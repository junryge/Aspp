<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M14 ì˜ˆì¸¡ í‰ê°€</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-card: #1f1f23;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --orange: #f97316;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Space Grotesk', system-ui, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--purple), var(--accent)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .logo-text { font-size: 18px; font-weight: 600; }
        .logo-text span { color: var(--text-secondary); font-weight: 400; }
        .nav-btns { display: flex; gap: 10px; }
        
        .btn { padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-family: inherit; font-size: 13px; transition: all 0.2s; }
        .btn:hover { background: var(--bg-card); border-color: var(--text-secondary); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); border-color: var(--success); color: #000; }
        .btn-warning { background: var(--warning); border-color: var(--warning); color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: var(--bg-secondary); padding: 15px 20px; border-radius: 10px; border: 1px solid var(--border); }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-label { font-size: 13px; color: var(--text-secondary); }
        
        input[type="date"], input[type="time"] { padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 13px; }
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        
        .radio-group { display: flex; gap: 10px; }
        .radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s; font-size: 13px; }
        .radio-label:hover { border-color: var(--accent); }
        .radio-label input { accent-color: var(--accent); }
        .radio-label.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); }
        .radio-label.source-internal.selected { background: rgba(34, 197, 94, 0.1); border-color: var(--success); }
        .radio-label.source-external.selected { background: rgba(249, 115, 22, 0.1); border-color: var(--orange); }
        
        .source-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; }
        .source-badge.internal { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .source-badge.external { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 15px 20px; }
        .stat-card.highlight { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); }
        .stat-card.danger { border-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        .stat-card.success { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .stat-card.warning { border-color: var(--warning); background: rgba(234, 179, 8, 0.05); }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-sub { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }
        
        .section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .confusion-matrix { display: grid; grid-template-columns: auto 1fr 1fr; gap: 2px; max-width: 400px; margin: 0 auto; }
        .cm-cell { padding: 15px 20px; text-align: center; border-radius: 6px; }
        .cm-header { background: var(--bg-card); font-weight: 600; font-size: 12px; color: var(--text-secondary); }
        .cm-tp { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .cm-tn { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .cm-fp { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .cm-fn { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .cm-value { font-size: 24px; font-weight: 700; }
        .cm-label { font-size: 10px; margin-top: 3px; }
        
        .status-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--bg-card); border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .status-item:hover { border-color: var(--accent); }
        .status-item.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .status-name { font-size: 13px; }
        .status-count { font-weight: 600; font-size: 14px; }
        .status-item.tp .status-count { color: var(--success); }
        .status-item.tn .status-count { color: var(--accent); }
        .status-item.fn .status-count { color: var(--danger); }
        .status-item.fp .status-count { color: var(--warning); }
        
        #chart { width: 100%; height: 500px; }
        .table-container { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-card); color: var(--text-secondary); font-weight: 500; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; position: sticky; top: 0; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .value-normal { color: var(--text-primary); }
        .value-warning { color: var(--warning); }
        .value-danger { color: var(--danger); }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .badge-tp { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .badge-tn { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .badge-fn { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-fp { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .badge-alarm { background: rgba(239, 68, 68, 0.3); color: var(--danger); }
        .badge-cooldown { background: rgba(234, 179, 8, 0.3); color: var(--warning); }
        
        .loading { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 48px; margin-bottom: 15px; }
        
        .warning-box { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; font-size: 13px; color: var(--warning); }
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; font-size: 13px; color: var(--accent); }
        .source-info-box { background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 15px; font-size: 13px; color: var(--orange); }
        
        .results-container { display: none; }
        .results-container.active { display: block; }
        
        .progress-bar { width: 100%; height: 20px; background: var(--bg-card); border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; }
        .progress-fill.external { background: linear-gradient(90deg, var(--orange), var(--danger)); }
        
        .divider { width: 1px; height: 30px; background: var(--border); margin: 0 5px; }
        
        .filter-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-secondary); transition: all 0.2s; }
        .filter-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .filter-btn.active.tp { background: var(--success); border-color: var(--success); }
        .filter-btn.active.tn { background: var(--accent); border-color: var(--accent); }
        .filter-btn.active.fn { background: var(--danger); border-color: var(--danger); }
        .filter-btn.active.fp { background: var(--warning); border-color: var(--warning); color: #000; }
        .filter-info { font-size: 12px; color: var(--text-secondary); margin-left: auto; }
        .filter-info strong { color: var(--accent); }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">E</div>
            <div class="logo-text">M14 <span>ì˜ˆì¸¡ í‰ê°€</span></div>
        </div>
        <div class="nav-btns">
            <button class="btn" onclick="location.href='/'">â† ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</button>
            <button class="btn" onclick="location.href='/history'">ğŸ“Š íˆìŠ¤í† ë¦¬</button>
        </div>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <span class="control-label">ë°ì´í„° ì†ŒìŠ¤:</span>
            <div class="radio-group">
                <label class="radio-label source-internal selected" id="radio-internal">
                    <input type="radio" name="data-source" value="internal" checked>
                    ğŸ“ ë‚´ë¶€ (íŒŒì¼)
                </label>
                <label class="radio-label source-external" id="radio-external">
                    <input type="radio" name="data-source" value="external">
                    ğŸŒ ì™¸ë¶€ (ë¡œê·¸í”„ë ˆì†Œ)
                </label>
            </div>
        </div>
        
        <div class="divider"></div>
        
        <div class="control-group">
            <span class="control-label">ì‹œì‘:</span>
            <input type="date" id="date-start">
            <input type="time" id="time-start" value="00:00">
        </div>
        <div class="control-group">
            <span class="control-label">ì¢…ë£Œ:</span>
            <input type="date" id="date-end">
            <input type="time" id="time-end" value="23:59">
        </div>
        
        <div class="divider"></div>
        
        <div class="control-group">
            <span class="control-label">ì˜ˆì¸¡:</span>
            <div class="radio-group">
                <label class="radio-label selected" id="radio-10">
                    <input type="radio" name="pred-type" value="10" checked>
                    10ë¶„
                </label>
                <label class="radio-label" id="radio-30">
                    <input type="radio" name="pred-type" value="30">
                    30ë¶„
                </label>
            </div>
        </div>
        
        <button class="btn btn-primary" id="btn-evaluate" onclick="startEvaluation()">ğŸ” í‰ê°€ ì‹¤í–‰</button>
        <button class="btn btn-success" id="btn-download" onclick="downloadCSV()" style="display: none;">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="loadToday()">ì˜¤ëŠ˜</button>
        <button class="btn" onclick="loadYesterday()">ì–´ì œ</button>
        <button class="btn" onclick="loadLast3Days()">ìµœê·¼ 3ì¼</button>
        <button class="btn" onclick="loadThisWeek()">ì´ë²ˆì£¼</button>
        <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; margin-left: 10px;">
            ğŸ’¡ CSVì— ì•ŒëŒë²ˆí˜¸, ì¿¨íƒ€ì„ ì •ë³´ í¬í•¨ë¨
        </span>
    </div>
    
    <div id="initial-state">
        <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div>ë‚ ì§œ/ì‹œê°„ì„ ì„ íƒí•˜ê³  <strong>í‰ê°€ ì‹¤í–‰</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
            <div style="color: var(--text-secondary); margin-top: 15px; font-size: 13px;">
                <div style="margin-bottom: 8px;"><span class="source-badge internal">ğŸ“ ë‚´ë¶€</span> data í´ë”ì˜ CSV íŒŒì¼ + alert íŒŒì¼ ì‚¬ìš©</div>
                <div style="margin-bottom: 8px;"><span class="source-badge external">ğŸŒ ì™¸ë¶€</span> ë¡œê·¸í”„ë ˆì†Œ API ì§ì ‘ ì¡°íšŒ (alert íŒŒì¼ì€ ë‚´ë¶€ ì‚¬ìš©)</div>
                <div style="color: var(--success); margin-top: 10px;">âœ… CSV ë‹¤ìš´ë¡œë“œ ì‹œ ì•ŒëŒë²ˆí˜¸, ì¿¨íƒ€ì„ ì •ë³´ í¬í•¨</div>
            </div>
        </div>
    </div>
    
    <div id="loading-state" style="display: none;">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div id="loading-text">í‰ê°€ ì§„í–‰ ì¤‘...</div>
            <div id="loading-source" style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
            </div>
            <div id="progress-text" style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">0 / 0</div>
        </div>
    </div>
    
    <div id="results-container" class="results-container">
        <div id="source-info-box" class="source-info-box" style="display: none;"></div>
        <div id="warning-box" class="warning-box" style="display: none;"></div>
        
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">ì´ í‰ê°€ ìˆ˜</div>
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-sub" id="stat-period">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì‹¤ì œ 1700+ ë°œìƒ</div>
                <div class="stat-value" id="stat-actual" style="color: var(--danger);">-</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">ì •í™•ë„</div>
                <div class="stat-value" id="stat-accuracy" style="color: var(--success);">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì¬í˜„ìœ¨ (Recall)</div>
                <div class="stat-value" id="stat-recall">-</div>
                <div class="stat-sub">1700+ ê°ì§€ ì„±ê³µë¥ </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì •ë°€ë„ (Precision)</div>
                <div class="stat-value" id="stat-precision">-</div>
                <div class="stat-sub">ê²½ê³  ì •í™•ë¥ </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">ì•ŒëŒ ê¸°ë¡</div>
                <div class="stat-value" id="stat-alarm" style="color: var(--warning);">-</div>
                <div class="stat-sub">1700+ ì˜ˆì¸¡ ì•ŒëŒ</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ“ í˜¼ë™ í–‰ë ¬</div>
            <div class="confusion-matrix">
                <div class="cm-cell"></div>
                <div class="cm-cell cm-header">ì˜ˆì¸¡: ì •ìƒ</div>
                <div class="cm-cell cm-header">ì˜ˆì¸¡: ìœ„í—˜</div>
                <div class="cm-cell cm-header">ì‹¤ì œ: ì •ìƒ</div>
                <div class="cm-cell cm-tn"><div class="cm-value" id="cm-tn">-</div><div class="cm-label">TN</div></div>
                <div class="cm-cell cm-fp"><div class="cm-value" id="cm-fp">-</div><div class="cm-label">FP</div></div>
                <div class="cm-cell cm-header">ì‹¤ì œ: ìœ„í—˜</div>
                <div class="cm-cell cm-fn"><div class="cm-value" id="cm-fn">-</div><div class="cm-label">FN</div></div>
                <div class="cm-cell cm-tp"><div class="cm-value" id="cm-tp">-</div><div class="cm-label">TP</div></div>
            </div>
        </div>
        
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="stat-card success"><div class="stat-label">FN ì¡°ê¸°ê°ì§€</div><div class="stat-value" id="stat-fn-early" style="color: var(--success);">-</div><div class="stat-sub" id="stat-fn-early-sub">ì‚¬ì „ ì˜ˆì¸¡</div></div>
            <div class="stat-card danger"><div class="stat-label">ì‹¤ì§ˆ FN (ë†“ì¹¨)</div><div class="stat-value" id="stat-real-fn" style="color: var(--danger);">-</div></div>
            <div class="stat-card warning"><div class="stat-label">FP ìœ íš¨ê²½ê³ </div><div class="stat-value" id="stat-fp-valid" style="color: var(--warning);">-</div><div class="stat-sub" id="stat-fp-valid-sub">ì´í›„ ëŒíŒŒ</div></div>
            <div class="stat-card"><div class="stat-label">ì‹¤ì§ˆ FP (ì˜¤íƒ)</div><div class="stat-value" id="stat-real-fp">-</div></div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ“Š ì˜ˆì¸¡ ìƒíƒœ ë¶„ë¥˜</div>
            <div class="status-list" id="status-list"></div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ“ˆ ì°¨íŠ¸</div>
            <div id="chart"></div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ“‹ ìƒì„¸ ë°ì´í„° (ì•ŒëŒ ì •ë³´ í¬í•¨)</div>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all" onclick="filterTable('all')">ì „ì²´</button>
                <button class="filter-btn tp" data-filter="TP" onclick="filterTable('TP')">TP</button>
                <button class="filter-btn tn" data-filter="TN" onclick="filterTable('TN')">TN</button>
                <button class="filter-btn fn" data-filter="FN" onclick="filterTable('FN')">FN</button>
                <button class="filter-btn fp" data-filter="FP" onclick="filterTable('FP')">FP</button>
                <button class="filter-btn" data-filter="alarm" onclick="filterTable('alarm')" style="border-color: var(--danger);">ğŸ”” ì•ŒëŒë§Œ</button>
                <div class="filter-info">í‘œì‹œ: <strong id="filter-count">0</strong>ê°œ / ì „ì²´ <span id="filter-total">0</span>ê°œ</div>
            </div>
            <div class="table-container" id="table-container"></div>
        </div>
    </div>

    <script>
        const today = new Date();
        document.getElementById('date-start').value = formatDate(today);
        document.getElementById('date-end').value = formatDate(today);
        
        let pollInterval = null;
        let allTableData = [];
        let currentFilter = 'all';
        let currentResultData = null;
        
        document.querySelectorAll('input[name="data-source"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('radio-internal').classList.remove('selected');
                document.getElementById('radio-external').classList.remove('selected');
                this.parentElement.classList.add('selected');
            });
        });
        
        document.querySelectorAll('input[name="pred-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('radio-10').classList.remove('selected');
                document.getElementById('radio-30').classList.remove('selected');
                this.parentElement.classList.add('selected');
            });
        });
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function loadToday() {
            document.getElementById('date-start').value = formatDate(today);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        function loadYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date-start').value = formatDate(yesterday);
            document.getElementById('date-end').value = formatDate(yesterday);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        function loadLast3Days() {
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
            document.getElementById('date-start').value = formatDate(threeDaysAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        function loadThisWeek() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 6);
            document.getElementById('date-start').value = formatDate(weekAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        // â˜… CSV ë‹¤ìš´ë¡œë“œ (ì•ŒëŒ ì •ë³´ í¬í•¨) - ìˆ˜ì •ë¨
        function downloadCSV() {
            if (!currentResultData || !currentResultData.data || currentResultData.data.length === 0) {
                alert('ë¨¼ì € í‰ê°€ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”');
                return;
            }
            
            const data = currentResultData.data;
            const predType = currentResultData.pred_type;
            const dateStart = currentResultData.date_start;
            const dateEnd = currentResultData.date_end;
            
            // CSV í—¤ë” (ì‹¤ì œë‹¨ì¼ í¬í•¨)
            const headers = ['í˜„ì¬ì‹œê°„','í˜„ì¬ê°’','ì˜ˆì¸¡ì‹œì ','ì˜ˆì¸¡ê°’','ì‹¤ì œ(ìµœëŒ€)','ì‹¤ì œ(ë‹¨ì¼)','í™•ë¥ ','íˆ¬í‘œìˆ˜','íŒì •','ì‹¤ì œìœ„í—˜','ìƒíƒœ','ì•ŒëŒë²ˆí˜¸','ì•ŒëŒë°œìƒ','ì¿¨íƒ€ì„(ë¶„)'];
            let csv = headers.join(',') + '\n';
            
            // â˜… ì•ŒëŒ ìˆëŠ” í–‰ ì¹´ìš´íŠ¸
            let alarmRowCount = 0;
            
            data.forEach(row => {
                // â˜… ì•ŒëŒ ì •ë³´ ì¶”ì¶œ (undefined, null, '' ëª¨ë‘ ì²˜ë¦¬)
                const hasAlarm = row.alarm_no !== undefined && row.alarm_no !== null && row.alarm_no !== '';
                
                let alarmNoStr = '';
                let isAlarmStr = '';
                let cooldownStr = '';
                
                if (hasAlarm) {
                    alarmRowCount++;
                    alarmNoStr = String(row.alarm_no);
                    isAlarmStr = row.is_alarm === true ? 'ë°œìƒ' : 'ì¿¨íƒ€ì„';
                    cooldownStr = row.cooldown_mins !== undefined && row.cooldown_mins !== null && row.cooldown_mins !== '' 
                                  ? String(row.cooldown_mins) : '0';
                }
                
                const values = [
                    row.currtime || '',
                    row.current || '',
                    row.pred_time || '',
                    row.predict || '',
                    row.actual_max || '',
                    row.actual_single || '',  // â˜… ì‹¤ì œ(ë‹¨ì¼) í¬í•¨
                    row.prob || '',
                    row.vote || '',
                    row.danger === 1 ? 'ìœ„í—˜' : 'ì •ìƒ',
                    row.actual_danger === 1 ? 'ìœ„í—˜' : 'ì •ìƒ',
                    row.status || '',
                    alarmNoStr,
                    isAlarmStr,
                    cooldownStr
                ];
                csv += values.join(',') + '\n';
            });
            
            console.log(`CSV ìƒì„±: ì´ ${data.length}í–‰, ì•ŒëŒ ì •ë³´ ìˆëŠ” í–‰: ${alarmRowCount}ê°œ`);
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `m14_evaluate_${predType}min_${dateStart}_${dateEnd}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function startEvaluation() {
            const dateStart = document.getElementById('date-start').value.replace(/-/g, '');
            const dateEnd = document.getElementById('date-end').value.replace(/-/g, '');
            const timeStart = document.getElementById('time-start').value.replace(':', '');
            const timeEnd = document.getElementById('time-end').value.replace(':', '');
            const predType = document.querySelector('input[name="pred-type"]:checked').value;
            const dataSource = document.querySelector('input[name="data-source"]:checked').value;
            
            if (!dateStart || !dateEnd) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
            
            document.getElementById('initial-state').style.display = 'none';
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('results-container').classList.remove('active');
            document.getElementById('btn-evaluate').disabled = true;
            document.getElementById('btn-download').style.display = 'none';
            
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            progressFill.className = 'progress-fill' + (dataSource === 'external' ? ' external' : '');
            
            document.getElementById('progress-text').textContent = 'ì‹œì‘ ì¤‘...';
            document.getElementById('loading-source').innerHTML = dataSource === 'internal' ? 'ğŸ“ ë‚´ë¶€(íŒŒì¼) + Alert íŒŒì¼' : 'ğŸŒ ì™¸ë¶€(ë¡œê·¸í”„ë ˆì†Œ) + Alert íŒŒì¼';
            
            try {
                const startRes = await fetch(`/api/evaluate/start?date_start=${dateStart}&date_end=${dateEnd}&time_start=${timeStart}&time_end=${timeEnd}&pred_type=${predType}&data_source=${dataSource}`);
                const startData = await startRes.json();
                
                if (startData.error) { alert(startData.error); resetUI(); return; }
                pollInterval = setInterval(pollStatus, 1000);
            } catch (e) {
                console.error(e);
                alert('í‰ê°€ ì‹œì‘ ì¤‘ ì˜¤ë¥˜');
                resetUI();
            }
        }
        
        async function pollStatus() {
            try {
                const res = await fetch('/api/evaluate/status');
                const data = await res.json();
                
                document.getElementById('progress-fill').style.width = data.percent + '%';
                document.getElementById('progress-fill').textContent = data.percent + '%';
                document.getElementById('progress-text').textContent = `${data.progress.toLocaleString()} / ${data.total.toLocaleString()}`;
                document.getElementById('loading-text').textContent = `í‰ê°€ ì§„í–‰ ì¤‘... (${data.percent}%)`;
                
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    await loadResult();
                } else if (data.status === 'error') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    alert('í‰ê°€ ì¤‘ ì˜¤ë¥˜');
                    resetUI();
                }
            } catch (e) { console.error(e); }
        }
        
        async function loadResult() {
            try {
                const res = await fetch('/api/evaluate/result');
                const data = await res.json();
                
                if (data.error) { alert(data.error); resetUI(); return; }
                currentResultData = data;
                
                // â˜… ê²°ê³¼ ë°ì´í„° ë””ë²„ê·¸ ë¡œê·¸
                console.log('í‰ê°€ ê²°ê³¼:', data);
                console.log('ì•ŒëŒ ê¸°ë¡ ìˆ˜:', data.alarm_record_count);
                if (data.data && data.data.length > 0) {
                    const sampleRow = data.data[0];
                    console.log('ìƒ˜í”Œ í–‰:', sampleRow);
                    console.log('alarm_no í•„ë“œ:', sampleRow.alarm_no);
                }
                
                displayResults(data);
            } catch (e) {
                console.error(e);
                alert('ê²°ê³¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜');
                resetUI();
            }
        }
        
        function resetUI() {
            document.getElementById('initial-state').style.display = 'block';
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('btn-evaluate').disabled = false;
            document.getElementById('btn-download').style.display = 'none';
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        }
        
        function displayResults(data) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('btn-evaluate').disabled = false;
            document.getElementById('btn-download').style.display = 'inline-block';
            
            const sourceInfoBox = document.getElementById('source-info-box');
            if (data.data_source === 'external') {
                sourceInfoBox.innerHTML = `ğŸŒ ì™¸ë¶€(ë¡œê·¸í”„ë ˆì†Œ) í‰ê°€ ì™„ë£Œ | ì•ŒëŒ ê¸°ë¡: ${data.alarm_record_count}ê°œ`;
                sourceInfoBox.className = 'source-info-box';
            } else {
                sourceInfoBox.innerHTML = `ğŸ“ ë‚´ë¶€(íŒŒì¼) í‰ê°€ ì™„ë£Œ | ì•ŒëŒ ê¸°ë¡: ${data.alarm_record_count}ê°œ`;
                sourceInfoBox.className = 'info-box';
            }
            sourceInfoBox.style.display = 'block';
            
            const warningBox = document.getElementById('warning-box');
            if (data.missing_cols && data.missing_cols.length > 0) {
                warningBox.innerHTML = `âš ï¸ ëˆ„ë½ ì»¬ëŸ¼: ${data.missing_cols.slice(0, 5).join(', ')}`;
                warningBox.style.display = 'block';
            } else { warningBox.style.display = 'none'; }
            
            const stats = data.stats;
            
            document.getElementById('stat-total').textContent = data.total_count.toLocaleString();
            document.getElementById('stat-period').textContent = `${data.date_start.slice(0,4)}-${data.date_start.slice(4,6)}-${data.date_start.slice(6,8)} ~ ${data.date_end.slice(0,4)}-${data.date_end.slice(4,6)}-${data.date_end.slice(6,8)} (${data.pred_type}ë¶„)`;
            document.getElementById('stat-actual').textContent = data.actual_danger_count.toLocaleString();
            document.getElementById('stat-accuracy').textContent = stats.accuracy + '%';
            document.getElementById('stat-recall').textContent = stats.recall + '%';
            document.getElementById('stat-precision').textContent = stats.precision + '%';
            document.getElementById('stat-alarm').textContent = (data.alarm_record_count || 0).toLocaleString();
            
            document.getElementById('cm-tp').textContent = stats.TP.toLocaleString();
            document.getElementById('cm-tn').textContent = stats.TN.toLocaleString();
            document.getElementById('cm-fp').textContent = stats.FP.toLocaleString();
            document.getElementById('cm-fn').textContent = stats.FN.toLocaleString();
            
            document.getElementById('stat-fn-early').textContent = stats.fn_early.toLocaleString();
            document.getElementById('stat-fn-early-sub').textContent = `${data.analysis_range}ë¶„ ì´ë‚´`;
            document.getElementById('stat-real-fn').textContent = stats.real_fn.toLocaleString();
            document.getElementById('stat-fp-valid').textContent = stats.fp_valid.toLocaleString();
            document.getElementById('stat-fp-valid-sub').textContent = `${data.analysis_range}ë¶„ ì´ë‚´`;
            document.getElementById('stat-real-fp').textContent = stats.real_fp.toLocaleString();
            
            const statusList = document.getElementById('status-list');
            let statusHtml = '';
            const sortedStatuses = Object.entries(data.status_counts).sort((a, b) => {
                const order = s => s === 'TP' ? 0 : s === 'TN' ? 1 : s.startsWith('FN') ? 2 : 3;
                return order(a[0]) - order(b[0]);
            });
            sortedStatuses.forEach(([status, count]) => {
                let cls = status === 'TP' ? 'tp' : status === 'TN' ? 'tn' : status.startsWith('FN') ? 'fn' : 'fp';
                statusHtml += `<div class="status-item ${cls}" onclick="filterTable('${status}')" data-status="${status}"><span class="status-name">${status}</span><span class="status-count">${count.toLocaleString()}</span></div>`;
            });
            statusList.innerHTML = statusHtml;
            
            allTableData = data.data;
            currentFilter = 'all';
            drawTable(allTableData);
            updateFilterInfo();
            
            // â˜… ì»¨í…Œì´ë„ˆ ë¨¼ì € í‘œì‹œ
            document.getElementById('results-container').classList.add('active');
            
            // â˜… ì»¨í…Œì´ë„ˆ í‘œì‹œ í›„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (DOM ë Œë”ë§ ëŒ€ê¸°)
            setTimeout(function() {
                drawChart(data.data, data.pred_type);
            }, 50);
        }
        
        function filterTable(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) btn.classList.add('active');
            });
            
            document.querySelectorAll('.status-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.status === filter) item.classList.add('active');
            });
            
            let filteredData;
            if (filter === 'all') filteredData = allTableData;
            else if (filter === 'FN') filteredData = allTableData.filter(row => row.status && row.status.startsWith('FN'));
            else if (filter === 'FP') filteredData = allTableData.filter(row => row.status && row.status.startsWith('FP'));
            else if (filter === 'alarm') filteredData = allTableData.filter(row => row.alarm_no !== undefined && row.alarm_no !== null && row.alarm_no !== '');
            else filteredData = allTableData.filter(row => row.status === filter);
            
            drawTable(filteredData);
            updateFilterInfo(filteredData.length);
        }
        
        function updateFilterInfo(count) {
            document.getElementById('filter-count').textContent = (count !== undefined ? count : allTableData.length).toLocaleString();
            document.getElementById('filter-total').textContent = allTableData.length.toLocaleString();
        }
        
        // â˜… ìˆ˜ì •ëœ drawChart í•¨ìˆ˜ - ì‹œì‘~ì¢…ë£Œ ì‹œê°„ í‘œì‹œ, hover ì‹œ YYYY-MM-DD-HH:MM:(ê°’) í˜•ì‹
        function drawChart(data, predType) {
            // xì¶•: ì˜ˆì¸¡ì‹œì  ì „ì²´ í‘œì‹œ (YYYY-MM-DD HH:MM)
            const times = data.map(d => d.pred_time || '');
            const actualMax = data.map(d => d.actual_max);
            const actualSingle = data.map(d => d.actual_single);
            const predicts = data.map(d => d.predict);
            
            // customdata ìƒì„± (hoverìš©) - YYYY-MM-DD-HH:MM:(ê°’) í˜•ì‹
            const customData = data.map(d => {
                const pt = d.pred_time || '';
                // YYYY-MM-DD HH:MM -> YYYY-MM-DD-HH:MM í˜•ì‹ ë³€í™˜
                let formatted = pt;
                if (pt && pt.includes(' ')) {
                    const [datePart, timePart] = pt.split(' ');
                    if (timePart) {
                        formatted = `${datePart}-${timePart}`;
                    }
                }
                return [formatted, d.actual_max, d.actual_single, d.predict];
            });
            
            const traces = [
                { 
                    x: times, y: actualMax, name: `ì‹¤ì œ(ìµœëŒ€)`, type: 'scatter', mode: 'lines', 
                    line: { color: '#22c55e', width: 2 },
                    customdata: customData,
                    hovertemplate: '%{customdata[0]}:(%{customdata[1]})<extra>ì‹¤ì œ(ìµœëŒ€)</extra>'
                },
                { 
                    x: times, y: actualSingle, name: `ì‹¤ì œ(ë‹¨ì¼)`, type: 'scatter', mode: 'lines', 
                    line: { color: '#3b82f6', width: 2 },
                    customdata: customData,
                    hovertemplate: '%{customdata[0]}:(%{customdata[2]})<extra>ì‹¤ì œ(ë‹¨ì¼)</extra>'
                },
                { 
                    x: times, y: predicts, name: 'ì˜ˆì¸¡ê°’', type: 'scatter', mode: 'lines', 
                    line: { color: '#f97316', width: 2 },
                    customdata: customData,
                    hovertemplate: '%{customdata[0]}:(%{customdata[3]})<extra>ì˜ˆì¸¡ê°’</extra>'
                }
            ];
            
            const layout = {
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: { color: '#a1a1aa', family: 'Space Grotesk' },
                showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' },
                xaxis: { gridcolor: '#27272a', tickangle: -45, autorange: true },
                yaxis: { gridcolor: '#27272a', range: [1000, 2000] },
                margin: { t: 40, r: 20, b: 80, l: 55 },
                shapes: [{ type: 'line', y0: 1700, y1: 1700, x0: 0, x1: 1, xref: 'paper', line: { color: '#ef4444', width: 2 } }]
            };
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±
            Plotly.purge('chart');
            Plotly.newPlot('chart', traces, layout, { responsive: true, displayModeBar: false });
            
            // â˜… ê°•ì œ ë¦¬ì‚¬ì´ì¦ˆ (ì´ˆê¸° ë Œë”ë§ ë¬¸ì œ í•´ê²°)
            setTimeout(function() {
                Plotly.Plots.resize('chart');
            }, 100);
            setTimeout(function() {
                Plotly.Plots.resize('chart');
            }, 300);
        }
        
        function drawTable(data) {
            let html = `<table><thead><tr><th>í˜„ì¬ì‹œê°„</th><th>í˜„ì¬ê°’</th><th>ì˜ˆì¸¡ì‹œì </th><th>ì˜ˆì¸¡ê°’</th><th>ì‹¤ì œ(ìµœëŒ€)</th><th>ì‹¤ì œ(ë‹¨ì¼)</th><th>í™•ë¥ </th><th>íŒì •</th><th>ì‹¤ì œìœ„í—˜</th><th>ìƒíƒœ</th><th>ì•ŒëŒì •ë³´</th></tr></thead><tbody>`;
            
            if (data.length === 0) {
                html += `<tr><td colspan="11" style="text-align: center; padding: 40px;">ë°ì´í„° ì—†ìŒ</td></tr>`;
            } else {
                data.forEach(row => {
                    const predClass = row.predict >= 1700 ? 'value-danger' : row.predict >= 1600 ? 'value-warning' : '';
                    const actualMaxClass = row.actual_max >= 1700 ? 'value-danger' : row.actual_max >= 1600 ? 'value-warning' : '';
                    const actualSingleClass = row.actual_single >= 1700 ? 'value-danger' : row.actual_single >= 1600 ? 'value-warning' : '';
                    
                    let statusBadge = '-';
                    if (row.status) {
                        if (row.status === 'TP') statusBadge = '<span class="badge badge-tp">TP</span>';
                        else if (row.status === 'TN') statusBadge = '<span class="badge badge-tn">TN</span>';
                        else if (row.status.startsWith('FN')) statusBadge = `<span class="badge badge-fn">${row.status}</span>`;
                        else if (row.status.startsWith('FP')) statusBadge = `<span class="badge badge-fp">${row.status}</span>`;
                    }
                    
                    // â˜… ì•ŒëŒ ì •ë³´ í‘œì‹œ
                    let alarmInfo = '-';
                    const hasAlarm = row.alarm_no !== undefined && row.alarm_no !== null && row.alarm_no !== '';
                    if (hasAlarm) {
                        if (row.is_alarm === true) {
                            alarmInfo = `<span class="badge badge-alarm">ğŸ”” ${row.alarm_no}ë²ˆì§¸ ì•ŒëŒ</span>`;
                        } else {
                            const cooldown = row.cooldown_mins !== undefined && row.cooldown_mins !== null ? row.cooldown_mins : 0;
                            alarmInfo = `<span class="badge badge-cooldown">â± ${row.alarm_no}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${cooldown}ë¶„</span>`;
                        }
                    }
                    
                    html += `<tr>
                        <td>${row.currtime || '-'}</td>
                        <td>${row.current ? row.current.toLocaleString() : '-'}</td>
                        <td>${row.pred_time || '-'}</td>
                        <td class="${predClass}" style="font-weight: 600;">${row.predict ? row.predict.toLocaleString() : '-'}</td>
                        <td class="${actualMaxClass}" style="font-weight: 600;">${row.actual_max ? row.actual_max.toLocaleString() : '-'}</td>
                        <td class="${actualSingleClass}" style="font-weight: 600;">${row.actual_single ? row.actual_single.toLocaleString() : '-'}</td>
                        <td>${row.prob !== undefined ? row.prob : '-'}</td>
                        <td>${row.danger ? 'âš ï¸' : 'âœ…'}</td>
                        <td>${row.actual_danger ? 'ğŸ”´' : 'ğŸŸ¢'}</td>
                        <td>${statusBadge}</td>
                        <td>${alarmInfo}</td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('table-container').innerHTML = html;
        }
    </script>
</body>
</html>