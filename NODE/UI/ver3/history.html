<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M14 History</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-card: #1f1f23;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Space Grotesk', system-ui, sans-serif;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
        }
        
        .back-btn:hover {
            background: var(--bg-card);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        input[type="date"], input[type="time"] {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:hover { background: var(--bg-card); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); border-color: var(--success); color: #000; }
        .btn-purple { background: var(--purple); border-color: var(--purple); }
        .btn-purple:hover { background: #7c3aed; }
        
        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 20px;
            min-width: 150px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        #chart {
            width: 100%;
            height: 400px;
        }
        
        .table-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-info {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-card);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .value-normal { color: var(--text-primary); }
        .value-warning { color: var(--warning); }
        .value-danger { color: var(--danger); }
        
        .accuracy-good { color: var(--success); }
        .accuracy-ok { color: var(--warning); }
        .accuracy-bad { color: var(--danger); }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .alert-badge.alarm {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .alert-badge.cooldown {
            background: rgba(234, 179, 8, 0.2);
            color: var(--warning);
        }
        
        .alert-badge.logpresso {
            background: rgba(139, 92, 246, 0.2);
            color: var(--purple);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">H</div>
            <div class="logo-text">M14 <span>History</span></div>
        </div>
        <button class="back-btn" onclick="location.href='/'">â† ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</button>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <span class="control-label">ì‹œì‘:</span>
            <input type="date" id="date-start">
            <input type="time" id="time-start" value="00:00">
        </div>
        <div class="control-group">
            <span class="control-label">ì¢…ë£Œ:</span>
            <input type="date" id="date-end">
            <input type="time" id="time-end" value="23:59">
        </div>
        <button class="btn btn-primary" onclick="loadData()">ì¡°íšŒ</button>
        <button class="btn" onclick="loadYesterday()">ì–´ì œ</button>
        <button class="btn" onclick="loadToday()">ì˜¤ëŠ˜</button>
        <button class="btn" onclick="loadLast3Days()">ìµœê·¼3ì¼</button>
        <button class="btn" onclick="loadThisWeek()">ì´ë²ˆì£¼</button>
        <button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-purple" onclick="location.href='/evaluate'">ğŸ“Š í‰ê°€ ë°ì´í„° ë¶„ì„ V10.4</button>
    </div>
    
    <div class="stats-row" id="stats-row" style="display: none;">
        <div class="stat-card">
            <div class="stat-label">ë°ì´í„° ìˆ˜</div>
            <div class="stat-value" id="stat-count">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">í‰ê·  TOTALCNT</div>
            <div class="stat-value" id="stat-avg">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ìµœëŒ€ TOTALCNT</div>
            <div class="stat-value" id="stat-max">-</div>
            <div class="stat-sub" id="stat-max-time">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">1700+ ì´ˆê³¼</div>
            <div class="stat-value value-danger" id="stat-over">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡10ë¶„ ì•ˆì— 1700+ ì ì¤‘ë¥ </div>
            <div class="stat-value" id="stat-acc10">-</div>
            <div class="stat-sub" id="stat-acc10-sub">ì˜ˆì¸¡â†’ì‹¤ì œ</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡30ë¶„ ì•ˆì— 1700+ ì ì¤‘ë¥ </div>
            <div class="stat-value" id="stat-acc30">-</div>
            <div class="stat-sub" id="stat-acc30-sub">ì˜ˆì¸¡â†’ì‹¤ì œ</div>
        </div>
    </div>
    
    <div class="chart-section" id="chart-section" style="display: none;">
        <div class="chart-title">ğŸ“ˆ TOTALCNT vs ì˜ˆì¸¡ê°’ (â— í”„ë¡œê·¸ë¨ì•ŒëŒ  â—† ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ)</div>
        <div id="chart"></div>
    </div>
    
    <div class="table-section">
        <div class="table-header">
            <div class="table-title">ğŸ“‹ ìƒì„¸ ë°ì´í„°</div>
            <div class="table-info" id="table-info">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div id="table-container">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“…</div>
                <div>ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
            </div>
        </div>
    </div>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        const today = new Date();
        document.getElementById('date-start').value = formatDate(today);
        document.getElementById('date-end').value = formatDate(today);
        
        let currentData = null;  // í˜„ì¬ ì¡°íšŒëœ ë°ì´í„° ì €ì¥
        let logpressoAlarmMap = {};  // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ë§µ
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function loadToday() {
            const today = new Date();
            document.getElementById('date-start').value = formatDate(today);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date-start').value = formatDate(yesterday);
            document.getElementById('date-end').value = formatDate(yesterday);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadLast3Days() {
            const today = new Date();
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
            document.getElementById('date-start').value = formatDate(threeDaysAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadThisWeek() {
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 6);
            document.getElementById('date-start').value = formatDate(weekAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function downloadCSV() {
            if (!currentData || !currentData.data || currentData.data.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì„¸ìš”');
                return;
            }
            
            const dateStart = document.getElementById('date-start').value.replace(/-/g, '');
            const dateEnd = document.getElementById('date-end').value.replace(/-/g, '');
            const timeStart = document.getElementById('time-start').value.replace(':', '');
            const timeEnd = document.getElementById('time-end').value.replace(':', '');
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ìƒì„±
            const alertMap10 = {};
            const alertMap30 = {};
            (currentData.alerts_10 || []).forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            (currentData.alerts_30 || []).forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            // CSV í—¤ë” (ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì»¬ëŸ¼ ì¶”ê°€)
            const headers = ['CURRTIME', 'TOTALCNT', 'PRED_TIME_10', 'PREDICT_10', 'PROG_ALERT_10', 'PRED_TIME_30', 'PREDICT_30', 'PROG_ALERT_30', 'LOGPRESSO_ALARM'];
            let csv = headers.join(',') + '\n';
            
            // CSV ë°ì´í„°
            currentData.data.forEach(row => {
                const currtime = String(row.CURRTIME);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                const logpressoAlarm = logpressoAlarmMap[currtime];
                
                // í”„ë¡œê·¸ë¨ ì•ŒëŒ í…ìŠ¤íŠ¸ ìƒì„± (ì¿¨íƒ€ì„ í¬í•¨)
                let alert10Text = '';
                if (alert10) {
                    if (alert10.IS_ALARM) {
                        alert10Text = `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸`;
                    } else {
                        alert10Text = `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert10.COOLDOWN_MINS}ë¶„`;
                    }
                }
                
                let alert30Text = '';
                if (alert30) {
                    if (alert30.IS_ALARM) {
                        alert30Text = `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸`;
                    } else {
                        alert30Text = `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert30.COOLDOWN_MINS}ë¶„`;
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ í…ìŠ¤íŠ¸
                let logpressoText = '';
                if (logpressoAlarm) {
                    logpressoText = logpressoAlarm.ALARM_DESC || 'Y';
                }
                
                const values = [
                    row.CURRTIME || '',
                    row.TOTALCNT || '',
                    row.PRED_TIME_10 || '',
                    row.PREDICT_10 || '',
                    alert10Text,
                    row.PRED_TIME_30 || '',
                    row.PREDICT_30 || '',
                    alert30Text,
                    logpressoText
                ];
                csv += values.join(',') + '\n';
            });
            
            // ë‹¤ìš´ë¡œë“œ
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `m14_history_${dateStart}_${dateEnd}_${timeStart}-${timeEnd}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function loadData() {
            const dateStartInput = document.getElementById('date-start').value;
            const dateEndInput = document.getElementById('date-end').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;
            
            if (!dateStartInput || !dateEndInput) {
                alert('ì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            // ë‚ ì§œ ë²”ìœ„ ìƒì„±
            const dateList = getDateRange(dateStartInput, dateEndInput);
            if (dateList.length === 0) {
                alert('ì‹œì‘ ë‚ ì§œê°€ ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ í½ë‹ˆë‹¤');
                return;
            }
            
            if (dateList.length > 30) {
                alert('ìµœëŒ€ 30ì¼ê¹Œì§€ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì‹œê°„ ë²”ìœ„ë¥¼ HHMM í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const startHHMM = timeStart.replace(':', '');
            const endHHMM = timeEnd.replace(':', '');
            
            document.getElementById('table-container').innerHTML = `<div class="loading">ë¡œë”© ì¤‘... (${dateList.length}ì¼)</div>`;
            
            try {
                // ê° ë‚ ì§œë³„ë¡œ API í˜¸ì¶œ
                let allData = [];
                let allAlerts10 = [];
                let allAlerts30 = [];
                
                for (const dateStr of dateList) {
                    const res = await fetch(`/api/history?date=${dateStr}`);
                    const data = await res.json();
                    
                    if (!data.error && data.data && data.data.length > 0) {
                        allData = allData.concat(data.data);
                        allAlerts10 = allAlerts10.concat(data.alerts_10 || []);
                        allAlerts30 = allAlerts30.concat(data.alerts_30 || []);
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì¡°íšŒ
                const fromTime = dateStartInput.replace(/-/g, '') + startHHMM + '00';
                const toTime = dateEndInput.replace(/-/g, '') + endHHMM + '00';
                
                try {
                    const alarmRes = await fetch(`/api/logpresso_alarm?from=${fromTime}&to=${toTime}`);
                    const alarmData = await alarmRes.json();
                    
                    logpressoAlarmMap = {};
                    if (alarmData.data && alarmData.data.length > 0) {
                        alarmData.data.forEach(a => {
                            const measTm = String(a.MEAS_TM);
                            logpressoAlarmMap[measTm] = a;
                        });
                        console.log(`ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ${alarmData.data.length}ê°œ ë¡œë“œ`);
                    }
                } catch (e) {
                    console.log('ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì¡°íšŒ ì‹¤íŒ¨:', e);
                    logpressoAlarmMap = {};
                }
                
                if (allData.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>í•´ë‹¹ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                // ì‹œê°„ ë²”ìœ„ í•„í„°ë§ (ì‹œì‘ì¼ ì‹œì‘ì‹œê°„ ~ ì¢…ë£Œì¼ ì¢…ë£Œì‹œê°„)
                const startDateTime = dateStartInput.replace(/-/g, '') + startHHMM;
                const endDateTime = dateEndInput.replace(/-/g, '') + endHHMM;
                
                const filteredData = allData.filter(row => {
                    const currtime = String(row.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                // ì•ŒëŒë„ í•„í„°ë§
                const filteredAlerts10 = allAlerts10.filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                const filteredAlerts30 = allAlerts30.filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                if (filteredData.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ•</div>
                            <div>ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤<br><small>${dateStartInput} ${timeStart} ~ ${dateEndInput} ${timeEnd}</small></div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                // CURRTIME ê¸°ì¤€ ì •ë ¬
                filteredData.sort((a, b) => String(a.CURRTIME).localeCompare(String(b.CURRTIME)));
                
                const filteredResult = {
                    data: filteredData,
                    alerts_10: filteredAlerts10,
                    alerts_30: filteredAlerts30
                };
                
                currentData = filteredResult;  // ë‹¤ìš´ë¡œë“œìš© ì €ì¥
                
                // í†µê³„ ê³„ì‚°
                updateStats(filteredResult);
                
                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                drawChart(filteredResult);
                
                // í…Œì´ë¸” ê·¸ë¦¬ê¸°
                drawTable(filteredResult);
                
                document.getElementById('stats-row').style.display = 'flex';
                document.getElementById('chart-section').style.display = 'block';
                
                const rangeText = dateStartInput === dateEndInput 
                    ? `${dateStartInput} ${timeStart}~${timeEnd}`
                    : `${dateStartInput} ${timeStart} ~ ${dateEndInput} ${timeEnd}`;
                document.getElementById('table-info').textContent = `${rangeText} | ${filteredData.length}ê°œ ë°ì´í„°`;
                
            } catch (e) {
                console.error(e);
                document.getElementById('table-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div>ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨</div>
                    </div>
                `;
            }
        }
        
        // ë‚ ì§œ ë²”ìœ„ ìƒì„± í•¨ìˆ˜
        function getDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) return [];
            
            const current = new Date(start);
            while (current <= end) {
                const y = current.getFullYear();
                const m = String(current.getMonth() + 1).padStart(2, '0');
                const d = String(current.getDate()).padStart(2, '0');
                dates.push(`${y}${m}${d}`);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }
        
        function updateStats(data) {
            const rows = data.data;
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            
            // ê¸°ë³¸ í†µê³„
            document.getElementById('stat-count').textContent = rows.length;
            document.getElementById('stat-avg').textContent = Math.round(totalcnts.reduce((a,b) => a+b, 0) / totalcnts.length);
            
            const maxVal = Math.max(...totalcnts);
            const maxIdx = totalcnts.indexOf(maxVal);
            document.getElementById('stat-max').textContent = maxVal;
            document.getElementById('stat-max').className = 'stat-value ' + getValueClass(maxVal);
            document.getElementById('stat-max-time').textContent = formatTime(rows[maxIdx].CURRTIME);
            
            const overCount = totalcnts.filter(v => v >= 1700).length;
            document.getElementById('stat-over').textContent = overCount;
            
            // ì˜ˆì¸¡ ì •í™•ë„ ê³„ì‚° (1700+ ì˜ˆì¸¡ ì ì¤‘ë¥ )
            let acc10Hit = 0;   // 1700+ ì˜ˆì¸¡ ì„±ê³µ
            let acc10Total = 0; // 1700+ ì˜ˆì¸¡ ì‹œë„
            let acc30Hit = 0;
            let acc30Total = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // 10ë¶„ ì˜ˆì¸¡ ê²€ì¦: ì˜ˆì¸¡ì´ 1700+ì¼ ë•Œ, ì‹¤ì œë¡œ 10ë¶„ í›„ 1700+ ëëŠ”ì§€
                if (i + 10 < rows.length && row.PREDICT_10 >= 1700) {
                    const actual = rows[i + 10].TOTALCNT;
                    acc10Total++;  // 1700+ ì˜ˆì¸¡ íšŸìˆ˜
                    if (actual >= 1700) acc10Hit++;  // ì‹¤ì œë¡œ 1700+ ëœ íšŸìˆ˜
                }
                
                // 30ë¶„ ì˜ˆì¸¡ ê²€ì¦
                if (i + 30 < rows.length && row.PREDICT_30 >= 1700) {
                    const actual = rows[i + 30].TOTALCNT;
                    acc30Total++;
                    if (actual >= 1700) acc30Hit++;
                }
            }
            
            const acc10 = acc10Total > 0 ? Math.round(acc10Hit / acc10Total * 100) : 0;
            const acc30 = acc30Total > 0 ? Math.round(acc30Hit / acc30Total * 100) : 0;
            
            document.getElementById('stat-acc10').textContent = acc10Total > 0 ? acc10 + '%' : '-';
            document.getElementById('stat-acc10').className = 'stat-value ' + getAccuracyClass(acc10);
            document.getElementById('stat-acc10-sub').textContent = `${acc10Hit}/${acc10Total} ì ì¤‘`;
            
            document.getElementById('stat-acc30').textContent = acc30Total > 0 ? acc30 + '%' : '-';
            document.getElementById('stat-acc30').className = 'stat-value ' + getAccuracyClass(acc30);
            document.getElementById('stat-acc30-sub').textContent = `${acc30Hit}/${acc30Total} ì ì¤‘`;
        }
        
        function getValueClass(val) {
            if (val >= 1700) return 'value-danger';
            if (val >= 1600) return 'value-warning';
            return 'value-normal';
        }
        
        function getAccuracyClass(acc) {
            if (acc >= 70) return 'accuracy-good';
            if (acc >= 50) return 'accuracy-ok';
            return 'accuracy-bad';
        }
        
        function formatTime(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function formatTimeChart(currtime) {
            // ì°¨íŠ¸ìš©: MM-DD HH:MM í˜•ì‹ (í•­ìƒ ë‚ ì§œ í¬í•¨)
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function formatTimeFull(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function drawChart(data) {
            const rows = data.data;
            const alerts10 = data.alerts_10 || [];
            const alerts30 = data.alerts_30 || [];
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ìƒì„±
            const alertMap10 = {};
            const alertMap30 = {};
            alerts10.forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            alerts30.forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            // ì—¬ëŸ¬ ë‚ ì§œì¸ì§€ í™•ì¸ (í…Œì´ë¸”ìš©)
            const dates = new Set(rows.map(r => String(r.CURRTIME).slice(0, 8)));
            const isMultipleDays = dates.size > 1;
            
            // ê·¸ë˜í”„ xì¶•: í•­ìƒ ë‚ ì§œ í¬í•¨ (MM-DD HH:MM)
            const times = rows.map(r => formatTimeChart(r.CURRTIME));
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            const pred10s = rows.map(r => r.PREDICT_10 || 0);
            const pred30s = rows.map(r => r.PREDICT_30 || 0);
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ì  ë°ì´í„° (IS_ALARM=trueì¸ ê²ƒë§Œ, "10ë¶„ ì•ŒëŒ Në²ˆì§¸" í˜•ì‹)
            const progAlarmTimes = [];
            const progAlarmValues = [];
            const progAlarmTexts = [];
            
            rows.forEach((r, i) => {
                const currtime = String(r.CURRTIME);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                
                if ((alert10 && alert10.IS_ALARM) || (alert30 && alert30.IS_ALARM)) {
                    progAlarmTimes.push(times[i]);
                    progAlarmValues.push(r.TOTALCNT || 0);
                    let text = '';
                    if (alert10 && alert10.IS_ALARM) text += `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸`;
                    if (alert30 && alert30.IS_ALARM) text += (text ? ', ' : '') + `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸`;
                    progAlarmTexts.push(text);
                }
            });
            
            // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì  ë°ì´í„°
            const logAlarmTimes = [];
            const logAlarmValues = [];
            const logAlarmTexts = [];
            
            rows.forEach((r, i) => {
                const currtime = String(r.CURRTIME);
                const logAlarm = logpressoAlarmMap[currtime];
                
                if (logAlarm) {
                    logAlarmTimes.push(times[i]);
                    logAlarmValues.push(r.TOTALCNT || 0);
                    logAlarmTexts.push(logAlarm.ALARM_DESC || 'ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ');
                }
            });
            
            const traces = [
                {
                    x: times,
                    y: totalcnts,
                    name: 'TOTALCNT',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#3b82f6', width: 2 }
                },
                {
                    x: times,
                    y: pred10s,
                    name: 'ì˜ˆì¸¡(10ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#22c55e', width: 1, dash: 'dot' }
                },
                {
                    x: times,
                    y: pred30s,
                    name: 'ì˜ˆì¸¡(30ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#f97316', width: 1, dash: 'dash' }
                },
                {
                    x: progAlarmTimes,
                    y: progAlarmValues,
                    name: 'í”„ë¡œê·¸ë¨ì•ŒëŒ',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#ef4444', size: 12, symbol: 'circle' },
                    text: progAlarmTexts,
                    hovertemplate: '%{text}<br>ì‹œê°„: %{x}<br>ê°’: %{y}<extra>í”„ë¡œê·¸ë¨ì•ŒëŒ</extra>'
                },
                {
                    x: logAlarmTimes,
                    y: logAlarmValues,
                    name: 'ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#8b5cf6', size: 12, symbol: 'diamond' },
                    text: logAlarmTexts,
                    hovertemplate: '%{text}<br>ì‹œê°„: %{x}<br>ê°’: %{y}<extra>ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ</extra>'
                }
            ];
            
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#a1a1aa', family: 'Space Grotesk', size: 11 },
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h' },
                xaxis: {
                    gridcolor: '#27272a',
                    tickangle: -45
                },
                yaxis: {
                    gridcolor: '#27272a',
                    range: [1000, 2000]
                },
                margin: { t: 30, r: 20, b: 60, l: 50 },
                shapes: [{
                    type: 'line',
                    y0: 1700, y1: 1700,
                    x0: 0, x1: 1, xref: 'paper',
                    line: { color: '#ef4444', width: 2, dash: 'solid' }
                }]
            };
            
            Plotly.newPlot('chart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        function drawTable(data) {
            const rows = data.data;
            const alerts10 = data.alerts_10 || [];
            const alerts30 = data.alerts_30 || [];
            
            // ì—¬ëŸ¬ ë‚ ì§œì¸ì§€ í™•ì¸
            const dates = new Set(rows.map(r => String(r.CURRTIME).slice(0, 8)));
            const isMultipleDays = dates.size > 1;
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ë§Œë“¤ê¸°
            const alertMap10 = {};
            alerts10.forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            const alertMap30 = {};
            alerts30.forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: ${isMultipleDays ? '120px' : '80px'};">ì‹œê°„</th>
                            <th style="width: 100px;">TOTALCNT</th>
                            <th style="width: 150px;">10ë¶„í›„ ì˜ˆì¸¡</th>
                            <th style="width: 150px;">30ë¶„í›„ ì˜ˆì¸¡</th>
                            <th>í”„ë¡œê·¸ë¨ì•ŒëŒ</th>
                            <th>ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                const timeDisplay = isMultipleDays ? formatTimeChart(currtime) : formatTime(currtime);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                const logAlarm = logpressoAlarmMap[currtime];
                
                // ì˜ˆì¸¡ ì‹œì  ê³„ì‚°
                const predTime10 = row.PRED_TIME_10 ? formatTime(String(row.PRED_TIME_10)) : '-';
                const predTime30 = row.PRED_TIME_30 ? formatTime(String(row.PRED_TIME_30)) : '-';
                
                // í”„ë¡œê·¸ë¨ ì•ŒëŒ HTML (ìƒì„¸ ë°ì´í„°ëŠ” ì¿¨íƒ€ì„ í¬í•¨)
                let progAlarmHtml = '';
                if (alert10) {
                    if (alert10.IS_ALARM) {
                        progAlarmHtml += `<span class="alert-badge alarm">ğŸ”” 10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸</span> `;
                    } else {
                        progAlarmHtml += `<span class="alert-badge cooldown">â± 10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert10.COOLDOWN_MINS}ë¶„</span> `;
                    }
                }
                if (alert30) {
                    if (alert30.IS_ALARM) {
                        progAlarmHtml += `<span class="alert-badge alarm">ğŸ”” 30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸</span> `;
                    } else {
                        progAlarmHtml += `<span class="alert-badge cooldown">â± 30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert30.COOLDOWN_MINS}ë¶„</span> `;
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ HTML
                let logAlarmHtml = '-';
                if (logAlarm) {
                    logAlarmHtml = `<span class="alert-badge logpresso">â—† ${logAlarm.ALARM_DESC || 'ì•ŒëŒ'}</span>`;
                }
                
                html += `
                    <tr>
                        <td style="font-weight: 600; color: #3b82f6;">${timeDisplay}</td>
                        <td class="${getValueClass(row.TOTALCNT)}" style="font-weight: 600;">${(row.TOTALCNT || 0).toLocaleString()}</td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_10)}" style="font-weight: 600;">${(row.PREDICT_10 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime10}</span>
                        </td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_30)}" style="font-weight: 600;">${(row.PREDICT_30 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime30}</span>
                        </td>
                        <td>${progAlarmHtml || '-'}</td>
                        <td>${logAlarmHtml}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('table-container').innerHTML = html;
        }
    </script>
</body>
</html>