<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M14 History</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-card: #1f1f23;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Space Grotesk', system-ui, sans-serif;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
        }
        
        .back-btn:hover {
            background: var(--bg-card);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        input[type="date"], input[type="time"] {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:hover { background: var(--bg-card); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #2563eb; }
        
        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 20px;
            min-width: 150px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        #chart {
            width: 100%;
            height: 400px;
        }
        
        .table-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-info {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-card);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .value-normal { color: var(--text-primary); }
        .value-warning { color: var(--warning); }
        .value-danger { color: var(--danger); }
        
        .accuracy-good { color: var(--success); }
        .accuracy-ok { color: var(--warning); }
        .accuracy-bad { color: var(--danger); }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .alert-badge.alarm {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .alert-badge.cooldown {
            background: rgba(234, 179, 8, 0.2);
            color: var(--warning);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">H</div>
            <div class="logo-text">M14 <span>History</span></div>
        </div>
        <button class="back-btn" onclick="location.href='/'">â† ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</button>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <span class="control-label">ë‚ ì§œ:</span>
            <input type="date" id="date-picker">
        </div>
        <div class="control-group">
            <span class="control-label">ì‹œì‘:</span>
            <input type="time" id="time-start" value="00:00">
        </div>
        <div class="control-group">
            <span class="control-label">ì¢…ë£Œ:</span>
            <input type="time" id="time-end" value="23:59">
        </div>
        <button class="btn btn-primary" onclick="loadData()">ì¡°íšŒ</button>
        <button class="btn" onclick="loadYesterday()">ì–´ì œ</button>
        <button class="btn" onclick="loadToday()">ì˜¤ëŠ˜</button>
        <button class="btn" onclick="setMorning()">ì˜¤ì „</button>
        <button class="btn" onclick="setAfternoon()">ì˜¤í›„</button>
        <button class="btn" onclick="setFullDay()">ì „ì²´</button>
    </div>
    
    <div class="stats-row" id="stats-row" style="display: none;">
        <div class="stat-card">
            <div class="stat-label">ë°ì´í„° ìˆ˜</div>
            <div class="stat-value" id="stat-count">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">í‰ê·  TOTALCNT</div>
            <div class="stat-value" id="stat-avg">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ìµœëŒ€ TOTALCNT</div>
            <div class="stat-value" id="stat-max">-</div>
            <div class="stat-sub" id="stat-max-time">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">1700+ ì´ˆê³¼</div>
            <div class="stat-value value-danger" id="stat-over">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡10ë¶„ ì •í™•ë„</div>
            <div class="stat-value" id="stat-acc10">-</div>
            <div class="stat-sub">ì˜¤ì°¨ Â±100 ì´ë‚´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡30ë¶„ ì •í™•ë„</div>
            <div class="stat-value" id="stat-acc30">-</div>
            <div class="stat-sub">ì˜¤ì°¨ Â±100 ì´ë‚´</div>
        </div>
    </div>
    
    <div class="chart-section" id="chart-section" style="display: none;">
        <div class="chart-title">ğŸ“ˆ TOTALCNT vs ì˜ˆì¸¡ê°’</div>
        <div id="chart"></div>
    </div>
    
    <div class="table-section">
        <div class="table-header">
            <div class="table-title">ğŸ“‹ ìƒì„¸ ë°ì´í„°</div>
            <div class="table-info" id="table-info">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div id="table-container">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“…</div>
                <div>ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
            </div>
        </div>
    </div>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        const today = new Date();
        document.getElementById('date-picker').value = formatDate(today);
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function loadToday() {
            document.getElementById('date-picker').value = formatDate(new Date());
            setFullDay();
            loadData();
        }
        
        function loadYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date-picker').value = formatDate(yesterday);
            setFullDay();
            loadData();
        }
        
        function setMorning() {
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '11:59';
        }
        
        function setAfternoon() {
            document.getElementById('time-start').value = '12:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        function setFullDay() {
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
        }
        
        async function loadData() {
            const dateInput = document.getElementById('date-picker').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;
            
            if (!dateInput) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            const dateStr = dateInput.replace(/-/g, '');
            
            // ì‹œê°„ ë²”ìœ„ë¥¼ HHMM í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const startHHMM = timeStart.replace(':', '');
            const endHHMM = timeEnd.replace(':', '');
            
            document.getElementById('table-container').innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            
            try {
                const res = await fetch(`/api/history?date=${dateStr}`);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <div>${data.error}</div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>í•´ë‹¹ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                // ì‹œê°„ ë²”ìœ„ í•„í„°ë§
                const filteredData = data.data.filter(row => {
                    const currtime = String(row.CURRTIME);
                    if (currtime.length >= 12) {
                        const timeHHMM = currtime.slice(8, 12);
                        return timeHHMM >= startHHMM && timeHHMM <= endHHMM;
                    }
                    return true;
                });
                
                // ì•ŒëŒë„ í•„í„°ë§
                const filteredAlerts10 = (data.alerts_10 || []).filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const timeHHMM = currtime.slice(8, 12);
                        return timeHHMM >= startHHMM && timeHHMM <= endHHMM;
                    }
                    return true;
                });
                
                const filteredAlerts30 = (data.alerts_30 || []).filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const timeHHMM = currtime.slice(8, 12);
                        return timeHHMM >= startHHMM && timeHHMM <= endHHMM;
                    }
                    return true;
                });
                
                if (filteredData.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ•</div>
                            <div>ì„ íƒí•œ ì‹œê°„ ë²”ìœ„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤<br><small>${timeStart} ~ ${timeEnd}</small></div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                const filteredResult = {
                    data: filteredData,
                    alerts_10: filteredAlerts10,
                    alerts_30: filteredAlerts30
                };
                
                // í†µê³„ ê³„ì‚°
                updateStats(filteredResult);
                
                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                drawChart(filteredResult);
                
                // í…Œì´ë¸” ê·¸ë¦¬ê¸°
                drawTable(filteredResult);
                
                document.getElementById('stats-row').style.display = 'flex';
                document.getElementById('chart-section').style.display = 'block';
                document.getElementById('table-info').textContent = `${dateInput} ${timeStart}~${timeEnd} | ${filteredData.length}ê°œ ë°ì´í„°`;
                
            } catch (e) {
                console.error(e);
                document.getElementById('table-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div>ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨</div>
                    </div>
                `;
            }
        }
        
        function updateStats(data) {
            const rows = data.data;
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            
            // ê¸°ë³¸ í†µê³„
            document.getElementById('stat-count').textContent = rows.length;
            document.getElementById('stat-avg').textContent = Math.round(totalcnts.reduce((a,b) => a+b, 0) / totalcnts.length);
            
            const maxVal = Math.max(...totalcnts);
            const maxIdx = totalcnts.indexOf(maxVal);
            document.getElementById('stat-max').textContent = maxVal;
            document.getElementById('stat-max').className = 'stat-value ' + getValueClass(maxVal);
            document.getElementById('stat-max-time').textContent = formatTime(rows[maxIdx].CURRTIME);
            
            const overCount = totalcnts.filter(v => v >= 1700).length;
            document.getElementById('stat-over').textContent = overCount;
            
            // ì˜ˆì¸¡ ì •í™•ë„ ê³„ì‚° (10ë¶„ ì˜ˆì¸¡)
            let acc10Count = 0;
            let acc10Total = 0;
            let acc30Count = 0;
            let acc30Total = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // 10ë¶„ ì˜ˆì¸¡ ê²€ì¦: ië²ˆì§¸ ì˜ˆì¸¡ì´ i+10ë²ˆì§¸ ì‹¤ì œê°’ê³¼ ë¹„êµ
                if (i + 10 < rows.length && row.PREDICT_10) {
                    const actual = rows[i + 10].TOTALCNT;
                    const predicted = row.PREDICT_10;
                    const error = Math.abs(actual - predicted);
                    acc10Total++;
                    if (error <= 100) acc10Count++;
                }
                
                // 30ë¶„ ì˜ˆì¸¡ ê²€ì¦
                if (i + 30 < rows.length && row.PREDICT_30) {
                    const actual = rows[i + 30].TOTALCNT;
                    const predicted = row.PREDICT_30;
                    const error = Math.abs(actual - predicted);
                    acc30Total++;
                    if (error <= 100) acc30Count++;
                }
            }
            
            const acc10 = acc10Total > 0 ? Math.round(acc10Count / acc10Total * 100) : 0;
            const acc30 = acc30Total > 0 ? Math.round(acc30Count / acc30Total * 100) : 0;
            
            document.getElementById('stat-acc10').textContent = acc10 + '%';
            document.getElementById('stat-acc10').className = 'stat-value ' + getAccuracyClass(acc10);
            
            document.getElementById('stat-acc30').textContent = acc30 + '%';
            document.getElementById('stat-acc30').className = 'stat-value ' + getAccuracyClass(acc30);
        }
        
        function getValueClass(val) {
            if (val >= 1700) return 'value-danger';
            if (val >= 1600) return 'value-warning';
            return 'value-normal';
        }
        
        function getAccuracyClass(acc) {
            if (acc >= 70) return 'accuracy-good';
            if (acc >= 50) return 'accuracy-ok';
            return 'accuracy-bad';
        }
        
        function formatTime(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function formatTimeFull(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function drawChart(data) {
            const rows = data.data;
            
            const times = rows.map(r => formatTime(r.CURRTIME));
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            const pred10s = rows.map(r => r.PREDICT_10 || 0);
            const pred30s = rows.map(r => r.PREDICT_30 || 0);
            
            const traces = [
                {
                    x: times,
                    y: totalcnts,
                    name: 'TOTALCNT',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#3b82f6', width: 2 }
                },
                {
                    x: times,
                    y: pred10s,
                    name: 'ì˜ˆì¸¡(10ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#22c55e', width: 1, dash: 'dot' }
                },
                {
                    x: times,
                    y: pred30s,
                    name: 'ì˜ˆì¸¡(30ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#f97316', width: 1, dash: 'dash' }
                }
            ];
            
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#a1a1aa', family: 'Space Grotesk', size: 11 },
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h' },
                xaxis: {
                    gridcolor: '#27272a',
                    tickangle: -45
                },
                yaxis: {
                    gridcolor: '#27272a',
                    range: [1000, 2000]
                },
                margin: { t: 30, r: 20, b: 60, l: 50 },
                shapes: [{
                    type: 'line',
                    y0: 1700, y1: 1700,
                    x0: 0, x1: 1, xref: 'paper',
                    line: { color: '#ef4444', width: 2, dash: 'solid' }
                }]
            };
            
            Plotly.newPlot('chart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        function drawTable(data) {
            const rows = data.data;
            const alerts10 = data.alerts_10 || [];
            const alerts30 = data.alerts_30 || [];
            
            // ì•ŒëŒ ë§µ ë§Œë“¤ê¸°
            const alertMap10 = {};
            alerts10.forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            const alertMap30 = {};
            alerts30.forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 80px;">ì‹œê°„</th>
                            <th style="width: 100px;">TOTALCNT</th>
                            <th style="width: 150px;">10ë¶„í›„ ì˜ˆì¸¡</th>
                            <th style="width: 150px;">30ë¶„í›„ ì˜ˆì¸¡</th>
                            <th>ì•ŒëŒ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                const timeDisplay = formatTime(currtime);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                
                // ì˜ˆì¸¡ ì‹œì  ê³„ì‚°
                const predTime10 = row.PRED_TIME_10 ? formatTime(String(row.PRED_TIME_10)) : '-';
                const predTime30 = row.PRED_TIME_30 ? formatTime(String(row.PRED_TIME_30)) : '-';
                
                let alertHtml = '';
                if (alert10) {
                    if (alert10.IS_ALARM) {
                        alertHtml += `<span class="alert-badge alarm">ğŸ”” 10ë¶„ #${alert10.ALARM_NO}</span> `;
                    } else {
                        alertHtml += `<span class="alert-badge cooldown">â± 10ë¶„ ì¿¨íƒ€ì„</span> `;
                    }
                }
                if (alert30) {
                    if (alert30.IS_ALARM) {
                        alertHtml += `<span class="alert-badge alarm">ğŸ”” 30ë¶„ #${alert30.ALARM_NO}</span> `;
                    } else {
                        alertHtml += `<span class="alert-badge cooldown">â± 30ë¶„ ì¿¨íƒ€ì„</span> `;
                    }
                }
                
                html += `
                    <tr>
                        <td style="font-weight: 600; color: #3b82f6;">${timeDisplay}</td>
                        <td class="${getValueClass(row.TOTALCNT)}" style="font-weight: 600;">${(row.TOTALCNT || 0).toLocaleString()}</td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_10)}" style="font-weight: 600;">${(row.PREDICT_10 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime10}</span>
                        </td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_30)}" style="font-weight: 600;">${(row.PREDICT_30 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime30}</span>
                        </td>
                        <td>${alertHtml || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('table-container').innerHTML = html;
        }
    </script>
</body>
</html>