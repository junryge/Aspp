<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M14 History</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-card: #1f1f23;
            --border: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Space Grotesk', system-ui, sans-serif;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
        }
        
        .back-btn:hover {
            background: var(--bg-card);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        input[type="date"], input[type="time"] {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:hover { background: var(--bg-card); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); border-color: var(--success); color: #000; }
        .btn-purple { background: var(--purple); border-color: var(--purple); }
        .btn-purple:hover { background: #7c3aed; }
        
        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 20px;
            min-width: 150px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        #chart {
            width: 100%;
            height: 400px;
        }
        
        .table-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-info {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-card);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .value-normal { color: var(--text-primary); }
        .value-warning { color: var(--warning); }
        .value-danger { color: var(--danger); }
        
        .accuracy-good { color: var(--success); }
        .accuracy-ok { color: var(--warning); }
        .accuracy-bad { color: var(--danger); }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .alert-badge.alarm {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .alert-badge.cooldown {
            background: rgba(234, 179, 8, 0.2);
            color: var(--warning);
        }
        
        .alert-badge.logpresso {
            background: rgba(139, 92, 246, 0.2);
            color: var(--purple);
        }
        
        .alert-badge.logpresso-cooldown {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px dashed #a855f7;
        }

        /* LLM ë¶„ì„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .llm-data-info {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px;
            margin-bottom: 10px;
        }

        .llm-stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .llm-stat {
            background: var(--bg-secondary);
            padding: 3px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .llm-stat-label {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .llm-stat-value {
            font-size: 11px;
            font-weight: 600;
        }

        .llm-stat-value.danger { color: var(--danger); }
        .llm-stat-value.warning { color: var(--warning); }
        .llm-stat-value.success { color: var(--success); }

        .llm-type-selector {
            margin-bottom: 15px;
        }

        .llm-type-selector label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .llm-type-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .llm-type-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .llm-type-btn:hover {
            border-color: var(--accent);
        }

        .llm-type-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* LLM ëª¨ë“œ ì„ íƒê¸° */
        .llm-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .llm-mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .llm-mode-btn:hover {
            border-color: var(--accent);
        }

        .llm-mode-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .llm-mode-btn[data-mode="dev"].active {
            background: var(--warning);
            border-color: var(--warning);
        }

        .llm-mode-btn[data-mode="prod"].active {
            background: var(--success);
            border-color: var(--success);
        }

        .llm-mode-btn[data-mode="local"].active {
            background: var(--purple);
            border-color: var(--purple);
        }

        .llm-mode-section {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .llm-model-info {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
        }

        .llm-model-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .llm-model-row:not(:last-child) {
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
            padding-bottom: 6px;
        }

        .llm-model-label {
            color: var(--text-secondary);
        }

        .llm-model-value {
            color: var(--accent);
            font-weight: 600;
            font-family: 'Consolas', monospace;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-llm {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            border: none;
            padding: 10px 24px;
        }

        .btn-llm:hover {
            background: linear-gradient(135deg, #7c3aed, #2563eb);
        }

        .llm-result-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
            margin-top: 15px;
        }

        .llm-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .llm-result-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .llm-result-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .llm-result-content {
            font-size: 13px;
            line-height: 1.7;
        }

        .llm-result-content h1, .llm-result-content h2, .llm-result-content h3 {
            margin: 16px 0 8px 0;
            color: var(--accent);
        }

        .llm-result-content h2 { font-size: 16px; }
        .llm-result-content h3 { font-size: 14px; }

        .llm-result-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 12px;
        }

        .llm-result-content th, .llm-result-content td {
            padding: 8px 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .llm-result-content th {
            background: var(--bg-secondary);
            color: var(--accent);
        }

        .llm-result-content ul, .llm-result-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .llm-result-content li { margin: 4px 0; }

        .llm-result-content strong { color: var(--warning); }

        .llm-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .llm-loading-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: llm-spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes llm-spin {
            to { transform: rotate(360deg); }
        }

        .llm-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .llm-empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .streaming-cursor {
            display: inline-block;
            color: var(--accent);
            animation: blink-cursor 0.8s infinite;
            font-weight: bold;
        }

        @keyframes blink-cursor {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* í”„ë¡¬í”„íŠ¸ ì„¤ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .prompt-modal-content {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .prompt-tab {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-tab:hover {
            border-color: var(--accent);
        }

        .prompt-tab.active {
            background: var(--accent) !important;
            border-color: var(--accent) !important;
            color: white !important;
        }

        .template-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: monospace;
            resize: vertical;
        }

        .template-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .btn-prompt-settings {
            background: var(--purple);
            border-color: var(--purple);
        }

        .btn-prompt-settings:hover {
            background: #7c3aed;
            border-color: #7c3aed;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">H</div>
            <div class="logo-text">M14 <span>History</span></div>
        </div>
        <button class="back-btn" onclick="location.href='/'">â† ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</button>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <span class="control-label">ì‹œì‘:</span>
            <input type="date" id="date-start">
            <input type="time" id="time-start" value="00:00">
        </div>
        <div class="control-group">
            <span class="control-label">ì¢…ë£Œ:</span>
            <input type="date" id="date-end">
            <input type="time" id="time-end" value="23:59">
        </div>
        <button class="btn btn-primary" onclick="loadData()">ì¡°íšŒ</button>
        <button class="btn" onclick="loadYesterday()">ì–´ì œ</button>
        <button class="btn" onclick="loadToday()">ì˜¤ëŠ˜</button>
        <button class="btn" onclick="loadLast3Days()">ìµœê·¼3ì¼</button>
        <button class="btn" onclick="loadThisWeek()">ì´ë²ˆì£¼</button>
        <button class="btn btn-success" onclick="downloadCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-purple" onclick="location.href='/evaluate'">ğŸ“Š í‰ê°€ ë°ì´í„° ë¶„ì„ V10.4</button>
        <button class="btn" onclick="openLlmAnalysisModal()" style="background: linear-gradient(135deg, #8b5cf6, #3b82f6); border: none;">ğŸ¤– LLM ë¶„ì„</button>
    </div>
    
    <div class="stats-row" id="stats-row" style="display: none;">
        <div class="stat-card">
            <div class="stat-label">ë°ì´í„° ìˆ˜</div>
            <div class="stat-value" id="stat-count">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">í‰ê·  TOTALCNT</div>
            <div class="stat-value" id="stat-avg">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ìµœëŒ€ TOTALCNT</div>
            <div class="stat-value" id="stat-max">-</div>
            <div class="stat-sub" id="stat-max-time">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">1700+ ì´ˆê³¼</div>
            <div class="stat-value value-danger" id="stat-over">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡10ë¶„ ì•ˆì— 1700+ ì ì¤‘ë¥ </div>
            <div class="stat-value" id="stat-acc10">-</div>
            <div class="stat-sub" id="stat-acc10-sub">ì˜ˆì¸¡â†’ì‹¤ì œ</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜ˆì¸¡30ë¶„ ì•ˆì— 1700+ ì ì¤‘ë¥ </div>
            <div class="stat-value" id="stat-acc30">-</div>
            <div class="stat-sub" id="stat-acc30-sub">ì˜ˆì¸¡â†’ì‹¤ì œ</div>
        </div>
    </div>
    
    <div class="chart-section" id="chart-section" style="display: none;">
        <div class="chart-title">ğŸ“ˆ TOTALCNT vs ì˜ˆì¸¡ê°’ (â—â—‹ í”„ë¡œê·¸ë¨ì•ŒëŒ  â—†â—‡ ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ)</div>
        <div id="chart"></div>
    </div>
    
    <div class="table-section">
        <div class="table-header">
            <div class="table-title">ğŸ“‹ ìƒì„¸ ë°ì´í„°</div>
            <div class="table-info" id="table-info">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div id="table-container">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“…</div>
                <div>ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
            </div>
        </div>
    </div>

    <!-- LLM ë¶„ì„ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="llm-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¤– LLM ë°ì´í„° ë¶„ì„</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn btn-prompt-settings" onclick="openPromptModal()" style="padding: 6px 12px; font-size: 12px;">âš™ï¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •</button>
                    <button class="modal-close" onclick="closeLlmModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- LLM ëª¨ë“œ ì„ íƒ -->
                <div class="llm-mode-section">
                    <div class="llm-mode-selector">
                        <button class="llm-mode-btn" data-mode="dev" onclick="setLlmMode('dev')">
                            ğŸŒ ê°œë°œ API
                        </button>
                        <button class="llm-mode-btn" data-mode="prod" onclick="setLlmMode('prod')">
                            ğŸ¢ ìš´ì˜ API
                        </button>
                        <button class="llm-mode-btn active" data-mode="local" onclick="setLlmMode('local')">
                            ğŸ’» ë¡œì»¬ GGUF
                        </button>
                    </div>
                    <div class="llm-model-info">
                        <div class="llm-model-row" id="current-model-row">
                            <span class="llm-model-label" id="current-model-label">ğŸ’» ë¡œì»¬ GGUF:</span>
                            <span class="llm-model-value" id="current-model-name">-</span>
                        </div>
                    </div>
                </div>

                <!-- ë°ì´í„° ì •ë³´ -->
                <div class="llm-data-info">
                    <div class="llm-stats-grid" id="llm-stats-grid">
                        <div class="llm-stat"><span class="llm-stat-label">ì´ ë¡œê·¸ ìˆ˜:</span><span class="llm-stat-value" id="llm-stat-count">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">í‰ê·  ì‘ë‹µì‹œê°„:</span><span class="llm-stat-value" id="llm-stat-avg">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">ìµœëŒ€ ì‘ë‹µì‹œê°„:</span><span class="llm-stat-value" id="llm-stat-max">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">ìœ„í—˜ ê±´ìˆ˜:</span><span class="llm-stat-value danger" id="llm-stat-over">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">LLM ì •í™•ë„:</span><span class="llm-stat-value success" id="llm-stat-accuracy">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">TP(ì •íƒ):</span><span class="llm-stat-value success" id="llm-stat-tp">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">TN(ì •ìƒ):</span><span class="llm-stat-value" id="llm-stat-tn" style="color: var(--accent);">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">FP(ì˜¤íƒ):</span><span class="llm-stat-value warning" id="llm-stat-fp">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">FN(ë¯¸íƒ):</span><span class="llm-stat-value danger" id="llm-stat-fn">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">10ë¶„ ì•ŒëŒ:</span><span class="llm-stat-value warning" id="llm-stat-alert10">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">30ë¶„ ì•ŒëŒ:</span><span class="llm-stat-value" id="llm-stat-alert30" style="color: var(--accent);">-</span></div>
                        <div class="llm-stat"><span class="llm-stat-label">ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ:</span><span class="llm-stat-value" id="llm-stat-logpresso" style="color: var(--purple);">-</span></div>
                    </div>
                </div>

                <!-- ë¶„ì„ ìœ í˜• ì„ íƒ -->
                <div class="llm-type-selector">
                    <label>ë¶„ì„ ìœ í˜• ì„ íƒ</label>
                    <div class="llm-type-btns">
                        <button class="llm-type-btn active" data-type="summary" onclick="selectLlmType('summary')">
                            ğŸ“‹ ìš”ì•½ ë¶„ì„
                        </button>
                        <button class="llm-type-btn" data-type="pattern" onclick="selectLlmType('pattern')">
                            ğŸ“ˆ íŒ¨í„´ ë¶„ì„
                        </button>
                        <button class="llm-type-btn" data-type="prediction" onclick="selectLlmType('prediction')">
                            ğŸ”® ì˜ˆì¸¡ ë¶„ì„
                        </button>
                    </div>
                </div>

                <!-- ë¶„ì„ ê²°ê³¼ -->
                <div class="llm-result-section" id="llm-result-section">
                    <div class="llm-result-header">
                        <div class="llm-result-title">ğŸ“ ë¶„ì„ ê²°ê³¼</div>
                        <div class="llm-result-meta" id="llm-result-meta"></div>
                    </div>
                    <div id="llm-result-container">
                        <div class="llm-empty">
                            <div class="llm-empty-icon">ğŸ¤–</div>
                            <div>ë¶„ì„ ìœ í˜•ì„ ì„ íƒí•˜ê³  <strong>ë¶„ì„ ì‹¤í–‰</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeLlmModal()">ë‹«ê¸°</button>
                <button class="btn btn-llm" id="btn-llm-analyze" onclick="runLlmAnalysis()">
                    ğŸ” ë¶„ì„ ì‹¤í–‰
                </button>
            </div>
        </div>
    </div>

    <!-- í”„ë¡¬í”„íŠ¸ ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="prompt-modal" style="display: none;">
        <div class="modal-content prompt-modal-content">
            <div class="modal-header">
                <h3>âš™ï¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h3>
                <button class="modal-close" onclick="closePromptModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="color: var(--accent);">
                        ğŸ¤– ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (LLM ì—­í•  ì •ì˜)
                    </label>
                    <textarea id="system-prompt" class="template-textarea" style="height: 200px;"></textarea>
                </div>

                <!-- ë¶„ì„ í”„ë¡¬í”„íŠ¸ íƒ­ -->
                <div style="margin-bottom: 15px;">
                    <label class="form-label" style="color: var(--success);">
                        ğŸ“ ë¶„ì„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
                    </label>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="prompt-tab active" data-tab="summary" onclick="switchPromptTab('summary')">ğŸ“‹ ìš”ì•½ ë¶„ì„</button>
                        <button class="prompt-tab" data-tab="pattern" onclick="switchPromptTab('pattern')">ğŸ“ˆ íŒ¨í„´ ë¶„ì„</button>
                        <button class="prompt-tab" data-tab="prediction" onclick="switchPromptTab('prediction')">ğŸ”® ì˜ˆì¸¡ ë¶„ì„</button>
                    </div>
                </div>

                <div class="form-group">
                    <textarea id="template-summary" class="template-textarea" style="height: 180px;"></textarea>
                    <textarea id="template-pattern" class="template-textarea" style="height: 180px; display: none;"></textarea>
                    <textarea id="template-prediction" class="template-textarea" style="height: 180px; display: none;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn" onclick="resetPrompts()">ğŸ”„ ê¸°ë³¸ê°’ ë³µì›</button>
                    <button class="btn btn-primary" onclick="savePrompts()">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        const today = new Date();
        document.getElementById('date-start').value = formatDate(today);
        document.getElementById('date-end').value = formatDate(today);

        let currentData = null;  // í˜„ì¬ ì¡°íšŒëœ ë°ì´í„° ì €ì¥
        let logpressoAlarmMap = {};  // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ë§µ

        // ========================================
        // í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
        // ========================================
        const defaultPrompts = {
            system: `ë‹¹ì‹ ì€ M14 ë°˜ì†¡ í ì˜ˆì¸¡ ëª¨ë¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ë¶„ì„ ì›ì¹™
1. **ê²°ë¡  ë¨¼ì €** - í•µì‹¬ ìˆ˜ì¹˜ì™€ íŒë‹¨ì„ ë¨¼ì € ì œì‹œ
2. **ê°„ê²°í•˜ê²Œ** - ë¶ˆí•„ìš”í•œ ì„¤ëª… ì—†ì´ í•µì‹¬ë§Œ
3. **ìˆ«ì ì¤‘ì‹¬** - ì •í™•í•œ ìˆ˜ì¹˜ì™€ ë¹„ìœ¨ ì œì‹œ
4. **ë¬¸ì œì  ëª…í™•íˆ** - ë¬´ì—‡ì´ ë¬¸ì œì¸ì§€ ì§ì ‘ì ìœ¼ë¡œ

## ì¶œë ¥ í˜•ì‹
- í…Œì´ë¸”ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹, ìµœì†Œí•œì˜ ì»¬ëŸ¼ë§Œ
- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš© (ğŸ“Š âœ… âš ï¸ ğŸ”´ ğŸ’¡ ğŸ””)
- ì„¹ì…˜ì€ ## í—¤ë”ë¡œ êµ¬ë¶„
- ê¸´ ì„¤ëª… ëŒ€ì‹  í•µì‹¬ bullet point

## M14 ê¸°ì¤€ê°’
- ìœ„í—˜ ì„ê³„ê°’: TOTALCNT >= 1700
- ê²½ê³  ì„ê³„ê°’: TOTALCNT >= 1600
- ì˜ˆì¸¡ ëª¨ë¸: XGB (10ë¶„ í›„, 30ë¶„ í›„ ì˜ˆì¸¡)
- ì•ŒëŒ ì‹œìŠ¤í…œ: 10ë¶„ ì•ŒëŒ, 30ë¶„ ì•ŒëŒ, ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ

## ì œê³µë˜ëŠ” í†µê³„ ë°ì´í„°
- ì´ ë¡œê·¸ ìˆ˜, í‰ê· /ìµœëŒ€ ì‘ë‹µì‹œê°„, ìœ„í—˜ ê±´ìˆ˜(1700+)
- LLM ì •í™•ë„, TP(ì •íƒ), TN(ì •ìƒ), FP(ì˜¤íƒ), FN(ë¯¸íƒ)
- 10ë¶„ ì•ŒëŒ, 30ë¶„ ì•ŒëŒ, ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ë°œìƒ íšŸìˆ˜`,
            templates: {
                summary: `ìœ„ ë°ì´í„°ë¥¼ ì¢…í•© ë¶„ì„í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:
## ğŸ“Š í•µì‹¬ ìš”ì•½
| ì§€í‘œ | ê°’ | í‰ê°€ |
|---|---|---|
- ì •í™•ë„, ì¬í˜„ìœ¨(TP/(TP+FN)), ì •ë°€ë„(TP/(TP+FP))

## ğŸ”” ì•ŒëŒ í˜„í™©
- 10ë¶„ ì•ŒëŒ vs 30ë¶„ ì•ŒëŒ vs ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ë¹„êµ
- ì•ŒëŒ íš¨ìœ¨ì„± í‰ê°€ (ì‹¤ì œ ìœ„í—˜ ëŒ€ë¹„)

## âœ… ì¢‹ì€ ì 
- (1-2ê°œ, ìˆ˜ì¹˜ í¬í•¨)

## âš ï¸ ë¬¸ì œì 
- í•µì‹¬ ë¬¸ì œ (FNì´ ë†’ìœ¼ë©´ ë†“ì¹œ ìœ„í—˜, FPê°€ ë†’ìœ¼ë©´ ì˜¤íƒ ê³¼ë‹¤)
- ì•ŒëŒ ì‹œìŠ¤í…œ ë¬¸ì œì 

## ğŸ’¡ ê°œì„  ì œì•ˆ
- êµ¬ì²´ì  ì¡°ì¹˜`,
                pattern: `ì‹œê°„ëŒ€ë³„ íŒ¨í„´ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:
## ğŸ“ˆ ì‹œê°„ëŒ€ë³„ íŒ¨í„´
| ì‹œê°„ëŒ€ | í‰ê·  | ìœ„í—˜ë°œìƒ | íŠ¹ì§• |
|---|---|---|---|

## ğŸ”´ ìœ„í—˜ ì§‘ì¤‘ ì‹œê°„ëŒ€
- 1700+ ìì£¼ ë°œìƒí•˜ëŠ” ì‹œê°„ëŒ€
- ì•ŒëŒ ë°œìƒ ì§‘ì¤‘ ì‹œê°„ëŒ€

## ğŸ”” ì•ŒëŒ íŒ¨í„´
- 10ë¶„/30ë¶„/ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ë°œìƒ ì‹œê°„ëŒ€ íŠ¹ì„±
- ì•ŒëŒ ê°„ ì‹œê°„ ê°„ê²© ë¶„ì„

## ğŸ’¡ ìš´ì˜ ì œì•ˆ
- ëª¨ë‹ˆí„°ë§ ê°•í™” ì‹œê°„ëŒ€
- ì•ŒëŒ ì„ê³„ê°’ ì¡°ì • ì œì•ˆ`,
                prediction: `ì˜ˆì¸¡ ëª¨ë¸ ì„±ëŠ¥ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:
## ğŸ¯ ëª¨ë¸ ì„±ëŠ¥ ìš”ì•½
| ì§€í‘œ | ê°’ | íŒì • |
|---|---|---|
- ì •í™•ë„, ì¬í˜„ìœ¨, ì •ë°€ë„, F1-Score

## ğŸ“Š í˜¼ë™ í–‰ë ¬ ë¶„ì„
- TP(ì •íƒ): ìœ„í—˜ ì˜ˆì¸¡ â†’ ì‹¤ì œ ìœ„í—˜ âœ…
- TN(ì •ìƒ): ì •ìƒ ì˜ˆì¸¡ â†’ ì‹¤ì œ ì •ìƒ âœ…
- FP(ì˜¤íƒ): ìœ„í—˜ ì˜ˆì¸¡ â†’ ì‹¤ì œ ì •ìƒ âš ï¸
- FN(ë¯¸íƒ): ì •ìƒ ì˜ˆì¸¡ â†’ ì‹¤ì œ ìœ„í—˜ ğŸ”´

## ğŸ”” ì•ŒëŒ vs ì˜ˆì¸¡ ë¹„êµ
- 10ë¶„/30ë¶„ ì˜ˆì¸¡ ì•ŒëŒ ì •í™•ë„
- ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒê³¼ì˜ ì¼ì¹˜ìœ¨

## âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­
- FN ê°ì†Œ ë°©ì•ˆ (ë†“ì¹œ ìœ„í—˜ ì¤„ì´ê¸°)
- FP ê°ì†Œ ë°©ì•ˆ (ì˜¤íƒ ì¤„ì´ê¸°)`
            }
        };

        // í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ì—´ê¸°
        function openPromptModal() {
            loadPrompts();
            loadLlmStatus();
            document.getElementById('prompt-modal').style.display = 'flex';
        }

        // í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePromptModal() {
            document.getElementById('prompt-modal').style.display = 'none';
        }

        // LLM ìƒíƒœ ë¡œë“œ
        async function loadLlmStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.llm-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                let activeMode = 'local';

                if (data.llm_mode === 'api') {
                    if (data.env === 'prod') {
                        activeMode = 'prod';
                    } else {
                        activeMode = 'dev';
                    }
                }

                const activeBtn = document.querySelector(`.llm-mode-btn[data-mode="${activeMode}"]`);
                if (activeBtn) activeBtn.classList.add('active');

                // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ë§Œ í‘œì‹œ
                if (data.models) {
                    const labelEl = document.getElementById('current-model-label');
                    const nameEl = document.getElementById('current-model-name');

                    if (activeMode === 'dev') {
                        labelEl.textContent = 'ğŸŒ ê°œë°œ API:';
                        nameEl.textContent = data.models.dev || '-';
                    } else if (activeMode === 'prod') {
                        labelEl.textContent = 'ğŸ¢ ìš´ì˜ API:';
                        nameEl.textContent = data.models.prod || '-';
                    } else {
                        labelEl.textContent = 'ğŸ’» ë¡œì»¬ GGUF:';
                        nameEl.textContent = data.models.local || '-';
                    }
                }
            } catch (e) {
                console.error('LLM ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        // LLM ëª¨ë“œ ë³€ê²½
        async function setLlmMode(mode) {
            try {
                let apiMode = 'local';
                let env = 'dev';

                if (mode === 'dev') {
                    apiMode = 'api';
                    env = 'dev';
                } else if (mode === 'prod') {
                    apiMode = 'api';
                    env = 'prod';
                }

                const res = await fetch('/api/llm_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: apiMode, env: env })
                });

                const data = await res.json();

                if (data.success) {
                    loadLlmStatus();
                    alert(`LLM ëª¨ë“œ ë³€ê²½: ${mode === 'local' ? 'ë¡œì»¬ GGUF' : mode === 'dev' ? 'ê°œë°œ API' : 'ìš´ì˜ API'}`);
                } else {
                    alert(`ëª¨ë“œ ë³€ê²½ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (e) {
                console.error('LLM ëª¨ë“œ ë³€ê²½ ì‹¤íŒ¨:', e);
                alert('LLM ëª¨ë“œ ë³€ê²½ ì‹¤íŒ¨');
            }
        }

        // í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        async function loadPrompts() {
            try {
                const res = await fetch('/api/prompts');
                const data = await res.json();

                document.getElementById('system-prompt').value = data.system_prompt || defaultPrompts.system;
                document.getElementById('template-summary').value = data.templates?.summary || defaultPrompts.templates.summary;
                document.getElementById('template-pattern').value = data.templates?.pattern || defaultPrompts.templates.pattern;
                document.getElementById('template-prediction').value = data.templates?.prediction || defaultPrompts.templates.prediction;
            } catch (e) {
                console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
                // ê¸°ë³¸ê°’ ì‚¬ìš©
                document.getElementById('system-prompt').value = defaultPrompts.system;
                document.getElementById('template-summary').value = defaultPrompts.templates.summary;
                document.getElementById('template-pattern').value = defaultPrompts.templates.pattern;
                document.getElementById('template-prediction').value = defaultPrompts.templates.prediction;
            }
        }

        // í”„ë¡¬í”„íŠ¸ ì €ì¥
        async function savePrompts() {
            try {
                const res = await fetch('/api/prompts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system_prompt: document.getElementById('system-prompt').value,
                        templates: {
                            summary: document.getElementById('template-summary').value,
                            pattern: document.getElementById('template-pattern').value,
                            prediction: document.getElementById('template-prediction').value
                        }
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closePromptModal();
                } else {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (e) {
                console.error('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨:', e);
                alert('âŒ ì €ì¥ ì‹¤íŒ¨');
            }
        }

        // í”„ë¡¬í”„íŠ¸ íƒ­ ì „í™˜
        function switchPromptTab(tab) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.prompt-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.prompt-tab[data-tab="${tab}"]`).classList.add('active');

            // textarea í‘œì‹œ/ìˆ¨ê¹€
            document.querySelectorAll('.template-textarea').forEach(ta => {
                if (ta.id.startsWith('template-')) {
                    ta.style.display = 'none';
                }
            });
            document.getElementById('template-' + tab).style.display = 'block';
        }

        // í”„ë¡¬í”„íŠ¸ ê¸°ë³¸ê°’ ë³µì›
        function resetPrompts() {
            if (confirm('ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('system-prompt').value = defaultPrompts.system;
                document.getElementById('template-summary').value = defaultPrompts.templates.summary;
                document.getElementById('template-pattern').value = defaultPrompts.templates.pattern;
                document.getElementById('template-prediction').value = defaultPrompts.templates.prediction;
            }
        }
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function loadToday() {
            const today = new Date();
            document.getElementById('date-start').value = formatDate(today);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date-start').value = formatDate(yesterday);
            document.getElementById('date-end').value = formatDate(yesterday);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadLast3Days() {
            const today = new Date();
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
            document.getElementById('date-start').value = formatDate(threeDaysAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function loadThisWeek() {
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 6);
            document.getElementById('date-start').value = formatDate(weekAgo);
            document.getElementById('date-end').value = formatDate(today);
            document.getElementById('time-start').value = '00:00';
            document.getElementById('time-end').value = '23:59';
            loadData();
        }
        
        function downloadCSV() {
            if (!currentData || !currentData.data || currentData.data.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì„¸ìš”');
                return;
            }
            
            const dateStart = document.getElementById('date-start').value.replace(/-/g, '');
            const dateEnd = document.getElementById('date-end').value.replace(/-/g, '');
            const timeStart = document.getElementById('time-start').value.replace(':', '');
            const timeEnd = document.getElementById('time-end').value.replace(':', '');
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ìƒì„±
            const alertMap10 = {};
            const alertMap30 = {};
            (currentData.alerts_10 || []).forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            (currentData.alerts_30 || []).forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            // CSV í—¤ë” (ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì»¬ëŸ¼ ì¶”ê°€)
            const headers = ['CURRTIME', 'TOTALCNT', 'PRED_TIME_10', 'PREDICT_10', 'PROG_ALERT_10', 'PRED_TIME_30', 'PREDICT_30', 'PROG_ALERT_30', 'LOGPRESSO_ALARM'];
            let csv = headers.join(',') + '\n';
            
            // CSV ë°ì´í„°
            currentData.data.forEach(row => {
                const currtime = String(row.CURRTIME);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                const logpressoAlarm = logpressoAlarmMap[currtime];
                
                // í”„ë¡œê·¸ë¨ ì•ŒëŒ í…ìŠ¤íŠ¸ ìƒì„± (ì¿¨íƒ€ì„ í¬í•¨)
                let alert10Text = '';
                if (alert10) {
                    if (alert10.IS_ALARM) {
                        alert10Text = `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸`;
                    } else {
                        alert10Text = `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert10.COOLDOWN_MINS}ë¶„`;
                    }
                }
                
                let alert30Text = '';
                if (alert30) {
                    if (alert30.IS_ALARM) {
                        alert30Text = `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸`;
                    } else {
                        alert30Text = `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert30.COOLDOWN_MINS}ë¶„`;
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ í…ìŠ¤íŠ¸ (ì•ŒëŒ/ì¿¨íƒ€ì„ êµ¬ë¶„)
                let logpressoText = '';
                if (logpressoAlarm) {
                    if (logpressoAlarm.IS_ALARM) {
                        logpressoText = `ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ${logpressoAlarm.ALARM_NO}ë²ˆì§¸`;
                    } else {
                        logpressoText = `ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ${logpressoAlarm.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${logpressoAlarm.COOLDOWN_MINS}ë¶„`;
                    }
                }
                
                const values = [
                    row.CURRTIME || '',
                    row.TOTALCNT || '',
                    row.PRED_TIME_10 || '',
                    row.PREDICT_10 || '',
                    alert10Text,
                    row.PRED_TIME_30 || '',
                    row.PREDICT_30 || '',
                    alert30Text,
                    logpressoText
                ];
                csv += values.join(',') + '\n';
            });
            
            // ë‹¤ìš´ë¡œë“œ
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `m14_history_${dateStart}_${dateEnd}_${timeStart}-${timeEnd}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function loadData() {
            const dateStartInput = document.getElementById('date-start').value;
            const dateEndInput = document.getElementById('date-end').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;
            
            if (!dateStartInput || !dateEndInput) {
                alert('ì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            // ë‚ ì§œ ë²”ìœ„ ìƒì„±
            const dateList = getDateRange(dateStartInput, dateEndInput);
            if (dateList.length === 0) {
                alert('ì‹œì‘ ë‚ ì§œê°€ ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ í½ë‹ˆë‹¤');
                return;
            }
            
            if (dateList.length > 30) {
                alert('ìµœëŒ€ 30ì¼ê¹Œì§€ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì‹œê°„ ë²”ìœ„ë¥¼ HHMM í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const startHHMM = timeStart.replace(':', '');
            const endHHMM = timeEnd.replace(':', '');
            
            document.getElementById('table-container').innerHTML = `<div class="loading">ë¡œë”© ì¤‘... (${dateList.length}ì¼)</div>`;
            
            try {
                // ê° ë‚ ì§œë³„ë¡œ API í˜¸ì¶œ
                let allData = [];
                let allAlerts10 = [];
                let allAlerts30 = [];
                
                for (const dateStr of dateList) {
                    const res = await fetch(`/api/history?date=${dateStr}`);
                    const data = await res.json();
                    
                    if (!data.error && data.data && data.data.length > 0) {
                        allData = allData.concat(data.data);
                        allAlerts10 = allAlerts10.concat(data.alerts_10 || []);
                        allAlerts30 = allAlerts30.concat(data.alerts_30 || []);
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì¡°íšŒ
                const fromTime = dateStartInput.replace(/-/g, '') + startHHMM + '00';
                const toTime = dateEndInput.replace(/-/g, '') + endHHMM + '00';
                
                try {
                    const alarmRes = await fetch(`/api/logpresso_alarm?from=${fromTime}&to=${toTime}`);
                    const alarmData = await alarmRes.json();
                    
                    logpressoAlarmMap = {};
                    if (alarmData.data && alarmData.data.length > 0) {
                        // ì‹œê°„ìˆœ ì •ë ¬
                        const sortedAlarms = alarmData.data.sort((a, b) => String(a.MEAS_TM).localeCompare(String(b.MEAS_TM)));
                        
                        // ì¿¨íƒ€ì„ ê³„ì‚° (60ë¶„)
                        let lastAlarmTime = null;
                        let alarmNo = 0;
                        
                        sortedAlarms.forEach(a => {
                            const measTm = String(a.MEAS_TM);
                            const currentTime = parseTime(measTm);
                            
                            let isAlarm = false;
                            let cooldownMins = 0;
                            
                            if (lastAlarmTime === null) {
                                // ì²« ë²ˆì§¸ ì•ŒëŒ
                                isAlarm = true;
                                alarmNo = 1;
                                lastAlarmTime = currentTime;
                            } else {
                                const diffMins = (currentTime - lastAlarmTime) / (1000 * 60);
                                if (diffMins >= 60) {
                                    // 60ë¶„ ì§€ë‚¨ - ìƒˆ ì•ŒëŒ
                                    isAlarm = true;
                                    alarmNo++;
                                    lastAlarmTime = currentTime;
                                } else {
                                    // ì¿¨íƒ€ì„ ì¤‘
                                    isAlarm = false;
                                    cooldownMins = Math.round(60 - diffMins);
                                }
                            }
                            
                            logpressoAlarmMap[measTm] = {
                                ...a,
                                IS_ALARM: isAlarm,
                                ALARM_NO: alarmNo,
                                COOLDOWN_MINS: cooldownMins
                            };
                        });
                        console.log(`ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ${alarmData.data.length}ê°œ ë¡œë“œ (ì•ŒëŒ ${alarmNo}íšŒ)`);
                    }
                } catch (e) {
                    console.log('ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì¡°íšŒ ì‹¤íŒ¨:', e);
                    logpressoAlarmMap = {};
                }
                
                // YYYYMMDDHHMM -> Date ë³€í™˜
                function parseTime(timeStr) {
                    const s = String(timeStr);
                    if (s.length >= 12) {
                        const y = parseInt(s.slice(0,4));
                        const m = parseInt(s.slice(4,6)) - 1;
                        const d = parseInt(s.slice(6,8));
                        const h = parseInt(s.slice(8,10));
                        const min = parseInt(s.slice(10,12));
                        return new Date(y, m, d, h, min);
                    }
                    return new Date();
                }
                
                if (allData.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>í•´ë‹¹ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                // ì‹œê°„ ë²”ìœ„ í•„í„°ë§ (ì‹œì‘ì¼ ì‹œì‘ì‹œê°„ ~ ì¢…ë£Œì¼ ì¢…ë£Œì‹œê°„)
                const startDateTime = dateStartInput.replace(/-/g, '') + startHHMM;
                const endDateTime = dateEndInput.replace(/-/g, '') + endHHMM;
                
                const filteredData = allData.filter(row => {
                    const currtime = String(row.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                // ì•ŒëŒë„ í•„í„°ë§
                const filteredAlerts10 = allAlerts10.filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                const filteredAlerts30 = allAlerts30.filter(a => {
                    const currtime = String(a.CURRTIME);
                    if (currtime.length >= 12) {
                        const rowDateTime = currtime.slice(0, 12);
                        return rowDateTime >= startDateTime && rowDateTime <= endDateTime;
                    }
                    return true;
                });
                
                if (filteredData.length === 0) {
                    document.getElementById('table-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ•</div>
                            <div>ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤<br><small>${dateStartInput} ${timeStart} ~ ${dateEndInput} ${timeEnd}</small></div>
                        </div>
                    `;
                    document.getElementById('stats-row').style.display = 'none';
                    document.getElementById('chart-section').style.display = 'none';
                    return;
                }
                
                // CURRTIME ê¸°ì¤€ ì •ë ¬
                filteredData.sort((a, b) => String(a.CURRTIME).localeCompare(String(b.CURRTIME)));
                
                const filteredResult = {
                    data: filteredData,
                    alerts_10: filteredAlerts10,
                    alerts_30: filteredAlerts30
                };
                
                currentData = filteredResult;  // ë‹¤ìš´ë¡œë“œìš© ì €ì¥
                
                // í†µê³„ ê³„ì‚°
                updateStats(filteredResult);
                
                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                drawChart(filteredResult);
                
                // í…Œì´ë¸” ê·¸ë¦¬ê¸°
                drawTable(filteredResult);
                
                document.getElementById('stats-row').style.display = 'flex';
                document.getElementById('chart-section').style.display = 'block';
                
                const rangeText = dateStartInput === dateEndInput 
                    ? `${dateStartInput} ${timeStart}~${timeEnd}`
                    : `${dateStartInput} ${timeStart} ~ ${dateEndInput} ${timeEnd}`;
                document.getElementById('table-info').textContent = `${rangeText} | ${filteredData.length}ê°œ ë°ì´í„°`;
                
            } catch (e) {
                console.error(e);
                document.getElementById('table-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div>ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨</div>
                    </div>
                `;
            }
        }
        
        // ë‚ ì§œ ë²”ìœ„ ìƒì„± í•¨ìˆ˜
        function getDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) return [];
            
            const current = new Date(start);
            while (current <= end) {
                const y = current.getFullYear();
                const m = String(current.getMonth() + 1).padStart(2, '0');
                const d = String(current.getDate()).padStart(2, '0');
                dates.push(`${y}${m}${d}`);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }
        
        function updateStats(data) {
            const rows = data.data;
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            
            // ê¸°ë³¸ í†µê³„
            document.getElementById('stat-count').textContent = rows.length;
            document.getElementById('stat-avg').textContent = Math.round(totalcnts.reduce((a,b) => a+b, 0) / totalcnts.length);
            
            const maxVal = Math.max(...totalcnts);
            const maxIdx = totalcnts.indexOf(maxVal);
            document.getElementById('stat-max').textContent = maxVal;
            document.getElementById('stat-max').className = 'stat-value ' + getValueClass(maxVal);
            document.getElementById('stat-max-time').textContent = formatTime(rows[maxIdx].CURRTIME);
            
            const overCount = totalcnts.filter(v => v >= 1700).length;
            document.getElementById('stat-over').textContent = overCount;
            
            // ì˜ˆì¸¡ ì •í™•ë„ ê³„ì‚° (1700+ ì˜ˆì¸¡ ì ì¤‘ë¥ )
            let acc10Hit = 0;   // 1700+ ì˜ˆì¸¡ ì„±ê³µ
            let acc10Total = 0; // 1700+ ì˜ˆì¸¡ ì‹œë„
            let acc30Hit = 0;
            let acc30Total = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // 10ë¶„ ì˜ˆì¸¡ ê²€ì¦: ì˜ˆì¸¡ì´ 1700+ì¼ ë•Œ, ì‹¤ì œë¡œ 10ë¶„ í›„ 1700+ ëëŠ”ì§€
                if (i + 10 < rows.length && row.PREDICT_10 >= 1700) {
                    const actual = rows[i + 10].TOTALCNT;
                    acc10Total++;  // 1700+ ì˜ˆì¸¡ íšŸìˆ˜
                    if (actual >= 1700) acc10Hit++;  // ì‹¤ì œë¡œ 1700+ ëœ íšŸìˆ˜
                }
                
                // 30ë¶„ ì˜ˆì¸¡ ê²€ì¦
                if (i + 30 < rows.length && row.PREDICT_30 >= 1700) {
                    const actual = rows[i + 30].TOTALCNT;
                    acc30Total++;
                    if (actual >= 1700) acc30Hit++;
                }
            }
            
            const acc10 = acc10Total > 0 ? Math.round(acc10Hit / acc10Total * 100) : 0;
            const acc30 = acc30Total > 0 ? Math.round(acc30Hit / acc30Total * 100) : 0;
            
            document.getElementById('stat-acc10').textContent = acc10Total > 0 ? acc10 + '%' : '-';
            document.getElementById('stat-acc10').className = 'stat-value ' + getAccuracyClass(acc10);
            document.getElementById('stat-acc10-sub').textContent = `${acc10Hit}/${acc10Total} ì ì¤‘`;
            
            document.getElementById('stat-acc30').textContent = acc30Total > 0 ? acc30 + '%' : '-';
            document.getElementById('stat-acc30').className = 'stat-value ' + getAccuracyClass(acc30);
            document.getElementById('stat-acc30-sub').textContent = `${acc30Hit}/${acc30Total} ì ì¤‘`;
        }
        
        function getValueClass(val) {
            if (val >= 1700) return 'value-danger';
            if (val >= 1600) return 'value-warning';
            return 'value-normal';
        }
        
        function getAccuracyClass(acc) {
            if (acc >= 70) return 'accuracy-good';
            if (acc >= 50) return 'accuracy-ok';
            return 'accuracy-bad';
        }
        
        function formatTime(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function formatTimeChart(currtime) {
            // ì°¨íŠ¸ìš©: MM-DD HH:MM í˜•ì‹ (í•­ìƒ ë‚ ì§œ í¬í•¨)
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function formatTimeFull(currtime) {
            const s = String(currtime);
            if (s.length >= 12) {
                return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
            }
            return s;
        }
        
        function drawChart(data) {
            const rows = data.data;
            const alerts10 = data.alerts_10 || [];
            const alerts30 = data.alerts_30 || [];
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ìƒì„±
            const alertMap10 = {};
            const alertMap30 = {};
            alerts10.forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            alerts30.forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            // ì—¬ëŸ¬ ë‚ ì§œì¸ì§€ í™•ì¸ (í…Œì´ë¸”ìš©)
            const dates = new Set(rows.map(r => String(r.CURRTIME).slice(0, 8)));
            const isMultipleDays = dates.size > 1;
            
            // ê·¸ë˜í”„ xì¶•: í•­ìƒ ë‚ ì§œ í¬í•¨ (MM-DD HH:MM)
            const times = rows.map(r => formatTimeChart(r.CURRTIME));
            const totalcnts = rows.map(r => r.TOTALCNT || 0);
            const pred10s = rows.map(r => r.PREDICT_10 || 0);
            const pred30s = rows.map(r => r.PREDICT_30 || 0);
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ì  ë°ì´í„° (ì•ŒëŒ/ì¿¨íƒ€ì„ êµ¬ë¶„)
            const progAlarmData = [];  // {time, value, fullTime, isAlarm, text}
            
            rows.forEach((r, i) => {
                const currtime = String(r.CURRTIME);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                
                // 10ë¶„ ë˜ëŠ” 30ë¶„ ì•ŒëŒ ê¸°ë¡ ìˆìœ¼ë©´
                if (alert10 || alert30) {
                    const fullTime = currtime.length >= 12 ? 
                        `${currtime.slice(0,4)}-${currtime.slice(4,6)}-${currtime.slice(6,8)} ${currtime.slice(8,10)}:${currtime.slice(10,12)}` : currtime;
                    
                    // IS_ALARM ì—¬ë¶€ í™•ì¸ (10ë¶„/30ë¶„ ì¤‘ í•˜ë‚˜ë¼ë„ ì•ŒëŒì´ë©´ ì•ŒëŒ)
                    const isAlarm = (alert10 && alert10.IS_ALARM) || (alert30 && alert30.IS_ALARM);
                    
                    let text = '';
                    if (alert10) {
                        if (alert10.IS_ALARM) {
                            text += `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸`;
                        } else {
                            text += `10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert10.COOLDOWN_MINS}ë¶„`;
                        }
                    }
                    if (alert30) {
                        if (alert30.IS_ALARM) {
                            text += (text ? '<br>' : '') + `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸`;
                        } else {
                            text += (text ? '<br>' : '') + `30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert30.COOLDOWN_MINS}ë¶„`;
                        }
                    }
                    
                    progAlarmData.push({
                        time: times[i],
                        value: r.TOTALCNT || 0,
                        fullTime: fullTime,
                        isAlarm: isAlarm,
                        text: text
                    });
                }
            });
            
            // ì•ŒëŒë§Œ í•„í„°
            const progAlarmOnly = progAlarmData.filter(d => d.isAlarm);
            // ì¿¨íƒ€ì„ë§Œ í•„í„°
            const progCooldownOnly = progAlarmData.filter(d => !d.isAlarm);
            
            // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì  ë°ì´í„° (ì•ŒëŒ/ì¿¨íƒ€ì„ êµ¬ë¶„)
            const logAlarmData = [];  // {time, value, fullTime, isAlarm, alarmNo, cooldownMins, desc}
            
            rows.forEach((r, i) => {
                const currtime = String(r.CURRTIME);
                const logAlarm = logpressoAlarmMap[currtime];
                
                if (logAlarm) {
                    const fullTime = currtime.length >= 12 ? 
                        `${currtime.slice(0,4)}-${currtime.slice(4,6)}-${currtime.slice(6,8)} ${currtime.slice(8,10)}:${currtime.slice(10,12)}` : currtime;
                    logAlarmData.push({
                        time: times[i],
                        value: r.TOTALCNT || 0,
                        fullTime: fullTime,
                        isAlarm: logAlarm.IS_ALARM,
                        alarmNo: logAlarm.ALARM_NO,
                        cooldownMins: logAlarm.COOLDOWN_MINS,
                        desc: logAlarm.ALARM_DESC || 'ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ'
                    });
                }
            });
            
            // ì•ŒëŒë§Œ í•„í„°
            const logAlarmOnly = logAlarmData.filter(d => d.isAlarm);
            // ì¿¨íƒ€ì„ë§Œ í•„í„°
            const logCooldownOnly = logAlarmData.filter(d => !d.isAlarm);
            
            // customdata: YYYY-MM-DD HH:MM í˜•ì‹
            const timesFullFormat = rows.map(r => {
                const s = String(r.CURRTIME);
                if (s.length >= 12) {
                    return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)} ${s.slice(8,10)}:${s.slice(10,12)}`;
                }
                return s;
            });
            
            // ì˜ˆì¸¡ìš© customdata: [ì˜ˆì¸¡ì‹œì , ê¸°ì¤€ì‹œì ]
            const customdata_pred10 = [];
            for (let i = 0; i < times.length - 10; i++) {
                customdata_pred10.push([timesFullFormat[i + 10], timesFullFormat[i]]);
            }
            
            const customdata_pred30 = [];
            for (let i = 0; i < times.length - 30; i++) {
                customdata_pred30.push([timesFullFormat[i + 30], timesFullFormat[i]]);
            }
            
            const traces = [
                {
                    x: times,
                    y: totalcnts,
                    customdata: timesFullFormat,
                    name: 'TOTALCNT',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#3b82f6', width: 2 },
                    hovertemplate: '%{customdata} (%{y:,})<extra>TOTALCNT</extra>'
                },
                {
                    x: times.slice(10),
                    y: pred10s.slice(0, -10),
                    customdata: customdata_pred10,
                    name: 'ì˜ˆì¸¡(10ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#22c55e', width: 1, dash: 'dot' },
                    hovertemplate: 'ì˜ˆì¸¡ì‹œì : %{customdata[0]} (%{y:,})<br>ê¸°ì¤€ì‹œì : %{customdata[1]}<extra>ì˜ˆì¸¡(10ë¶„)</extra>'
                },
                {
                    x: times.slice(30),
                    y: pred30s.slice(0, -30),
                    customdata: customdata_pred30,
                    name: 'ì˜ˆì¸¡(30ë¶„)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#f97316', width: 1, dash: 'dash' },
                    hovertemplate: 'ì˜ˆì¸¡ì‹œì : %{customdata[0]} (%{y:,})<br>ê¸°ì¤€ì‹œì : %{customdata[1]}<extra>ì˜ˆì¸¡(30ë¶„)</extra>'
                },
                {
                    x: progAlarmOnly.map(d => d.time),
                    y: progAlarmOnly.map(d => d.value),
                    customdata: progAlarmOnly.map(d => [d.fullTime, d.text]),
                    name: 'â—í”„ë¡œê·¸ë¨ì•ŒëŒ',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#ef4444', size: 12, symbol: 'circle' },
                    hovertemplate: '%{customdata[1]}<br>%{customdata[0]}<extra></extra>'
                },
                {
                    x: progCooldownOnly.map(d => d.time),
                    y: progCooldownOnly.map(d => d.value),
                    customdata: progCooldownOnly.map(d => [d.fullTime, d.text]),
                    name: 'â—‹í”„ë¡œê·¸ë¨ì¿¨íƒ€ì„',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#f87171', size: 8, symbol: 'circle-open', line: { width: 2, color: '#f87171' } },
                    hovertemplate: '%{customdata[1]}<br>%{customdata[0]}<extra></extra>',
                    visible: 'legendonly'
                },
                {
                    x: logAlarmOnly.map(d => d.time),
                    y: logAlarmOnly.map(d => d.value),
                    customdata: logAlarmOnly.map(d => [`ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ${d.alarmNo}ë²ˆì§¸`, d.fullTime, d.desc]),
                    name: 'â—†ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#8b5cf6', size: 12, symbol: 'diamond' },
                    hovertemplate: '%{customdata[0]}<br>%{customdata[2]}<br>%{customdata[1]}<extra></extra>'
                },
                {
                    x: logCooldownOnly.map(d => d.time),
                    y: logCooldownOnly.map(d => d.value),
                    customdata: logCooldownOnly.map(d => [`ë¡œê·¸í”„ë ˆì†Œ ì¿¨íƒ€ì„ (${d.alarmNo}ë²ˆì§¸ í›„ ${d.cooldownMins}ë¶„)`, d.fullTime, d.desc]),
                    name: 'â—‡ë¡œê·¸í”„ë ˆì†Œì¿¨íƒ€ì„',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { color: '#a855f7', size: 8, symbol: 'diamond-open', line: { width: 2, color: '#a855f7' } },
                    hovertemplate: '%{customdata[0]}<br>%{customdata[2]}<br>%{customdata[1]}<extra></extra>',
                    visible: 'legendonly'
                }
            ];
            
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#a1a1aa', family: 'Space Grotesk', size: 11 },
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h' },
                xaxis: {
                    gridcolor: '#27272a',
                    tickangle: -45
                },
                yaxis: {
                    gridcolor: '#27272a',
                    range: [1000, 2000]
                },
                margin: { t: 30, r: 20, b: 60, l: 50 },
                shapes: [{
                    type: 'line',
                    y0: 1700, y1: 1700,
                    x0: 0, x1: 1, xref: 'paper',
                    line: { color: '#ef4444', width: 2, dash: 'solid' }
                }]
            };
            
            Plotly.newPlot('chart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        function drawTable(data) {
            const rows = data.data;
            const alerts10 = data.alerts_10 || [];
            const alerts30 = data.alerts_30 || [];
            
            // ì—¬ëŸ¬ ë‚ ì§œì¸ì§€ í™•ì¸
            const dates = new Set(rows.map(r => String(r.CURRTIME).slice(0, 8)));
            const isMultipleDays = dates.size > 1;
            
            // í”„ë¡œê·¸ë¨ ì•ŒëŒ ë§µ ë§Œë“¤ê¸°
            const alertMap10 = {};
            alerts10.forEach(a => { alertMap10[String(a.CURRTIME)] = a; });
            const alertMap30 = {};
            alerts30.forEach(a => { alertMap30[String(a.CURRTIME)] = a; });
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: ${isMultipleDays ? '120px' : '80px'};">ì‹œê°„</th>
                            <th style="width: 100px;">TOTALCNT</th>
                            <th style="width: 150px;">10ë¶„í›„ ì˜ˆì¸¡</th>
                            <th style="width: 150px;">30ë¶„í›„ ì˜ˆì¸¡</th>
                            <th>í”„ë¡œê·¸ë¨ì•ŒëŒ</th>
                            <th>ë¡œê·¸í”„ë ˆì†Œì•ŒëŒ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                const timeDisplay = isMultipleDays ? formatTimeChart(currtime) : formatTime(currtime);
                const alert10 = alertMap10[currtime];
                const alert30 = alertMap30[currtime];
                const logAlarm = logpressoAlarmMap[currtime];
                
                // ì˜ˆì¸¡ ì‹œì  ê³„ì‚°
                const predTime10 = row.PRED_TIME_10 ? formatTime(String(row.PRED_TIME_10)) : '-';
                const predTime30 = row.PRED_TIME_30 ? formatTime(String(row.PRED_TIME_30)) : '-';
                
                // í”„ë¡œê·¸ë¨ ì•ŒëŒ HTML (ìƒì„¸ ë°ì´í„°ëŠ” ì¿¨íƒ€ì„ í¬í•¨)
                let progAlarmHtml = '';
                if (alert10) {
                    if (alert10.IS_ALARM) {
                        progAlarmHtml += `<span class="alert-badge alarm">ğŸ”” 10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸</span> `;
                    } else {
                        progAlarmHtml += `<span class="alert-badge cooldown">â± 10ë¶„ ì•ŒëŒ ${alert10.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert10.COOLDOWN_MINS}ë¶„</span> `;
                    }
                }
                if (alert30) {
                    if (alert30.IS_ALARM) {
                        progAlarmHtml += `<span class="alert-badge alarm">ğŸ”” 30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸</span> `;
                    } else {
                        progAlarmHtml += `<span class="alert-badge cooldown">â± 30ë¶„ ì•ŒëŒ ${alert30.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${alert30.COOLDOWN_MINS}ë¶„</span> `;
                    }
                }
                
                // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ HTML
                let logAlarmHtml = '-';
                if (logAlarm) {
                    if (logAlarm.IS_ALARM) {
                        logAlarmHtml = `<span class="alert-badge logpresso">â—† ${logAlarm.ALARM_NO}ë²ˆì§¸ ì•ŒëŒ</span>`;
                    } else {
                        logAlarmHtml = `<span class="alert-badge logpresso-cooldown">â—‡ ${logAlarm.ALARM_NO}ë²ˆì§¸ í›„ ì¿¨íƒ€ì„ ${logAlarm.COOLDOWN_MINS}ë¶„</span>`;
                    }
                }
                
                html += `
                    <tr>
                        <td style="font-weight: 600; color: #3b82f6;">${timeDisplay}</td>
                        <td class="${getValueClass(row.TOTALCNT)}" style="font-weight: 600;">${(row.TOTALCNT || 0).toLocaleString()}</td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_10)}" style="font-weight: 600;">${(row.PREDICT_10 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime10}</span>
                        </td>
                        <td>
                            <span class="${getValueClass(row.PREDICT_30)}" style="font-weight: 600;">${(row.PREDICT_30 || 0).toLocaleString()}</span>
                            <span style="color: #52525b; font-size: 10px; margin-left: 5px;">â†’ ${predTime30}</span>
                        </td>
                        <td>${progAlarmHtml || '-'}</td>
                        <td>${logAlarmHtml}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('table-container').innerHTML = html;
        }

        // ========================================
        // LLM ë¶„ì„ ê¸°ëŠ¥
        // ========================================
        let selectedLlmType = 'summary';
        let llmIsLoading = false;

        function openLlmAnalysisModal() {
            if (!currentData || !currentData.data || currentData.data.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì„¸ìš”');
                return;
            }

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('llm-modal').style.display = 'flex';

            // LLM ìƒíƒœ ë¡œë“œ
            loadLlmStatus();

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateLlmStats();

            // ê²°ê³¼ ì´ˆê¸°í™”
            document.getElementById('llm-result-container').innerHTML = `
                <div class="llm-empty">
                    <div class="llm-empty-icon">ğŸ¤–</div>
                    <div>ë¶„ì„ ìœ í˜•ì„ ì„ íƒí•˜ê³  <strong>ë¶„ì„ ì‹¤í–‰</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                </div>
            `;
            document.getElementById('llm-result-meta').textContent = '';
        }

        function closeLlmModal() {
            document.getElementById('llm-modal').style.display = 'none';
        }

        function updateLlmStats() {
            if (!currentData || !currentData.data) return;

            const rows = currentData.data;
            const totalcnts = rows.map(r => r.TOTALCNT || 0);

            // í†µê³„ ê³„ì‚°
            const count = rows.length;
            const avg = Math.round(totalcnts.reduce((a, b) => a + b, 0) / count);
            const max = Math.max(...totalcnts);
            const over1700 = totalcnts.filter(v => v >= 1700).length;

            // ì•ŒëŒ ë§µ ìƒì„± (10ë¶„ ì˜ˆì¸¡ ê¸°ì¤€)
            const alertMap10 = {};
            (currentData.alerts_10 || []).forEach(a => {
                alertMap10[String(a.CURRTIME)] = a;
            });

            // TP/TN/FP/FN ê³„ì‚° (10ë¶„ ì˜ˆì¸¡ ê¸°ì¤€)
            let tp = 0, tn = 0, fp = 0, fn = 0;
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                const actual = (row.TOTALCNT || 0) >= 1700;
                const alert = alertMap10[currtime];
                const predicted = alert ? alert.IS_ALARM : false;

                if (predicted && actual) tp++;      // ì˜ˆì¸¡O, ì‹¤ì œO
                else if (!predicted && !actual) tn++; // ì˜ˆì¸¡X, ì‹¤ì œX
                else if (predicted && !actual) fp++;  // ì˜ˆì¸¡O, ì‹¤ì œX (ì˜¤íƒ)
                else if (!predicted && actual) fn++;  // ì˜ˆì¸¡X, ì‹¤ì œO (ë†“ì¹¨)
            });

            // ì •í™•ë„ ê³„ì‚°
            const total = tp + tn + fp + fn;
            const accuracy = total > 0 ? Math.round((tp + tn) / total * 100) : 0;

            // ì•ŒëŒ ê°œìˆ˜
            const alerts10 = (currentData.alerts_10 || []).filter(a => a.IS_ALARM).length;
            const alerts30 = (currentData.alerts_30 || []).filter(a => a.IS_ALARM).length;
            const logpressoAlarms = Object.values(logpressoAlarmMap).filter(a => a.IS_ALARM).length;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('llm-stat-count').textContent = count.toLocaleString();
            document.getElementById('llm-stat-avg').textContent = avg.toLocaleString();
            document.getElementById('llm-stat-max').textContent = max.toLocaleString();
            document.getElementById('llm-stat-over').textContent = over1700;
            document.getElementById('llm-stat-accuracy').textContent = accuracy + '%';
            document.getElementById('llm-stat-tp').textContent = tp;
            document.getElementById('llm-stat-tn').textContent = tn;
            document.getElementById('llm-stat-fp').textContent = fp;
            document.getElementById('llm-stat-fn').textContent = fn;
            document.getElementById('llm-stat-alert10').textContent = alerts10;
            document.getElementById('llm-stat-alert30').textContent = alerts30;
            document.getElementById('llm-stat-logpresso').textContent = logpressoAlarms;
        }

        function selectLlmType(type) {
            selectedLlmType = type;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.llm-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        async function runLlmAnalysis() {
            if (llmIsLoading) return;
            if (!currentData || !currentData.data || currentData.data.length === 0) {
                alert('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            llmIsLoading = true;
            document.getElementById('btn-llm-analyze').disabled = true;
            document.getElementById('btn-llm-analyze').textContent = 'â³ ë¶„ì„ ì¤‘...';

            // ë¡œë”© í‘œì‹œ
            document.getElementById('llm-result-container').innerHTML = `
                <div class="llm-loading">
                    <div class="llm-loading-spinner"></div>
                    <div style="color: var(--text-secondary); font-size: 13px;">
                        LLMì´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                </div>
            `;

            try {
                // ë°ì´í„° ì¤€ë¹„
                const analysisData = prepareDataForLlm();

                // API í˜¸ì¶œ (ìŠ¤íŠ¸ë¦¬ë°)
                const res = await fetch('/api/llm_history_analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: analysisData.data,
                        stats: analysisData.stats,
                        analysis_type: selectedLlmType
                    })
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                const contentEl = document.getElementById('llm-result-container');
                contentEl.innerHTML = '<div class="llm-result-content" id="llm-streaming-content" style="white-space: pre-wrap;"><span class="streaming-cursor">â–Œ</span></div>';
                const streamingEl = document.getElementById('llm-streaming-content');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                // ì™„ë£Œ - ë§ˆí¬ë‹¤ìš´ ë³€í™˜
                                streamingEl.style.whiteSpace = 'normal';
                                streamingEl.innerHTML = formatMarkdownSimple(fullText);
                                document.getElementById('llm-result-meta').textContent =
                                    `${getTypeName(selectedLlmType)} | ${new Date().toLocaleTimeString()}`;
                            } else if (data.startsWith('[ERROR]')) {
                                streamingEl.innerHTML = `<span style="color: var(--danger);">${data}</span>`;
                            } else {
                                // ì¤„ë°”ê¿ˆ ë³µì›
                                fullText += data.replace(/â/g, '\n');
                                streamingEl.textContent = fullText;
                                streamingEl.innerHTML = streamingEl.textContent + '<span class="streaming-cursor">â–Œ</span>';
                                streamingEl.scrollTop = streamingEl.scrollHeight;
                            }
                        }
                    }
                }

            } catch (e) {
                console.error('LLM ë¶„ì„ ì‹¤íŒ¨:', e);
                document.getElementById('llm-result-container').innerHTML = `
                    <div class="llm-empty">
                        <div class="llm-empty-icon">âŒ</div>
                        <div>ë¶„ì„ ì‹¤íŒ¨: ${e.message}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                            llm_analysis_server.py ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
                        </div>
                    </div>
                `;
            } finally {
                llmIsLoading = false;
                document.getElementById('btn-llm-analyze').disabled = false;
                document.getElementById('btn-llm-analyze').textContent = 'ğŸ” ë¶„ì„ ì‹¤í–‰';
            }
        }

        function prepareDataForLlm() {
            const rows = currentData.data;
            const totalcnts = rows.map(r => r.TOTALCNT || 0);

            // ì‹œê°„ëŒ€ë³„ í†µê³„ ê³„ì‚°
            const hourlyStats = {};
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                if (currtime.length >= 10) {
                    const hour = currtime.slice(8, 10);
                    if (!hourlyStats[hour]) {
                        hourlyStats[hour] = { values: [], over1700: 0 };
                    }
                    hourlyStats[hour].values.push(row.TOTALCNT || 0);
                    if ((row.TOTALCNT || 0) >= 1700) {
                        hourlyStats[hour].over1700++;
                    }
                }
            });

            // ì‹œê°„ëŒ€ë³„ í‰ê·  ê³„ì‚°
            const hourlyAvg = {};
            Object.entries(hourlyStats).forEach(([hour, data]) => {
                const avg = Math.round(data.values.reduce((a, b) => a + b, 0) / data.values.length);
                hourlyAvg[hour + 'ì‹œ'] = { avg: avg, over1700: data.over1700 };
            });

            // ì•ŒëŒ ë§µ ìƒì„±
            const alertMap10 = {};
            (currentData.alerts_10 || []).forEach(a => {
                alertMap10[String(a.CURRTIME)] = a;
            });

            // TP/TN/FP/FN ê³„ì‚° (10ë¶„ ì˜ˆì¸¡ ê¸°ì¤€)
            let tp = 0, tn = 0, fp = 0, fn = 0;
            rows.forEach(row => {
                const currtime = String(row.CURRTIME);
                const actual = (row.TOTALCNT || 0) >= 1700;
                const alert = alertMap10[currtime];
                const predicted = alert ? alert.IS_ALARM : false;

                if (predicted && actual) tp++;
                else if (!predicted && !actual) tn++;
                else if (predicted && !actual) fp++;
                else if (!predicted && actual) fn++;
            });

            // ì•ŒëŒ ì •ë³´
            const alerts10 = (currentData.alerts_10 || []).filter(a => a.IS_ALARM);
            const alerts30 = (currentData.alerts_30 || []).filter(a => a.IS_ALARM);

            // ë¡œê·¸í”„ë ˆì†Œ ì•ŒëŒ ì •ë³´
            const logpressoAlarms = Object.values(logpressoAlarmMap).filter(a => a.IS_ALARM);

            // ê¸°ê°„ ì •ë³´
            const dateStart = document.getElementById('date-start').value;
            const dateEnd = document.getElementById('date-end').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;

            // ì •í™•ë„ ê³„ì‚°
            const total = tp + tn + fp + fn;
            const accuracy = total > 0 ? Math.round((tp + tn) / total * 100) : 0;

            return {
                data: rows.slice(0, 500), // ìµœëŒ€ 500ê°œ ìƒ˜í”Œ
                stats: {
                    period: `${dateStart} ${timeStart} ~ ${dateEnd} ${timeEnd}`,
                    total_count: rows.length,
                    avg_totalcnt: Math.round(totalcnts.reduce((a, b) => a + b, 0) / rows.length),
                    max_totalcnt: Math.max(...totalcnts),
                    min_totalcnt: Math.min(...totalcnts),
                    over_1700_count: totalcnts.filter(v => v >= 1700).length,
                    over_1600_count: totalcnts.filter(v => v >= 1600).length,
                    alerts_10_count: alerts10.length,
                    alerts_30_count: alerts30.length,
                    logpresso_alarms: logpressoAlarms.length,
                    hourly_stats: hourlyAvg,
                    // ì˜ˆì¸¡ ì„±ëŠ¥ ì§€í‘œ
                    accuracy: accuracy,
                    tp: tp,
                    tn: tn,
                    fp: fp,
                    fn: fn
                }
            };
        }

        function getTypeName(type) {
            const names = {
                'summary': 'ğŸ“‹ ìš”ì•½ ë¶„ì„',
                'pattern': 'ğŸ“ˆ íŒ¨í„´ ë¶„ì„',
                'prediction': 'ğŸ”® ì˜ˆì¸¡ ë¶„ì„'
            };
            return names[type] || type;
        }

        // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜
        function formatMarkdownSimple(text) {
            if (!text) return '';

            let html = text;

            // í…Œì´ë¸” ì²˜ë¦¬
            const tableRegex = /(\|[^\n]+\|\n)(\|[-:\s|]+\|\n)((?:\|[^\n]+\|\n?)+)/g;
            html = html.replace(tableRegex, function(match, headerRow, sepRow, bodyRows) {
                const headers = headerRow.split('|').filter(c => c.trim());
                const thRow = '<tr>' + headers.map(h => `<th>${h.trim()}</th>`).join('') + '</tr>';

                const rows = bodyRows.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(c => c.trim());
                    return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                }).join('');

                return `<table><thead>${thRow}</thead><tbody>${rows}</tbody></table>\n`;
            });

            // ì½”ë“œ ë¸”ë¡
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // í—¤ë”
            html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // ìˆ˜í‰ì„ 
            html = html.replace(/^---+$/gm, '<hr>');

            // ë³¼ë“œ/ì´íƒ¤ë¦­
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // ë¦¬ìŠ¤íŠ¸
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');

            // ì¤„ë°”ê¿ˆ
            html = html.replace(/\n\n+/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');

            // p íƒœê·¸ ì •ë¦¬
            html = '<p>' + html + '</p>';
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p>\s*(<h[1-4]>)/g, '$1');
            html = html.replace(/(<\/h[1-4]>)\s*<\/p>/g, '$1');
            html = html.replace(/<p>\s*(<table>)/g, '$1');
            html = html.replace(/(<\/table>)\s*<\/p>/g, '$1');
            html = html.replace(/<p>\s*(<hr>)/g, '$1');
            html = html.replace(/<p><br>/g, '<p>');

            return html;
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('llm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLlmModal();
            }
        });
    </script>
</body>
</html>