"""
ğŸ¤– Coding Agent - ì›Œí¬í”Œë¡œìš°
1. ê´€ë¦¬ì: ì‘ì—… ì§€ì‹œ
2. Ralph: ì½”ë“œ ìƒì„±
3. Ralph: 1ì°¨ ê²€ì¦ (ì‹¤í–‰/í…ŒìŠ¤íŠ¸)
   - ì‹¤íŒ¨ â†’ ë‹¤ì‹œ ìˆ˜ì • (ìê¸°ìˆ˜ì • ë£¨í”„)
   - ì„±ê³µ â†’ ìµœì¢… ìŠ¹ì¸ìì—ê²Œ ì œì¶œ
4. ìµœì¢… ìŠ¹ì¸ì: ìŠ¹ì¸/ê±°ì ˆ
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import threading
import time
import subprocess
import tempfile
import os

# ìƒ‰ìƒ
COLORS = {
    'bg': '#1e1e2e',
    'surface': '#313244',
    'overlay': '#45475a',
    'primary': '#6366f1',
    'success': '#10b981',
    'warning': '#f59e0b',
    'danger': '#ef4444',
    'text': '#cdd6f4',
    'muted': '#6c7086',
}


class CodingAgentApp:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("ğŸ¤– Coding Agent")
        self.root.geometry("1000x800")
        self.root.configure(bg=COLORS['bg'])
        
        # ìƒíƒœ
        self.generated_code = ""
        self.attempt = 0          # í˜„ì¬ ì‹œë„ íšŸìˆ˜
        self.max_attempts = 10    # ìµœëŒ€ ì‹œë„ íšŸìˆ˜
        self.errors = []          # ì—ëŸ¬ íˆìŠ¤í† ë¦¬
        
        self.create_ui()
    
    def run(self):
        self.root.mainloop()
    
    def create_ui(self):
        # ===== ìƒë‹¨: ì›Œí¬í”Œë¡œìš° í‘œì‹œ =====
        flow_frame = tk.Frame(self.root, bg=COLORS['surface'], height=90)
        flow_frame.pack(fill='x', padx=10, pady=10)
        flow_frame.pack_propagate(False)
        
        # ì›Œí¬í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨
        flow_label = tk.Label(
            flow_frame,
            text="ğŸ›¡ï¸ ê´€ë¦¬ì(ì§€ì‹œ) â†’ ğŸ¤– Ralph(ìƒì„±) â†’ ğŸ” Ralph(ê²€ì¦) â†’ âœ… ìµœì¢…ìŠ¹ì¸ì(í™•ì¸)",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['surface'],
            fg=COLORS['text']
        )
        flow_label.pack(pady=10)
        
        # í˜„ì¬ ìƒíƒœ
        self.status_label = tk.Label(
            flow_frame,
            text="ğŸ“ í˜„ì¬: ê´€ë¦¬ì - ì‘ì—… ì§€ì‹œ ëŒ€ê¸°ì¤‘",
            font=('Segoe UI', 11),
            bg=COLORS['surface'],
            fg=COLORS['primary']
        )
        self.status_label.pack()
        
        # ===== ë©”ì¸ ì˜ì—­ =====
        main = tk.Frame(self.root, bg=COLORS['bg'])
        main.pack(fill='both', expand=True, padx=10)
        
        # --- ì™¼ìª½: ê´€ë¦¬ì ì…ë ¥ ---
        left = tk.Frame(main, bg=COLORS['surface'], width=350)
        left.pack(side='left', fill='y', padx=(0, 5))
        left.pack_propagate(False)
        
        tk.Label(
            left,
            text="ğŸ›¡ï¸ ê´€ë¦¬ì - ì‘ì—… ì§€ì‹œ",
            font=('Segoe UI', 13, 'bold'),
            bg=COLORS['surface'],
            fg=COLORS['primary']
        ).pack(anchor='w', padx=15, pady=(15, 10))
        
        # í”„ë¡¬í”„íŠ¸ ì…ë ¥
        tk.Label(left, text="ë¬´ì—‡ì„ ë§Œë“¤ê¹Œìš”?", font=('Segoe UI', 10),
            bg=COLORS['surface'], fg=COLORS['muted']).pack(anchor='w', padx=15)
        
        self.prompt_text = scrolledtext.ScrolledText(
            left, font=('Segoe UI', 10), bg=COLORS['overlay'],
            fg=COLORS['text'], height=5, wrap='word'
        )
        self.prompt_text.pack(fill='x', padx=15, pady=5)
        self.prompt_text.insert('1.0', "Calculator í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤˜.\nadd, subtract, multiply, divide ë©”ì„œë“œ í¬í•¨.")
        
        # ì˜µì…˜
        opt_frame = tk.Frame(left, bg=COLORS['surface'])
        opt_frame.pack(fill='x', padx=15, pady=10)
        
        tk.Label(opt_frame, text="Ralph:", font=('Segoe UI', 10),
            bg=COLORS['surface'], fg=COLORS['muted']).pack(side='left')
        self.ralph_var = tk.StringVar(value='Backend Ralph')
        ttk.Combobox(opt_frame, textvariable=self.ralph_var,
            values=['Backend Ralph', 'Frontend Ralph', 'Test Ralph'],
            state='readonly', width=14).pack(side='left', padx=5)
        
        tk.Label(opt_frame, text="ì–¸ì–´:", font=('Segoe UI', 10),
            bg=COLORS['surface'], fg=COLORS['muted']).pack(side='left', padx=(10, 0))
        self.lang_var = tk.StringVar(value='python')
        ttk.Combobox(opt_frame, textvariable=self.lang_var,
            values=['python', 'javascript', 'java'],
            state='readonly', width=10).pack(side='left', padx=5)
        
        # ìµœëŒ€ ì‹œë„ íšŸìˆ˜
        retry_frame = tk.Frame(left, bg=COLORS['surface'])
        retry_frame.pack(fill='x', padx=15, pady=5)
        
        tk.Label(retry_frame, text="ìµœëŒ€ ì¬ì‹œë„:", font=('Segoe UI', 10),
            bg=COLORS['surface'], fg=COLORS['muted']).pack(side='left')
        self.retry_var = tk.StringVar(value='10')
        tk.Spinbox(retry_frame, from_=1, to=20, textvariable=self.retry_var,
            width=5, font=('Segoe UI', 10)).pack(side='left', padx=10)
        
        # ì‹œì‘ ë²„íŠ¼
        self.start_btn = tk.Button(
            left, text="ğŸš€ Ralphì—ê²Œ ì‹œí‚¤ê¸°",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['primary'], fg='white',
            relief='flat', cursor='hand2',
            command=self.start_work
        )
        self.start_btn.pack(fill='x', padx=15, pady=15)
        
        # Ralph ì§„í–‰ ìƒíƒœ
        tk.Label(left, text="ğŸ¤– Ralph ì‘ì—… í˜„í™©",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['surface'], fg=COLORS['warning']).pack(anchor='w', padx=15, pady=(10, 5))
        
        self.ralph_log = scrolledtext.ScrolledText(
            left, font=('Consolas', 9), bg=COLORS['overlay'],
            fg=COLORS['text'], height=12
        )
        self.ralph_log.pack(fill='both', expand=True, padx=15, pady=(0, 15))
        self.ralph_log.insert('1.0', "ëŒ€ê¸° ì¤‘...")
        
        # --- ì˜¤ë¥¸ìª½: ì½”ë“œ & ìµœì¢… ìŠ¹ì¸ ---
        right = tk.Frame(main, bg=COLORS['surface'])
        right.pack(side='right', fill='both', expand=True, padx=(5, 0))
        
        tk.Label(
            right,
            text="ğŸ“„ ìƒì„±ëœ ì½”ë“œ",
            font=('Segoe UI', 13, 'bold'),
            bg=COLORS['surface'],
            fg=COLORS['success']
        ).pack(anchor='w', padx=15, pady=(15, 5))
        
        # ì‹œë„ íšŸìˆ˜ í‘œì‹œ
        self.attempt_label = tk.Label(
            right,
            text="ì‹œë„: 0 / 10",
            font=('Segoe UI', 10),
            bg=COLORS['surface'],
            fg=COLORS['muted']
        )
        self.attempt_label.pack(anchor='w', padx=15)
        
        # ì½”ë“œ í‘œì‹œ
        self.code_text = scrolledtext.ScrolledText(
            right, font=('Consolas', 10), bg=COLORS['overlay'],
            fg=COLORS['text'], height=18
        )
        self.code_text.pack(fill='both', expand=True, padx=15, pady=5)
        self.code_text.insert('1.0', "# ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤")
        
        # ìµœì¢… ìŠ¹ì¸ ì˜ì—­
        approval_frame = tk.Frame(right, bg=COLORS['overlay'])
        approval_frame.pack(fill='x', padx=15, pady=10)
        
        tk.Label(
            approval_frame,
            text="ğŸ›¡ï¸ ìµœì¢… ìŠ¹ì¸ì í™•ì¸",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['overlay'],
            fg=COLORS['primary']
        ).pack(anchor='w', padx=10, pady=(10, 5))
        
        self.approval_status = tk.Label(
            approval_frame,
            text="Ralphê°€ ê²€ì¦ ì™„ë£Œ í›„ ì œì¶œí•˜ë©´ ì—¬ê¸°ì„œ í™•ì¸í•©ë‹ˆë‹¤.",
            font=('Segoe UI', 10),
            bg=COLORS['overlay'],
            fg=COLORS['muted']
        )
        self.approval_status.pack(anchor='w', padx=10, pady=(0, 10))
        
        btn_frame = tk.Frame(approval_frame, bg=COLORS['overlay'])
        btn_frame.pack(fill='x', padx=10, pady=(0, 10))
        
        self.reject_btn = tk.Button(
            btn_frame, text="âŒ ê±°ì ˆ (ì¬ì‘ì—…)",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['danger'], fg='white',
            relief='flat', state='disabled',
            command=self.reject_code
        )
        self.reject_btn.pack(side='left', expand=True, fill='x', padx=(0, 5))
        
        self.approve_btn = tk.Button(
            btn_frame, text="âœ… ìµœì¢… ìŠ¹ì¸",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['success'], fg='white',
            relief='flat', state='disabled',
            command=self.approve_code
        )
        self.approve_btn.pack(side='right', expand=True, fill='x', padx=(5, 0))
    
    def log(self, message):
        """Ralph ë¡œê·¸ ì¶”ê°€"""
        self.ralph_log.insert('end', f"\n{message}")
        self.ralph_log.see('end')
    
    def start_work(self):
        """ì‘ì—… ì‹œì‘"""
        prompt = self.prompt_text.get('1.0', 'end').strip()
        if not prompt:
            messagebox.showwarning("ê²½ê³ ", "ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
            return
        
        # ì´ˆê¸°í™”
        self.attempt = 0
        self.max_attempts = int(self.retry_var.get())
        self.errors = []
        
        # UI ìƒíƒœ ë³€ê²½
        self.start_btn.config(state='disabled')
        self.approve_btn.config(state='disabled')
        self.reject_btn.config(state='disabled')
        
        self.ralph_log.delete('1.0', 'end')
        self.log(f"ğŸš€ ì‘ì—… ì‹œì‘!")
        self.log(f"ë‹´ë‹¹: {self.ralph_var.get()}")
        self.log(f"ìµœëŒ€ ì‹œë„: {self.max_attempts}íšŒ")
        
        self.status_label.config(text="ğŸ“ í˜„ì¬: Ralph - ì½”ë“œ ìƒì„± ì¤‘...")
        
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
        threading.Thread(target=self.ralph_loop, args=(prompt,), daemon=True).start()
    
    def ralph_loop(self, prompt):
        """Ralph ìê¸°ìˆ˜ì • ë£¨í”„"""
        lang = self.lang_var.get()
        
        while self.attempt < self.max_attempts:
            self.attempt += 1
            self.root.after(0, lambda a=self.attempt: self.attempt_label.config(
                text=f"ì‹œë„: {a} / {self.max_attempts}"))
            
            # 1. ì½”ë“œ ìƒì„±
            self.root.after(0, lambda: self.log(f"\n--- ì‹œë„ {self.attempt} ---"))
            self.root.after(0, lambda: self.log("ğŸ“ ì½”ë“œ ìƒì„± ì¤‘..."))
            self.root.after(0, lambda: self.status_label.config(
                text=f"ğŸ“ í˜„ì¬: Ralph - ì½”ë“œ ìƒì„± ì¤‘... (ì‹œë„ {self.attempt})"))
            
            time.sleep(1)
            code = self.generate_code(prompt, lang)
            
            self.root.after(0, lambda c=code: self.show_code(c))
            self.root.after(0, lambda: self.log("âœ… ì½”ë“œ ìƒì„± ì™„ë£Œ"))
            
            # 2. 1ì°¨ ê²€ì¦
            self.root.after(0, lambda: self.log("ğŸ” ê²€ì¦ ì¤‘... (ë¬¸ë²•/ì‹¤í–‰ í…ŒìŠ¤íŠ¸)"))
            self.root.after(0, lambda: self.status_label.config(
                text=f"ğŸ“ í˜„ì¬: Ralph - ê²€ì¦ ì¤‘... (ì‹œë„ {self.attempt})"))
            
            time.sleep(1)
            result = self.verify_code(code, lang)
            
            if result['success']:
                # ê²€ì¦ í†µê³¼!
                self.root.after(0, lambda: self.log("âœ… ê²€ì¦ í†µê³¼!"))
                self.root.after(0, lambda: self.log("ğŸ“¤ ìµœì¢… ìŠ¹ì¸ìì—ê²Œ ì œì¶œí•©ë‹ˆë‹¤."))
                self.root.after(0, self.submit_to_admin)
                return
            else:
                # ê²€ì¦ ì‹¤íŒ¨ â†’ ë‹¤ì‹œ ì‹œë„
                error = result['error']
                self.errors.append(error)
                self.root.after(0, lambda e=error: self.log(f"âŒ ê²€ì¦ ì‹¤íŒ¨: {e}"))
                self.root.after(0, lambda: self.log("ğŸ”„ ìˆ˜ì • í›„ ì¬ì‹œë„..."))
                
                # ì—ëŸ¬ë¥¼ í”„ë¡¬í”„íŠ¸ì— í¬í•¨ì‹œì¼œ ì¬ìƒì„±
                prompt = f"{prompt}\n\n[ì´ì „ ì—ëŸ¬: {error}]\nìœ„ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”."
        
        # ìµœëŒ€ ì‹œë„ ì´ˆê³¼
        self.root.after(0, lambda: self.log(f"\nğŸ’€ {self.max_attempts}íšŒ ì‹œë„ í›„ ì‹¤íŒ¨"))
        self.root.after(0, lambda: self.status_label.config(
            text="ğŸ“ í˜„ì¬: ì‹¤íŒ¨ - ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"))
        self.root.after(0, lambda: self.start_btn.config(state='normal'))
    
    def generate_code(self, prompt, lang):
        """ì½”ë“œ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” LLM API í˜¸ì¶œ)"""
        # ì‹œë„ íšŸìˆ˜ì— ë”°ë¼ ì½”ë“œ í’ˆì§ˆ ì¡°ì • (ì‹œë®¬ë ˆì´ì…˜)
        if self.attempt >= 2:
            # 2ë²ˆì§¸ë¶€í„°ëŠ” "ìˆ˜ì •ëœ" ì½”ë“œ ë°˜í™˜
            return self.get_correct_code(prompt, lang)
        else:
            # ì²« ì‹œë„ëŠ” ì¼ë¶€ëŸ¬ ì—ëŸ¬ ìˆëŠ” ì½”ë“œ (ì‹œë®¬ë ˆì´ì…˜)
            return self.get_buggy_code(prompt, lang)
    
    def get_buggy_code(self, prompt, lang):
        """ì—ëŸ¬ê°€ ìˆëŠ” ì½”ë“œ (ì‹œë®¬ë ˆì´ì…˜)"""
        if lang == 'python':
            return f'''# {prompt}

class Calculator:
    def add(self, a, b):
        return a + b
    
    def subtract(self, a, b):
        return a - b
    
    def multiply(self, a, b):
        return a * b
    
    def divide(self, a, b):
        return a / b  # 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ì—ëŸ¬ ê°€ëŠ¥!

# í…ŒìŠ¤íŠ¸
calc = Calculator()
print(calc.divide(10, 0))  # ì—ëŸ¬ ë°œìƒ!
'''
        else:
            return f"// {prompt}\nconsole.log('buggy code')"
    
    def get_correct_code(self, prompt, lang):
        """ìˆ˜ì •ëœ ì •ìƒ ì½”ë“œ"""
        if lang == 'python':
            return f'''# {prompt}

class Calculator:
    """ì‚¬ì¹™ì—°ì‚° ê³„ì‚°ê¸°"""
    
    def add(self, a: float, b: float) -> float:
        return a + b
    
    def subtract(self, a: float, b: float) -> float:
        return a - b
    
    def multiply(self, a: float, b: float) -> float:
        return a * b
    
    def divide(self, a: float, b: float) -> float:
        if b == 0:
            raise ValueError("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        return a / b


# í…ŒìŠ¤íŠ¸
if __name__ == "__main__":
    calc = Calculator()
    print(calc.add(10, 5))       # 15
    print(calc.subtract(10, 5))  # 5
    print(calc.multiply(10, 5))  # 50
    print(calc.divide(10, 5))    # 2.0
'''
        elif lang == 'javascript':
            return f'''// {prompt}

class Calculator {{
    add(a, b) {{ return a + b; }}
    subtract(a, b) {{ return a - b; }}
    multiply(a, b) {{ return a * b; }}
    divide(a, b) {{
        if (b === 0) throw new Error("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return a / b;
    }}
}}

const calc = new Calculator();
console.log(calc.add(10, 5)); // 15
'''
        else:
            return f"// {prompt}\n// ì •ìƒ ì½”ë“œ"
    
    def verify_code(self, code, lang):
        """ì½”ë“œ ê²€ì¦ (ì‹¤ì œ ì‹¤í–‰)"""
        if lang == 'python':
            return self.verify_python(code)
        else:
            # ë‹¤ë¥¸ ì–¸ì–´ëŠ” ê°„ë‹¨íˆ í†µê³¼ (ì‹œë®¬ë ˆì´ì…˜)
            return {'success': True}
    
    def verify_python(self, code):
        """Python ì½”ë“œ ê²€ì¦"""
        # ì„ì‹œ íŒŒì¼ì— ì €ì¥
        with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False, encoding='utf-8') as f:
            f.write(code)
            temp_path = f.name
        
        try:
            # 1. ë¬¸ë²• ì²´í¬
            result = subprocess.run(
                ['python', '-m', 'py_compile', temp_path],
                capture_output=True, text=True, timeout=10
            )
            if result.returncode != 0:
                return {'success': False, 'error': f"ë¬¸ë²• ì—ëŸ¬: {result.stderr}"}
            
            # 2. ì‹¤í–‰ í…ŒìŠ¤íŠ¸
            result = subprocess.run(
                ['python', temp_path],
                capture_output=True, text=True, timeout=10
            )
            if result.returncode != 0:
                return {'success': False, 'error': f"ì‹¤í–‰ ì—ëŸ¬: {result.stderr}"}
            
            return {'success': True, 'output': result.stdout}
            
        except subprocess.TimeoutExpired:
            return {'success': False, 'error': "íƒ€ì„ì•„ì›ƒ"}
        except Exception as e:
            return {'success': False, 'error': str(e)}
        finally:
            os.unlink(temp_path)
    
    def show_code(self, code):
        """ì½”ë“œ í‘œì‹œ"""
        self.generated_code = code
        self.code_text.delete('1.0', 'end')
        self.code_text.insert('1.0', code)
    
    def submit_to_admin(self):
        """ìµœì¢… ìŠ¹ì¸ìì—ê²Œ ì œì¶œ"""
        self.status_label.config(text="ğŸ“ í˜„ì¬: ìµœì¢… ìŠ¹ì¸ì - ê²€í†  ëŒ€ê¸°ì¤‘")
        self.approval_status.config(
            text=f"âœ… Ralph ê²€ì¦ ì™„ë£Œ! ({self.attempt}íšŒ ì‹œë„)\nìŠ¹ì¸ ë˜ëŠ” ê±°ì ˆì„ ì„ íƒí•˜ì„¸ìš”.",
            fg=COLORS['success']
        )
        self.approve_btn.config(state='normal')
        self.reject_btn.config(state='normal')
    
    def approve_code(self):
        """ìµœì¢… ìŠ¹ì¸"""
        # íŒŒì¼ ì €ì¥
        ext = {'python': '.py', 'javascript': '.js', 'java': '.java'}
        filename = f"output{ext.get(self.lang_var.get(), '.txt')}"
        
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(self.generated_code)
        
        messagebox.showinfo("âœ… ìŠ¹ì¸ ì™„ë£Œ!", f"ì½”ë“œê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì €ì¥ë¨: {filename}")
        
        self.reset_ui()
    
    def reject_code(self):
        """ê±°ì ˆ â†’ Ralph ì¬ì‘ì—…"""
        if messagebox.askyesno("ì¬ì‘ì—…", "Ralphì—ê²Œ ë‹¤ì‹œ ì‹œí‚¬ê¹Œìš”?"):
            self.log("\nğŸ”„ ìµœì¢… ìŠ¹ì¸ìê°€ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤. ì¬ì‘ì—… ì‹œì‘...")
            self.approval_status.config(text="ì¬ì‘ì—… ìš”ì²­ë¨", fg=COLORS['warning'])
            self.approve_btn.config(state='disabled')
            self.reject_btn.config(state='disabled')
            
            prompt = self.prompt_text.get('1.0', 'end').strip()
            threading.Thread(target=self.ralph_loop, args=(prompt,), daemon=True).start()
    
    def reset_ui(self):
        """UI ë¦¬ì…‹"""
        self.start_btn.config(state='normal')
        self.approve_btn.config(state='disabled')
        self.reject_btn.config(state='disabled')
        self.status_label.config(text="ğŸ“ í˜„ì¬: ê´€ë¦¬ì - ì‘ì—… ì§€ì‹œ ëŒ€ê¸°ì¤‘")
        self.approval_status.config(
            text="Ralphê°€ ê²€ì¦ ì™„ë£Œ í›„ ì œì¶œí•˜ë©´ ì—¬ê¸°ì„œ í™•ì¸í•©ë‹ˆë‹¤.",
            fg=COLORS['muted']
        )
        self.attempt_label.config(text="ì‹œë„: 0 / 10")


if __name__ == "__main__":
    app = CodingAgentApp()
    app.run()