"""
ğŸ¤– Coding Agent Desktop App
- Ralph ì—ì´ì „íŠ¸ë“¤ì´ ì½”ë“œ ìƒì„± (ì§ì›)
- ê´€ë¦¬ìê°€ ìµœì¢… í™•ì¸/ìŠ¹ì¸
- ë¡œê·¸ì¸ ì—†ì´ ë°”ë¡œ ì‹œì‘
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import json
import os
from datetime import datetime
import threading
import time

# ========================================
# ìƒ‰ìƒ í…Œë§ˆ
# ========================================
COLORS = {
    'bg_dark': '#1e1e2e',
    'bg_darker': '#181825',
    'bg_surface': '#313244',
    'bg_overlay': '#45475a',
    'primary': '#6366f1',
    'secondary': '#8b5cf6',
    'success': '#10b981',
    'warning': '#f59e0b',
    'danger': '#ef4444',
    'text_light': '#cdd6f4',
    'text_muted': '#6c7086',
}

# ========================================
# ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
# ========================================
class CodingAgentApp:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("ğŸ¤– Coding Agent - Ralph Team Manager")
        self.root.geometry("1400x900")
        self.root.configure(bg=COLORS['bg_darker'])
        
        # Ralph ì—ì´ì „íŠ¸ë“¤ (ì§ì›)
        self.ralphs = [
            {
                'id': 1, 
                'name': 'Backend Ralph', 
                'role': 'ë°±ì—”ë“œ', 
                'icon': 'ğŸ‘¨â€ğŸ’»', 
                'status': 'idle',  # idle, working, done
                'specialty': ['python', 'java', 'csharp'],
            },
            {
                'id': 2, 
                'name': 'Frontend Ralph', 
                'role': 'í”„ë¡ íŠ¸ì—”ë“œ', 
                'icon': 'ğŸ¨', 
                'status': 'idle',
                'specialty': ['javascript', 'html', 'css'],
            },
            {
                'id': 3, 
                'name': 'Test Ralph', 
                'role': 'QA', 
                'icon': 'ğŸ§ª', 
                'status': 'idle',
                'specialty': ['pytest', 'unittest'],
            },
        ]
        
        # ì‘ì—… ëª©ë¡ (ìŠ¹ì¸ ëŒ€ê¸°)
        self.pending_tasks = []
        
        # ìŠ¹ì¸ëœ ì‘ì—…
        self.approved_tasks = []
        
        # ê±°ì ˆëœ ì‘ì—…
        self.rejected_tasks = []
        
        # í˜„ì¬ ì„ íƒëœ ì‘ì—…
        self.selected_task = None
        
        # UI ìƒì„±
        self.create_ui()
        
    def run(self):
        self.root.mainloop()
    
    # ========================================
    # UI ìƒì„±
    # ========================================
    def create_ui(self):
        # ìƒë‹¨ í—¤ë”
        self.create_header()
        
        # ë©”ì¸ ì˜ì—­ (3ë¶„í• )
        main_frame = tk.Frame(self.root, bg=COLORS['bg_darker'])
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # ì™¼ìª½: Ralph íŒ€ (ì§ì›ë“¤)
        self.create_ralph_panel(main_frame)
        
        # ì¤‘ì•™: ì‘ì—… ì…ë ¥ & ëŒ€ê¸°ì—´
        self.create_task_panel(main_frame)
        
        # ì˜¤ë¥¸ìª½: ìŠ¹ì¸ íŒ¨ë„ (ê´€ë¦¬ì)
        self.create_approval_panel(main_frame)
    
    def create_header(self):
        """ìƒë‹¨ í—¤ë”"""
        header = tk.Frame(self.root, bg=COLORS['bg_dark'], height=60)
        header.pack(fill='x')
        header.pack_propagate(False)
        
        # ë¡œê³ 
        logo = tk.Label(
            header,
            text="ğŸ¤– Coding Agent",
            font=('Segoe UI', 18, 'bold'),
            bg=COLORS['bg_dark'],
            fg=COLORS['primary']
        )
        logo.pack(side='left', padx=20, pady=15)
        
        # ìƒíƒœ í‘œì‹œ
        status_frame = tk.Frame(header, bg=COLORS['bg_dark'])
        status_frame.pack(side='right', padx=20)
        
        self.pending_label = tk.Label(
            status_frame,
            text="â³ ëŒ€ê¸°: 0",
            font=('Segoe UI', 11),
            bg=COLORS['bg_dark'],
            fg=COLORS['warning']
        )
        self.pending_label.pack(side='left', padx=10)
        
        self.approved_label = tk.Label(
            status_frame,
            text="âœ… ìŠ¹ì¸: 0",
            font=('Segoe UI', 11),
            bg=COLORS['bg_dark'],
            fg=COLORS['success']
        )
        self.approved_label.pack(side='left', padx=10)
    
    def create_ralph_panel(self, parent):
        """ì™¼ìª½: Ralph íŒ€ íŒ¨ë„"""
        panel = tk.Frame(parent, bg=COLORS['bg_surface'], width=300)
        panel.pack(side='left', fill='y', padx=(0, 10))
        panel.pack_propagate(False)
        
        # ì œëª©
        title = tk.Label(
            panel,
            text="ğŸ‘¥ Ralph íŒ€ (ì§ì›)",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        title.pack(pady=15)
        
        # Ralph ì¹´ë“œë“¤
        self.ralph_frames = {}
        for ralph in self.ralphs:
            self.create_ralph_card(panel, ralph)
    
    def create_ralph_card(self, parent, ralph):
        """Ralph ì¹´ë“œ ìƒì„±"""
        card = tk.Frame(parent, bg=COLORS['bg_overlay'])
        card.pack(fill='x', padx=10, pady=5)
        
        # ìƒë‹¨: ì•„ì´ì½˜ + ì´ë¦„ + ìƒíƒœ
        top = tk.Frame(card, bg=COLORS['bg_overlay'])
        top.pack(fill='x', padx=10, pady=10)
        
        icon_label = tk.Label(
            top,
            text=ralph['icon'],
            font=('Segoe UI Emoji', 28),
            bg=COLORS['bg_overlay']
        )
        icon_label.pack(side='left')
        
        info_frame = tk.Frame(top, bg=COLORS['bg_overlay'])
        info_frame.pack(side='left', padx=10)
        
        name_label = tk.Label(
            info_frame,
            text=ralph['name'],
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_light']
        )
        name_label.pack(anchor='w')
        
        role_label = tk.Label(
            info_frame,
            text=ralph['role'],
            font=('Segoe UI', 10),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_muted']
        )
        role_label.pack(anchor='w')
        
        # ìƒíƒœ í‘œì‹œ
        status_colors = {
            'idle': COLORS['text_muted'],
            'working': COLORS['warning'],
            'done': COLORS['success']
        }
        status_texts = {
            'idle': 'â— ëŒ€ê¸° ì¤‘',
            'working': 'â— ì‘ì—… ì¤‘...',
            'done': 'â— ì™„ë£Œ'
        }
        
        status_label = tk.Label(
            top,
            text=status_texts[ralph['status']],
            font=('Segoe UI', 10),
            bg=COLORS['bg_overlay'],
            fg=status_colors[ralph['status']]
        )
        status_label.pack(side='right')
        
        # ì €ì¥ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ìš©)
        self.ralph_frames[ralph['id']] = {
            'card': card,
            'status_label': status_label
        }
    
    def create_task_panel(self, parent):
        """ì¤‘ì•™: ì‘ì—… ì…ë ¥ & ëŒ€ê¸°ì—´"""
        panel = tk.Frame(parent, bg=COLORS['bg_darker'])
        panel.pack(side='left', fill='both', expand=True, padx=10)
        
        # === ì‘ì—… ì…ë ¥ ì˜ì—­ ===
        input_frame = tk.Frame(panel, bg=COLORS['bg_surface'])
        input_frame.pack(fill='x', pady=(0, 10))
        
        input_title = tk.Label(
            input_frame,
            text="ğŸ“ ìƒˆ ì‘ì—… ìš”ì²­",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        input_title.pack(anchor='w', padx=15, pady=(15, 10))
        
        # ì‘ì—… ì„¤ëª… ì…ë ¥
        self.task_entry = tk.Entry(
            input_frame,
            font=('Segoe UI', 12),
            bg=COLORS['bg_dark'],
            fg=COLORS['text_light'],
            insertbackground=COLORS['text_light'],
            relief='flat'
        )
        self.task_entry.pack(fill='x', padx=15, pady=5, ipady=10)
        self.task_entry.insert(0, "ì˜ˆ: Calculator í´ë˜ìŠ¤ ë§Œë“¤ì–´ì¤˜")
        self.task_entry.bind('<FocusIn>', lambda e: self.task_entry.delete(0, 'end') if self.task_entry.get().startswith('ì˜ˆ:') else None)
        
        # ì˜µì…˜ í–‰
        options_frame = tk.Frame(input_frame, bg=COLORS['bg_surface'])
        options_frame.pack(fill='x', padx=15, pady=10)
        
        # ë‹´ë‹¹ Ralph ì„ íƒ
        tk.Label(
            options_frame,
            text="ë‹´ë‹¹:",
            font=('Segoe UI', 10),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_muted']
        ).pack(side='left')
        
        self.ralph_var = tk.StringVar(value='auto')
        ralph_menu = ttk.Combobox(
            options_frame,
            textvariable=self.ralph_var,
            values=['auto (ìë™ ë°°ì •)', 'Backend Ralph', 'Frontend Ralph', 'Test Ralph'],
            state='readonly',
            width=18
        )
        ralph_menu.pack(side='left', padx=(5, 15))
        
        # ì–¸ì–´ ì„ íƒ
        tk.Label(
            options_frame,
            text="ì–¸ì–´:",
            font=('Segoe UI', 10),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_muted']
        ).pack(side='left')
        
        self.lang_var = tk.StringVar(value='python')
        lang_menu = ttk.Combobox(
            options_frame,
            textvariable=self.lang_var,
            values=['python', 'java', 'javascript', 'html', 'csharp'],
            state='readonly',
            width=12
        )
        lang_menu.pack(side='left', padx=5)
        
        # ì‘ì—… ì‹œì‘ ë²„íŠ¼
        start_btn = tk.Button(
            options_frame,
            text="ğŸš€ Ralphì—ê²Œ ì‹œí‚¤ê¸°",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['primary'],
            fg='white',
            relief='flat',
            cursor='hand2',
            command=self.assign_task
        )
        start_btn.pack(side='right')
        
        # === ì‘ì—… ëŒ€ê¸°ì—´ ===
        queue_frame = tk.Frame(panel, bg=COLORS['bg_surface'])
        queue_frame.pack(fill='both', expand=True)
        
        queue_title = tk.Label(
            queue_frame,
            text="â³ ìŠ¹ì¸ ëŒ€ê¸° ì‘ì—…",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        queue_title.pack(anchor='w', padx=15, pady=15)
        
        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì‘ì—… ëª©ë¡
        self.queue_container = tk.Frame(queue_frame, bg=COLORS['bg_surface'])
        self.queue_container.pack(fill='both', expand=True, padx=15, pady=(0, 15))
        
        # ë¹ˆ ìƒíƒœ ë©”ì‹œì§€
        self.empty_label = tk.Label(
            self.queue_container,
            text="ì•„ì§ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.\nìœ„ì—ì„œ ì‘ì—…ì„ ìš”ì²­í•˜ì„¸ìš”!",
            font=('Segoe UI', 11),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_muted']
        )
        self.empty_label.pack(pady=50)
    
    def create_approval_panel(self, parent):
        """ì˜¤ë¥¸ìª½: ìŠ¹ì¸ íŒ¨ë„ (ê´€ë¦¬ì)"""
        panel = tk.Frame(parent, bg=COLORS['bg_surface'], width=450)
        panel.pack(side='right', fill='y', padx=(10, 0))
        panel.pack_propagate(False)
        
        # ì œëª©
        title = tk.Label(
            panel,
            text="ğŸ›¡ï¸ ê´€ë¦¬ì ê²€í† ",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        title.pack(pady=15)
        
        # ì„ íƒëœ ì‘ì—… ì •ë³´
        self.review_frame = tk.Frame(panel, bg=COLORS['bg_overlay'])
        self.review_frame.pack(fill='x', padx=10, pady=5)
        
        self.review_title = tk.Label(
            self.review_frame,
            text="ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_light']
        )
        self.review_title.pack(anchor='w', padx=15, pady=(15, 5))
        
        self.review_info = tk.Label(
            self.review_frame,
            text="ì™¼ìª½ ëŒ€ê¸°ì—´ì—ì„œ ì‘ì—…ì„ í´ë¦­í•˜ë©´\nì½”ë“œë¥¼ ê²€í† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            font=('Segoe UI', 10),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_muted'],
            justify='left'
        )
        self.review_info.pack(anchor='w', padx=15, pady=(0, 15))
        
        # ì½”ë“œ ë¯¸ë¦¬ë³´ê¸°
        code_label = tk.Label(
            panel,
            text="ğŸ“„ ìƒì„±ëœ ì½”ë“œ",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        code_label.pack(anchor='w', padx=15, pady=(15, 5))
        
        self.code_preview = scrolledtext.ScrolledText(
            panel,
            font=('Consolas', 10),
            bg=COLORS['bg_dark'],
            fg=COLORS['text_light'],
            relief='flat',
            height=20
        )
        self.code_preview.pack(fill='both', expand=True, padx=10, pady=5)
        self.code_preview.insert('1.0', "# ì‘ì—…ì„ ì„ íƒí•˜ë©´ ì½”ë“œê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤")
        self.code_preview.config(state='disabled')
        
        # ìŠ¹ì¸/ê±°ì ˆ ë²„íŠ¼
        btn_frame = tk.Frame(panel, bg=COLORS['bg_surface'])
        btn_frame.pack(fill='x', padx=10, pady=15)
        
        self.reject_btn = tk.Button(
            btn_frame,
            text="âŒ ê±°ì ˆ (ì¬ì‘ì—…)",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['danger'],
            fg='white',
            relief='flat',
            cursor='hand2',
            state='disabled',
            command=self.reject_task
        )
        self.reject_btn.pack(side='left', expand=True, fill='x', padx=(0, 5))
        
        self.approve_btn = tk.Button(
            btn_frame,
            text="âœ… ìŠ¹ì¸",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['success'],
            fg='white',
            relief='flat',
            cursor='hand2',
            state='disabled',
            command=self.approve_task
        )
        self.approve_btn.pack(side='right', expand=True, fill='x', padx=(5, 0))
    
    # ========================================
    # ì‘ì—… ì²˜ë¦¬
    # ========================================
    def assign_task(self):
        """Ralphì—ê²Œ ì‘ì—… í• ë‹¹"""
        task_desc = self.task_entry.get().strip()
        if not task_desc or task_desc.startswith('ì˜ˆ:'):
            messagebox.showwarning("ê²½ê³ ", "ì‘ì—… ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
            return
        
        # ë‹´ë‹¹ Ralph ê²°ì •
        ralph_choice = self.ralph_var.get()
        if ralph_choice.startswith('auto'):
            # ìë™ ë°°ì •: ì–¸ì–´ì— ë”°ë¼
            lang = self.lang_var.get()
            if lang in ['python', 'java', 'csharp']:
                assigned_ralph = self.ralphs[0]  # Backend
            elif lang in ['javascript', 'html', 'css']:
                assigned_ralph = self.ralphs[1]  # Frontend
            else:
                assigned_ralph = self.ralphs[0]
        else:
            # ì§€ì •ëœ Ralph
            ralph_name = ralph_choice
            assigned_ralph = next((r for r in self.ralphs if r['name'] == ralph_name), self.ralphs[0])
        
        # ì‘ì—… ìƒì„±
        task = {
            'id': len(self.pending_tasks) + len(self.approved_tasks) + 1,
            'description': task_desc,
            'language': self.lang_var.get(),
            'ralph': assigned_ralph,
            'status': 'working',
            'code': None,
            'created_at': datetime.now().strftime('%H:%M:%S'),
            'attempts': 0
        }
        
        # Ralph ìƒíƒœ ì—…ë°ì´íŠ¸
        self.update_ralph_status(assigned_ralph['id'], 'working')
        
        # ì…ë ¥ ì´ˆê¸°í™”
        self.task_entry.delete(0, 'end')
        
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì½”ë“œ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
        threading.Thread(target=self.simulate_code_generation, args=(task,), daemon=True).start()
    
    def simulate_code_generation(self, task):
        """ì½”ë“œ ìƒì„± ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” LLM API í˜¸ì¶œ)"""
        time.sleep(2)  # ì‹œë®¬ë ˆì´ì…˜ ë”œë ˆì´
        
        # ìƒ˜í”Œ ì½”ë“œ ìƒì„±
        sample_codes = {
            'python': '''# {desc}
class Calculator:
    """ê¸°ë³¸ ê³„ì‚°ê¸° í´ë˜ìŠ¤"""
    
    def add(self, a: float, b: float) -> float:
        """ë‘ ìˆ˜ë¥¼ ë”í•©ë‹ˆë‹¤"""
        return a + b
    
    def subtract(self, a: float, b: float) -> float:
        """ë‘ ìˆ˜ë¥¼ ëºë‹ˆë‹¤"""
        return a - b
    
    def multiply(self, a: float, b: float) -> float:
        """ë‘ ìˆ˜ë¥¼ ê³±í•©ë‹ˆë‹¤"""
        return a * b
    
    def divide(self, a: float, b: float) -> float:
        """ë‘ ìˆ˜ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤"""
        if b == 0:
            raise ValueError("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        return a / b


if __name__ == "__main__":
    calc = Calculator()
    print(calc.add(10, 5))  # 15
''',
            'javascript': '''// {desc}
class Calculator {{
    add(a, b) {{
        return a + b;
    }}
    
    subtract(a, b) {{
        return a - b;
    }}
    
    multiply(a, b) {{
        return a * b;
    }}
    
    divide(a, b) {{
        if (b === 0) throw new Error("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return a / b;
    }}
}}

// ì‚¬ìš© ì˜ˆì‹œ
const calc = new Calculator();
console.log(calc.add(10, 5)); // 15
''',
            'html': '''<!-- {desc} -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Login Form</title>
    <style>
        body {{ font-family: Arial; background: #1e1e2e; }}
        .login-form {{
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: #313244;
            border-radius: 10px;
        }}
        input {{
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
        }}
        button {{
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }}
    </style>
</head>
<body>
    <div class="login-form">
        <h2 style="color: white;">ë¡œê·¸ì¸</h2>
        <input type="email" placeholder="ì´ë©”ì¼">
        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button>ë¡œê·¸ì¸</button>
    </div>
</body>
</html>
''',
            'java': '''// {desc}
public class Calculator {{
    
    public double add(double a, double b) {{
        return a + b;
    }}
    
    public double subtract(double a, double b) {{
        return a - b;
    }}
    
    public double multiply(double a, double b) {{
        return a * b;
    }}
    
    public double divide(double a, double b) {{
        if (b == 0) {{
            throw new ArithmeticException("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }}
        return a / b;
    }}
    
    public static void main(String[] args) {{
        Calculator calc = new Calculator();
        System.out.println(calc.add(10, 5)); // 15.0
    }}
}}
''',
            'csharp': '''// {desc}
using System;

public class Calculator
{{
    public double Add(double a, double b)
    {{
        return a + b;
    }}
    
    public double Subtract(double a, double b)
    {{
        return a - b;
    }}
    
    public double Multiply(double a, double b)
    {{
        return a * b;
    }}
    
    public double Divide(double a, double b)
    {{
        if (b == 0)
            throw new DivideByZeroException("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return a / b;
    }}
    
    public static void Main()
    {{
        var calc = new Calculator();
        Console.WriteLine(calc.Add(10, 5)); // 15
    }}
}}
'''
        }
        
        lang = task['language']
        code_template = sample_codes.get(lang, sample_codes['python'])
        task['code'] = code_template.format(desc=task['description'])
        task['status'] = 'pending_approval'
        task['attempts'] += 1
        
        # UI ì—…ë°ì´íŠ¸ (ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ)
        self.root.after(0, lambda: self.on_code_generated(task))
    
    def on_code_generated(self, task):
        """ì½”ë“œ ìƒì„± ì™„ë£Œ í›„ UI ì—…ë°ì´íŠ¸"""
        # Ralph ìƒíƒœ ì—…ë°ì´íŠ¸
        self.update_ralph_status(task['ralph']['id'], 'done')
        
        # ëŒ€ê¸°ì—´ì— ì¶”ê°€
        self.pending_tasks.append(task)
        
        # UI ì—…ë°ì´íŠ¸
        self.refresh_queue()
        self.update_status_labels()
        
        # 2ì´ˆ í›„ Ralph ìƒíƒœ idleë¡œ
        self.root.after(2000, lambda: self.update_ralph_status(task['ralph']['id'], 'idle'))
    
    def update_ralph_status(self, ralph_id, status):
        """Ralph ìƒíƒœ ì—…ë°ì´íŠ¸"""
        for ralph in self.ralphs:
            if ralph['id'] == ralph_id:
                ralph['status'] = status
                break
        
        # UI ì—…ë°ì´íŠ¸
        if ralph_id in self.ralph_frames:
            frame_data = self.ralph_frames[ralph_id]
            status_label = frame_data['status_label']
            
            status_colors = {
                'idle': COLORS['text_muted'],
                'working': COLORS['warning'],
                'done': COLORS['success']
            }
            status_texts = {
                'idle': 'â— ëŒ€ê¸° ì¤‘',
                'working': 'â— ì‘ì—… ì¤‘...',
                'done': 'â— ì™„ë£Œ!'
            }
            
            status_label.config(
                text=status_texts.get(status, 'â— ëŒ€ê¸° ì¤‘'),
                fg=status_colors.get(status, COLORS['text_muted'])
            )
    
    def refresh_queue(self):
        """ëŒ€ê¸°ì—´ UI ìƒˆë¡œê³ ì¹¨"""
        # ê¸°ì¡´ ìœ„ì ¯ ì‚­ì œ
        for widget in self.queue_container.winfo_children():
            widget.destroy()
        
        if not self.pending_tasks:
            self.empty_label = tk.Label(
                self.queue_container,
                text="ì•„ì§ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.\nìœ„ì—ì„œ ì‘ì—…ì„ ìš”ì²­í•˜ì„¸ìš”!",
                font=('Segoe UI', 11),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_muted']
            )
            self.empty_label.pack(pady=50)
            return
        
        # ì‘ì—… ì¹´ë“œ ìƒì„±
        for task in self.pending_tasks:
            self.create_task_card(task)
    
    def create_task_card(self, task):
        """ì‘ì—… ì¹´ë“œ ìƒì„±"""
        card = tk.Frame(self.queue_container, bg=COLORS['bg_overlay'], cursor='hand2')
        card.pack(fill='x', pady=5)
        
        # í´ë¦­ ì´ë²¤íŠ¸
        card.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        inner = tk.Frame(card, bg=COLORS['bg_overlay'])
        inner.pack(fill='x', padx=15, pady=12)
        inner.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        # ìƒë‹¨: ì‘ì—…ëª… + ì‹œê°„
        top = tk.Frame(inner, bg=COLORS['bg_overlay'])
        top.pack(fill='x')
        top.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        title = tk.Label(
            top,
            text=task['description'][:40] + ('...' if len(task['description']) > 40 else ''),
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_light']
        )
        title.pack(side='left')
        title.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        time_label = tk.Label(
            top,
            text=task['created_at'],
            font=('Segoe UI', 9),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_muted']
        )
        time_label.pack(side='right')
        time_label.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        # í•˜ë‹¨: Ralph + ì–¸ì–´ + ì‹œë„ íšŸìˆ˜
        bottom = tk.Frame(inner, bg=COLORS['bg_overlay'])
        bottom.pack(fill='x', pady=(8, 0))
        bottom.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        ralph_label = tk.Label(
            bottom,
            text=f"{task['ralph']['icon']} {task['ralph']['name']}",
            font=('Segoe UI', 10),
            bg=COLORS['bg_overlay'],
            fg=COLORS['primary']
        )
        ralph_label.pack(side='left')
        ralph_label.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        lang_label = tk.Label(
            bottom,
            text=task['language'],
            font=('Segoe UI', 9),
            bg=COLORS['primary'],
            fg='white',
            padx=8,
            pady=2
        )
        lang_label.pack(side='left', padx=10)
        lang_label.bind('<Button-1>', lambda e, t=task: self.select_task(t))
        
        if task['attempts'] > 1:
            retry_label = tk.Label(
                bottom,
                text=f"ì¬ì‹œë„ {task['attempts']}íšŒ",
                font=('Segoe UI', 9),
                bg=COLORS['bg_overlay'],
                fg=COLORS['warning']
            )
            retry_label.pack(side='right')
            retry_label.bind('<Button-1>', lambda e, t=task: self.select_task(t))
    
    def select_task(self, task):
        """ì‘ì—… ì„ íƒ"""
        self.selected_task = task
        
        # ê²€í†  ì •ë³´ ì—…ë°ì´íŠ¸
        self.review_title.config(text=task['description'][:50])
        self.review_info.config(
            text=f"ë‹´ë‹¹: {task['ralph']['name']}\n"
                 f"ì–¸ì–´: {task['language']}\n"
                 f"ì‹œë„: {task['attempts']}íšŒ"
        )
        
        # ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        self.code_preview.config(state='normal')
        self.code_preview.delete('1.0', 'end')
        self.code_preview.insert('1.0', task['code'] or 'ì½”ë“œ ì—†ìŒ')
        self.code_preview.config(state='disabled')
        
        # ë²„íŠ¼ í™œì„±í™”
        self.approve_btn.config(state='normal')
        self.reject_btn.config(state='normal')
    
    def approve_task(self):
        """ì‘ì—… ìŠ¹ì¸"""
        if not self.selected_task:
            return
        
        task = self.selected_task
        
        # ëŒ€ê¸°ì—´ì—ì„œ ì œê±°
        self.pending_tasks.remove(task)
        
        # ìŠ¹ì¸ ëª©ë¡ì— ì¶”ê°€
        task['status'] = 'approved'
        self.approved_tasks.append(task)
        
        # UI ì´ˆê¸°í™”
        self.selected_task = None
        self.review_title.config(text="ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”")
        self.review_info.config(text="ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…")
        self.code_preview.config(state='normal')
        self.code_preview.delete('1.0', 'end')
        self.code_preview.insert('1.0', "# ìŠ¹ì¸ ì™„ë£Œ! ë‹¤ìŒ ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”.")
        self.code_preview.config(state='disabled')
        
        self.approve_btn.config(state='disabled')
        self.reject_btn.config(state='disabled')
        
        # ìƒˆë¡œê³ ì¹¨
        self.refresh_queue()
        self.update_status_labels()
        
        messagebox.showinfo("ìŠ¹ì¸ ì™„ë£Œ", f"'{task['description'][:30]}...' ì‘ì—…ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!")
    
    def reject_task(self):
        """ì‘ì—… ê±°ì ˆ (ì¬ì‘ì—… ìš”ì²­)"""
        if not self.selected_task:
            return
        
        task = self.selected_task
        
        # ëŒ€ê¸°ì—´ì—ì„œ ì œê±°
        self.pending_tasks.remove(task)
        
        # Ralphì—ê²Œ ì¬ì‘ì—… ìš”ì²­
        task['status'] = 'working'
        self.update_ralph_status(task['ralph']['id'], 'working')
        
        # UI ì´ˆê¸°í™”
        self.selected_task = None
        self.review_title.config(text="ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”")
        self.review_info.config(text="ì¬ì‘ì—… ìš”ì²­ë¨ ğŸ”„")
        
        self.approve_btn.config(state='disabled')
        self.reject_btn.config(state='disabled')
        
        # ìƒˆë¡œê³ ì¹¨
        self.refresh_queue()
        self.update_status_labels()
        
        # ì¬ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
        threading.Thread(target=self.simulate_code_generation, args=(task,), daemon=True).start()
    
    def update_status_labels(self):
        """ìƒíƒœ ë ˆì´ë¸” ì—…ë°ì´íŠ¸"""
        self.pending_label.config(text=f"â³ ëŒ€ê¸°: {len(self.pending_tasks)}")
        self.approved_label.config(text=f"âœ… ìŠ¹ì¸: {len(self.approved_tasks)}")


# ========================================
# ì•± ì‹¤í–‰
# ========================================
if __name__ == "__main__":
    app = CodingAgentApp()
    app.run()