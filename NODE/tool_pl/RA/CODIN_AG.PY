"""
ğŸ¤– Coding Agent - Workflow Map UI
ì›Œí¬í”Œë¡œìš° ë§µ ì‹œê°í™” & ì„¤ì •
- ë…¸ë“œë³„ ì‘ì—… ì„¤ì •
- ë°˜ë³µ íšŸìˆ˜ ì„¤ì •
- ë‹¨ê³„ë³„ ì§„í–‰ (Previous/Next)
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import json
from datetime import datetime
import threading
import time

# ========================================
# ìƒ‰ìƒ í…Œë§ˆ
# ========================================
COLORS = {
    'bg_dark': '#1e1e2e',
    'bg_darker': '#181825',
    'bg_surface': '#313244',
    'bg_overlay': '#45475a',
    'primary': '#6366f1',
    'secondary': '#8b5cf6',
    'success': '#10b981',
    'warning': '#f59e0b',
    'danger': '#ef4444',
    'text_light': '#cdd6f4',
    'text_muted': '#6c7086',
    'node_admin': '#ec4899',
    'node_prd': '#8b5cf6',
    'node_ralph': '#3b82f6',
    'node_process': '#f59e0b',
    'node_decision': '#6366f1',
    'node_done': '#10b981',
    'node_implement': '#22c55e',
}


class WorkflowMapApp:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("ğŸ¤– Coding Agent - Workflow Map")
        self.root.geometry("1400x900")
        self.root.configure(bg=COLORS['bg_darker'])
        
        # ì›Œí¬í”Œë¡œìš° ë…¸ë“œ ì •ì˜
        self.nodes = self.create_workflow_nodes()
        self.connections = self.create_connections()
        
        # í˜„ì¬ ë‹¨ê³„
        self.current_step = 0
        self.total_steps = len(self.nodes)
        self.selected_node = None
        
        # UI ìƒì„±
        self.create_ui()
        
        # ì›Œí¬í”Œë¡œìš° ê·¸ë¦¬ê¸°
        self.root.after(100, self.draw_workflow)
    
    def create_workflow_nodes(self):
        """ì›Œí¬í”Œë¡œìš° ë…¸ë“œ ìƒì„±"""
        return [
            {
                'id': 'prd_write',
                'type': 'admin',
                'title': 'PRD ì‘ì„±',
                'desc': 'ë§Œë“¤ê³  ì‹¶ì€ ê²ƒ ì •ì˜',
                'x': 120, 'y': 60,
                'color': COLORS['node_prd'],
                'status': 'pending',
                'settings': {
                    'template': 'default',
                }
            },
            {
                'id': 'prd_convert',
                'type': 'process',
                'title': 'prd.json ë³€í™˜',
                'desc': 'ìœ ì € ìŠ¤í† ë¦¬ë¡œ ë¶„í• ',
                'x': 120, 'y': 160,
                'color': COLORS['node_process'],
                'status': 'pending',
                'settings': {}
            },
            {
                'id': 'ralph_start',
                'type': 'process',
                'title': 'Ralph ì‹¤í–‰',
                'desc': 'ìê¸°ìˆ˜ì • ë£¨í”„ ì‹œì‘',
                'x': 120, 'y': 260,
                'color': COLORS['node_process'],
                'status': 'pending',
                'settings': {
                    'max_retries': 10,
                }
            },
            {
                'id': 'pick_story',
                'type': 'ralph',
                'title': 'ìŠ¤í† ë¦¬ ì„ íƒ',
                'desc': 'passes: false ì°¾ê¸°',
                'x': 120, 'y': 380,
                'color': COLORS['node_ralph'],
                'status': 'pending',
                'settings': {
                    'assigned_ralph': 'auto',
                }
            },
            {
                'id': 'more_stories',
                'type': 'decision',
                'title': 'ë” ìˆë‚˜?',
                'desc': 'ë‚¨ì€ ìŠ¤í† ë¦¬ í™•ì¸',
                'x': 70, 'y': 510,
                'color': COLORS['node_decision'],
                'status': 'pending',
                'settings': {}
            },
            {
                'id': 'implement',
                'type': 'implement',
                'title': 'êµ¬í˜„',
                'desc': 'ì½”ë“œ ì‘ì„±, í…ŒìŠ¤íŠ¸ ì‹¤í–‰',
                'x': 420, 'y': 300,
                'color': COLORS['node_implement'],
                'status': 'pending',
                'settings': {
                    'language': 'python',
                    'max_retries': 10,
                    'run_tests': True,
                }
            },
            {
                'id': 'update_prd',
                'type': 'process',
                'title': 'prd.json ì—…ë°ì´íŠ¸',
                'desc': 'passes: true ì„¤ì •',
                'x': 420, 'y': 420,
                'color': COLORS['node_process'],
                'status': 'pending',
                'settings': {}
            },
            {
                'id': 'commit',
                'type': 'process',
                'title': 'ì»¤ë°‹',
                'desc': 'ë³€ê²½ì‚¬í•­ ì €ì¥',
                'x': 580, 'y': 300,
                'color': COLORS['node_process'],
                'status': 'pending',
                'settings': {
                    'auto_commit': True,
                }
            },
            {
                'id': 'log_progress',
                'type': 'process',
                'title': 'progress.txt ë¡œê·¸',
                'desc': 'ì§„í–‰ ìƒí™© ê¸°ë¡',
                'x': 250, 'y': 510,
                'color': COLORS['node_process'],
                'status': 'pending',
                'settings': {}
            },
            {
                'id': 'done',
                'type': 'done',
                'title': 'ì™„ë£Œ!',
                'desc': 'ëª¨ë“  ìŠ¤í† ë¦¬ ì™„ë£Œ',
                'x': 70, 'y': 620,
                'color': COLORS['node_done'],
                'status': 'pending',
                'settings': {}
            },
        ]
    
    def create_connections(self):
        """ë…¸ë“œ ì—°ê²° ì •ì˜"""
        return [
            ('prd_write', 'prd_convert'),
            ('prd_convert', 'ralph_start'),
            ('ralph_start', 'pick_story'),
            ('pick_story', 'more_stories'),
            ('pick_story', 'implement'),
            ('more_stories', 'done', 'No'),
            ('more_stories', 'log_progress', 'Yes'),
            ('implement', 'commit'),
            ('implement', 'update_prd'),
            ('update_prd', 'log_progress'),
            ('log_progress', 'pick_story'),
        ]
    
    def run(self):
        self.root.mainloop()
    
    # ========================================
    # UI ìƒì„±
    # ========================================
    def create_ui(self):
        # ìƒë‹¨ í—¤ë”
        self.create_header()
        
        # ë©”ì¸ ì˜ì—­
        main_frame = tk.Frame(self.root, bg=COLORS['bg_darker'])
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # ì™¼ìª½: ì›Œí¬í”Œë¡œìš° ë§µ ìº”ë²„ìŠ¤
        self.create_canvas(main_frame)
        
        # ì˜¤ë¥¸ìª½: ì„¤ì • íŒ¨ë„
        self.create_settings_panel(main_frame)
        
        # í•˜ë‹¨: ë„¤ë¹„ê²Œì´ì…˜
        self.create_navigation()
    
    def create_header(self):
        """ìƒë‹¨ í—¤ë”"""
        header = tk.Frame(self.root, bg=COLORS['bg_dark'], height=60)
        header.pack(fill='x')
        header.pack_propagate(False)
        
        # ë¡œê³ 
        logo = tk.Label(
            header,
            text="ğŸ¤– Coding Agent - Workflow Map",
            font=('Segoe UI', 18, 'bold'),
            bg=COLORS['bg_dark'],
            fg=COLORS['primary']
        )
        logo.pack(side='left', padx=20, pady=15)
        
        # ìƒíƒœ
        self.status_label = tk.Label(
            header,
            text="Ready",
            font=('Segoe UI', 11),
            bg=COLORS['bg_dark'],
            fg=COLORS['success']
        )
        self.status_label.pack(side='right', padx=20)
    
    def create_canvas(self, parent):
        """ì›Œí¬í”Œë¡œìš° ë§µ ìº”ë²„ìŠ¤"""
        canvas_frame = tk.Frame(parent, bg=COLORS['bg_surface'])
        canvas_frame.pack(side='left', fill='both', expand=True, padx=(0, 10))
        
        # ìº”ë²„ìŠ¤ ì œëª©
        title = tk.Label(
            canvas_frame,
            text="ğŸ“ Workflow Map",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        title.pack(anchor='w', padx=15, pady=10)
        
        # ìº”ë²„ìŠ¤
        self.canvas = tk.Canvas(
            canvas_frame,
            bg=COLORS['bg_dark'],
            highlightthickness=0,
            width=700,
            height=700
        )
        self.canvas.pack(fill='both', expand=True, padx=10, pady=(0, 10))
        
        # í´ë¦­ ì´ë²¤íŠ¸
        self.canvas.bind('<Button-1>', self.on_canvas_click)
    
    def create_settings_panel(self, parent):
        """ì˜¤ë¥¸ìª½ ì„¤ì • íŒ¨ë„"""
        panel = tk.Frame(parent, bg=COLORS['bg_surface'], width=400)
        panel.pack(side='right', fill='y')
        panel.pack_propagate(False)
        
        # ë…¸ë“œ ì •ë³´
        info_frame = tk.Frame(panel, bg=COLORS['bg_overlay'])
        info_frame.pack(fill='x', padx=10, pady=10)
        
        self.node_title = tk.Label(
            info_frame,
            text="ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”",
            font=('Segoe UI', 14, 'bold'),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_light']
        )
        self.node_title.pack(anchor='w', padx=15, pady=(15, 5))
        
        self.node_desc = tk.Label(
            info_frame,
            text="ì™¼ìª½ ë§µì—ì„œ ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´\nì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            font=('Segoe UI', 10),
            bg=COLORS['bg_overlay'],
            fg=COLORS['text_muted'],
            justify='left'
        )
        self.node_desc.pack(anchor='w', padx=15, pady=(0, 15))
        
        # ì„¤ì • ì˜ì—­
        settings_label = tk.Label(
            panel,
            text="âš™ï¸ ë…¸ë“œ ì„¤ì •",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        settings_label.pack(anchor='w', padx=15, pady=(15, 10))
        
        # ì„¤ì • ì»¨í…Œì´ë„ˆ
        self.settings_container = tk.Frame(panel, bg=COLORS['bg_surface'])
        self.settings_container.pack(fill='x', padx=15)
        
        # ê¸°ë³¸ ì„¤ì • í‘œì‹œ
        self.show_default_settings()
        
        # JSON ë¯¸ë¦¬ë³´ê¸°
        json_label = tk.Label(
            panel,
            text="ğŸ“„ JSON ë¯¸ë¦¬ë³´ê¸°",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light']
        )
        json_label.pack(anchor='w', padx=15, pady=(20, 10))
        
        self.json_preview = scrolledtext.ScrolledText(
            panel,
            font=('Consolas', 9),
            bg=COLORS['bg_dark'],
            fg=COLORS['text_light'],
            relief='flat',
            height=12
        )
        self.json_preview.pack(fill='x', padx=10, pady=(0, 10))
        self.update_json_preview()
    
    def show_default_settings(self):
        """ê¸°ë³¸ ì„¤ì • í‘œì‹œ"""
        for widget in self.settings_container.winfo_children():
            widget.destroy()
        
        tk.Label(
            self.settings_container,
            text="ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ì„¤ì •ì´ í‘œì‹œë©ë‹ˆë‹¤.",
            font=('Segoe UI', 10),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_muted']
        ).pack(pady=20)
    
    def show_node_settings(self, node):
        """ì„ íƒëœ ë…¸ë“œ ì„¤ì • í‘œì‹œ"""
        for widget in self.settings_container.winfo_children():
            widget.destroy()
        
        settings = node.get('settings', {})
        
        # ë…¸ë“œ íƒ€ì…ë³„ ì„¤ì •
        if node['type'] in ['ralph', 'implement']:
            # ë‹´ë‹¹ Ralph ì„ íƒ
            row = tk.Frame(self.settings_container, bg=COLORS['bg_surface'])
            row.pack(fill='x', pady=5)
            
            tk.Label(
                row, text="ë‹´ë‹¹ Ralph:",
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_muted']
            ).pack(side='left')
            
            ralph_var = tk.StringVar(value=settings.get('assigned_ralph', 'auto'))
            ralph_menu = ttk.Combobox(
                row,
                textvariable=ralph_var,
                values=['auto', 'Backend Ralph', 'Frontend Ralph', 'Test Ralph'],
                state='readonly',
                width=18
            )
            ralph_menu.pack(side='right')
            ralph_menu.bind('<<ComboboxSelected>>', 
                lambda e, n=node, v=ralph_var: self.update_node_setting(n, 'assigned_ralph', v.get()))
        
        if 'max_retries' in settings:
            # ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜
            row = tk.Frame(self.settings_container, bg=COLORS['bg_surface'])
            row.pack(fill='x', pady=5)
            
            tk.Label(
                row, text="ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜:",
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_muted']
            ).pack(side='left')
            
            retry_var = tk.StringVar(value=str(settings.get('max_retries', 10)))
            retry_spin = tk.Spinbox(
                row,
                from_=1, to=20,
                textvariable=retry_var,
                width=5,
                font=('Segoe UI', 10),
                bg=COLORS['bg_dark'],
                fg=COLORS['text_light']
            )
            retry_spin.pack(side='right')
            retry_spin.bind('<FocusOut>', 
                lambda e, n=node, v=retry_var: self.update_node_setting(n, 'max_retries', int(v.get())))
        
        if 'language' in settings:
            # ì–¸ì–´ ì„ íƒ
            row = tk.Frame(self.settings_container, bg=COLORS['bg_surface'])
            row.pack(fill='x', pady=5)
            
            tk.Label(
                row, text="ì–¸ì–´:",
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_muted']
            ).pack(side='left')
            
            lang_var = tk.StringVar(value=settings.get('language', 'python'))
            lang_menu = ttk.Combobox(
                row,
                textvariable=lang_var,
                values=['python', 'java', 'javascript', 'csharp', 'html'],
                state='readonly',
                width=15
            )
            lang_menu.pack(side='right')
            lang_menu.bind('<<ComboboxSelected>>', 
                lambda e, n=node, v=lang_var: self.update_node_setting(n, 'language', v.get()))
        
        if 'run_tests' in settings:
            # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—¬ë¶€
            row = tk.Frame(self.settings_container, bg=COLORS['bg_surface'])
            row.pack(fill='x', pady=5)
            
            test_var = tk.BooleanVar(value=settings.get('run_tests', True))
            test_check = tk.Checkbutton(
                row,
                text="í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰",
                variable=test_var,
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_light'],
                selectcolor=COLORS['bg_dark'],
                activebackground=COLORS['bg_surface'],
                command=lambda n=node, v=test_var: self.update_node_setting(n, 'run_tests', v.get())
            )
            test_check.pack(side='left')
        
        if 'auto_commit' in settings:
            # ìë™ ì»¤ë°‹ ì—¬ë¶€
            row = tk.Frame(self.settings_container, bg=COLORS['bg_surface'])
            row.pack(fill='x', pady=5)
            
            commit_var = tk.BooleanVar(value=settings.get('auto_commit', True))
            commit_check = tk.Checkbutton(
                row,
                text="ìë™ ì»¤ë°‹",
                variable=commit_var,
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_light'],
                selectcolor=COLORS['bg_dark'],
                activebackground=COLORS['bg_surface'],
                command=lambda n=node, v=commit_var: self.update_node_setting(n, 'auto_commit', v.get())
            )
            commit_check.pack(side='left')
        
        # ì„¤ì •ì´ ì—†ëŠ” ë…¸ë“œ
        if not settings:
            tk.Label(
                self.settings_container,
                text="ì´ ë…¸ë“œëŠ” ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.",
                font=('Segoe UI', 10),
                bg=COLORS['bg_surface'],
                fg=COLORS['text_muted']
            ).pack(pady=10)
    
    def update_node_setting(self, node, key, value):
        """ë…¸ë“œ ì„¤ì • ì—…ë°ì´íŠ¸"""
        node['settings'][key] = value
        self.update_json_preview()
    
    def update_json_preview(self):
        """JSON ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸"""
        if self.selected_node:
            data = {
                'id': self.selected_node['id'],
                'title': self.selected_node['title'],
                'type': self.selected_node['type'],
                'status': self.selected_node['status'],
                'settings': self.selected_node['settings']
            }
        else:
            # ì „ì²´ ì›Œí¬í”Œë¡œìš° ìš”ì•½
            data = {
                'total_nodes': len(self.nodes),
                'current_step': self.current_step + 1,
                'nodes': [{'id': n['id'], 'status': n['status']} for n in self.nodes]
            }
        
        self.json_preview.config(state='normal')
        self.json_preview.delete('1.0', 'end')
        self.json_preview.insert('1.0', json.dumps(data, indent=2, ensure_ascii=False))
        self.json_preview.config(state='disabled')
    
    def create_navigation(self):
        """í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜"""
        nav = tk.Frame(self.root, bg=COLORS['bg_dark'], height=60)
        nav.pack(fill='x', side='bottom')
        nav.pack_propagate(False)
        
        # ì¤‘ì•™ ì •ë ¬ìš© í”„ë ˆì„
        center = tk.Frame(nav, bg=COLORS['bg_dark'])
        center.pack(expand=True)
        
        # Previous ë²„íŠ¼
        self.prev_btn = tk.Button(
            center,
            text="â—€ Previous",
            font=('Segoe UI', 11),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light'],
            relief='flat',
            padx=20, pady=8,
            cursor='hand2',
            command=self.prev_step
        )
        self.prev_btn.pack(side='left', padx=5)
        
        # ë‹¨ê³„ í‘œì‹œ
        self.step_label = tk.Label(
            center,
            text=f"Step {self.current_step + 1} of {self.total_steps}",
            font=('Segoe UI', 12, 'bold'),
            bg=COLORS['bg_dark'],
            fg=COLORS['text_light'],
            padx=30
        )
        self.step_label.pack(side='left')
        
        # Next ë²„íŠ¼
        self.next_btn = tk.Button(
            center,
            text="Next â–¶",
            font=('Segoe UI', 11),
            bg=COLORS['primary'],
            fg='white',
            relief='flat',
            padx=20, pady=8,
            cursor='hand2',
            command=self.next_step
        )
        self.next_btn.pack(side='left', padx=5)
        
        # Reset ë²„íŠ¼
        self.reset_btn = tk.Button(
            center,
            text="Reset",
            font=('Segoe UI', 11),
            bg=COLORS['bg_surface'],
            fg=COLORS['text_light'],
            relief='flat',
            padx=20, pady=8,
            cursor='hand2',
            command=self.reset_workflow
        )
        self.reset_btn.pack(side='left', padx=20)
        
        # Run All ë²„íŠ¼
        self.run_btn = tk.Button(
            center,
            text="â–¶ Run All",
            font=('Segoe UI', 11, 'bold'),
            bg=COLORS['success'],
            fg='white',
            relief='flat',
            padx=20, pady=8,
            cursor='hand2',
            command=self.run_all
        )
        self.run_btn.pack(side='left', padx=5)
    
    # ========================================
    # ì›Œí¬í”Œë¡œìš° ê·¸ë¦¬ê¸°
    # ========================================
    def draw_workflow(self):
        """ì›Œí¬í”Œë¡œìš° ë§µ ê·¸ë¦¬ê¸°"""
        self.canvas.delete('all')
        
        # ì—°ê²°ì„  ë¨¼ì € ê·¸ë¦¬ê¸°
        for conn in self.connections:
            self.draw_connection(conn)
        
        # ë…¸ë“œ ê·¸ë¦¬ê¸°
        for i, node in enumerate(self.nodes):
            self.draw_node(node, is_current=(i == self.current_step))
    
    def draw_connection(self, conn):
        """ì—°ê²°ì„  ê·¸ë¦¬ê¸°"""
        from_id = conn[0]
        to_id = conn[1]
        label = conn[2] if len(conn) > 2 else None
        
        from_node = next((n for n in self.nodes if n['id'] == from_id), None)
        to_node = next((n for n in self.nodes if n['id'] == to_id), None)
        
        if not from_node or not to_node:
            return
        
        # ì‹œì‘ì , ëì  ê³„ì‚°
        x1 = from_node['x'] + 70
        y1 = from_node['y'] + 30
        x2 = to_node['x'] + 70
        y2 = to_node['y'] + 30
        
        # ê³¡ì„  ì—°ê²°
        if abs(x2 - x1) > 100:
            # ìˆ˜í‰ ì´ë™ì´ í° ê²½ìš° ë² ì§€ì–´ ê³¡ì„ 
            mid_x = (x1 + x2) / 2
            self.canvas.create_line(
                x1, y1, mid_x, y1, mid_x, y2, x2, y2,
                fill=COLORS['text_muted'],
                width=2,
                smooth=True,
                arrow=tk.LAST
            )
        else:
            # ì§ì„ 
            self.canvas.create_line(
                x1, y1, x2, y2,
                fill=COLORS['text_muted'],
                width=2,
                arrow=tk.LAST
            )
        
        # ë¼ë²¨ (Yes/No)
        if label:
            mid_x = (x1 + x2) / 2
            mid_y = (y1 + y2) / 2
            self.canvas.create_text(
                mid_x + 20, mid_y,
                text=label,
                font=('Segoe UI', 9),
                fill=COLORS['warning'] if label == 'Yes' else COLORS['danger']
            )
    
    def draw_node(self, node, is_current=False):
        """ë…¸ë“œ ê·¸ë¦¬ê¸°"""
        x, y = node['x'], node['y']
        w, h = 140, 60
        
        # ìƒíƒœë³„ ìƒ‰ìƒ
        if node['status'] == 'completed':
            fill_color = COLORS['success']
            outline_color = COLORS['success']
        elif node['status'] == 'running':
            fill_color = node['color']
            outline_color = COLORS['warning']
        elif is_current:
            fill_color = node['color']
            outline_color = COLORS['primary']
        else:
            fill_color = COLORS['bg_overlay']
            outline_color = node['color']
        
        # í˜„ì¬ ë‹¨ê³„ ê°•ì¡°
        outline_width = 4 if is_current else 2
        
        # ë‘¥ê·¼ ì‚¬ê°í˜•
        radius = 10
        self.canvas.create_rectangle(
            x, y, x + w, y + h,
            fill=fill_color,
            outline=outline_color,
            width=outline_width
        )
        
        # ì œëª©
        self.canvas.create_text(
            x + w/2, y + 20,
            text=node['title'],
            font=('Segoe UI', 10, 'bold'),
            fill='white' if node['status'] in ['completed', 'running'] or is_current else COLORS['text_light']
        )
        
        # ì„¤ëª…
        self.canvas.create_text(
            x + w/2, y + 40,
            text=node['desc'][:20],
            font=('Segoe UI', 8),
            fill=COLORS['text_muted']
        )
        
        # ë…¸ë“œ ID ì €ì¥ (í´ë¦­ ê°ì§€ìš©)
        node['canvas_coords'] = (x, y, x + w, y + h)
    
    def on_canvas_click(self, event):
        """ìº”ë²„ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸"""
        x, y = event.x, event.y
        
        for node in self.nodes:
            coords = node.get('canvas_coords')
            if coords:
                x1, y1, x2, y2 = coords
                if x1 <= x <= x2 and y1 <= y <= y2:
                    self.select_node(node)
                    return
        
        # ë¹ˆ ê³µê°„ í´ë¦­ì‹œ ì„ íƒ í•´ì œ
        self.selected_node = None
        self.node_title.config(text="ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”")
        self.node_desc.config(text="ì™¼ìª½ ë§µì—ì„œ ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´\nì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        self.show_default_settings()
        self.update_json_preview()
        self.draw_workflow()
    
    def select_node(self, node):
        """ë…¸ë“œ ì„ íƒ"""
        self.selected_node = node
        
        # ì •ë³´ ì—…ë°ì´íŠ¸
        self.node_title.config(text=f"{node['title']}")
        self.node_desc.config(text=f"íƒ€ì…: {node['type']}\nìƒíƒœ: {node['status']}\n{node['desc']}")
        
        # ì„¤ì • í‘œì‹œ
        self.show_node_settings(node)
        
        # JSON ì—…ë°ì´íŠ¸
        self.update_json_preview()
        
        # ë§µ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì„ íƒ í‘œì‹œ)
        self.draw_workflow()
    
    # ========================================
    # ë„¤ë¹„ê²Œì´ì…˜
    # ========================================
    def prev_step(self):
        """ì´ì „ ë‹¨ê³„"""
        if self.current_step > 0:
            self.current_step -= 1
            self.update_step_ui()
    
    def next_step(self):
        """ë‹¤ìŒ ë‹¨ê³„"""
        if self.current_step < self.total_steps - 1:
            # í˜„ì¬ ë…¸ë“œ ì™„ë£Œ ì²˜ë¦¬
            self.nodes[self.current_step]['status'] = 'completed'
            self.current_step += 1
            self.nodes[self.current_step]['status'] = 'running'
            self.update_step_ui()
    
    def reset_workflow(self):
        """ì›Œí¬í”Œë¡œìš° ë¦¬ì…‹"""
        self.current_step = 0
        for node in self.nodes:
            node['status'] = 'pending'
        self.nodes[0]['status'] = 'running'
        self.update_step_ui()
    
    def update_step_ui(self):
        """ë‹¨ê³„ UI ì—…ë°ì´íŠ¸"""
        self.step_label.config(text=f"Step {self.current_step + 1} of {self.total_steps}")
        self.status_label.config(text=f"í˜„ì¬: {self.nodes[self.current_step]['title']}")
        
        # ì„ íƒëœ ë…¸ë“œ ì—…ë°ì´íŠ¸
        self.select_node(self.nodes[self.current_step])
        
        # ë²„íŠ¼ ìƒíƒœ
        self.prev_btn.config(state='normal' if self.current_step > 0 else 'disabled')
        self.next_btn.config(state='normal' if self.current_step < self.total_steps - 1 else 'disabled')
        
        self.draw_workflow()
    
    def run_all(self):
        """ì „ì²´ ì‹¤í–‰"""
        def run_steps():
            for i in range(self.current_step, self.total_steps):
                self.root.after(0, lambda idx=i: self.set_step_running(idx))
                time.sleep(1)
                self.root.after(0, lambda idx=i: self.set_step_completed(idx))
            
            self.root.after(0, lambda: messagebox.showinfo("ì™„ë£Œ", "ëª¨ë“  ë‹¨ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"))
        
        threading.Thread(target=run_steps, daemon=True).start()
    
    def set_step_running(self, idx):
        """ë‹¨ê³„ ì‹¤í–‰ ì¤‘ìœ¼ë¡œ ì„¤ì •"""
        self.nodes[idx]['status'] = 'running'
        self.current_step = idx
        self.update_step_ui()
    
    def set_step_completed(self, idx):
        """ë‹¨ê³„ ì™„ë£Œë¡œ ì„¤ì •"""
        self.nodes[idx]['status'] = 'completed'
        self.draw_workflow()


# ========================================
# ì•± ì‹¤í–‰
# ========================================
if __name__ == "__main__":
    app = WorkflowMapApp()
    app.run()