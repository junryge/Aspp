#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         AMHS Multi-Agent System v1.0 - DOS Edition           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import sys
import asyncio
from datetime import datetime

# ì»¬ëŸ¬ ì½”ë“œ
class C:
    if os.name == 'nt':
        os.system('color')
    
    R = '\033[0m'       # Reset
    B = '\033[1m'       # Bold
    
    BLK = '\033[30m'
    RED = '\033[31m'
    GRN = '\033[32m'
    YEL = '\033[33m'
    BLU = '\033[34m'
    MAG = '\033[35m'
    CYN = '\033[36m'
    WHT = '\033[37m'
    
    BG_BLU = '\033[44m'
    BG_CYN = '\033[46m'
    BG_WHT = '\033[47m'


def cls():
    os.system('cls' if os.name == 'nt' else 'clear')


def header():
    cls()
    print(f"""
{C.CYN}  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                                              â•‘
  â•‘   {C.YEL}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  {C.GRN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—{C.CYN}â•‘
  â•‘  {C.YEL}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•  {C.GRN}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•{C.CYN}â•‘
  â•‘  {C.YEL}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  {C.GRN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—{C.CYN}â•‘
  â•‘  {C.YEL}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘  {C.GRN}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘{C.CYN}â•‘
  â•‘  {C.YEL}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  {C.GRN}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•{C.CYN}â•‘
  â•‘  {C.YEL}â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•  {C.GRN}â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•{C.CYN} â•‘
  â•‘                                                              â•‘
  â•‘            {C.MAG}â˜…â˜…â˜…  Ralph Wiggum Edition  â˜…â˜…â˜…{C.CYN}               â•‘
  â•‘                                                              â•‘
  â•‘          {C.WHT}ë°˜ë„ì²´ FAB ë¬¼ë¥˜ì‹œìŠ¤í…œ AI ë¶„ì„ v1.0{C.CYN}                  â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{C.R}
""")


def menu():
    print(f"""
  {C.YEL}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚    {C.WHT}[1]{C.YEL} ë°˜ì†¡í˜„í™© ì¡°íšŒ        {C.WHT}[2]{C.YEL} ìœ„ì¹˜ ì¡°íšŒ                  â”‚
  â”‚    {C.WHT}[3]{C.YEL} ììœ  ì§ˆë¬¸            {C.WHT}[4]{C.YEL} ì—°ê²° í…ŒìŠ¤íŠ¸                â”‚
  â”‚                                                              â”‚
  â”‚    {C.CYN}[H]{C.YEL} ë„ì›€ë§              {C.RED}[Q]{C.YEL} ì¢…ë£Œ                        â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}
""")


def fab_list():
    print(f"""
  {C.GRN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FAB LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  {C.WHT}[ì´ì²œ]{C.GRN} M14 M14B M16A M16B M16E M16HUB M10A M10C R3 R4   â”‚
  â”‚        WLPKG1 PNT4_TSV PNT4_WT ICPRB M16_PKT M16_WT          â”‚
  â”‚                                                              â”‚
  â”‚  {C.WHT}[ì²­ì£¼]{C.GRN} M11A M11B M15A M15B M15B_WLP3 CJPRB             â”‚
  â”‚        CJPRB_WLP3 CJPKG_FRONT CJPKG_MBS                      â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}
""")


def statusbar():
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"  {C.BG_BLU}{C.WHT} AMHS Ralph Wiggum RAG v1.0 â”‚ {now} â”‚ [Q]uit {C.R}")


def help_screen():
    cls()
    header()
    print(f"""
  {C.CYN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HELP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  {C.YEL}â–¶ ë°˜ì†¡í˜„í™© ì˜ˆì‹œ:{C.CYN}                                         â”‚
  â”‚    {C.WHT}"M14 ë°˜ì†¡í˜„í™©"  "M16A í ìƒíƒœ"  "M14ë‘ M16A ë¹„êµ"{C.CYN}       â”‚
  â”‚                                                            â”‚
  â”‚  {C.YEL}â–¶ ìœ„ì¹˜ì¡°íšŒ ì˜ˆì‹œ:{C.CYN}                                         â”‚
  â”‚    {C.WHT}"5NNN3764 ì–´ë””ìˆì–´?"  "5QQ4B74 ìœ„ì¹˜"{C.CYN}                   â”‚
  â”‚                                                            â”‚
  â”‚  {C.YEL}â–¶ ë³µí•©ì§ˆë¬¸ ì˜ˆì‹œ:{C.CYN}                                         â”‚
  â”‚    {C.WHT}"5NNN3764 ìœ„ì¹˜í•œ ê³³ì˜ ë°˜ì†¡í˜„í™© ì•Œë ¤ì¤˜"{C.CYN}                  â”‚
  â”‚                                                            â”‚
  â”‚  {C.YEL}â–¶ ë‹¨ì¶•í‚¤:{C.CYN}                                                â”‚
  â”‚    {C.WHT}B{C.CYN}=ë’¤ë¡œ  {C.WHT}Q{C.CYN}=ì¢…ë£Œ  {C.WHT}H{C.CYN}=ë„ì›€ë§                              â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}
""")
    input(f"\n  {C.YEL}>>> Enter ëˆ„ë¥´ë©´ ë©”ë‰´ë¡œ...{C.R}")


async def run_query(query: str):
    """ì¿¼ë¦¬ ì‹¤í–‰"""
    from app._builder import build_team_graph
    
    graph = build_team_graph()
    config = {
        "configurable": {"thread_id": f"dos_{datetime.now().strftime('%H%M%S')}"},
        "recursion_limit": 20,
    }
    inputs = {"messages": [{"role": "user", "content": query}]}
    
    print(f"\n  {C.GRN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AI ì‘ë‹µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”{C.R}")
    print(f"  {C.GRN}â”‚{C.R}")
    
    response = ""
    async for ev in graph.astream_events(inputs, config=config, version="v1"):
        md = ev.get("metadata", {}) or {}
        node = md.get("langgraph_node")
        
        if ev.get("event") == "on_chat_model_stream" and node == "FinalAnswerAgent":
            chunk = ev.get("data", {}).get("chunk")
            text = getattr(chunk, "content", None)
            if text:
                response += text
    
    # ì‘ë‹µ ì¶œë ¥
    for line in response.split('\n'):
        while len(line) > 50:
            print(f"  {C.GRN}â”‚{C.R}  {C.WHT}{line[:50]}{C.R}")
            line = line[50:]
        print(f"  {C.GRN}â”‚{C.R}  {C.WHT}{line}{C.R}")
    
    print(f"  {C.GRN}â”‚{C.R}")
    print(f"  {C.GRN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}")


def mode_1():
    """ë°˜ì†¡í˜„í™©"""
    while True:
        cls()
        header()
        print(f"\n  {C.YEL}[ ë°˜ì†¡í˜„í™© ì¡°íšŒ ]{C.R}")
        fab_list()
        
        fab = input(f"  {C.CYN}FAB ì…ë ¥ (B=ë’¤ë¡œ): {C.R}").strip().upper()
        
        if fab in ['B', '']: return
        if fab in ['Q', 'QUIT']: sys.exit(0)
        
        print(f"\n  {C.YEL}ì²˜ë¦¬ì¤‘...{C.R}")
        asyncio.run(run_query(f"{fab} ë°˜ì†¡í˜„í™© ì•Œë ¤ì¤˜"))
        input(f"\n  {C.YEL}>>> Enter...{C.R}")


def mode_2():
    """ìœ„ì¹˜ì¡°íšŒ"""
    while True:
        cls()
        header()
        print(f"""
  {C.YEL}[ ìœ„ì¹˜ ì¡°íšŒ ]{C.R}
  
  {C.GRN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Carrier ID ë˜ëŠ” Lot ID ì…ë ¥                          â”‚
  â”‚  ì˜ˆ: 5NNN3764, 5QQ4B74, S5P499258                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}
""")
        
        id_input = input(f"  {C.CYN}ID ì…ë ¥ (B=ë’¤ë¡œ): {C.R}").strip()
        
        if id_input.upper() in ['B', '']: return
        if id_input.upper() in ['Q', 'QUIT']: sys.exit(0)
        
        print(f"\n  {C.YEL}ì²˜ë¦¬ì¤‘...{C.R}")
        asyncio.run(run_query(f"{id_input} ì–´ë””ìˆì–´?"))
        input(f"\n  {C.YEL}>>> Enter...{C.R}")


def mode_3():
    """ììœ ì§ˆë¬¸"""
    while True:
        cls()
        header()
        print(f"""
  {C.YEL}[ ììœ  ì§ˆë¬¸ ]{C.R}
  
  {C.GRN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  AIì—ê²Œ ììœ ë¡­ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”!                           â”‚
  â”‚                                                      â”‚
  â”‚  ì˜ˆ: "5NNN3764 ìœ„ì¹˜í•œ ê³³ì˜ ë°˜ì†¡í˜„í™© ì•Œë ¤ì¤˜"           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜{C.R}
""")
        
        query = input(f"  {C.CYN}ì§ˆë¬¸ (B=ë’¤ë¡œ): {C.R}").strip()
        
        if query.upper() in ['B', '']: return
        if query.upper() in ['Q', 'QUIT']: sys.exit(0)
        
        print(f"\n  {C.YEL}ì²˜ë¦¬ì¤‘...{C.R}")
        asyncio.run(run_query(query))
        input(f"\n  {C.YEL}>>> Enter...{C.R}")


def mode_4():
    """ì—°ê²°í…ŒìŠ¤íŠ¸"""
    cls()
    header()
    print(f"\n  {C.YEL}[ ì—°ê²° í…ŒìŠ¤íŠ¸ ]{C.R}\n")
    
    print(f"  {C.CYN}[1/3] LLM...{C.R}", end=" ")
    try:
        from app._llm import getmodellist
        print(f"{C.GRN}OK{C.R} ({getmodellist(k=2)})")
    except Exception as e:
        print(f"{C.RED}FAIL{C.R}")
    
    print(f"  {C.CYN}[2/3] Config...{C.R}", end=" ")
    try:
        from app import config as cfg
        print(f"{C.GRN}OK{C.R} (FAB: {len(cfg.FACTORY_DB_KEY_MAP)}ê°œ)")
    except:
        print(f"{C.RED}FAIL{C.R}")
    
    print(f"  {C.CYN}[3/3] Graph...{C.R}", end=" ")
    try:
        from app._builder import build_team_graph
        build_team_graph()
        print(f"{C.GRN}OK{C.R}")
    except:
        print(f"{C.RED}FAIL{C.R}")
    
    print(f"\n  {C.GRN}í…ŒìŠ¤íŠ¸ ì™„ë£Œ!{C.R}")
    input(f"\n  {C.YEL}>>> Enter...{C.R}")


def main():
    while True:
        header()
        menu()
        statusbar()
        
        ch = input(f"\n  {C.CYN}ì„ íƒ [1-4/H/Q]: {C.R}").strip().upper()
        
        if ch == '1':   mode_1()
        elif ch == '2': mode_2()
        elif ch == '3': mode_3()
        elif ch == '4': mode_4()
        elif ch == 'H': help_screen()
        elif ch in ['Q', 'QUIT', 'EXIT']:
            cls()
            print(f"""
{C.CYN}  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                                      â•‘
  â•‘              Thank you for using                     â•‘
  â•‘        AMHS Ralph Wiggum RAG v1.0                    â•‘
  â•‘                                                      â•‘
  â•‘                  Goodbye! ğŸ‘‹                         â•‘
  â•‘                                                      â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{C.R}
""")
            sys.exit(0)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n  {C.YEL}Bye!{C.R}\n")
        sys.exit(0)