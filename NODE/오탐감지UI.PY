# -*- coding: utf-8 -*-
"""
Created on Mon Dec 30 2025
V8.1 - ë¶„ë¥˜ ì²´ê³„ ë‹¨ìˆœí™”
- ì •ìƒì˜ˆì¸¡ â†’ ì´ìƒ(ì •ìƒ(-Në¶„))ìœ¼ë¡œ ì´ìƒíƒì§€ì— í¬í•¨
- ê¸‰ì¦ì—°ì† â†’ ì •ìƒ(ê¸‰ì¦(-Në¶„))ìœ¼ë¡œ ì •ìƒì— í¬í•¨
"""
import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import pandas as pd
from datetime import datetime
import webbrowser
import os

try:
    import matplotlib.pyplot as plt
    from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
    from matplotlib.figure import Figure
    HAS_MATPLOTLIB = True
except ImportError:
    HAS_MATPLOTLIB = False

class SurgeAnalyzer:
    def __init__(self, root):
        self.root = root
        self.root.title("MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8.2 (ì•ŒëŒê¸°ë°˜)")
        self.root.geometry("1200x900")
        self.root.configure(bg='#1a1a2e')
        
        self.hub_file = None
        self.m14_file = None
        self.hub_alarm_file = None
        self.m14_alarm_file = None
        self.hub_df = None
        self.m14_df = None
        self.hub_alarm_df = None
        self.m14_alarm_df = None
        self.hub_stats = None
        self.m14_stats = None
        
        self.setup_ui()
    
    def setup_ui(self):
        main_frame = tk.Frame(self.root, bg='#1a1a2e')
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        top_frame = tk.Frame(main_frame, bg='#1a1a2e')
        top_frame.pack(fill=tk.X)
        
        # íƒ€ì´í‹€
        tk.Label(top_frame, text="ğŸ“Š MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8.2", font=('ë§‘ì€ ê³ ë”•', 20, 'bold'),
                 bg='#1a1a2e', fg='#00d4ff').pack(pady=(0, 3))
        tk.Label(top_frame, text="ì•ŒëŒ ê¸°ë°˜: ì´ìƒíƒì§€ / ì˜¤íƒ / ë¯¸íƒ / ì •ìƒ", font=('ë§‘ì€ ê³ ë”•', 10),
                 bg='#1a1a2e', fg='#888888').pack(pady=(0, 10))
        
        # ë¶„ì„ ë‚ ì§œ
        date_frame = tk.Frame(top_frame, bg='#252540', relief='ridge', bd=2)
        date_frame.pack(fill=tk.X, pady=5, ipady=5, ipadx=10)
        
        tk.Label(date_frame, text="ğŸ“… ë¶„ì„ ë‚ ì§œ", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'),
                 bg='#252540', fg='#00ff88').pack(side=tk.LEFT, padx=(10,15), pady=5)
        
        today = datetime.now()
        self.year_var = tk.StringVar(value=str(today.year))
        self.month_var = tk.StringVar(value=str(today.month))
        self.day_var = tk.StringVar(value=str(today.day))
        
        tk.Entry(date_frame, textvariable=self.year_var, font=('ë§‘ì€ ê³ ë”•', 10), width=5,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ë…„", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        tk.Entry(date_frame, textvariable=self.month_var, font=('ë§‘ì€ ê³ ë”•', 10), width=3,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ì›”", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        tk.Entry(date_frame, textvariable=self.day_var, font=('ë§‘ì€ ê³ ë”•', 10), width=3,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ì¼", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        
        # íŒŒì¼ ì„ íƒ
        file_frame = tk.Frame(top_frame, bg='#1a1a2e')
        file_frame.pack(fill=tk.X, pady=5)
        
        # HUBROOM
        hub_frame = tk.Frame(file_frame, bg='#252540', relief='ridge', bd=2)
        hub_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0,5), ipady=5, ipadx=10)
        
        tk.Label(hub_frame, text="ğŸ  HUBROOM (350)", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), 
                 bg='#252540', fg='#00d4ff').pack(anchor='w', padx=10, pady=(5,2))
        
        hub_btn_frame = tk.Frame(hub_frame, bg='#252540')
        hub_btn_frame.pack(fill=tk.X, padx=10, pady=3)
        tk.Button(hub_btn_frame, text="ğŸ“ íŒŒì¼", command=self.select_hub_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#00d4ff', fg='black', width=8).pack(side=tk.LEFT)
        self.hub_label = tk.Label(hub_btn_frame, text="ì„ íƒ ì•ˆë¨", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#888')
        self.hub_label.pack(side=tk.LEFT, padx=5)
        
        hub_alarm_frame = tk.Frame(hub_frame, bg='#252540')
        hub_alarm_frame.pack(fill=tk.X, padx=10, pady=2)
        tk.Button(hub_alarm_frame, text="ğŸš¨ ì•ŒëŒ", command=self.select_hub_alarm_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#ffcc00', fg='black', width=8).pack(side=tk.LEFT)
        self.hub_alarm_label = tk.Label(hub_alarm_frame, text="(ì„ íƒ)", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#666')
        self.hub_alarm_label.pack(side=tk.LEFT, padx=5)
        
        self.hub_comment = tk.Text(hub_frame, font=('ë§‘ì€ ê³ ë”•', 9), bg='#0d0d15', fg='white', 
                                    height=2, relief='flat', padx=5, pady=3, insertbackground='white')
        self.hub_comment.pack(fill=tk.X, padx=10, pady=(0,5))
        
        # M14_Q
        m14_frame = tk.Frame(file_frame, bg='#252540', relief='ridge', bd=2)
        m14_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(5,0), ipady=5, ipadx=10)
        
        tk.Label(m14_frame, text="ğŸ­ M14_Q (1700)", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), 
                 bg='#252540', fg='#ff6b35').pack(anchor='w', padx=10, pady=(5,2))
        
        m14_btn_frame = tk.Frame(m14_frame, bg='#252540')
        m14_btn_frame.pack(fill=tk.X, padx=10, pady=3)
        tk.Button(m14_btn_frame, text="ğŸ“ íŒŒì¼", command=self.select_m14_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#ff6b35', fg='black', width=8).pack(side=tk.LEFT)
        self.m14_label = tk.Label(m14_btn_frame, text="ì„ íƒ ì•ˆë¨", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#888')
        self.m14_label.pack(side=tk.LEFT, padx=5)
        
        m14_alarm_frame = tk.Frame(m14_frame, bg='#252540')
        m14_alarm_frame.pack(fill=tk.X, padx=10, pady=2)
        tk.Button(m14_alarm_frame, text="ğŸš¨ ì•ŒëŒ", command=self.select_m14_alarm_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#ffcc00', fg='black', width=8).pack(side=tk.LEFT)
        self.m14_alarm_label = tk.Label(m14_alarm_frame, text="(ì„ íƒ)", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#666')
        self.m14_alarm_label.pack(side=tk.LEFT, padx=5)
        
        self.m14_comment = tk.Text(m14_frame, font=('ë§‘ì€ ê³ ë”•', 9), bg='#0d0d15', fg='white', 
                                    height=2, relief='flat', padx=5, pady=3, insertbackground='white')
        self.m14_comment.pack(fill=tk.X, padx=10, pady=(0,5))
        
        # ë¶„ì„ ë²„íŠ¼
        tk.Button(top_frame, text="ğŸ” ë¶„ì„ ì‹œì‘ ë° ì €ì¥", command=self.run_analysis,
                  font=('ë§‘ì€ ê³ ë”•', 12, 'bold'), bg='#00ff88', fg='black',
                  width=20, height=1).pack(pady=10)
        
        # íƒ­
        self.notebook = ttk.Notebook(main_frame)
        self.notebook.pack(fill=tk.BOTH, expand=True, pady=(5,0))
        
        style = ttk.Style()
        style.configure('TNotebook', background='#1a1a2e')
        style.configure('TNotebook.Tab', font=('ë§‘ì€ ê³ ë”•', 10, 'bold'), padding=[10, 5])
        
        result_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(result_frame, text='ğŸ“‹ ë¶„ì„ ê²°ê³¼')
        
        self.result_text = tk.Text(result_frame, font=('Consolas', 10), bg='#0d0d15', fg='white', 
                                    relief='flat', padx=15, pady=15)
        self.result_text.pack(fill=tk.BOTH, expand=True)
        self.result_text.insert(tk.END, "CSV íŒŒì¼ì„ ì„ íƒí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”...")
        
        self.hub_data_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(self.hub_data_frame, text='ğŸ  HUBROOM ë°ì´í„°')
        
        self.m14_data_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(self.m14_data_frame, text='ğŸ­ M14_Q ë°ì´í„°')
        
        # ì´ë²¤íŠ¸ ë·°ì–´ íƒ­ ì¶”ê°€
        self.event_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(self.event_frame, text='ğŸ“ˆ ì´ë²¤íŠ¸ ê·¸ë˜í”„')
        self.setup_event_viewer()
    
    def read_csv_auto(self, filepath):
        """ì—¬ëŸ¬ ì¸ì½”ë”© ì‹œë„í•´ì„œ CSV ì½ê¸°"""
        encodings = ['utf-8-sig', 'utf-8', 'cp949', 'euc-kr']
        for enc in encodings:
            try:
                return pd.read_csv(filepath, encoding=enc)
            except UnicodeDecodeError:
                continue
        raise ValueError(f"íŒŒì¼ ì¸ì½”ë”©ì„ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filepath}")
    
    def setup_event_viewer(self):
        """ì´ë²¤íŠ¸ ë·°ì–´ íƒ­ ì„¤ì •"""
        # ìƒë‹¨ ì»¨íŠ¸ë¡¤
        ctrl_frame = tk.Frame(self.event_frame, bg='#252540')
        ctrl_frame.pack(fill=tk.X, padx=10, pady=10)
        
        tk.Label(ctrl_frame, text="ì‹œìŠ¤í…œ:", font=('ë§‘ì€ ê³ ë”•', 10, 'bold'),
                 bg='#252540', fg='white').pack(side=tk.LEFT, padx=(10,5))
        self.ev_system = ttk.Combobox(ctrl_frame, values=['HUBROOM', 'M14_Q'], width=12, state='readonly')
        self.ev_system.set('HUBROOM')
        self.ev_system.pack(side=tk.LEFT, padx=5)
        self.ev_system.bind('<<ComboboxSelected>>', lambda e: self.refresh_event_list())
        
        tk.Label(ctrl_frame, text="ë¶„ë¥˜:", font=('ë§‘ì€ ê³ ë”•', 10, 'bold'),
                 bg='#252540', fg='white').pack(side=tk.LEFT, padx=(20,5))
        self.ev_class = ttk.Combobox(ctrl_frame, values=[
            'ì „ì²´', 'ì´ìƒíƒì§€', 'ë¯¸íƒ', 'ì •ìƒ', 'ì˜¤íƒ'
        ], width=15, state='readonly')
        self.ev_class.set('ì´ìƒíƒì§€')
        self.ev_class.pack(side=tk.LEFT, padx=5)
        self.ev_class.bind('<<ComboboxSelected>>', lambda e: self.refresh_event_list())
        
        tk.Button(ctrl_frame, text="ğŸ”„ ìƒˆë¡œê³ ì¹¨", command=self.refresh_event_list,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#00d4ff', fg='black').pack(side=tk.LEFT, padx=20)
        
        self.ev_count_label = tk.Label(ctrl_frame, text="ì´ë²¤íŠ¸: 0ê°œ", font=('ë§‘ì€ ê³ ë”•', 10),
                                        bg='#252540', fg='#00ff88')
        self.ev_count_label.pack(side=tk.RIGHT, padx=10)
        
        # ë©”ì¸ ì˜ì—­ (ë¦¬ìŠ¤íŠ¸ + ê·¸ë˜í”„)
        main_pane = tk.PanedWindow(self.event_frame, orient=tk.HORIZONTAL, bg='#1a1a2e', sashwidth=5)
        main_pane.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0,10))
        
        # ì™¼ìª½: ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸
        list_frame = tk.Frame(main_pane, bg='#0d0d15')
        main_pane.add(list_frame, width=400)
        
        tk.Label(list_frame, text="ğŸ“‹ ì´ë²¤íŠ¸ ëª©ë¡ (í´ë¦­ â†’ ê·¸ë˜í”„)", font=('ë§‘ì€ ê³ ë”•', 10, 'bold'),
                 bg='#0d0d15', fg='#ffcc00').pack(pady=(10,5))
        
        # ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤
        list_container = tk.Frame(list_frame, bg='#0d0d15')
        list_container.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        y_scroll = ttk.Scrollbar(list_container, orient=tk.VERTICAL)
        y_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        self.event_listbox = tk.Listbox(list_container, font=('Consolas', 9), bg='#15151f', fg='white',
                                         selectmode=tk.SINGLE, activestyle='none',
                                         yscrollcommand=y_scroll.set, selectbackground='#00d4ff',
                                         selectforeground='black')
        self.event_listbox.pack(fill=tk.BOTH, expand=True)
        y_scroll.config(command=self.event_listbox.yview)
        self.event_listbox.bind('<<ListboxSelect>>', self.on_event_select)
        
        # ì˜¤ë¥¸ìª½: ê·¸ë˜í”„
        graph_frame = tk.Frame(main_pane, bg='#0d0d15')
        main_pane.add(graph_frame, width=700)
        
        self.graph_title = tk.Label(graph_frame, text="ğŸ“ˆ ì´ë²¤íŠ¸ ì„ íƒ ì‹œ ê·¸ë˜í”„ í‘œì‹œ", 
                                     font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), bg='#0d0d15', fg='#00d4ff')
        self.graph_title.pack(pady=(10,5))
        
        # ê·¸ë˜í”„ ì •ë³´
        self.graph_info = tk.Label(graph_frame, text="", font=('ë§‘ì€ ê³ ë”•', 9), bg='#0d0d15', fg='#888')
        self.graph_info.pack()
        
        # matplotlib ìº”ë²„ìŠ¤
        self.graph_container = tk.Frame(graph_frame, bg='#0d0d15')
        self.graph_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        if HAS_MATPLOTLIB:
            plt.style.use('dark_background')
            self.fig = Figure(figsize=(8, 5), dpi=100, facecolor='#0d0d15')
            self.ax = self.fig.add_subplot(111)
            self.ax.set_facecolor('#15151f')
            self.canvas = FigureCanvasTkAgg(self.fig, master=self.graph_container)
            self.canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)
        else:
            tk.Label(self.graph_container, text="matplotlib ì„¤ì¹˜ í•„ìš”\npip install matplotlib",
                     font=('ë§‘ì€ ê³ ë”•', 12), bg='#0d0d15', fg='#ff4466').pack(pady=50)
        
        self.event_data = []  # í˜„ì¬ í‘œì‹œì¤‘ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸
    
    def refresh_event_list(self):
        """ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨"""
        self.event_listbox.delete(0, tk.END)
        self.event_data = []
        
        system = self.ev_system.get()
        cls_filter = self.ev_class.get()
        
        df = self.hub_df if system == 'HUBROOM' else self.m14_df
        
        if df is None or len(df) == 0 or 'ë¶„ë¥˜' not in df.columns:
            self.ev_count_label.config(text="ì´ë²¤íŠ¸: 0ê°œ")
            return
        
        # í•„í„°ë§ - includes ì‚¬ìš© + ì¿¨ë‹¤ìš´ ì œì™¸
        if cls_filter == 'ì „ì²´':
            filtered = df
        elif cls_filter == 'ì´ìƒíƒì§€':
            filtered = df[df['ë¶„ë¥˜'].str.contains('ì´ìƒ', na=False) & ~df['ë¶„ë¥˜'].str.contains('ì¿¨ë‹¤ìš´', na=False)]
        elif cls_filter == 'ë¯¸íƒ':
            filtered = df[df['ë¶„ë¥˜'].str.contains('ë¯¸íƒ', na=False) & ~df['ë¶„ë¥˜'].str.contains('ì¿¨ë‹¤ìš´', na=False)]
        elif cls_filter == 'ì •ìƒ':
            filtered = df[df['ë¶„ë¥˜'].str.contains('ì •ìƒ', na=False) & ~df['ë¶„ë¥˜'].str.contains('ì´ìƒ', na=False)]
        elif cls_filter == 'ì˜¤íƒ':
            filtered = df[df['ë¶„ë¥˜'] == 'ì˜¤íƒ']
        else:
            filtered = df[df['ë¶„ë¥˜'].str.contains(cls_filter, na=False)]
        
        self.ev_count_label.config(text=f"ì´ë²¤íŠ¸: {len(filtered)}ê°œ")
        
        # ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        for i, (idx, row) in enumerate(filtered.iterrows()):
            time_str = str(row.get('í˜„ì¬ì‹œê°„', ''))[-11:]
            pred_time = str(row.get('ì˜ˆì¸¡ì‹œì ', ''))[-11:]
            actual = row.get('ì‹¤ì œê°’', 0)
            pred = row.get('ì˜ˆì¸¡ê°’_MAX', 0)
            cls = str(row.get('ë¶„ë¥˜', ''))[:12]
            
            display = f"{i+1:4d} | {time_str} â†’ {pred_time} | ì‹¤:{actual:6.0f} ì˜ˆ:{pred:6.0f} | {cls}"
            self.event_listbox.insert(tk.END, display)
            self.event_data.append(idx)
    
    def on_event_select(self, event):
        """ì´ë²¤íŠ¸ ì„ íƒ ì‹œ ê·¸ë˜í”„ í‘œì‹œ"""
        if not HAS_MATPLOTLIB:
            return
        
        selection = self.event_listbox.curselection()
        if not selection:
            return
        
        list_idx = selection[0]
        if list_idx >= len(self.event_data):
            return
        
        df_idx = self.event_data[list_idx]
        system = self.ev_system.get()
        df = self.hub_df if system == 'HUBROOM' else self.m14_df
        threshold = 350 if system == 'HUBROOM' else 1700
        
        if df is None:
            return
        
        row = df.loc[df_idx]
        center_time = str(row.get('í˜„ì¬ì‹œê°„', ''))
        cls = str(row.get('ë¶„ë¥˜', ''))
        actual_val = row.get('ì‹¤ì œê°’', 0)
        pred_val = row.get('ì˜ˆì¸¡ê°’_MAX', 0)
        
        row_pos = df.index.get_loc(df_idx)
        start_pos = max(0, row_pos - 30)
        end_pos = min(len(df), row_pos + 31)
        
        range_df = df.iloc[start_pos:end_pos].copy()
        
        self.ax.clear()
        self.ax.set_facecolor('#15151f')
        
        x_labels = [str(t)[-8:] for t in range_df['í˜„ì¬ì‹œê°„'].values]
        x_pos = list(range(len(range_df)))
        
        # ì˜ˆì¸¡ê°’ í¬ì¸íŠ¸ ìƒ‰ìƒ/í¬ê¸° ì„¤ì • (ì•ŒëŒ ìƒíƒœì— ë”°ë¼)
        pred_colors = []
        pred_sizes = []
        alarm_count = 0
        cooldown_count = 0
        miss_count = 0
        
        for i, (idx, r) in enumerate(range_df.iterrows()):
            if 'ì•ŒëŒ' in range_df.columns and pd.notna(r.get('ì•ŒëŒ')) and str(r.get('ì•ŒëŒ', '')).strip():
                pred_colors.append('#ff4466')  # ì•ŒëŒ: ë¹¨ê°„ìƒ‰
                pred_sizes.append(80)
                alarm_count += 1
            elif 'ì•ŒëŒì¿¨ë‹¤ìš´' in range_df.columns and pd.notna(r.get('ì•ŒëŒì¿¨ë‹¤ìš´')) and str(r.get('ì•ŒëŒì¿¨ë‹¤ìš´', '')).strip():
                pred_colors.append('#4488ff')  # ì¿¨ë‹¤ìš´: íŒŒë€ìƒ‰
                pred_sizes.append(30)
                cooldown_count += 1
            elif 'ì•ŒëŒë¯¸ë°œìƒ' in range_df.columns and pd.notna(r.get('ì•ŒëŒë¯¸ë°œìƒ')) and str(r.get('ì•ŒëŒë¯¸ë°œìƒ', '')).strip():
                pred_colors.append('#aa44ff')  # ë¯¸ë°œìƒ: ë³´ë¼ìƒ‰
                pred_sizes.append(80)
                miss_count += 1
            else:
                pred_colors.append('#ff6b35')  # ê¸°ë³¸: ì£¼í™©ìƒ‰
                pred_sizes.append(25)
        
        # ì‹¤ì œê°’ ë¼ì¸
        self.ax.plot(x_pos, range_df['ì‹¤ì œê°’'].values, 'o-', color='#00d4ff', 
                     linewidth=2, markersize=6, label='ì‹¤ì œê°’')
        
        # ì˜ˆì¸¡ê°’ ë¼ì¸ (ê¸°ë³¸)
        self.ax.plot(x_pos, range_df['ì˜ˆì¸¡ê°’_MAX'].values, '--', color='#ff6b35', 
                     linewidth=2, label='ì˜ˆì¸¡ê°’')
        
        # ì˜ˆì¸¡ê°’ í¬ì¸íŠ¸ (ì•ŒëŒ ìƒ‰ìƒ ì ìš©)
        self.ax.scatter(x_pos, range_df['ì˜ˆì¸¡ê°’_MAX'].values, c=pred_colors, s=pred_sizes, 
                        marker='s', zorder=4, edgecolors='white', linewidths=0.5)
        
        self.ax.axhline(y=threshold, color='#ff4466', linestyle=':', linewidth=2, label=f'ë¦¬ë¯¸íŠ¸ê°’ ({threshold})')
        
        center_pos = row_pos - start_pos
        self.ax.axvline(x=center_pos, color='#ffcc00', linestyle='-', linewidth=2, alpha=0.5)
        self.ax.scatter([center_pos], [actual_val], color='#ffcc00', s=150, zorder=5, marker='*')
        
        self.ax.set_xticks(x_pos)
        self.ax.set_xticklabels(x_labels, rotation=45, ha='right', fontsize=8)
        self.ax.set_xlabel('ì‹œê°„', fontsize=10, color='white')
        self.ax.set_ylabel('ê°’', fontsize=10, color='white')
        self.ax.legend(loc='upper right', fontsize=9)
        self.ax.grid(True, alpha=0.3, color='#333')
        self.ax.tick_params(colors='white')
        
        self.fig.tight_layout()
        self.canvas.draw()
        
        # ìƒíƒœ í…ìŠ¤íŠ¸
        status_text = ""
        if alarm_count > 0:
            status_text += f" | ğŸ”´ì•ŒëŒ {alarm_count}"
        if cooldown_count > 0:
            status_text += f" | ğŸ”µì¿¨ë‹¤ìš´ {cooldown_count}"
        if miss_count > 0:
            status_text += f" | ğŸŸ£ë¯¸ë°œìƒ {miss_count}"
        
        self.graph_title.config(text=f"ğŸ“ˆ {system} - {cls}")
        self.graph_info.config(text=f"ì‹œì : {center_time} | ì‹¤ì œê°’: {actual_val:.0f} | ì˜ˆì¸¡ê°’: {pred_val:.1f} | Â±30ë¶„ ë²”ìœ„{status_text}")
    
    def create_data_view(self, parent, df):
        for widget in parent.winfo_children():
            widget.destroy()
        
        if df is None or len(df) == 0:
            tk.Label(parent, text="ë°ì´í„° ì—†ìŒ", font=('ë§‘ì€ ê³ ë”•', 12), bg='#0d0d15', fg='#888').pack(pady=50)
            return
        
        tree_frame = tk.Frame(parent, bg='#0d0d15')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        y_scroll = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL)
        y_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        x_scroll = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL)
        x_scroll.pack(side=tk.BOTTOM, fill=tk.X)
        
        cols = list(df.columns)
        tree = ttk.Treeview(tree_frame, columns=cols, show='headings',
                            yscrollcommand=y_scroll.set, xscrollcommand=x_scroll.set)
        
        y_scroll.config(command=tree.yview)
        x_scroll.config(command=tree.xview)
        
        for col in cols:
            tree.heading(col, text=col)
            tree.column(col, width=100, minwidth=50)
        
        for idx, row in df.iterrows():
            values = [str(v) if pd.notna(v) else '' for v in row.values]
            tag = ''
            if 'ë¶„ë¥˜' in df.columns:
                ë¶„ë¥˜ = str(row.get('ë¶„ë¥˜', ''))
                if 'ì´ìƒ' in ë¶„ë¥˜:
                    tag = 'detect'
                elif 'ë¯¸íƒ' in ë¶„ë¥˜:
                    tag = 'miss'
                elif 'ì •ìƒ' in ë¶„ë¥˜:
                    tag = 'normal'
                elif 'ì˜¤íƒ' in ë¶„ë¥˜:
                    tag = 'false'
            tree.insert('', tk.END, values=values, tags=(tag,))
        
        tree.tag_configure('detect', background='#1a3a1a')
        tree.tag_configure('miss', background='#3a1a1a')
        tree.tag_configure('normal', background='#1a1a2a')
        tree.tag_configure('false', background='#3a1a2a')
        
        tree.pack(fill=tk.BOTH, expand=True)
    
    def select_hub_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.hub_file = file
            self.hub_label.config(text=f"âœ… {os.path.basename(file)[:25]}", fg='#00ff88')
    
    def select_m14_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.m14_file = file
            self.m14_label.config(text=f"âœ… {os.path.basename(file)[:25]}", fg='#00ff88')
    
    def select_hub_alarm_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv"), ("All files", "*.*")])
        if file:
            self.hub_alarm_file = file
            self.hub_alarm_label.config(text=f"âœ… {os.path.basename(file)[:20]}", fg='#ffcc00')
    
    def select_m14_alarm_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv"), ("All files", "*.*")])
        if file:
            self.m14_alarm_file = file
            self.m14_alarm_label.config(text=f"âœ… {os.path.basename(file)[:20]}", fg='#ffcc00')
    
    def load_alarm_data(self, alarm_file):
        """ì•ŒëŒ CSV ë¡œë“œ ë° ì‹œê°„ í˜•ì‹ ë³€í™˜"""
        if not alarm_file:
            return None
        try:
            df = self.read_csv_auto(alarm_file)
            if 'MEAS_TM' in df.columns:
                # MEAS_TMì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (202512291354 í˜•ì‹)
                df['MEAS_TM'] = df['MEAS_TM'].astype(str)
            if 'LSTM_FCAST_TM' in df.columns:
                # LSTM_FCAST_TMì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì˜ˆì¸¡ì‹œì ê³¼ ë§¤ì¹­ìš©)
                df['LSTM_FCAST_TM'] = df['LSTM_FCAST_TM'].astype(str)
            return df
        except Exception as e:
            print(f"ì•ŒëŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return None
    
    def match_alarm(self, df, alarm_df, pred_time_col='ì˜ˆì¸¡ì‹œì ', pred_col='ì˜ˆì¸¡ê°’_MAX', threshold=1700):
        """ë°ì´í„°í”„ë ˆì„ì— ì•ŒëŒ ë§¤ì¹­ (ìµœì´ˆ 1ê°œ + 60ë¶„ ì¿¨ë‹¤ìš´ ë°©ì‹)
        - ì•ŒëŒ: ìµœì´ˆ ì•ŒëŒ ë°œìƒ (60ë¶„ ë‚´ ì¬ë°œìƒì€ ì¿¨ë‹¤ìš´)
        - ì•ŒëŒì¿¨ë‹¤ìš´: ì•ŒëŒ ë°œìƒ í›„ 60ë¶„ ì´ë‚´
        - ì•ŒëŒë¯¸ë°œìƒ: ì˜ˆì¸¡>=thresholdì¸ë° ì•ŒëŒë„ ì¿¨ë‹¤ìš´ë„ ì•„ë‹˜ (ì „ë¶€ í‘œì‹œ)
        """
        df = df.copy()
        df = df.reset_index(drop=True)  # ì¸ë±ìŠ¤ 0ë¶€í„° ë¦¬ì…‹!
        df['ì•ŒëŒ'] = ''
        df['ì•ŒëŒì¿¨ë‹¤ìš´'] = ''
        df['ì•ŒëŒë¯¸ë°œìƒ'] = ''
        df['ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´'] = ''
        
        # ì˜ˆì¸¡ ì»¬ëŸ¼ í™•ì¸ (ì˜ˆì¸¡ê°’_MAX ë˜ëŠ” ìµœì¢…ì˜ˆì¸¡)
        actual_pred_col = None
        if pred_col in df.columns:
            actual_pred_col = pred_col
        elif 'ì˜ˆì¸¡ê°’_MAX' in df.columns:
            actual_pred_col = 'ì˜ˆì¸¡ê°’_MAX'
        elif 'ìµœì¢…ì˜ˆì¸¡' in df.columns:
            actual_pred_col = 'ìµœì¢…ì˜ˆì¸¡'
        
        if actual_pred_col is None:
            print(f"ê²½ê³ : ì˜ˆì¸¡ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ ëª©ë¡: {df.columns.tolist()}")
            return df
        
        if alarm_df is None or len(alarm_df) == 0:
            # ì•ŒëŒ ë°ì´í„° ì—†ìœ¼ë©´ ì˜ˆì¸¡ê°’>=thresholdì¸ ê³³ ì „ë¶€ ë¯¸ë°œìƒ ì²˜ë¦¬
            for idx in range(len(df)):
                pred_val = df.loc[idx, actual_pred_col]
                if pred_val >= threshold:
                    df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒ'] = 'ì•ŒëŒë°ì´í„°ì—†ìŒ'
            return df
        
        # 1ë‹¨ê³„: ì•ŒëŒ ë°œìƒ ì‹œì  ì°¾ê¸° (ìµœì´ˆë§Œ ê¸°ë¡, 60ë¶„ ë‚´ ì¬ë°œìƒì€ ì¿¨ë‹¤ìš´)
        last_alarm_idx = -9999  # ë§ˆì§€ë§‰ ìµœì´ˆ ì•ŒëŒ ì¸ë±ìŠ¤ (ì•„ì§ ì—†ìŒ)
        last_alarm_at = {}  # ê° idx ì‹œì ì—ì„œì˜ last_alarm_idx ì €ì¥
        
        for idx in range(len(df)):
            pred_time_str = str(df.loc[idx, pred_time_col])
            time_key = pred_time_str.replace('-', '').replace(':', '').replace(' ', '')[:12]
            
            if 'LSTM_FCAST_TM' in alarm_df.columns:
                matched = alarm_df[alarm_df['LSTM_FCAST_TM'].str[:12] == time_key]
            else:
                matched = alarm_df[alarm_df['MEAS_TM'].str[:12] == time_key]
            
            if len(matched) > 0:
                # ì•ŒëŒì´ ìˆëŠ” ì‹œì 
                alarm_texts = []
                for _, row in matched.head(2).iterrows():
                    meas_tm = str(row.get('MEAS_TM', ''))
                    if len(meas_tm) >= 12:
                        meas_formatted = f"{meas_tm[4:6]}-{meas_tm[6:8]} {meas_tm[8:10]}:{meas_tm[10:12]}"
                    else:
                        meas_formatted = meas_tm
                    alarm_texts.append(f"[{meas_formatted}] Y ì˜ˆì¸¡ê°’{threshold}ì´ˆê³¼")
                alarm_text = ' / '.join(alarm_texts)
                
                if last_alarm_idx < 0 or idx - last_alarm_idx > 60:
                    # 60ë¶„ ì§€ë‚¬ìœ¼ë‹ˆ ìƒˆ ì•ŒëŒ (ìµœì´ˆ)
                    df.loc[idx, 'ì•ŒëŒ'] = alarm_text
                    last_alarm_idx = idx
                else:
                    # 60ë¶„ ì•ˆì´ë‹ˆ ì¿¨ë‹¤ìš´ - ëª‡ ë¶„ ì „ ì•ŒëŒì¸ì§€ í‘œì‹œ
                    minutes_ago = idx - last_alarm_idx
                    df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] = f'{minutes_ago}ë¶„ì „'
            
            # í˜„ì¬ idx ì‹œì ì˜ last_alarm_idx ì €ì¥
            last_alarm_at[idx] = last_alarm_idx
        
        # 2ë‹¨ê³„: ì˜ˆì¸¡ê°’>=thresholdì¸ë° ì•ŒëŒ ì•„ë‹Œ ê³³ ì²˜ë¦¬
        # - 60ë¶„ ì´ë‚´: ì•ŒëŒì¿¨ë‹¤ìš´ (ì•ŒëŒ CSVì— ì—†ì–´ë„!)
        # - 60ë¶„ ì´ˆê³¼: ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´
        for idx in range(len(df)):
            # ì´ë¯¸ ì•ŒëŒì´ë©´ ìŠ¤í‚µ
            if df.loc[idx, 'ì•ŒëŒ'] != '':
                continue
            
            # ì˜ˆì¸¡ê°’ì´ threshold ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ
            pred_val = df.loc[idx, actual_pred_col]
            if pred_val < threshold:
                continue
            
            # í•´ë‹¹ ì‹œì ê¹Œì§€ì˜ ë§ˆì§€ë§‰ ì•ŒëŒ ì¸ë±ìŠ¤
            my_last_alarm = last_alarm_at.get(idx, -9999)
            
            # ì˜ˆì¸¡ê°’ >= thresholdì¸ë°...
            if my_last_alarm < 0:
                # ì•„ì§ ì•ŒëŒ ë°œìƒ ì „ â†’ ì•ŒëŒë¯¸ë°œìƒ (í° í¬ê¸°)
                df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒ'] = 'ì´ì „ì•ŒëŒì—†ìŒ'
            else:
                minutes_ago = idx - my_last_alarm
                if minutes_ago <= 60:
                    # 60ë¶„ ì´ë‚´ â†’ ì•ŒëŒì¿¨ë‹¤ìš´
                    if df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] == '':
                        df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] = f'{minutes_ago}ë¶„ì „'
                else:
                    # 60ë¶„ ì´ˆê³¼ â†’ ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´
                    df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´'] = f'{minutes_ago}ë¶„ì „'
        
        return df
    
    def analyze_alarm_based(self, df, alarm_df, threshold, pred_col, curr_col, actual_col, pred_time_col):
        """
        V8.2 ì•ŒëŒ ê¸°ë°˜ ë¶„ë¥˜ ë¡œì§
        1) ì‹¤ì œê°’ >= threshold + ì•ŒëŒë°œìƒ â†’ ì´ìƒíƒì§€
        2) ì‹¤ì œê°’ >= threshold + ì•ŒëŒë¯¸ë°œìƒ â†’ ë¯¸íƒ
        3) ì‹¤ì œê°’ < threshold + ì•ŒëŒë°œìƒ â†’ ì˜¤íƒ
        4) ì‹¤ì œê°’ < threshold + ì•ŒëŒë¯¸ë°œìƒ â†’ ì •ìƒ
        """
        df = df.copy()
        df = df.reset_index(drop=True)
        
        # ë¶ˆí•„ìš” ì»¬ëŸ¼ ì œê±°
        drop_cols = ['Unnamed: 22', 'Unnamed: 23', '12ë¶„ì „TOTALCNT', '12ë³€í™”ëŸ‰']
        for col in drop_cols:
            if col in df.columns:
                df = df.drop(columns=[col])
        
        # ì•ŒëŒ ì»¬ëŸ¼ ì´ˆê¸°í™”
        df['ì•ŒëŒ'] = ''
        df['ì•ŒëŒì¿¨ë‹¤ìš´'] = ''
        df['ì•ŒëŒë¯¸ë°œìƒ'] = ''
        df['ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´'] = ''
        df['ë¶„ë¥˜'] = ''
        
        # ì•ŒëŒ ë§¤ì¹­ (60ë¶„ ì¿¨ë‹¤ìš´) - ì˜ˆì¸¡ê°’ >= thresholdì¸ ê²½ìš°ì—ë§Œ í‘œì‹œ!
        last_alarm_idx = -9999
        
        if alarm_df is not None and len(alarm_df) > 0:
            for idx in range(len(df)):
                pred = df.loc[idx, pred_col]
                if pred < threshold:
                    continue  # ì˜ˆì¸¡ê°’ < thresholdë©´ ì•ŒëŒ í‘œì‹œ ì•ˆí•¨
                
                pred_time_str = str(df.loc[idx, pred_time_col])
                time_key = pred_time_str.replace('-', '').replace(':', '').replace(' ', '')[:12]
                
                if 'LSTM_FCAST_TM' in alarm_df.columns:
                    matched = alarm_df[alarm_df['LSTM_FCAST_TM'].str[:12] == time_key]
                else:
                    matched = alarm_df[alarm_df['MEAS_TM'].str[:12] == time_key]
                
                if len(matched) > 0:
                    alarm_texts = []
                    for _, row in matched.head(2).iterrows():
                        meas_tm = str(row.get('MEAS_TM', ''))
                        if len(meas_tm) >= 12:
                            meas_formatted = f"{meas_tm[4:6]}-{meas_tm[6:8]} {meas_tm[8:10]}:{meas_tm[10:12]}"
                        else:
                            meas_formatted = meas_tm
                        alarm_texts.append(f"[{meas_formatted}]")
                    alarm_text = ' / '.join(alarm_texts)
                    
                    if last_alarm_idx < 0 or idx - last_alarm_idx > 60:
                        df.loc[idx, 'ì•ŒëŒ'] = alarm_text
                        last_alarm_idx = idx
                    else:
                        minutes_ago = idx - last_alarm_idx
                        df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] = f'{minutes_ago}ë¶„ì „'
        
        # ì•ŒëŒë¯¸ë°œìƒ ì²˜ë¦¬ (ì˜ˆì¸¡ê°’ >= thresholdì¸ë° ì•ŒëŒë„ ì¿¨ë‹¤ìš´ë„ ì—†ëŠ” ê²½ìš°) + 60ë¶„ ì¿¨ë‹¤ìš´
        # ë‹¨, ì•ŒëŒ ë°œìƒ í›„ 60ë¶„ê°„ì€ ì•ŒëŒë¯¸ë°œìƒ ì²´í¬ ì•ˆí•¨!
        last_miss_idx = -9999
        for idx in range(len(df)):
            # ì´ í–‰ì— ì•ŒëŒì´ë‚˜ ì¿¨ë‹¤ìš´ ìˆìœ¼ë©´ ìŠ¤í‚µ
            if df.loc[idx, 'ì•ŒëŒ'] or df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´']:
                continue
            
            pred = df.loc[idx, pred_col]
            if pred < threshold:
                continue
            
            # ìµœê·¼ 60ë¶„ ë‚´ ì•ŒëŒ ë°œìƒí–ˆìœ¼ë©´ â†’ ì•ŒëŒì¿¨ë‹¤ìš´ìœ¼ë¡œ í‘œì‹œ!
            alarm_cooldown_back = 0
            for back in range(1, 61):
                if idx - back >= 0 and df.loc[idx - back, 'ì•ŒëŒ']:
                    alarm_cooldown_back = back
                    break
            
            if alarm_cooldown_back > 0:
                # ì•ŒëŒ ì¿¨ë‹¤ìš´ ê¸°ê°„ì´ë¼ ì•ŒëŒ ì•ˆ ìš¸ë¦¼ â†’ ì•ŒëŒì¿¨ë‹¤ìš´ í‘œì‹œ
                df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] = f'ì¿¨ë‹¤ìš´ì¤‘({alarm_cooldown_back}ë¶„ì „)'
            else:
                # 60ë¶„ ë‚´ ì•ŒëŒ ì—†ìŒ â†’ ì•ŒëŒë¯¸ë°œìƒ
                if last_miss_idx < 0 or idx - last_miss_idx > 60:
                    df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒ'] = 'ë¯¸ë°œìƒ'
                    last_miss_idx = idx
                else:
                    minutes_ago = idx - last_miss_idx
                    df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´'] = f'{minutes_ago}ë¶„ì „'
        
        # ë¶„ë¥˜ (ì¿¨ë‹¤ìš´ êµ¬ë¶„) - 60ë¶„ ì´ë‚´ ì•ŒëŒ/ì•ŒëŒë¯¸ë°œìƒ ìˆìœ¼ë©´ ì¿¨ë‹¤ìš´
        for idx in range(len(df)):
            actual = df.loc[idx, actual_col]
            
            # í˜„ì¬ í–‰ì˜ ìƒíƒœ
            has_alarm = df.loc[idx, 'ì•ŒëŒ'] != ''
            has_alarm_cd = df.loc[idx, 'ì•ŒëŒì¿¨ë‹¤ìš´'] != ''
            has_miss = df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒ'] != ''
            has_miss_cd = df.loc[idx, 'ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´'] != ''
            
            # 60ë¶„ ì´ë‚´ ì•ŒëŒ/ì•ŒëŒë¯¸ë°œìƒ ìˆì—ˆëŠ”ì§€ ì²´í¬
            in_alarm_cooldown = False
            in_miss_cooldown = False
            for back in range(1, 61):
                if idx - back >= 0:
                    if df.loc[idx - back, 'ì•ŒëŒ'] != '':
                        in_alarm_cooldown = True
                        break
            for back in range(1, 61):
                if idx - back >= 0:
                    if df.loc[idx - back, 'ì•ŒëŒë¯¸ë°œìƒ'] != '':
                        in_miss_cooldown = True
                        break
            
            if actual >= threshold:
                # ê¸‰ì¦ ì¼€ì´ìŠ¤
                if has_alarm:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì´ìƒíƒì§€'
                elif has_alarm_cd or in_alarm_cooldown:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì´ìƒíƒì§€(ì¿¨ë‹¤ìš´)'
                elif has_miss:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ë¯¸íƒ'
                elif has_miss_cd or in_miss_cooldown:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ë¯¸íƒ(ì¿¨ë‹¤ìš´)'
                else:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ë¯¸íƒ'
            else:
                # ì •ìƒ ì¼€ì´ìŠ¤
                if has_alarm:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì˜¤íƒ'
                elif has_alarm_cd or in_alarm_cooldown:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì˜¤íƒ(ì¿¨ë‹¤ìš´)'
                else:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì •ìƒ'
        
        # í†µê³„ (ì¿¨ë‹¤ìš´ ì œì™¸í•œ ìˆœìˆ˜ ê°œìˆ˜)
        total = len(df)
        surge_total = len(df[df[actual_col] >= threshold])  # ê¸‰ì¦ ê±´ìˆ˜ ì „ì²´
        detect = len(df[df['ë¶„ë¥˜'] == 'ì´ìƒíƒì§€'])  # ì¿¨ë‹¤ìš´ ì œì™¸
        miss = len(df[df['ë¶„ë¥˜'] == 'ë¯¸íƒ'])  # ì¿¨ë‹¤ìš´ ì œì™¸
        normal = len(df[df['ë¶„ë¥˜'] == 'ì •ìƒ'])
        false_alarm = len(df[df['ë¶„ë¥˜'] == 'ì˜¤íƒ'])  # ì¿¨ë‹¤ìš´ ì œì™¸
        alarm_total = detect + false_alarm  # ì¿¨ë‹¤ìš´ ì œì™¸í•œ ì•ŒëŒë°œìƒ
        surge_base = detect + miss  # ì¿¨ë‹¤ìš´ ì œì™¸í•œ ê¸‰ì¦ ì¼€ì´ìŠ¤ (íƒì§€ìœ¨/ë¯¸íƒìœ¨ ê¸°ì¤€)
        
        stats = {
            'total_rows': total,
            'surge_total': surge_total,
            'detect': detect,
            'miss': miss,
            'normal': normal,
            'false': false_alarm,
            'alarm_total': alarm_total,  # ì˜¤íƒìœ¨ ê³„ì‚°ìš©
            'surge_base': surge_base     # íƒì§€ìœ¨/ë¯¸íƒìœ¨ ê³„ì‚°ìš©
        }
        
        # ì»¬ëŸ¼ ìˆœì„œ ì •ë¦¬
        cols = df.columns.tolist()
        if 'ë¶„ë¥˜' in cols:
            cols.remove('ë¶„ë¥˜')
            actual_idx = cols.index(actual_col)
            df = df[cols[:actual_idx+1] + ['ë¶„ë¥˜'] + cols[actual_idx+1:]]
        
        return df, stats
    
    def analyze_v81(self, df, threshold, pred_col, curr_col, actual_col):
        """
        V8.1 ë¶„ì„ ë¡œì§ (ë‹¨ìˆœí™”)
        ê¸‰ì¦(ì‹¤ì œ>=threshold):
          - í˜„ì¬ ì˜ˆì¸¡>=threshold â†’ ì´ìƒíƒì§€
          - ê³¼ê±° 10ë¶„ë‚´ ì˜ˆì¸¡>=threshold â†’ ì´ìƒ(ì •ìƒ(-Në¶„))
          - ê·¸ ì™¸ â†’ ë¯¸íƒ ë˜ëŠ” ë¯¸íƒ(Në¶„í›„)
        ì •ìƒ(ì‹¤ì œ<threshold):
          - ì˜ˆì¸¡<threshold â†’ ì •ìƒ
          - ì˜ˆì¸¡>=threshold + ê³¼ê±°10ë¶„ë‚´ ê¸‰ì¦ â†’ ì •ìƒ(ê¸‰ì¦(-Në¶„))
          - ì˜ˆì¸¡>=threshold + ê³¼ê±° ê¸‰ì¦ ì—†ìŒ â†’ ì˜¤íƒ
        """
        df = df.copy()
        
        # ë¶ˆí•„ìš” ì»¬ëŸ¼ ì œê±°
        drop_cols = ['Unnamed: 22', 'Unnamed: 23', '12ë¶„ì „TOTALCNT', '12ë³€í™”ëŸ‰']
        for col in drop_cols:
            if col in df.columns:
                df = df.drop(columns=[col])
        
        df['ë¶„ë¥˜'] = ''
        
        for idx in range(len(df)):
            actual = df.loc[idx, actual_col]
            pred = df.loc[idx, pred_col]
            
            if actual >= threshold:
                # ê¸‰ì¦ ì¼€ì´ìŠ¤
                if pred >= threshold:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì´ìƒíƒì§€'
                else:
                    # 1) ê³¼ê±° 10ë¶„ë‚´ ì˜ˆì¸¡ >= threshold â†’ ì´ìƒ(ì •ìƒ(-Në¶„))
                    found_past = False
                    for back in range(1, 11):
                        if idx - back >= 0 and df.loc[idx - back, pred_col] >= threshold:
                            df.loc[idx, 'ë¶„ë¥˜'] = f'ì´ìƒ(ì •ìƒ(-{back}ë¶„))'
                            found_past = True
                            break
                    
                    if not found_past:
                        # 2) ë¯¸ë˜ 10ë¶„ë‚´ ì˜ˆì¸¡ >= threshold â†’ ë¯¸íƒ(Në¶„í›„)
                        found_future = False
                        for fwd in range(1, 11):
                            if idx + fwd < len(df) and df.loc[idx + fwd, pred_col] >= threshold:
                                df.loc[idx, 'ë¶„ë¥˜'] = f'ë¯¸íƒ({fwd}ë¶„í›„)'
                                found_future = True
                                break
                        
                        if not found_future:
                            df.loc[idx, 'ë¶„ë¥˜'] = 'ë¯¸íƒ'
            else:
                # ì •ìƒ ì¼€ì´ìŠ¤ (ì‹¤ì œê°’ < threshold)
                if pred >= threshold:
                    # 10ë¶„ ì „ì— ê¸‰ì¦ ìˆëŠ”ì§€ ì²´í¬ â†’ ì •ìƒ(ê¸‰ì¦(-Në¶„))
                    found_past = False
                    for back in range(1, 11):
                        if idx - back >= 0 and df.loc[idx - back, actual_col] >= threshold:
                            found_past = True
                            df.loc[idx, 'ë¶„ë¥˜'] = f'ì •ìƒ(ê¸‰ì¦(-{back}ë¶„))'
                            break
                    
                    if not found_past:
                        # ê³¼ê±° ê¸‰ì¦ ì—†ìœ¼ë©´ ì˜¤íƒ
                        df.loc[idx, 'ë¶„ë¥˜'] = 'ì˜¤íƒ'
                else:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì •ìƒ'
        
        # í†µê³„ - ë‹¨ìˆœí™”ëœ 4ê°œ ë¶„ë¥˜
        total = len(df)
        surge_total = len(df[df[actual_col] >= threshold])
        
        # ì´ìƒíƒì§€ = ì´ìƒíƒì§€ + ì´ìƒ(ì •ìƒ(-Në¶„))
        detect = len(df[df['ë¶„ë¥˜'].str.contains('ì´ìƒ', na=False)])
        # ë¯¸íƒ = ë¯¸íƒ + ë¯¸íƒ(Në¶„í›„)
        miss = len(df[df['ë¶„ë¥˜'].str.contains('ë¯¸íƒ', na=False)])
        # ì •ìƒ = ì •ìƒ + ì •ìƒ(ê¸‰ì¦(-Në¶„))
        normal = len(df[df['ë¶„ë¥˜'].str.contains('ì •ìƒ', na=False) & ~df['ë¶„ë¥˜'].str.contains('ì´ìƒ', na=False)])
        # ì˜¤íƒ
        false_alarm = len(df[df['ë¶„ë¥˜'] == 'ì˜¤íƒ'])
        
        surge_base = detect + miss  # íƒì§€ìœ¨/ë¯¸íƒìœ¨ ê¸°ì¤€
        alarm_total = detect + false_alarm  # ì˜¤íƒìœ¨ ê¸°ì¤€
        
        stats = {
            'total_rows': total,
            'surge_total': surge_total,
            'detect': detect,      # ì´ìƒíƒì§€ ì „ì²´
            'miss': miss,          # ë¯¸íƒ ì „ì²´
            'normal': normal,      # ì •ìƒ ì „ì²´
            'false': false_alarm,  # ì˜¤íƒ
            'surge_base': surge_base,
            'alarm_total': alarm_total
        }
        
        # ì»¬ëŸ¼ ìˆœì„œ ì •ë¦¬
        cols = df.columns.tolist()
        if 'ë¶„ë¥˜' in cols:
            cols.remove('ë¶„ë¥˜')
            actual_idx = cols.index(actual_col)
            df = df[cols[:actual_idx+1] + ['ë¶„ë¥˜'] + cols[actual_idx+1:]]
        
        return df, stats
    
    def run_analysis(self):
        if not self.hub_file and not self.m14_file:
            messagebox.showwarning("ê²½ê³ ", "CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!")
            return
        
        hub_cmt = self.hub_comment.get("1.0", tk.END).strip()
        m14_cmt = self.m14_comment.get("1.0", tk.END).strip()
        
        try:
            anal_date = f"{self.year_var.get()}ë…„ {self.month_var.get()}ì›” {self.day_var.get()}ì¼"
        except:
            anal_date = datetime.now().strftime("%Yë…„ %mì›” %dì¼")
        
        result_text = ""
        
        try:
            # ì•ŒëŒ ë°ì´í„° ë¡œë“œ
            self.hub_alarm_df = self.load_alarm_data(self.hub_alarm_file)
            self.m14_alarm_df = self.load_alarm_data(self.m14_alarm_file)
            
            if self.hub_file:
                df = self.read_csv_auto(self.hub_file)
                # ì•ŒëŒ íŒŒì¼ ìˆìœ¼ë©´ ì•ŒëŒ ê¸°ë°˜, ì—†ìœ¼ë©´ ì˜ˆì¸¡ê°’ ê¸°ì¤€
                if self.hub_alarm_df is not None and len(self.hub_alarm_df) > 0:
                    self.hub_df, self.hub_stats = self.analyze_alarm_based(
                        df.copy(), self.hub_alarm_df, 350, 'ì˜ˆì¸¡ê°’_MAX', 'í˜„ì¬ê°’', 'ì‹¤ì œê°’', 'ì˜ˆì¸¡ì‹œì ')
                    result_text += self.fmt("HUBROOM V8.2 (ì•ŒëŒê¸°ë°˜)", self.hub_stats, 350)
                else:
                    self.hub_df, self.hub_stats = self.analyze_v81(
                        df.copy(), 350, 'ì˜ˆì¸¡ê°’_MAX', 'í˜„ì¬ê°’', 'ì‹¤ì œê°’')
                    result_text += self.fmt_pred("HUBROOM V8.1 (ì˜ˆì¸¡ê¸°ë°˜)", self.hub_stats, 350)
                self.create_data_view(self.hub_data_frame, self.hub_df)
            
            if self.m14_file:
                df = self.read_csv_auto(self.m14_file)
                # ì•ŒëŒ íŒŒì¼ ìˆìœ¼ë©´ ì•ŒëŒ ê¸°ë°˜, ì—†ìœ¼ë©´ ì˜ˆì¸¡ê°’ ê¸°ì¤€
                if self.m14_alarm_df is not None and len(self.m14_alarm_df) > 0:
                    self.m14_df, self.m14_stats = self.analyze_alarm_based(
                        df.copy(), self.m14_alarm_df, 1700, 'ìµœì¢…ì˜ˆì¸¡', 'í˜„ì¬TOTALCNT', 'ì‹¤ì œê°’', 'ì˜ˆì¸¡ì‹œì ')
                    result_text += self.fmt("M14_Q V8.2 (ì•ŒëŒê¸°ë°˜)", self.m14_stats, 1700)
                else:
                    self.m14_df, self.m14_stats = self.analyze_v81(
                        df.copy(), 1700, 'ìµœì¢…ì˜ˆì¸¡', 'í˜„ì¬TOTALCNT', 'ì‹¤ì œê°’')
                    result_text += self.fmt_pred("M14_Q V8.1 (ì˜ˆì¸¡ê¸°ë°˜)", self.m14_stats, 1700)
                self.create_data_view(self.m14_data_frame, self.m14_df)
            
            self.result_text.config(state=tk.NORMAL)
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, result_text)
            self.result_text.config(state=tk.DISABLED)
            
            self.refresh_event_list()
            
            save_dir = filedialog.askdirectory(title="ê²°ê³¼ ì €ì¥í•  í´ë” ì„ íƒ")
            if save_dir:
                ts = datetime.now().strftime('%Y%m%d_%H%M%S')
                files = []
                
                if self.hub_df is not None:
                    f = os.path.join(save_dir, f"HUBìˆ˜ì¹˜í˜•_V8.2_í‰ê°€ê²°ê³¼_{ts}.csv")
                    self.hub_df.to_csv(f, index=False, encoding='utf-8-sig')
                    files.append(f)
                
                if self.m14_df is not None:
                    f = os.path.join(save_dir, f"M14ìˆ˜ì¹˜í˜•_V8.2_í‰ê°€ê²°ê³¼_{ts}.csv")
                    self.m14_df.to_csv(f, index=False, encoding='utf-8-sig')
                    files.append(f)
                
                html_f = os.path.join(save_dir, f"MLê¸‰ì¦ê°ì§€_V8.2_ë¦¬í¬íŠ¸_{ts}.html")
                with open(html_f, 'w', encoding='utf-8') as f:
                    f.write(self.gen_html(hub_cmt, m14_cmt, anal_date))
                files.append(html_f)
                
                webbrowser.open(html_f)
                messagebox.showinfo("ì™„ë£Œ", "ì €ì¥ ì™„ë£Œ!\n\n" + "\n".join([os.path.basename(x) for x in files]))
            
            self.refresh_event_list()
            
        except Exception as e:
            import traceback
            messagebox.showerror("ì˜¤ë¥˜", f"{str(e)}\n\n{traceback.format_exc()}")
    
    def fmt(self, name, s, th):
        """ì•ŒëŒ ê¸°ë°˜ í¬ë§· - ì˜¤íƒìœ¨ = ì˜¤íƒ/ì „ì²´ì•ŒëŒë°œìƒ"""
        t = s['total_rows'] or 1
        surge = s['surge_total'] or 1
        alarm_total = s.get('alarm_total', 1) or 1
        surge_base = s.get('surge_base', 1) or 1  # ì´ìƒíƒì§€ + ë¯¸íƒ
        
        return f"""
{'='*60}
  {name} (ê¸°ì¤€: {th})
{'='*60}
ì „ì²´: {s['total_rows']}ê°œ | ê¸‰ì¦: {s['surge_total']}ê°œ | ì•ŒëŒë°œìƒ: {s.get('alarm_total', 0)}ê°œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ì´ìƒíƒì§€: {s['detect']}ê°œ (íƒì§€ìœ¨: {s['detect']/surge_base*100:.1f}%)
âŒ ì˜¤íƒ: {s['false']}ê°œ (ì˜¤íƒìœ¨: {s['false']/alarm_total*100:.1f}%)
âŒ ë¯¸íƒ: {s['miss']}ê°œ (ë¯¸íƒìœ¨: {s['miss']/surge_base*100:.1f}%)
âœ… ì •ìƒ: {s['normal']}ê°œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    
    def fmt_pred(self, name, s, th):
        """ì˜ˆì¸¡ê°’ ê¸°ì¤€ í¬ë§·"""
        t = s['total_rows'] or 1
        surge = s['surge_total'] or 1
        surge_base = s.get('surge_base', 1) or 1
        alarm_total = s.get('alarm_total', 1) or 1
        
        return f"""
{'='*60}
  {name} (ê¸°ì¤€: {th})
{'='*60}
ì „ì²´: {s['total_rows']}ê°œ | ê¸‰ì¦: {s['surge_total']}ê°œ | ì •ìƒ: {t - surge}ê°œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ì´ìƒíƒì§€: {s['detect']}ê°œ (íƒì§€ìœ¨: {s['detect']/surge_base*100:.1f}%)
âŒ ì˜¤íƒ: {s['false']}ê°œ (ì˜¤íƒìœ¨: {s['false']/alarm_total*100:.1f}%)
âŒ ë¯¸íƒ: {s['miss']}ê°œ (ë¯¸íƒìœ¨: {s['miss']/surge_base*100:.1f}%)
âœ… ì •ìƒ: {s['normal']}ê°œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    
    def gen_html(self, hub_cmt, m14_cmt, anal_date):
        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜
        hub_json = "[]"
        m14_json = "[]"
        hub_stats_json = "{}"
        m14_stats_json = "{}"
        
        if self.hub_df is not None and len(self.hub_df) > 0:
            hub_data = []
            for i, (idx, row) in enumerate(self.hub_df.iterrows()):
                alarm_val = str(row.get('ì•ŒëŒ', '')) if pd.notna(row.get('ì•ŒëŒ')) else ''
                cooldown_val = str(row.get('ì•ŒëŒì¿¨ë‹¤ìš´', '')) if pd.notna(row.get('ì•ŒëŒì¿¨ë‹¤ìš´')) else ''
                miss_val = str(row.get('ì•ŒëŒë¯¸ë°œìƒ', '')) if pd.notna(row.get('ì•ŒëŒë¯¸ë°œìƒ')) else ''
                miss_cd_val = str(row.get('ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´', '')) if pd.notna(row.get('ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´')) else ''
                hub_data.append({
                    'idx': i,
                    'time': str(row.get('í˜„ì¬ì‹œê°„', '')),
                    'pred_time': str(row.get('ì˜ˆì¸¡ì‹œì ', '')),
                    'current': float(row.get('í˜„ì¬ê°’', 0)),
                    'actual': float(row.get('ì‹¤ì œê°’', 0)),
                    'pred': float(row.get('ì˜ˆì¸¡ê°’_MAX', 0)),
                    'cls': str(row.get('ë¶„ë¥˜', '')),
                    'alarm': alarm_val,
                    'cooldown': cooldown_val,
                    'alarm_miss': miss_val,
                    'alarm_miss_cd': miss_cd_val
                })
            hub_json = str(hub_data).replace("'", '"')
        
        if self.m14_df is not None and len(self.m14_df) > 0:
            m14_data = []
            for i, (idx, row) in enumerate(self.m14_df.iterrows()):
                alarm_val = str(row.get('ì•ŒëŒ', '')) if pd.notna(row.get('ì•ŒëŒ')) else ''
                cooldown_val = str(row.get('ì•ŒëŒì¿¨ë‹¤ìš´', '')) if pd.notna(row.get('ì•ŒëŒì¿¨ë‹¤ìš´')) else ''
                miss_val = str(row.get('ì•ŒëŒë¯¸ë°œìƒ', '')) if pd.notna(row.get('ì•ŒëŒë¯¸ë°œìƒ')) else ''
                miss_cd_val = str(row.get('ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´', '')) if pd.notna(row.get('ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´')) else ''
                m14_data.append({
                    'idx': i,
                    'time': str(row.get('í˜„ì¬ì‹œê°„', '')),
                    'pred_time': str(row.get('ì˜ˆì¸¡ì‹œì ', '')),
                    'current': float(row.get('í˜„ì¬TOTALCNT', 0)),
                    'actual': float(row.get('ì‹¤ì œê°’', 0)),
                    'pred': float(row.get('ì˜ˆì¸¡ê°’_MAX', row.get('ìµœì¢…ì˜ˆì¸¡', 0))),
                    'cls': str(row.get('ë¶„ë¥˜', '')),
                    'alarm': alarm_val,
                    'cooldown': cooldown_val,
                    'alarm_miss': miss_val,
                    'alarm_miss_cd': miss_cd_val
                })
            m14_json = str(m14_data).replace("'", '"')
        
        if self.hub_stats:
            s = self.hub_stats
            hub_stats_json = str({
                'total': s['total_rows'],
                'surge_total': s['surge_total'],
                'detect': s['detect'],
                'miss': s['miss'],
                'normal': s['normal'],
                'false': s['false'],
                'alarm_total': s.get('alarm_total', 0)
            }).replace("'", '"')
        
        if self.m14_stats:
            s = self.m14_stats
            m14_stats_json = str({
                'total': s['total_rows'],
                'surge_total': s['surge_total'],
                'detect': s['detect'],
                'miss': s['miss'],
                'normal': s['normal'],
                'false': s['false'],
                'alarm_total': s.get('alarm_total', 0)
            }).replace("'", '"')
        
        html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸ V8.2</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
*{{margin:0;padding:0;box-sizing:border-box}}
body{{font-family:'ë§‘ì€ ê³ ë”•',sans-serif;background:#0a0a0f;color:#fff;padding:25px;font-size:0.9rem}}
.container{{max-width:1400px;margin:0 auto}}
h1{{font-size:2rem;text-align:center;background:linear-gradient(135deg,#00d4ff,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}}
.sub{{text-align:center;color:#888;margin-bottom:20px;font-size:0.9rem}}
.view-toggle{{display:flex;justify-content:center;gap:15px;margin-bottom:25px;padding:15px;background:#12121a;border-radius:12px;border:1px solid #2a2a3a}}
.toggle-btn{{padding:12px 28px;border-radius:8px;border:2px solid #444;background:#1a1a2a;color:#888;cursor:pointer;font-size:0.95rem;font-weight:bold;transition:all 0.2s}}
.toggle-btn:hover{{border-color:#00d4ff;color:#fff;background:#252540}}
.toggle-btn.active{{background:linear-gradient(135deg,#00d4ff,#0099cc);border-color:#00d4ff;color:#000;box-shadow:0 0 15px rgba(0,212,255,0.4)}}
.toggle-btn.active-warn{{background:linear-gradient(135deg,#ff4466,#cc2244);border-color:#ff4466;color:#fff;box-shadow:0 0 15px rgba(255,68,102,0.4)}}
.system{{background:#12121a;border-radius:16px;padding:25px;margin-bottom:30px;border:1px solid #2a2a3a}}
.sys-header{{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #333}}
.sys-title{{font-size:1.3rem;font-weight:bold}}
.sys-title.hub{{color:#00d4ff}}
.sys-title.m14{{color:#ff6b35}}
.sys-stats{{display:flex;gap:20px;font-size:0.95rem}}
.sys-stats span{{color:#aaa}}
.sys-stats strong{{margin-left:5px}}
.case-row{{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}}
.case-row.single{{grid-template-columns:1fr;max-width:600px;margin:0 auto 20px auto}}
.case-box{{background:#0a0a12;border-radius:12px;padding:20px;border:1px solid #333}}
.case-title{{font-size:1rem;font-weight:bold;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}}
.case-title.surge{{color:#00d4ff}}
.case-title.normal{{color:#888}}
.items{{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}}
.item{{background:#15151f;padding:12px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s}}
.item:hover{{background:#1a1a2a;transform:scale(1.02);box-shadow:0 0 10px rgba(0,212,255,0.3)}}
.item-label{{font-size:0.7rem;color:#666;margin-bottom:4px}}
.item-value{{font-size:1.3rem;font-weight:bold}}
.item-sub{{font-size:0.75rem;color:#888;margin-top:3px}}
.ok{{color:#00ff88}}.warn{{color:#ffcc00}}.bad{{color:#ff4466}}.gray{{color:#aaa}}
.stat-row{{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:15px}}
.stat-box{{background:#0a0a12;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;border:1px solid #333}}
.stat-box:hover{{background:#15151f;transform:scale(1.02);box-shadow:0 0 15px rgba(0,212,255,0.3)}}
.stat-label{{font-size:0.9rem;margin-bottom:8px;font-weight:bold}}
.stat-value{{font-size:2rem;font-weight:bold}}
.stat-sub{{font-size:0.75rem;color:#888;margin-top:5px}}
.total-summary{{display:flex;gap:15px;margin-bottom:15px;padding:15px;background:#0a0a12;border-radius:10px;border:1px solid #333}}
.total-ok,.total-ng{{flex:1;padding:12px 15px;border-radius:8px;font-size:0.95rem;text-align:center}}
.total-ok{{background:#1a3a1a;color:#00ff88;border:1px solid #00ff88}}
.total-ng{{background:#3a1a1a;color:#ff4466;border:1px solid #ff4466}}
.total-ok strong,.total-ng strong{{font-size:1.3rem;margin:0 5px}}
.total-ok span,.total-ng span{{opacity:0.8}}
.charts{{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}}
.charts.single{{grid-template-columns:1fr}}
.chart-box{{background:#0a0a12;border-radius:12px;padding:15px;border:1px solid #333}}
.chart-box.full{{max-width:500px;margin:0 auto}}
.chart-title{{font-size:0.85rem;color:#888;text-align:center;margin-bottom:10px}}
.chart-wrap{{height:200px;cursor:pointer}}
.chart-wrap.tall{{height:280px}}
.normal-section{{transition:opacity 0.3s ease}}
.normal-section.hidden{{display:none}}
.comment{{background:#1a2a1a;border:2px solid #00ff88;border-radius:10px;padding:15px;margin-top:15px}}
.comment.m14{{background:#2a1a1a;border-color:#ff6b35}}
.comment-title{{font-weight:bold;margin-bottom:6px;font-size:0.9rem}}
.comment-title.hub{{color:#00d4ff}}
.comment-title.m14{{color:#ff6b35}}
.comment-content{{color:#ccc;line-height:1.6;font-size:0.9rem}}
.footer{{text-align:center;color:#555;margin-top:40px;font-size:0.8rem}}
.modal{{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;justify-content:center;align-items:center}}
.modal.show{{display:flex}}
.modal-content{{background:#12121a;border-radius:16px;padding:25px;width:90%;max-width:1000px;max-height:85vh;overflow-y:auto;border:1px solid #333}}
.modal-header{{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #333}}
.modal-title{{font-size:1.2rem;font-weight:bold}}
.modal-close{{background:none;border:none;color:#888;font-size:1.5rem;cursor:pointer}}
.modal-close:hover{{color:#fff}}
.modal-chart{{height:400px;margin-bottom:20px}}
.modal-info{{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}}
.modal-stat{{background:#0a0a12;padding:12px;border-radius:8px;text-align:center}}
.modal-stat-label{{font-size:0.75rem;color:#666;margin-bottom:4px}}
.modal-stat-value{{font-size:1.1rem;font-weight:bold}}
.event-list{{max-height:60vh;overflow-y:auto;background:#0a0a12;border-radius:8px;padding:10px}}
.event-item{{display:grid;grid-template-columns:50px 1fr 1fr 80px 80px 80px 120px;gap:10px;padding:10px 15px;border-bottom:1px solid #222;cursor:pointer;transition:all 0.2s;font-size:0.85rem}}
.event-item:hover{{background:#1a1a2a}}
.event-item.header{{background:#15151f;font-weight:bold;color:#888;cursor:default}}
.event-item.header:hover{{background:#15151f}}
.event-num{{color:#00d4ff}}
.event-time{{color:#aaa}}
.event-current{{color:#00ff88;text-align:right}}
.event-actual{{color:#00d4ff;text-align:right}}
.event-pred{{color:#ff6b35;text-align:right}}
.event-cls{{text-align:center;padding:2px 8px;border-radius:4px;font-size:0.75rem}}
.event-cls.detect{{background:#1a3a1a;color:#00ff88}}
.event-cls.miss{{background:#3a1a1a;color:#ff4466}}
.event-cls.normal{{background:#1a1a2a;color:#888}}
.event-cls.false{{background:#3a1a2a;color:#ff4466}}
.back-btn{{background:#333;color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;margin-right:10px}}
.back-btn:hover{{background:#444}}
.mode-desc{{text-align:center;color:#666;font-size:0.8rem;margin-top:8px}}
.help-box{{position:fixed;right:15px;top:50%;transform:translateY(-50%);width:220px;background:#1a1a2a;border:2px solid #00d4ff;border-radius:12px;padding:12px;z-index:100;box-shadow:0 0 20px rgba(0,212,255,0.3);max-height:85vh;overflow-y:auto}}
.help-box h3{{font-size:0.8rem;color:#00d4ff;margin-bottom:10px;text-align:center;border-bottom:1px solid #333;padding-bottom:6px}}
.help-box .close-btn{{position:absolute;top:8px;right:10px;background:none;border:none;color:#666;font-size:1rem;cursor:pointer}}
.help-box .close-btn:hover{{color:#fff}}
.help-item{{margin-bottom:6px;font-size:0.7rem;line-height:1.3}}
.help-item:last-child{{margin-bottom:0}}
.help-label{{font-weight:bold;margin-bottom:2px}}
.help-label.ok{{color:#00ff88}}
.help-label.bad{{color:#ff4466}}
.help-label.gray{{color:#aaa}}
.help-desc{{color:#888}}
.help-toggle{{position:fixed;right:15px;top:50%;transform:translateY(-50%);width:36px;height:36px;background:#00d4ff;border:none;border-radius:50%;cursor:pointer;font-size:1.2rem;z-index:101;display:none}}
.help-box.hidden{{display:none}}
.help-box.hidden+.help-toggle{{display:block}}
@media(max-width:800px){{.stat-row{{grid-template-columns:repeat(2,1fr)}}.sys-header{{flex-direction:column;gap:10px}}.sys-stats{{flex-wrap:wrap}}.modal-info{{grid-template-columns:1fr}}.help-box{{display:none}}.help-toggle{{display:block}}}}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ“Š MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸ V8.2 (ì•ŒëŒê¸°ë°˜)</h1>
<p class="sub">ğŸ“… ë¶„ì„ ë‚ ì§œ: {anal_date} | ìƒì„±: {now}</p>
'''
        
        if self.hub_stats and self.hub_stats['total_rows'] > 0:
            s = self.hub_stats
            t = s['total_rows']
            surge = s['surge_total'] or 1
            normal_case = t - surge if t - surge > 0 else 1
            
            # ì•ŒëŒíŒŒì¼ ìœ ë¬´ ì²´í¬
            hub_has_alarm = self.hub_alarm_df is not None and len(self.hub_alarm_df) > 0
            alarm_total = s.get('alarm_total', 0) or 1
            surge_base = s.get('surge_base', 1) or 1  # ì´ìƒíƒì§€ + ë¯¸íƒ
            
            if hub_has_alarm:
                mode_text = "ì•ŒëŒê¸°ë°˜"
                mode_color = "#00ff88"
                stats_html = f'<span>ë¶„ì„ëŒ€ìƒ <strong>{t}</strong>ê°œ</span><span style="color:{mode_color};font-weight:bold">ğŸ“¡ {mode_text}</span>'
            else:
                mode_text = "ì˜ˆì¸¡ê¸°ë°˜"
                mode_color = "#ffcc00"
                stats_html = f'<span>ë¶„ì„ëŒ€ìƒ <strong>{t}</strong>ê°œ</span><span style="color:{mode_color};font-weight:bold">ğŸ“Š {mode_text}</span>'
            
            # í¼ì„¼íŠ¸ ê³„ì‚° (ì•ŒëŒ/ì˜ˆì¸¡ ê¸°ë°˜ ë™ì¼)
            detect_rate = s['detect']/surge_base*100
            miss_rate = s['miss']/surge_base*100
            ohtam_rate = s['false']/alarm_total*100
            
            cmt_html = ""
            if hub_cmt:
                cmt_html = f'<div class="comment"><div class="comment-title hub">ğŸ“ ì½”ë©˜íŠ¸</div><div class="comment-content">{hub_cmt.replace(chr(10),"<br>")}</div></div>'
            
            html += f'''
<div class="system" id="hubSystem">
<div class="sys-header">
<div class="sys-title hub">ğŸ  HUBROOM (ê¸°ì¤€: 350)</div>
<div class="sys-stats">
{stats_html}
</div>
</div>
<div class="stat-row">
<div class="stat-box" onclick="showList('hub','ì´ìƒíƒì§€',350)"><div class="stat-label ok">ì´ìƒíƒì§€</div><div class="stat-value ok">{s['detect']}</div><div class="stat-sub">íƒì§€ìœ¨ {detect_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('hub','ì˜¤íƒ',350)"><div class="stat-label bad">ì˜¤íƒ</div><div class="stat-value bad">{s['false']}</div><div class="stat-sub">ì˜¤íƒìœ¨ {ohtam_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('hub','ë¯¸íƒ',350)"><div class="stat-label bad">ë¯¸íƒ</div><div class="stat-value bad">{s['miss']}</div><div class="stat-sub">ë¯¸íƒìœ¨ {miss_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('hub','ì •ìƒ',350)"><div class="stat-label gray">ì •ìƒ</div><div class="stat-value gray">{s['normal']}</div><div class="stat-sub">&nbsp;</div></div>
</div>
{cmt_html}
</div>
'''
        
        if self.m14_stats and self.m14_stats['total_rows'] > 0:
            s = self.m14_stats
            t = s['total_rows']
            surge = s['surge_total'] or 1
            normal_case = t - surge if t - surge > 0 else 1
            
            # ì•ŒëŒíŒŒì¼ ìœ ë¬´ ì²´í¬
            m14_has_alarm = self.m14_alarm_df is not None and len(self.m14_alarm_df) > 0
            alarm_total = s.get('alarm_total', 0) or 1
            surge_base = s.get('surge_base', 1) or 1  # ì´ìƒíƒì§€ + ë¯¸íƒ
            
            if m14_has_alarm:
                mode_text = "ì•ŒëŒê¸°ë°˜"
                mode_color = "#00ff88"
                stats_html = f'<span>ë¶„ì„ëŒ€ìƒ <strong>{t}</strong>ê°œ</span><span style="color:{mode_color};font-weight:bold">ğŸ“¡ {mode_text}</span>'
            else:
                mode_text = "ì˜ˆì¸¡ê¸°ë°˜"
                mode_color = "#ffcc00"
                stats_html = f'<span>ë¶„ì„ëŒ€ìƒ <strong>{t}</strong>ê°œ</span><span style="color:{mode_color};font-weight:bold">ğŸ“Š {mode_text}</span>'
            
            # í¼ì„¼íŠ¸ ê³„ì‚° (ì•ŒëŒ/ì˜ˆì¸¡ ê¸°ë°˜ ë™ì¼)
            detect_rate = s['detect']/surge_base*100
            miss_rate = s['miss']/surge_base*100
            ohtam_rate = s['false']/alarm_total*100
            
            cmt_html = ""
            if m14_cmt:
                cmt_html = f'<div class="comment m14"><div class="comment-title m14">ğŸ“ ì½”ë©˜íŠ¸</div><div class="comment-content">{m14_cmt.replace(chr(10),"<br>")}</div></div>'
            
            html += f'''
<div class="system" id="m14System">
<div class="sys-header">
<div class="sys-title m14">ğŸ­ M14_Q (ê¸°ì¤€: 1700)</div>
<div class="sys-stats">
{stats_html}
</div>
</div>
<div class="stat-row">
<div class="stat-box" onclick="showList('m14','ì´ìƒíƒì§€',1700)"><div class="stat-label ok">ì´ìƒíƒì§€</div><div class="stat-value ok">{s['detect']}</div><div class="stat-sub">íƒì§€ìœ¨ {detect_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('m14','ì˜¤íƒ',1700)"><div class="stat-label bad">ì˜¤íƒ</div><div class="stat-value bad">{s['false']}</div><div class="stat-sub">ì˜¤íƒìœ¨ {ohtam_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('m14','ë¯¸íƒ',1700)"><div class="stat-label bad">ë¯¸íƒ</div><div class="stat-value bad">{s['miss']}</div><div class="stat-sub">ë¯¸íƒìœ¨ {miss_rate:.1f}%</div></div>
<div class="stat-box" onclick="showList('m14','ì •ìƒ',1700)"><div class="stat-label gray">ì •ìƒ</div><div class="stat-value gray">{s['normal']}</div><div class="stat-sub">&nbsp;</div></div>
</div>
{cmt_html}
</div>
'''
        
        html += f'''
<div class="help-box" id="helpBox">
<button class="close-btn" onclick="this.parentElement.classList.add('hidden')">&times;</button>
<h3>ğŸ“– ë¶„ë¥˜ ìš©ì–´ ì„¤ëª…</h3>
<div class="help-item"><div class="help-label ok">âœ… ì´ìƒíƒì§€</div><div class="help-desc">ì‹¤ì œ ì´ˆê³¼ + ì•ŒëŒ ë°œìƒ (ìµœì´ˆ)</div></div>
<div class="help-item"><div class="help-label bad">âŒ ì˜¤íƒ</div><div class="help-desc">ì‹¤ì œ ë¯¸ë§Œ + ì•ŒëŒ ë°œìƒ (ìµœì´ˆ, ì •ìƒì¸ë° ì•ŒëŒ)</div></div>
<div class="help-item"><div class="help-label bad">âŒ ë¯¸íƒ</div><div class="help-desc">ì‹¤ì œ ì´ˆê³¼ + ì•ŒëŒë¯¸ë°œìƒ (ìµœì´ˆ, ê¸‰ì¦ì¸ë° ëª»ì¡ìŒ)</div></div>
<div class="help-item"><div class="help-label gray">âœ… ì •ìƒ</div><div class="help-desc">ì‹¤ì œ ë¯¸ë§Œ + ì•ŒëŒ/ì•ŒëŒë¯¸ë°œìƒ ì—†ìŒ</div></div>
<hr style="border-color:#333;margin:12px 0">
<h3 style="margin-bottom:8px">ğŸ• ì¿¨ë‹¤ìš´ ë¶„ë¥˜ (60ë¶„ ì´ë‚´, í†µê³„ ì œì™¸)</h3>
<div class="help-item"><div class="help-label" style="color:#888">ì´ìƒíƒì§€(ì¿¨ë‹¤ìš´)</div><div class="help-desc">60ë¶„ë‚´ ì•ŒëŒ ìˆì—ˆìŒ</div></div>
<div class="help-item"><div class="help-label" style="color:#888">ì˜¤íƒ(ì¿¨ë‹¤ìš´)</div><div class="help-desc">60ë¶„ë‚´ ì•ŒëŒ ìˆì—ˆìŒ</div></div>
<div class="help-item"><div class="help-label" style="color:#888">ë¯¸íƒ(ì¿¨ë‹¤ìš´)</div><div class="help-desc">60ë¶„ë‚´ ì•ŒëŒë¯¸ë°œìƒ ìˆì—ˆìŒ</div></div>
<hr style="border-color:#333;margin:12px 0">
<h3 style="margin-bottom:8px">ğŸ“Š í¼ì„¼íŠ¸ ê¸°ì¤€ (ì¿¨ë‹¤ìš´ ì œì™¸)</h3>
<div class="help-item"><div class="help-label">íƒì§€ìœ¨</div><div class="help-desc">ì´ìƒíƒì§€ / (ì´ìƒíƒì§€ + ë¯¸íƒ)</div></div>
<div class="help-item"><div class="help-label">ì˜¤íƒìœ¨</div><div class="help-desc">ì˜¤íƒ / (ì´ìƒíƒì§€ + ì˜¤íƒ)</div></div>
<div class="help-item"><div class="help-label">ë¯¸íƒìœ¨</div><div class="help-desc">ë¯¸íƒ / (ì´ìƒíƒì§€ + ë¯¸íƒ)</div></div>
</div>
<button class="help-toggle" onclick="document.getElementById('helpBox').classList.remove('hidden')">â“</button>
<div class="footer">MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8.2 (ì•ŒëŒê¸°ë°˜) | AMHS ë¬¼ë¥˜ ì˜ˆì¸¡ ëª¨ë¸</div>
</div>
<script>
const hubStats = {hub_stats_json};
const m14Stats = {m14_stats_json};
'''
        
        html += f'''
const hubData = {hub_json};
const m14Data = {m14_json};
let modalChart = null;
let currentSystem = '';
let currentThreshold = 350;
let currentFiltered = [];

function showList(system, cls, threshold) {{
    const data = system === 'hub' ? hubData : m14Data;
    const sysName = system === 'hub' ? 'HUBROOM' : 'M14_Q';
    currentSystem = system;
    currentThreshold = threshold;
    
    let filtered = [];
    if (cls === 'ì´ìƒíƒì§€') {{
        filtered = data.filter(d => d.cls.includes('ì´ìƒ') && !d.cls.includes('ì¿¨ë‹¤ìš´'));
    }} else if (cls === 'ë¯¸íƒ') {{
        filtered = data.filter(d => d.cls.includes('ë¯¸íƒ') && !d.cls.includes('ì¿¨ë‹¤ìš´'));
    }} else if (cls === 'ì •ìƒ') {{
        filtered = data.filter(d => d.cls.includes('ì •ìƒ') && !d.cls.includes('ì´ìƒ'));
    }} else if (cls === 'ì˜¤íƒ') {{
        filtered = data.filter(d => d.cls === 'ì˜¤íƒ');
    }} else {{
        filtered = data.filter(d => d.cls.includes(cls));
    }}
    
    if (filtered.length === 0) {{
        alert('í•´ë‹¹ ë¶„ë¥˜ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }}
    
    currentFiltered = filtered;
    document.getElementById('listTitle').textContent = `${{sysName}} - ${{cls}} (${{filtered.length}}ê°œ)`;
    
    let html = '<div class="event-item header"><div>No.</div><div>í˜„ì¬ì‹œê°„</div><div>ì˜ˆì¸¡ì‹œì </div><div>í˜„ì¬ê°’</div><div>ì‹¤ì œê°’</div><div>ì˜ˆì¸¡ê°’</div><div>ë¶„ë¥˜</div></div>';
    
    filtered.forEach((d, i) => {{
        let clsClass = 'normal';
        if (d.cls.includes('ì´ìƒ')) clsClass = 'detect';
        else if (d.cls.includes('ë¯¸íƒ')) clsClass = 'miss';
        else if (d.cls === 'ì˜¤íƒ') clsClass = 'false';
        
        const timeShort = d.time.split(' ')[1] || d.time;
        const predTimeShort = d.pred_time.split(' ')[1] || d.pred_time;
        
        html += `<div class="event-item" onclick="showGraph(${{i}})">
            <div class="event-num">${{i+1}}</div>
            <div class="event-time">${{timeShort}}</div>
            <div class="event-time">${{predTimeShort}}</div>
            <div class="event-current">${{d.current.toFixed(0)}}</div>
            <div class="event-actual">${{d.actual.toFixed(0)}}</div>
            <div class="event-pred">${{d.pred.toFixed(1)}}</div>
            <div class="event-cls ${{clsClass}}">${{d.cls.substring(0,12)}}</div>
        </div>`;
    }});
    
    document.getElementById('eventListContainer').innerHTML = html;
    document.getElementById('listModal').classList.add('show');
}}

function showGraph(filteredIdx) {{
    const item = currentFiltered[filteredIdx];
    const data = currentSystem === 'hub' ? hubData : m14Data;
    const sysName = currentSystem === 'hub' ? 'HUBROOM' : 'M14_Q';
    const centerIdx = item.idx;
    
    const startIdx = Math.max(0, centerIdx - 30);
    const endIdx = Math.min(data.length, centerIdx + 31);
    const rangeData = data.slice(startIdx, endIdx);
    const centerPos = centerIdx - startIdx;
    
    // ì•ŒëŒ/ì¿¨ë‹¤ìš´/ë¯¸ë°œìƒ ê°œìˆ˜ ì„¸ê¸°
    const alarmCount = rangeData.filter(d => d.alarm && d.alarm.length > 0).length;
    const cooldownCount = rangeData.filter(d => d.cooldown && d.cooldown.length > 0).length;
    const missCount = rangeData.filter(d => d.alarm_miss && d.alarm_miss.length > 0).length;
    let statusText = '';
    if (alarmCount > 0) statusText += ` | ğŸ”´ì•ŒëŒ ${{alarmCount}}`;
    if (cooldownCount > 0) statusText += ` | ğŸ”µì¿¨ë‹¤ìš´ ${{cooldownCount}}`;
    if (missCount > 0) statusText += ` | ğŸŸ£ë¯¸ë°œìƒ ${{missCount}}`;
    
    document.getElementById('chartTitle').innerHTML = `<button class="back-btn" onclick="backToList()">â† ëª©ë¡</button>${{sysName}} - ${{item.cls}}`;
    const t1 = (item.time.split(' ')[1] || item.time).substring(0,5);
    const t2 = (item.pred_time.split(' ')[1] || item.pred_time).substring(0,5);
    document.getElementById('chartInfo').textContent = `${{t1}}(í˜„ì¬)->${{t2}}(ì˜ˆì¸¡) | í˜„ì¬ê°’: ${{item.current.toFixed(0)}} | ì‹¤ì œê°’: ${{item.actual.toFixed(0)}} | ì˜ˆì¸¡ê°’: ${{item.pred.toFixed(1)}}${{statusText}}`;
    
    document.getElementById('listModal').classList.remove('show');
    document.getElementById('chartModal').classList.add('show');
    
    const ctx = document.getElementById('modalLineChart').getContext('2d');
    if (modalChart) modalChart.destroy();
    
    // ì•ŒëŒ/ì¿¨ë‹¤ìš´/ë¯¸ë°œìƒ í¬ì¸íŠ¸ ìƒ‰ìƒ (ì˜ˆì¸¡ê°’ì— ì ìš©!)
    const predPointColors = rangeData.map((d, i) => {{
        if (i === centerPos) return '#ffcc00';  // í˜„ì¬ ì„ íƒ í¬ì¸íŠ¸: ë…¸ë€ìƒ‰
        if (d.alarm && d.alarm.length > 0) return '#ff4466';  // ì•ŒëŒ: ë¹¨ê°„ìƒ‰
        if (d.cooldown && d.cooldown.length > 0) return '#4488ff';  // ì¿¨ë‹¤ìš´: íŒŒë€ìƒ‰
        if (d.alarm_miss && d.alarm_miss.length > 0) return '#aa44ff';  // ë¯¸ë°œìƒ: ë³´ë¼ìƒ‰
        return '#ff6b35';  // ê¸°ë³¸ ì£¼í™©ìƒ‰
    }});
    const predPointSizes = rangeData.map((d, i) => {{
        if (i === centerPos) return 12;  // í˜„ì¬ ì„ íƒ í¬ì¸íŠ¸: í¬ê²Œ
        if (d.alarm && d.alarm.length > 0) return 8;  // ì•ŒëŒ
        if (d.cooldown && d.cooldown.length > 0) return 5;  // ì¿¨ë‹¤ìš´: ì‘ê²Œ
        if (d.alarm_miss && d.alarm_miss.length > 0) return 8;  // ë¯¸ë°œìƒ
        return 4;
    }});
    
    const labelsShort = rangeData.map(d => (d.pred_time.split(' ')[1] || d.pred_time).substring(0,5) + '(ì˜ˆì¸¡)');
    const labelsFull = rangeData.map(d => {{
        const t1 = (d.time.split(' ')[1] || d.time).substring(0,5);
        const t2 = (d.pred_time.split(' ')[1] || d.pred_time).substring(0,5);
        return t1 + '(í˜„ì¬)->' + t2 + '(ì˜ˆì¸¡)';
    }});
    
    modalChart = new Chart(ctx, {{
        type: 'line',
        data: {{
            labels: labelsShort,
            datasets: [
                {{
                    label: 'í˜„ì¬ê°’ (í˜„ì¬ì‹œê°„)',
                    data: rangeData.map(d => d.current),
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0,255,136,0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 3,
                    borderWidth: 2,
                    hidden: true
                }},
                {{
                    label: 'ì‹¤ì œê°’ (ì˜ˆì¸¡ì‹œì )',
                    data: rangeData.map(d => d.actual),
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0,212,255,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4
                }},
                {{
                    label: 'ì˜ˆì¸¡ê°’ (ì˜ˆì¸¡ì‹œì )',
                    data: rangeData.map(d => d.pred),
                    borderColor: '#ff6b35',
                    backgroundColor: 'rgba(255,107,53,0.1)',
                    fill: false,
                    tension: 0.3,
                    pointBackgroundColor: predPointColors,
                    pointRadius: predPointSizes,
                    pointBorderColor: predPointColors
                }},
                {{
                    label: 'ë¦¬ë¯¸íŠ¸ê°’ (' + currentThreshold + ')',
                    data: rangeData.map(() => currentThreshold),
                    borderColor: '#ff4466',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    pointHitRadius: 0,
                    tension: 0,
                    order: 999
                }}
            ]
        }},
        options: {{
            responsive: true,
            maintainAspectRatio: false,
            events: ['click'],
            interaction: {{mode: 'nearest', intersect: true}},
            plugins: {{
                legend: {{ 
                    position: 'top', 
                    labels: {{ color: '#fff' }},
                    onClick: function(e, legendItem, legend) {{
                        const index = legendItem.datasetIndex;
                        const ci = legend.chart;
                        const meta = ci.getDatasetMeta(index);
                        meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                        if (index === 0) {{
                            ci.data.labels = meta.hidden ? labelsShort : labelsFull;
                        }}
                        ci.update();
                    }}
                }},
                datalabels: {{ display: false }},
                tooltip: {{
                    enabled: true,
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#444',
                    borderWidth: 1,
                    padding: 8,
                    displayColors: true,
                    titleFont: {{ size: 11 }},
                    bodyFont: {{ size: 10 }},
                    filter: function(tooltipItem) {{
                        return tooltipItem.datasetIndex !== 3;
                    }},
                    callbacks: {{
                        title: function(context) {{ return context[0].label; }},
                        label: function(context) {{
                            const idx = context.dataIndex;
                            const d = rangeData[idx];
                            if (context.datasetIndex === 0) return 'ğŸŸ¢ í˜„ì¬ê°’: ' + d.current.toFixed(0);
                            else if (context.datasetIndex === 1) return 'ğŸ”µ ì‹¤ì œê°’: ' + d.actual.toFixed(0);
                            else if (context.datasetIndex === 2) return 'ğŸŸ  ì˜ˆì¸¡ê°’: ' + d.pred.toFixed(1);
                            else return null;
                        }},
                        afterBody: function(context) {{
                            const idx = context[0].dataIndex;
                            const d = rangeData[idx];
                            const diff = d.pred - d.actual;
                            const timeStr = (d.pred_time.split(' ')[1] || d.pred_time).substring(0,8);
                            let result = [];
                            
                            // ì•ŒëŒ ìƒíƒœ í‘œì‹œ
                            if (d.alarm && d.alarm.length > 0) {{
                                result.push('ğŸ”´ ì•ŒëŒë°œìƒ [' + timeStr + ']');
                            }} else if (d.cooldown && d.cooldown.length > 0) {{
                                result.push('ğŸ”µ ì•ŒëŒì¿¨ë‹¤ìš´(' + d.cooldown + ')');
                            }} else if (d.alarm_miss && d.alarm_miss.length > 0) {{
                                result.push('ğŸŸ£ ì•ŒëŒë¯¸ë°œìƒ (' + d.alarm_miss + ')');
                            }} else if (d.alarm_miss_cd && d.alarm_miss_cd.length > 0) {{
                                result.push('ğŸŸ£ ì•ŒëŒë¯¸ë°œìƒì¿¨ë‹¤ìš´(' + d.alarm_miss_cd + ')');
                            }}
                            
                            result.push('');
                            result.push('ì˜ˆì¸¡ ì˜¤ì°¨: ' + (diff >= 0 ? '+' : '') + diff.toFixed(1));
                            return result;
                        }}
                    }}
                }}
            }},
            scales: {{
                x: {{ ticks: {{ color: '#888', maxRotation: 60, font: {{ size: 8 }} }}, grid: {{ color: '#333' }} }},
                y: {{ ticks: {{ color: '#888' }}, grid: {{ color: '#333' }} }}
            }}
        }}
    }});
    
    const actuals = rangeData.map(d => d.actual);
    const preds = rangeData.map(d => d.pred);
    document.getElementById('statCount').textContent = rangeData.length + 'ë¶„';
    document.getElementById('statCurrent').textContent = item.current.toFixed(0);
    document.getElementById('statActualAvg').textContent = (actuals.reduce((a,b)=>a+b,0)/actuals.length).toFixed(1);
    document.getElementById('statPredAvg').textContent = (preds.reduce((a,b)=>a+b,0)/preds.length).toFixed(1);
    document.getElementById('statActualMax').textContent = Math.max(...actuals).toFixed(1);
}}

function backToList() {{
    document.getElementById('chartModal').classList.remove('show');
    document.getElementById('listModal').classList.add('show');
    if (modalChart) {{ modalChart.destroy(); modalChart = null; }}
}}

function closeListModal() {{ document.getElementById('listModal').classList.remove('show'); }}
function closeChartModal() {{
    document.getElementById('chartModal').classList.remove('show');
    if (modalChart) {{ modalChart.destroy(); modalChart = null; }}
}}

document.getElementById('listModal').addEventListener('click', function(e) {{ if (e.target === this) closeListModal(); }});
document.getElementById('chartModal').addEventListener('click', function(e) {{ if (e.target === this) closeChartModal(); }});
</script>

<div id="listModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div id="listTitle" class="modal-title">ì´ë²¤íŠ¸ ëª©ë¡</div>
<button class="modal-close" onclick="closeListModal()">&times;</button>
</div>
<div id="eventListContainer" class="event-list"></div>
</div>
</div>

<div id="chartModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div id="chartTitle" class="modal-title">ê·¸ë˜í”„</div>
<button class="modal-close" onclick="closeChartModal()">&times;</button>
</div>
<div id="chartInfo" style="text-align:center;color:#888;margin-bottom:15px;font-size:0.9rem"></div>
<div class="modal-chart"><canvas id="modalLineChart"></canvas></div>
<div class="modal-info">
<div class="modal-stat"><div class="modal-stat-label">ë²”ìœ„</div><div id="statCount" class="modal-stat-value ok">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">í˜„ì¬ê°’</div><div id="statCurrent" class="modal-stat-value" style="color:#00ff88">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì‹¤ì œê°’ í‰ê· </div><div id="statActualAvg" class="modal-stat-value" style="color:#00d4ff">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì˜ˆì¸¡ê°’ í‰ê· </div><div id="statPredAvg" class="modal-stat-value" style="color:#ff6b35">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì‹¤ì œê°’ ìµœëŒ€</div><div id="statActualMax" class="modal-stat-value bad">0</div></div>
</div>
</div>
</div>
</body></html>'''
        return html


if __name__ == "__main__":
    root = tk.Tk()
    app = SurgeAnalyzer(root)
    root.mainloop()