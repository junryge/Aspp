import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import pandas as pd
from datetime import datetime
import webbrowser
import os

class SurgeAnalyzer:
    def __init__(self, root):
        self.root = root
        self.root.title("MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V9")
        self.root.geometry("1200x900")
        self.root.configure(bg='#1a1a2e')
        
        self.hub_file = None
        self.m14_file = None
        self.hub_df = None
        self.m14_df = None
        self.hub_stats = None
        self.m14_stats = None
        
        self.setup_ui()
    
    def setup_ui(self):
        main_frame = tk.Frame(self.root, bg='#1a1a2e')
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)
        
        top_frame = tk.Frame(main_frame, bg='#1a1a2e')
        top_frame.pack(fill=tk.X)
        
        # íƒ€ì´í‹€
        tk.Label(top_frame, text="ğŸ“Š MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V9", font=('ë§‘ì€ ê³ ë”•', 20, 'bold'),
                 bg='#1a1a2e', fg='#00d4ff').pack(pady=(0, 3))
        tk.Label(top_frame, text="ì´ìƒíƒì§€ / ê¸‰ì¦ì‚¬ì „ê°ì§€ / ì •ìƒì˜ˆì¸¡ / ë¯¸íƒ / ì •ìƒì‚¬ì „ê°ì§€ / ì˜¤íƒ / ì •ìƒ", font=('ë§‘ì€ ê³ ë”•', 10),
                 bg='#1a1a2e', fg='#888888').pack(pady=(0, 10))
        
        # ë¶„ì„ ë‚ ì§œ
        date_frame = tk.Frame(top_frame, bg='#252540', relief='ridge', bd=2)
        date_frame.pack(fill=tk.X, pady=5, ipady=5, ipadx=10)
        
        tk.Label(date_frame, text="ğŸ“… ë¶„ì„ ë‚ ì§œ", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'),
                 bg='#252540', fg='#00ff88').pack(side=tk.LEFT, padx=(10,15), pady=5)
        
        today = datetime.now()
        self.year_var = tk.StringVar(value=str(today.year))
        self.month_var = tk.StringVar(value=str(today.month))
        self.day_var = tk.StringVar(value=str(today.day))
        
        tk.Entry(date_frame, textvariable=self.year_var, font=('ë§‘ì€ ê³ ë”•', 10), width=5,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ë…„", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        tk.Entry(date_frame, textvariable=self.month_var, font=('ë§‘ì€ ê³ ë”•', 10), width=3,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ì›”", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        tk.Entry(date_frame, textvariable=self.day_var, font=('ë§‘ì€ ê³ ë”•', 10), width=3,
                 bg='#0d0d15', fg='white', insertbackground='white', justify='center').pack(side=tk.LEFT)
        tk.Label(date_frame, text="ì¼", font=('ë§‘ì€ ê³ ë”•', 10), bg='#252540', fg='white').pack(side=tk.LEFT, padx=(2,8))
        
        # íŒŒì¼ ì„ íƒ
        file_frame = tk.Frame(top_frame, bg='#1a1a2e')
        file_frame.pack(fill=tk.X, pady=5)
        
        # HUBROOM
        hub_frame = tk.Frame(file_frame, bg='#252540', relief='ridge', bd=2)
        hub_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0,5), ipady=5, ipadx=10)
        
        tk.Label(hub_frame, text="ğŸ  HUBROOM (350)", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), 
                 bg='#252540', fg='#00d4ff').pack(anchor='w', padx=10, pady=(5,2))
        
        hub_btn_frame = tk.Frame(hub_frame, bg='#252540')
        hub_btn_frame.pack(fill=tk.X, padx=10, pady=3)
        tk.Button(hub_btn_frame, text="ğŸ“ íŒŒì¼", command=self.select_hub_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#00d4ff', fg='black', width=8).pack(side=tk.LEFT)
        self.hub_label = tk.Label(hub_btn_frame, text="ì„ íƒ ì•ˆë¨", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#888')
        self.hub_label.pack(side=tk.LEFT, padx=5)
        
        self.hub_comment = tk.Text(hub_frame, font=('ë§‘ì€ ê³ ë”•', 9), bg='#0d0d15', fg='white', 
                                    height=2, relief='flat', padx=5, pady=3, insertbackground='white')
        self.hub_comment.pack(fill=tk.X, padx=10, pady=(0,5))
        
        # M14_Q
        m14_frame = tk.Frame(file_frame, bg='#252540', relief='ridge', bd=2)
        m14_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(5,0), ipady=5, ipadx=10)
        
        tk.Label(m14_frame, text="ğŸ­ M14_Q (1700)", font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), 
                 bg='#252540', fg='#ff6b35').pack(anchor='w', padx=10, pady=(5,2))
        
        m14_btn_frame = tk.Frame(m14_frame, bg='#252540')
        m14_btn_frame.pack(fill=tk.X, padx=10, pady=3)
        tk.Button(m14_btn_frame, text="ğŸ“ íŒŒì¼", command=self.select_m14_file,
                  font=('ë§‘ì€ ê³ ë”•', 9), bg='#ff6b35', fg='black', width=8).pack(side=tk.LEFT)
        self.m14_label = tk.Label(m14_btn_frame, text="ì„ íƒ ì•ˆë¨", font=('ë§‘ì€ ê³ ë”•', 8), bg='#252540', fg='#888')
        self.m14_label.pack(side=tk.LEFT, padx=5)
        
        self.m14_comment = tk.Text(m14_frame, font=('ë§‘ì€ ê³ ë”•', 9), bg='#0d0d15', fg='white', 
                                    height=2, relief='flat', padx=5, pady=3, insertbackground='white')
        self.m14_comment.pack(fill=tk.X, padx=10, pady=(0,5))
        
        # ë¶„ì„ ë²„íŠ¼
        tk.Button(top_frame, text="ğŸ” ë¶„ì„ ì‹œì‘ ë° ì €ì¥", command=self.run_analysis,
                  font=('ë§‘ì€ ê³ ë”•', 12, 'bold'), bg='#00ff88', fg='black',
                  width=20, height=1).pack(pady=10)
        
        # íƒ­
        self.notebook = ttk.Notebook(main_frame)
        self.notebook.pack(fill=tk.BOTH, expand=True, pady=(5,0))
        
        style = ttk.Style()
        style.configure('TNotebook', background='#1a1a2e')
        style.configure('TNotebook.Tab', font=('ë§‘ì€ ê³ ë”•', 10, 'bold'), padding=[10, 5])
        
        result_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(result_frame, text='ğŸ“‹ ë¶„ì„ ê²°ê³¼')
        
        self.result_text = tk.Text(result_frame, font=('Consolas', 10), bg='#0d0d15', fg='white', 
                                    relief='flat', padx=15, pady=15)
        self.result_text.pack(fill=tk.BOTH, expand=True)
        self.result_text.insert(tk.END, "CSV íŒŒì¼ì„ ì„ íƒí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”...")
        
        self.hub_data_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(self.hub_data_frame, text='ğŸ  HUBROOM ë°ì´í„°')
        
        self.m14_data_frame = tk.Frame(self.notebook, bg='#0d0d15')
        self.notebook.add(self.m14_data_frame, text='ğŸ­ M14_Q ë°ì´í„°')
    
    def create_data_view(self, parent, df):
        for widget in parent.winfo_children():
            widget.destroy()
        
        if df is None or len(df) == 0:
            tk.Label(parent, text="ë°ì´í„° ì—†ìŒ", font=('ë§‘ì€ ê³ ë”•', 12), bg='#0d0d15', fg='#888').pack(pady=50)
            return
        
        tree_frame = tk.Frame(parent, bg='#0d0d15')
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        y_scroll = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL)
        y_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        x_scroll = ttk.Scrollbar(tree_frame, orient=tk.HORIZONTAL)
        x_scroll.pack(side=tk.BOTTOM, fill=tk.X)
        
        cols = list(df.columns)
        tree = ttk.Treeview(tree_frame, columns=cols, show='headings',
                            yscrollcommand=y_scroll.set, xscrollcommand=x_scroll.set)
        
        y_scroll.config(command=tree.yview)
        x_scroll.config(command=tree.xview)
        
        for col in cols:
            tree.heading(col, text=col)
            tree.column(col, width=100, minwidth=50)
        
        for idx, row in df.iterrows():
            values = [str(v) if pd.notna(v) else '' for v in row.values]
            tag = ''
            if 'ë¶„ë¥˜' in df.columns:
                ë¶„ë¥˜ = str(row.get('ë¶„ë¥˜', ''))
                if ë¶„ë¥˜ == 'ì´ìƒíƒì§€':
                    tag = 'detect'
                elif 'ê¸‰ì¦ì‚¬ì „ê°ì§€' in ë¶„ë¥˜:
                    tag = 'pre'
                elif 'ì •ìƒì˜ˆì¸¡' in ë¶„ë¥˜:
                    tag = 'normal_pred'
                elif ë¶„ë¥˜ == 'ë¯¸íƒ':
                    tag = 'miss'
                elif 'ê¸‰ì¦ì—°ì†' in ë¶„ë¥˜:
                    tag = 'surge_cont'
                elif 'ì •ìƒì‚¬ì „ê°ì§€' in ë¶„ë¥˜:
                    tag = 'pre_future'
                elif 'ì˜¤íƒ' in ë¶„ë¥˜:
                    tag = 'false'
            tree.insert('', tk.END, values=values, tags=(tag,))
        
        tree.tag_configure('detect', background='#1a3a1a')
        tree.tag_configure('pre', background='#2a3a1a')
        tree.tag_configure('normal_pred', background='#1a2a3a')
        tree.tag_configure('miss', background='#3a1a1a')
        tree.tag_configure('surge_cont', background='#2a2a1a')
        tree.tag_configure('pre_future', background='#2a2a3a')
        tree.tag_configure('false', background='#3a1a2a')
        
        tree.pack(fill=tk.BOTH, expand=True)
    
    def select_hub_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.hub_file = file
            self.hub_label.config(text=f"âœ… {os.path.basename(file)[:25]}", fg='#00ff88')
    
    def select_m14_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.m14_file = file
            self.m14_label.config(text=f"âœ… {os.path.basename(file)[:25]}", fg='#00ff88')
    
    def analyze_v9(self, df, threshold, pred_col, curr_col, actual_col):
        """
        V9 ë¶„ì„ ë¡œì§
        ê¸‰ì¦(ì‹¤ì œ>=threshold):
          - í˜„ì¬ ì˜ˆì¸¡>=threshold â†’ ì´ìƒíƒì§€
          - ê³¼ê±° 10ë¶„ë‚´ ì˜ˆì¸¡>=threshold â†’ ê¸‰ì¦ì‚¬ì „ê°ì§€
          - ë¯¸ë˜ 10ë¶„ë‚´ ì˜ˆì¸¡>=threshold â†’ ì •ìƒì˜ˆì¸¡
          - ë‹¤ ì•„ë‹ˆë©´ â†’ ë¯¸íƒ
        ì •ìƒ(ì‹¤ì œ<threshold):
          - ì˜ˆì¸¡>=threshold + 10ë¶„ë‚´ ê¸‰ì¦ â†’ ì •ìƒì‚¬ì „ê°ì§€
          - ì˜ˆì¸¡>=threshold + 10ë¶„ë‚´ ê¸‰ì¦ ì—†ìŒ â†’ ì˜¤íƒ
          - ì˜ˆì¸¡<threshold â†’ ì •ìƒ
        """
        df = df.copy()
        
        # ë¶ˆí•„ìš” ì»¬ëŸ¼ ì œê±°
        drop_cols = ['Unnamed: 22', 'Unnamed: 23', '12ë¶„ì „TOTALCNT', '12ë³€í™”ëŸ‰']
        for col in drop_cols:
            if col in df.columns:
                df = df.drop(columns=[col])
        
        df['ë¶„ë¥˜'] = ''
        
        for idx in range(len(df)):
            actual = df.loc[idx, actual_col]
            pred = df.loc[idx, pred_col]
            
            if actual >= threshold:
                # ê¸‰ì¦ ì¼€ì´ìŠ¤
                if pred >= threshold:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì´ìƒíƒì§€'
                else:
                    # 1) ê³¼ê±° 10ë¶„ë‚´ ì˜ˆì¸¡ >= threshold
                    found_past = False
                    for back in range(1, 11):
                        if idx - back >= 0 and df.loc[idx - back, pred_col] >= threshold:
                            df.loc[idx, 'ë¶„ë¥˜'] = f'ê¸‰ì¦ì‚¬ì „ê°ì§€({back}ë¶„ì „)'
                            found_past = True
                            break
                    
                    if not found_past:
                        # 2) ë¯¸ë˜ 10ë¶„ë‚´ ì˜ˆì¸¡ >= threshold
                        found_future = False
                        for fwd in range(1, 11):
                            if idx + fwd < len(df) and df.loc[idx + fwd, pred_col] >= threshold:
                                df.loc[idx, 'ë¶„ë¥˜'] = f'ì •ìƒì˜ˆì¸¡({fwd}ë¶„í›„)'
                                found_future = True
                                break
                        
                        if not found_future:
                            df.loc[idx, 'ë¶„ë¥˜'] = 'ë¯¸íƒ'
            else:
                # ì •ìƒ ì¼€ì´ìŠ¤ (ì‹¤ì œê°’ < threshold)
                if pred >= threshold:
                    # 1) 10ë¶„ ì „ì— ê¸‰ì¦ ìˆëŠ”ì§€ ì²´í¬ â†’ ê¸‰ì¦ì—°ì†
                    found_past = False
                    for back in range(1, 11):
                        if idx - back >= 0 and df.loc[idx - back, actual_col] >= threshold:
                            found_past = True
                            df.loc[idx, 'ë¶„ë¥˜'] = f'ê¸‰ì¦ì—°ì†({back}ë¶„ì „)'
                            break
                    
                    if not found_past:
                        # 2) 10ë¶„ í›„ì— ê¸‰ì¦ ìˆëŠ”ì§€ ì²´í¬ â†’ ì •ìƒì‚¬ì „ê°ì§€
                        found_future = False
                        for fwd in range(1, 11):
                            if idx + fwd < len(df) and df.loc[idx + fwd, actual_col] >= threshold:
                                found_future = True
                                df.loc[idx, 'ë¶„ë¥˜'] = f'ì •ìƒì‚¬ì „ê°ì§€({fwd}ë¶„í›„)'
                                break
                        
                        if not found_future:
                            # 3) ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì§„ì§œ ì˜¤íƒ
                            df.loc[idx, 'ë¶„ë¥˜'] = 'ì˜¤íƒ'
                else:
                    df.loc[idx, 'ë¶„ë¥˜'] = 'ì •ìƒ'
        
        # í†µê³„
        total = len(df)
        surge_total = len(df[df[actual_col] >= threshold])
        detect = len(df[df['ë¶„ë¥˜'] == 'ì´ìƒíƒì§€'])
        pre_past = len(df[df['ë¶„ë¥˜'].str.contains('ê¸‰ì¦ì‚¬ì „ê°ì§€', na=False)])  # ê¸‰ì¦ì¼€ì´ìŠ¤ ì‚¬ì „ê°ì§€
        pre_future = len(df[df['ë¶„ë¥˜'].str.contains('ì •ìƒì‚¬ì „ê°ì§€', na=False)])  # ì •ìƒì¼€ì´ìŠ¤ ì‚¬ì „ê°ì§€
        surge_cont = len(df[df['ë¶„ë¥˜'].str.contains('ê¸‰ì¦ì—°ì†', na=False)])  # ê¸‰ì¦ì—°ì†
        normal_pred = len(df[df['ë¶„ë¥˜'].str.contains('ì •ìƒì˜ˆì¸¡', na=False)])
        miss = len(df[df['ë¶„ë¥˜'] == 'ë¯¸íƒ'])
        false_alarm = len(df[df['ë¶„ë¥˜'] == 'ì˜¤íƒ'])
        normal = len(df[df['ë¶„ë¥˜'] == 'ì •ìƒ'])
        
        stats = {
            'total_rows': total,
            'surge_total': surge_total,
            'detect': detect,
            'pre_past': pre_past,        # ê¸‰ì¦ ì¼€ì´ìŠ¤ ì‚¬ì „ê°ì§€ (Në¶„ì „)
            'pre_future': pre_future,    # ì •ìƒ ì¼€ì´ìŠ¤ ì‚¬ì „ê°ì§€ (Në¶„í›„)
            'surge_cont': surge_cont,    # ê¸‰ì¦ì—°ì†
            'normal_pred': normal_pred,
            'miss': miss,
            'false': false_alarm,
            'normal': normal
        }
        
        # ì»¬ëŸ¼ ìˆœì„œ ì •ë¦¬
        cols = df.columns.tolist()
        if 'ë¶„ë¥˜' in cols:
            cols.remove('ë¶„ë¥˜')
            actual_idx = cols.index(actual_col)
            df = df[cols[:actual_idx+1] + ['ë¶„ë¥˜'] + cols[actual_idx+1:]]
        
        return df, stats
    
    def run_analysis(self):
        if not self.hub_file and not self.m14_file:
            messagebox.showwarning("ê²½ê³ ", "CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!")
            return
        
        hub_cmt = self.hub_comment.get("1.0", tk.END).strip()
        m14_cmt = self.m14_comment.get("1.0", tk.END).strip()
        
        try:
            anal_date = f"{self.year_var.get()}ë…„ {self.month_var.get()}ì›” {self.day_var.get()}ì¼"
        except:
            anal_date = datetime.now().strftime("%Yë…„ %mì›” %dì¼")
        
        result_text = ""
        
        try:
            if self.hub_file:
                df = pd.read_csv(self.hub_file, encoding='utf-8-sig')
                self.hub_df, self.hub_stats = self.analyze_v9(df.copy(), 350, 'ì˜ˆì¸¡ê°’_MAX', 'í˜„ì¬ê°’', 'ì‹¤ì œê°’')
                result_text += self.fmt("HUBROOM V9", self.hub_stats, 350)
                self.create_data_view(self.hub_data_frame, self.hub_df)
            
            if self.m14_file:
                df = pd.read_csv(self.m14_file, encoding='utf-8-sig')
                self.m14_df, self.m14_stats = self.analyze_v9(df.copy(), 1700, 'ìµœì¢…ì˜ˆì¸¡', 'í˜„ì¬TOTALCNT', 'ì‹¤ì œê°’')
                result_text += self.fmt("M14_Q V9", self.m14_stats, 1700)
                self.create_data_view(self.m14_data_frame, self.m14_df)
            
            self.result_text.config(state=tk.NORMAL)
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, result_text)
            self.result_text.config(state=tk.DISABLED)
            
            save_dir = filedialog.askdirectory(title="ê²°ê³¼ ì €ì¥í•  í´ë” ì„ íƒ")
            if save_dir:
                ts = datetime.now().strftime('%Y%m%d_%H%M%S')
                files = []
                
                if self.hub_df is not None:
                    f = os.path.join(save_dir, f"HUBROOM_V9_ê²°ê³¼_{ts}.csv")
                    self.hub_df.to_csv(f, index=False, encoding='utf-8-sig')
                    files.append(f)
                
                if self.m14_df is not None:
                    f = os.path.join(save_dir, f"M14_V9_ê²°ê³¼_{ts}.csv")
                    self.m14_df.to_csv(f, index=False, encoding='utf-8-sig')
                    files.append(f)
                
                html_f = os.path.join(save_dir, f"MLê¸‰ì¦ê°ì§€_V9_ë¦¬í¬íŠ¸_{ts}.html")
                with open(html_f, 'w', encoding='utf-8') as f:
                    f.write(self.gen_html(hub_cmt, m14_cmt, anal_date))
                files.append(html_f)
                
                webbrowser.open(html_f)
                messagebox.showinfo("ì™„ë£Œ", "ì €ì¥ ì™„ë£Œ!\n\n" + "\n".join([os.path.basename(x) for x in files]))
            
        except Exception as e:
            import traceback
            messagebox.showerror("ì˜¤ë¥˜", f"{str(e)}\n\n{traceback.format_exc()}")
    
    def fmt(self, name, s, th):
        t = s['total_rows'] or 1
        surge = s['surge_total'] or 1
        normal_case = t - surge if t - surge > 0 else 1
        detect_rate = (s['detect'] + s['pre_past'] + s['normal_pred']) / surge * 100 if surge > 0 else 0
        
        # ìš”ì•½ ê³„ì‚°
        surge_ok = s['detect'] + s['pre_past'] + s['normal_pred']
        surge_ng = s['miss']
        normal_ok = s['normal'] + s['pre_future'] + s['surge_cont']
        normal_ng = s['false']
        total_ok = surge_ok + normal_ok
        total_ng = surge_ng + normal_ng
        
        return f"""
{'='*60}
  {name} (ê¸°ì¤€: {th})
{'='*60}
ì „ì²´: {s['total_rows']}ê°œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ì „ì²´ ì˜ˆì¸¡OK: {total_ok}ê°œ ({total_ok/t*100:.1f}%)
âŒ ì „ì²´ ì˜ˆì¸¡NG: {total_ng}ê°œ ({total_ng/t*100:.1f}%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[ ê¸‰ì¦ ì¼€ì´ìŠ¤: {s['surge_total']}ê°œ ]
  âœ… ì´ìƒíƒì§€: {s['detect']}ê°œ ({s['detect']/surge*100:.1f}%)
  â° ê¸‰ì¦ì‚¬ì „ê°ì§€: {s['pre_past']}ê°œ ({s['pre_past']/surge*100:.1f}%)
  âœ… ì •ìƒì˜ˆì¸¡: {s['normal_pred']}ê°œ ({s['normal_pred']/surge*100:.1f}%)
  âŒ ë¯¸íƒ: {s['miss']}ê°œ ({s['miss']/surge*100:.1f}%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“Š ì´ìƒíƒì§€(Â±10ë¶„): {surge_ok}ê°œ ({surge_ok/surge*100:.1f}%)
  ğŸ“Š ë¯¸íƒ: {surge_ng}ê°œ ({surge_ng/surge*100:.1f}%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ… ì˜ˆì¸¡OK: {surge_ok}ê°œ ({surge_ok/surge*100:.1f}%)
  âŒ ì˜ˆì¸¡NG: {surge_ng}ê°œ ({surge_ng/surge*100:.1f}%)

[ ì •ìƒ ì¼€ì´ìŠ¤: {t - surge}ê°œ ]
  âœ”ï¸ ì •ìƒ: {s['normal']}ê°œ ({s['normal']/normal_case*100:.1f}%)
  ğŸ”„ ê¸‰ì¦ì—°ì†: {s['surge_cont']}ê°œ ({s['surge_cont']/normal_case*100:.1f}%)
  â° ì •ìƒì‚¬ì „ê°ì§€: {s['pre_future']}ê°œ ({s['pre_future']/normal_case*100:.1f}%)
  âš ï¸ ì˜¤íƒ: {s['false']}ê°œ ({s['false']/normal_case*100:.1f}%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“Š ì •ìƒíƒì§€: {normal_ok}ê°œ ({normal_ok/normal_case*100:.1f}%)
  ğŸ“Š ì˜¤íƒ: {normal_ng}ê°œ ({normal_ng/normal_case*100:.1f}%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ… ì˜ˆì¸¡OK: {normal_ok}ê°œ ({normal_ok/normal_case*100:.1f}%)
  âŒ ì˜ˆì¸¡NG: {normal_ng}ê°œ ({normal_ng/normal_case*100:.1f}%)
"""
    
    def gen_html(self, hub_cmt, m14_cmt, anal_date):
        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜ (ê·¸ë˜í”„ìš©)
        hub_json = "[]"
        m14_json = "[]"
        
        if self.hub_df is not None and len(self.hub_df) > 0:
            hub_data = []
            for _, row in self.hub_df.iterrows():
                hub_data.append({
                    'time': str(row.get('í˜„ì¬ì‹œê°„', '')),
                    'actual': float(row.get('ì‹¤ì œê°’', 0)),
                    'pred': float(row.get('ì˜ˆì¸¡ê°’_MAX', 0)),
                    'cls': str(row.get('ë¶„ë¥˜', ''))
                })
            hub_json = str(hub_data).replace("'", '"')
        
        if self.m14_df is not None and len(self.m14_df) > 0:
            m14_data = []
            for _, row in self.m14_df.iterrows():
                m14_data.append({
                    'time': str(row.get('í˜„ì¬ì‹œê°„', '')),
                    'actual': float(row.get('ì‹¤ì œê°’', 0)),
                    'pred': float(row.get('ì˜ˆì¸¡ê°’_MAX', 0)),
                    'cls': str(row.get('ë¶„ë¥˜', ''))
                })
            m14_json = str(m14_data).replace("'", '"')
        
        html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸ V9</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
*{{margin:0;padding:0;box-sizing:border-box}}
body{{font-family:'ë§‘ì€ ê³ ë”•',sans-serif;background:#0a0a0f;color:#fff;padding:30px}}
.container{{max-width:1200px;margin:0 auto}}
h1{{font-size:2rem;text-align:center;background:linear-gradient(135deg,#00d4ff,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}}
.sub{{text-align:center;color:#888;margin-bottom:30px;font-size:0.9rem}}
.system{{background:#12121a;border-radius:16px;padding:25px;margin-bottom:30px;border:1px solid #2a2a3a}}
.sys-header{{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #333}}
.sys-title{{font-size:1.3rem;font-weight:bold}}
.sys-title.hub{{color:#00d4ff}}
.sys-title.m14{{color:#ff6b35}}
.sys-stats{{display:flex;gap:20px;font-size:0.95rem}}
.sys-stats span{{color:#aaa}}
.sys-stats strong{{margin-left:5px}}
.case-row{{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}}
.case-box{{background:#0a0a12;border-radius:12px;padding:20px;border:1px solid #333}}
.case-title{{font-size:1rem;font-weight:bold;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}}
.case-title.surge{{color:#00d4ff}}
.case-title.normal{{color:#888}}
.rate{{font-size:0.85rem;padding:4px 10px;border-radius:20px}}
.rate.good{{background:#1a3a1a;color:#00ff88}}
.rate.bad{{background:#3a1a1a;color:#ff4466}}
.items{{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}}
.item{{background:#15151f;padding:12px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s}}
.item:hover{{background:#1a1a2a;transform:scale(1.02);box-shadow:0 0 10px rgba(0,212,255,0.3)}}
.item-label{{font-size:0.7rem;color:#666;margin-bottom:4px}}
.item-value{{font-size:1.3rem;font-weight:bold}}
.item-sub{{font-size:0.75rem;color:#888;margin-top:3px}}
.ok{{color:#00ff88}}.warn{{color:#ffcc00}}.bad{{color:#ff4466}}.gray{{color:#aaa}}
.summary-row{{display:flex;gap:10px;margin-top:15px;padding-top:12px;border-top:1px solid #333}}
.sum-ok,.sum-ng{{flex:1;padding:10px 12px;border-radius:8px;font-size:0.85rem}}
.sum-ok{{background:#1a2a1a;color:#00ff88}}
.sum-ng{{background:#2a1a1a;color:#ff4466}}
.sum-ok strong,.sum-ng strong{{font-size:1.1rem;margin:0 5px}}
.sum-ok span,.sum-ng span{{opacity:0.8}}
.mid-summary{{display:flex;gap:10px;margin-top:12px;padding:10px;background:#0a0a12;border-radius:8px}}
.mid-item{{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all 0.2s}}
.mid-item:hover{{transform:scale(1.02)}}
.mid-item.ok-box{{background:#1a2a1a;border:1px solid #00ff8855}}
.mid-item.ng-box{{background:#2a1a1a;border:1px solid #ff446655}}
.mid-label{{font-size:0.75rem;color:#aaa}}
.mid-item strong{{font-size:1.1rem;color:#fff}}
.mid-pct{{font-size:0.8rem;color:#888}}
.mid-item.ok-box strong{{color:#00ff88}}
.mid-item.ng-box strong{{color:#ff4466}}
.items-3{{grid-template-columns:repeat(3,1fr)}}
.total-summary{{display:flex;gap:15px;margin-bottom:15px;padding:15px;background:#0a0a12;border-radius:10px;border:1px solid #333}}
.total-ok,.total-ng{{flex:1;padding:12px 15px;border-radius:8px;font-size:0.95rem;text-align:center}}
.total-ok{{background:#1a3a1a;color:#00ff88;border:1px solid #00ff88}}
.total-ng{{background:#3a1a1a;color:#ff4466;border:1px solid #ff4466}}
.total-ok strong,.total-ng strong{{font-size:1.3rem;margin:0 5px}}
.total-ok span,.total-ng span{{opacity:0.8}}
.charts{{display:grid;grid-template-columns:1fr 1fr;gap:15px}}
.chart-box{{background:#0a0a12;border-radius:12px;padding:15px;border:1px solid #333}}
.chart-title{{font-size:0.85rem;color:#888;text-align:center;margin-bottom:10px}}
.chart-wrap{{height:200px}}
.comment{{background:#1a2a1a;border:2px solid #00ff88;border-radius:10px;padding:15px;margin-top:15px}}
.comment.m14{{background:#2a1a1a;border-color:#ff6b35}}
.comment-title{{font-weight:bold;margin-bottom:6px;font-size:0.9rem}}
.comment-title.hub{{color:#00d4ff}}
.comment-title.m14{{color:#ff6b35}}
.comment-content{{color:#ccc;line-height:1.6;font-size:0.9rem}}
.footer{{text-align:center;color:#555;margin-top:40px;font-size:0.8rem}}
.modal{{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;justify-content:center;align-items:center}}
.modal.show{{display:flex}}
.modal-content{{background:#12121a;border-radius:16px;padding:25px;width:90%;max-width:1000px;max-height:85vh;overflow-y:auto;border:1px solid #333}}
.modal-header{{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #333}}
.modal-title{{font-size:1.2rem;font-weight:bold}}
.modal-close{{background:none;border:none;color:#888;font-size:1.5rem;cursor:pointer}}
.modal-close:hover{{color:#fff}}
.modal-chart{{height:400px;margin-bottom:20px}}
.modal-info{{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}}
.modal-stat{{background:#0a0a12;padding:12px;border-radius:8px;text-align:center}}
.modal-stat-label{{font-size:0.75rem;color:#666;margin-bottom:4px}}
.modal-stat-value{{font-size:1.1rem;font-weight:bold}}
@media(max-width:800px){{.case-row,.charts,.items,.modal-info{{grid-template-columns:1fr}}.sys-header{{flex-direction:column;gap:10px}}.sys-stats{{flex-wrap:wrap}}}}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ“Š MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸ V9</h1>
<p class="sub">ğŸ“… ë¶„ì„ ë‚ ì§œ: {anal_date} | ìƒì„±: {now}</p>
'''
        
        if self.hub_stats and self.hub_stats['total_rows'] > 0:
            s = self.hub_stats
            t = s['total_rows']
            surge = s['surge_total'] or 1
            normal_case = t - surge if t - surge > 0 else 1
            det_rate = (s['detect']+s['pre_past']+s['normal_pred'])/surge*100
            
            # ìš”ì•½ ê³„ì‚°
            surge_ok = s['detect'] + s['pre_past'] + s['normal_pred']
            surge_ng = s['miss']
            normal_ok = s['normal'] + s['pre_future'] + s['surge_cont']
            normal_ng = s['false']
            total_ok = surge_ok + normal_ok
            total_ng = surge_ng + normal_ng
            
            cmt_html = ""
            if hub_cmt:
                cmt_html = f'<div class="comment"><div class="comment-title hub">ğŸ“ ì½”ë©˜íŠ¸</div><div class="comment-content">{hub_cmt.replace(chr(10),"<br>")}</div></div>'
            
            html += f'''
<div class="system">
<div class="sys-header">
<div class="sys-title hub">ğŸ  HUBROOM V9 (ê¸°ì¤€: 350)</div>
<div class="sys-stats">
<span>ì „ì²´ <strong>{t}</strong>ê°œ</span>
<span>ê¸‰ì¦ <strong style="color:#00d4ff">{s['surge_total']}</strong>ê°œ</span>
<span>ì •ìƒ <strong style="color:#aaa">{t-s['surge_total']}</strong>ê°œ</span>
</div>
</div>
<div class="total-summary">
<div class="total-ok">âœ… ì „ì²´ ì˜ˆì¸¡OK <strong>{total_ok}</strong>ê°œ <span>({total_ok/t*100:.1f}%)</span></div>
<div class="total-ng">âŒ ì „ì²´ ì˜ˆì¸¡NG <strong>{total_ng}</strong>ê°œ <span>({total_ng/t*100:.1f}%)</span></div>
</div>
<div class="case-row">
<div class="case-box">
<div class="case-title surge">ğŸ“ˆ ê¸‰ì¦ ì¼€ì´ìŠ¤ ({s['surge_total']}ê°œ)</div>
<div class="items">
<div class="item" onclick="showChart('hub','ì´ìƒíƒì§€',350)"><div class="item-label">ì´ìƒíƒì§€</div><div class="item-value ok">{s['detect']}</div><div class="item-sub">{s['detect']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ê¸‰ì¦ì‚¬ì „ê°ì§€',350)"><div class="item-label">ê¸‰ì¦ì‚¬ì „ê°ì§€</div><div class="item-value warn">{s['pre_past']}</div><div class="item-sub">{s['pre_past']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ì •ìƒì˜ˆì¸¡',350)"><div class="item-label">ì •ìƒì˜ˆì¸¡</div><div class="item-value ok">{s['normal_pred']}</div><div class="item-sub">{s['normal_pred']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ë¯¸íƒ',350)"><div class="item-label">ë¯¸íƒ</div><div class="item-value bad">{s['miss']}</div><div class="item-sub">{s['miss']/surge*100:.1f}%</div></div>
</div>
<div class="mid-summary">
<div class="mid-item ok-box" onclick="showChart('hub','ì´ìƒíƒì§€_ALL',350)"><span class="mid-label">ì´ìƒíƒì§€(Â±10ë¶„)</span><strong>{surge_ok}</strong><span class="mid-pct">{surge_ok/surge*100:.1f}%</span></div>
<div class="mid-item ng-box" onclick="showChart('hub','ë¯¸íƒ',350)"><span class="mid-label">ë¯¸íƒ</span><strong>{surge_ng}</strong><span class="mid-pct">{surge_ng/surge*100:.1f}%</span></div>
</div>
<div class="summary-row">
<div class="sum-ok">âœ… ì˜ˆì¸¡OK <strong>{surge_ok}</strong> <span>({surge_ok/surge*100:.1f}%)</span></div>
<div class="sum-ng">âŒ ì˜ˆì¸¡NG <strong>{surge_ng}</strong> <span>({surge_ng/surge*100:.1f}%)</span></div>
</div>
</div>
<div class="case-box">
<div class="case-title normal">ğŸ“Š ì •ìƒ ì¼€ì´ìŠ¤ ({t-s['surge_total']}ê°œ)</div>
<div class="items">
<div class="item" onclick="showChart('hub','ì •ìƒ',350)"><div class="item-label">ì •ìƒ</div><div class="item-value gray">{s['normal']}</div><div class="item-sub">{s['normal']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ê¸‰ì¦ì—°ì†',350)"><div class="item-label">ê¸‰ì¦ì—°ì†</div><div class="item-value warn">{s['surge_cont']}</div><div class="item-sub">{s['surge_cont']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ì •ìƒì‚¬ì „ê°ì§€',350)"><div class="item-label">ì •ìƒì‚¬ì „ê°ì§€</div><div class="item-value warn">{s['pre_future']}</div><div class="item-sub">{s['pre_future']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('hub','ì˜¤íƒ',350)"><div class="item-label">ì˜¤íƒ</div><div class="item-value bad">{s['false']}</div><div class="item-sub">{s['false']/normal_case*100:.1f}%</div></div>
</div>
<div class="mid-summary">
<div class="mid-item ok-box" onclick="showChart('hub','ì •ìƒíƒì§€_ALL',350)"><span class="mid-label">ì •ìƒíƒì§€</span><strong>{normal_ok}</strong><span class="mid-pct">{normal_ok/normal_case*100:.1f}%</span></div>
<div class="mid-item ng-box" onclick="showChart('hub','ì˜¤íƒ',350)"><span class="mid-label">ì˜¤íƒ</span><strong>{normal_ng}</strong><span class="mid-pct">{normal_ng/normal_case*100:.1f}%</span></div>
</div>
<div class="summary-row">
<div class="sum-ok">âœ… ì˜ˆì¸¡OK <strong>{normal_ok}</strong> <span>({normal_ok/normal_case*100:.1f}%)</span></div>
<div class="sum-ng">âŒ ì˜ˆì¸¡NG <strong>{normal_ng}</strong> <span>({normal_ng/normal_case*100:.1f}%)</span></div>
</div>
</div>
</div>
<div class="charts">
<div class="chart-box"><div class="chart-title">ê¸‰ì¦ íƒì§€ ë¶„í¬</div><div class="chart-wrap"><canvas id="hubSurge"></canvas></div></div>
<div class="chart-box"><div class="chart-title">ì •ìƒ ì¼€ì´ìŠ¤ ë¶„í¬</div><div class="chart-wrap"><canvas id="hubNormal"></canvas></div></div>
</div>
{cmt_html}
</div>
'''
        
        if self.m14_stats and self.m14_stats['total_rows'] > 0:
            s = self.m14_stats
            t = s['total_rows']
            surge = s['surge_total'] or 1
            det_rate = (s['detect']+s['pre_past']+s['normal_pred'])/surge*100
            normal_case = t - surge if t - surge > 0 else 1
            
            # ìš”ì•½ ê³„ì‚°
            surge_ok = s['detect'] + s['pre_past'] + s['normal_pred']
            surge_ng = s['miss']
            normal_ok = s['normal'] + s['pre_future'] + s['surge_cont']
            normal_ng = s['false']
            total_ok = surge_ok + normal_ok
            total_ng = surge_ng + normal_ng
            
            cmt_html = ""
            if m14_cmt:
                cmt_html = f'<div class="comment m14"><div class="comment-title m14">ğŸ“ ì½”ë©˜íŠ¸</div><div class="comment-content">{m14_cmt.replace(chr(10),"<br>")}</div></div>'
            
            html += f'''
<div class="system">
<div class="sys-header">
<div class="sys-title m14">ğŸ­ M14_Q V9 (ê¸°ì¤€: 1700)</div>
<div class="sys-stats">
<span>ì „ì²´ <strong>{t}</strong>ê°œ</span>
<span>ê¸‰ì¦ <strong style="color:#ff6b35">{s['surge_total']}</strong>ê°œ</span>
<span>ì •ìƒ <strong style="color:#aaa">{t-s['surge_total']}</strong>ê°œ</span>
</div>
</div>
<div class="total-summary">
<div class="total-ok">âœ… ì „ì²´ ì˜ˆì¸¡OK <strong>{total_ok}</strong>ê°œ <span>({total_ok/t*100:.1f}%)</span></div>
<div class="total-ng">âŒ ì „ì²´ ì˜ˆì¸¡NG <strong>{total_ng}</strong>ê°œ <span>({total_ng/t*100:.1f}%)</span></div>
</div>
<div class="case-row">
<div class="case-box">
<div class="case-title surge" style="color:#ff6b35">ğŸ“ˆ ê¸‰ì¦ ì¼€ì´ìŠ¤ ({s['surge_total']}ê°œ)</div>
<div class="items">
<div class="item" onclick="showChart('m14','ì´ìƒíƒì§€',1700)"><div class="item-label">ì´ìƒíƒì§€</div><div class="item-value ok">{s['detect']}</div><div class="item-sub">{s['detect']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ê¸‰ì¦ì‚¬ì „ê°ì§€',1700)"><div class="item-label">ê¸‰ì¦ì‚¬ì „ê°ì§€</div><div class="item-value warn">{s['pre_past']}</div><div class="item-sub">{s['pre_past']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ì •ìƒì˜ˆì¸¡',1700)"><div class="item-label">ì •ìƒì˜ˆì¸¡</div><div class="item-value ok">{s['normal_pred']}</div><div class="item-sub">{s['normal_pred']/surge*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ë¯¸íƒ',1700)"><div class="item-label">ë¯¸íƒ</div><div class="item-value bad">{s['miss']}</div><div class="item-sub">{s['miss']/surge*100:.1f}%</div></div>
</div>
<div class="mid-summary">
<div class="mid-item ok-box" onclick="showChart('m14','ì´ìƒíƒì§€_ALL',1700)"><span class="mid-label">ì´ìƒíƒì§€(Â±10ë¶„)</span><strong>{surge_ok}</strong><span class="mid-pct">{surge_ok/surge*100:.1f}%</span></div>
<div class="mid-item ng-box" onclick="showChart('m14','ë¯¸íƒ',1700)"><span class="mid-label">ë¯¸íƒ</span><strong>{surge_ng}</strong><span class="mid-pct">{surge_ng/surge*100:.1f}%</span></div>
</div>
<div class="summary-row">
<div class="sum-ok">âœ… ì˜ˆì¸¡OK <strong>{surge_ok}</strong> <span>({surge_ok/surge*100:.1f}%)</span></div>
<div class="sum-ng">âŒ ì˜ˆì¸¡NG <strong>{surge_ng}</strong> <span>({surge_ng/surge*100:.1f}%)</span></div>
</div>
</div>
<div class="case-box">
<div class="case-title normal">ğŸ“Š ì •ìƒ ì¼€ì´ìŠ¤ ({t-s['surge_total']}ê°œ)</div>
<div class="items">
<div class="item" onclick="showChart('m14','ì •ìƒ',1700)"><div class="item-label">ì •ìƒ</div><div class="item-value gray">{s['normal']}</div><div class="item-sub">{s['normal']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ê¸‰ì¦ì—°ì†',1700)"><div class="item-label">ê¸‰ì¦ì—°ì†</div><div class="item-value warn">{s['surge_cont']}</div><div class="item-sub">{s['surge_cont']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ì •ìƒì‚¬ì „ê°ì§€',1700)"><div class="item-label">ì •ìƒì‚¬ì „ê°ì§€</div><div class="item-value warn">{s['pre_future']}</div><div class="item-sub">{s['pre_future']/normal_case*100:.1f}%</div></div>
<div class="item" onclick="showChart('m14','ì˜¤íƒ',1700)"><div class="item-label">ì˜¤íƒ</div><div class="item-value bad">{s['false']}</div><div class="item-sub">{s['false']/normal_case*100:.1f}%</div></div>
</div>
<div class="mid-summary">
<div class="mid-item ok-box" onclick="showChart('m14','ì •ìƒíƒì§€_ALL',1700)"><span class="mid-label">ì •ìƒíƒì§€</span><strong>{normal_ok}</strong><span class="mid-pct">{normal_ok/normal_case*100:.1f}%</span></div>
<div class="mid-item ng-box" onclick="showChart('m14','ì˜¤íƒ',1700)"><span class="mid-label">ì˜¤íƒ</span><strong>{normal_ng}</strong><span class="mid-pct">{normal_ng/normal_case*100:.1f}%</span></div>
</div>
<div class="summary-row">
<div class="sum-ok">âœ… ì˜ˆì¸¡OK <strong>{normal_ok}</strong> <span>({normal_ok/normal_case*100:.1f}%)</span></div>
<div class="sum-ng">âŒ ì˜ˆì¸¡NG <strong>{normal_ng}</strong> <span>({normal_ng/normal_case*100:.1f}%)</span></div>
</div>
</div>
</div>
<div class="charts">
<div class="chart-box"><div class="chart-title">ê¸‰ì¦ íƒì§€ ë¶„í¬</div><div class="chart-wrap"><canvas id="m14Surge"></canvas></div></div>
<div class="chart-box"><div class="chart-title">ì •ìƒ ì¼€ì´ìŠ¤ ë¶„í¬</div><div class="chart-wrap"><canvas id="m14Normal"></canvas></div></div>
</div>
{cmt_html}
</div>
'''
        
        html += '''
<div class="footer">MLê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V9 | AMHS ë¬¼ë¥˜ ì˜ˆì¸¡ ëª¨ë¸</div>
</div>
<script>
Chart.register(ChartDataLabels);
const opt={responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#fff',font:{size:10},padding:8}},datalabels:{color:'#fff',font:{weight:'bold',size:11},formatter:(v,ctx)=>{let sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return v>0?(v/sum*100).toFixed(1)+'%':''}}}};
'''
        
        if self.hub_stats and self.hub_stats['total_rows'] > 0:
            s = self.hub_stats
            html += f'''
new Chart(document.getElementById('hubSurge'),{{type:'doughnut',data:{{labels:['ì´ìƒíƒì§€ ({s['detect']}ê°œ)','ê¸‰ì¦ì‚¬ì „ê°ì§€ ({s['pre_past']}ê°œ)','ì •ìƒì˜ˆì¸¡ ({s['normal_pred']}ê°œ)','ë¯¸íƒ ({s['miss']}ê°œ)'],datasets:[{{data:[{s['detect']},{s['pre_past']},{s['normal_pred']},{s['miss']}],backgroundColor:['#00ff88','#ffcc00','#00d4ff','#ff4466']}}]}},options:opt}});
new Chart(document.getElementById('hubNormal'),{{type:'doughnut',data:{{labels:['ì •ìƒ ({s['normal']}ê°œ)','ê¸‰ì¦ì—°ì† ({s['surge_cont']}ê°œ)','ì •ìƒì‚¬ì „ê°ì§€ ({s['pre_future']}ê°œ)','ì˜¤íƒ ({s['false']}ê°œ)'],datasets:[{{data:[{s['normal']},{s['surge_cont']},{s['pre_future']},{s['false']}],backgroundColor:['#666666','#ff9500','#ffcc00','#ff4466']}}]}},options:opt}});
'''
        
        if self.m14_stats and self.m14_stats['total_rows'] > 0:
            s = self.m14_stats
            html += f'''
new Chart(document.getElementById('m14Surge'),{{type:'doughnut',data:{{labels:['ì´ìƒíƒì§€ ({s['detect']}ê°œ)','ê¸‰ì¦ì‚¬ì „ê°ì§€ ({s['pre_past']}ê°œ)','ì •ìƒì˜ˆì¸¡ ({s['normal_pred']}ê°œ)','ë¯¸íƒ ({s['miss']}ê°œ)'],datasets:[{{data:[{s['detect']},{s['pre_past']},{s['normal_pred']},{s['miss']}],backgroundColor:['#00ff88','#ffcc00','#00d4ff','#ff4466']}}]}},options:opt}});
new Chart(document.getElementById('m14Normal'),{{type:'doughnut',data:{{labels:['ì •ìƒ ({s['normal']}ê°œ)','ê¸‰ì¦ì—°ì† ({s['surge_cont']}ê°œ)','ì •ìƒì‚¬ì „ê°ì§€ ({s['pre_future']}ê°œ)','ì˜¤íƒ ({s['false']}ê°œ)'],datasets:[{{data:[{s['normal']},{s['surge_cont']},{s['pre_future']},{s['false']}],backgroundColor:['#666666','#ff9500','#ffcc00','#ff4466']}}]}},options:opt}});
'''
        
        # ëª¨ë‹¬ê³¼ ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
        html += f'''
const hubData = {hub_json};
const m14Data = {m14_json};
let modalChart = null;

function showChart(system, cls, threshold) {{
    const data = system === 'hub' ? hubData : m14Data;
    const sysName = system === 'hub' ? 'HUBROOM' : 'M14_Q';
    
    let filtered = [];
    if (cls === 'ì´ìƒíƒì§€_ALL') {{
        filtered = data.filter(d => d.cls === 'ì´ìƒíƒì§€' || d.cls.includes('ê¸‰ì¦ì‚¬ì „ê°ì§€') || d.cls.includes('ì •ìƒì˜ˆì¸¡'));
    }} else if (cls === 'ì •ìƒíƒì§€_ALL') {{
        filtered = data.filter(d => d.cls === 'ì •ìƒ' || d.cls.includes('ê¸‰ì¦ì—°ì†') || d.cls.includes('ì •ìƒì‚¬ì „ê°ì§€'));
    }} else {{
        filtered = data.filter(d => d.cls.includes(cls));
    }}
    
    if (filtered.length === 0) {{
        alert('í•´ë‹¹ ë¶„ë¥˜ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }}
    
    // ìµœëŒ€ 500ê°œë§Œ ìƒ˜í”Œë§ (ì„±ëŠ¥)
    if (filtered.length > 500) {{
        const step = Math.ceil(filtered.length / 500);
        filtered = filtered.filter((_, i) => i % step === 0);
    }}
    
    document.getElementById('modalTitle').textContent = `${{sysName}} - ${{cls}} (${{filtered.length}}ê°œ)`;
    document.getElementById('chartModal').classList.add('show');
    
    const ctx = document.getElementById('modalLineChart').getContext('2d');
    if (modalChart) modalChart.destroy();
    
    modalChart = new Chart(ctx, {{
        type: 'line',
        data: {{
            labels: filtered.map(d => d.time.split(' ')[1] || d.time),
            datasets: [
                {{
                    label: 'ì‹¤ì œê°’',
                    data: filtered.map(d => d.actual),
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0,212,255,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2
                }},
                {{
                    label: 'ì˜ˆì¸¡ê°’',
                    data: filtered.map(d => d.pred),
                    borderColor: '#ff6b35',
                    backgroundColor: 'rgba(255,107,53,0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2
                }},
                {{
                    label: 'ì„ê³„ê°’',
                    data: filtered.map(() => threshold),
                    borderColor: '#ff4466',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }}
            ]
        }},
        options: {{
            responsive: true,
            maintainAspectRatio: false,
            plugins: {{
                legend: {{ position: 'top', labels: {{ color: '#fff' }} }},
                datalabels: {{ display: false }}
            }},
            scales: {{
                x: {{ ticks: {{ color: '#888', maxTicksLimit: 20 }}, grid: {{ color: '#333' }} }},
                y: {{ ticks: {{ color: '#888' }}, grid: {{ color: '#333' }} }}
            }}
        }}
    }});
    
    // í†µê³„
    const actuals = filtered.map(d => d.actual);
    const preds = filtered.map(d => d.pred);
    document.getElementById('statCount').textContent = filtered.length;
    document.getElementById('statActualAvg').textContent = (actuals.reduce((a,b)=>a+b,0)/actuals.length).toFixed(1);
    document.getElementById('statPredAvg').textContent = (preds.reduce((a,b)=>a+b,0)/preds.length).toFixed(1);
    document.getElementById('statActualMax').textContent = Math.max(...actuals).toFixed(1);
}}

function closeModal() {{
    document.getElementById('chartModal').classList.remove('show');
    if (modalChart) {{ modalChart.destroy(); modalChart = null; }}
}}

document.getElementById('chartModal').addEventListener('click', function(e) {{
    if (e.target === this) closeModal();
}});
</script>

<div id="chartModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div id="modalTitle" class="modal-title">ê·¸ë˜í”„</div>
<button class="modal-close" onclick="closeModal()">&times;</button>
</div>
<div class="modal-chart"><canvas id="modalLineChart"></canvas></div>
<div class="modal-info">
<div class="modal-stat"><div class="modal-stat-label">ë°ì´í„° ìˆ˜</div><div id="statCount" class="modal-stat-value ok">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì‹¤ì œê°’ í‰ê· </div><div id="statActualAvg" class="modal-stat-value" style="color:#00d4ff">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì˜ˆì¸¡ê°’ í‰ê· </div><div id="statPredAvg" class="modal-stat-value" style="color:#ff6b35">0</div></div>
<div class="modal-stat"><div class="modal-stat-label">ì‹¤ì œê°’ ìµœëŒ€</div><div id="statActualMax" class="modal-stat-value bad">0</div></div>
</div>
</div>
</div>
</body></html>'''
        return html


if __name__ == "__main__":
    root = tk.Tk()
    app = SurgeAnalyzer(root)
    root.mainloop()