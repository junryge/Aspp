# -*- coding: utf-8 -*-
"""
ì—ì´ì „í‹± AI ì‹œìŠ¤í…œ - ììœ¨ ì‘ì—… ìˆ˜í–‰ ê°€ëŠ¥í•œ AI ì–´ì‹œìŠ¤í„´íŠ¸
Multi-Agent Architecture with Tool Usage
"""

import os
import sys
import json
import time
import threading
import asyncio
from typing import Dict, List, Optional, Any, Callable
from dataclasses import dataclass, field
from enum import Enum
import customtkinter as ctk
from tkinter import filedialog, messagebox, ttk
from pathlib import Path
import logging
from datetime import datetime
import traceback
from abc import ABC, abstractmethod
import queue
import subprocess
import webbrowser
import sqlite3

# llama-cpp-python ì§ì ‘ import
try:
    from llama_cpp import Llama
    LLAMA_CPP_AVAILABLE = True
except ImportError:
    LLAMA_CPP_AVAILABLE = False
    print("llama-cpp-pythonê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜í•´ì£¼ì„¸ìš”: pip install llama-cpp-python")

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.FileHandler("agentic_ai.log"), logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

# í˜„ëŒ€ì  í…Œë§ˆ ì„¤ì •
MODERN_THEME = {
    'primary': '#6366F1',      # Indigo
    'secondary': '#8B5CF6',    # Purple
    'accent': '#EC4899',       # Pink
    'success': '#10B981',      # Emerald
    'warning': '#F59E0B',      # Amber
    'error': '#EF4444',        # Red
    'info': '#3B82F6',         # Blue
    'dark': '#1F2937',         # Gray-800
    'light': '#F9FAFB',        # Gray-50
    'surface': '#FFFFFF',
    'text': '#111827',         # Gray-900
    'text_secondary': '#6B7280', # Gray-500
    'border': '#E5E7EB',       # Gray-200
    'hover': '#4F46E5',        # Indigo-600
    'gradient_start': '#6366F1',
    'gradient_end': '#8B5CF6'
}

# ============= ì—ì´ì „íŠ¸ íƒ€ì… ì •ì˜ =============
class AgentType(Enum):
    """ì—ì´ì „íŠ¸ íƒ€ì… ì •ì˜"""
    ORCHESTRATOR = "orchestrator"     # ì „ì²´ ì¡°ì •ì
    PLANNER = "planner"               # ê³„íš ìˆ˜ë¦½
    EXECUTOR = "executor"             # ì‹¤í–‰ ë‹´ë‹¹
    RESEARCHER = "researcher"         # ì •ë³´ ìˆ˜ì§‘
    ANALYZER = "analyzer"             # ë¶„ì„ ë‹´ë‹¹
    CREATOR = "creator"               # ì½˜í…ì¸  ìƒì„±
    REVIEWER = "reviewer"             # ê²€í†  ë‹´ë‹¹

class TaskStatus(Enum):
    """ì‘ì—… ìƒíƒœ"""
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"

# ============= ë„êµ¬ ì¸í„°í˜ì´ìŠ¤ =============
class Tool(ABC):
    """ë„êµ¬ ê¸°ë³¸ í´ë˜ìŠ¤"""
    
    def __init__(self, name: str, description: str):
        self.name = name
        self.description = description
    
    @abstractmethod
    async def execute(self, *args, **kwargs) -> Any:
        """ë„êµ¬ ì‹¤í–‰"""
        pass

class WebSearchTool(Tool):
    """ì›¹ ê²€ìƒ‰ ë„êµ¬"""
    
    def __init__(self):
        super().__init__(
            name="web_search",
            description="ì›¹ì—ì„œ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤"
        )
    
    async def execute(self, query: str) -> str:
        """ì›¹ ê²€ìƒ‰ ì‹¤í–‰ (ì‹œë®¬ë ˆì´ì…˜)"""
        await asyncio.sleep(1)  # ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ
        return f"ê²€ìƒ‰ ê²°ê³¼: {query}ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."

class FileSystemTool(Tool):
    """íŒŒì¼ ì‹œìŠ¤í…œ ë„êµ¬"""
    
    def __init__(self):
        super().__init__(
            name="file_system",
            description="íŒŒì¼ì„ ì½ê³  ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        )
    
    async def execute(self, action: str, path: str, content: str = None) -> str:
        """íŒŒì¼ ì‘ì—… ì‹¤í–‰"""
        if action == "read":
            try:
                with open(path, 'r', encoding='utf-8') as f:
                    return f.read()
            except Exception as e:
                return f"íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {str(e)}"
        elif action == "write":
            try:
                with open(path, 'w', encoding='utf-8') as f:
                    f.write(content)
                return f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {path}"
            except Exception as e:
                return f"íŒŒì¼ ì“°ê¸° ì‹¤íŒ¨: {str(e)}"
        return "ì§€ì›í•˜ì§€ ì•ŠëŠ” ì‘ì—…ì…ë‹ˆë‹¤."

class CodeExecutorTool(Tool):
    """ì½”ë“œ ì‹¤í–‰ ë„êµ¬"""
    
    def __init__(self):
        super().__init__(
            name="code_executor",
            description="Python ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤"
        )
    
    async def execute(self, code: str) -> str:
        """ì½”ë“œ ì‹¤í–‰ (ë³´ì•ˆìƒ ì œí•œì ìœ¼ë¡œ)"""
        try:
            # ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” ìƒŒë“œë°•ìŠ¤ í™˜ê²½ í•„ìš”
            result = eval(code) if len(code) < 100 else "ì½”ë“œê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤"
            return str(result)
        except Exception as e:
            return f"ì‹¤í–‰ ì˜¤ë¥˜: {str(e)}"

class DatabaseTool(Tool):
    """ë°ì´í„°ë² ì´ìŠ¤ ë„êµ¬"""
    
    def __init__(self):
        super().__init__(
            name="database",
            description="ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤"
        )
        self.conn = None
        self.init_db()
    
    def init_db(self):
        """ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”"""
        self.conn = sqlite3.connect('agentic_ai.db', check_same_thread=False)
        cursor = self.conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tasks (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                description TEXT,
                status TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP
            )
        ''')
        self.conn.commit()
    
    async def execute(self, query: str) -> str:
        """SQL ì¿¼ë¦¬ ì‹¤í–‰"""
        try:
            cursor = self.conn.cursor()
            cursor.execute(query)
            if query.strip().upper().startswith('SELECT'):
                return str(cursor.fetchall())
            else:
                self.conn.commit()
                return f"ì¿¼ë¦¬ ì‹¤í–‰ ì™„ë£Œ: {cursor.rowcount}ê°œ í–‰ ì˜í–¥"
        except Exception as e:
            return f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {str(e)}"

# ============= ì‘ì—… ì •ì˜ =============
@dataclass
class Task:
    """ì‘ì—… ì •ì˜"""
    id: str
    title: str
    description: str
    agent_type: AgentType
    status: TaskStatus = TaskStatus.PENDING
    priority: int = 5
    dependencies: List[str] = field(default_factory=list)
    result: Any = None
    error: str = None
    created_at: datetime = field(default_factory=datetime.now)
    completed_at: Optional[datetime] = None

# ============= ì—ì´ì „íŠ¸ ê¸°ë³¸ í´ë˜ìŠ¤ =============
class Agent:
    """ì—ì´ì „íŠ¸ ê¸°ë³¸ í´ë˜ìŠ¤"""
    
    def __init__(self, name: str, agent_type: AgentType, model=None):
        self.name = name
        self.agent_type = agent_type
        self.model = model
        self.tools: Dict[str, Tool] = {}
        self.memory: List[Dict] = []
        self.current_task: Optional[Task] = None
        
    def add_tool(self, tool: Tool):
        """ë„êµ¬ ì¶”ê°€"""
        self.tools[tool.name] = tool
        
    async def process_task(self, task: Task) -> Any:
        """ì‘ì—… ì²˜ë¦¬"""
        self.current_task = task
        task.status = TaskStatus.IN_PROGRESS
        
        try:
            # ì‘ì—… ê³„íš ìˆ˜ë¦½
            plan = await self.plan_task(task)
            
            # ì‘ì—… ì‹¤í–‰
            result = await self.execute_plan(plan)
            
            task.status = TaskStatus.COMPLETED
            task.completed_at = datetime.now()
            task.result = result
            
            # ë©”ëª¨ë¦¬ì— ì €ì¥
            self.memory.append({
                'task': task.title,
                'result': result,
                'timestamp': datetime.now()
            })
            
            return result
            
        except Exception as e:
            task.status = TaskStatus.FAILED
            task.error = str(e)
            logger.error(f"Agent {self.name} failed: {str(e)}")
            raise
            
    async def plan_task(self, task: Task) -> List[Dict]:
        """ì‘ì—… ê³„íš ìˆ˜ë¦½"""
        # ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì—… ê³„íš ìƒì„±
        if self.model:
            prompt = f"""
            ì‘ì—…: {task.title}
            ì„¤ëª…: {task.description}
            
            ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë‹¨ê³„ë³„ ê³„íšì„ ìˆ˜ë¦½í•˜ì„¸ìš”.
            ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬: {', '.join(self.tools.keys())}
            """
            
            # ì‹¤ì œë¡œëŠ” ëª¨ë¸ í˜¸ì¶œ
            plan = [
                {'step': 'ì •ë³´ ìˆ˜ì§‘', 'tool': 'web_search'},
                {'step': 'ë¶„ì„', 'tool': None},
                {'step': 'ê²°ê³¼ ìƒì„±', 'tool': 'file_system'}
            ]
        else:
            plan = [{'step': 'ê¸°ë³¸ ì‹¤í–‰', 'tool': None}]
            
        return plan
        
    async def execute_plan(self, plan: List[Dict]) -> Any:
        """ê³„íš ì‹¤í–‰"""
        results = []
        
        for step in plan:
            if step.get('tool'):
                tool = self.tools.get(step['tool'])
                if tool:
                    result = await tool.execute()
                    results.append(result)
            else:
                # ë„êµ¬ ì—†ì´ ì‹¤í–‰
                results.append(f"Step completed: {step.get('step', 'Unknown')}")
                
        return results

# ============= ë©€í‹° ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° =============
class AgentOrchestrator:
    """ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì¡°ì •ì"""
    
    def __init__(self):
        self.agents: Dict[str, Agent] = {}
        self.task_queue: queue.Queue = queue.Queue()
        self.completed_tasks: List[Task] = []
        self.running = False
        
    def add_agent(self, agent: Agent):
        """ì—ì´ì „íŠ¸ ì¶”ê°€"""
        self.agents[agent.name] = agent
        logger.info(f"Agent added: {agent.name} ({agent.agent_type.value})")
        
    def submit_task(self, task: Task):
        """ì‘ì—… ì œì¶œ"""
        self.task_queue.put(task)
        logger.info(f"Task submitted: {task.title}")
        
    async def process_tasks(self):
        """ì‘ì—… ì²˜ë¦¬ ë£¨í”„"""
        self.running = True
        
        while self.running:
            if not self.task_queue.empty():
                task = self.task_queue.get()
                
                # ì ì ˆí•œ ì—ì´ì „íŠ¸ ì„ íƒ
                agent = self.select_agent(task)
                
                if agent:
                    try:
                        result = await agent.process_task(task)
                        self.completed_tasks.append(task)
                        logger.info(f"Task completed: {task.title}")
                    except Exception as e:
                        logger.error(f"Task failed: {task.title} - {str(e)}")
                else:
                    logger.warning(f"No suitable agent for task: {task.title}")
                    
            await asyncio.sleep(0.1)
            
    def select_agent(self, task: Task) -> Optional[Agent]:
        """ì‘ì—…ì— ì í•©í•œ ì—ì´ì „íŠ¸ ì„ íƒ"""
        for agent in self.agents.values():
            if agent.agent_type == task.agent_type:
                return agent
        return None
        
    def stop(self):
        """ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì¤‘ì§€"""
        self.running = False

# ============= ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ UI =============
class AgenticAIApp(ctk.CTk):
    """ì—ì´ì „í‹± AI ì‹œìŠ¤í…œ UI"""
    
    def __init__(self):
        super().__init__()
        
        # ì•± ì´ˆê¸°í™”
        self.title("ğŸ¤– Agentic AI System - ììœ¨ AI ì–´ì‹œìŠ¤í„´íŠ¸")
        self.geometry("1400x900")
        
        # ë””ë ‰í† ë¦¬ ìƒì„±
        self.create_directories()
        
        # ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        self.orchestrator = AgentOrchestrator()
        self.setup_agents()
        
        # ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë£¨í”„
        self.loop = asyncio.new_event_loop()
        self.async_thread = threading.Thread(target=self.run_async_loop, daemon=True)
        self.async_thread.start()
        
        # UI ì„¤ì •
        self.setup_modern_ui()
        
        # ì‹œì‘ ë©”ì‹œì§€
        self.add_system_message("ğŸš€ ì—ì´ì „í‹± AI ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
        self.add_system_message("ğŸ“‹ ì‘ì—…ì„ ì…ë ¥í•˜ë©´ AI ì—ì´ì „íŠ¸ë“¤ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.")
        
    def create_directories(self):
        """í•„ìš” ë””ë ‰í† ë¦¬ ìƒì„±"""
        dirs = ["agents", "tasks", "outputs", "memory", "tools"]
        for dir_path in dirs:
            os.makedirs(dir_path, exist_ok=True)
            
    def setup_agents(self):
        """ì—ì´ì „íŠ¸ ì„¤ì •"""
        # ë‹¤ì–‘í•œ ì—ì´ì „íŠ¸ ìƒì„±
        agents_config = [
            ("ì£¼ ì¡°ì •ì", AgentType.ORCHESTRATOR),
            ("ê³„íš ìˆ˜ë¦½ì", AgentType.PLANNER),
            ("ì‹¤í–‰ì", AgentType.EXECUTOR),
            ("ì—°êµ¬ì›", AgentType.RESEARCHER),
            ("ë¶„ì„ê°€", AgentType.ANALYZER),
            ("ì°½ì‘ì", AgentType.CREATOR),
            ("ê²€í† ì", AgentType.REVIEWER)
        ]
        
        for name, agent_type in agents_config:
            agent = Agent(name, agent_type)
            
            # ë„êµ¬ í• ë‹¹
            if agent_type in [AgentType.RESEARCHER, AgentType.EXECUTOR]:
                agent.add_tool(WebSearchTool())
                agent.add_tool(FileSystemTool())
            
            if agent_type == AgentType.EXECUTOR:
                agent.add_tool(CodeExecutorTool())
                agent.add_tool(DatabaseTool())
                
            self.orchestrator.add_agent(agent)
            
    def run_async_loop(self):
        """ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë£¨í”„ ì‹¤í–‰"""
        asyncio.set_event_loop(self.loop)
        self.loop.run_until_complete(self.orchestrator.process_tasks())
        
    def setup_modern_ui(self):
        """í˜„ëŒ€ì  UI êµ¬ì„±"""
        # í…Œë§ˆ ì„¤ì •
        ctk.set_appearance_mode("dark")
        ctk.set_default_color_theme("blue")
        
        # ê·¸ë¦¬ë“œ ì„¤ì •
        self.grid_columnconfigure(0, weight=0)  # ì‚¬ì´ë“œë°”
        self.grid_columnconfigure(1, weight=1)  # ë©”ì¸ ì˜ì—­
        self.grid_rowconfigure(0, weight=1)
        
        # ì‚¬ì´ë“œë°”
        self.setup_sidebar()
        
        # ë©”ì¸ ì˜ì—­
        self.setup_main_area()
        
    def setup_sidebar(self):
        """ì‚¬ì´ë“œë°” êµ¬ì„±"""
        sidebar = ctk.CTkFrame(self, width=280, corner_radius=0, fg_color=MODERN_THEME['dark'])
        sidebar.grid(row=0, column=0, sticky="nsew")
        sidebar.grid_rowconfigure(6, weight=1)
        
        # ë¡œê³  ì˜ì—­
        logo_frame = ctk.CTkFrame(sidebar, fg_color="transparent")
        logo_frame.grid(row=0, column=0, padx=20, pady=(20, 30), sticky="ew")
        
        ctk.CTkLabel(
            logo_frame,
            text="ğŸ¤– Agentic AI",
            font=("SF Pro Display", 28, "bold"),
            text_color=MODERN_THEME['light']
        ).pack()
        
        ctk.CTkLabel(
            logo_frame,
            text="Autonomous Multi-Agent System",
            font=("SF Pro Text", 12),
            text_color=MODERN_THEME['text_secondary']
        ).pack()
        
        # ì—ì´ì „íŠ¸ ìƒíƒœ
        self.agent_status_frame = ctk.CTkFrame(sidebar, fg_color=MODERN_THEME['surface'], corner_radius=10)
        self.agent_status_frame.grid(row=1, column=0, padx=20, pady=10, sticky="ew")
        
        ctk.CTkLabel(
            self.agent_status_frame,
            text="Active Agents",
            font=("SF Pro Display", 14, "bold"),
            text_color=MODERN_THEME['text']
        ).pack(pady=(10, 5))
        
        # ì—ì´ì „íŠ¸ ë¦¬ìŠ¤íŠ¸
        for agent_name, agent in self.orchestrator.agents.items():
            agent_item = ctk.CTkFrame(self.agent_status_frame, fg_color="transparent")
            agent_item.pack(fill="x", padx=10, pady=2)
            
            status_color = MODERN_THEME['success']
            ctk.CTkLabel(
                agent_item,
                text="â—",
                font=("SF Pro Text", 12),
                text_color=status_color,
                width=20
            ).pack(side="left")
            
            ctk.CTkLabel(
                agent_item,
                text=agent_name,
                font=("SF Pro Text", 12),
                text_color=MODERN_THEME['text_secondary']
            ).pack(side="left", padx=(5, 0))
        
        # ì‘ì—… í†µê³„
        stats_frame = ctk.CTkFrame(sidebar, fg_color=MODERN_THEME['surface'], corner_radius=10)
        stats_frame.grid(row=2, column=0, padx=20, pady=10, sticky="ew")
        
        ctk.CTkLabel(
            stats_frame,
            text="Task Statistics",
            font=("SF Pro Display", 14, "bold"),
            text_color=MODERN_THEME['text']
        ).pack(pady=(10, 5))
        
        self.stats_labels = {}
        stats = [
            ("Pending", "pending", MODERN_THEME['warning']),
            ("In Progress", "progress", MODERN_THEME['info']),
            ("Completed", "completed", MODERN_THEME['success']),
            ("Failed", "failed", MODERN_THEME['error'])
        ]
        
        for stat_name, stat_key, color in stats:
            stat_item = ctk.CTkFrame(stats_frame, fg_color="transparent")
            stat_item.pack(fill="x", padx=15, pady=2)
            
            ctk.CTkLabel(
                stat_item,
                text=stat_name,
                font=("SF Pro Text", 11),
                text_color=MODERN_THEME['text_secondary']
            ).pack(side="left")
            
            label = ctk.CTkLabel(
                stat_item,
                text="0",
                font=("SF Pro Display", 12, "bold"),
                text_color=color
            )
            label.pack(side="right")
            self.stats_labels[stat_key] = label
        
        # ë„êµ¬ ì„¹ì…˜
        tools_frame = ctk.CTkFrame(sidebar, fg_color=MODERN_THEME['surface'], corner_radius=10)
        tools_frame.grid(row=3, column=0, padx=20, pady=10, sticky="ew")
        
        ctk.CTkLabel(
            tools_frame,
            text="Available Tools",
            font=("SF Pro Display", 14, "bold"),
            text_color=MODERN_THEME['text']
        ).pack(pady=(10, 5))
        
        tools = ["ğŸ” Web Search", "ğŸ“ File System", "ğŸ’» Code Executor", "ğŸ—„ï¸ Database"]
        for tool in tools:
            ctk.CTkLabel(
                tools_frame,
                text=tool,
                font=("SF Pro Text", 11),
                text_color=MODERN_THEME['text_secondary']
            ).pack(padx=15, pady=2, anchor="w")
        
        # ì•¡ì…˜ ë²„íŠ¼ë“¤
        action_frame = ctk.CTkFrame(sidebar, fg_color="transparent")
        action_frame.grid(row=4, column=0, padx=20, pady=20, sticky="ew")
        
        ctk.CTkButton(
            action_frame,
            text="â• New Task",
            command=self.show_new_task_dialog,
            font=("SF Pro Display", 13, "bold"),
            height=40,
            corner_radius=8,
            fg_color=MODERN_THEME['primary'],
            hover_color=MODERN_THEME['hover']
        ).pack(fill="x", pady=5)
        
        ctk.CTkButton(
            action_frame,
            text="ğŸ“Š View Reports",
            command=self.show_reports,
            font=("SF Pro Display", 13, "bold"),
            height=40,
            corner_radius=8,
            fg_color=MODERN_THEME['secondary'],
            hover_color=MODERN_THEME['hover']
        ).pack(fill="x", pady=5)
        
        # ì„¤ì • ë²„íŠ¼
        ctk.CTkButton(
            sidebar,
            text="âš™ï¸ Settings",
            command=self.show_settings,
            font=("SF Pro Display", 12),
            height=35,
            corner_radius=8,
            fg_color="transparent",
            hover_color=MODERN_THEME['hover'],
            text_color=MODERN_THEME['text_secondary']
        ).grid(row=7, column=0, padx=20, pady=(0, 20), sticky="ew")
        
    def setup_main_area(self):
        """ë©”ì¸ ì˜ì—­ êµ¬ì„±"""
        main_frame = ctk.CTkFrame(self, fg_color=MODERN_THEME['light'])
        main_frame.grid(row=0, column=1, sticky="nsew", padx=(0, 0), pady=0)
        main_frame.grid_columnconfigure(0, weight=1)
        main_frame.grid_rowconfigure(1, weight=1)
        
        # í—¤ë”
        header_frame = ctk.CTkFrame(main_frame, height=80, fg_color=MODERN_THEME['surface'], corner_radius=0)
        header_frame.grid(row=0, column=0, sticky="ew", padx=0, pady=0)
        header_frame.grid_columnconfigure(1, weight=1)
        
        ctk.CTkLabel(
            header_frame,
            text="Task Console",
            font=("SF Pro Display", 24, "bold"),
            text_color=MODERN_THEME['text']
        ).grid(row=0, column=0, padx=30, pady=25)
        
        # ìƒíƒœ í‘œì‹œ
        self.status_label = ctk.CTkLabel(
            header_frame,
            text="ğŸŸ¢ System Online",
            font=("SF Pro Text", 14),
            text_color=MODERN_THEME['success']
        )
        self.status_label.grid(row=0, column=1, padx=30, pady=25, sticky="e")
        
        # íƒ­ ë·°
        self.tabview = ctk.CTkTabview(main_frame, corner_radius=10)
        self.tabview.grid(row=1, column=0, sticky="nsew", padx=20, pady=20)
        
        # ëŒ€í™” íƒ­
        chat_tab = self.tabview.add("ğŸ’¬ Chat")
        self.setup_chat_tab(chat_tab)
        
        # ì‘ì—… ëª¨ë‹ˆí„° íƒ­
        monitor_tab = self.tabview.add("ğŸ“Š Task Monitor")
        self.setup_monitor_tab(monitor_tab)
        
        # ë©”ëª¨ë¦¬ ë·° íƒ­
        memory_tab = self.tabview.add("ğŸ§  Agent Memory")
        self.setup_memory_tab(memory_tab)
        
    def setup_chat_tab(self, parent):
        """ëŒ€í™” íƒ­ ì„¤ì •"""
        parent.grid_columnconfigure(0, weight=1)
        parent.grid_rowconfigure(0, weight=1)
        
        # ëŒ€í™” ì˜ì—­
        self.chat_frame = ctk.CTkScrollableFrame(
            parent,
            fg_color=MODERN_THEME['surface'],
            corner_radius=10
        )
        self.chat_frame.grid(row=0, column=0, sticky="nsew", padx=10, pady=10)
        
        # ì…ë ¥ ì˜ì—­
        input_frame = ctk.CTkFrame(parent, fg_color="transparent", height=100)
        input_frame.grid(row=1, column=0, sticky="ew", padx=10, pady=(0, 10))
        input_frame.grid_columnconfigure(0, weight=1)
        
        self.input_box = ctk.CTkTextbox(
            input_frame,
            height=80,
            wrap="word",
            font=("SF Pro Text", 14),
            border_width=2,
            border_color=MODERN_THEME['border'],
            fg_color=MODERN_THEME['surface'],
            corner_radius=10
        )
        self.input_box.grid(row=0, column=0, sticky="ew", padx=(0, 10))
        self.input_box.bind("<Return>", self.handle_return)
        
        # ì „ì†¡ ë²„íŠ¼
        self.send_button = ctk.CTkButton(
            input_frame,
            text="Send Task",
            command=self.send_task,
            width=120,
            height=80,
            font=("SF Pro Display", 14, "bold"),
            corner_radius=10,
            fg_color=MODERN_THEME['primary'],
            hover_color=MODERN_THEME['hover']
        )
        self.send_button.grid(row=0, column=1)
        
    def setup_monitor_tab(self, parent):
        """ì‘ì—… ëª¨ë‹ˆí„° íƒ­ ì„¤ì •"""
        parent.grid_columnconfigure(0, weight=1)
        parent.grid_rowconfigure(0, weight=1)
        
        # ì‘ì—… ë¦¬ìŠ¤íŠ¸
        self.task_tree = ttk.Treeview(
            parent,
            columns=('ID', 'Title', 'Agent', 'Status', 'Priority', 'Created'),
            show='headings',
            height=20
        )
        
        # ì»¬ëŸ¼ ì„¤ì •
        columns = [
            ('ID', 80),
            ('Title', 250),
            ('Agent', 150),
            ('Status', 100),
            ('Priority', 80),
            ('Created', 150)
        ]
        
        for col, width in columns:
            self.task_tree.heading(col, text=col)
            self.task_tree.column(col, width=width)
        
        self.task_tree.grid(row=0, column=0, sticky="nsew", padx=10, pady=10)
        
        # ìŠ¤í¬ë¡¤ë°”
        scrollbar = ttk.Scrollbar(parent, orient="vertical", command=self.task_tree.yview)
        scrollbar.grid(row=0, column=1, sticky="ns", pady=10)
        self.task_tree.configure(yscrollcommand=scrollbar.set)
        
    def setup_memory_tab(self, parent):
        """ë©”ëª¨ë¦¬ ë·° íƒ­ ì„¤ì •"""
        parent.grid_columnconfigure(0, weight=1)
        parent.grid_rowconfigure(0, weight=1)
        
        self.memory_text = ctk.CTkTextbox(
            parent,
            font=("SF Pro Mono", 12),
            fg_color=MODERN_THEME['dark'],
            text_color=MODERN_THEME['light']
        )
        self.memory_text.grid(row=0, column=0, sticky="nsew", padx=10, pady=10)
        
    def add_system_message(self, message):
        """ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€"""
        container = ctk.CTkFrame(self.chat_frame, fg_color=MODERN_THEME['info'], corner_radius=10)
        container.pack(fill="x", padx=10, pady=5)
        
        ctk.CTkLabel(
            container,
            text=message,
            font=("SF Pro Text", 13),
            text_color="white",
            wraplength=800,
            justify="left"
        ).pack(padx=15, pady=10, anchor="w")
        
    def add_agent_message(self, agent_name, message):
        """ì—ì´ì „íŠ¸ ë©”ì‹œì§€ ì¶”ê°€"""
        container = ctk.CTkFrame(self.chat_frame, fg_color="#E0E7FF", corner_radius=10)
        container.pack(fill="x", padx=10, pady=5)
        
        # ì—ì´ì „íŠ¸ ì´ë¦„
        ctk.CTkLabel(
            container,
            text=f"ğŸ¤– {agent_name}",
            font=("SF Pro Display", 12, "bold"),
            text_color=MODERN_THEME['primary']
        ).pack(padx=15, pady=(10, 5), anchor="w")
        
        # ë©”ì‹œì§€
        ctk.CTkLabel(
            container,
            text=message,
            font=("SF Pro Text", 13),
            text_color=MODERN_THEME['text'],
            wraplength=800,
            justify="left"
        ).pack(padx=15, pady=(0, 10), anchor="w")
        
    def send_task(self):
        """ì‘ì—… ì „ì†¡"""
        task_description = self.input_box.get("0.0", "end").strip()
        
        if not task_description:
            return
            
        # ì…ë ¥ ì´ˆê¸°í™”
        self.input_box.delete("0.0", "end")
        
        # ì‘ì—… ìƒì„±
        task = Task(
            id=f"TASK-{datetime.now().strftime('%Y%m%d%H%M%S')}",
            title=task_description[:50],
            description=task_description,
            agent_type=AgentType.EXECUTOR,
            priority=5
        )
        
        # ì‘ì—… ì œì¶œ
        self.orchestrator.submit_task(task)
        
        # UI ì—…ë°ì´íŠ¸
        self.add_system_message(f"ğŸ“‹ ìƒˆ ì‘ì—… ì œì¶œ: {task.title}")
        self.update_task_monitor(task)
        self.update_stats()
        
    def update_task_monitor(self, task):
        """ì‘ì—… ëª¨ë‹ˆí„° ì—…ë°ì´íŠ¸"""
        self.task_tree.insert('', 'end', values=(
            task.id,
            task.title,
            task.agent_type.value,
            task.status.value,
            task.priority,
            task.created_at.strftime('%Y-%m-%d %H:%M')
        ))
        
    def update_stats(self):
        """í†µê³„ ì—…ë°ì´íŠ¸"""
        # ì‹¤ì œ í†µê³„ ê³„ì‚°
        stats = {
            'pending': sum(1 for t in self.orchestrator.task_queue.queue if t.status == TaskStatus.PENDING),
            'progress': 0,  # í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—…
            'completed': len(self.orchestrator.completed_tasks),
            'failed': sum(1 for t in self.orchestrator.completed_tasks if t.status == TaskStatus.FAILED)
        }
        
        for key, value in stats.items():
            if key in self.stats_labels:
                self.stats_labels[key].configure(text=str(value))
                
    def show_new_task_dialog(self):
        """ìƒˆ ì‘ì—… ëŒ€í™”ìƒì"""
        dialog = ctk.CTkToplevel(self)
        dialog.title("New Task")
        dialog.geometry("600x500")
        dialog.transient(self)
        dialog.grab_set()
        
        # ì¤‘ì•™ ë°°ì¹˜
        dialog.update_idletasks()
        width = dialog.winfo_width()
        height = dialog.winfo_height()
        x = (dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (dialog.winfo_screenheight() // 2) - (height // 2)
        dialog.geometry(f'+{x}+{y}')
        
        # ë‚´ìš©
        ctk.CTkLabel(
            dialog,
            text="Create New Task",
            font=("SF Pro Display", 20, "bold")
        ).pack(pady=(20, 10))
        
        # ì‘ì—… ì œëª©
        ctk.CTkLabel(dialog, text="Task Title:").pack(pady=(10, 5))
        title_entry = ctk.CTkEntry(dialog, width=400)
        title_entry.pack(pady=(0, 10))
        
        # ì‘ì—… ì„¤ëª…
        ctk.CTkLabel(dialog, text="Description:").pack(pady=(10, 5))
        desc_text = ctk.CTkTextbox(dialog, width=400, height=150)
        desc_text.pack(pady=(0, 10))
        
        # ì—ì´ì „íŠ¸ ì„ íƒ
        ctk.CTkLabel(dialog, text="Agent Type:").pack(pady=(10, 5))
        agent_var = ctk.StringVar(value=AgentType.EXECUTOR.value)
        agent_menu = ctk.CTkComboBox(
            dialog,
            values=[t.value for t in AgentType],
            variable=agent_var,
            width=400
        )
        agent_menu.pack(pady=(0, 10))
        
        # ìš°ì„ ìˆœìœ„
        ctk.CTkLabel(dialog, text="Priority (1-10):").pack(pady=(10, 5))
        priority_slider = ctk.CTkSlider(dialog, from_=1, to=10, width=400)
        priority_slider.set(5)
        priority_slider.pack(pady=(0, 20))
        
        # ë²„íŠ¼
        button_frame = ctk.CTkFrame(dialog, fg_color="transparent")
        button_frame.pack(pady=20)
        
        ctk.CTkButton(
            button_frame,
            text="Cancel",
            command=dialog.destroy,
            width=100,
            fg_color=MODERN_THEME['error']
        ).pack(side="left", padx=10)
        
        ctk.CTkButton(
            button_frame,
            text="Create",
            command=lambda: self.create_task_from_dialog(
                dialog,
                title_entry.get(),
                desc_text.get("0.0", "end"),
                agent_var.get(),
                int(priority_slider.get())
            ),
            width=100,
            fg_color=MODERN_THEME['success']
        ).pack(side="left", padx=10)
        
    def create_task_from_dialog(self, dialog, title, description, agent_type, priority):
        """ëŒ€í™”ìƒìì—ì„œ ì‘ì—… ìƒì„±"""
        if not title or not description:
            messagebox.showwarning("Warning", "Please fill in all fields")
            return
            
        task = Task(
            id=f"TASK-{datetime.now().strftime('%Y%m%d%H%M%S')}",
            title=title,
            description=description.strip(),
            agent_type=AgentType(agent_type),
            priority=priority
        )
        
        self.orchestrator.submit_task(task)
        self.add_system_message(f"ğŸ“‹ ìƒˆ ì‘ì—… ìƒì„±: {task.title}")
        self.update_task_monitor(task)
        self.update_stats()
        
        dialog.destroy()
        
    def show_reports(self):
        """ë¦¬í¬íŠ¸ ë³´ê¸°"""
        messagebox.showinfo("Reports", "ì‘ì—… ë¦¬í¬íŠ¸ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")
        
    def show_settings(self):
        """ì„¤ì • ë³´ê¸°"""
        messagebox.showinfo("Settings", "ì„¤ì • ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")
        
    def handle_return(self, event):
        """Enter í‚¤ ì²˜ë¦¬"""
        if event.state & 0x1:  # Shift key
            return None
        else:
            self.send_task()
            return "break"
            
    def on_closing(self):
        """ì•± ì¢…ë£Œ ì²˜ë¦¬"""
        self.orchestrator.stop()
        self.loop.call_soon_threadsafe(self.loop.stop)
        self.quit()
        self.destroy()

# ============= ë©”ì¸ ì‹¤í–‰ =============
if __name__ == "__main__":
    try:
        app = AgenticAIApp()
        app.protocol("WM_DELETE_WINDOW", app.on_closing)
        app.mainloop()
    except Exception as e:
        error_message = f"ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{str(e)}\n\n{traceback.format_exc()}"
        print(error_message)
        
        try:
            import tkinter as tk
            from tkinter import messagebox
            root = tk.Tk()
            root.withdraw()
            messagebox.showerror("ì˜¤ë¥˜", error_message)
            root.destroy()
        except:
            pass
        
        sys.exit(1)