function displayBatchResult(data) {
    const summary = data.summary;
    let html = `<div style="padding: 10px;">`;
    
    // ========================================
    // 1. ğŸ“Œ ìµœì¢… ê²°ë¡  (ë§¨ ìœ„ì—!)
    // ========================================
    const hasDelays = summary.delay_file_count > 0;
    const hasFails = summary.fail_count > 0;
    
    html += `<div style="background: ${hasDelays || hasFails ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)'}; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 5px solid ${hasDelays || hasFails ? '#f59e0b' : '#10b981'};">`;
    html += `<h2 style="margin: 0 0 15px 0; color: ${hasDelays || hasFails ? '#92400e' : '#065f46'};">ğŸ“Œ ìµœì¢… ê²°ë¡ </h2>`;
    
    if (hasFails) {
        html += `<div style="font-size: 18px; font-weight: 700; color: #dc2626; margin-bottom: 12px;">âš ï¸ ${summary.fail_count}ê°œ íŒŒì¼ ë¶„ì„ ì‹¤íŒ¨</div>`;
    }
    
    if (hasDelays) {
        html += `<div style="font-size: 18px; font-weight: 700; color: #92400e; margin-bottom: 12px;">ğŸ”´ ${summary.delay_file_count}ê°œ íŒŒì¼ì—ì„œ ì§€ì—° ë°œìƒ</div>`;
        
        html += `<div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">`;
        html += `<div style="font-weight: 600; margin-bottom: 10px;">ğŸ“ ì§€ì—° ë°œìƒ íŒŒì¼:</div>`;
        html += `<ul style="margin: 0; padding-left: 20px;">`;
        summary.delay_files.slice(0, 5).forEach(function(df) {
            html += `<li style="margin-bottom: 5px;"><strong>${df.filename}</strong> - ${df.total_duration_str}`;
            if (df.main_delay) {
                html += ` (${df.main_delay.segment}: ${df.main_delay.cause || 'ì†Œìš”ì‹œê°„ ì´ˆê³¼'})`;
            }
            html += `</li>`;
        });
        if (summary.delay_files.length > 5) {
            html += `<li style="color: #666;">... ì™¸ ${summary.delay_files.length - 5}ê°œ</li>`;
        }
        html += `</ul></div>`;
        
        html += `<div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">`;
        html += `<div style="font-weight: 600; margin-bottom: 10px;">ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜:</div>`;
        html += `<ul style="margin: 0; padding-left: 20px;">`;
        var allCauses = summary.delay_files.map(function(df) { return df.main_delay ? df.main_delay.cause || '' : ''; }).join(' ');
        if (allCauses.includes('HCACK') || allCauses.includes('OHT')) {
            html += `<li>OHT ì°¨ëŸ‰ ê°€ìš©ì„± ì ê²€ ë° Rail Cut ì—¬ë¶€ í™•ì¸</li>`;
        }
        if (allCauses.includes('Conveyor') || allCauses.includes('ì»¨ë² ì´ì–´')) {
            html += `<li>ì»¨ë² ì´ì–´ ì ì²´ êµ¬ê°„ ì ê²€</li>`;
        }
        if (allCauses.includes('Lifter') || allCauses.includes('í¬ë ˆì¸')) {
            html += `<li>Lifter í¬ë ˆì¸ ìƒíƒœ ì ê²€</li>`;
        }
        html += `<li>í•´ë‹¹ ì‹œê°„ëŒ€ ì‘ì—… ë¶€í•˜ ë¶„ì„</li>`;
        html += `</ul></div>`;
        
    } else if (!hasFails) {
        html += `<div style="font-size: 18px; font-weight: 700; color: #065f46; margin-bottom: 12px;">âœ… ì „ì²´ ${summary.success_count}ê°œ íŒŒì¼ ì •ìƒ ì™„ë£Œ</div>`;
        html += `<div style="color: #047857;">ëª¨ë“  ì´ì†¡ ì‘ì—…ì´ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
    }
    
    html += `</div>`;
    
    // ========================================
    // 2. ğŸ“Š ë°°ì¹˜ ë¶„ì„ ìš”ì•½
    // ========================================
    html += `<div class="batch-summary"><h3>ğŸ“Š ë°°ì¹˜ ë¶„ì„ ìš”ì•½ (${data.total_files}ê°œ íŒŒì¼)</h3>`;
    html += `<div class="batch-summary-grid">`;
    html += `<div class="batch-summary-item"><div class="value">${summary.success_count}</div><div class="label">âœ… ì„±ê³µ</div></div>`;
    html += `<div class="batch-summary-item"><div class="value">${summary.fail_count}</div><div class="label">âŒ ì‹¤íŒ¨</div></div>`;
    html += `<div class="batch-summary-item"><div class="value">${summary.delay_file_count}</div><div class="label">âš ï¸ ì§€ì—° ë°œìƒ</div></div>`;
    html += `<div class="batch-summary-item"><div class="value">${summary.total_duration_str || 'N/A'}</div><div class="label">â±ï¸ ì´ ì†Œìš”ì‹œê°„</div></div>`;
    html += `<div class="batch-summary-item"><div class="value">${summary.total_records ? summary.total_records.toLocaleString() : 0}</div><div class="label">ğŸ“‹ ì´ ë ˆì½”ë“œ</div></div>`;
    html += `</div>`;
    
    if (summary.equipment_distribution && Object.keys(summary.equipment_distribution).length > 0) {
        html += `<div style="margin-top: 15px;"><strong>ì„¤ë¹„ ë¶„í¬:</strong> `;
        Object.entries(summary.equipment_distribution).forEach(function(entry) {
            var k = entry[0], v = entry[1];
            var color = EQUIP_COLORS[k] || '#666';
            html += `<span class="equip-badge" style="background: ${color}22; color: ${color}; margin: 2px;">${k}: ${v}</span>`;
        });
        html += `</div>`;
    }
    html += `</div>`;
    
    // ========================================
    // 3. ğŸ” ê°œë³„ ë¶„ì„ ê²°ê³¼
    // ========================================
    html += `<h3 style="margin: 20px 0 15px 0;">ğŸ” ê°œë³„ ë¶„ì„ ê²°ê³¼</h3>`;
    data.results.forEach(function(r, i) {
        var equipColor = EQUIP_COLORS[r.equipment_type] || EQUIP_COLORS['UNKNOWN'];
        var hasDelay = r.preprocess_details && r.preprocess_details.delays && r.preprocess_details.delays.length > 0;
        var statusClass = !r.success ? 'error' : (hasDelay ? 'delay' : 'success');
        var statusText = !r.success ? 'âŒ ì‹¤íŒ¨' : (hasDelay ? 'âš ï¸ ì§€ì—°' : 'âœ… ì •ìƒ');
        
        html += `<div class="batch-result-item">`;
        html += `<div class="batch-result-header" onclick="toggleBatchDetail(${i})">`;
        html += `<span class="order">${r.order || i+1}</span>`;
        html += `<span class="filename">${r.filename}</span>`;
        if (r.success) html += `<span class="equip-badge" style="background: ${equipColor}22; color: ${equipColor};">${r.equipment_type}</span>`;
        html += `<span class="status-badge ${statusClass}">${statusText}</span>`;
        html += `<span class="expand-icon" id="expand-${i}">â–¼</span>`;
        html += `</div>`;
        html += `<div class="batch-result-body" id="detail-${i}">`;
        
        if (r.success) {
            if (hasDelay) {
                html += `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; margin-bottom: 15px;">`;
                html += `<strong>âš ï¸ ì§€ì—° ë°œìƒ:</strong> ${r.preprocess_details.delays.map(function(d) { return d.segment; }).join(', ')}`;
                html += `</div>`;
            }
            html += `<div class="markdown-content">${marked.parse(r.analysis || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ')}</div>`;
        } else {
            html += `<div style="color: #dc2626;">ì˜¤ë¥˜: ${r.error}</div>`;
        }
        html += `</div></div>`;
    });
    
    html += `</div>`;
    resultDiv.innerHTML = html;
    resultDiv.className = 'success';
    
    var summaryText = 'ë°°ì¹˜ ë¶„ì„ ì™„ë£Œ: ' + summary.success_count + '/' + data.total_files + ' ì„±ê³µ, ' + summary.delay_file_count + 'ê°œ ì§€ì—°';
    addToHistory('[ë°°ì¹˜] ' + data.total_files + 'ê°œ íŒŒì¼', summaryText, 'batch');
}



#######-----------
function displaySingleResult(data) {
    var equipColor = EQUIP_COLORS[data.equipment_type] || EQUIP_COLORS['UNKNOWN'];
    var preprocess = data.preprocess_details || {};
    var hasDelay = preprocess.delays && preprocess.delays.length > 0;
    var totalDuration = preprocess.total_duration_sec || 0;
    
    // ì†Œìš”ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatDur(seconds) {
        if (!seconds || seconds < 0) return 'N/A';
        if (seconds < 60) return Math.round(seconds) + 'ì´ˆ';
        if (seconds < 3600) {
            var mins = Math.floor(seconds / 60);
            var secs = Math.round(seconds % 60);
            return mins + 'ë¶„ ' + secs + 'ì´ˆ';
        }
        var hours = Math.floor(seconds / 3600);
        var mins2 = Math.floor((seconds % 3600) / 60);
        return hours + 'ì‹œê°„ ' + mins2 + 'ë¶„';
    }
    
    var html = '<div style="padding: 10px;">';
    
    // ========================================
    // 1. ğŸ“Œ ìµœì¢… ê²°ë¡  (ë§¨ ìœ„!)
    // ========================================
    html += '<div style="background: ' + (hasDelay ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)') + '; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 5px solid ' + (hasDelay ? '#f59e0b' : '#10b981') + ';">';
    html += '<h2 style="margin: 0 0 15px 0; color: ' + (hasDelay ? '#92400e' : '#065f46') + ';">ğŸ“Œ ìµœì¢… ê²°ë¡ </h2>';
    
    if (hasDelay) {
        html += '<div style="font-size: 18px; font-weight: 700; color: #92400e; margin-bottom: 12px;">ğŸ”´ ì§€ì—° ë°œìƒ - ì´ ì†Œìš”ì‹œê°„: ' + formatDur(totalDuration) + '</div>';
        
        // ì§€ì—° êµ¬ê°„ ìƒì„¸
        html += '<div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">';
        html += '<div style="font-weight: 600; margin-bottom: 10px;">ğŸ“ ì§€ì—° êµ¬ê°„:</div>';
        html += '<ul style="margin: 0; padding-left: 20px;">';
        preprocess.delays.forEach(function(d) {
            html += '<li style="margin-bottom: 5px;"><strong>' + d.segment + '</strong>: ' + d.duration_str;
            if (d.cause) html += ' - ' + d.cause;
            html += '</li>';
        });
        html += '</ul></div>';
        
        // ê¶Œì¥ ì¡°ì¹˜
        html += '<div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">';
        html += '<div style="font-weight: 600; margin-bottom: 10px;">ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜:</div>';
        html += '<ul style="margin: 0; padding-left: 20px;">';
        
        var allCauses = preprocess.delays.map(function(d) { return d.cause || ''; }).join(' ');
        if (allCauses.includes('HCACK') || allCauses.includes('OHT') || allCauses.includes('Vehicle')) {
            html += '<li>OHT ì°¨ëŸ‰ ê°€ìš©ì„± ì ê²€ ë° Rail Cut ì—¬ë¶€ í™•ì¸</li>';
        }
        if (allCauses.includes('Conveyor') || allCauses.includes('ì»¨ë² ì´ì–´') || allCauses.includes('ì ì²´')) {
            html += '<li>ì»¨ë² ì´ì–´ ì ì²´ êµ¬ê°„ ë° ì„¼ì„œ ì ê²€</li>';
        }
        if (allCauses.includes('Lifter') || allCauses.includes('í¬ë ˆì¸') || allCauses.includes('ì¸µê°„')) {
            html += '<li>Lifter í¬ë ˆì¸ ìƒíƒœ ì ê²€</li>';
        }
        if (allCauses.includes('í¬íŠ¸') || allCauses.includes('ì ìœ ')) {
            html += '<li>í¬íŠ¸ ì ìœ  ìƒíƒœ ë° ì‘ì—… ìŠ¤ì¼€ì¤„ í™•ì¸</li>';
        }
        html += '<li>í•´ë‹¹ ì‹œê°„ëŒ€ ì „ì²´ ì‘ì—… ë¶€í•˜ ë¶„ì„</li>';
        html += '</ul></div>';
        
    } else {
        html += '<div style="font-size: 18px; font-weight: 700; color: #065f46; margin-bottom: 12px;">âœ… ì •ìƒ ì™„ë£Œ</div>';
        if (totalDuration > 0) {
            html += '<div style="color: #047857;">ì´ ì†Œìš”ì‹œê°„: ' + formatDur(totalDuration) + ' - ì •ìƒ ë²”ìœ„ ë‚´ ì™„ë£Œ</div>';
        } else {
            html += '<div style="color: #047857;">ì´ì†¡ ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    // ìºë¦¬ì–´/LOT ì •ë³´
    if (preprocess.carrier_id || preprocess.lot_id) {
        html += '<div style="margin-top: 12px; font-size: 14px; color: #666;">';
        if (preprocess.carrier_id) html += '<span style="margin-right: 15px;">ğŸ“¦ ìºë¦¬ì–´: <strong>' + preprocess.carrier_id + '</strong></span>';
        if (preprocess.lot_id) html += '<span>ğŸ·ï¸ LOT: <strong>' + preprocess.lot_id + '</strong></span>';
        html += '</div>';
    }
    
    html += '</div>';
    
    // ========================================
    // 2. ğŸ“Š íŒŒì¼ ì •ë³´
    // ========================================
    html += '<div style="background: #f0fdf4; padding: 15px; border-radius: 10px; border-left: 4px solid #22c55e; margin-bottom: 20px;">';
    html += '<h3 style="color: #15803d; margin: 0 0 10px 0;">ğŸ“Š íŒŒì¼ ì •ë³´ <span class="equip-badge" style="background: ' + equipColor + '22; color: ' + equipColor + '; margin-left: 10px;">ğŸ”§ ' + data.equipment_type + '</span></h3>';
    html += '<div style="font-size: 14px; display: flex; flex-wrap: wrap; gap: 15px;">';
    html += '<span><strong>íŒŒì¼ëª…:</strong> ' + (data.filename || 'N/A') + '</span>';
    html += '<span><strong>ë ˆì½”ë“œ:</strong> ' + (data.basic_info ? data.basic_info.row_count : 0) + 'ê±´</span>';
    if (data.basic_info && data.basic_info.time_range && data.basic_info.time_range.start) {
        html += '<span><strong>ì‹œê°„:</strong> ' + data.basic_info.time_range.start + ' ~ ' + data.basic_info.time_range.end + '</span>';
    }
    html += '</div>';
    
    // ì„¤ë¹„ë³„ ì¶”ê°€ ì •ë³´
    if (data.equipment_type === 'OHT' && preprocess.vehicle_id) {
        html += '<div style="margin-top: 8px; font-size: 13px; color: #666;">ğŸšƒ ì°¨ëŸ‰: ' + preprocess.vehicle_id + ' | ê²½ë¡œ: ' + (preprocess.source_port || 'N/A') + ' â†’ ' + (preprocess.dest_port || 'N/A') + '</div>';
    } else if (data.equipment_type === 'CONVEYOR' && preprocess.machine_name) {
        html += '<div style="margin-top: 8px; font-size: 13px; color: #666;">ğŸ”„ ì¥ë¹„: ' + preprocess.machine_name + ' | Zone: ' + (preprocess.source_zone || 'N/A') + ' â†’ ' + (preprocess.dest_zone || 'N/A') + '</div>';
    } else if (data.equipment_type === 'LIFTER' && preprocess.machine_name) {
        html += '<div style="margin-top: 8px; font-size: 13px; color: #666;">ğŸ—ï¸ ì¥ë¹„: ' + preprocess.machine_name + ' | ì¸µ: ' + (preprocess.source_floor || 'N/A') + ' â†’ ' + (preprocess.dest_floor || 'N/A') + '</div>';
    } else if (data.equipment_type === 'FABJOB' && preprocess.hcack_errors > 0) {
        html += '<div style="margin-top: 8px; font-size: 13px; color: #dc2626;">âš ï¸ HCACK=2 ê±°ì ˆ: ' + preprocess.hcack_errors + 'íšŒ ë°œìƒ</div>';
    }
    
    html += '</div>';
    
    // ========================================
    // 3. ğŸ¤– AI ë¶„ì„ ê²°ê³¼
    // ========================================
    html += '<div style="background: #faf5ff; padding: 20px; border-radius: 10px; border-left: 4px solid #a855f7;">';
    html += '<h3 style="color: #7e22ce; margin: 0 0 15px 0;">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>';
    html += '<div class="markdown-content">' + marked.parse(data.analysis || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ') + '</div>';
    html += '</div>';
    
    html += '</div>';
    
    resultDiv.innerHTML = html;
    resultDiv.className = 'success';
    addToHistory('[' + data.equipment_type + '] ' + data.filename, data.analysis, 'amhs');
}