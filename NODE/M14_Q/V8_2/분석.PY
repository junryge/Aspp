#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š ì „ì²´ ì»¬ëŸ¼ ë¶„ì„ ì½”ë“œ
ë‹¹ì‹ ì˜ CSV íŒŒì¼ì„ ë¶„ì„í•´ì„œ ì–´ë–¤ ì»¬ëŸ¼ì„ ì‚¬ìš©í• ì§€ ê²°ì •í•©ë‹ˆë‹¤
"""

import pandas as pd
import numpy as np
import warnings
warnings.filterwarnings('ignore')

# ========================================
# 1. CSV íŒŒì¼ ê²½ë¡œ ì„¤ì • (ì—¬ê¸°ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”!)
# ========================================
CSV_FILE = "ë‹¹ì‹ ì˜íŒŒì¼.csv"  # â† ì—¬ê¸°ì— íŒŒì¼ ê²½ë¡œë¥¼ ë„£ìœ¼ì„¸ìš”!

print("="*100)
print(" "*30 + "ğŸ“Š ì „ì²´ ì»¬ëŸ¼ ë¶„ì„ ì‹œì‘")
print("="*100)

# ========================================
# 2. ë°ì´í„° ë¡œë“œ
# ========================================
print(f"\nğŸ“‚ íŒŒì¼ ë¡œë”©: {CSV_FILE}")
try:
    df = pd.read_csv(CSV_FILE)
    print(f"âœ… ë¡œë“œ ì„±ê³µ: {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")
except Exception as e:
    print(f"âŒ ì—ëŸ¬: {e}")
    exit(1)

# ========================================
# 3. ê¸°ë³¸ ì •ë³´
# ========================================
print(f"\n" + "="*100)
print("ğŸ“‹ ê¸°ë³¸ ì •ë³´")
print("="*100)
print(f"ë°ì´í„° í¬ê¸°: {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")
if 'CURRTIME' in df.columns:
    print(f"ë°ì´í„° ê¸°ê°„: {df['CURRTIME'].min()} ~ {df['CURRTIME'].max()}")
if 'TOTALCNT' in df.columns:
    print(f"TOTALCNT ë²”ìœ„: {df['TOTALCNT'].min():.0f} ~ {df['TOTALCNT'].max():.0f}")
    print(f"1700+ êµ¬ê°„: {(df['TOTALCNT']>=1700).sum():,}ê°œ ({(df['TOTALCNT']>=1700).sum()/len(df)*100:.2f}%)")

# ========================================
# 4. ì „ì²´ ì»¬ëŸ¼ ëª©ë¡
# ========================================
print(f"\n" + "="*100)
print(f"ğŸ“‹ ì „ì²´ ì»¬ëŸ¼ ëª©ë¡ ({len(df.columns)}ê°œ)")
print("="*100)
for i, col in enumerate(df.columns, 1):
    dtype = df[col].dtype
    null_count = df[col].isna().sum()
    null_pct = null_count / len(df) * 100
    print(f"{i:3d}. {col:<55s} {str(dtype):<10s} (ê²°ì¸¡:{null_count:4d}, {null_pct:5.1f}%)")

# ========================================
# 5. ì»¬ëŸ¼ë³„ ìƒì„¸ í†µê³„
# ========================================
print(f"\n" + "="*100)
print("ğŸ“Š ì»¬ëŸ¼ë³„ ìƒì„¸ í†µê³„ (ìˆ«ìí˜• ì»¬ëŸ¼ë§Œ)")
print("="*100)

column_stats = []

for col in df.columns:
    if df[col].dtype in ['int64', 'float64']:
        stats = {
            'ì»¬ëŸ¼ëª…': col,
            'í‰ê· ': df[col].mean(),
            'í‘œì¤€í¸ì°¨': df[col].std(),
            'ìµœì†Œ': df[col].min(),
            'ìµœëŒ€': df[col].max(),
            'ê²°ì¸¡': df[col].isna().sum(),
            'ê³ ìœ ê°’': df[col].nunique(),
        }
        
        # ë³€ë™ê³„ìˆ˜ (CV)
        if stats['í‰ê· '] != 0:
            stats['ë³€ë™ê³„ìˆ˜'] = stats['í‘œì¤€í¸ì°¨'] / abs(stats['í‰ê· '])
        else:
            stats['ë³€ë™ê³„ìˆ˜'] = 0
        
        # TOTALCNTì™€ ìƒê´€ê´€ê³„
        if 'TOTALCNT' in df.columns and col != 'TOTALCNT':
            try:
                corr = df[[col, 'TOTALCNT']].corr().iloc[0,1]
                stats['TOTALCNTìƒê´€'] = corr if not np.isnan(corr) else 0
            except:
                stats['TOTALCNTìƒê´€'] = 0
        else:
            stats['TOTALCNTìƒê´€'] = 1.0 if col == 'TOTALCNT' else 0
        
        column_stats.append(stats)

stats_df = pd.DataFrame(column_stats)

# ìƒê´€ê´€ê³„ ìˆœìœ¼ë¡œ ì •ë ¬
stats_df = stats_df.sort_values('TOTALCNTìƒê´€', key=lambda x: abs(x), ascending=False)

print(f"\n{'ìˆœìœ„':<4} {'ì»¬ëŸ¼ëª…':<50} {'ìƒê´€ê³„ìˆ˜':>10} {'ë³€ë™ê³„ìˆ˜':>10} {'í‰ê· ':>15} {'ë²”ìœ„':>20}")
print("-"*100)

for idx, (_, row) in enumerate(stats_df.head(40).iterrows(), 1):
    col_name = row['ì»¬ëŸ¼ëª…']
    corr = row['TOTALCNTìƒê´€']
    cv = row['ë³€ë™ê³„ìˆ˜']
    mean = row['í‰ê· ']
    range_str = f"{row['ìµœì†Œ']:.0f}~{row['ìµœëŒ€']:.0f}"
    
    # ì¤‘ìš”ë„ í‘œì‹œ
    if abs(corr) > 0.5:
        marker = "â­â­â­"
    elif abs(corr) > 0.3:
        marker = "â­â­"
    elif abs(corr) > 0.15:
        marker = "â­"
    else:
        marker = ""
    
    print(f"{idx:2d}. {col_name:<48s} {corr:>+10.4f} {cv:>10.3f} {mean:>15.1f} {range_str:>20s} {marker}")

# ========================================
# 6. 1700+ êµ¬ê°„ ì„ í–‰ ì§€í‘œ ë¶„ì„
# ========================================
if 'TOTALCNT' in df.columns:
    print(f"\n" + "="*100)
    print("ğŸ”¥ 1700+ ìœ„í—˜ êµ¬ê°„ ì„ í–‰ ì§€í‘œ ë¶„ì„ (30ë¶„ ì „)")
    print("="*100)
    
    high_risk = df[df['TOTALCNT'] >= 1700].index.tolist()
    print(f"1700+ êµ¬ê°„: {len(high_risk):,}ê°œ ({len(high_risk)/len(df)*100:.2f}%)\n")
    
    if len(high_risk) > 0:
        print(f"{'ì»¬ëŸ¼ëª…':<50} {'1700+ì§ì „':>12} {'ì „ì²´í‰ê· ':>12} {'ë°°ìœ¨':>8} {'ìƒê´€':>8}")
        print("-"*100)
        
        lead_results = []
        
        for col in df.columns:
            if df[col].dtype in ['int64', 'float64'] and col not in ['CURRTIME', 'CURRTIME.1', 'TIME', 'TOTALCNT']:
                lead_vals = []
                for idx in high_risk:
                    if idx >= 30:
                        lead_vals.append(df[col].iloc[idx-30:idx].mean())
                
                if len(lead_vals) > 0 and df[col].mean() != 0:
                    lead_avg = np.mean(lead_vals)
                    overall_avg = df[col].mean()
                    ratio = lead_avg / overall_avg
                    corr = abs(stats_df[stats_df['ì»¬ëŸ¼ëª…']==col]['TOTALCNTìƒê´€'].values[0]) if col in stats_df['ì»¬ëŸ¼ëª…'].values else 0
                    
                    lead_results.append({
                        'ì»¬ëŸ¼': col,
                        '1700+ì§ì „': lead_avg,
                        'ì „ì²´í‰ê· ': overall_avg,
                        'ë°°ìœ¨': ratio,
                        'ìƒê´€': corr
                    })
        
        lead_df = pd.DataFrame(lead_results).sort_values('ë°°ìœ¨', ascending=False)
        
        for idx, row in lead_df.head(30).iterrows():
            marker = "ğŸ”¥" if row['ë°°ìœ¨'] > 1.5 else ("âš ï¸" if row['ë°°ìœ¨'] > 1.2 else "")
            print(f"{row['ì»¬ëŸ¼']:<50s} {row['1700+ì§ì „']:>12.1f} {row['ì „ì²´í‰ê· ']:>12.1f} {row['ë°°ìœ¨']:>8.2f}x {row['ìƒê´€']:>7.3f} {marker}")

# ========================================
# 7. ì œì™¸ ê¶Œì¥ ì»¬ëŸ¼
# ========================================
print(f"\n" + "="*100)
print("âŒ ì œì™¸ ê¶Œì¥ ì»¬ëŸ¼")
print("="*100)

# ìƒìˆ˜ ì»¬ëŸ¼
print("\nã€ìƒìˆ˜ ì»¬ëŸ¼ã€‘ (ë³€ë™ ì—†ìŒ)")
constant_cols = stats_df[stats_df['ê³ ìœ ê°’'] == 1]
if len(constant_cols) > 0:
    for _, row in constant_cols.iterrows():
        print(f"  â€¢ {row['ì»¬ëŸ¼ëª…']:<50s} (ê°’: {row['í‰ê· ']:.1f})")
else:
    print("  ì—†ìŒ")

# ì¤‘ë³µ ì»¬ëŸ¼
print("\nã€ì¤‘ë³µ ì»¬ëŸ¼ã€‘")
if 'CURRTIME' in df.columns and 'CURRTIME.1' in df.columns:
    if (df['CURRTIME'] == df['CURRTIME.1']).all():
        print("  â€¢ CURRTIME.1 (CURRTIMEê³¼ 100% ë™ì¼)")
if 'TIME' in df.columns:
    print("  â€¢ TIME (CURRTIMEê³¼ ìœ ì‚¬)")

# ì €ë³€ë™/ì €ìƒê´€
print("\nã€ì €ë³€ë™/ì €ìƒê´€ ì»¬ëŸ¼ã€‘ (ë³€ë™ê³„ìˆ˜<0.1 AND ìƒê´€<0.1)")
low_cols = stats_df[(stats_df['ë³€ë™ê³„ìˆ˜'] < 0.1) & (abs(stats_df['TOTALCNTìƒê´€']) < 0.1)]
low_cols = low_cols[~low_cols['ì»¬ëŸ¼ëª…'].isin(['CURRTIME', 'CURRTIME.1', 'TIME', 'TOTALCNT'])]
if len(low_cols) > 0:
    for _, row in low_cols.iterrows():
        print(f"  â€¢ {row['ì»¬ëŸ¼ëª…']}")
else:
    print("  ì—†ìŒ")

# ========================================
# 8. ì¶”ì²œ ì»¬ëŸ¼ ì„¸íŠ¸
# ========================================
print(f"\n" + "="*100)
print("âœ… ì¶”ì²œ ì»¬ëŸ¼ ì„¸íŠ¸")
print("="*100)

# ìƒê´€ê´€ê³„ 0.15 ì´ìƒ
high_corr = stats_df[abs(stats_df['TOTALCNTìƒê´€']) >= 0.15]
high_corr = high_corr[~high_corr['ì»¬ëŸ¼ëª…'].isin(['CURRTIME.1', 'TIME', 'TOTALCNT'])]

print(f"\nã€ë†’ì€ ìƒê´€ê´€ê³„ ì»¬ëŸ¼ã€‘ (|ìƒê´€| â‰¥ 0.15) - {len(high_corr)}ê°œ")
for idx, (_, row) in enumerate(high_corr.iterrows(), 1):
    print(f"  {idx:2d}. {row['ì»¬ëŸ¼ëª…']:<50s} ìƒê´€:{row['TOTALCNTìƒê´€']:>+7.3f}")

# ========================================
# 9. CSV ì €ì¥
# ========================================
output_file = "ì»¬ëŸ¼ë¶„ì„ê²°ê³¼.csv"
stats_df.to_csv(output_file, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ê²°ê³¼ ì €ì¥: {output_file}")

# ========================================
# 10. ìµœì¢… ìš”ì•½
# ========================================
print(f"\n" + "="*100)
print("ğŸ“Š ìµœì¢… ìš”ì•½")
print("="*100)
print(f"ì´ ì»¬ëŸ¼ ìˆ˜: {len(df.columns)}ê°œ")
print(f"ìˆ«ìí˜• ì»¬ëŸ¼: {len(stats_df)}ê°œ")
print(f"ìƒìˆ˜ ì»¬ëŸ¼: {len(constant_cols)}ê°œ")
print(f"ë†’ì€ ìƒê´€ ì»¬ëŸ¼ (|r|â‰¥0.15): {len(high_corr)}ê°œ")
if 'TOTALCNT' in df.columns:
    print(f"1700+ êµ¬ê°„: {(df['TOTALCNT']>=1700).sum():,}ê°œ")
print(f"\nâœ… ë¶„ì„ ì™„ë£Œ!")
print("="*100)