#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š ì „ì²´ ì»¬ëŸ¼ ìƒì„¸ ë¶„ì„ ì½”ë“œ (ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ í¬í•¨)
"""

import pandas as pd
import numpy as np
import warnings
warnings.filterwarnings('ignore')

# ========================================
# CSV íŒŒì¼ ê²½ë¡œ (ìˆ˜ì •í•˜ì„¸ìš”!)
# ========================================
CSV_FILE = "ë‹¹ì‹ ì˜íŒŒì¼.csv"

print("="*120)
print(" "*40 + "ğŸ“Š ì „ì²´ ì»¬ëŸ¼ ìƒì„¸ ë¶„ì„")
print("="*120)

# ë°ì´í„° ë¡œë“œ
print(f"\nğŸ“‚ íŒŒì¼ ë¡œë”©: {CSV_FILE}")
df = pd.read_csv(CSV_FILE)
print(f"âœ… {len(df):,}í–‰ Ã— {df.shape[1]}ì—´\n")

# ê¸°ë³¸ ì •ë³´
if 'CURRTIME' in df.columns:
    print(f"ê¸°ê°„: {df['CURRTIME'].min()} ~ {df['CURRTIME'].max()}")
if 'TOTALCNT' in df.columns:
    print(f"TOTALCNT: {df['TOTALCNT'].min():.0f} ~ {df['TOTALCNT'].max():.0f}")
    print(f"1700+ êµ¬ê°„: {(df['TOTALCNT']>=1700).sum():,}ê°œ ({(df['TOTALCNT']>=1700).sum()/len(df)*100:.3f}%)")

# ========================================
# ì»¬ëŸ¼ í†µê³„ ê³„ì‚°
# ========================================
print(f"\n" + "="*120)
print("ğŸ” ì»¬ëŸ¼ë³„ í†µê³„ ê³„ì‚° ì¤‘...")
print("="*120)

stats_list = []

for col in df.columns:
    if df[col].dtype in ['int64', 'float64']:
        mean_val = df[col].mean()
        std_val = df[col].std()
        
        stat = {
            'ì»¬ëŸ¼ëª…': col,
            'í‰ê· ': mean_val,
            'í‘œì¤€í¸ì°¨': std_val,
            'ìµœì†Œ': df[col].min(),
            'ìµœëŒ€': df[col].max(),
            'ê²°ì¸¡': df[col].isna().sum(),
            'ê³ ìœ ê°’': df[col].nunique(),
            'ë³€ë™ê³„ìˆ˜': std_val / (abs(mean_val) + 0.0001),
        }
        
        # TOTALCNT ìƒê´€ê´€ê³„
        if 'TOTALCNT' in df.columns and col != 'TOTALCNT':
            try:
                corr = df[[col, 'TOTALCNT']].corr().iloc[0,1]
                stat['ìƒê´€'] = corr if not np.isnan(corr) else 0
            except:
                stat['ìƒê´€'] = 0
        else:
            stat['ìƒê´€'] = 1.0 if col == 'TOTALCNT' else 0
        
        stats_list.append(stat)

stats_df = pd.DataFrame(stats_list)

# ========================================
# TOP ì»¬ëŸ¼ ì¶œë ¥
# ========================================
print(f"\n" + "="*120)
print("ğŸ¯ TOTALCNT ìƒê´€ê´€ê³„ TOP 40")
print("="*120)
print(f"{'ìˆœìœ„':<4} {'ì»¬ëŸ¼ëª…':<55} {'ìƒê´€':>8} {'ë³€ë™':>8} {'í‰ê· ':>12} {'ë²”ìœ„':>18} {'ì¤‘ìš”ë„':>6}")
print("-"*120)

sorted_stats = stats_df.sort_values('ìƒê´€', key=lambda x: abs(x), ascending=False)

for idx, (_, row) in enumerate(sorted_stats.head(40).iterrows(), 1):
    marker = "â­â­â­" if abs(row['ìƒê´€']) > 0.5 else ("â­â­" if abs(row['ìƒê´€']) > 0.3 else ("â­" if abs(row['ìƒê´€']) > 0.15 else ""))
    range_str = f"{row['ìµœì†Œ']:.0f}~{row['ìµœëŒ€']:.0f}"
    print(f"{idx:2d}. {row['ì»¬ëŸ¼ëª…']:<53s} {row['ìƒê´€']:>+8.3f} {row['ë³€ë™ê³„ìˆ˜']:>8.3f} {row['í‰ê· ']:>12.1f} {range_str:>18s} {marker:>6s}")

# ========================================
# ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
# ========================================
print(f"\n" + "="*120)
print("ğŸ“‚ ì»¬ëŸ¼ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜")
print("="*120)

categories = {}

for col in df.columns:
    if 'TIME' in col and col != 'TRANSPORT':
        cat = 'â° ì‹œê°„'
    elif col == 'TOTALCNT':
        cat = 'ğŸ¯ íƒ€ê²Ÿ'
    elif 'M14AM14B' in col or 'M14AM10A' in col or 'M14AM16' in col:
        cat = 'ğŸ“¤ ë¬¼ë¥˜_ìˆœë°©í–¥'
    elif 'M14BM14A' in col or 'M10AM14A' in col or 'M16M14A' in col:
        cat = 'ğŸ“¥ ë¬¼ë¥˜_ì—­ë°©í–¥'
    elif 'SUM' in col:
        cat = 'ğŸ“Š ë¬¼ë¥˜_í•©ê³„'
    elif 'M10A.QUE' in col:
        cat = 'ğŸ­ M10Aíì •ë³´'
    elif 'M14.QUE' in col or 'M14B.QUE' in col:
        cat = 'ğŸ”§ M14íê´€ë¦¬'
    elif 'ALLALL_CD' in col:
        cat = 'ğŸ’¾ ì €ì¥ì†Œ_CD'
    elif 'M14M16_CD' in col or 'M10M16_CD' in col:
        cat = 'ğŸ”€ M14M16_CD'
    elif 'M16M14_CD' in col or 'M16M10_CD' in col:
        cat = 'ğŸ” M16M14_CD'
    else:
        cat = 'â“ ê¸°íƒ€'
    
    if cat not in categories:
        categories[cat] = []
    categories[cat].append(col)

for cat_name in sorted(categories.keys()):
    cols = categories[cat_name]
    print(f"\n{cat_name} ({len(cols)}ê°œ)")
    for col in cols:
        if col in stats_df['ì»¬ëŸ¼ëª…'].values:
            row = stats_df[stats_df['ì»¬ëŸ¼ëª…']==col].iloc[0]
            print(f"  â€¢ {col:<55s} ìƒê´€:{row['ìƒê´€']:>+7.3f}  ë³€ë™:{row['ë³€ë™ê³„ìˆ˜']:>6.3f}")
        else:
            print(f"  â€¢ {col}")

# ========================================
# 1700+ ì„ í–‰ ì§€í‘œ
# ========================================
if 'TOTALCNT' in df.columns:
    print(f"\n" + "="*120)
    print("ğŸ”¥ 1700+ ìœ„í—˜ êµ¬ê°„ ì„ í–‰ ì§€í‘œ (30ë¶„ ì „ í‰ê·  ë¹„êµ)")
    print("="*120)
    
    high_idx = df[df['TOTALCNT'] >= 1700].index.tolist()
    print(f"1700+ ë°œìƒ: {len(high_idx):,}íšŒ\n")
    
    if len(high_idx) > 0:
        print(f"{'ì»¬ëŸ¼ëª…':<55} {'1700+ì§ì „':>12} {'ì „ì²´í‰ê· ':>12} {'ë°°ìœ¨':>8} {'ìƒê´€':>8}")
        print("-"*120)
        
        lead_list = []
        for col in df.columns:
            if df[col].dtype in ['int64', 'float64'] and col not in ['CURRTIME', 'CURRTIME.1', 'TIME', 'TOTALCNT']:
                vals_30min = []
                for idx in high_idx:
                    if idx >= 30:
                        vals_30min.append(df[col].iloc[idx-30:idx].mean())
                
                if len(vals_30min) > 0 and df[col].mean() != 0:
                    avg_30 = np.mean(vals_30min)
                    avg_all = df[col].mean()
                    ratio = avg_30 / avg_all
                    corr_val = stats_df[stats_df['ì»¬ëŸ¼ëª…']==col]['ìƒê´€'].values[0] if col in stats_df['ì»¬ëŸ¼ëª…'].values else 0
                    
                    lead_list.append({
                        'col': col,
                        'lead': avg_30,
                        'avg': avg_all,
                        'ratio': ratio,
                        'corr': abs(corr_val)
                    })
        
        lead_df = pd.DataFrame(lead_list).sort_values('ratio', ascending=False)
        
        for i, r in lead_df.head(25).iterrows():
            mark = "ğŸ”¥" if r['ratio'] > 1.5 else ("âš ï¸" if r['ratio'] > 1.2 else "")
            print(f"{r['col']:<55s} {r['lead']:>12.1f} {r['avg']:>12.1f} {r['ratio']:>8.2f}x {r['corr']:>7.3f} {mark}")

# ========================================
# ì œì™¸ ê¶Œì¥
# ========================================
print(f"\n" + "="*120)
print("âŒ ì œì™¸ ê¶Œì¥ ì»¬ëŸ¼")
print("="*120)

print("\nã€ìƒìˆ˜ã€‘")
for _, r in stats_df[stats_df['ê³ ìœ ê°’']==1].iterrows():
    print(f"  â€¢ {r['ì»¬ëŸ¼ëª…']:<55s} (ê°’: {r['í‰ê· ']:.1f})")

print("\nã€ì¤‘ë³µã€‘")
if 'CURRTIME' in df.columns and 'CURRTIME.1' in df.columns:
    if (df['CURRTIME']==df['CURRTIME.1']).all():
        print("  â€¢ CURRTIME.1")
if 'TIME' in df.columns:
    print("  â€¢ TIME")

print("\nã€ì €ë³€ë™/ì €ìƒê´€ã€‘(CV<0.1 AND |r|<0.1)")
low = stats_df[(stats_df['ë³€ë™ê³„ìˆ˜']<0.1) & (abs(stats_df['ìƒê´€'])<0.1)]
low = low[~low['ì»¬ëŸ¼ëª…'].isin(['CURRTIME', 'CURRTIME.1', 'TIME', 'TOTALCNT'])]
for _, r in low.iterrows():
    print(f"  â€¢ {r['ì»¬ëŸ¼ëª…']}")

# ========================================
# ì¶”ì²œ ì»¬ëŸ¼
# ========================================
print(f"\n" + "="*120)
print("âœ… ì¶”ì²œ ì‚¬ìš© ì»¬ëŸ¼")
print("="*120)

rec = stats_df[abs(stats_df['ìƒê´€']) >= 0.15]
rec = rec[~rec['ì»¬ëŸ¼ëª…'].isin(['CURRTIME.1', 'TIME', 'TOTALCNT'])]

print(f"\nã€ë†’ì€ ìƒê´€ ì»¬ëŸ¼ã€‘ (|r| â‰¥ 0.15) - {len(rec)}ê°œ")
for i, (_, r) in enumerate(rec.iterrows(), 1):
    print(f"  {i:2d}. {r['ì»¬ëŸ¼ëª…']:<55s} {r['ìƒê´€']:>+7.3f}")

# CSV ì €ì¥
out_file = "ì»¬ëŸ¼ë¶„ì„_ìƒì„¸.csv"
stats_df.to_csv(out_file, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥: {out_file}")

print(f"\n" + "="*120)
print("âœ… ë¶„ì„ ì™„ë£Œ!")
print("="*120)