#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ðŸŽ¯ 1700+ êµ¬ê°„ ì¶”ì¶œ - ì´ˆê°„ë‹¨ ë²„ì „
"""

import pandas as pd

# ============================================================
# í•µì‹¬ ì½”ë“œ: 1700+ êµ¬ê°„ ì¶”ì¶œ
# ============================================================

def extract_1700plus(input_csv, output_csv='extracted_1700plus.csv'):
    """
    1700+ ë°œìƒ êµ¬ê°„ì„ ìžë™ ì¶”ì¶œ
    ê³¼ê±° 280ë¶„ + 1700+ ì‹œì  + ì´í›„ 30ë¶„ í¬í•¨
    """
    
    print("="*60)
    print("ðŸŽ¯ 1700+ êµ¬ê°„ ì¶”ì¶œ")
    print("="*60)
    
    # 1. ë°ì´í„° ë¡œë“œ
    print(f"\nðŸ“‚ ë¡œë”©: {input_csv}")
    df = pd.read_csv(input_csv)
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M')
    print(f"âœ… ì „ì²´: {len(df):,}í–‰")
    
    # 2. 1700+ ì‹œì  ì°¾ê¸°
    print(f"\nðŸ” 1700+ íƒìƒ‰...")
    high_indices = df[df['TOTALCNT'] >= 1700].index.tolist()
    print(f"âœ… 1700+: {len(high_indices)}ê°œ")
    
    if len(high_indices) == 0:
        print("âŒ 1700+ ì—†ìŒ!")
        return None
    
    # 3. í•„ìš”í•œ ì¸ë±ìŠ¤ ìˆ˜ì§‘
    print(f"\nðŸ“Š í•„ìš” êµ¬ê°„ ê³„ì‚°...")
    needed_indices = set()
    
    for idx in high_indices:
        if idx >= 280:  # ê³¼ê±° 280ë¶„ì´ ìžˆì–´ì•¼ í•¨
            # ê³¼ê±° 280ë¶„ ~ ì´í›„ 30ë¶„
            start = idx - 280
            end = min(idx + 30, len(df) - 1)
            needed_indices.update(range(start, end + 1))
    
    # 4. ë°ì´í„° ì¶”ì¶œ
    print(f"\nðŸ’¾ ì¶”ì¶œ ì¤‘...")
    extracted_indices = sorted(needed_indices)
    extracted_df = df.iloc[extracted_indices].copy()
    extracted_df = extracted_df.sort_values('CURRTIME').reset_index(drop=True)
    
    # 5. ì €ìž¥
    extracted_df.to_csv(output_csv, index=False, encoding='utf-8-sig')
    
    print(f"âœ… ì™„ë£Œ: {output_csv}")
    print(f"   ì¶”ì¶œ: {len(extracted_df):,}í–‰ (ì›ë³¸ì˜ {len(extracted_df)/len(df)*100:.1f}%)")
    print(f"   1700+: {(extracted_df['TOTALCNT'] >= 1700).sum()}ê°œ")
    print("="*60)
    
    return extracted_df


# ============================================================
# ì‚¬ìš© ì˜ˆì‹œ
# ============================================================

if __name__ == '__main__':
    
    # ì˜ˆì‹œ 1: Ois.csvì—ì„œ 1700+ êµ¬ê°„ ì¶”ì¶œ
    extract_1700plus('Ois.csv', 'extracted_1700plus.csv')
    
    # ì˜ˆì‹œ 2: ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ì¶”ì¶œ
    # extract_1700plus('ë‹¤ë¥¸ë°ì´í„°.csv', 'extracted_other.csv')
    
    # ì˜ˆì‹œ 3: ì—¬ëŸ¬ íŒŒì¼ ì¶”ì¶œ í›„ í•©ì¹˜ê¸°
    # df1 = extract_1700plus('8ì›”ë°ì´í„°.csv', 'extracted_8ì›”.csv')
    # df2 = extract_1700plus('9ì›”ë°ì´í„°.csv', 'extracted_9ì›”.csv')
    # df3 = extract_1700plus('10ì›”ë°ì´í„°.csv', 'extracted_10ì›”.csv')
    # 
    # # í•©ì¹˜ê¸°
    # combined = pd.concat([df1, df2, df3], ignore_index=True)
    # combined = combined.sort_values('CURRTIME').reset_index(drop=True)
    # combined.to_csv('combined_1700plus.csv', index=False, encoding='utf-8-sig')
    # print(f"âœ… í•©ì¹¨ ì™„ë£Œ: {len(combined):,}í–‰, 1700+: {(combined['TOTALCNT']>=1700).sum()}ê°œ")