#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ XGBoost í‰ê°€ - 13ê°œ ì»¬ëŸ¼ ìµœì í™” ë²„ì „
VERTICAL ì œê±°, Queue Gap & TRANSPORT ê°•í™”!
"""

import numpy as np
import pandas as pd
import pickle
from datetime import timedelta
import os
import gc
import warnings
warnings.filterwarnings('ignore')

def create_features_13col_optimized(row_dict):
    """13ê°œ ì»¬ëŸ¼ ìµœì í™” Feature ìƒì„± (í•™ìŠµ ì½”ë“œì™€ ì™„ì „ ë™ì¼)"""
    features = {}
    
    # ì‹œí€€ìŠ¤ ì¶”ì¶œ
    seq_m14b = np.array(row_dict['M14AM14B'])
    seq_m14b_sum = np.array(row_dict['M14AM14BSUM'])
    seq_m14b_rev = np.array(row_dict['M14BM14A'])
    seq_m10a = np.array(row_dict['M14AM10A'])
    seq_m10a_rev = np.array(row_dict['M10AM14A'])
    seq_m16_rev = np.array(row_dict['M16M14A'])
    seq_m16_sum = np.array(row_dict['M14AM16SUM'])
    seq_totalcnt = np.array(row_dict['TOTALCNT'])
    seq_q_created = np.array(row_dict['M14.QUE.ALL.CURRENTQCREATED'])
    seq_q_completed = np.array(row_dict['M14.QUE.ALL.CURRENTQCOMPLETED'])
    seq_oht = np.array(row_dict['M14.QUE.OHT.OHTUTIL'])
    seq_transport = np.array(row_dict['M14.QUE.ALL.TRANSPORT4MINOVERCNT'])
    
    # íŒŒìƒ ì»¬ëŸ¼ (Queue Gap - 4.2ë°° ì°¨ì´!)
    seq_queue_gap = seq_q_created - seq_q_completed
    
    # ========================================
    # 1. M14AM14B (10ê°œ)
    # ========================================
    features['m14b_mean'] = np.mean(seq_m14b)
    features['m14b_std'] = np.std(seq_m14b)
    features['m14b_max'] = np.max(seq_m14b)
    features['m14b_min'] = np.min(seq_m14b)
    features['m14b_current'] = seq_m14b[-1]
    features['m14b_last_5'] = np.mean(seq_m14b[-5:])
    features['m14b_last_10'] = np.mean(seq_m14b[-10:])
    features['m14b_last_30'] = np.mean(seq_m14b[-30:])
    features['m14b_slope'] = np.polyfit(np.arange(280), seq_m14b, 1)[0]
    features['m14b_range'] = np.max(seq_m14b) - np.min(seq_m14b)
    
    # ========================================
    # 2. M14AM14BSUM (10ê°œ)
    # ========================================
    features['m14bsum_mean'] = np.mean(seq_m14b_sum)
    features['m14bsum_std'] = np.std(seq_m14b_sum)
    features['m14bsum_max'] = np.max(seq_m14b_sum)
    features['m14bsum_min'] = np.min(seq_m14b_sum)
    features['m14bsum_current'] = seq_m14b_sum[-1]
    features['m14bsum_last_5'] = np.mean(seq_m14b_sum[-5:])
    features['m14bsum_last_10'] = np.mean(seq_m14b_sum[-10:])
    features['m14bsum_last_30'] = np.mean(seq_m14b_sum[-30:])
    features['m14bsum_slope'] = np.polyfit(np.arange(280), seq_m14b_sum, 1)[0]
    features['m14bsum_range'] = np.max(seq_m14b_sum) - np.min(seq_m14b_sum)
    
    # ========================================
    # 3. M14BM14A (10ê°œ)
    # ========================================
    features['m14brev_mean'] = np.mean(seq_m14b_rev)
    features['m14brev_std'] = np.std(seq_m14b_rev)
    features['m14brev_max'] = np.max(seq_m14b_rev)
    features['m14brev_min'] = np.min(seq_m14b_rev)
    features['m14brev_current'] = seq_m14b_rev[-1]
    features['m14brev_last_5'] = np.mean(seq_m14b_rev[-5:])
    features['m14brev_last_10'] = np.mean(seq_m14b_rev[-10:])
    features['m14brev_last_30'] = np.mean(seq_m14b_rev[-30:])
    features['m14brev_slope'] = np.polyfit(np.arange(280), seq_m14b_rev, 1)[0]
    features['m14brev_range'] = np.max(seq_m14b_rev) - np.min(seq_m14b_rev)
    
    # ========================================
    # 4. M14AM10A (10ê°œ)
    # ========================================
    features['m10a_mean'] = np.mean(seq_m10a)
    features['m10a_std'] = np.std(seq_m10a)
    features['m10a_max'] = np.max(seq_m10a)
    features['m10a_min'] = np.min(seq_m10a)
    features['m10a_current'] = seq_m10a[-1]
    features['m10a_last_5'] = np.mean(seq_m10a[-5:])
    features['m10a_last_10'] = np.mean(seq_m10a[-10:])
    features['m10a_last_30'] = np.mean(seq_m10a[-30:])
    features['m10a_slope'] = np.polyfit(np.arange(280), seq_m10a, 1)[0]
    features['m10a_range'] = np.max(seq_m10a) - np.min(seq_m10a)
    
    # ========================================
    # 5. M10AM14A (10ê°œ)
    # ========================================
    features['m10arev_mean'] = np.mean(seq_m10a_rev)
    features['m10arev_std'] = np.std(seq_m10a_rev)
    features['m10arev_max'] = np.max(seq_m10a_rev)
    features['m10arev_min'] = np.min(seq_m10a_rev)
    features['m10arev_current'] = seq_m10a_rev[-1]
    features['m10arev_last_5'] = np.mean(seq_m10a_rev[-5:])
    features['m10arev_last_10'] = np.mean(seq_m10a_rev[-10:])
    features['m10arev_last_30'] = np.mean(seq_m10a_rev[-30:])
    features['m10arev_slope'] = np.polyfit(np.arange(280), seq_m10a_rev, 1)[0]
    features['m10arev_range'] = np.max(seq_m10a_rev) - np.min(seq_m10a_rev)
    
    # ========================================
    # 6. M16M14A (10ê°œ)
    # ========================================
    features['m16rev_mean'] = np.mean(seq_m16_rev)
    features['m16rev_std'] = np.std(seq_m16_rev)
    features['m16rev_max'] = np.max(seq_m16_rev)
    features['m16rev_min'] = np.min(seq_m16_rev)
    features['m16rev_current'] = seq_m16_rev[-1]
    features['m16rev_last_5'] = np.mean(seq_m16_rev[-5:])
    features['m16rev_last_10'] = np.mean(seq_m16_rev[-10:])
    features['m16rev_last_30'] = np.mean(seq_m16_rev[-30:])
    features['m16rev_slope'] = np.polyfit(np.arange(280), seq_m16_rev, 1)[0]
    features['m16rev_range'] = np.max(seq_m16_rev) - np.min(seq_m16_rev)
    
    # ========================================
    # 7. M14AM16SUM (10ê°œ)
    # ========================================
    features['m16sum_mean'] = np.mean(seq_m16_sum)
    features['m16sum_std'] = np.std(seq_m16_sum)
    features['m16sum_max'] = np.max(seq_m16_sum)
    features['m16sum_min'] = np.min(seq_m16_sum)
    features['m16sum_current'] = seq_m16_sum[-1]
    features['m16sum_last_5'] = np.mean(seq_m16_sum[-5:])
    features['m16sum_last_10'] = np.mean(seq_m16_sum[-10:])
    features['m16sum_last_30'] = np.mean(seq_m16_sum[-30:])
    features['m16sum_slope'] = np.polyfit(np.arange(280), seq_m16_sum, 1)[0]
    features['m16sum_range'] = np.max(seq_m16_sum) - np.min(seq_m16_sum)
    
    # ========================================
    # 8. TOTALCNT (10ê°œ)
    # ========================================
    features['total_mean'] = np.mean(seq_totalcnt)
    features['total_std'] = np.std(seq_totalcnt)
    features['total_max'] = np.max(seq_totalcnt)
    features['total_min'] = np.min(seq_totalcnt)
    features['total_current'] = seq_totalcnt[-1]
    features['total_last_5'] = np.mean(seq_totalcnt[-5:])
    features['total_last_10'] = np.mean(seq_totalcnt[-10:])
    features['total_last_30'] = np.mean(seq_totalcnt[-30:])
    features['total_slope'] = np.polyfit(np.arange(280), seq_totalcnt, 1)[0]
    features['total_range'] = np.max(seq_totalcnt) - np.min(seq_totalcnt)
    
    # ========================================
    # 9. Queue Created (10ê°œ)
    # ========================================
    features['qc_mean'] = np.mean(seq_q_created)
    features['qc_std'] = np.std(seq_q_created)
    features['qc_max'] = np.max(seq_q_created)
    features['qc_min'] = np.min(seq_q_created)
    features['qc_current'] = seq_q_created[-1]
    features['qc_last_5'] = np.mean(seq_q_created[-5:])
    features['qc_last_10'] = np.mean(seq_q_created[-10:])
    features['qc_last_30'] = np.mean(seq_q_created[-30:])
    features['qc_slope'] = np.polyfit(np.arange(280), seq_q_created, 1)[0]
    features['qc_range'] = np.max(seq_q_created) - np.min(seq_q_created)
    
    # ========================================
    # 10. Queue Completed (10ê°œ)
    # ========================================
    features['qd_mean'] = np.mean(seq_q_completed)
    features['qd_std'] = np.std(seq_q_completed)
    features['qd_max'] = np.max(seq_q_completed)
    features['qd_min'] = np.min(seq_q_completed)
    features['qd_current'] = seq_q_completed[-1]
    features['qd_last_5'] = np.mean(seq_q_completed[-5:])
    features['qd_last_10'] = np.mean(seq_q_completed[-10:])
    features['qd_last_30'] = np.mean(seq_q_completed[-30:])
    features['qd_slope'] = np.polyfit(np.arange(280), seq_q_completed, 1)[0]
    features['qd_range'] = np.max(seq_q_completed) - np.min(seq_q_completed)
    
    # ========================================
    # 11. OHT Util (10ê°œ)
    # ========================================
    features['oht_mean'] = np.mean(seq_oht)
    features['oht_std'] = np.std(seq_oht)
    features['oht_max'] = np.max(seq_oht)
    features['oht_min'] = np.min(seq_oht)
    features['oht_current'] = seq_oht[-1]
    features['oht_last_5'] = np.mean(seq_oht[-5:])
    features['oht_last_10'] = np.mean(seq_oht[-10:])
    features['oht_last_30'] = np.mean(seq_oht[-30:])
    features['oht_slope'] = np.polyfit(np.arange(280), seq_oht, 1)[0]
    features['oht_range'] = np.max(seq_oht) - np.min(seq_oht)
    
    # ========================================
    # 12. Transport (10ê°œ) - 1.29ë°° ì¤‘ìš”!
    # ========================================
    features['trans_mean'] = np.mean(seq_transport)
    features['trans_std'] = np.std(seq_transport)
    features['trans_max'] = np.max(seq_transport)
    features['trans_min'] = np.min(seq_transport)
    features['trans_current'] = seq_transport[-1]
    features['trans_last_5'] = np.mean(seq_transport[-5:])
    features['trans_last_10'] = np.mean(seq_transport[-10:])
    features['trans_last_30'] = np.mean(seq_transport[-30:])
    features['trans_slope'] = np.polyfit(np.arange(280), seq_transport, 1)[0]
    features['trans_range'] = np.max(seq_transport) - np.min(seq_transport)
    
    # ========================================
    # 13. Queue Gap (10ê°œ) - 4.2ë°° ì°¨ì´!
    # ========================================
    features['gap_mean'] = np.mean(seq_queue_gap)
    features['gap_std'] = np.std(seq_queue_gap)
    features['gap_max'] = np.max(seq_queue_gap)
    features['gap_min'] = np.min(seq_queue_gap)
    features['gap_current'] = seq_queue_gap[-1]
    features['gap_last_5'] = np.mean(seq_queue_gap[-5:])
    features['gap_last_10'] = np.mean(seq_queue_gap[-10:])
    features['gap_last_30'] = np.mean(seq_queue_gap[-30:])
    features['gap_slope'] = np.polyfit(np.arange(280), seq_queue_gap, 1)[0]
    features['gap_range'] = np.max(seq_queue_gap) - np.min(seq_queue_gap)
    
    # ========================================
    # Interaction Features (30ê°œ) - í•µì‹¬!
    # ========================================
    
    # M14AM14B Ã— M14AM14BSUM (100% í•„ìˆ˜ ì¡°ê±´!)
    features['m14b_x_m14bsum'] = seq_m14b[-1] * seq_m14b_sum[-1] / 1000
    features['m14b_x_m14bsum_mean'] = np.mean(seq_m14b * seq_m14b_sum) / 1000
    features['m14bsum_per_m14b'] = seq_m14b_sum[-1] / (seq_m14b[-1] + 1)
    features['m14b_plus_m14bsum'] = seq_m14b[-1] + seq_m14b_sum[-1]
    
    # Queue Gap ì¡°í•© (4.2ë°° ì°¨ì´!)
    features['gap_x_m14b'] = seq_queue_gap[-1] * seq_m14b[-1] / 1000
    features['gap_x_m14bsum'] = seq_queue_gap[-1] * seq_m14b_sum[-1] / 1000
    features['gap_x_total'] = seq_queue_gap[-1] * seq_totalcnt[-1] / 1000
    features['gap_per_total'] = seq_queue_gap[-1] / (seq_totalcnt[-1] + 1)
    
    # Transport ì¡°í•© (1.29ë°°!)
    features['trans_x_m14b'] = seq_transport[-1] * seq_m14b[-1] / 100
    features['trans_x_m14bsum'] = seq_transport[-1] * seq_m14b_sum[-1] / 100
    features['trans_x_gap'] = seq_transport[-1] * seq_queue_gap[-1] / 100
    features['trans_x_oht'] = seq_transport[-1] * seq_oht[-1] / 10
    
    # 3ì¤‘ ì¡°í•©
    features['triple_danger'] = seq_m14b[-1] * seq_m14b_sum[-1] * seq_transport[-1] / 100000
    features['gap_trans_m14b'] = seq_queue_gap[-1] * seq_transport[-1] * seq_m14b[-1] / 100000
    
    # ê¸°íƒ€ ì¡°í•©
    features['m10arev_x_m14b'] = seq_m10a_rev[-1] * seq_m14b[-1] / 100
    features['oht_x_m14bsum'] = seq_oht[-1] * seq_m14b_sum[-1] / 10
    features['m16rev_x_total'] = seq_m16_rev[-1] * seq_totalcnt[-1] / 100
    
    # ë¹„ìœ¨
    features['ratio_m14b_total'] = seq_m14b[-1] / (seq_totalcnt[-1] + 1)
    features['ratio_m14bsum_total'] = seq_m14b_sum[-1] / (seq_totalcnt[-1] + 1)
    features['ratio_gap_m14b'] = seq_queue_gap[-1] / (seq_m14b[-1] + 1)
    features['ratio_trans_total'] = seq_transport[-1] / (seq_totalcnt[-1] + 1)
    
    # ë³€ë™ì„±
    features['vol_m14b'] = np.std(seq_m14b) / (np.mean(seq_m14b) + 1)
    features['vol_m14bsum'] = np.std(seq_m14b_sum) / (np.mean(seq_m14b_sum) + 1)
    features['vol_total'] = np.std(seq_totalcnt) / (np.mean(seq_totalcnt) + 1)
    features['vol_gap'] = np.std(seq_queue_gap) / (np.mean(np.abs(seq_queue_gap)) + 1)
    features['vol_trans'] = np.std(seq_transport) / (np.mean(seq_transport) + 1)
    
    # ìƒê´€
    features['corr_m14b_total'] = np.corrcoef(seq_m14b, seq_totalcnt)[0, 1]
    features['corr_m14bsum_total'] = np.corrcoef(seq_m14b_sum, seq_totalcnt)[0, 1]
    features['corr_gap_total'] = np.corrcoef(seq_queue_gap, seq_totalcnt)[0, 1]
    features['corr_trans_total'] = np.corrcoef(seq_transport, seq_totalcnt)[0, 1]
    
    # ========================================
    # ì„ê³„ê°’ ì¹´ìš´íŠ¸ (35ê°œ)
    # ========================================
    
    # M14AM14B (ë°ì´í„° ê¸°ë°˜!)
    features['m14b_over_497'] = np.sum(seq_m14b > 497)
    features['m14b_over_517'] = np.sum(seq_m14b > 517)
    features['m14b_over_520'] = np.sum(seq_m14b > 520)
    features['m14b_over_539'] = np.sum(seq_m14b > 539)
    
    # M14AM14BSUM (ë°ì´í„° ê¸°ë°˜!)
    features['m14bsum_over_566'] = np.sum(seq_m14b_sum > 566)
    features['m14bsum_over_576'] = np.sum(seq_m14b_sum > 576)
    features['m14bsum_over_588'] = np.sum(seq_m14b_sum > 588)
    features['m14bsum_over_602'] = np.sum(seq_m14b_sum > 602)
    
    # Queue Gap (ë°ì´í„° ê¸°ë°˜!)
    features['gap_over_200'] = np.sum(seq_queue_gap > 200)
    features['gap_over_250'] = np.sum(seq_queue_gap > 250)
    features['gap_over_300'] = np.sum(seq_queue_gap > 300)
    features['gap_over_350'] = np.sum(seq_queue_gap > 350)
    
    # Transport (ë°ì´í„° ê¸°ë°˜!)
    features['trans_over_145'] = np.sum(seq_transport > 145)
    features['trans_over_151'] = np.sum(seq_transport > 151)
    features['trans_over_171'] = np.sum(seq_transport > 171)
    features['trans_over_180'] = np.sum(seq_transport > 180)
    
    # OHT
    features['oht_over_83'] = np.sum(seq_oht > 83.6)
    features['oht_over_84'] = np.sum(seq_oht > 84.6)
    features['oht_over_86'] = np.sum(seq_oht > 85.6)
    
    # TOTALCNT
    features['total_over_1500'] = np.sum(seq_totalcnt >= 1500)
    features['total_over_1600'] = np.sum(seq_totalcnt >= 1600)
    features['total_over_1700'] = np.sum(seq_totalcnt >= 1700)
    features['total_over_1600_last30'] = np.sum(seq_totalcnt[-30:] >= 1600)
    
    # ê¸°íƒ€
    features['m10arev_over_55'] = np.sum(seq_m10a_rev > 55)
    features['m10arev_over_59'] = np.sum(seq_m10a_rev > 59)
    features['m10a_under_80'] = np.sum(seq_m10a < 80)
    features['m10a_under_70'] = np.sum(seq_m10a < 70)
    features['m16rev_over_128'] = np.sum(seq_m16_rev > 128)
    features['m16rev_over_136'] = np.sum(seq_m16_rev > 136)
    
    # ìµœê·¼ 30ë¶„
    features['m14b_over_517_last30'] = np.sum(seq_m14b[-30:] > 517)
    features['m14bsum_over_576_last30'] = np.sum(seq_m14b_sum[-30:] > 576)
    features['gap_over_250_last30'] = np.sum(seq_queue_gap[-30:] > 250)
    features['trans_over_151_last30'] = np.sum(seq_transport[-30:] > 151)
    
    # ========================================
    # í™©ê¸ˆ íŒ¨í„´ (20ê°œ) - ë°ì´í„° ê¸°ë°˜!
    # ========================================
    
    # í•„ìˆ˜ ì¡°ê±´ (100%!)
    features['must_condition'] = 1 if (seq_m14b[-1] > 497 and seq_m14b_sum[-1] > 566) else 0
    
    # ê°•ë ¥í•œ ì‹ í˜¸
    features['gold_strict'] = 1 if (seq_m14b[-1] > 520 and seq_m14b_sum[-1] > 588) else 0
    features['gold_normal'] = 1 if (seq_m14b[-1] > 517 and seq_m14b_sum[-1] > 576) else 0
    features['gold_loose'] = 1 if (seq_m14b[-1] > 509 and seq_m14b_sum[-1] > 570) else 0
    
    # ë³µí•© ì‹ í˜¸
    features['danger_gap'] = 1 if seq_queue_gap[-1] > 300 else 0
    features['danger_trans'] = 1 if seq_transport[-1] > 151 else 0
    features['danger_oht'] = 1 if seq_oht[-1] > 84.6 else 0
    
    # 3ì¤‘ ì²´í¬
    features['triple_check'] = 1 if (seq_m14b[-1] > 517 and seq_m14b_sum[-1] > 576 and seq_queue_gap[-1] > 250) else 0
    features['quad_check'] = 1 if (seq_m14b[-1] > 517 and seq_m14b_sum[-1] > 576 and seq_queue_gap[-1] > 250 and seq_transport[-1] > 145) else 0
    
    # í˜„ì¬ ìƒíƒœ
    features['danger_1700'] = 1 if seq_totalcnt[-1] >= 1700 else 0
    features['danger_1600'] = 1 if seq_totalcnt[-1] >= 1600 else 0
    features['in_1700'] = 1 if seq_totalcnt[-1] >= 1700 else 0
    features['rising_1700'] = 1 if (seq_totalcnt[-1] >= 1700 and seq_totalcnt[-1] - seq_totalcnt[-10] > 20) else 0
    features['stable_1700'] = 1 if (seq_totalcnt[-1] >= 1700 and abs(seq_totalcnt[-1] - seq_totalcnt[-10]) <= 20) else 0
    features['falling_1700'] = 1 if (seq_totalcnt[-1] >= 1700 and seq_totalcnt[-1] - seq_totalcnt[-10] < -20) else 0
    
    # ì¶”ì„¸
    features['trend_10min'] = seq_totalcnt[-1] - seq_totalcnt[-10]
    features['trend_30min'] = seq_totalcnt[-1] - seq_totalcnt[-30]
    
    # íŠ¹ìˆ˜ íŒ¨í„´
    features['high_m14b_low_m10a'] = 1 if (seq_m14b[-1] > 517 and seq_m10a[-1] < 80) else 0
    features['high_gap_high_trans'] = 1 if (seq_queue_gap[-1] > 250 and seq_transport[-1] > 145) else 0
    
    # ========================================
    # ì‹œê°„ëŒ€ë³„ í†µê³„ (10ê°œ)
    # ========================================
    q1 = seq_totalcnt[:70]
    q2 = seq_totalcnt[70:140]
    q3 = seq_totalcnt[140:210]
    q4 = seq_totalcnt[210:280]
    
    features['q1_mean'] = np.mean(q1)
    features['q2_mean'] = np.mean(q2)
    features['q3_mean'] = np.mean(q3)
    features['q4_mean'] = np.mean(q4)
    features['q_trend_1_2'] = np.mean(q2) - np.mean(q1)
    features['q_trend_2_3'] = np.mean(q3) - np.mean(q2)
    features['q_trend_3_4'] = np.mean(q4) - np.mean(q3)
    features['q_trend_overall'] = np.mean(q4) - np.mean(q1)
    features['q4_vs_mean'] = np.mean(q4) / (np.mean(seq_totalcnt) + 1)
    features['q_accel'] = (np.mean(q4) - np.mean(q3)) - (np.mean(q3) - np.mean(q2))
    
    return features

def evaluate_all_predictions():
    """ì „ì²´ ë°ì´í„°ë¥¼ ìŠ¬ë¼ì´ë”© ìœˆë„ìš°ë¡œ í‰ê°€ - 13ê°œ ì»¬ëŸ¼"""
    
    print("="*80)
    print("ğŸš€ XGBoost í‰ê°€ - 13ê°œ ì»¬ëŸ¼ ìµœì í™” (280ë¶„â†’10ë¶„)")
    print("="*80)
    print("VERTICAL ì œê±°, Queue Gap & TRANSPORT ê°•í™”!")
    print("="*80)
    
    # ëª¨ë¸ ë¡œë“œ
    model_files = [
        '/mnt/user-data/outputs/model_13col_optimized.pkl',
        'model_13col_optimized.pkl',
        '/home/claude/model_13col_optimized.pkl'
    ]
    
    model = None
    model_file = None
    
    for mf in model_files:
        if os.path.exists(mf):
            try:
                with open(mf, 'rb') as f:
                    model = pickle.load(f)
                model_file = mf
                print(f"âœ… ëª¨ë¸ ë¡œë“œ: {model_file}")
                break
            except Exception as e:
                print(f"âš ï¸ ë¡œë“œ ì‹¤íŒ¨ ({mf}): {e}")
    
    if model is None:
        print(f"âŒ ëª¨ë¸ íŒŒì¼ ì—†ìŒ!")
        print(f"\në¨¼ì € í•™ìŠµ_13ì»¬ëŸ¼_ìµœì í™”.pyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
        return None
    
    # ë°ì´í„° ë¡œë“œ
    csv_file = '/mnt/user-data/uploads/ssss.CSV'
    
    if not os.path.exists(csv_file):
        print(f"âŒ CSV íŒŒì¼ ì—†ìŒ: {csv_file}")
        return None
    
    try:
        print(f"ë°ì´í„° ë¡œë”©: {csv_file}...")
        df = pd.read_csv(csv_file, on_bad_lines='skip')
        print(f"âœ… ë°ì´í„° ë¡œë“œ: {len(df):,}í–‰")
    except Exception as e:
        print(f"âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
        return None
    
    # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ (13ê°œ)
    required_cols = [
        'CURRTIME', 'M14AM14B', 'M14AM14BSUM', 'M14BM14A',
        'M14AM10A', 'M10AM14A', 'M16M14A', 'M14AM16SUM', 'TOTALCNT',
        'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED',
        'M14.QUE.OHT.OHTUTIL', 'M14.QUE.ALL.TRANSPORT4MINOVERCNT'
    ]
    
    missing_cols = [col for col in required_cols if col not in df.columns]
    
    if missing_cols:
        print(f"âŒ í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: {missing_cols}")
        return None
    
    print(f"âœ… 13ê°œ ì»¬ëŸ¼ í™•ì¸ ì™„ë£Œ (VERTICAL ì œì™¸)")
    
    # CURRTIME ì²˜ë¦¬
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M')
    print("âœ… CURRTIME íŒŒì‹± ì™„ë£Œ")
    
    results = []
    
    total_predictions = len(df) - 280 - 10
    print(f"\nğŸ”„ ìŠ¬ë¼ì´ë”© ìœˆë„ìš° í‰ê°€ ì‹œì‘...")
    print(f"ì´ ì˜ˆì¸¡ ìˆ˜: {total_predictions:,}ê°œ")
    
    # ìŠ¬ë¼ì´ë”© ìœˆë„ìš°
    for i in range(280, len(df) - 10):
        # 280ë¶„ ì‹œí€€ìŠ¤
        row_dict = {
            'M14AM14B': df['M14AM14B'].iloc[i-280:i].values,
            'M14AM14BSUM': df['M14AM14BSUM'].iloc[i-280:i].values,
            'M14BM14A': df['M14BM14A'].iloc[i-280:i].values,
            'M14AM10A': df['M14AM10A'].iloc[i-280:i].values,
            'M10AM14A': df['M10AM14A'].iloc[i-280:i].values,
            'M16M14A': df['M16M14A'].iloc[i-280:i].values,
            'M14AM16SUM': df['M14AM16SUM'].iloc[i-280:i].values,
            'TOTALCNT': df['TOTALCNT'].iloc[i-280:i].values,
            'M14.QUE.ALL.CURRENTQCREATED': df['M14.QUE.ALL.CURRENTQCREATED'].iloc[i-280:i].values,
            'M14.QUE.ALL.CURRENTQCOMPLETED': df['M14.QUE.ALL.CURRENTQCOMPLETED'].iloc[i-280:i].values,
            'M14.QUE.OHT.OHTUTIL': df['M14.QUE.OHT.OHTUTIL'].iloc[i-280:i].values,
            'M14.QUE.ALL.TRANSPORT4MINOVERCNT': df['M14.QUE.ALL.TRANSPORT4MINOVERCNT'].iloc[i-280:i].values,
        }
        
        seq_totalcnt = row_dict['TOTALCNT']
        seq_m14b = row_dict['M14AM14B']
        seq_m14b_sum = row_dict['M14AM14BSUM']
        seq_m10a = row_dict['M14AM10A']
        seq_m10a_rev = row_dict['M10AM14A']
        seq_transport = row_dict['M14.QUE.ALL.TRANSPORT4MINOVERCNT']
        
        seq_queue_created = row_dict['M14.QUE.ALL.CURRENTQCREATED']
        seq_queue_completed = row_dict['M14.QUE.ALL.CURRENTQCOMPLETED']
        seq_oht = row_dict['M14.QUE.OHT.OHTUTIL']
        
        seq_queue_gap = seq_queue_created - seq_queue_completed
        
        # ì‹œê°„ ì •ë³´
        current_time = df['CURRTIME'].iloc[i-1]
        seq_start_time = df['CURRTIME'].iloc[i-280]
        prediction_time = current_time + timedelta(minutes=10)
        actual_time = df['CURRTIME'].iloc[i+9]
        
        # ì‹¤ì œê°’ (10ë¶„ í›„)
        actual_value = df['TOTALCNT'].iloc[i+9]
        
        # Feature ìƒì„±
        features = create_features_13col_optimized(row_dict)
        X_pred = pd.DataFrame([features])
        
        # ì˜ˆì¸¡
        prediction = model.predict(X_pred)[0]
        
        # íŒ¨í„´ ê°ì§€ (ë°ì´í„° ê¸°ë°˜!)
        gold_strict = (seq_m14b[-1] > 520 and seq_m14b_sum[-1] > 588)
        gold_normal = (seq_m14b[-1] > 517 and seq_m14b_sum[-1] > 576)
        danger_gap = (seq_queue_gap[-1] > 300)
        danger_trans = (seq_transport[-1] > 151)
        quad_check = (seq_m14b[-1] > 517 and seq_m14b_sum[-1] > 576 and seq_queue_gap[-1] > 250 and seq_transport[-1] > 145)
        
        # ì¡°ê¸° ê²½ë³´
        last_10min = seq_totalcnt[-10:]
        early_warning = (np.max(last_10min) >= 1640) and ((last_10min[-1] - last_10min[0]) > 20)
        
        # ê²°ê³¼ ì €ì¥
        results.append({
            'ì‹œí€€ìŠ¤ì‹œì‘': seq_start_time.strftime('%Y-%m-%d %H:%M'),
            'í˜„ì¬ì‹œê°„': current_time.strftime('%Y-%m-%d %H:%M'),
            'í˜„ì¬TOTALCNT': round(seq_totalcnt[-1], 2),
            'ì˜ˆì¸¡ì‹œì ': prediction_time.strftime('%Y-%m-%d %H:%M'),
            'ì‹¤ì œì‹œì ': actual_time.strftime('%Y-%m-%d %H:%M'),
            'ì‹¤ì œê°’': round(actual_value, 2),
            'ì˜ˆì¸¡ê°’': round(prediction, 2),
            'ì˜¤ì°¨': round(actual_value - prediction, 2),
            'ì ˆëŒ€ì˜¤ì°¨': round(abs(actual_value - prediction), 2),
            'ì˜¤ì°¨ìœ¨(%)': round(abs(actual_value - prediction) / max(actual_value, 1) * 100, 2),
            'M14AM14B': round(seq_m14b[-1], 2),
            'M14AM14BSUM': round(seq_m14b_sum[-1], 2),
            'M14AM10A': round(seq_m10a[-1], 2),
            'M10AM14A': round(seq_m10a_rev[-1], 2),
            'queue_gap': round(seq_queue_gap[-1], 2),
            'TRANSPORT': round(seq_transport[-1], 2),
            'OHT_UTIL': round(seq_oht[-1], 2),
            'ì‹œí€€ìŠ¤MAX': round(np.max(seq_totalcnt), 2),
            'ì‹œí€€ìŠ¤MIN': round(np.min(seq_totalcnt), 2),
            'ì‹œí€€ìŠ¤í‰ê· ': round(np.mean(seq_totalcnt), 2),
            'ë§ˆì§€ë§‰10ë¶„MAX': round(np.max(last_10min), 2),
            'ë§ˆì§€ë§‰10ë¶„ìƒìŠ¹': round(last_10min[-1] - last_10min[0], 2),
            'í™©ê¸ˆíŒ¨í„´(ì—„ê²©)': 'O' if gold_strict else '',
            'í™©ê¸ˆíŒ¨í„´(ë³´í†µ)': 'O' if gold_normal else '',
            'Gapìœ„í—˜': 'O' if danger_gap else '',
            'Transìœ„í—˜': 'O' if danger_trans else '',
            '4ì¤‘ì²´í¬': 'O' if quad_check else '',
            'ì¡°ê¸°ê²½ë³´': 'O' if early_warning else '',
            'ì‹¤ì œìœ„í—˜(1700+)': 'O' if actual_value >= 1700 else '',
            'ì˜ˆì¸¡ìœ„í—˜(1640+)': 'O' if prediction >= 1640 else ''
        })
        
        # ì§„í–‰ìƒí™©
        if (i - 280) % 5000 == 0 and i > 280:
            progress = (i - 280) / total_predictions * 100
            print(f"  ì§„í–‰ì¤‘... {i-280:,}/{total_predictions:,} ({progress:.1f}%)")
            gc.collect()
    
    print(f"âœ… í‰ê°€ ì™„ë£Œ!")
    
    # DataFrame ë³€í™˜
    results_df = pd.DataFrame(results)
    
    # CSV ì €ì¥
    output_file = '/mnt/user-data/outputs/evaluation_13col_optimized.csv'
    results_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"âœ… ê²°ê³¼ ì €ì¥: {output_file}")
    
    # ë©”ëª¨ë¦¬ ì •ë¦¬
    del df
    gc.collect()
    
    # ===== í†µê³„ ë¶„ì„ =====
    print("\n" + "="*80)
    print("ğŸ“Š í‰ê°€ í†µê³„ (13ê°œ ì»¬ëŸ¼, 280ë¶„ â†’ 10ë¶„ í›„)")
    print("="*80)
    print(f"ì´ ì˜ˆì¸¡ ìˆ˜: {len(results_df):,}ê°œ")
    print(f"í‰ê·  ì ˆëŒ€ ì˜¤ì°¨(MAE): {results_df['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")
    print(f"í‰ê·  ì˜¤ì°¨ìœ¨: {results_df['ì˜¤ì°¨ìœ¨(%)'].mean():.2f}%")
    print(f"ìµœëŒ€ ì ˆëŒ€ ì˜¤ì°¨: {results_df['ì ˆëŒ€ì˜¤ì°¨'].max():.2f}")
    print(f"ìµœì†Œ ì ˆëŒ€ ì˜¤ì°¨: {results_df['ì ˆëŒ€ì˜¤ì°¨'].min():.2f}")
    
    print(f"\ní™©ê¸ˆ íŒ¨í„´(ì—„ê²©): {results_df['í™©ê¸ˆíŒ¨í„´(ì—„ê²©)'].value_counts().get('O', 0):,}ê°œ")
    print(f"í™©ê¸ˆ íŒ¨í„´(ë³´í†µ): {results_df['í™©ê¸ˆíŒ¨í„´(ë³´í†µ)'].value_counts().get('O', 0):,}ê°œ")
    print(f"Gap ìœ„í—˜: {results_df['Gapìœ„í—˜'].value_counts().get('O', 0):,}ê°œ")
    print(f"Transport ìœ„í—˜: {results_df['Transìœ„í—˜'].value_counts().get('O', 0):,}ê°œ")
    print(f"ğŸ”¥ 4ì¤‘ ì²´í¬: {results_df['4ì¤‘ì²´í¬'].value_counts().get('O', 0):,}ê°œ")
    print(f"ğŸ”¥ ì¡°ê¸° ê²½ë³´: {results_df['ì¡°ê¸°ê²½ë³´'].value_counts().get('O', 0):,}ê°œ")
    
    # ìœ„í—˜ êµ¬ê°„ ë¶„ì„
    actual_danger = results_df['ì‹¤ì œìœ„í—˜(1700+)'] == 'O'
    pred_danger = results_df['ì˜ˆì¸¡ìœ„í—˜(1640+)'] == 'O'
    quad_check = results_df['4ì¤‘ì²´í¬'] == 'O'
    
    actual_danger_count = actual_danger.sum()
    pred_danger_count = pred_danger.sum()
    danger_detected = (actual_danger & pred_danger).sum()
    quad_count = quad_check.sum()
    
    # 4ì¤‘ ì²´í¬ì˜ 1700+ ì˜ˆì¸¡ë ¥
    quad_to_danger = (quad_check & actual_danger).sum()
    
    print(f"\nì‹¤ì œ ìœ„í—˜(1700+): {actual_danger_count:,}ê°œ")
    print(f"ì˜ˆì¸¡ ìœ„í—˜(1640+): {pred_danger_count:,}ê°œ")
    print(f"ìœ„í—˜ ê°ì§€ ì„±ê³µ: {danger_detected:,}ê°œ")
    if actual_danger_count > 0:
        print(f"ğŸ¯ ìœ„í—˜ ê°ì§€ìœ¨: {danger_detected/actual_danger_count*100:.1f}% ({danger_detected:,}/{actual_danger_count:,})")
    
    if quad_count > 0:
        print(f"\nğŸ”¥ 4ì¤‘ ì²´í¬ â†’ ì‹¤ì œ 1700+ ë°œìƒ: {quad_to_danger:,}ê°œ ({quad_to_danger/quad_count*100:.1f}%)")
    
    # ì˜¤ì°¨ ìƒìœ„ 10ê°œ
    print("\n" + "="*80)
    print("ì˜¤ì°¨ ìƒìœ„ 10ê°œ êµ¬ê°„")
    print("="*80)
    top_errors = results_df.nlargest(10, 'ì ˆëŒ€ì˜¤ì°¨')
    print(top_errors[['í˜„ì¬ì‹œê°„', 'í˜„ì¬TOTALCNT', 'ì‹¤ì œê°’', 'ì˜ˆì¸¡ê°’', 'ì ˆëŒ€ì˜¤ì°¨', 'M14AM14B', 'M14AM14BSUM', 'queue_gap', 'TRANSPORT', '4ì¤‘ì²´í¬']].to_string(index=False))
    
    # ìµœì¢… ìš”ì•½
    print("\n" + "="*80)
    print("âœ… ìµœì¢… í‰ê°€ ìš”ì•½")
    print("="*80)
    print(f"1. ì „ì²´ ì„±ëŠ¥:")
    print(f"   - MAE: {results_df['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")
    if actual_danger_count > 0:
        print(f"   - ğŸ¯ ìœ„í—˜ ê°ì§€ìœ¨: {danger_detected/actual_danger_count*100:.1f}% ({danger_detected:,}/{actual_danger_count:,})")
    
    print(f"\n2. ì €ì¥ íŒŒì¼:")
    print(f"   - {output_file}")
    print("="*80)
    
    return results_df

if __name__ == '__main__':
    print("\nğŸš€ XGBoost í‰ê°€ ì‹œì‘ (13ê°œ ì»¬ëŸ¼ ìµœì í™”)...\n")
    results = evaluate_all_predictions()
    
    if results is not None:
        print(f"\nâœ… í‰ê°€ ì™„ë£Œ! ì´ {len(results):,}ê°œ ì˜ˆì¸¡ ìƒì„±")
        print(f"âœ… ê²°ê³¼ íŒŒì¼: evaluation_13col_optimized.csv")