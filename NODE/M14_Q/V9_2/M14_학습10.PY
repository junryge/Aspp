#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ 1ë‹¨ê³„: í•™ìŠµ ì „ìš© (train_v12.py) - ìµœì¢… ìˆ˜ì •
ê¸°ëŠ¥: UF09.CSV íŒŒì¼ì˜ ì‹¤ì œ ì»¬ëŸ¼ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ í•™ìŠµ (ì˜¤ë¥˜ í•´ê²°)
"""

import pandas as pd
import numpy as np
import xgboost as xgb
import pickle
import warnings

warnings.filterwarnings('ignore')

# ============================================
# âš™ï¸ ì„¤ì •
# ============================================
TRAIN_FILE = "UF09.CSV"   # í•™ìŠµ íŒŒì¼ëª…
PRED_MINUTES = 10         # 10ë¶„ ì˜ˆì§€
THRESHOLD = 1700          # ìœ„í—˜ ê¸°ì¤€

print("="*70)
print(f"ğŸš€ V12 í•™ìŠµ ì‹œì‘: {TRAIN_FILE}")
print("="*70)

def create_features(df):
    df = df.copy()
    
    # ì‹œê°„ ë³€í™˜
    if 'CURRTIME' in df.columns:
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

    # 1. í ê°­ ê³„ì‚° (íŒŒì¼ì— ìˆëŠ” ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš©)
    # Q_CREATED - Q_COMPLETED
    df['Queue_Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    
    # 2. ê±°ë¦¬ ì •ë³´
    df['Dist_to_Limit'] = THRESHOLD - df['TOTALCNT']
    
    # 3. ì†ë„ ë° ê°€ì†ë„ (M14AM14B ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    for gap in [1, 3, 5, 10]:
        df[f'Vel_Total_{gap}m'] = df['TOTALCNT'].diff(gap)
        df[f'Vel_Gap_{gap}m'] = df['Queue_Gap'].diff(gap)
        df[f'Vel_M14B_{gap}m'] = df['M14AM14B'].diff(gap)
    
    df['Acc_Total'] = df['Vel_Total_3m'].diff(1)
    df['Vol_Total_10m'] = df['TOTALCNT'].rolling(10).std()
    
    # 4. íŒ¨í„´ (M14AM14B, M14AM14BSUM ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    df['Is_Triple_Danger'] = ((df['M14AM14B'] > 500) & (df['M14AM14BSUM'] > 600) & (df['Queue_Gap'] > 200)).astype(int)
    df['Is_Gold_Pattern'] = ((df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)).astype(int)
    
    return df

def train():
    print("ğŸ”„ ë°ì´í„° ë¡œë”© ì¤‘...")
    try:
        df = pd.read_csv(TRAIN_FILE, on_bad_lines='skip')
    except FileNotFoundError:
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {TRAIN_FILE}")
        return

    # Feature ìƒì„±
    print("ğŸ”„ íŠ¹ì§•(Feature) ìƒì„± ì¤‘...")
    try:
        df = create_features(df)
    except KeyError as e:
        print(f"âŒ ì»¬ëŸ¼ ì—ëŸ¬: {e} ê°€ íŒŒì¼ì— ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # Target ìƒì„±
    indexer = pd.api.indexers.FixedForwardWindowIndexer(window_size=PRED_MINUTES)
    df['Future_Max'] = df['TOTALCNT'].rolling(window=indexer).max().shift(-1)
    df['Target'] = (df['Future_Max'] >= THRESHOLD).astype(int)
    
    # í•™ìŠµì— ì‚¬ìš©í•  Feature ëª©ë¡ (ì‹¤ì œ ì»¬ëŸ¼ëª… í¬í•¨)
    features = [
        'TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'Queue_Gap', 'Dist_to_Limit',
        'Vel_Total_1m', 'Vel_Total_3m', 'Vel_Total_5m', 'Vel_Total_10m',
        'Vel_Gap_3m', 'Acc_Total', 'Vol_Total_10m', 
        'Is_Triple_Danger', 'Is_Gold_Pattern'
    ]
    
    df_train = df.dropna(subset=features + ['Target']).reset_index(drop=True)
    print(f"âœ… í•™ìŠµ ë°ì´í„° í™•ë³´: {len(df_train):,}í–‰")
    
    # ê°€ì¤‘ì¹˜ ê³„ì‚°
    neg, pos = np.bincount(df_train['Target'])
    scale_weight = neg / pos if pos > 0 else 1
    print(f"âš–ï¸ ê°€ì¤‘ì¹˜ ì„¤ì •: {scale_weight:.2f}")
    
    print("ğŸš€ XGBoost ëª¨ë¸ í•™ìŠµ ì¤‘...")
    model = xgb.XGBClassifier(
        n_estimators=500, max_depth=6, learning_rate=0.03,
        scale_pos_weight=scale_weight * 1.5, random_state=42, n_jobs=-1, tree_method='hist'
    )
    model.fit(df_train[features], df_train['Target'])
    
    # ì €ì¥
    with open('model_v12.pkl', 'wb') as f: pickle.dump(model, f)
    with open('features_v12.pkl', 'wb') as f: pickle.dump(features, f)
    
    print("\nâœ… í•™ìŠµ ì™„ë£Œ! (model_v12.pkl ì €ì¥ë¨)")
    print("   ì´ì œ eval_v12.pyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")

if __name__ == "__main__":
    train()
