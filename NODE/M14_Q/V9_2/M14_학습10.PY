#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ 1ë‹¨ê³„: í•™ìŠµ ì „ìš© (train_v12.py)
ê¸°ëŠ¥: ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ì½ì–´ XGBoost ëª¨ë¸ì„ í•™ìŠµí•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
"""

import pandas as pd
import numpy as np
import xgboost as xgb
import pickle
import warnings

warnings.filterwarnings('ignore')

# ============================================
# âš™ï¸ ì„¤ì • (í•™ìŠµìš© ë°ì´í„° ì§€ì •)
# ============================================
TRAIN_FILE = "UF09.CSV"   # 3ê°œì›”ì¹˜ ë°ì´í„° íŒŒì¼ëª… (í•™ìŠµìš©)
PRED_MINUTES = 10         # 10ë¶„ í›„ ì˜ˆì¸¡
THRESHOLD = 1700          # ìœ„í—˜ ê¸°ì¤€ê°’

print("="*70)
print(f"ğŸš€ V12 í•™ìŠµ ëª¨ë“œ: {TRAIN_FILE}")
print("="*70)

# --------------------------------------------
# 1. Feature Engineering (í‰ê°€ ì½”ë“œì™€ ë™ì¼í•´ì•¼ í•¨!)
# --------------------------------------------
def create_features(df):
    df = df.copy()
    
    # ì‹œê°„ ë³€í™˜
    if 'CURRTIME' in df.columns:
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

    # ì»¬ëŸ¼ ë§¤í•‘ (íŒŒì¼ë§ˆë‹¤ ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
    q_created = df['M14.QUE.ALL.CURRENTQCREATED'] if 'M14.QUE.ALL.CURRENTQCREATED' in df.columns else df['Q_CREATED']
    q_completed = df['M14.QUE.ALL.CURRENTQCOMPLETED'] if 'M14.QUE.ALL.CURRENTQCOMPLETED' in df.columns else df['Q_COMPLETED']
    
    df['Queue_Gap'] = q_created - q_completed
    df['Dist_to_Limit'] = THRESHOLD - df['TOTALCNT']
    
    # ì†ë„(Velocity) ë° ê°€ì†ë„
    for gap in [1, 3, 5, 10]:
        df[f'Vel_Total_{gap}m'] = df['TOTALCNT'].diff(gap)
        df[f'Vel_Gap_{gap}m'] = df['Queue_Gap'].diff(gap)
        df[f'Vel_M14B_{gap}m'] = df['M14AM14B'].diff(gap)
    
    df['Acc_Total'] = df['Vel_Total_3m'].diff(1)
    df['Vol_Total_10m'] = df['TOTALCNT'].rolling(10).std()
    
    # ìœ„í—˜ íŒ¨í„´
    df['Is_Triple_Danger'] = ((df['M14AM14B'] > 500) & (df['M14AM14BSUM'] > 600) & (df['Queue_Gap'] > 200)).astype(int)
    df['Is_Gold_Pattern'] = ((df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)).astype(int)
    
    return df

# --------------------------------------------
# 2. ë°ì´í„° ì¤€ë¹„ ë° í•™ìŠµ
# --------------------------------------------
def train():
    print("ğŸ”„ ë°ì´í„° ë¡œë”© ì¤‘...")
    df = pd.read_csv(TRAIN_FILE, on_bad_lines='skip')
    
    # ì»¬ëŸ¼ ì´ë¦„ í†µì¼
    rename_dict = {}
    cols_map = {'TOTALCNT': 'TOTALCNT', 'M14B': 'M14AM14B', 'M14BSUM': 'M14AM14BSUM'}
    for k, v in cols_map.items():
        if v in df.columns: rename_dict[v] = k
    df = df.rename(columns=rename_dict)
    
    # ë³€ìˆ˜ ìƒì„±
    df = create_features(df)
    
    # Target ìƒì„± (ë¯¸ë˜ 10ë¶„ MAX >= 1700)
    indexer = pd.api.indexers.FixedForwardWindowIndexer(window_size=PRED_MINUTES)
    df['Future_Max'] = df['TOTALCNT'].rolling(window=indexer).max().shift(-1)
    df['Target'] = (df['Future_Max'] >= THRESHOLD).astype(int)
    
    # í•™ìŠµì— ì“¸ ë³€ìˆ˜ ì§€ì •
    features = [
        'TOTALCNT', 'M14B', 'M14BSUM', 'Queue_Gap', 'Dist_to_Limit',
        'Vel_Total_1m', 'Vel_Total_3m', 'Vel_Total_5m', 'Vel_Total_10m',
        'Vel_Gap_3m', 'Acc_Total', 'Vol_Total_10m', 
        'Is_Triple_Danger', 'Is_Gold_Pattern'
    ]
    
    # ê²°ì¸¡ì¹˜ ì œê±°
    df_train = df.dropna(subset=features + ['Target']).reset_index(drop=True)
    
    print(f"âœ… í•™ìŠµ ë°ì´í„°: {len(df_train):,}í–‰")
    
    # ê°€ì¤‘ì¹˜ ê³„ì‚° (ë¶ˆê· í˜• ë°ì´í„° í•´ê²°)
    neg, pos = np.bincount(df_train['Target'])
    scale_weight = neg / pos if pos > 0 else 1
    print(f"âš–ï¸ ê°€ì¤‘ì¹˜(scale_pos_weight): {scale_weight:.2f}")
    
    # XGBoost í•™ìŠµ
    print("ğŸš€ í•™ìŠµ ì‹œì‘...")
    model = xgb.XGBClassifier(
        n_estimators=500,
        max_depth=6,
        learning_rate=0.03,
        scale_pos_weight=scale_weight * 1.5, # Recall ê°•í™”
        random_state=42,
        n_jobs=-1,
        tree_method='hist'
    )
    
    model.fit(df_train[features], df_train['Target'])
    
    # ì €ì¥
    with open('model_v12.pkl', 'wb') as f:
        pickle.dump(model, f)
    with open('features_v12.pkl', 'wb') as f:
        pickle.dump(features, f)
        
    print("\nğŸ’¾ ì €ì¥ ì™„ë£Œ:")
    print("  1. ëª¨ë¸: model_v12.pkl")
    print("  2. ë³€ìˆ˜ëª©ë¡: features_v12.pkl")
    print("âœ… í•™ìŠµ ë! ì´ì œ eval_v12.pyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")

if __name__ == "__main__":
    train()
