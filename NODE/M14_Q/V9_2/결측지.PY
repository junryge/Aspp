#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ” AMHS ê²°ì¸¡ì¹˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì‹¤í–‰ë°©ë²•:
    python missing_dashboard.py

ì¶œë ¥íŒŒì¼:
    - missing_dashboard.html  (ì¸í„°ë™í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ)
    - missing_by_column.csv   (ì»¬ëŸ¼ë³„ ê²°ì¸¡ì¹˜)
    - missing_by_date.csv     (ë‚ ì§œë³„ ê²°ì¸¡ì¹˜)
    - missing_by_hour.csv     (ì‹œê°„ëŒ€ë³„ ê²°ì¸¡ì¹˜)
    - key_columns_status.csv  (í•µì‹¬ 8ê°œ ì»¬ëŸ¼ ìƒíƒœ)
    - collection_gaps.csv     (ë¯¸ìˆ˜ì§‘ êµ¬ê°„)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""

import pandas as pd
import numpy as np
from datetime import datetime
import os
import json
import warnings
warnings.filterwarnings('ignore')

# ============================================================
# âš™ï¸ ì„¤ì • - ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë¨!
# ============================================================
CONFIG = {
    'input_file': 'data/M14_Q_20250802_TO_20251015.csv',  # ğŸ“Œ ë¶„ì„í•  CSV íŒŒì¼ ê²½ë¡œ
    'output_dir': 'missing_results',                       # ğŸ“Œ ê²°ê³¼ ì €ì¥ í´ë”
    'time_column': 'CURRTIME',                             # ì‹œê°„ ì»¬ëŸ¼ëª…
    'time_format': '%Y%m%d%H%M',                           # ì‹œê°„ í¬ë§· (YYYYMMDDHHMM)
}

# V8.3 í•µì‹¬ ì»¬ëŸ¼ (ìˆ˜ì • ê°€ëŠ¥)
KEY_COLUMNS = [
    ('M14AM14B', 'M14AM14B'),
    ('M14AM14BSUM', 'M14AM14BSUM'),
    ('M10AM14A', 'M10AM14A'),
    ('TOTALCNT', 'TOTALCNT'),
    ('M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'TRANSPORT'),
    ('M14.QUE.OHT.OHTUTIL', 'OHT_UTIL'),
    ('M14.QUE.ALL.CURRENTQCREATED', 'Q_CREATED'),
    ('M14.QUE.ALL.CURRENTQCOMPLETED', 'Q_COMPLETED'),
]
# ============================================================


class MissingAnalyzer:
    def __init__(self, config):
        self.config = config
        self.df = None
        self.analysis = {}
        
    def load_data(self):
        """ë°ì´í„° ë¡œë“œ"""
        file_path = self.config['input_file']
        print(f"\nğŸ“‚ ë°ì´í„° ë¡œë”©: {file_path}")
        
        if not os.path.exists(file_path):
            print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
            print("ğŸ’¡ CONFIGì˜ 'input_file' ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”!")
            return False
        
        self.df = pd.read_csv(file_path, on_bad_lines='skip')
        print(f"âœ… {len(self.df):,}í–‰ Ã— {self.df.shape[1]}ì—´")
        
        # ì‹œê°„ ì»¬ëŸ¼ íŒŒì‹±
        time_col = self.config['time_column']
        if time_col in self.df.columns:
            self.df[time_col] = self.df[time_col].astype(str).str.strip()
            self.df[time_col] = pd.to_datetime(
                self.df[time_col], 
                format=self.config['time_format'], 
                errors='coerce'
            )
            self.df['DATE'] = self.df[time_col].dt.date
            self.df['HOUR'] = self.df[time_col].dt.hour
            
            valid_times = self.df[time_col].dropna()
            if len(valid_times) > 0:
                print(f"ğŸ“… ê¸°ê°„: {valid_times.min()} ~ {valid_times.max()}")
        
        return True
    
    def analyze(self):
        """ì „ì²´ ë¶„ì„ ì‹¤í–‰"""
        print("\nğŸ” ë¶„ì„ ì¤‘...")
        df = self.df
        total = len(df)
        time_col = self.config['time_column']
        
        # 1. ê¸°ë³¸ ì •ë³´
        date_start = '-'
        date_end = '-'
        if time_col in df.columns:
            valid_times = df[time_col].dropna()
            if len(valid_times) > 0:
                date_start = valid_times.min().strftime('%Y-%m-%d %H:%M')
                date_end = valid_times.max().strftime('%Y-%m-%d %H:%M')
        
        self.analysis['info'] = {
            'file': os.path.basename(self.config['input_file']),
            'total_rows': total,
            'total_cols': len(df.columns),
            'date_start': date_start,
            'date_end': date_end,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        # 2. ì»¬ëŸ¼ë³„ ê²°ì¸¡ì¹˜
        exclude_cols = ['DATE', 'HOUR']
        analysis_cols = [c for c in df.columns if c not in exclude_cols]
        
        missing_counts = df[analysis_cols].isnull().sum()
        missing_pct = (missing_counts / total * 100).round(2)
        
        col_summary = []
        for col in analysis_cols:
            col_summary.append({
                'column': col,
                'missing': int(missing_counts[col]),
                'pct': float(missing_pct[col]),
                'valid': int(total - missing_counts[col]),
                'dtype': str(df[col].dtype)
            })
        
        col_summary = sorted(col_summary, key=lambda x: x['pct'], reverse=True)
        self.analysis['columns'] = col_summary
        self.analysis['missing_columns'] = [c for c in col_summary if c['missing'] > 0]
        
        # 3. ë‚ ì§œë³„ ê²°ì¸¡ì¹˜
        daily_missing = []
        if 'DATE' in df.columns:
            dates = sorted(df['DATE'].dropna().unique())
            num_cols = len(analysis_cols)
            for date in dates:
                day_df = df[df['DATE'] == date]
                day_total = len(day_df)
                day_missing = int(day_df[analysis_cols].isnull().sum().sum())
                day_pct = round((day_missing / (day_total * num_cols)) * 100, 2) if day_total > 0 else 0
                daily_missing.append({
                    'date': date.strftime('%Y-%m-%d') if hasattr(date, 'strftime') else str(date),
                    'rows': day_total,
                    'missing_cells': day_missing,
                    'pct': day_pct
                })
        self.analysis['daily'] = daily_missing
        
        # 4. ì‹œê°„ëŒ€ë³„ ê²°ì¸¡ì¹˜
        hourly_missing = []
        if 'HOUR' in df.columns:
            num_cols = len(analysis_cols)
            for hour in range(24):
                hour_df = df[df['HOUR'] == hour]
                if len(hour_df) > 0:
                    hour_missing = int(hour_df[analysis_cols].isnull().sum().sum())
                    hour_pct = round((hour_missing / (len(hour_df) * num_cols)) * 100, 2)
                    hourly_missing.append({
                        'hour': f'{hour:02d}:00',
                        'rows': len(hour_df),
                        'missing_cells': hour_missing,
                        'pct': hour_pct
                    })
        self.analysis['hourly'] = hourly_missing
        
        # 5. í•µì‹¬ ì»¬ëŸ¼ ìƒíƒœ
        key_status = []
        for col, short in KEY_COLUMNS:
            if col in df.columns:
                m = int(df[col].isnull().sum())
                p = round(m / total * 100, 2)
                status = 'âœ…' if p == 0 else 'âš ï¸' if p < 1 else 'âŒ'
                key_status.append({
                    'column': col, 'short': short, 'missing': m, 
                    'pct': p, 'status': status, 'exists': True
                })
            else:
                key_status.append({
                    'column': col, 'short': short, 'missing': total, 
                    'pct': 100, 'status': 'âŒ', 'exists': False
                })
        self.analysis['key_columns'] = key_status
        
        # 6. ìˆ˜ì§‘ ê°„ê²© ë¶„ì„
        gaps = []
        gap_stats = {'total_gaps': 0, 'max_gap': 0, 'total_missing_min': 0}
        
        if time_col in df.columns:
            df_sorted = df.dropna(subset=[time_col]).sort_values(time_col).reset_index(drop=True)
            if len(df_sorted) > 1:
                df_sorted['time_diff'] = df_sorted[time_col].diff().dt.total_seconds() / 60
                gap_df = df_sorted[df_sorted['time_diff'] > 1.5].copy()
                
                for idx, row in gap_df.head(50).iterrows():
                    prev_idx = idx - 1
                    if prev_idx >= 0 and prev_idx in df_sorted.index:
                        start_time = df_sorted.loc[prev_idx, time_col]
                        gaps.append({
                            'start': start_time.strftime('%Y-%m-%d %H:%M') if pd.notna(start_time) else '-',
                            'end': row[time_col].strftime('%Y-%m-%d %H:%M') if pd.notna(row[time_col]) else '-',
                            'gap_min': round(row['time_diff'], 1)
                        })
                
                if len(gap_df) > 0:
                    gap_stats = {
                        'total_gaps': len(gap_df),
                        'max_gap': round(gap_df['time_diff'].max(), 1),
                        'total_missing_min': round(gap_df['time_diff'].sum(), 0)
                    }
        
        self.analysis['gaps'] = gaps
        self.analysis['gap_stats'] = gap_stats
        
        # 7. ì¤‘ë³µ ì²´í¬
        self.analysis['duplicates'] = {
            'full': int(df.duplicated().sum()),
            'time': int(df[time_col].duplicated().sum()) if time_col in df.columns else 0
        }
        
        # 8. ìš”ì•½
        num_cols = len(analysis_cols)
        total_cells = total * num_cols
        total_missing = df[analysis_cols].isnull().sum().sum()
        
        self.analysis['summary'] = {
            'total_cells': int(total_cells),
            'missing_cells': int(total_missing),
            'missing_pct': round(total_missing / total_cells * 100, 2) if total_cells > 0 else 0,
            'columns_with_missing': len(self.analysis['missing_columns']),
            'columns_complete': len([c for c in col_summary if c['missing'] == 0])
        }
        
        print("âœ… ë¶„ì„ ì™„ë£Œ!")
        return self
    
    def save_csv(self):
        """CSV ê²°ê³¼ ì €ì¥"""
        output_dir = self.config['output_dir']
        os.makedirs(output_dir, exist_ok=True)
        
        # ì»¬ëŸ¼ë³„
        pd.DataFrame(self.analysis['columns']).to_csv(
            f'{output_dir}/missing_by_column.csv', index=False, encoding='utf-8-sig')
        
        # ë‚ ì§œë³„
        if self.analysis['daily']:
            pd.DataFrame(self.analysis['daily']).to_csv(
                f'{output_dir}/missing_by_date.csv', index=False, encoding='utf-8-sig')
        
        # ì‹œê°„ëŒ€ë³„
        if self.analysis['hourly']:
            pd.DataFrame(self.analysis['hourly']).to_csv(
                f'{output_dir}/missing_by_hour.csv', index=False, encoding='utf-8-sig')
        
        # í•µì‹¬ ì»¬ëŸ¼
        pd.DataFrame(self.analysis['key_columns']).to_csv(
            f'{output_dir}/key_columns_status.csv', index=False, encoding='utf-8-sig')
        
        # ë¯¸ìˆ˜ì§‘ êµ¬ê°„
        if self.analysis['gaps']:
            pd.DataFrame(self.analysis['gaps']).to_csv(
                f'{output_dir}/collection_gaps.csv', index=False, encoding='utf-8-sig')
        
        print(f"\nğŸ’¾ CSV ì €ì¥ ì™„ë£Œ: {output_dir}/")
        return self
    
    def generate_html(self):
        """HTML ëŒ€ì‹œë³´ë“œ ìƒì„±"""
        output_dir = self.config['output_dir']
        os.makedirs(output_dir, exist_ok=True)
        
        a = self.analysis
        
        # ì°¨íŠ¸ ë°ì´í„°
        daily_labels = json.dumps([d['date'] for d in a['daily']])
        daily_data = json.dumps([d['pct'] for d in a['daily']])
        hourly_labels = json.dumps([h['hour'] for h in a['hourly']])
        hourly_data = json.dumps([h['pct'] for h in a['hourly']])
        
        top_missing = a['missing_columns'][:20]
        top_labels = json.dumps([c['column'][:35] for c in top_missing])
        top_data = json.dumps([c['pct'] for c in top_missing])
        
        key_labels = json.dumps([k['short'] for k in a['key_columns']])
        key_data = json.dumps([k['pct'] for k in a['key_columns']])
        key_colors = json.dumps(['#22c55e' if k['pct']==0 else '#f59e0b' if k['pct']<1 else '#ef4444' for k in a['key_columns']])
        
        html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” AMHS ê²°ì¸¡ì¹˜ ë¶„ì„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #e4e4e7; min-height: 100vh; padding: 20px; }}
        .container {{ max-width: 1600px; margin: 0 auto; }}
        header {{ text-align: center; padding: 30px; margin-bottom: 30px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }}
        header h1 {{ font-size: 2.2rem; margin-bottom: 10px; }}
        header p {{ color: #a1a1aa; }}
        .stats-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }}
        .stat-card {{ background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }}
        .stat-card:hover {{ transform: translateY(-3px); transition: 0.2s; }}
        .stat-card .icon {{ font-size: 1.8rem; margin-bottom: 8px; }}
        .stat-card .value {{ font-size: 1.8rem; font-weight: bold; color: #60a5fa; }}
        .stat-card .label {{ color: #a1a1aa; margin-top: 4px; font-size: 0.9rem; }}
        .stat-card.warning .value {{ color: #fbbf24; }}
        .stat-card.danger .value {{ color: #f87171; }}
        .stat-card.success .value {{ color: #4ade80; }}
        .section {{ background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1); }}
        .section h2 {{ font-size: 1.3rem; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }}
        .chart-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }}
        .chart-box {{ background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; min-height: 320px; }}
        .chart-box h3 {{ margin-bottom: 12px; color: #d4d4d8; font-size: 1rem; }}
        table {{ width: 100%; border-collapse: collapse; font-size: 0.85rem; }}
        th, td {{ padding: 10px 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }}
        th {{ background: rgba(0,0,0,0.3); font-weight: 600; color: #a1a1aa; text-transform: uppercase; font-size: 0.75rem; }}
        tr:hover {{ background: rgba(255,255,255,0.05); }}
        .badge {{ padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }}
        .badge-ok {{ background: #166534; color: #4ade80; }}
        .badge-warn {{ background: #854d0e; color: #fbbf24; }}
        .badge-error {{ background: #991b1b; color: #fca5a5; }}
        .progress {{ width: 80px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 8px; }}
        .progress-fill {{ height: 100%; border-radius: 3px; }}
        .progress-ok {{ background: #22c55e; }}
        .progress-warn {{ background: #f59e0b; }}
        .progress-error {{ background: #ef4444; }}
        .key-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }}
        .key-card {{ background: rgba(0,0,0,0.2); border-radius: 10px; padding: 14px; display: flex; align-items: center; gap: 12px; }}
        .key-card .icon {{ font-size: 1.6rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }}
        .key-card .icon.ok {{ background: rgba(34,197,94,0.2); }}
        .key-card .icon.warn {{ background: rgba(245,158,11,0.2); }}
        .key-card .icon.error {{ background: rgba(239,68,68,0.2); }}
        .key-card .info {{ flex: 1; }}
        .key-card .name {{ font-weight: 600; font-size: 0.85rem; }}
        .key-card .stat {{ color: #a1a1aa; font-size: 0.8rem; margin-top: 2px; }}
        .table-wrap {{ max-height: 400px; overflow-y: auto; }}
        .table-wrap::-webkit-scrollbar {{ width: 6px; }}
        .table-wrap::-webkit-scrollbar-thumb {{ background: rgba(255,255,255,0.2); border-radius: 3px; }}
        .info-box {{ background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 10px; padding: 14px; margin-bottom: 16px; }}
        .info-box strong {{ color: #60a5fa; }}
        footer {{ text-align: center; padding: 24px; color: #71717a; font-size: 0.85rem; }}
        @media (max-width: 768px) {{ .chart-grid {{ grid-template-columns: 1fr; }} .stats-grid {{ grid-template-columns: repeat(2, 1fr); }} }}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ” AMHS ê²°ì¸¡ì¹˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ğŸ“ {a['info']['file']} | â° {a['info']['analysis_time']}</p>
    </header>
    
    <div class="info-box">
        <p>ğŸ“… <strong>ë¶„ì„ ê¸°ê°„:</strong> {a['info']['date_start']} ~ {a['info']['date_end']}</p>
        <p>ğŸ“Š <strong>ë°ì´í„°:</strong> {a['info']['total_rows']:,}í–‰ Ã— {a['info']['total_cols']}ì—´ = {a['summary']['total_cells']:,}ì…€</p>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card"><div class="icon">ğŸ“Š</div><div class="value">{a['info']['total_rows']:,}</div><div class="label">ì „ì²´ í–‰</div></div>
        <div class="stat-card"><div class="icon">ğŸ“‹</div><div class="value">{a['info']['total_cols']}</div><div class="label">ì „ì²´ ì»¬ëŸ¼</div></div>
        <div class="stat-card {'warning' if a['summary']['missing_pct']>1 else 'success'}"><div class="icon">âš ï¸</div><div class="value">{a['summary']['missing_pct']}%</div><div class="label">ì „ì²´ ê²°ì¸¡ë¥ </div></div>
        <div class="stat-card {'danger' if a['summary']['columns_with_missing']>10 else 'warning' if a['summary']['columns_with_missing']>0 else 'success'}"><div class="icon">ğŸ”´</div><div class="value">{a['summary']['columns_with_missing']}</div><div class="label">ê²°ì¸¡ ì»¬ëŸ¼</div></div>
        <div class="stat-card success"><div class="icon">âœ…</div><div class="value">{a['summary']['columns_complete']}</div><div class="label">ì™„ì „ ì»¬ëŸ¼</div></div>
        <div class="stat-card {'danger' if a['gap_stats']['total_gaps']>10 else 'warning' if a['gap_stats']['total_gaps']>0 else 'success'}"><div class="icon">â±ï¸</div><div class="value">{a['gap_stats']['total_gaps']}</div><div class="label">ë¯¸ìˆ˜ì§‘ êµ¬ê°„</div></div>
    </div>
    
    <div class="section">
        <h2>ğŸ”‘ í•µì‹¬ ì»¬ëŸ¼ ìƒíƒœ (V8.3)</h2>
        <div class="key-grid">
            {''.join([f'<div class="key-card"><div class="icon {"ok" if k["pct"]==0 else "warn" if k["pct"]<1 else "error"}">{k["status"]}</div><div class="info"><div class="name">{k["short"]}</div><div class="stat">{"ì»¬ëŸ¼ ì—†ìŒ!" if not k["exists"] else f"ê²°ì¸¡: {k["missing"]:,}ê°œ ({k["pct"]}%)"}</div></div></div>' for k in a['key_columns']])}
        </div>
    </div>
    
    <div class="chart-grid">
        <div class="chart-box"><h3>ğŸ“… ë‚ ì§œë³„ ê²°ì¸¡ë¥ </h3><canvas id="dailyChart"></canvas></div>
        <div class="chart-box"><h3>â° ì‹œê°„ëŒ€ë³„ ê²°ì¸¡ë¥ </h3><canvas id="hourlyChart"></canvas></div>
        <div class="chart-box"><h3>ğŸ“Š ê²°ì¸¡ ì»¬ëŸ¼ TOP 20</h3><canvas id="topChart"></canvas></div>
        <div class="chart-box"><h3>ğŸ”‘ í•µì‹¬ ì»¬ëŸ¼ ê²°ì¸¡ë¥ </h3><canvas id="keyChart"></canvas></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“‹ ì „ì²´ ì»¬ëŸ¼ í˜„í™© ({len(a['columns'])}ê°œ) - ê²°ì¸¡ {len(a['missing_columns'])}ê°œ / ì™„ì „ {a['summary']['columns_complete']}ê°œ</h2>
        <div class="table-wrap" style="max-height:600px;">
            <table>
                <thead><tr><th>#</th><th>ì»¬ëŸ¼ëª…</th><th>ë°ì´í„°íƒ€ì…</th><th>ê²°ì¸¡</th><th>ê²°ì¸¡ë¥ </th><th>ìœ íš¨</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>
                    {''.join([f'<tr><td>{i+1}</td><td style="max-width:280px;word-break:break-all;">{c["column"]}</td><td>{c["dtype"]}</td><td>{c["missing"]:,}</td><td>{c["pct"]}%<div class="progress"><div class="progress-fill {"progress-error" if c["pct"]>10 else "progress-warn" if c["pct"]>1 else "progress-ok"}" style="width:{min(c["pct"],100)}%"></div></div></td><td>{c["valid"]:,}</td><td><span class="badge {"badge-error" if c["pct"]>10 else "badge-warn" if c["pct"]>1 else "badge-ok"}">{"ì‹¬ê°" if c["pct"]>10 else "ì£¼ì˜" if c["pct"]>1 else "ì–‘í˜¸"}</span></td></tr>' for i, c in enumerate(a['columns'])])}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="section">
        <h2>ğŸ“… ë‚ ì§œë³„ í˜„í™© ({len(a['daily'])}ì¼)</h2>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ë‚ ì§œ</th><th>ë°ì´í„°</th><th>ê²°ì¸¡ ì…€</th><th>ê²°ì¸¡ë¥ </th><th>ìƒíƒœ</th></tr></thead>
                <tbody>
                    {''.join([f'<tr><td>{d["date"]}</td><td>{d["rows"]:,}</td><td>{d["missing_cells"]:,}</td><td>{d["pct"]}%<div class="progress"><div class="progress-fill {"progress-error" if d["pct"]>5 else "progress-warn" if d["pct"]>1 else "progress-ok"}" style="width:{min(d["pct"]*10,100)}%"></div></div></td><td><span class="badge {"badge-error" if d["pct"]>5 else "badge-warn" if d["pct"]>1 else "badge-ok"}">{"ì‹¬ê°" if d["pct"]>5 else "ì£¼ì˜" if d["pct"]>1 else "ì–‘í˜¸"}</span></td></tr>' for d in a['daily']])}
                </tbody>
            </table>
        </div>
    </div>
    
    {f'''<div class="section">
        <h2>â±ï¸ ë¯¸ìˆ˜ì§‘ êµ¬ê°„ ({a['gap_stats']['total_gaps']}ê±´, ì´ {a['gap_stats']['total_missing_min']:.0f}ë¶„)</h2>
        <div class="info-box"><p>ğŸ“Š <strong>ìµœëŒ€ ê°„ê²©:</strong> {a['gap_stats']['max_gap']}ë¶„ | 1.5ë¶„ ì´ˆê³¼ êµ¬ê°„ë§Œ í‘œì‹œ</p></div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>#</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th><th>ê°„ê²©(ë¶„)</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>{''.join([f"<tr><td>{i+1}</td><td>{g['start']}</td><td>{g['end']}</td><td>{g['gap_min']}</td><td><span class='badge {'badge-error' if g['gap_min']>10 else 'badge-warn'}'>{'ì‹¬ê°' if g['gap_min']>10 else 'ì£¼ì˜'}</span></td></tr>" for i, g in enumerate(a['gaps'])])}</tbody>
            </table>
        </div>
    </div>''' if a['gaps'] else ''}
    
    <div class="section">
        <h2>ğŸ”„ ì¤‘ë³µ ë°ì´í„°</h2>
        <div class="stats-grid" style="max-width:400px;">
            <div class="stat-card {'danger' if a['duplicates']['full']>0 else 'success'}"><div class="value">{a['duplicates']['full']:,}</div><div class="label">ì™„ì „ ì¤‘ë³µ</div></div>
            <div class="stat-card {'warning' if a['duplicates']['time']>0 else 'success'}"><div class="value">{a['duplicates']['time']:,}</div><div class="label">ì‹œê°„ ì¤‘ë³µ</div></div>
        </div>
    </div>
    
    <footer>ğŸ” AMHS ê²°ì¸¡ì¹˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ | V8.3</footer>
</div>

<script>
const colors = {{ primary: 'rgba(96,165,250,1)', primaryBg: 'rgba(96,165,250,0.3)', grid: 'rgba(255,255,255,0.1)', text: '#a1a1aa' }};
Chart.defaults.color = colors.text;
Chart.defaults.borderColor = colors.grid;

new Chart(document.getElementById('dailyChart'), {{
    type: 'line',
    data: {{ labels: {daily_labels}, datasets: [{{ label: 'ê²°ì¸¡ë¥ (%)', data: {daily_data}, borderColor: colors.primary, backgroundColor: colors.primaryBg, fill: true, tension: 0.3 }}] }},
    options: {{ responsive: true, maintainAspectRatio: false, plugins: {{ legend: {{ display: false }} }}, scales: {{ y: {{ beginAtZero: true }}, x: {{ display: {str(len(a['daily']) <= 31).lower()} }} }} }}
}});

new Chart(document.getElementById('hourlyChart'), {{
    type: 'bar',
    data: {{ labels: {hourly_labels}, datasets: [{{ label: 'ê²°ì¸¡ë¥ (%)', data: {hourly_data}, backgroundColor: colors.primaryBg, borderColor: colors.primary, borderWidth: 1 }}] }},
    options: {{ responsive: true, maintainAspectRatio: false, plugins: {{ legend: {{ display: false }} }}, scales: {{ y: {{ beginAtZero: true }} }} }}
}});

new Chart(document.getElementById('topChart'), {{
    type: 'bar',
    data: {{ labels: {top_labels}, datasets: [{{ data: {top_data}, backgroundColor: {top_data}.map(v => v > 10 ? '#ef4444' : v > 1 ? '#f59e0b' : '#22c55e') }}] }},
    options: {{ responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: {{ legend: {{ display: false }} }}, scales: {{ x: {{ beginAtZero: true }} }} }}
}});

new Chart(document.getElementById('keyChart'), {{
    type: 'bar',
    data: {{ labels: {key_labels}, datasets: [{{ data: {key_data}, backgroundColor: {key_colors} }}] }},
    options: {{ responsive: true, maintainAspectRatio: false, plugins: {{ legend: {{ display: false }} }}, scales: {{ y: {{ beginAtZero: true }} }} }}
}});
</script>
</body>
</html>'''
        
        output_path = f'{output_dir}/missing_dashboard.html'
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(html)
        
        print(f"ğŸ¨ HTML ëŒ€ì‹œë³´ë“œ ì €ì¥: {output_path}")
        return self


def main():
    print("=" * 60)
    print("ğŸ” AMHS ê²°ì¸¡ì¹˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
    print("=" * 60)
    
    analyzer = MissingAnalyzer(CONFIG)
    
    if not analyzer.load_data():
        return
    
    analyzer.analyze()
    analyzer.save_csv()
    analyzer.generate_html()
    
    output_dir = CONFIG['output_dir']
    print(f"\n{'=' * 60}")
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print(f"ğŸ“ ê²°ê³¼ í´ë”: {output_dir}/")
    print("   ğŸ“Š missing_dashboard.html  â† ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°!")
    print("   ğŸ“‹ missing_by_column.csv")
    print("   ğŸ“… missing_by_date.csv")
    print("   â° missing_by_hour.csv")
    print("   ğŸ”‘ key_columns_status.csv")
    print("   â±ï¸ collection_gaps.csv")
    print("=" * 60)


if __name__ == '__main__':
    main()