#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ› ï¸ í•™ìŠµ ë°ì´í„° ì •ì œê¸° (ì›ë³¸ ì»¬ëŸ¼ ìœ ì§€ + 1:1 ë¹„ìœ¨)
ê¸°ëŠ¥: ì¡ë‹¤í•œ íŒŒìƒë³€ìˆ˜ ìƒì„± ì—†ì´, ì›ë³¸ ì»¬ëŸ¼(TOTALCNT, M14... ë“±) ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë˜
      ë°ì´í„° ë¹„ìœ¨ë§Œ 50:50ìœ¼ë¡œ ë§ì¶°ì„œ ì €ì¥í•¨.
"""
import pandas as pd
import glob
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸ›¡ï¸ í•™ìŠµ ë°ì´í„° ìƒì„± (ì›ë³¸ í¬ë§· ìœ ì§€ + 1:1 ë¹„ìœ¨)")
print("="*70)

PRED_OFFSET = 10
EXCLUDE_DATE = '2025-12-11' # ğŸ”´ í‰ê°€ì¼ ì œì™¸

def load_data(path_pattern):
    print(f"\nğŸ“‚ ì›ë³¸ ë°ì´í„° ë¡œë”© ì¤‘...")
    files = glob.glob(path_pattern)
    if not files: files = glob.glob('M14_Q_*.CSV')
    
    dfs = []
    for f in sorted(files):
        try: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='utf-8'))
        except: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='cp949'))
    if not dfs: raise ValueError("íŒŒì¼ ì—†ìŒ")
    return pd.concat(dfs, ignore_index=True)

# --- ë©”ì¸ ì‹¤í–‰ ---
if __name__ == '__main__':
    # 1. ë¡œë“œ
    df = load_data('M14_Q_*.CSV')
    
    # 2. ë‚ ì§œ í•„í„°ë§ì„ ìœ„í•œ ì„ì‹œ ë³€ìˆ˜ ìƒì„±
    df['datetime'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    
    # 12ì›” 11ì¼ ì œê±°
    mask_train = df['datetime'].dt.date.astype(str) != EXCLUDE_DATE
    df_train = df[mask_train].copy()
    
    print(f"ğŸ“‰ í‰ê°€ì¼({EXCLUDE_DATE}) ì œì™¸ ì™„ë£Œ.")
    
    # 3. ê³ ë¶€í•˜ íŒë‹¨ì„ ìœ„í•œ ì„ì‹œ íƒ€ê²Ÿ ìƒì„± (ì €ì¥í•  ë• ì§€ì›€)
    # ìˆ«ìë¡œ ë³€í™˜ (ì—ëŸ¬ ë°©ì§€)
    df_train['TOTALCNT_NUM'] = pd.to_numeric(df_train['TOTALCNT'], errors='coerce').fillna(0)
    df_train['Target_Temp'] = df_train['TOTALCNT_NUM'].shift(-PRED_OFFSET)
    
    # NaN ì œê±° (Shiftë¡œ ì¸í•œ ëë¶€ë¶„)
    df_train = df_train.dropna(subset=['Target_Temp']).reset_index(drop=True)
    
    # 4. ë¹„ìœ¨ ë§ì¶”ê¸° (Downsampling)
    print("\nâš–ï¸ ë¹„ìœ¨ 1:1 ë§ì¶¤ (ì •ìƒ ë°ì´í„° ì¤„ì´ê¸°)...")
    
    df_high = df_train[df_train['Target_Temp'] >= 1700].copy()
    df_normal = df_train[df_train['Target_Temp'] < 1700].copy()
    
    cnt_high = len(df_high)
    print(f"   - 1700+ ë°ì´í„°: {cnt_high:,}ê°œ (ê¸°ì¤€)")
    
    if cnt_high > 0:
        # ì •ìƒ ë°ì´í„°ë¥¼ ê³ ë¶€í•˜ ê°œìˆ˜ë§Œí¼ë§Œ ëœë¤ ì¶”ì¶œ
        df_normal_balanced = df_normal.sample(n=cnt_high, random_state=42)
        
        # í•©ì¹˜ê¸°
        df_final = pd.concat([df_high, df_normal_balanced], ignore_index=True)
        
        # ì…”í”Œ
        df_final = df_final.sample(frac=1, random_state=42).reset_index(drop=True)
        
        # 5. [ì¤‘ìš”] ì„ì‹œ ì»¬ëŸ¼ ì‚­ì œ (ì›ë³¸ ì»¬ëŸ¼ë§Œ ë‚¨ê¸°ê¸°)
        # datetime, Target_Temp, TOTALCNT_NUM ë“±ì€ ê³„ì‚°ìš©ì´ì—ˆìœ¼ë‹ˆ ì‚­ì œ
        original_cols = df.columns.tolist() 
        # datetimeì€ ì›ë³¸ì— ì—†ì—ˆìœ¼ë¯€ë¡œ ì œì™¸í•˜ê³  ì €ì¥
        cols_to_save = [c for c in df_final.columns if c in original_cols and c != 'datetime']
        
        df_save = df_final[cols_to_save]
        
        # ê²°ê³¼ í™•ì¸
        print(f"\nğŸ“Š ìµœì¢… ë°ì´í„°ì…‹ ì •ë³´")
        print(f"   - íŒŒì¼ëª…: Clean_Balanced_Data.csv")
        print(f"   - ì»¬ëŸ¼: {list(df_save.columns)}") # ì›ë³¸ ì»¬ëŸ¼ì¸ì§€ í™•ì¸
        print(f"   - ì´ ë°ì´í„° ìˆ˜: {len(df_save):,}ê°œ")
        print(f"   - êµ¬ì„±: ê³ ë¶€í•˜ {cnt_high}ê°œ vs ì •ìƒ {cnt_high}ê°œ")
        
        # ì €ì¥
        df_save.to_csv('Clean_Balanced_Data.csv', index=False, encoding='utf-8-sig')
        print(f"\nâœ… ì €ì¥ ì™„ë£Œ! ì›ë³¸ CSVì™€ ë˜‘ê°™ì€ ëª¨ì–‘ì…ë‹ˆë‹¤.")
        
    else:
        print("âš  1700 ì´ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
