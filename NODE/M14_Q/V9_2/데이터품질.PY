#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”§ V9.3 ë°ì´í„° í’ˆì§ˆ - ê· í˜• ì¡íŒ í•™ìŠµ ë°ì´í„° ìƒì„±

í•µì‹¬:
1. TOTALCNT êµ¬ê°„ë³„ ê· í˜• ìƒ˜í”Œë§
2. ì •ìƒ ë°ì´í„° ë‹¤ìš´ìƒ˜í”Œë§
3. ì „ì´ êµ¬ê°„(1600~1700) ë¹„ì¤‘ ë†’ì´ê¸°
4. 1700+ ì „ë¶€ í¬í•¨
5. ë‹¤ì–‘í•œ ì‹œê°„ëŒ€ íŒ¨í„´ í¬í•¨
"""

import numpy as np
import pandas as pd
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸ”§ V9.3 ë°ì´í„° í’ˆì§ˆ - ê· í˜• ì¡íŒ í•™ìŠµ ë°ì´í„° ìƒì„±")
print("="*70)

# ============================================
# ì„¤ì •
# ============================================
INPUT_FILE = "YOUR_CSV_FILE.csv"  # â† ì›ë³¸ ë°ì´í„°!
OUTPUT_FILE = "train_balanced.csv"  # ê· í˜• ë°ì´í„° ì¶œë ¥

# ëª©í‘œ ë¹„ìœ¨ ì„¤ì •
TARGET_RATIO = {
    'low': 0.20,       # ~1400: 20%
    'normal': 0.20,    # 1400~1550: 20%
    'rising': 0.20,    # 1550~1650: 20%
    'warning': 0.20,   # 1650~1700: 20%
    'danger': 0.20,    # 1700+: 20%
}

# ============================================
# ë°ì´í„° ë¡œë“œ
# ============================================
print(f"\nğŸ“‚ ë°ì´í„° ë¡œë”©: {INPUT_FILE}")
df = pd.read_csv(INPUT_FILE, on_bad_lines='skip')
print(f"âœ… ì›ë³¸: {len(df):,}í–‰")

# í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
required = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 
            'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
missing = [c for c in required if c not in df.columns]
if missing:
    print(f"âŒ ëˆ„ë½ ì»¬ëŸ¼: {missing}")
    exit(1)

# NaN ì œê±°
df = df.dropna(subset=required)
print(f"âœ… NaN ì œê±° í›„: {len(df):,}í–‰")

# queue_gap ê³„ì‚°
df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']

# ============================================
# ì›ë³¸ ë¶„í¬ í™•ì¸
# ============================================
print(f"\nğŸ“Š ì›ë³¸ TOTALCNT ë¶„í¬:")

def get_segment(val):
    if val < 1400:
        return 'low'
    elif val < 1550:
        return 'normal'
    elif val < 1650:
        return 'rising'
    elif val < 1700:
        return 'warning'
    else:
        return 'danger'

df['segment'] = df['TOTALCNT'].apply(get_segment)
orig_counts = df['segment'].value_counts()

for seg in ['low', 'normal', 'rising', 'warning', 'danger']:
    cnt = orig_counts.get(seg, 0)
    pct = cnt / len(df) * 100
    print(f"  {seg:10}: {cnt:7,}ê°œ ({pct:5.1f}%)")

# ============================================
# ê· í˜• ìƒ˜í”Œë§
# ============================================
print(f"\nğŸ”§ ê· í˜• ìƒ˜í”Œë§ ì‹œì‘...")

# 1700+ ì „ì²´ ê°œìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ëª©í‘œ ì„¤ì •
danger_count = len(df[df['segment'] == 'danger'])
print(f"  1700+ (danger): {danger_count:,}ê°œ (ì „ë¶€ í¬í•¨)")

# ëª©í‘œ ì´ ê°œìˆ˜ ê³„ì‚° (danger ê¸°ì¤€)
target_total = int(danger_count / TARGET_RATIO['danger'])
print(f"  ëª©í‘œ ì´ ê°œìˆ˜: {target_total:,}ê°œ")

# ì„¸ê·¸ë¨¼íŠ¸ë³„ ëª©í‘œ ê°œìˆ˜
target_counts = {seg: int(target_total * ratio) for seg, ratio in TARGET_RATIO.items()}
target_counts['danger'] = danger_count  # dangerëŠ” ì „ë¶€!

print(f"\nğŸ“Š ì„¸ê·¸ë¨¼íŠ¸ë³„ ëª©í‘œ:")
for seg, cnt in target_counts.items():
    print(f"  {seg:10}: {cnt:,}ê°œ")

# ============================================
# ë‹¤ì–‘í•œ íŒ¨í„´ ìƒ˜í”Œë§ í•¨ìˆ˜
# ============================================
def diverse_sampling(df_seg, target_n, segment_name):
    """ì‹œê°„ëŒ€/íŒ¨í„´ ë‹¤ì–‘í•˜ê²Œ ìƒ˜í”Œë§"""
    
    if len(df_seg) <= target_n:
        print(f"  {segment_name}: ì „ì²´ í¬í•¨ ({len(df_seg):,}ê°œ)")
        return df_seg
    
    sampled_indices = []
    
    # 1. ì‹œê°„ëŒ€ë³„ ë¶„ì‚° (CURRTIME ìˆìœ¼ë©´)
    if 'CURRTIME' in df_seg.columns:
        try:
            df_seg = df_seg.copy()
            df_seg['hour'] = pd.to_datetime(df_seg['CURRTIME'].astype(str), format='%Y%m%d%H%M').dt.hour
            
            # ì‹œê°„ëŒ€ë³„ë¡œ ê³¨ê³ ë£¨
            hours = df_seg['hour'].unique()
            per_hour = target_n // len(hours)
            
            for hour in hours:
                hour_df = df_seg[df_seg['hour'] == hour]
                if len(hour_df) > 0:
                    n_sample = min(per_hour, len(hour_df))
                    sampled_indices.extend(hour_df.sample(n=n_sample, random_state=42).index.tolist())
            
            # ë¶€ì¡±í•œ ë§Œí¼ ì¶”ê°€ ìƒ˜í”Œë§
            remaining = target_n - len(sampled_indices)
            if remaining > 0:
                available = df_seg[~df_seg.index.isin(sampled_indices)]
                if len(available) > 0:
                    extra = min(remaining, len(available))
                    sampled_indices.extend(available.sample(n=extra, random_state=42).index.tolist())
        except:
            # ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨ ì‹œ ëœë¤ ìƒ˜í”Œë§
            sampled_indices = df_seg.sample(n=target_n, random_state=42).index.tolist()
    else:
        # CURRTIME ì—†ìœ¼ë©´ ëœë¤ ìƒ˜í”Œë§
        sampled_indices = df_seg.sample(n=target_n, random_state=42).index.tolist()
    
    result = df_seg.loc[sampled_indices[:target_n]]
    print(f"  {segment_name}: {len(df_seg):,} â†’ {len(result):,}ê°œ")
    return result

# ============================================
# ì„¸ê·¸ë¨¼íŠ¸ë³„ ìƒ˜í”Œë§ ì‹¤í–‰
# ============================================
sampled_dfs = []

for seg in ['low', 'normal', 'rising', 'warning', 'danger']:
    df_seg = df[df['segment'] == seg]
    target_n = target_counts[seg]
    
    if seg == 'danger':
        # dangerëŠ” ì „ë¶€ í¬í•¨!
        sampled_dfs.append(df_seg)
        print(f"  {seg}: ì „ì²´ í¬í•¨ ({len(df_seg):,}ê°œ)")
    else:
        sampled = diverse_sampling(df_seg, target_n, seg)
        sampled_dfs.append(sampled)

# í•©ì¹˜ê¸°
df_balanced = pd.concat(sampled_dfs, ignore_index=True)

# ì…”í”Œ
df_balanced = df_balanced.sample(frac=1, random_state=42).reset_index(drop=True)

# ============================================
# ê²°ê³¼ í™•ì¸
# ============================================
print(f"\nğŸ“Š ê· í˜• ë°ì´í„° ë¶„í¬:")
balanced_counts = df_balanced['segment'].value_counts()

for seg in ['low', 'normal', 'rising', 'warning', 'danger']:
    cnt = balanced_counts.get(seg, 0)
    pct = cnt / len(df_balanced) * 100
    marker = "âœ…" if 15 <= pct <= 25 else "âš ï¸"
    print(f"  {seg:10}: {cnt:7,}ê°œ ({pct:5.1f}%) {marker}")

# ============================================
# íŒ¨í„´ ë‹¤ì–‘ì„± í™•ì¸
# ============================================
print(f"\nğŸ“Š íŒ¨í„´ ë‹¤ì–‘ì„± í™•ì¸:")

# í™©ê¸ˆíŒ¨í„´
gold = (df_balanced['M14AM14B'] > 520) & (df_balanced['M14AM14BSUM'] > 600)
print(f"  í™©ê¸ˆíŒ¨í„´: {gold.sum():,}ê°œ ({gold.sum()/len(df_balanced)*100:.1f}%)")

# gap ë¶„í¬
print(f"  queue_gap ë¶„í¬:")
print(f"    < 100: {(df_balanced['queue_gap'] < 100).sum():,}ê°œ")
print(f"    100~200: {((df_balanced['queue_gap'] >= 100) & (df_balanced['queue_gap'] < 200)).sum():,}ê°œ")
print(f"    200~300: {((df_balanced['queue_gap'] >= 200) & (df_balanced['queue_gap'] < 300)).sum():,}ê°œ")
print(f"    300+: {(df_balanced['queue_gap'] >= 300).sum():,}ê°œ")

# 1700+ ì„¸ë¶€
danger_df = df_balanced[df_balanced['segment'] == 'danger']
print(f"\nğŸ“Š 1700+ ì„¸ë¶€ ë¶„ì„:")
print(f"  1700~1750: {((danger_df['TOTALCNT'] >= 1700) & (danger_df['TOTALCNT'] < 1750)).sum()}ê°œ")
print(f"  1750~1800: {((danger_df['TOTALCNT'] >= 1750) & (danger_df['TOTALCNT'] < 1800)).sum()}ê°œ")
print(f"  1800+: {(danger_df['TOTALCNT'] >= 1800).sum()}ê°œ")

# ============================================
# ì €ì¥
# ============================================
# segment ì»¬ëŸ¼ ì œê±° í›„ ì €ì¥
df_balanced = df_balanced.drop(columns=['segment', 'hour'], errors='ignore')
df_balanced.to_csv(OUTPUT_FILE, index=False)

print(f"\nğŸ’¾ ì €ì¥: {OUTPUT_FILE}")
print(f"  í–‰: {len(df_balanced):,}")
print(f"  ì—´: {df_balanced.shape[1]}")

# ============================================
# ìš”ì•½
# ============================================
print(f"\n" + "="*70)
print("âœ… ë°ì´í„° í’ˆì§ˆ ì²˜ë¦¬ ì™„ë£Œ!")
print("="*70)
print(f"""
ì›ë³¸: {len(df):,}ê°œ
  â†’ ê· í˜•: {len(df_balanced):,}ê°œ

ë³€í™”:
  low (~1400):     {orig_counts.get('low',0)/len(df)*100:.1f}% â†’ {balanced_counts.get('low',0)/len(df_balanced)*100:.1f}%
  normal:          {orig_counts.get('normal',0)/len(df)*100:.1f}% â†’ {balanced_counts.get('normal',0)/len(df_balanced)*100:.1f}%
  rising:          {orig_counts.get('rising',0)/len(df)*100:.1f}% â†’ {balanced_counts.get('rising',0)/len(df_balanced)*100:.1f}%
  warning:         {orig_counts.get('warning',0)/len(df)*100:.1f}% â†’ {balanced_counts.get('warning',0)/len(df_balanced)*100:.1f}%
  danger (1700+):  {orig_counts.get('danger',0)/len(df)*100:.1f}% â†’ {balanced_counts.get('danger',0)/len(df_balanced)*100:.1f}%

ë‹¤ìŒ ë‹¨ê³„: V93_í•™ìŠµ ì‹¤í–‰!
""")