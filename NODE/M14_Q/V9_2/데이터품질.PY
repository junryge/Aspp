import pandas as pd
import numpy as np
import glob
import warnings
warnings.filterwarnings('ignore')

print("ğŸš€ ë°ì´í„° ë¹„ìœ¨ ì¡°ì • ë° CSV ì €ì¥ ì‹œì‘...")

# 1. ì›ë³¸ ë°ì´í„° ë¡œë“œ
files = glob.glob('M14_Q_*.CSV')
if not files:
    print("âŒ M14_Q_*.CSV íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    exit()

dfs = []
for f in sorted(files):
    try: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='utf-8'))
    except: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='cp949'))
df = pd.concat(dfs, ignore_index=True)

# 2. ì „ì²˜ë¦¬ (ìˆ«ì ë³€í™˜)
cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 
        'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
        'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
for c in cols:
    df[c] = pd.to_numeric(df[c], errors='coerce').fillna(0)

# 3. íƒ€ê²Ÿ ìƒì„± (1700 ì´ìƒì¸ì§€ íŒë‹¨í•˜ê¸° ìœ„í•´ í•„ìˆ˜)
# 10ë¶„ ë’¤ ì˜ˆì¸¡ì´ë¯€ë¡œ -10 shift
df['Target_Total_Future'] = df['TOTALCNT'].shift(-10)

# 4. 12ì›” 11ì¼(í‰ê°€ìš©) ë°ì´í„° ì œê±°
df['datetime'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
df_train = df[df['datetime'].dt.date.astype(str) != '2025-12-11'].copy()
df_train = df_train.dropna(subset=['Target_Total_Future']).reset_index(drop=True)

# 5. ë¹„ìœ¨ ì¡°ì • (í•µì‹¬!)
# 1700 ì´ìƒ(High) vs ë¯¸ë§Œ(Normal)
df_high = df_train[df_train['Target_Total_Future'] >= 1700].copy()
df_normal = df_train[df_train['Target_Total_Future'] < 1700].copy()

count_high = len(df_high)
count_normal = len(df_normal)

print(f" - ì •ìƒ ë°ì´í„°: {count_normal:,}ê°œ")
print(f" - 1700+ ë°ì´í„°: {count_high:,}ê°œ")

if count_high > 0:
    # ë¹„ìœ¨ ë§ì¶”ê¸° (ì •ìƒ ë°ì´í„° ê°œìˆ˜ë§Œí¼ 1700 ë°ì´í„° ë³µì‚¬)
    multiplier = int(count_normal / count_high)
    print(f"ğŸ”¥ 1700+ ë°ì´í„°ë¥¼ {multiplier}ë°°ë¡œ ë»¥íŠ€ê¸°í•©ë‹ˆë‹¤.")
    
    df_high_augmented = pd.concat([df_high] * multiplier, ignore_index=True)
    
    # í•©ì¹˜ê¸°
    df_balanced = pd.concat([df_normal, df_high_augmented], ignore_index=True)
    
    # ìˆœì„œ ì„ê¸°
    df_balanced = df_balanced.sample(frac=1, random_state=42).reset_index(drop=True)
    
    # 6. CSV ì €ì¥
    filename = 'Balanced_Data.csv'
    df_balanced.to_csv(filename, index=False, encoding='utf-8-sig')
    
    print(f"\nâœ… ì €ì¥ ì™„ë£Œ: {filename}")
    print(f"   ì´ ë°ì´í„°: {len(df_balanced):,}ê°œ (1700+ ë¹„ìœ¨ ì•½ 50% ë§ì¶¤)")
else:
    print("âŒ 1700 ì´ìƒ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì¦í­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")