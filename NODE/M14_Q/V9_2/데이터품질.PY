#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š ë°ì´í„° í’ˆì§ˆ ì²´í¬ & ì •ì œ
1. ì¤‘ë³µ ë°ì´í„° í™•ì¸/ì œê±°
2. 1700+ ë°ì´í„° í™•ì¸
3. ì •ì œëœ ë°ì´í„° ì €ì¥
"""

import pandas as pd
import numpy as np
import glob

print("="*70)
print("ğŸ“Š ë°ì´í„° í’ˆì§ˆ ì²´í¬")
print("="*70)

# ========================================
# 1. ë°ì´í„° ë¡œë“œ
# ========================================
print("\nğŸ“‚ ë°ì´í„° ë¡œë”©...")

# íŒŒì¼ ê²½ë¡œ ìˆ˜ì • í•„ìš”
DATA_FILE = 'data/M14_í•™ìŠµë°ì´í„°.csv'  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½

df = pd.read_csv(DATA_FILE, on_bad_lines='skip')
print(f"âœ… ì›ë³¸ ë°ì´í„°: {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")

# ========================================
# 2. í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
# ========================================
required = [
    'CURRTIME',
    'TOTALCNT', 
    'M14AM14B', 
    'M14AM14BSUM', 
    'M10AM14A',
    'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 
    'M14.QUE.OHT.OHTUTIL',
    'M14.QUE.ALL.CURRENTQCREATED', 
    'M14.QUE.ALL.CURRENTQCOMPLETED'
]

missing = [c for c in required if c not in df.columns]
if missing:
    print(f"âŒ ëˆ„ë½ ì»¬ëŸ¼: {missing}")
else:
    print(f"âœ… í•„ìˆ˜ ì»¬ëŸ¼ 9ê°œ í™•ì¸")

# ========================================
# 3. ì¤‘ë³µ ë°ì´í„° í™•ì¸
# ========================================
print("\n" + "="*70)
print("ğŸ” ì¤‘ë³µ ë°ì´í„° í™•ì¸")
print("="*70)

# 3-1. ì™„ì „ ì¤‘ë³µ (ëª¨ë“  ì»¬ëŸ¼ ë™ì¼)
full_dup = df.duplicated().sum()
print(f"\nì™„ì „ ì¤‘ë³µ (ëª¨ë“  ì»¬ëŸ¼ ë™ì¼): {full_dup:,}ê°œ")

# 3-2. CURRTIME ì¤‘ë³µ (ê°™ì€ ì‹œê°„ì— ì—¬ëŸ¬ í–‰)
time_dup = df.duplicated(subset=['CURRTIME']).sum()
print(f"CURRTIME ì¤‘ë³µ: {time_dup:,}ê°œ")

# 3-3. ì—°ì† ë™ì¼ê°’ (ì‹œê°„ë§Œ ë‹¤ë¥´ê³  ë‚˜ë¨¸ì§€ ë™ì¼)
check_cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A']
df['ì—°ì†ì¤‘ë³µ'] = df[check_cols].eq(df[check_cols].shift()).all(axis=1)
consecutive_dup = df['ì—°ì†ì¤‘ë³µ'].sum()
print(f"ì—°ì† ë™ì¼ê°’ (ì‹œê°„ ì œì™¸ ë™ì¼): {consecutive_dup:,}ê°œ")

# ì¤‘ë³µ ìƒ˜í”Œ ë³´ê¸°
if consecutive_dup > 0:
    print("\n[ì—°ì† ì¤‘ë³µ ìƒ˜í”Œ]")
    dup_idx = df[df['ì—°ì†ì¤‘ë³µ']].index[:5]
    for idx in dup_idx:
        print(f"  í–‰ {idx-1} â†’ {idx}: TOTALCNT={df.loc[idx, 'TOTALCNT']}")

# ========================================
# 4. 1700+ ë°ì´í„° í™•ì¸
# ========================================
print("\n" + "="*70)
print("ğŸ”¥ 1700+ ë°ì´í„° í™•ì¸")
print("="*70)

total_rows = len(df)
high_1700 = (df['TOTALCNT'] >= 1700).sum()
high_1600 = ((df['TOTALCNT'] >= 1600) & (df['TOTALCNT'] < 1700)).sum()
high_1400 = ((df['TOTALCNT'] >= 1400) & (df['TOTALCNT'] < 1600)).sum()
normal = (df['TOTALCNT'] < 1400).sum()

print(f"\nêµ¬ê°„ë³„ ë¶„í¬:")
print(f"  0~1400:    {normal:>7,}ê°œ ({normal/total_rows*100:5.2f}%)")
print(f"  1400~1600: {high_1400:>7,}ê°œ ({high_1400/total_rows*100:5.2f}%)")
print(f"  1600~1700: {high_1600:>7,}ê°œ ({high_1600/total_rows*100:5.2f}%)")
print(f"  1700+:     {high_1700:>7,}ê°œ ({high_1700/total_rows*100:5.2f}%) â† í•µì‹¬!")

# 1700+ ìƒì„¸
if high_1700 > 0:
    df_high = df[df['TOTALCNT'] >= 1700]
    print(f"\n1700+ ìƒì„¸:")
    print(f"  ìµœì†Œ: {df_high['TOTALCNT'].min():.0f}")
    print(f"  ìµœëŒ€: {df_high['TOTALCNT'].max():.0f}")
    print(f"  í‰ê· : {df_high['TOTALCNT'].mean():.0f}")

# ========================================
# 5. ê²°ì¸¡ì¹˜ í™•ì¸
# ========================================
print("\n" + "="*70)
print("ğŸ” ê²°ì¸¡ì¹˜ í™•ì¸")
print("="*70)

na_counts = df[required].isna().sum()
print(f"\nì»¬ëŸ¼ë³„ ê²°ì¸¡ì¹˜:")
for col in required:
    na = df[col].isna().sum()
    if na > 0:
        print(f"  {col}: {na:,}ê°œ")
if na_counts.sum() == 0:
    print("  ê²°ì¸¡ì¹˜ ì—†ìŒ âœ…")

# ========================================
# 6. ì¤‘ë³µ ì œê±° ì˜µì…˜
# ========================================
print("\n" + "="*70)
print("ğŸ§¹ ë°ì´í„° ì •ì œ ì˜µì…˜")
print("="*70)

# ì˜µì…˜1: ì™„ì „ ì¤‘ë³µë§Œ ì œê±°
df_clean1 = df.drop_duplicates()
print(f"\nì˜µì…˜1 - ì™„ì „ ì¤‘ë³µ ì œê±°: {len(df):,} â†’ {len(df_clean1):,}í–‰")

# ì˜µì…˜2: CURRTIME ì¤‘ë³µ ì œê±° (ì²«ë²ˆì§¸ë§Œ ìœ ì§€)
df_clean2 = df.drop_duplicates(subset=['CURRTIME'], keep='first')
print(f"ì˜µì…˜2 - CURRTIME ì¤‘ë³µ ì œê±°: {len(df):,} â†’ {len(df_clean2):,}í–‰")

# ì˜µì…˜3: ì—°ì† ë™ì¼ê°’ ì œê±°
df_clean3 = df[~df['ì—°ì†ì¤‘ë³µ']].copy()
print(f"ì˜µì…˜3 - ì—°ì† ë™ì¼ê°’ ì œê±°: {len(df):,} â†’ {len(df_clean3):,}í–‰")

# ========================================
# 7. ì •ì œ í›„ 1700+ ë¹„ìœ¨ í™•ì¸
# ========================================
print("\n" + "="*70)
print("ğŸ“Š ì •ì œ í›„ 1700+ ë¹„ìœ¨")
print("="*70)

for name, df_c in [('ì›ë³¸', df), ('ì˜µì…˜1', df_clean1), ('ì˜µì…˜2', df_clean2), ('ì˜µì…˜3', df_clean3)]:
    cnt = (df_c['TOTALCNT'] >= 1700).sum()
    ratio = cnt / len(df_c) * 100
    print(f"  {name}: {cnt:,}ê°œ / {len(df_c):,}í–‰ ({ratio:.2f}%)")

# ========================================
# 8. ì •ì œ ë°ì´í„° ì €ì¥
# ========================================
print("\n" + "="*70)
print("ğŸ’¾ ì €ì¥")
print("="*70)

# ì›í•˜ëŠ” ì˜µì…˜ ì„ íƒí•´ì„œ ì €ì¥
# df_clean = df_clean1  # ì˜µì…˜1
# df_clean = df_clean2  # ì˜µì…˜2
df_clean = df_clean3  # ì˜µì…˜3 (ì—°ì† ë™ì¼ê°’ ì œê±°)

# ì„ì‹œ ì»¬ëŸ¼ ì œê±°
if 'ì—°ì†ì¤‘ë³µ' in df_clean.columns:
    df_clean = df_clean.drop(columns=['ì—°ì†ì¤‘ë³µ'])

output_file = 'data/M14_ì •ì œì™„ë£Œ.csv'
df_clean.to_csv(output_file, index=False, encoding='utf-8-sig')
print(f"âœ… ì €ì¥: {output_file}")
print(f"   {len(df_clean):,}í–‰")

# 1700+ ì „ìš© íŒŒì¼ ì €ì¥
df_high = df_clean[df_clean['TOTALCNT'] >= 1700]
df_high.to_csv('data/M14_1700plus.csv', index=False, encoding='utf-8-sig')
print(f"âœ… 1700+ ì €ì¥: data/M14_1700plus.csv ({len(df_high):,}í–‰)")

print("\nâœ… ë°ì´í„° í’ˆì§ˆ ì²´í¬ ì™„ë£Œ!")