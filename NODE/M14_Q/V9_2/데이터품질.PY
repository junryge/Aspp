#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ› ï¸ í•™ìŠµìš© ê³ ë¶€í•˜(Over 1700) ë°ì´í„° ì¶”ì¶œê¸°
ì¤‘ìš”: í‰ê°€í•˜ë ¤ëŠ” ë‚ ì§œ(12ì›” 11ì¼)ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë°ì´í„° ëˆ„ìˆ˜ ë°©ì§€)
"""
import pandas as pd
import glob
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸ›¡ï¸ í•™ìŠµìš© ê³ ë¶€í•˜ ë°ì´í„° ì¶”ì¶œ (í‰ê°€ì¼ ì œì™¸)")
print("="*70)

# ğŸ”´ í‰ê°€í•  ë‚ ì§œ (ì´ ë‚ ì§œëŠ” í•™ìŠµ ë°ì´í„°ì—ì„œ ë¬´ì¡°ê±´ ëºë‹ˆë‹¤)
TEST_DATE = '2025-12-11'
PRED_OFFSET = 10

def load_data(path_pattern):
    files = glob.glob(path_pattern)
    if not files: files = glob.glob('M14_Q_*.CSV')
    dfs = []
    for f in sorted(files):
        try: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='utf-8'))
        except: dfs.append(pd.read_csv(f, on_bad_lines='skip', encoding='cp949'))
    return pd.concat(dfs, ignore_index=True)

# 1. ì „ì²´ ë°ì´í„° ë¡œë“œ
df = load_data('M14_Q_*.CSV')
df['CURRTIME_OBJ'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

# 2. í”¼ì²˜ ìƒì„± (í•™ìŠµ ë•Œ ì“°ëŠ” ê²ƒê³¼ ë™ì¼í•˜ê²Œ 280 ì‹œí€€ìŠ¤ ë“±)
# (ê°„ë‹¨í•˜ê²Œ íƒ€ê²Ÿë§Œ í™•ì¸í•˜ê¸° ìœ„í•´ ë¡œì§ ìµœì†Œí™”, ì‹¤ì œë¡  í•™ìŠµ ì½”ë“œì˜ í”¼ì²˜ ìƒì„± í•¨ìˆ˜ ì“°ë©´ ë¨)
df['Target_Total_Future'] = df['TOTALCNT'].shift(-PRED_OFFSET)

# 3. [ì¤‘ìš”] í‰ê°€ì¼(12ì›” 11ì¼) ë°ì´í„° ì œê±°
mask_not_test = df['CURRTIME_OBJ'].dt.date.astype(str) != TEST_DATE
df_train_pool = df[mask_not_test].copy()

print(f"\nğŸ“‰ ë°ì´í„° í•„í„°ë§:")
print(f" - ì „ì²´ ë°ì´í„°: {len(df):,}ê°œ")
print(f" - í‰ê°€ì¼({TEST_DATE}) ì œì™¸ í›„: {len(df_train_pool):,}ê°œ")

# 4. 1700 ì´ìƒì¸ ë°ì´í„°ë§Œ ì¶”ì¶œ
df_high_load = df_train_pool[df_train_pool['Target_Total_Future'] >= 1700].copy()

print(f"\nğŸ”¥ ì¶”ì¶œëœ í•™ìŠµìš© ê³ ë¶€í•˜ ë°ì´í„°:")
print(f" - ê°œìˆ˜: {len(df_high_load):,}ê°œ")

if len(df_high_load) > 0:
    # ì €ì¥
    filename = 'High_Load_Train_Only.csv'
    df_high_load.to_csv(filename, index=False, encoding='utf-8-sig')
    print(f"\nğŸ’¾ ì €ì¥ ì™„ë£Œ: {filename}")
    print("ğŸ‘‰ í•™ìŠµ ì½”ë“œì—ì„œ ì´ íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì„œ 50~100ë°° ë³µì‚¬(pd.concat)í•´ì„œ ì“°ì„¸ìš”.")
else:
    print("\nâš  12ì›” 11ì¼ì„ ëºë”ë‹ˆ 1700 ë„˜ëŠ” ê²Œ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ê¸°ê°„ì„ í™•ì¸í•˜ì„¸ìš”.")
