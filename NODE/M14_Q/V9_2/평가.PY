#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V13.0 í‰ê°€ - 12ì›” 11ì¼ ì‹¤ì „ í…ŒìŠ¤íŠ¸
íŠ¹ì§•: ì‹¤ì „ ì•ŒëŒ ê¸°ì¤€(1650) ì ìš©í•˜ì—¬ ë°©ì–´ìœ¨ ì¸¡ì •
"""
import numpy as np
import pandas as pd
import xgboost as xgb
import pickle
import warnings
from datetime import timedelta
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸš€ V13.0 í‰ê°€ - 12ì›” 11ì¼ ì§‘ì¤‘ ë¶„ì„")
print("="*70)

PRED_OFFSET = 10
# ğŸ”´ í‰ê°€í•  íŒŒì¼ëª…ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”!
EVAL_FILE = '20251211_16í‰ê°€.CSV' 

def create_vectorized_features(df):
    """í”¼ì²˜ ìƒì„±"""
    df = df.copy()
    cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 
            'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
            'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
    for c in cols: df[c] = pd.to_numeric(df[c], errors='coerce').fillna(0)
    
    df['Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    
    lags = [1, 3, 5, 10, 20]
    for lag in lags:
        df[f'Total_Lag_{lag}'] = df['TOTALCNT'].shift(lag)
        df[f'M14B_Lag_{lag}'] = df['M14AM14B'].shift(lag)
    
    windows = [10, 30, 60]
    for w in windows:
        df[f'Total_Mean_{w}'] = df['TOTALCNT'].rolling(w).mean()
        df[f'Total_Std_{w}'] = df['TOTALCNT'].rolling(w).std()

    df['Target_Total_Future'] = df['TOTALCNT'].shift(-PRED_OFFSET)
    return df

# 1. ëª¨ë¸ ë¡œë“œ
print("ğŸ“‚ ëª¨ë¸ ë¡œë”© (model_v13_final.pkl)...")
try:
    with open('model_v13_final.pkl', 'rb') as f: model = pickle.load(f)
    with open('features_v13_final.pkl', 'rb') as f: cols = pickle.load(f)
except:
    print("âŒ ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! 'train_v13_final.py'ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.")
    exit()

# 2. ë°ì´í„° ë¡œë“œ
print(f"ğŸ“‚ í‰ê°€ ë°ì´í„°: {EVAL_FILE}")
try: df_raw = pd.read_csv(EVAL_FILE, encoding='utf-8')
except: df_raw = pd.read_csv(EVAL_FILE, encoding='cp949')

df_raw['CURRTIME_OBJ'] = pd.to_datetime(df_raw['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

# 3. í”¼ì²˜ ìƒì„± ë° ì˜ˆì¸¡
print("ğŸ”„ í”¼ì²˜ ìƒì„± ë° ì˜ˆì¸¡ ì¤‘...")
df_feat = create_vectorized_features(df_raw)
df_valid = df_feat.dropna(subset=cols + ['Target_Total_Future', 'CURRTIME_OBJ']).copy()

# ì˜ˆì¸¡ê°’ ê³„ì‚°
pred_total = df_valid['TOTALCNT'] + model.predict(df_valid[cols])

# 4. ê²°ê³¼ ì •ë¦¬
results = pd.DataFrame()
current_time = df_valid['CURRTIME_OBJ']
results['í˜„ì¬ì‹œê°„'] = current_time.dt.strftime('%Y-%m-%d %H:%M')
results['í˜„ì¬TOTALCNT'] = df_valid['TOTALCNT']
results['ì˜ˆì¸¡ì‹œì '] = (current_time + timedelta(minutes=PRED_OFFSET)).dt.strftime('%Y-%m-%d %H:%M')
results['ì‹¤ì œê°’'] = df_valid['Target_Total_Future']
results['ì˜ˆì¸¡ê°’'] = pred_total
results['ì˜¤ì°¨'] = (results['ì‹¤ì œê°’'] - results['ì˜ˆì¸¡ê°’']).round(2)
results['ì ˆëŒ€ì˜¤ì°¨'] = results['ì˜¤ì°¨'].abs()

# ğŸ”¥ [ì‹¤ì „ ì•ŒëŒ íŠœë‹]
# ì˜ˆì¸¡ê°’ì´ 1650ë§Œ ë„˜ì–´ë„ "ìœ„í—˜(O)"ìœ¼ë¡œ íŒë‹¨
results['ì‹¤ì œìœ„í—˜'] = np.where(results['ì‹¤ì œê°’'] >= 1700, 'O', '')
results['ì˜ˆì¸¡ìœ„í—˜'] = np.where(results['ì˜ˆì¸¡ê°’'] >= 1650, 'O', '') 

# 5. ë¦¬í¬íŠ¸ ì¶œë ¥
print("\nğŸ“Š [12ì›” 11ì¼ ì‹¤ì „ í‰ê°€ ê²°ê³¼]")
high_risk = results[results['ì‹¤ì œê°’'] >= 1700]

if len(high_risk) > 0:
    detected = high_risk[high_risk['ì˜ˆì¸¡ìœ„í—˜'] == 'O']
    print(f"ğŸ”¥ ì‹¤ì œ 1700+ ë°œìƒ ê±´ìˆ˜: {len(high_risk)}ê±´")
    print(f"âœ… ì•ŒëŒ ë°œì†¡ ì„±ê³µ(ì˜ˆì¸¡>=1650): {len(detected)}ê±´")
    print(f"ğŸ¯ ë°©ì–´ìœ¨: {len(detected)/len(high_risk)*100:.1f}%")
    
    print("\n[ìƒì„¸ ë‚´ì—­ - ì²˜ìŒ 5ê±´]")
    print(high_risk[['í˜„ì¬ì‹œê°„', 'í˜„ì¬TOTALCNT', 'ì‹¤ì œê°’', 'ì˜ˆì¸¡ê°’', 'ì˜ˆì¸¡ìœ„í—˜']].head().to_string(index=False))
else:
    print("í‰ê°€ ë°ì´í„°ì— 1700+ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.")

outfile = 'Final_Evaluation_Result_Dec11.CSV'
results.to_csv(outfile, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ê²°ê³¼ ì €ì¥: {outfile}")
