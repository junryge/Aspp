#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ðŸš€ V11.8 ìµœì¢… í‰ê°€ - AI vs Rule íŒë‹¨í˜• ì‹œìŠ¤í…œ
í•µì‹¬ ê¸°ëŠ¥:
  - ê²°ê³¼ íŒŒì¼ì— 'Source' ì»¬ëŸ¼ ì¶”ê°€ (AI / Rule)
  - ì‚¬ìš©ìžëŠ” ì–´ë–¤ ë¡œì§ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥
"""
import numpy as np
import pandas as pd
import xgboost as xgb
import pickle
import warnings
from datetime import timedelta
warnings.filterwarnings('ignore')

print("="*70)
print("ðŸš€ V11.8 í‰ê°€ - ì˜ˆì¸¡ ì¶œì²˜(Source) íŒë‹¨ ì‹œìŠ¤í…œ")
print("="*70)

PRED_OFFSET = 10
EVAL_FILE = '20251211_16í‰ê°€.CSV'

# 1. ëª¨ë¸ ë¡œë“œ
try:
    with open('model_v11_280seq.pkl', 'rb') as f: model_base = pickle.load(f)
    with open('features_v11_280seq.pkl', 'rb') as f: feature_cols = pickle.load(f)
except:
    try: 
        with open('model_v10_base.pkl', 'rb') as f: model_base = pickle.load(f)
        with open('features_v10.pkl', 'rb') as f: feature_cols = pickle.load(f)
    except:
        print("âŒ ëª¨ë¸ íŒŒì¼ ì—†ìŒ."); exit()

# 2. ë°ì´í„° ë¡œë“œ
try: df_raw = pd.read_csv(EVAL_FILE, encoding='utf-8')
except: df_raw = pd.read_csv(EVAL_FILE, encoding='cp949')
df_raw['CURRTIME_OBJ'] = pd.to_datetime(df_raw['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

# 3. í”¼ì²˜ ìƒì„±
def create_features(df):
    df = df.copy()
    cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 
            'M14.QUE.OHT.OHTUTIL', 'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
    for c in cols: df[c] = pd.to_numeric(df[c], errors='coerce').fillna(0)
    df['Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    
    lags = [1, 3, 5, 10, 20, 50, 100, 280]
    for lag in lags:
        df[f'Total_Lag_{lag}'] = df['TOTALCNT'].shift(lag)
        df[f'M14B_Lag_{lag}'] = df['M14AM14B'].shift(lag)
    
    windows = [10, 30, 60, 100, 280]
    for w in windows:
        df[f'Total_Mean_{w}'] = df['TOTALCNT'].rolling(w).mean()
        df[f'Total_Std_{w}'] = df['TOTALCNT'].rolling(w).std()

    df['Slope_1'] = df['TOTALCNT'] - df['TOTALCNT'].shift(1)
    df['Slope_3'] = df['TOTALCNT'] - df['TOTALCNT'].shift(3)
    df['Accel_1'] = df['Slope_1'] - df['Slope_1'].shift(1)
    df['Total_Delta_10'] = df['TOTALCNT'] - df['Total_Lag_10']
    df['Target_Total_Future'] = df['TOTALCNT'].shift(-PRED_OFFSET)
    return df

print("ðŸ”„ í”¼ì²˜ ìƒì„± ì¤‘...")
df_feat = create_features(df_raw)
df_valid = df_feat.dropna(subset=feature_cols + ['Target_Total_Future']).copy()

# 4. ì˜ˆì¸¡ ìˆ˜í–‰
print("ðŸš€ AI ë° Rule ì˜ˆì¸¡ ê³„ì‚° ì¤‘...")
X_eval = df_valid[feature_cols]

# (1) AI ì˜ˆì¸¡ê°’
pred_ai = df_valid['TOTALCNT'] + model_base.predict(X_eval)

# (2) Rule ì˜ˆì¸¡ê°’ (íŒ¨í„´ ë³´ì •)
# ê³µì‹: (ìž…ê³ ëŸ‰ - 500) * 2.2
def calculate_rule(row, ai_val):
    inp = row['M14AM14B']
    if inp > 500:
        boost = (inp - 500) * 2.2
        if ai_val > 1680: boost *= 0.5 # AIê°€ ì´ë¯¸ ë†’ìœ¼ë©´ ë³´ì • ì™„í™”
        return min(ai_val + boost, 1850)
    return ai_val # ìž…ê³ ëŸ‰ ë‚®ìœ¼ë©´ AIê°’ ê·¸ëŒ€ë¡œ

pred_rule = df_valid.apply(lambda row: calculate_rule(row, pred_ai.loc[row.name]), axis=1)

# 5. [í•µì‹¬] ì†ŒìŠ¤ ê²°ì • (Selection Logic)
# ìž…ê³ ëŸ‰ 520 ì´ìƒì´ë©´ 'Rule' ì„ íƒ, ì•„ë‹ˆë©´ 'AI' ì„ íƒ
print("âš–ï¸ Source(ì¶œì²˜) ê²°ì • ì¤‘...")

df_valid['AI_Pred'] = pred_ai
df_valid['Rule_Pred'] = pred_rule
df_valid['M14AM14B'] = df_valid['M14AM14B']

# ì¡°ê±´ë¬¸ìœ¼ë¡œ Source ê²°ì •
df_valid['Source'] = np.where(df_valid['M14AM14B'] >= 520, 'Rule', 'AI')

# ìµœì¢…ê°’ ë§¤í•‘
df_valid['Final_Pred'] = np.where(df_valid['Source'] == 'Rule', df_valid['Rule_Pred'], df_valid['AI_Pred'])

# 6. ê²°ê³¼ ì •ë¦¬ ë° ì €ìž¥
results = pd.DataFrame()
results['í˜„ìž¬ì‹œê°„'] = df_valid['CURRTIME_OBJ'].dt.strftime('%Y-%m-%d %H:%M')
results['ìž…ê³ ëŸ‰'] = df_valid['M14AM14B']
results['ì‹¤ì œê°’'] = df_valid['Target_Total_Future']
results['AIì˜ˆì¸¡'] = df_valid['AI_Pred'].round(2)
results['Ruleì˜ˆì¸¡'] = df_valid['Rule_Pred'].round(2)
results['Source'] = df_valid['Source']  # âœ… ì—¬ê¸°ê°€ í•µì‹¬ (AI vs Rule)
results['ìµœì¢…ì˜ˆì¸¡'] = df_valid['Final_Pred'].round(2)
results['ì˜¤ì°¨'] = (results['ì‹¤ì œê°’'] - results['ìµœì¢…ì˜ˆì¸¡']).abs().round(2)

# í†µê³„ ì¶œë ¥
mae = results['ì˜¤ì°¨'].mean()
print(f"\nðŸ“Š [ìµœì¢… ë¶„ì„ ê²°ê³¼]")
print(f"   - ì „ì²´ ë°ì´í„° ìˆ˜: {len(results)}ê°œ")
print(f"   - AI ì„ íƒ íšŸìˆ˜: {(results['Source']=='AI').sum()}íšŒ (ì•ˆì • êµ¬ê°„)")
print(f"   - Rule ì„ íƒ íšŸìˆ˜: {(results['Source']=='Rule').sum()}íšŒ (ìœ„í—˜ êµ¬ê°„)")
print(f"   - ì „ì²´ MAE: {mae:.2f}")

# 10:20ë¶„ êµ¬ê°„ í™•ì¸
print("\n[ðŸ”Ž 10:20ë¶„ êµ¬ê°„ íŒë‹¨ ê²°ê³¼]")
mask_10 = (results['í˜„ìž¬ì‹œê°„'] >= '2025-12-11 10:20') & (results['í˜„ìž¬ì‹œê°„'] <= '2025-12-11 10:23')
print(results.loc[mask_10, ['í˜„ìž¬ì‹œê°„', 'ìž…ê³ ëŸ‰', 'AIì˜ˆì¸¡', 'Ruleì˜ˆì¸¡', 'Source', 'ìµœì¢…ì˜ˆì¸¡']].to_string(index=False))

# 17:34ë¶„ êµ¬ê°„ í™•ì¸
print("\n[ðŸ”Ž 17:34ë¶„ êµ¬ê°„ íŒë‹¨ ê²°ê³¼]")
mask_17 = (results['í˜„ìž¬ì‹œê°„'] >= '2025-12-11 17:33') & (results['í˜„ìž¬ì‹œê°„'] <= '2025-12-11 17:36')
print(results.loc[mask_17, ['í˜„ìž¬ì‹œê°„', 'ìž…ê³ ëŸ‰', 'AIì˜ˆì¸¡', 'Ruleì˜ˆì¸¡', 'Source', 'ìµœì¢…ì˜ˆì¸¡']].to_string(index=False))

# ì €ìž¥
results.to_csv('Final_Eval_With_Source.CSV', index=False, encoding='utf-8-sig')
print("\nðŸ’¾ ì €ìž¥ ì™„ë£Œ: Final_Eval_With_Source.CSV")
print("   ðŸ‘‰ ì—‘ì…€ì—ì„œ 'Source' ì»¬ëŸ¼ì„ í•„í„°ë§í•´ë³´ì„¸ìš”!")