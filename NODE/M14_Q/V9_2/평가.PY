#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ 2ë‹¨ê³„: í‰ê°€ ì „ìš© (eval_v12.py) - ìµœì¢… ìˆ˜ì •
ê¸°ëŠ¥: í˜„ì¬ê°’, ì‹¤ì œê°’, ì˜ˆì¸¡ê°’ ì¶œë ¥ (ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš©)
"""

import pandas as pd
import numpy as np
import xgboost as xgb
import pickle
from datetime import timedelta
import warnings

warnings.filterwarnings('ignore')

# ============================================
# âš™ï¸ ì„¤ì •
# ============================================
EVAL_FILE = "UF09.CSV"      # í‰ê°€ íŒŒì¼ëª…
PRED_MINUTES = 10           # 10ë¶„ ì˜ˆì§€
THRESHOLD = 1700            # ìœ„í—˜ ê¸°ì¤€
THRESHOLD_PROB = 0.45       # 45% ì´ìƒì´ë©´ ìœ„í—˜(O)

print("="*70)
print(f"ğŸš€ V12 í‰ê°€ ì‹œì‘: {EVAL_FILE}")
print("="*70)

def create_features(df):
    df = df.copy()
    if 'CURRTIME' in df.columns:
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

    # ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš©
    df['Queue_Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    df['Dist_to_Limit'] = THRESHOLD - df['TOTALCNT']
    
    for gap in [1, 3, 5, 10]:
        df[f'Vel_Total_{gap}m'] = df['TOTALCNT'].diff(gap)
        df[f'Vel_Gap_{gap}m'] = df['Queue_Gap'].diff(gap)
        df[f'Vel_M14B_{gap}m'] = df['M14AM14B'].diff(gap)
    
    df['Acc_Total'] = df['Vel_Total_3m'].diff(1)
    df['Vol_Total_10m'] = df['TOTALCNT'].rolling(10).std()
    
    df['Is_Triple_Danger'] = ((df['M14AM14B'] > 500) & (df['M14AM14BSUM'] > 600) & (df['Queue_Gap'] > 200)).astype(int)
    df['Is_Gold_Pattern'] = ((df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)).astype(int)
    
    return df

def evaluate():
    try:
        with open('model_v12.pkl', 'rb') as f: model = pickle.load(f)
        with open('features_v12.pkl', 'rb') as f: features = pickle.load(f)
        print("âœ… ëª¨ë¸ ë¡œë“œ ì„±ê³µ")
    except FileNotFoundError:
        print("âŒ ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. train_v12.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.")
        return

    print(f"ğŸ”„ ë°ì´í„° ë¡œë”© ì¤‘...")
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip')
    
    try:
        df = create_features(df)
    except KeyError as e:
        print(f"âŒ ì»¬ëŸ¼ ì—ëŸ¬: {e} ê°€ íŒŒì¼ì— ì—†ìŠµë‹ˆë‹¤.")
        return

    # ì‹¤ì œê°’(Future Max)
    indexer = pd.api.indexers.FixedForwardWindowIndexer(window_size=PRED_MINUTES)
    df['Future_Max'] = df['TOTALCNT'].rolling(window=indexer).max().shift(-1)
    
    # ë°ì´í„° ì¤€ë¹„
    df_eval = df.dropna(subset=features + ['Future_Max']).reset_index(drop=True)
    print(f"ğŸ“Š í‰ê°€ ë°ì´í„°: {len(df_eval):,}ê°œ")
    
    # ì˜ˆì¸¡
    y_prob = model.predict_proba(df_eval[features])[:, 1]
    y_pred = (y_prob >= THRESHOLD_PROB).astype(int)
    
    # ê²°ê³¼ ì €ì¥
    results = pd.DataFrame()
    results['í˜„ì¬ì‹œê°„'] = df_eval['CURRTIME']
    results['ì˜ˆì¸¡ì‹œì '] = df_eval['CURRTIME'] + timedelta(minutes=PRED_MINUTES)
    
    # ìš”ì²­í•˜ì‹  3ëŒ€ì¥
    results['í˜„ì¬ê°’'] = df_eval['TOTALCNT']
    results['ì‹¤ì œê°’'] = df_eval['Future_Max']
    results['ì˜ˆì¸¡ê°’'] = np.where(y_pred == 1, 'O', '')
    
    # ë³´ì¡° ì •ë³´
    results['ì˜ˆì¸¡í™•ë¥ '] = (y_prob * 100).round(1).astype(str) + '%'
    results['M14B'] = df_eval['M14AM14B']
    results['Gap'] = df_eval['Queue_Gap']
    
    # ì €ì¥
    results.to_csv("eval_result.csv", index=False, encoding='utf-8-sig')
    print("\nğŸ’¾ ê²°ê³¼ ì €ì¥ ì™„ë£Œ: eval_result.csv")

    # ìš”ì•½
    actual_danger = (df_eval['Future_Max'] >= THRESHOLD)
    detected = (actual_danger & (y_pred == 1)).sum()
    total = actual_danger.sum()
    
    print("\n" + "="*50)
    print(f"ğŸ“Š ìš”ì•½: ì‹¤ì œ ìœ„í—˜ {total}ê±´ ì¤‘ {detected}ê±´ ê°ì§€ ì„±ê³µ")
    if total > 0:
        print(f"âœ… ê°ì§€ìœ¨: {detected/total*100:.1f}%")

if __name__ == "__main__":
    evaluate()
