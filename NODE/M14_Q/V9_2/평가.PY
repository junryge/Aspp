#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V11.0 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡ (ì‹œí€€ìŠ¤ 280ë¶„ + 12ì›” íŒ¨í„´ ë³´ì •)
ì‹œí€€ìŠ¤: 280ë¶„, ì˜ˆì¸¡: 10ë¶„ í›„
íŠ¹ì§•: 11ì›”í˜•(ê¸‰ìƒìŠ¹) + 12ì›”í˜•(ì ì§„ìƒìŠ¹) ì´ì›í™” íŒ¨í„´ ê°ì§€
"""
import numpy as np
import pandas as pd
import xgboost as xgb
import pickle
import warnings
from datetime import timedelta
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸš€ V11.0 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡ (280ë¶„ + 12ì›” íŒ¨í„´)")
print("="*70)

PRED_OFFSET = 10
SEQ_LEN = 280

def create_vectorized_features(df):
    """í•™ìŠµê³¼ ë™ì¼í•œ í”¼ì²˜ ìƒì„± ë¡œì§ (280ë¶„ ì‹œí€€ìŠ¤ + 12ì›” íŒ¨í„´)"""
    df = df.copy()
    
    cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 
            'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
            'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
    for c in cols:
        df[c] = pd.to_numeric(df[c], errors='coerce').fillna(0)
    
    df['Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    df['Transport'] = df['M14.QUE.ALL.TRANSPORT4MINOVERCNT']
    df['OHT'] = df['M14.QUE.OHT.OHTUTIL']
    
    # 1. ì‹œì°¨ ë³€ìˆ˜ (Lags) - 280ë¶„ê¹Œì§€ í™•ì¥
    lags = [1, 3, 5, 10, 20, 50, 100, 200, 280]
    for lag in lags:
        df[f'Total_Lag_{lag}'] = df['TOTALCNT'].shift(lag)
        df[f'M14B_Lag_{lag}'] = df['M14AM14B'].shift(lag)
        df[f'Sum_Lag_{lag}'] = df['M14AM14BSUM'].shift(lag)
        df[f'Gap_Lag_{lag}'] = df['Gap'].shift(lag)
    
    # 2. ì´ë™ í‰ê· /í‘œì¤€í¸ì°¨ (Rolling Stats) - 280ë¶„ê¹Œì§€ í™•ì¥
    windows = [10, 30, 60, 100, 200, 280]
    for w in windows:
        df[f'Total_Mean_{w}'] = df['TOTALCNT'].rolling(w).mean()
        df[f'Total_Std_{w}'] = df['TOTALCNT'].rolling(w).std()
        df[f'Total_Max_{w}'] = df['TOTALCNT'].rolling(w).max()
        df[f'Total_Min_{w}'] = df['TOTALCNT'].rolling(w).min()
        df[f'M14B_Mean_{w}'] = df['M14AM14B'].rolling(w).mean()
        df[f'Gap_Mean_{w}'] = df['Gap'].rolling(w).mean()
    
    # 3. ë³€í™”ëŸ‰ (Delta)
    df['Total_Delta_1'] = df['TOTALCNT'] - df['Total_Lag_1']
    df['Total_Delta_5'] = df['TOTALCNT'] - df['Total_Lag_5']
    df['Total_Delta_10'] = df['TOTALCNT'] - df['Total_Lag_10']
    df['Total_Delta_50'] = df['TOTALCNT'] - df['Total_Lag_50']
    df['Total_Delta_100'] = df['TOTALCNT'] - df['Total_Lag_100']
    df['Total_Delta_280'] = df['TOTALCNT'] - df['Total_Lag_280']
    
    df['M14B_Delta_10'] = df['M14AM14B'] - df['M14B_Lag_10']
    df['M14B_Delta_100'] = df['M14AM14B'] - df['M14B_Lag_100']
    df['Sum_Delta_10'] = df['M14AM14BSUM'] - df['Sum_Lag_10']
    df['Sum_Delta_100'] = df['M14AM14BSUM'] - df['Sum_Lag_100']
    
    # 4. ìƒí˜¸ì‘ìš© (Interaction)
    df['Load_Ratio'] = df['M14AM14B'] / (df['TOTALCNT'] + 1)
    df['Gap_Load'] = df['Gap'] * df['M14AM14B']
    
    # 5. íŒ¨í„´ (11ì›”í˜• + 12ì›”í˜• í†µí•©!)
    df['Gold_Pattern'] = ((df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)).astype(int)
    df['Danger_Gap'] = (df['Gap'] > 250).astype(int)
    df['Danger_Total'] = (df['TOTALCNT'] >= 1600).astype(int)
    
    # 11ì›”í˜•: Triple Check (ê¸‰ìƒìŠ¹)
    df['Triple_Check'] = ((df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600) & (df['Gap'] > 250)).astype(int)
    
    # ğŸ”¥ 12ì›”í˜•: ë†’ì€ TOTALCNT + í™©ê¸ˆíŒ¨í„´ (ì ì§„ìƒìŠ¹)
    df['Pattern_Dec'] = ((df['TOTALCNT'] >= 1680) & (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)).astype(int)
    
    # ğŸ”¥ í†µí•© ìœ„í—˜ íŒ¨í„´ (11ì›” OR 12ì›”)
    df['Danger_Pattern_Combined'] = (df['Triple_Check'] | df['Pattern_Dec']).astype(int)
    
    # 6. ê°€ì†ë„ (Acceleration) ë° ë‹¨ê¸° ë³€í™”
    df['Accel_1'] = df['Total_Delta_1'] - df['Total_Delta_1'].shift(1)
    df['Accel_3'] = df['Total_Delta_1'].diff(3)
    
    # ê¸°ìš¸ê¸° (Slope)
    df['Slope_3'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(3)) / 3
    df['Slope_5'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(5)) / 5
    df['Slope_30'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(30)) / 30
    df['Slope_100'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(100)) / 100
    df['Gap_Slope_3'] = (df['Gap'] - df['Gap'].shift(3)) / 3
    df['Gap_Slope_30'] = (df['Gap'] - df['Gap'].shift(30)) / 30
    
    df['Target_Total_Future'] = df['TOTALCNT'].shift(-PRED_OFFSET)
    df['Target_Delta'] = df['Target_Total_Future'] - df['TOTALCNT']
    return df

def adjust_prediction(pred, current_total, m14b, m14bsum, gap):
    """
    ğŸ”¥ ë³´ì • ë¡œì§ - 11ì›”í˜• + 12ì›”í˜• ì´ì›í™” íŒ¨í„´
    """
    # 1. í•˜í•œì„  (10ë¶„ = -80)
    floor = current_total - 80
    if pred < floor:
        pred = floor
    
    # 2. 1650-1699 êµ¬ê°„ Boost
    if 1650 <= pred < 1700:
        boost = 0
        
        # 11ì›”í˜•: Triple Check (ê¸‰ìƒìŠ¹ - gap ê¸°ë°˜)
        pattern_nov = (m14b > 520) and (m14bsum > 600) and (gap > 250)
        
        # ğŸ”¥ 12ì›”í˜•: ë†’ì€ TOTALCNT + í™©ê¸ˆíŒ¨í„´ (ì ì§„ìƒìŠ¹)
        pattern_dec = (current_total >= 1680) and (m14b > 520) and (m14bsum > 600)
        
        # 11ì›”í˜• boost
        if pattern_nov:
            boost += 50
            if gap > 300:
                boost += 20
        
        # ğŸ”¥ 12ì›”í˜• boost (ìƒˆë¡œ ì¶”ê°€!)
        elif pattern_dec:
            boost += 40
            if current_total >= 1700:
                boost += 20
        
        # ì¼ë°˜ í™©ê¸ˆíŒ¨í„´
        elif (m14b > 520) and (m14bsum > 600):
            boost += 30
        
        pred = pred + boost
    
    # 3. í˜„ì¬ 1700+ ë³´ì •
    if current_total >= 1700 and pred < 1680:
        pred = max(pred, current_total - 50)
    
    return pred

# 1. ëª¨ë¸ ë¡œë“œ
print("ğŸ“‚ ëª¨ë¸ ë¡œë”©...")
with open('model_v11_280min.pkl', 'rb') as f:
    model_base = pickle.load(f)
with open('features_v11_280min.pkl', 'rb') as f:
    feature_cols = pickle.load(f)
print(f"ğŸ“Š í”¼ì²˜ ìˆ˜: {len(feature_cols)}ê°œ")

# 2. ë°ì´í„° ë¡œë“œ
EVAL_FILE = '20251211_16í‰ê°€.CSV'
print(f"ğŸ“‚ ë°ì´í„° ë¡œë”©: {EVAL_FILE}")
try:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='utf-8')
except UnicodeDecodeError:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='cp949')

# ì‹œê°„ íŒŒì‹± (CURRTIME: YYYYMMDDHHMM)
df['CURRTIME_OBJ'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

# 3. í”¼ì²˜ ìƒì„±
print(f"ğŸ”„ í”¼ì²˜ ìƒì„± ì¤‘ (280ë¶„ ì‹œí€€ìŠ¤ + 12ì›” íŒ¨í„´)...")
df_feat = create_vectorized_features(df)

# ìœ íš¨ ë°ì´í„° í•„í„°ë§
df_valid = df_feat.dropna(subset=feature_cols).copy()
df_valid = df_valid.dropna(subset=['Target_Total_Future'])
print(f"âœ… ìœ íš¨ ìƒ˜í”Œ: {len(df_valid):,}ê°œ")

X_eval = df_valid[feature_cols]
y_true = df_valid['Target_Total_Future'].values
current_time = df_valid['CURRTIME_OBJ']
current_total = df_valid['TOTALCNT'].values
m14b = df_valid['M14AM14B'].values
m14bsum = df_valid['M14AM14BSUM'].values
gap = df_valid['Gap'].values
trans = df_valid['Transport'].values

# 4. ì˜ˆì¸¡
print("ğŸš€ ì˜ˆì¸¡ ìˆ˜í–‰...")
pred_delta = model_base.predict(X_eval)
pred_raw = current_total + pred_delta

# ğŸ”¥ ë³´ì • ì ìš© (12ì›” íŒ¨í„´ í¬í•¨)
pred_adjusted = np.array([
    adjust_prediction(pred_raw[i], current_total[i], m14b[i], m14bsum[i], gap[i])
    for i in range(len(pred_raw))
])

# 5. ê²°ê³¼ ì €ì¥ (í•œê¸€ ì»¬ëŸ¼)
results = pd.DataFrame()
results['í˜„ì¬ì‹œê°„'] = current_time.dt.strftime('%Y-%m-%d %H:%M')
results['í˜„ì¬TOTALCNT'] = np.round(current_total, 2)
results['ì˜ˆì¸¡ì‹œì '] = (current_time + timedelta(minutes=PRED_OFFSET)).dt.strftime('%Y-%m-%d %H:%M')
results['ì‹¤ì œê°’'] = np.round(y_true, 2)
results['ì›ë³¸ì˜ˆì¸¡'] = np.round(pred_raw, 2)
results['ë³´ì •ì˜ˆì¸¡'] = np.round(pred_adjusted, 2)
results['ì˜¤ì°¨'] = np.round(y_true - pred_adjusted, 2)
results['ì ˆëŒ€ì˜¤ì°¨'] = np.abs(results['ì˜¤ì°¨'])
results['M14AM14B'] = m14b
results['M14AM14BSUM'] = m14bsum
results['queue_gap'] = gap
results['TRANSPORT'] = trans

# íŒ¨í„´ ê°ì§€
results['11ì›”íŒ¨í„´(Triple)'] = np.where((m14b > 520) & (m14bsum > 600) & (gap > 250), 'O', '')
results['12ì›”íŒ¨í„´(Total>=1680)'] = np.where((current_total >= 1680) & (m14b > 520) & (m14bsum > 600), 'O', '')

# ìœ„í—˜ ê°ì§€ ì—¬ë¶€
results['ì‹¤ì œìœ„í—˜'] = np.where(y_true >= 1700, 'O', '')
results['ì˜ˆì¸¡ìœ„í—˜(ì›ë³¸)'] = np.where(pred_raw >= 1700, 'O', '')
results['ì˜ˆì¸¡ìœ„í—˜(ë³´ì •)'] = np.where(pred_adjusted >= 1700, 'O', '')

# 6. ê²°ê³¼ ì¶œë ¥
print("\n" + "="*70)
print("ğŸ“Š í‰ê°€ ê²°ê³¼")
print("="*70)

mae = results['ì ˆëŒ€ì˜¤ì°¨'].mean()
print(f"\nì „ì²´ MAE: {mae:.2f}")

# ê³ ë¶€í•˜ êµ¬ê°„
high_val_mask = results['ì‹¤ì œê°’'] >= 1650
if high_val_mask.sum() > 0:
    mae_high = results.loc[high_val_mask, 'ì ˆëŒ€ì˜¤ì°¨'].mean()
    print(f"ê³ ë¶€í•˜ êµ¬ê°„(>=1650) MAE: {mae_high:.2f}")

# 1700+ ê°ì§€ìœ¨
actual_danger = (y_true >= 1700).sum()
if actual_danger > 0:
    detected_raw = ((y_true >= 1700) & (pred_raw >= 1700)).sum()
    detected_adj = ((y_true >= 1700) & (pred_adjusted >= 1700)).sum()
    
    print(f"\nğŸ”¥ 1700+ ê°ì§€:")
    print(f"  ì‹¤ì œ 1700+ ê±´ìˆ˜: {actual_danger}ê°œ")
    print(f"  ì›ë³¸ ê°ì§€: {detected_raw}ê°œ ({detected_raw/actual_danger*100:.1f}%)")
    print(f"  ë³´ì • ê°ì§€: {detected_adj}ê°œ ({detected_adj/actual_danger*100:.1f}%)")

# íŒ¨í„´ë³„ ê°ì§€ìœ¨
print(f"\nğŸ“Š íŒ¨í„´ë³„ ë¶„ì„:")
nov_pattern = (results['11ì›”íŒ¨í„´(Triple)'] == 'O')
dec_pattern = (results['12ì›”íŒ¨í„´(Total>=1680)'] == 'O')
actual_1700 = (results['ì‹¤ì œìœ„í—˜'] == 'O')

print(f"  11ì›” íŒ¨í„´ ë°œë™: {nov_pattern.sum()}ê±´")
print(f"  12ì›” íŒ¨í„´ ë°œë™: {dec_pattern.sum()}ê±´")

if actual_1700.sum() > 0:
    nov_detected = (nov_pattern & actual_1700).sum()
    dec_detected = (dec_pattern & actual_1700).sum()
    combined_detected = ((nov_pattern | dec_pattern) & actual_1700).sum()
    
    print(f"\n  1700+ ì¤‘ 11ì›” íŒ¨í„´ ê°ì§€: {nov_detected}ê±´ ({nov_detected/actual_1700.sum()*100:.1f}%)")
    print(f"  1700+ ì¤‘ 12ì›” íŒ¨í„´ ê°ì§€: {dec_detected}ê±´ ({dec_detected/actual_1700.sum()*100:.1f}%)")
    print(f"  1700+ ì¤‘ í†µí•© íŒ¨í„´ ê°ì§€: {combined_detected}ê±´ ({combined_detected/actual_1700.sum()*100:.1f}%)")

# CSV ì €ì¥
outfile = 'í‰ê°€ê²°ê³¼_V11_280ë¶„_12ì›”íŒ¨í„´.CSV'
results.to_csv(outfile, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥ ì™„ë£Œ: {outfile}")
print(f"ğŸ“Š ì‹œí€€ìŠ¤: {SEQ_LEN}ë¶„")
print(f"ğŸ”¥ 12ì›” íŒ¨í„´ ë³´ì • ì ìš©ë¨!")