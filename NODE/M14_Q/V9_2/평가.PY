#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V9.3 í‰ê°€ - ìƒì„¸ ë¶„ì„

í•µì‹¬:
1. ìˆœìˆ˜ ML ì˜ˆì¸¡ (boost ì—†ìŒ!)
2. êµ¬ê°„ë³„ ìƒì„¸ ë¶„ì„
3. íŒ¨í„´ ë§¤ì¹­ ì •í™•ë„ í™•ì¸
"""

import numpy as np
import pandas as pd
import pickle
from datetime import timedelta
import os
import gc
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸš€ V9.3 í‰ê°€ - ìƒì„¸ ë¶„ì„")
print("="*70)

# ============================================
# ì„¤ì •
# ============================================
SEQ_LEN = 100
PRED_MINUTES = 10
DATA_FILE = "YOUR_EVAL_FILE.csv"  # â† í‰ê°€ ë°ì´í„°!
MODEL_FILE = "model_v93.pkl"

# ============================================
# Feature ìƒì„± (í•™ìŠµê³¼ ë™ì¼!)
# ============================================
def create_features_v93(row_dict):
    """40ê°œ Feature"""
    features = {}
    
    seq_m14b = np.array(row_dict['M14B'])
    seq_m14bsum = np.array(row_dict['M14BSUM'])
    seq_totalcnt = np.array(row_dict['TOTALCNT'])
    seq_q_created = np.array(row_dict['Q_CREATED'])
    seq_q_completed = np.array(row_dict['Q_COMPLETED'])
    seq_gap = seq_q_created - seq_q_completed
    
    seq_len = len(seq_m14b)
    
    cur_m14b = seq_m14b[-1]
    cur_m14bsum = seq_m14bsum[-1]
    cur_gap = seq_gap[-1]
    cur_total = seq_totalcnt[-1]
    
    # TOTALCNT (8ê°œ)
    features['total_current'] = cur_total
    features['total_mean'] = np.mean(seq_totalcnt)
    features['total_max'] = np.max(seq_totalcnt)
    features['total_min'] = np.min(seq_totalcnt)
    features['total_last10'] = np.mean(seq_totalcnt[-10:])
    features['total_slope'] = np.polyfit(np.arange(seq_len), seq_totalcnt, 1)[0]
    features['total_std'] = np.std(seq_totalcnt)
    features['total_trend10'] = seq_totalcnt[-1] - seq_totalcnt[-10]
    
    # M14AM14B (6ê°œ)
    features['m14b_current'] = cur_m14b
    features['m14b_mean'] = np.mean(seq_m14b)
    features['m14b_max'] = np.max(seq_m14b)
    features['m14b_last10'] = np.mean(seq_m14b[-10:])
    features['m14b_slope'] = np.polyfit(np.arange(seq_len), seq_m14b, 1)[0]
    features['m14b_trend10'] = seq_m14b[-1] - seq_m14b[-10]
    
    # M14AM14BSUM (6ê°œ)
    features['m14bsum_current'] = cur_m14bsum
    features['m14bsum_mean'] = np.mean(seq_m14bsum)
    features['m14bsum_max'] = np.max(seq_m14bsum)
    features['m14bsum_last10'] = np.mean(seq_m14bsum[-10:])
    features['m14bsum_slope'] = np.polyfit(np.arange(seq_len), seq_m14bsum, 1)[0]
    features['m14bsum_trend10'] = seq_m14bsum[-1] - seq_m14bsum[-10]
    
    # Queue Gap (8ê°œ)
    features['gap_current'] = cur_gap
    features['gap_mean'] = np.mean(seq_gap)
    features['gap_max'] = np.max(seq_gap)
    features['gap_min'] = np.min(seq_gap)
    features['gap_last10'] = np.mean(seq_gap[-10:])
    features['gap_slope'] = np.polyfit(np.arange(seq_len), seq_gap, 1)[0]
    features['gap_std'] = np.std(seq_gap)
    features['gap_trend10'] = seq_gap[-1] - seq_gap[-10]
    
    # ì¡°í•© (6ê°œ)
    features['m14b_x_sum'] = cur_m14b * cur_m14bsum / 1000
    features['gap_x_m14b'] = cur_gap * cur_m14b / 1000
    features['ratio_gap_total'] = cur_gap / (cur_total + 1)
    features['ratio_m14b_total'] = cur_m14b / (cur_total + 1)
    features['m14b_plus_sum'] = cur_m14b + cur_m14bsum
    features['gap_per_m14b'] = cur_gap / (cur_m14b + 1)
    
    # íŒ¨í„´ (6ê°œ)
    features['is_gold_pattern'] = 1 if (cur_m14b > 520 and cur_m14bsum > 600) else 0
    features['is_triple_check'] = 1 if (cur_m14b > 520 and cur_m14bsum > 600 and cur_gap > 250) else 0
    features['is_gap_critical'] = 1 if cur_gap > 400 else 0
    features['is_gap_extreme'] = 1 if cur_gap > 500 else 0
    features['is_near_danger'] = 1 if cur_total >= 1650 else 0
    features['is_in_danger'] = 1 if cur_total >= 1700 else 0
    
    return features

# ============================================
# ëª¨ë¸ ë¡œë“œ
# ============================================
if not os.path.exists(MODEL_FILE):
    print(f"âŒ ëª¨ë¸ ì—†ìŒ: {MODEL_FILE}")
    exit(1)

with open(MODEL_FILE, 'rb') as f:
    model = pickle.load(f)
print(f"âœ… ëª¨ë¸: {MODEL_FILE}")

# ============================================
# ë°ì´í„° ë¡œë“œ
# ============================================
df = pd.read_csv(DATA_FILE, on_bad_lines='skip')
print(f"âœ… ë°ì´í„°: {len(df):,}í–‰")

if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')

df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']

# í‰ê°€ ë°ì´í„° ë¶„í¬
print(f"\nğŸ“Š í‰ê°€ ë°ì´í„° ë¶„í¬:")
print(f"  TOTALCNT ë²”ìœ„: {df['TOTALCNT'].min():.0f} ~ {df['TOTALCNT'].max():.0f}")
print(f"  1700+: {(df['TOTALCNT'] >= 1700).sum()}ê°œ ({(df['TOTALCNT'] >= 1700).sum()/len(df)*100:.2f}%)")
print(f"  1800+: {(df['TOTALCNT'] >= 1800).sum()}ê°œ")

# ============================================
# í‰ê°€ ì‹¤í–‰
# ============================================
results = []
total = len(df) - SEQ_LEN - PRED_MINUTES
print(f"\nğŸ”„ í‰ê°€ ì¤‘... {total:,}ê°œ")

for i in range(SEQ_LEN, len(df) - PRED_MINUTES):
    row_dict = {
        'TOTALCNT': df['TOTALCNT'].iloc[i-SEQ_LEN:i].values,
        'M14B': df['M14AM14B'].iloc[i-SEQ_LEN:i].values,
        'M14BSUM': df['M14AM14BSUM'].iloc[i-SEQ_LEN:i].values,
        'Q_CREATED': df['M14.QUE.ALL.CURRENTQCREATED'].iloc[i-SEQ_LEN:i].values,
        'Q_COMPLETED': df['M14.QUE.ALL.CURRENTQCOMPLETED'].iloc[i-SEQ_LEN:i].values,
    }
    
    current_total = row_dict['TOTALCNT'][-1]
    current_m14b = row_dict['M14B'][-1]
    current_m14bsum = row_dict['M14BSUM'][-1]
    current_gap = row_dict['Q_CREATED'][-1] - row_dict['Q_COMPLETED'][-1]
    
    # ì‹œê°„
    if 'CURRTIME' in df.columns and pd.notna(df['CURRTIME'].iloc[i-1]):
        current_time = df['CURRTIME'].iloc[i-1]
        time_str = current_time.strftime('%Y-%m-%d %H:%M')
        pred_time_str = (current_time + timedelta(minutes=PRED_MINUTES)).strftime('%Y-%m-%d %H:%M')
    else:
        time_str = ''
        pred_time_str = ''
    
    actual = df['TOTALCNT'].iloc[i + PRED_MINUTES - 1]
    
    # Feature ìƒì„±
    features = create_features_v93(row_dict)
    X = pd.DataFrame([features])
    
    # ìˆœìˆ˜ ML ì˜ˆì¸¡!
    pred = model.predict(X)[0]
    
    # í•˜í•œì„ ë§Œ (ë¬¼ë¦¬ì  ì œí•œ)
    floor = current_total - 80
    if pred < floor:
        pred = floor
    
    # íŒ¨í„´ ì •ë³´
    is_gold = (current_m14b > 520 and current_m14bsum > 600)
    is_triple = is_gold and current_gap > 250
    
    results.append({
        'í˜„ì¬ì‹œê°„': time_str,
        'ì˜ˆì¸¡ì‹œì ': pred_time_str,
        'í˜„ì¬TOTALCNT': round(current_total, 2),
        'ì˜ˆì¸¡ê°’': round(pred, 2),
        'ì‹¤ì œê°’': round(actual, 2),
        'ì˜¤ì°¨': round(actual - pred, 2),
        'ì ˆëŒ€ì˜¤ì°¨': round(abs(actual - pred), 2),
        'M14B': round(current_m14b, 2),
        'M14BSUM': round(current_m14bsum, 2),
        'queue_gap': round(current_gap, 2),
        'í™©ê¸ˆíŒ¨í„´': 'O' if is_gold else '',
        'Triple': 'O' if is_triple else '',
        'í˜„ì¬1650+': 'O' if current_total >= 1650 else '',
        'ì‹¤ì œ1700+': 'O' if actual >= 1700 else '',
        'ì˜ˆì¸¡1700+': 'O' if pred >= 1700 else '',
        'ì‹¤ì œ1800+': 'O' if actual >= 1800 else '',
        'ì˜ˆì¸¡1800+': 'O' if pred >= 1800 else ''
    })
    
    if (i - SEQ_LEN) % 2000 == 0:
        print(f"  {i-SEQ_LEN:,}/{total:,}")
        gc.collect()

print(f"âœ… ì™„ë£Œ!")

# ============================================
# ê²°ê³¼ ì €ì¥
# ============================================
df_result = pd.DataFrame(results)
output_file = 'evaluation_V93.csv'
df_result.to_csv(output_file, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥: {output_file}")

# ============================================
# ìƒì„¸ í†µê³„
# ============================================
print("\n" + "="*70)
print("ğŸ“Š V9.3 í‰ê°€ í†µê³„")
print("="*70)

print(f"\nì´ ì˜ˆì¸¡: {len(df_result):,}ê°œ")
print(f"MAE (ì „ì²´): {df_result['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")
print(f"RMSE: {np.sqrt((df_result['ì˜¤ì°¨']**2).mean()):.2f}")

# êµ¬ê°„ë³„ MAE
print(f"\nğŸ“Š êµ¬ê°„ë³„ MAE:")
for low, high, name in [(0, 1400, '~1400'), (1400, 1600, '1400~1600'),
                        (1600, 1700, '1600~1700'), (1700, 1800, '1700~1800'),
                        (1800, 9999, '1800+')]:
    mask = (df_result['ì‹¤ì œê°’'] >= low) & (df_result['ì‹¤ì œê°’'] < high)
    if mask.sum() > 0:
        seg_mae = df_result.loc[mask, 'ì ˆëŒ€ì˜¤ì°¨'].mean()
        print(f"  {name}: MAE={seg_mae:.2f} ({mask.sum()}ê°œ)")

# 1700+ ê°ì§€
print(f"\n" + "="*70)
print("ğŸ”¥ 1700+ ê°ì§€ ì„±ëŠ¥")
print("="*70)

actual_1700 = df_result['ì‹¤ì œ1700+'] == 'O'
pred_1700 = df_result['ì˜ˆì¸¡1700+'] == 'O'
pred_1680 = df_result['ì˜ˆì¸¡ê°’'] >= 1680
pred_1650 = df_result['ì˜ˆì¸¡ê°’'] >= 1650

actual_count = actual_1700.sum()
detected_1700 = (actual_1700 & pred_1700).sum()
detected_1680 = (actual_1700 & pred_1680).sum()
detected_1650 = (actual_1700 & pred_1650).sum()
false_alarm = (pred_1700 & ~actual_1700).sum()

print(f"\nì‹¤ì œ 1700+: {actual_count}ê°œ")
print(f"\nê°ì§€ìœ¨ (Recall):")
print(f"  ì˜ˆì¸¡>=1700: {detected_1700}/{actual_count} ({detected_1700/actual_count*100:.1f}%)")
print(f"  ì˜ˆì¸¡>=1680: {detected_1680}/{actual_count} ({detected_1680/actual_count*100:.1f}%)")
print(f"  ì˜ˆì¸¡>=1650: {detected_1650}/{actual_count} ({detected_1650/actual_count*100:.1f}%)")

pred_count = pred_1700.sum()
if pred_count > 0:
    print(f"\nì •ë°€ë„ (Precision):")
    print(f"  ì˜ˆì¸¡>=1700: {detected_1700}/{pred_count} ({detected_1700/pred_count*100:.1f}%)")

print(f"\nì˜¤íƒ: {false_alarm}ê°œ")
print(f"ë¯¸ê°ì§€: {actual_count - detected_1700}ê°œ")

# 1800+ ê°ì§€
actual_1800 = df_result['ì‹¤ì œ1800+'] == 'O'
pred_1800 = df_result['ì˜ˆì¸¡1800+'] == 'O'
if actual_1800.sum() > 0:
    detected_1800 = (actual_1800 & pred_1800).sum()
    print(f"\nğŸ”¥ 1800+ ê°ì§€:")
    print(f"  ì‹¤ì œ: {actual_1800.sum()}ê°œ")
    print(f"  ê°ì§€: {detected_1800}/{actual_1800.sum()} ({detected_1800/actual_1800.sum()*100:.1f}%)")

# íŒ¨í„´ë³„ ë¶„ì„
print(f"\n" + "="*70)
print("ğŸ“Š íŒ¨í„´ë³„ ë¶„ì„")
print("="*70)

gold = df_result['í™©ê¸ˆíŒ¨í„´'] == 'O'
triple = df_result['Triple'] == 'O'
cur_1650 = df_result['í˜„ì¬1650+'] == 'O'

for name, mask in [('í™©ê¸ˆíŒ¨í„´', gold), ('Triple Check', triple), ('í˜„ì¬>=1650', cur_1650)]:
    if mask.sum() > 0:
        actual_in = (df_result.loc[mask, 'ì‹¤ì œ1700+'] == 'O').sum()
        print(f"\n{name}:")
        print(f"  ë°œìƒ: {mask.sum()}ê°œ")
        print(f"  ì‹¤ì œ 1700+: {actual_in}/{mask.sum()} ({actual_in/mask.sum()*100:.1f}%)")

# ë¯¸ê°ì§€ ë¶„ì„
missed = actual_1700 & ~pred_1700
if missed.sum() > 0:
    print(f"\n" + "="*70)
    print(f"ğŸ“Š ë¯¸ê°ì§€ {missed.sum()}ê°œ ë¶„ì„")
    print("="*70)
    
    missed_df = df_result[missed]
    print(f"  í˜„ì¬ê°’ í‰ê· : {missed_df['í˜„ì¬TOTALCNT'].mean():.0f}")
    print(f"  ì˜ˆì¸¡ê°’ í‰ê· : {missed_df['ì˜ˆì¸¡ê°’'].mean():.0f}")
    print(f"  ì‹¤ì œê°’ í‰ê· : {missed_df['ì‹¤ì œê°’'].mean():.0f}")
    print(f"  í‰ê·  ì˜¤ì°¨: {missed_df['ì˜¤ì°¨'].mean():.0f}")
    
    print(f"\n  í˜„ì¬ê°’ ë¶„í¬:")
    print(f"    >= 1650: {(missed_df['í˜„ì¬TOTALCNT'] >= 1650).sum()}ê°œ")
    print(f"    >= 1600: {(missed_df['í˜„ì¬TOTALCNT'] >= 1600).sum()}ê°œ")
    print(f"    >= 1550: {(missed_df['í˜„ì¬TOTALCNT'] >= 1550).sum()}ê°œ")
    
    print(f"\n  íŒ¨í„´ ë¶„í¬:")
    print(f"    í™©ê¸ˆíŒ¨í„´: {(missed_df['í™©ê¸ˆíŒ¨í„´'] == 'O').sum()}ê°œ")
    print(f"    Triple: {(missed_df['Triple'] == 'O').sum()}ê°œ")

print(f"\n" + "="*70)
print(f"âœ… V9.3 í‰ê°€ ì™„ë£Œ!")
print("="*70)