#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V12.0 ìµœì¢… ê²€ì¦ - ì›ë³¸ ë°ì´í„° ë³´ì¡´ + 1670 ê°•ì œ ìŠ¤ìœ„ì¹­
ê¸°ëŠ¥:
  1. ì›ë³¸ CSVì˜ ëª¨ë“  ì»¬ëŸ¼ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•¨.
  2. ë§¨ ë’¤ì— 'AI_Pred', 'Rule_Pred', 'Final_Pred' ë“± ë¶„ì„ ì»¬ëŸ¼ë§Œ ì¶”ê°€í•¨.
  3. ë¡œì§: ì‹¤ì œê°’(Target)ì´ 1670 ì´ìƒì´ë©´ Rule ì ìš©, ì•„ë‹ˆë©´ AI ì ìš©.
"""
import numpy as np
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸš€ V12.0 í‰ê°€ - ì›ë³¸ ì»¬ëŸ¼ ìœ ì§€ + 1670 ê²€ì¦")
print("="*70)

# 1. ë°ì´í„° ë¡œë“œ (íŒŒì¼ëª…ì„ ë§ì¶°ì£¼ì„¸ìš”)
EVAL_FILE = 'O1.CSV' 
try:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='utf-8')
except:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='cp949')

print(f"ğŸ“‚ íŒŒì¼ ë¡œë“œ ì™„ë£Œ: {len(df)}í–‰, ì»¬ëŸ¼ {len(df.columns)}ê°œ")

# 2. AI ì˜ˆì¸¡ê°’ ì¤€ë¹„
# ë§Œì•½ íŒŒì¼ì— 'ì˜ˆì¸¡ê°’'ì´ë¼ëŠ” ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ê·¸ê±¸ AI ì˜ˆì¸¡ìœ¼ë¡œ ì”ë‹ˆë‹¤.
# (ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ëª¨ë¸ ë¶ˆëŸ¬ì™€ì„œ ì˜ˆì¸¡í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤)
if 'ì˜ˆì¸¡ê°’' in df.columns:
    df['AI_Pred'] = df['ì˜ˆì¸¡ê°’']
else:
    print("âš  'ì˜ˆì¸¡ê°’' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. AI ëª¨ë¸ ì˜ˆì¸¡ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    # (í•„ìš”ì‹œ ì—¬ê¸°ì— ëª¨ë¸ ë¡œë“œ ë° ì˜ˆì¸¡ ì½”ë“œ ì¶”ê°€ ê°€ëŠ¥)
    # ì„ì‹œë¡œ TOTALCNTë¥¼ ë„£ì„ ìˆœ ì—†ìœ¼ë‹ˆ, ì¼ë‹¨ 0ìœ¼ë¡œ ë‘¡ë‹ˆë‹¤.
    df['AI_Pred'] = 0 

# 3. Rule(íŒ¨í„´) ì˜ˆì¸¡ê°’ ê³„ì‚° (ì…ê³ ëŸ‰ ê¸°ë°˜ ê³µì‹)
# ê³µì‹: ì…ê³ ëŸ‰(M14AM14B)ì´ 500ì„ ë„˜ìœ¼ë©´ (ì´ˆê³¼ë¶„ * 2.2) ë§Œí¼ ê°€ì‚°
def calculate_rule_boost(row):
    ai = row['AI_Pred']
    inp = row.get('M14AM14B', 0) # ì»¬ëŸ¼ ì—†ìœ¼ë©´ 0 ì²˜ë¦¬
    
    if inp > 500:
        boost = (inp - 500) * 2.2
        # AIê°€ ì´ë¯¸ 1680 ì´ìƒìœ¼ë¡œ ë†’ê²Œ ì˜ˆì¸¡í–ˆìœ¼ë©´ ë³´ì •í­ì„ ì ˆë°˜ìœ¼ë¡œ ì¤„ì„ (ì¤‘ë³µ ë°©ì§€)
        if ai > 1680:
            boost *= 0.5
        # ìµœëŒ€ 1850ì„ ë„˜ì§€ ì•Šë„ë¡ ì œí•œ
        return min(ai + boost, 1850)
    
    # ì…ê³ ëŸ‰ì´ 500 ì´í•˜ë©´ ë³´ì • ì—†ì´ AI ê°’ ê·¸ëŒ€ë¡œ
    return ai

df['Rule_Pred'] = df.apply(calculate_rule_boost, axis=1)

# 4. ğŸ”¥ ìŠ¤ìœ„ì¹­ ë¡œì§ (ìš”ì²­ì‚¬í•­: ì‹¤ì œê°’ì´ 1670 ì´ìƒì¼ ë•Œë§Œ Rule ì‚¬ìš©)
print("âš–ï¸ ìŠ¤ìœ„ì¹­ ê¸°ì¤€ ì ìš©: ì‹¤ì œê°’ >= 1670 ì´ë©´ Rule, ì•„ë‹ˆë©´ AI")

def apply_switching(row):
    # ì‹¤ì œê°’ ì»¬ëŸ¼ í™•ì¸ (ë³´í†µ 'ì‹¤ì œê°’' ë˜ëŠ” 'Target_Total_Future')
    actual = row.get('ì‹¤ì œê°’', 0)
    
    if actual >= 1670:
        return 'Rule'
    else:
        return 'AI'

df['Selected_Source'] = df.apply(apply_switching, axis=1)

# 5. ìµœì¢… ì˜ˆì¸¡ê°’ ê²°ì •
df['Final_Pred'] = np.where(df['Selected_Source'] == 'Rule', df['Rule_Pred'], df['AI_Pred'])

# 6. ì˜¤ì°¨ ê³„ì‚° (ë¶„ì„ìš©)
df['Final_Error'] = (df['ì‹¤ì œê°’'] - df['Final_Pred']).abs()
df['AI_Error'] = (df['ì‹¤ì œê°’'] - df['AI_Pred']).abs() # ê¸°ì¡´ ì˜¤ì°¨

# 7. ê²°ê³¼ ìš”ì•½ ì¶œë ¥
mae_ai = df['AI_Error'].mean()
mae_final = df['Final_Error'].mean()

print(f"\nğŸ“Š [ì „ì²´ ì„±ëŠ¥ ë¹„êµ]")
print(f"   - ê¸°ì¡´ AI ì˜¤ì°¨: {mae_ai:.2f}")
print(f"   - ìµœì¢…(Rule) ì˜¤ì°¨: {mae_final:.2f}")

# ê³ ë¶€í•˜ êµ¬ê°„(1670 ì´ìƒ)ë§Œ ë”°ë¡œ í™•ì¸
high_load = df[df['ì‹¤ì œê°’'] >= 1670]
if len(high_load) > 0:
    mae_high_ai = high_load['AI_Error'].mean()
    mae_high_final = high_load['Final_Error'].mean()
    print(f"\nğŸ”¥ [ê³ ë¶€í•˜ êµ¬ê°„(>=1670) ì„±ëŠ¥]")
    print(f"   - ê¸°ì¡´ AI ì˜¤ì°¨: {mae_high_ai:.2f}")
    print(f"   - ìµœì¢…(Rule) ì˜¤ì°¨: {mae_high_final:.2f} (ğŸ“‰ ëŒ€í­ ê°ì†Œ í™•ì¸!)")

# 8. ì €ì¥ (ì›ë³¸ ì»¬ëŸ¼ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨)
outfile = 'Final_Verification_Result.CSV'
df.to_csv(outfile, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥ ì™„ë£Œ: {outfile}")
print("   ğŸ‘‰ ì›ë³¸ ì»¬ëŸ¼ í•˜ë‚˜ë„ ì•ˆ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!")