#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V8.3.1 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡
ë³€í™”ëŸ‰ ì˜ˆì¸¡ ëª¨ë¸ í‰ê°€

ì¶œë ¥ ì»¬ëŸ¼ (ê¸°ì¡´ í˜•ì‹ ìœ ì§€):
- í˜„ì¬ì‹œê°„, í˜„ì¬TOTALCNT, ì˜ˆì¸¡ì‹œì , ì‹¤ì œê°’
- ì›ë³¸ì˜ˆì¸¡, ë³´ì •ì˜ˆì¸¡, ì˜¤ì°¨, ì ˆëŒ€ì˜¤ì°¨
- ì‹¤ì œìœ„í—˜(1700+), ì˜ˆì¸¡ìœ„í—˜(1700+)
"""

import numpy as np
import pandas as pd
import pickle
from datetime import timedelta
import os
import gc
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸš€ V8.3.1 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡")
print("   ë³€í™”ëŸ‰ ì˜ˆì¸¡ ë°©ì‹")
print("="*70)

# ========================================
# ì„¤ì •
# ========================================
SEQ_LEN = 60
PRED_OFFSET = 10

# ========================================
# Feature ìƒì„± í•¨ìˆ˜ (í•™ìŠµê³¼ ë™ì¼)
# ========================================
def create_features_v831(row_dict):
    """í•µì‹¬ Featureë§Œ (33ê°œ)"""
    features = {}
    
    seq_totalcnt = np.array(row_dict['TOTALCNT'])
    seq_m14b = np.array(row_dict['M14AM14B'])
    seq_m14bsum = np.array(row_dict['M14AM14BSUM'])
    seq_m10arev = np.array(row_dict['M10AM14A'])
    seq_m16m14a = np.array(row_dict['M16M14A'])
    seq_transport = np.array(row_dict['TRANSPORT'])
    seq_oht = np.array(row_dict['OHT'])
    seq_gap = np.array(row_dict['Q_CREATED']) - np.array(row_dict['Q_COMPLETED'])
    
    seq_len = len(seq_totalcnt)
    
    # 1. TOTALCNT (7ê°œ)
    features['total_current'] = seq_totalcnt[-1]
    features['total_last5'] = np.mean(seq_totalcnt[-5:])
    features['total_last10'] = np.mean(seq_totalcnt[-10:])
    features['total_trend5'] = seq_totalcnt[-1] - seq_totalcnt[-5]
    features['total_trend10'] = seq_totalcnt[-1] - seq_totalcnt[-10]
    features['total_slope'] = np.polyfit(np.arange(min(30, seq_len)), seq_totalcnt[-30:], 1)[0]
    features['total_std10'] = np.std(seq_totalcnt[-10:])
    
    # 2. M14AM14B (4ê°œ)
    features['m14b_current'] = seq_m14b[-1]
    features['m14b_last10'] = np.mean(seq_m14b[-10:])
    features['m14b_trend10'] = seq_m14b[-1] - seq_m14b[-10]
    features['m14b_slope'] = np.polyfit(np.arange(min(30, seq_len)), seq_m14b[-30:], 1)[0]
    
    # 3. M14AM14BSUM (4ê°œ)
    features['m14bsum_current'] = seq_m14bsum[-1]
    features['m14bsum_last10'] = np.mean(seq_m14bsum[-10:])
    features['m14bsum_trend10'] = seq_m14bsum[-1] - seq_m14bsum[-10]
    features['m14bsum_slope'] = np.polyfit(np.arange(min(30, seq_len)), seq_m14bsum[-30:], 1)[0]
    
    # 4. M16M14A (3ê°œ)
    features['m16_current'] = seq_m16m14a[-1]
    features['m16_last10'] = np.mean(seq_m16m14a[-10:])
    features['m16_trend10'] = seq_m16m14a[-1] - seq_m16m14a[-10]
    
    # 5. M10AM14A (2ê°œ)
    features['m10arev_current'] = seq_m10arev[-1]
    features['m10arev_trend10'] = seq_m10arev[-1] - seq_m10arev[-10]
    
    # 6. TRANSPORT (2ê°œ)
    features['trans_current'] = seq_transport[-1]
    features['trans_trend10'] = seq_transport[-1] - seq_transport[-10]
    
    # 7. OHT (2ê°œ)
    features['oht_current'] = seq_oht[-1]
    features['oht_last10'] = np.mean(seq_oht[-10:])
    
    # 8. Queue Gap (3ê°œ)
    features['gap_current'] = seq_gap[-1]
    features['gap_last10'] = np.mean(seq_gap[-10:])
    features['gap_trend10'] = seq_gap[-1] - seq_gap[-10]
    
    # 9. í•µì‹¬ ì„ê³„ê°’ (4ê°œ)
    features['is_over_1550'] = 1 if seq_totalcnt[-1] >= 1550 else 0
    features['is_over_1580'] = 1 if seq_totalcnt[-1] >= 1580 else 0
    features['is_over_1600'] = 1 if seq_totalcnt[-1] >= 1600 else 0
    features['is_over_1650'] = 1 if seq_totalcnt[-1] >= 1650 else 0
    
    # 10. ë³µí•© ì§€í‘œ (2ê°œ)
    features['m14b_plus_sum'] = seq_m14b[-1] + seq_m14bsum[-1]
    features['total_momentum'] = features['total_trend5'] + features['total_trend10']
    
    return features

# ========================================
# ë³´ì • í•¨ìˆ˜
# ========================================
def adjust_prediction(pred, current_total):
    """
    ë³´ì •: í•˜í•œì„ ë§Œ ì ìš© (ë‹¨ìˆœí™”)
    - 10ë¶„ ë‚´ ê¸‰ë½ ì œí•œ: í˜„ì¬ê°’ - 100
    """
    floor = current_total - 100
    if pred < floor:
        pred = floor
    return pred

# ========================================
# ëª¨ë¸ ë¡œë“œ
# ========================================
model = None
for mf in ['model_V8.3.1_10min.pkl', 'model_v831_10min.pkl']:
    if os.path.exists(mf):
        with open(mf, 'rb') as f:
            model = pickle.load(f)
        print(f"âœ… ëª¨ë¸: {mf}")
        break

if not model:
    print("âŒ ëª¨ë¸ ì—†ìŒ!")
    exit(1)

# ========================================
# ë°ì´í„° ë¡œë“œ
# ========================================
DATA_FILE = '1211í‰ê°€.CSV'  # ìˆ˜ì • í•„ìš”!
if not os.path.exists(DATA_FILE):
    print(f"âŒ ë°ì´í„° ì—†ìŒ: {DATA_FILE}")
    exit(1)

df = pd.read_csv(DATA_FILE, on_bad_lines='skip')
print(f"âœ… ë°ì´í„°: {len(df):,}í–‰")

# ì‹œê°„ íŒŒì‹±
df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M')

# queue_gap
df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']

# ========================================
# í‰ê°€ ì‹¤í–‰
# ========================================
results = []
total = len(df) - SEQ_LEN - PRED_OFFSET
print(f"\nğŸ”„ í‰ê°€ ì¤‘... {total:,}ê°œ")

for i in range(SEQ_LEN, len(df) - PRED_OFFSET):
    row_dict = {
        'M14AM14B': df['M14AM14B'].iloc[i-SEQ_LEN:i].values,
        'M14AM14BSUM': df['M14AM14BSUM'].iloc[i-SEQ_LEN:i].values,
        'M10AM14A': df['M10AM14A'].iloc[i-SEQ_LEN:i].values,
        'TOTALCNT': df['TOTALCNT'].iloc[i-SEQ_LEN:i].values,
        'M16M14A': df['M16M14A'].iloc[i-SEQ_LEN:i].values,
        'TRANSPORT': df['M14.QUE.ALL.TRANSPORT4MINOVERCNT'].iloc[i-SEQ_LEN:i].values,
        'OHT': df['M14.QUE.OHT.OHTUTIL'].iloc[i-SEQ_LEN:i].values,
        'Q_CREATED': df['M14.QUE.ALL.CURRENTQCREATED'].iloc[i-SEQ_LEN:i].values,
        'Q_COMPLETED': df['M14.QUE.ALL.CURRENTQCOMPLETED'].iloc[i-SEQ_LEN:i].values,
    }
    
    # í˜„ì¬ ìƒíƒœ
    current_time = df['CURRTIME'].iloc[i-1]
    current_total = df['TOTALCNT'].iloc[i-1]
    actual = df['TOTALCNT'].iloc[i + PRED_OFFSET - 1]
    prediction_time = current_time + timedelta(minutes=PRED_OFFSET)
    
    # ì¶”ê°€ ì •ë³´
    m14b = row_dict['M14AM14B'][-1]
    m14bsum = row_dict['M14AM14BSUM'][-1]
    m16 = row_dict['M16M14A'][-1]
    gap = row_dict['Q_CREATED'][-1] - row_dict['Q_COMPLETED'][-1]
    transport = row_dict['TRANSPORT'][-1]
    
    # Feature ìƒì„±
    features = create_features_v831(row_dict)
    X = pd.DataFrame([features])
    
    # ì˜ˆì¸¡ (ë³€í™”ëŸ‰)
    pred_change = model.predict(X)[0]
    
    # ì›ë³¸ ì˜ˆì¸¡ = í˜„ì¬ê°’ + ë³€í™”ëŸ‰
    pred_raw = current_total + pred_change
    
    # ë³´ì • ì˜ˆì¸¡
    pred = adjust_prediction(pred_raw, current_total)
    
    # ê²°ê³¼ ì €ì¥ (ê¸°ì¡´ í˜•ì‹!)
    results.append({
        'í˜„ì¬ì‹œê°„': current_time.strftime('%Y-%m-%d %H:%M'),
        'í˜„ì¬TOTALCNT': round(current_total, 2),
        'ì˜ˆì¸¡ì‹œì ': prediction_time.strftime('%Y-%m-%d %H:%M'),
        'ì‹¤ì œê°’': round(actual, 2),
        'ì›ë³¸ì˜ˆì¸¡': round(pred_raw, 2),
        'ë³´ì •ì˜ˆì¸¡': round(pred, 2),
        'ì˜¤ì°¨': round(actual - pred, 2),
        'ì ˆëŒ€ì˜¤ì°¨': round(abs(actual - pred), 2),
        'M14AM14B': round(m14b, 2),
        'M14AM14BSUM': round(m14bsum, 2),
        'M16M14A': round(m16, 2),
        'queue_gap': round(gap, 2),
        'TRANSPORT': round(transport, 2),
        '>=1580': 'O' if current_total >= 1580 else '',
        'ì‹¤ì œìœ„í—˜(1700+)': 'O' if actual >= 1700 else '',
        'ì˜ˆì¸¡ìœ„í—˜(1700+)': 'O' if pred >= 1700 else ''
    })
    
    if (i - SEQ_LEN) % 500 == 0:
        print(f"  {i-SEQ_LEN:,}/{total:,}")
        gc.collect()

print(f"âœ… ì™„ë£Œ!")

# ========================================
# ê²°ê³¼ ì €ì¥
# ========================================
df_result = pd.DataFrame(results)
output = 'evaluation_V8.3.1_10min.csv'
df_result.to_csv(output, index=False, encoding='utf-8-sig')
print(f"âœ… ì €ì¥: {output}")

# ========================================
# í†µê³„
# ========================================
print("\n" + "="*70)
print("ğŸ“Š V8.3.1 10ë¶„ í‰ê°€ í†µê³„")
print("="*70)
print(f"ì´ ì˜ˆì¸¡: {len(df_result):,}ê°œ")
print(f"MAE: {df_result['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")

actual_danger = df_result['ì‹¤ì œìœ„í—˜(1700+)'] == 'O'
pred_danger = df_result['ì˜ˆì¸¡ìœ„í—˜(1700+)'] == 'O'
actual_count = actual_danger.sum()
detected = (actual_danger & pred_danger).sum()

print(f"\nğŸ”¥ 1700+ ê°ì§€:")
print(f"  ì‹¤ì œ: {actual_count}ê°œ")
if actual_count > 0:
    print(f"  ê°ì§€: {detected}ê°œ ({detected/actual_count*100:.1f}%)")
    
    # ì˜¤íƒ
    fp = (pred_danger & ~actual_danger).sum()
    print(f"  ì˜¤íƒ(FP): {fp}ê°œ")
    
    # ì •ë°€ë„
    if pred_danger.sum() > 0:
        precision = detected / pred_danger.sum() * 100
        print(f"  ì •ë°€ë„: {precision:.1f}%")
    
    # ì›ë³¸ vs ë³´ì • ë¹„êµ
    raw_detected = (df_result[actual_danger]['ì›ë³¸ì˜ˆì¸¡'] >= 1700).sum()
    print(f"\nğŸ“ˆ ë³´ì • íš¨ê³¼:")
    print(f"  ì›ë³¸ ê°ì§€ìœ¨: {raw_detected/actual_count*100:.1f}%")
    print(f"  ë³´ì • ê°ì§€ìœ¨: {detected/actual_count*100:.1f}%")

# ë‹¨ìˆœ ì„ê³„ê°’ ë¹„êµ
simple_pred = df_result['>=1580'] == 'O'
simple_tp = (actual_danger & simple_pred).sum()
print(f"\nğŸ“Œ ë‹¨ìˆœ ì„ê³„ê°’(>=1580) ë¹„êµ:")
print(f"  ê°ì§€ìœ¨: {simple_tp/actual_count*100:.1f}%" if actual_count > 0 else "  N/A")

print(f"\nâœ… V8.3.1 í‰ê°€ ì™„ë£Œ! â†’ {output}")