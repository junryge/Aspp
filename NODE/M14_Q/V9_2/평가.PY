#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ V11.0 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡ (ì‹œí€€ìŠ¤ 280ë¶„)
ì‹œí€€ìŠ¤: 280ë¶„, ì˜ˆì¸¡: 10ë¶„ í›„
"""
import numpy as np
import pandas as pd
import xgboost as xgb
import pickle
import warnings
from datetime import timedelta
warnings.filterwarnings('ignore')
print("="*70)
print("ğŸš€ V11.0 í‰ê°€ - 10ë¶„ ì˜ˆì¸¡ (ì‹œí€€ìŠ¤ 280ë¶„)")
print("="*70)
PRED_OFFSET = 10
SEQ_LEN = 280

def create_vectorized_features(df):
    """í•™ìŠµê³¼ ë™ì¼í•œ í”¼ì²˜ ìƒì„± ë¡œì§ (280ë¶„ ì‹œí€€ìŠ¤)"""
    df = df.copy()
    
    cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 
            'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
            'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED']
    for c in cols:
        df[c] = pd.to_numeric(df[c], errors='coerce').fillna(0)
    df['Gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    df['Transport'] = df['M14.QUE.ALL.TRANSPORT4MINOVERCNT']
    df['OHT'] = df['M14.QUE.OHT.OHTUTIL']
    
    # 1. ì‹œì°¨ ë³€ìˆ˜ (Lags) - 280ë¶„ê¹Œì§€ í™•ì¥
    lags = [1, 3, 5, 10, 20, 50, 100, 200, 280]
    for lag in lags:
        df[f'Total_Lag_{lag}'] = df['TOTALCNT'].shift(lag)
        df[f'M14B_Lag_{lag}'] = df['M14AM14B'].shift(lag)
        df[f'Sum_Lag_{lag}'] = df['M14AM14BSUM'].shift(lag)
        df[f'Gap_Lag_{lag}'] = df['Gap'].shift(lag)
    # 2. ì´ë™ í‰ê· /í‘œì¤€í¸ì°¨ (Rolling Stats) - 280ë¶„ê¹Œì§€ í™•ì¥
    windows = [10, 30, 60, 100, 200, 280]
    for w in windows:
        df[f'Total_Mean_{w}'] = df['TOTALCNT'].rolling(w).mean()
        df[f'Total_Std_{w}'] = df['TOTALCNT'].rolling(w).std()
        df[f'Total_Max_{w}'] = df['TOTALCNT'].rolling(w).max()
        df[f'Total_Min_{w}'] = df['TOTALCNT'].rolling(w).min()
        df[f'M14B_Mean_{w}'] = df['M14AM14B'].rolling(w).mean()
        df[f'Gap_Mean_{w}'] = df['Gap'].rolling(w).mean()
    # 3. ë³€í™”ëŸ‰ (Delta)
    df['Total_Delta_1'] = df['TOTALCNT'] - df['Total_Lag_1']
    df['Total_Delta_5'] = df['TOTALCNT'] - df['Total_Lag_5']
    df['Total_Delta_10'] = df['TOTALCNT'] - df['Total_Lag_10']
    df['Total_Delta_50'] = df['TOTALCNT'] - df['Total_Lag_50']
    df['Total_Delta_100'] = df['TOTALCNT'] - df['Total_Lag_100']
    df['Total_Delta_280'] = df['TOTALCNT'] - df['Total_Lag_280']
    
    df['M14B_Delta_10'] = df['M14AM14B'] - df['M14B_Lag_10']
    df['M14B_Delta_100'] = df['M14AM14B'] - df['M14B_Lag_100']
    df['Sum_Delta_10'] = df['M14AM14BSUM'] - df['Sum_Lag_10']
    df['Sum_Delta_100'] = df['M14AM14BSUM'] - df['Sum_Lag_100']
    
    # 4. ìƒí˜¸ì‘ìš© (Interaction)
    df['Load_Ratio'] = df['M14AM14B'] / (df['TOTALCNT'] + 1)
    df['Gap_Load'] = df['Gap'] * df['M14AM14B']
    
    # 5. íŒ¨í„´ (Explicit Patterns)
    df['Gold_Pattern'] = ((df['M14AM14B'] > 500) & (df['M14AM14BSUM'] > 600)).astype(int)
    df['Danger_Gap'] = (df['Gap'] > 250).astype(int)
    df['Danger_Total'] = (df['TOTALCNT'] >= 1600).astype(int)
    df['Triple_Check'] = ((df['M14AM14B'] > 450) & (df['M14AM14BSUM'] > 550) & (df['Gap'] > 200)).astype(int)
    # 6. ê°€ì†ë„ (Acceleration) ë° ë‹¨ê¸° ë³€í™”
    df['Accel_1'] = df['Total_Delta_1'] - df['Total_Delta_1'].shift(1)
    df['Accel_3'] = df['Total_Delta_1'].diff(3)
    
    # ê¸°ìš¸ê¸° (Slope)
    df['Slope_3'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(3)) / 3
    df['Slope_5'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(5)) / 5
    df['Slope_30'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(30)) / 30
    df['Slope_100'] = (df['TOTALCNT'] - df['TOTALCNT'].shift(100)) / 100
    df['Gap_Slope_3'] = (df['Gap'] - df['Gap'].shift(3)) / 3
    df['Gap_Slope_30'] = (df['Gap'] - df['Gap'].shift(30)) / 30
    df['Target_Total_Future'] = df['TOTALCNT'].shift(-PRED_OFFSET)
    df['Target_Delta'] = df['Target_Total_Future'] - df['TOTALCNT']
    return df

# 1. ëª¨ë¸ ë¡œë“œ
print("ğŸ“‚ ëª¨ë¸ ë¡œë”©...")
with open('model_v11_280min.pkl', 'rb') as f:
    model_base = pickle.load(f)
with open('features_v11_280min.pkl', 'rb') as f:
    feature_cols = pickle.load(f)
print(f"ğŸ“Š í”¼ì²˜ ìˆ˜: {len(feature_cols)}ê°œ")
# 2. ë°ì´í„° ë¡œë“œ
EVAL_FILE = '20251211_16í‰ê°€.CSV'
print(f"ğŸ“‚ ë°ì´í„° ë¡œë”©: {EVAL_FILE}")
try:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='utf-8')
except UnicodeDecodeError:
    df = pd.read_csv(EVAL_FILE, on_bad_lines='skip', encoding='cp949')
# ì‹œê°„ íŒŒì‹± (CURRTIME: YYYYMMDDHHMM)
df['CURRTIME_OBJ'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
# 3. í”¼ì²˜ ìƒì„±
print(f"ğŸ”„ í”¼ì²˜ ìƒì„± ì¤‘ (280ë¶„ ì‹œí€€ìŠ¤)...")
df_feat = create_vectorized_features(df)
# ìœ íš¨ ë°ì´í„° í•„í„°ë§
df_valid = df_feat.dropna(subset=feature_cols).copy()
df_valid = df_valid.dropna(subset=['Target_Total_Future'])
print(f"âœ… ìœ íš¨ ìƒ˜í”Œ: {len(df_valid):,}ê°œ")
X_eval = df_valid[feature_cols]
y_true = df_valid['Target_Total_Future']
current_time = df_valid['CURRTIME_OBJ']
current_total = df_valid['TOTALCNT']
m14b = df_valid['M14AM14B']
m14bsum = df_valid['M14AM14BSUM']
gap = df_valid['Gap']
trans = df_valid['Transport']
# 4. ì˜ˆì¸¡
print("ğŸš€ ì˜ˆì¸¡ ìˆ˜í–‰...")
pred_delta = model_base.predict(X_eval)
pred_total = current_total + pred_delta
# 5. ê²°ê³¼ ì €ì¥ (í•œê¸€ ì»¬ëŸ¼)
results = pd.DataFrame()
results['í˜„ì¬ì‹œê°„'] = current_time.dt.strftime('%Y-%m-%d %H:%M')
results['í˜„ì¬TOTALCNT'] = current_total.round(2)
results['ì˜ˆì¸¡ì‹œì '] = (current_time + timedelta(minutes=PRED_OFFSET)).dt.strftime('%Y-%m-%d %H:%M')
results['ì‹¤ì œê°’'] = y_true.round(2)
results['ì˜ˆì¸¡ê°’'] = pred_total.round(2)
results['ì˜¤ì°¨'] = (results['ì‹¤ì œê°’'] - results['ì˜ˆì¸¡ê°’']).round(2)
results['ì ˆëŒ€ì˜¤ì°¨'] = (results['ì˜¤ì°¨'].abs()).round(2)
results['M14AM14B'] = m14b
results['M14AM14BSUM'] = m14bsum
results['queue_gap'] = gap
results['TRANSPORT'] = trans
# ìœ„í—˜ ê°ì§€ ì—¬ë¶€
results['ì‹¤ì œìœ„í—˜'] = np.where(y_true >= 1700, 'O', '')
results['ì˜ˆì¸¡ìœ„í—˜'] = np.where(pred_total >= 1700, 'O', '')
# ê²°ê³¼ ì¶œë ¥
mae = results['ì ˆëŒ€ì˜¤ì°¨'].mean()
print(f"\nğŸ“Š ì „ì²´ í‰ê·  ì ˆëŒ€ ì˜¤ì°¨ (MAE): {mae:.2f}")
high_val_mask = results['ì‹¤ì œê°’'] >= 1650
if high_val_mask.sum() > 0:
    mae_high = results.loc[high_val_mask, 'ì ˆëŒ€ì˜¤ì°¨'].mean()
    acc_high = (results.loc[high_val_mask, 'ì ˆëŒ€ì˜¤ì°¨'] <= 20).mean() * 100
    print(f"ğŸ”¥ ê³ ë¶€í•˜ êµ¬ê°„(>=1650) MAE: {mae_high:.2f}")
    print(f"ğŸ”¥ ê³ ë¶€í•˜ êµ¬ê°„ ì •í™•ë„(Â±20): {acc_high:.1f}%")
# 1700+ ê°ì§€ìœ¨
actual_danger = (y_true >= 1700).sum()
if actual_danger > 0:
    detected = ((y_true >= 1700) & (pred_total >= 1700)).sum()
    print(f"\nğŸ”¥ 1700+ ê°ì§€:")
    print(f"  ì‹¤ì œ: {actual_danger}ê°œ")
    print(f"  ê°ì§€: {detected}ê°œ ({detected/actual_danger*100:.1f}%)")
# CSV ì €ì¥
outfile = '20251211_16í‰ê°€_ê²°ê³¼_280ë¶„.CSV'
results.to_csv(outfile, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥ ì™„ë£Œ: {outfile}")
print(f"ğŸ“Š ì‹œí€€ìŠ¤: {SEQ_LEN}ë¶„")