#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š AMHS ê²°ì¸¡ì¹˜ ì²˜ë¦¬ (ì‹œê³„ì—´ íŠ¹ì„± ê³ ë ¤)

ì²˜ë¦¬ ë°©ë²•:
1. ì§§ì€ ê²°ì¸¡ (1~3ê°œ) â†’ ì„ í˜•ë³´ê°„ (ì•ë’¤ ê°’ ì‚¬ì´ ì§ì„ )
2. ê¸´ ê²°ì¸¡ (4ê°œ ì´ìƒ) â†’ ì´ë™í‰ê·  (ì£¼ë³€ 5ë¶„ í‰ê· )
3. ì²˜ìŒ/ë ê²°ì¸¡ â†’ ê°€ì¥ ê°€ê¹Œìš´ ìœ íš¨ê°’ìœ¼ë¡œ ì±„ì›€
"""

import pandas as pd
import numpy as np

# ========================================
# ì„¤ì •
# ========================================
INPUT_FILE = 'aps.csv'
OUTPUT_FILE = 'aps_cleaned.csv'

# ========================================
# í•¨ìˆ˜
# ========================================
def smart_interpolate(series):
    """
    ìŠ¤ë§ˆíŠ¸ ë³´ê°„:
    - ì§§ì€ ê²°ì¸¡: ì„ í˜•ë³´ê°„
    - ê¸´ ê²°ì¸¡: ì´ë™í‰ê· 
    """
    result = series.copy()
    
    # 1ë‹¨ê³„: ì„ í˜•ë³´ê°„ (ì§§ì€ ê°­ì€ ì´ê²Œ ì œì¼ ìì—°ìŠ¤ëŸ¬ì›€)
    result = result.interpolate(method='linear', limit=3, limit_direction='both')
    
    # 2ë‹¨ê³„: ë‚¨ì€ ê²°ì¸¡ì€ ì´ë™í‰ê·  (5ë¶„ ìœˆë„ìš°)
    if result.isna().any():
        rolling_mean = series.rolling(window=5, min_periods=1, center=True).mean()
        result = result.fillna(rolling_mean)
    
    # 3ë‹¨ê³„: ì²˜ìŒ/ë ë‚¨ì€ê±´ ì•ë’¤ ê°’ìœ¼ë¡œ
    result = result.ffill().bfill()
    
    return result

# ========================================
# ì‹¤í–‰
# ========================================
print("="*60)
print("ğŸ“Š AMHS ê²°ì¸¡ì¹˜ ì²˜ë¦¬ (ì‹œê³„ì—´ íŠ¹ì„± ê³ ë ¤)")
print("="*60)

# 1. ë¡œë“œ
try:
    df = pd.read_csv(INPUT_FILE, encoding='utf-8')
except:
    df = pd.read_csv(INPUT_FILE, encoding='cp949')

print(f"âœ… ë¡œë“œ: {len(df):,}í–‰ Ã— {len(df.columns)}ì—´")

# 2. ê²°ì¸¡ì¹˜ í˜„í™©
print(f"\nğŸ“Œ ê²°ì¸¡ì¹˜ í˜„í™©:")
missing_cols = []
for col in df.columns:
    if col == 'CURRTIME':
        continue
    missing = df[col].isna().sum() + (df[col] == '').sum()
    if missing > 0:
        missing_cols.append((col, missing))

if missing_cols:
    missing_cols.sort(key=lambda x: -x[1])
    for col, cnt in missing_cols[:10]:
        pct = cnt / len(df) * 100
        print(f"   {col[:45]:<45} : {cnt:>4}ê°œ ({pct:.1f}%)")
    if len(missing_cols) > 10:
        print(f"   ... ì™¸ {len(missing_cols)-10}ê°œ ì»¬ëŸ¼")
else:
    print("   ê²°ì¸¡ì¹˜ ì—†ìŒ!")

# 3. ì²˜ë¦¬
print(f"\nğŸ”„ ì²˜ë¦¬ ì¤‘...")
numeric_cols = [col for col in df.columns if col != 'CURRTIME']

for col in numeric_cols:
    # ìˆ«ìí˜• ë³€í™˜ (ë¹ˆ ë¬¸ìì—´, ê³µë°± ë“± â†’ NaN)
    df[col] = pd.to_numeric(df[col], errors='coerce')
    
    # ìŠ¤ë§ˆíŠ¸ ë³´ê°„ ì ìš©
    df[col] = smart_interpolate(df[col])

# 4. ê²°ê³¼ í™•ì¸
missing_after = df.isna().sum().sum()
print(f"âœ… ì²˜ë¦¬ ì™„ë£Œ! ë‚¨ì€ ê²°ì¸¡ì¹˜: {missing_after}ê°œ")

# 5. ì£¼ìš” ì»¬ëŸ¼ í†µê³„
print(f"\nğŸ“ˆ ì£¼ìš” ì»¬ëŸ¼ í†µê³„:")
key_cols = ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A']
for col in key_cols:
    if col in df.columns:
        print(f"   {col}: {df[col].min():.0f} ~ {df[col].max():.0f} (í‰ê· : {df[col].mean():.1f})")

# 6. ì €ì¥
df.to_csv(OUTPUT_FILE, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ì €ì¥: {OUTPUT_FILE}")
print("="*60)