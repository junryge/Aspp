#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š í˜„ì¬ íê°œìˆ˜ë³„ 10ë¶„ í›„ ì¦ê°ëŸ‰ ë¶„ì„ (ë‚ ì§œë³„)
"""

import pandas as pd
import numpy as np

# ë°ì´í„° ë¡œë“œ
DATA_PATH = 'your_data.csv'  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œ!
df = pd.read_csv(DATA_PATH)

print("="*70)
print("ğŸ“Š í˜„ì¬ íê°œìˆ˜ë³„ 10ë¶„ í›„ ì¦ê°ëŸ‰ ë¶„ì„")
print("="*70)

# CURRTIME íŒŒì‹±
df['CURRTIME'] = df['CURRTIME'].astype(str)
df['ë‚ ì§œ'] = df['CURRTIME'].str[:8]  # YYYYMMDD
df['ì‹œê°„'] = df['CURRTIME'].str[8:]  # HHMM

# 10ë¶„ í›„ ê°’ê³¼ ë³€í™”ëŸ‰ ê³„ì‚°
df['10ë¶„í›„_TOTALCNT'] = df['TOTALCNT'].shift(-10)
df['10ë¶„í›„_ì¦ê°'] = df['10ë¶„í›„_TOTALCNT'] - df['TOTALCNT']

# ì„ê³„ê°’ë³„ ë¶„ì„
thresholds = [1200, 1300, 1400, 1500, 1600, 1700, 1800]

for th in thresholds:
    print(f"\n{'='*70}")
    print(f"ğŸ”¹ í˜„ì¬ íê°œìˆ˜ >= {th}")
    print(f"{'='*70}")
    
    subset = df[df['TOTALCNT'] >= th].copy()
    subset = subset.dropna(subset=['10ë¶„í›„_ì¦ê°'])
    
    if len(subset) == 0:
        print("  í•´ë‹¹ ë°ì´í„° ì—†ìŒ")
        continue
    
    # ë‚ ì§œë³„ ì§‘ê³„
    daily = subset.groupby('ë‚ ì§œ').agg(
        ê±´ìˆ˜=('TOTALCNT', 'count'),
        í˜„ì¬í_í‰ê· =('TOTALCNT', 'mean'),
        í˜„ì¬í_ìµœëŒ€=('TOTALCNT', 'max'),
        _10ë¶„í›„_í‰ê· =('10ë¶„í›„_TOTALCNT', 'mean'),
        ì¦ê°_í‰ê· =('10ë¶„í›„_ì¦ê°', 'mean'),
        ì¦ê°_ìµœì†Œ=('10ë¶„í›„_ì¦ê°', 'min'),
        ì¦ê°_ìµœëŒ€=('10ë¶„í›„_ì¦ê°', 'max'),
        ì¦ê°€ê±´ìˆ˜=('10ë¶„í›„_ì¦ê°', lambda x: (x > 0).sum()),
        ê°ì†Œê±´ìˆ˜=('10ë¶„í›„_ì¦ê°', lambda x: (x < 0).sum())
    ).round(1)
    
    daily['ì¦ê°€ë¹„ìœ¨(%)'] = (daily['ì¦ê°€ê±´ìˆ˜'] / daily['ê±´ìˆ˜'] * 100).round(1)
    daily['ê°ì†Œë¹„ìœ¨(%)'] = (daily['ê°ì†Œê±´ìˆ˜'] / daily['ê±´ìˆ˜'] * 100).round(1)
    
    print(daily.to_string())
    
    # CSV ì €ì¥
    daily.to_csv(f'queue_{th}_daily_analysis.csv', encoding='utf-8-sig')
    print(f"\nğŸ’¾ queue_{th}_daily_analysis.csv ì €ì¥")

# ì „ì²´ ìš”ì•½
print("\n" + "="*70)
print("ğŸ“‹ ì „ì²´ ìš”ì•½")
print("="*70)

summary = []
for th in thresholds:
    subset = df[df['TOTALCNT'] >= th].dropna(subset=['10ë¶„í›„_ì¦ê°'])
    if len(subset) > 0:
        summary.append({
            'ì„ê³„ê°’': f'>={th}',
            'ì´ê±´ìˆ˜': len(subset),
            'í˜„ì¬í_í‰ê· ': round(subset['TOTALCNT'].mean(), 1),
            '10ë¶„í›„_í‰ê· ': round(subset['10ë¶„í›„_TOTALCNT'].mean(), 1),
            'ì¦ê°_í‰ê· ': round(subset['10ë¶„í›„_ì¦ê°'].mean(), 1),
            'ì¦ê°€ê±´ìˆ˜': (subset['10ë¶„í›„_ì¦ê°'] > 0).sum(),
            'ê°ì†Œê±´ìˆ˜': (subset['10ë¶„í›„_ì¦ê°'] < 0).sum(),
            'ì¦ê°€ë¹„ìœ¨(%)': round((subset['10ë¶„í›„_ì¦ê°'] > 0).sum() / len(subset) * 100, 1)
        })

summary_df = pd.DataFrame(summary)
print(summary_df.to_string(index=False))
summary_df.to_csv('queue_threshold_summary.csv', index=False, encoding='utf-8-sig')
print("\nğŸ’¾ queue_threshold_summary.csv ì €ì¥")

print("\nâœ… ë¶„ì„ ì™„ë£Œ!")