#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ AMHS ì‹¬ì¸µ ë¶„ì„ - Leakage ì œê±° + 1700+ ì§‘ì¤‘ ë¶„ì„
"""

import numpy as np
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

print("="*80)
print("ğŸ”¬ AMHS ì‹¬ì¸µ ë¶„ì„ - Leakage ì œê±° + 1700+ ì§‘ì¤‘ ë¶„ì„")
print("="*80)

# ========================================
# ğŸ“Œ íŒŒì¼ ê²½ë¡œ ìˆ˜ì •!
# ========================================
DATA_FILE = "data/M14_Q_3MONTH.csv"  # ì—¬ê¸° ìˆ˜ì •!

# ë°ì´í„° ë¡œë“œ
df = pd.read_csv(DATA_FILE, on_bad_lines='skip')
print(f"âœ… ë°ì´í„°: {len(df):,}í–‰ x {df.shape[1]}ì—´")

# queue_gap ìƒì„±
if 'M14.QUE.ALL.CURRENTQCREATED' in df.columns and 'M14.QUE.ALL.CURRENTQCOMPLETED' in df.columns:
    df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']

# ============================================================
# 1. ê¸°ë³¸ í†µê³„
# ============================================================
print("\n" + "="*60)
print("ğŸ“Š 1. ê¸°ë³¸ í†µê³„")
print("="*60)

target = 'TOTALCNT'
print(f"TOTALCNT í‰ê· : {df[target].mean():.2f}")
print(f"TOTALCNT ì¤‘ì•™ê°’: {df[target].median():.2f}")
print(f"TOTALCNT ë²”ìœ„: {df[target].min()} ~ {df[target].max()}")

print(f"\nğŸ“Œ ìœ„í—˜ êµ¬ê°„ ë¶„í¬:")
for t in [1500, 1600, 1650, 1700, 1750, 1800, 1900, 2000]:
    cnt = (df[target] >= t).sum()
    print(f"  {t}+ : {cnt:,}ê°œ ({cnt/len(df)*100:.3f}%)")

# ============================================================
# 2. Leakage ë³€ìˆ˜ í™•ì¸
# ============================================================
print("\n" + "="*60)
print("âš ï¸ 2. Leakage ì˜ì‹¬ ë³€ìˆ˜ í™•ì¸")
print("="*60)

leakage_cols = ['M14.QUE.ALL.CURRENTQCNT', 'M14B.QUE.ALL.CURRENTQCNT']
for col in leakage_cols:
    if col in df.columns:
        corr = df[col].corr(df[target])
        print(f"  {col} â†” TOTALCNT: {corr:.4f}")

# ============================================================
# 3. Leakage ì œê±° í›„ Feature Importance
# ============================================================
print("\n" + "="*60)
print("ğŸ¯ 3. Leakage ì œê±° í›„ Feature Importance")
print("="*60)

try:
    import xgboost as xgb
    from sklearn.model_selection import train_test_split
    from sklearn.metrics import mean_absolute_error, r2_score
    
    # ì œê±°í•  ì»¬ëŸ¼
    remove_cols = [
        'CURRTIME', 'TOTALCNT',
        # Leakage ì˜ì‹¬
        'M14.QUE.ALL.CURRENTQCNT',
        'M14B.QUE.ALL.CURRENTQCNT',
        # ê²°ì¸¡ì¹˜ 100%
        'M14.QUE.SFAB.SENDTOR3', 'M14.QUE.SFAB.SENDTOM16', 'M14.QUE.SFAB.SENDTOM10',
        'M14.QUE.SFAB.SENDQUEUETOTAL', 'M14.QUE.SFAB.RECEIVETOR3', 'M14.QUE.SFAB.RECEIVETOM16',
        'M14.QUE.SFAB.RECEIVETOM10', 'M14.QUE.SFAB.RECEIVEQUEUETOTAL',
        'M14.QUE.SFAB.RETURNTOR3', 'M14.QUE.SFAB.RETURNTOM16', 'M14.QUE.SFAB.RETURNTOM10',
        'M14.QUE.SFAB.RETURNQUEUETOTAL', 'M14.QUE.SFAB.COMPLETETOR3', 'M14.QUE.SFAB.COMPLETETOM16',
        'M14.QUE.SFAB.COMPLETETOM10', 'M14.QUE.SFAB.COMPLETEQUEUETOTAL',
        'M14B.QUE.ABN.QUETIMEDELAY',
        'M16.QUE.SFAB.SENDTOM14', 'M16.QUE.SFAB.RECEIVETOM14',
        'M16.QUE.SFAB.RETURNTOM14', 'M16.QUE.SFAB.COMPLETETOM14',
    ]
    
    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
    feature_cols = [c for c in numeric_cols if c not in remove_cols]
    
    print(f"âœ… ì‚¬ìš© Feature: {len(feature_cols)}ê°œ")
    
    X = df[feature_cols].fillna(df[feature_cols].median())
    y = df[target]
    
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    
    model = xgb.XGBRegressor(max_depth=6, learning_rate=0.1, n_estimators=100, 
                              random_state=42, n_jobs=-1)
    model.fit(X_train, y_train, eval_set=[(X_test, y_test)], verbose=False)
    
    y_pred = model.predict(X_test)
    mae = mean_absolute_error(y_test, y_pred)
    r2 = r2_score(y_test, y_pred)
    print(f"\nğŸ“Œ ëª¨ë¸ ì„±ëŠ¥: MAE={mae:.2f}, RÂ²={r2:.4f}")
    
    importance = pd.DataFrame({
        'feature': feature_cols,
        'importance': model.feature_importances_
    }).sort_values('importance', ascending=False)
    
    print(f"\nğŸ“Œ Feature Importance TOP 30 (Leakage ì œê±° í›„):")
    for i, row in importance.head(30).iterrows():
        print(f"  {importance.index.get_loc(i)+1:2d}. {row['feature']}: {row['importance']:.4f}")
    
    # CSV ì €ì¥
    importance.to_csv('importance_no_leakage.csv', index=False, encoding='utf-8-sig')
    print(f"\nâœ… ì €ì¥: importance_no_leakage.csv")
    
except ImportError:
    print("âŒ xgboost í•„ìš”")

# ============================================================
# 4. queue_gap ì‹¬ì¸µ ë¶„ì„
# ============================================================
print("\n" + "="*60)
print("ğŸ”¥ 4. queue_gap ì‹¬ì¸µ ë¶„ì„")
print("="*60)

if 'queue_gap' in df.columns:
    print(f"queue_gap í‰ê· : {df['queue_gap'].mean():.2f}")
    print(f"queue_gap í‘œì¤€í¸ì°¨: {df['queue_gap'].std():.2f}")
    print(f"queue_gap ë²”ìœ„: {df['queue_gap'].min():.0f} ~ {df['queue_gap'].max():.0f}")
    
    # ì „ì²´ ìƒê´€ê³„ìˆ˜
    corr_all = df['queue_gap'].corr(df[target])
    print(f"\nğŸ“Œ ì „ì²´ ë°ì´í„° ìƒê´€ê³„ìˆ˜: {corr_all:.4f}")
    
    # 1600+ êµ¬ê°„ë§Œ
    high_mask = df[target] >= 1600
    if high_mask.sum() > 0:
        corr_high = df[high_mask]['queue_gap'].corr(df[high_mask][target])
        print(f"ğŸ“Œ 1600+ êµ¬ê°„ ìƒê´€ê³„ìˆ˜: {corr_high:.4f}")
    
    # 1700+ êµ¬ê°„ë§Œ
    danger_mask = df[target] >= 1700
    if danger_mask.sum() > 0:
        corr_danger = df[danger_mask]['queue_gap'].corr(df[danger_mask][target])
        print(f"ğŸ“Œ 1700+ êµ¬ê°„ ìƒê´€ê³„ìˆ˜: {corr_danger:.4f}")
    
    # êµ¬ê°„ë³„ ë¶„ì„
    print(f"\nğŸ“Œ queue_gap êµ¬ê°„ë³„ 1700+ í™•ë¥ :")
    bins = [-9999, 50, 100, 150, 200, 250, 300, 350, 400, 500, 9999]
    labels = ['<50', '50-100', '100-150', '150-200', '200-250', '250-300', '300-350', '350-400', '400-500', '500+']
    df['gap_bin'] = pd.cut(df['queue_gap'], bins=bins, labels=labels)
    
    for label in labels:
        mask = df['gap_bin'] == label
        if mask.sum() > 0:
            cnt = mask.sum()
            avg = df[mask][target].mean()
            rate_1700 = (df[mask][target] >= 1700).sum() / cnt * 100
            print(f"    {label:10s}: {cnt:6,}ê°œ, í‰ê·  {avg:6.0f}, 1700+ {rate_1700:5.2f}%")
    
    df.drop('gap_bin', axis=1, inplace=True)

# ============================================================
# 5. í™©ê¸ˆ íŒ¨í„´ ë¶„ì„
# ============================================================
print("\n" + "="*60)
print("âœ¨ 5. í™©ê¸ˆ íŒ¨í„´ ë¶„ì„")
print("="*60)

if 'M14AM14B' in df.columns and 'M14AM14BSUM' in df.columns:
    print(f"M14AM14B ë²”ìœ„: {df['M14AM14B'].min()} ~ {df['M14AM14B'].max()}")
    print(f"M14AM14BSUM ë²”ìœ„: {df['M14AM14BSUM'].min()} ~ {df['M14AM14BSUM'].max()}")
    
    # ìƒê´€ê³„ìˆ˜
    corr_m14b = df['M14AM14B'].corr(df[target])
    corr_m14bsum = df['M14AM14BSUM'].corr(df[target])
    print(f"\nğŸ“Œ TOTALCNT ìƒê´€ê³„ìˆ˜:")
    print(f"  M14AM14B: {corr_m14b:.4f}")
    print(f"  M14AM14BSUM: {corr_m14bsum:.4f}")
    
    # ë‹¤ì–‘í•œ ì„ê³„ê°’ í…ŒìŠ¤íŠ¸
    print(f"\nğŸ“Œ í™©ê¸ˆ íŒ¨í„´ ì„ê³„ê°’ë³„ 1700+ í™•ë¥ :")
    thresholds = [
        (500, 580), (510, 590), (520, 600), (530, 610), (540, 620),
        (550, 630), (560, 640), (580, 660), (600, 680)
    ]
    
    for m14b_th, sum_th in thresholds:
        mask = (df['M14AM14B'] > m14b_th) & (df['M14AM14BSUM'] > sum_th)
        if mask.sum() > 0:
            cnt = mask.sum()
            rate_1700 = (df[mask][target] >= 1700).sum() / cnt * 100
            avg = df[mask][target].mean()
            print(f"    M14B>{m14b_th} & SUM>{sum_th}: {cnt:5,}ê°œ, í‰ê·  {avg:.0f}, 1700+ {rate_1700:5.1f}%")

# ============================================================
# 6. 1700+ êµ¬ê°„ íŠ¹ì„± ë¶„ì„
# ============================================================
print("\n" + "="*60)
print("ğŸš¨ 6. 1700+ êµ¬ê°„ íŠ¹ì„± ë¶„ì„")
print("="*60)

danger_mask = df[target] >= 1700
normal_mask = df[target] < 1600

print(f"1700+ ë°ì´í„°: {danger_mask.sum():,}ê°œ")
print(f"ì •ìƒ(<1600) ë°ì´í„°: {normal_mask.sum():,}ê°œ")

# ì£¼ìš” ë³€ìˆ˜ ë¹„êµ
key_vars = ['queue_gap', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A', 
            'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
            'M14.QUE.LOAD.CURRENTLOADQCNT', 'M14.QUE.SENDFAB.CURRENTSENDFABCOMPLETED']

print(f"\nğŸ“Œ ì£¼ìš” ë³€ìˆ˜ ë¹„êµ (ì •ìƒ vs ìœ„í—˜):")
print(f"{'ë³€ìˆ˜':<45} {'ì •ìƒí‰ê· ':>10} {'ìœ„í—˜í‰ê· ':>10} {'ë°°ìœ¨':>8}")
print("-" * 75)

for var in key_vars:
    if var in df.columns:
        normal_avg = df[normal_mask][var].mean()
        danger_avg = df[danger_mask][var].mean()
        ratio = danger_avg / normal_avg if normal_avg != 0 else 0
        print(f"{var:<45} {normal_avg:>10.1f} {danger_avg:>10.1f} {ratio:>8.2f}x")

# ============================================================
# 7. ë³µí•© ì¡°ê±´ ë¶„ì„ (Triple Check)
# ============================================================
print("\n" + "="*60)
print("ğŸ”¥ 7. ë³µí•© ì¡°ê±´ ë¶„ì„")
print("="*60)

if 'queue_gap' in df.columns and 'M14AM14B' in df.columns:
    conditions = [
        ("M14B>520 & SUM>600", (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)),
        ("M14B>520 & SUM>600 & gap>200", (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600) & (df['queue_gap'] > 200)),
        ("M14B>520 & SUM>600 & gap>250", (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600) & (df['queue_gap'] > 250)),
        ("M14B>520 & SUM>600 & gap>300", (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600) & (df['queue_gap'] > 300)),
        ("gap>300 ë§Œ", df['queue_gap'] > 300),
        ("gap>350 ë§Œ", df['queue_gap'] > 350),
        ("gap>400 ë§Œ", df['queue_gap'] > 400),
    ]
    
    print(f"{'ì¡°ê±´':<40} {'ë°œìƒ':>8} {'1700+':>8} {'í™•ë¥ ':>8}")
    print("-" * 70)
    
    for name, mask in conditions:
        if mask.sum() > 0:
            cnt = mask.sum()
            danger_cnt = (df[mask][target] >= 1700).sum()
            rate = danger_cnt / cnt * 100
            print(f"{name:<40} {cnt:>8,} {danger_cnt:>8,} {rate:>7.1f}%")

# ============================================================
# 8. ê²°ê³¼ ìš”ì•½ ì €ì¥
# ============================================================
print("\n" + "="*60)
print("ğŸ’¾ 8. ê²°ê³¼ ìš”ì•½")
print("="*60)

summary = []
summary.append(f"ì´ ë°ì´í„°: {len(df):,}í–‰")
summary.append(f"1700+ ë°ì´í„°: {(df[target]>=1700).sum():,}ê°œ ({(df[target]>=1700).sum()/len(df)*100:.2f}%)")
summary.append(f"TOTALCNT ë²”ìœ„: {df[target].min()} ~ {df[target].max()}")

if 'queue_gap' in df.columns:
    summary.append(f"queue_gap ë²”ìœ„: {df['queue_gap'].min():.0f} ~ {df['queue_gap'].max():.0f}")
    summary.append(f"queue_gap-TOTALCNT ìƒê´€: {df['queue_gap'].corr(df[target]):.4f}")

with open('analysis_summary.txt', 'w', encoding='utf-8') as f:
    f.write("\n".join(summary))
print("âœ… ì €ì¥: analysis_summary.txt")

print("\n" + "="*80)
print("âœ… ë¶„ì„ ì™„ë£Œ!")
print("="*80)