#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ 10ë¶„ í›„ ì˜ˆì¸¡ ì •í™•ë„ ê²€ì¦
- í˜„ì¬ gap, M14B, SUMìœ¼ë¡œ â†’ 10ë¶„ í›„ TOTALCNT ì˜ˆì¸¡
"""

import pandas as pd
import numpy as np

CSV_FILE = "YOUR_CSV_FILE.csv"  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œ!

print("="*70)
print("ğŸ”® 10ë¶„ í›„ ì˜ˆì¸¡ ê²€ì¦")
print("="*70)

df = pd.read_csv(CSV_FILE, on_bad_lines='skip')
print(f"ì´ {len(df):,}í–‰")

# ì»¬ëŸ¼ ì§€ì •
totalcnt_col = 'TOTALCNT'
m14b_col = 'M14AM14B'
m14bsum_col = 'M14AM14BSUM'
qcreated_col = 'M14.QUE.ALL.CURRENTQCREATED'
qcompleted_col = 'M14.QUE.ALL.CURRENTQCOMPLETED'

# queue_gap ê³„ì‚°
df['queue_gap'] = df[qcreated_col] - df[qcompleted_col]

# ============================================
# 10ë¶„ í›„ TOTALCNT (ì‹œí”„íŠ¸!)
# ============================================
PRED_MINUTES = 10
df['future_totalcnt'] = df[totalcnt_col].shift(-PRED_MINUTES)
df['future_1700'] = df['future_totalcnt'] >= 1700

# NaN ì œê±° (ë§ˆì§€ë§‰ 10í–‰)
df_valid = df.dropna(subset=['future_totalcnt']).copy()
print(f"ìœ íš¨ ë°ì´í„°: {len(df_valid):,}í–‰ (ë§ˆì§€ë§‰ {PRED_MINUTES}í–‰ ì œì™¸)")

# ============================================
# í˜„ì¬ ì¡°ê±´ë“¤
# ============================================
df_valid['gap_over_300'] = df_valid['queue_gap'] > 300
df_valid['gap_over_400'] = df_valid['queue_gap'] > 400
df_valid['gap_over_500'] = df_valid['queue_gap'] > 500
df_valid['gold_pattern'] = (df_valid[m14b_col] > 520) & (df_valid[m14bsum_col] > 600)
df_valid['triple_check'] = (df_valid[m14b_col] > 520) & (df_valid[m14bsum_col] > 600) & (df_valid['queue_gap'] > 250)

# ============================================
# ê¸°ë³¸ í†µê³„
# ============================================
total = len(df_valid)
actual_1700 = df_valid['future_1700'].sum()

print(f"\nğŸ“Š ê¸°ë³¸ í†µê³„:")
print(f"  ì „ì²´: {total:,}ê°œ")
print(f"  10ë¶„ í›„ 1700+ ì‹¤ì œ ë°œìƒ: {actual_1700:,}ê°œ ({actual_1700/total*100:.2f}%)")

# ============================================
# ì˜ˆì¸¡ ì •í™•ë„ ê²€ì¦
# ============================================
print("\n" + "="*70)
print("ğŸ¯ 10ë¶„ í›„ ì˜ˆì¸¡ ì •í™•ë„")
print("="*70)

def calc_metrics(condition, actual, name):
    """ì •ë°€ë„, ì¬í˜„ìœ¨, ê°ì§€ ê°œìˆ˜ ê³„ì‚°"""
    pred_positive = condition.sum()
    true_positive = (condition & actual).sum()
    actual_positive = actual.sum()
    
    precision = true_positive / pred_positive * 100 if pred_positive > 0 else 0
    recall = true_positive / actual_positive * 100 if actual_positive > 0 else 0
    
    print(f"\nğŸ”¥ {name}")
    print(f"  ì¡°ê±´ ì¶©ì¡±: {pred_positive:,}ê°œ")
    print(f"  ì‹¤ì œ 1700+ ê°ì§€: {true_positive:,}ê°œ / {actual_positive:,}ê°œ")
    print(f"  ì •ë°€ë„(Precision): {precision:.1f}% (ê²½ë³´ ì¤‘ ì‹¤ì œ ìœ„í—˜)")
    print(f"  ì¬í˜„ìœ¨(Recall): {recall:.1f}% (ì‹¤ì œ ìœ„í—˜ ì¤‘ ê°ì§€)")
    
    return pred_positive, true_positive, precision, recall

# ê° ì¡°ê±´ë³„ í…ŒìŠ¤íŠ¸
print("\n" + "-"*50)
print("ğŸ“Š queue_gap ë‹¨ë…")
print("-"*50)

for gap_th in [200, 250, 300, 350, 400, 500]:
    cond = df_valid['queue_gap'] > gap_th
    calc_metrics(cond, df_valid['future_1700'], f"gap > {gap_th}")

print("\n" + "-"*50)
print("ğŸ“Š í™©ê¸ˆíŒ¨í„´")
print("-"*50)

calc_metrics(df_valid['gold_pattern'], df_valid['future_1700'], "M14B>520 & SUM>600")

print("\n" + "-"*50)
print("ğŸ“Š ë³µí•© ì¡°ê±´ (Triple Check)")
print("-"*50)

calc_metrics(df_valid['triple_check'], df_valid['future_1700'], "M14B>520 & SUM>600 & gap>250")

# ì¶”ê°€ ë³µí•© ì¡°ê±´
for gap_th in [200, 300, 400]:
    cond = (df_valid[m14b_col] > 520) & (df_valid[m14bsum_col] > 600) & (df_valid['queue_gap'] > gap_th)
    calc_metrics(cond, df_valid['future_1700'], f"í™©ê¸ˆíŒ¨í„´ & gap>{gap_th}")

# ============================================
# ë¯¸ê°ì§€ ë¶„ì„
# ============================================
print("\n" + "="*70)
print("âš ï¸ ë¯¸ê°ì§€ ë¶„ì„")
print("="*70)

# Triple Checkë¡œ ë¯¸ê°ì§€ëœ ì¼€ì´ìŠ¤
missed = df_valid['future_1700'] & ~df_valid['triple_check']
print(f"\nTriple Check ë¯¸ê°ì§€: {missed.sum():,}ê°œ / {actual_1700:,}ê°œ")

# gap > 400 ë¯¸ê°ì§€
missed_gap400 = df_valid['future_1700'] & ~(df_valid['queue_gap'] > 400)
print(f"gap > 400 ë¯¸ê°ì§€: {missed_gap400.sum():,}ê°œ / {actual_1700:,}ê°œ")

# ìµœì  ì¡°ê±´ ì¡°í•©
print("\n" + "="*70)
print("ğŸ† ìµœì  ì¡°ê±´ íƒìƒ‰")
print("="*70)

best_f1 = 0
best_cond = ""

conditions = [
    ("gap>300", df_valid['queue_gap'] > 300),
    ("gap>350", df_valid['queue_gap'] > 350),
    ("gap>400", df_valid['queue_gap'] > 400),
    ("gap>500", df_valid['queue_gap'] > 500),
    ("Triple Check", df_valid['triple_check']),
    ("í™©ê¸ˆíŒ¨í„´ & gap>300", (df_valid[m14b_col] > 520) & (df_valid[m14bsum_col] > 600) & (df_valid['queue_gap'] > 300)),
    ("gap>300 OR í™©ê¸ˆíŒ¨í„´", (df_valid['queue_gap'] > 300) | df_valid['gold_pattern']),
    ("gap>250 OR í™©ê¸ˆíŒ¨í„´", (df_valid['queue_gap'] > 250) | df_valid['gold_pattern']),
]

print(f"\n{'ì¡°ê±´':<30} {'ì •ë°€ë„':>8} {'ì¬í˜„ìœ¨':>8} {'F1':>8} {'ê°ì§€ìˆ˜':>8}")
print("-"*70)

for name, cond in conditions:
    pred_pos = cond.sum()
    true_pos = (cond & df_valid['future_1700']).sum()
    actual_pos = df_valid['future_1700'].sum()
    
    prec = true_pos / pred_pos * 100 if pred_pos > 0 else 0
    rec = true_pos / actual_pos * 100 if actual_pos > 0 else 0
    f1 = 2 * prec * rec / (prec + rec) if (prec + rec) > 0 else 0
    
    print(f"{name:<30} {prec:>7.1f}% {rec:>7.1f}% {f1:>7.1f} {true_pos:>7,}")
    
    if f1 > best_f1:
        best_f1 = f1
        best_cond = name

print(f"\nğŸ† ìµœì  ì¡°ê±´: {best_cond} (F1: {best_f1:.1f})")

print("\nâœ… 10ë¶„ í›„ ì˜ˆì¸¡ ê²€ì¦ ì™„ë£Œ!")