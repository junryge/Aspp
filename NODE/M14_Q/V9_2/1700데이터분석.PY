#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ê°€ì¹˜ ë¶„ì„
- í•µì‹¬ 5ê°œ ì™¸ ë‹¤ë¥¸ ì»¬ëŸ¼ì´ ë¯¸ê°ì§€ 70%ë¥¼ ì¡ì„ ìˆ˜ ìˆë‚˜?
"""

import pandas as pd
import numpy as np

CSV_FILE = "YOUR_CSV_FILE.csv"  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œ!

print("="*70)
print("ğŸ”¬ ì»¬ëŸ¼ ê°€ì¹˜ ë¶„ì„")
print("="*70)

df = pd.read_csv(CSV_FILE, on_bad_lines='skip')
print(f"ì´ {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")

# í•µì‹¬ ì»¬ëŸ¼
totalcnt_col = 'TOTALCNT'
m14b_col = 'M14AM14B'
m14bsum_col = 'M14AM14BSUM'
qcreated_col = 'M14.QUE.ALL.CURRENTQCREATED'
qcompleted_col = 'M14.QUE.ALL.CURRENTQCOMPLETED'

# queue_gap ê³„ì‚°
df['queue_gap'] = df[qcreated_col] - df[qcompleted_col]

# 10ë¶„ í›„ TOTALCNT
df['future_totalcnt'] = df[totalcnt_col].shift(-10)
df['future_1700'] = df['future_totalcnt'] >= 1700
df = df.dropna(subset=['future_totalcnt']).copy()

# í˜„ì¬ ì¡°ê±´
df['triple_check'] = (df[m14b_col] > 520) & (df[m14bsum_col] > 600) & (df['queue_gap'] > 250)

# ë¯¸ê°ì§€ ì¼€ì´ìŠ¤ (Triple Checkë¡œ ëª» ì¡ì€ 1700+)
df['missed'] = df['future_1700'] & ~df['triple_check']

total_1700 = df['future_1700'].sum()
missed_count = df['missed'].sum()
print(f"\nğŸ“Š ê¸°ë³¸ í†µê³„:")
print(f"  10ë¶„ í›„ 1700+ ì „ì²´: {total_1700:,}ê°œ")
print(f"  Triple Check ê°ì§€: {total_1700 - missed_count:,}ê°œ")
print(f"  ë¯¸ê°ì§€: {missed_count:,}ê°œ ({missed_count/total_1700*100:.1f}%)")

# ============================================
# V8.3 ì‚¬ìš© ì»¬ëŸ¼ë“¤ ë¶„ì„
# ============================================
print("\n" + "="*70)
print("ğŸ“Š V8.3 ì‚¬ìš© ì»¬ëŸ¼ ë¶„ì„")
print("="*70)

v83_cols = [
    'M10AM14A',
    'M14.QUE.ALL.TRANSPORT4MINOVERCNT',
    'M14.QUE.OHT.OHTUTIL',
]

for col in v83_cols:
    if col in df.columns:
        # 1700+ vs ì •ìƒ ë¹„êµ
        val_1700 = df[df['future_1700']][col].mean()
        val_normal = df[~df['future_1700']][col].mean()
        val_missed = df[df['missed']][col].mean()
        
        print(f"\nğŸ” {col}")
        print(f"  ì •ìƒ í‰ê· : {val_normal:.1f}")
        print(f"  1700+ í‰ê· : {val_1700:.1f} (ì°¨ì´: {val_1700-val_normal:+.1f})")
        print(f"  ë¯¸ê°ì§€ í‰ê· : {val_missed:.1f}")
        
        # ìƒê´€ê´€ê³„
        corr = df[col].corr(df['future_totalcnt'])
        print(f"  10ë¶„ í›„ TOTALCNT ìƒê´€ê³„ìˆ˜: {corr:.3f}")

# ============================================
# ì „ì²´ ì»¬ëŸ¼ ìƒê´€ê´€ê³„ ë¶„ì„
# ============================================
print("\n" + "="*70)
print("ğŸ“Š ì „ì²´ ì»¬ëŸ¼ ìƒê´€ê´€ê³„ TOP 20")
print("="*70)

correlations = []
for col in df.columns:
    if col in ['CURRTIME', 'future_totalcnt', 'future_1700', 'triple_check', 'missed', 'queue_gap']:
        continue
    try:
        corr = df[col].corr(df['future_totalcnt'])
        if not np.isnan(corr):
            correlations.append((col, corr))
    except:
        pass

correlations.sort(key=lambda x: abs(x[1]), reverse=True)

print(f"\n{'ì»¬ëŸ¼':<50} {'ìƒê´€ê³„ìˆ˜':>10}")
print("-"*62)
for col, corr in correlations[:20]:
    marker = "â­" if col in [totalcnt_col, m14b_col, m14bsum_col, qcreated_col, qcompleted_col] else ""
    print(f"{col:<50} {corr:>10.4f} {marker}")

# ============================================
# ë¯¸ê°ì§€ ì¼€ì´ìŠ¤ íŠ¹ì„± ë¶„ì„
# ============================================
print("\n" + "="*70)
print("ğŸ” ë¯¸ê°ì§€ ì¼€ì´ìŠ¤ vs ê°ì§€ ì¼€ì´ìŠ¤ ë¹„êµ")
print("="*70)

detected = df['future_1700'] & df['triple_check']

key_cols = [totalcnt_col, m14b_col, m14bsum_col, 'queue_gap']
if 'M10AM14A' in df.columns:
    key_cols.append('M10AM14A')
if 'M14.QUE.ALL.TRANSPORT4MINOVERCNT' in df.columns:
    key_cols.append('M14.QUE.ALL.TRANSPORT4MINOVERCNT')
if 'M14.QUE.OHT.OHTUTIL' in df.columns:
    key_cols.append('M14.QUE.OHT.OHTUTIL')
if 'M14.QUE.ALL.CURRENTQCNT' in df.columns:
    key_cols.append('M14.QUE.ALL.CURRENTQCNT')

print(f"\n{'ì»¬ëŸ¼':<45} {'ê°ì§€ í‰ê· ':>12} {'ë¯¸ê°ì§€ í‰ê· ':>12} {'ì°¨ì´':>10}")
print("-"*82)
for col in key_cols:
    if col in df.columns:
        det_mean = df[detected][col].mean()
        mis_mean = df[df['missed']][col].mean()
        diff = mis_mean - det_mean
        print(f"{col:<45} {det_mean:>12.1f} {mis_mean:>12.1f} {diff:>+10.1f}")

# ============================================
# ë¯¸ê°ì§€ ì¼€ì´ìŠ¤ ë³´ì™„ ê°€ëŠ¥ì„±
# ============================================
print("\n" + "="*70)
print("ğŸ¯ ë¯¸ê°ì§€ ë³´ì™„ ê°€ëŠ¥ì„± íƒìƒ‰")
print("="*70)

# ë¯¸ê°ì§€ ì¼€ì´ìŠ¤ì—ì„œ ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ì¡ì„ ìˆ˜ ìˆëŠ”ì§€
missed_df = df[df['missed']]

print(f"\në¯¸ê°ì§€ {missed_count:,}ê°œ ì¤‘:")

# í˜„ì¬ TOTALCNTê°€ ì´ë¯¸ ë†’ì€ ê²½ìš°
high_current = (missed_df[totalcnt_col] >= 1600).sum()
print(f"  í˜„ì¬ TOTALCNT >= 1600: {high_current:,}ê°œ ({high_current/missed_count*100:.1f}%)")

high_current2 = (missed_df[totalcnt_col] >= 1650).sum()
print(f"  í˜„ì¬ TOTALCNT >= 1650: {high_current2:,}ê°œ ({high_current2/missed_count*100:.1f}%)")

# M14Bë§Œ ë†’ì€ ê²½ìš°
m14b_high = (missed_df[m14b_col] > 450).sum()
print(f"  M14B > 450: {m14b_high:,}ê°œ ({m14b_high/missed_count*100:.1f}%)")

# gap > 150
gap_150 = (missed_df['queue_gap'] > 150).sum()
print(f"  gap > 150: {gap_150:,}ê°œ ({gap_150/missed_count*100:.1f}%)")

gap_100 = (missed_df['queue_gap'] > 100).sum()
print(f"  gap > 100: {gap_100:,}ê°œ ({gap_100/missed_count*100:.1f}%)")

# TRANSPORT ë†’ì€ ê²½ìš°
if 'M14.QUE.ALL.TRANSPORT4MINOVERCNT' in df.columns:
    trans_col = 'M14.QUE.ALL.TRANSPORT4MINOVERCNT'
    trans_high = (missed_df[trans_col] > 100).sum()
    print(f"  TRANSPORT > 100: {trans_high:,}ê°œ ({trans_high/missed_count*100:.1f}%)")

# ============================================
# ë³´ì™„ ì¡°ê±´ í…ŒìŠ¤íŠ¸
# ============================================
print("\n" + "="*70)
print("ğŸ§ª ë³´ì™„ ì¡°ê±´ í…ŒìŠ¤íŠ¸")
print("="*70)

# ê¸°ì¡´ Triple Check + ì¶”ê°€ ì¡°ê±´
base_cond = df['triple_check']

# ì¶”ê°€ ì¡°ê±´ í›„ë³´
additional_conditions = [
    ("í˜„ì¬ TOTALCNT >= 1650", df[totalcnt_col] >= 1650),
    ("í˜„ì¬ TOTALCNT >= 1600", df[totalcnt_col] >= 1600),
    ("M14B > 450 & gap > 150", (df[m14b_col] > 450) & (df['queue_gap'] > 150)),
    ("M14B > 400 & gap > 200", (df[m14b_col] > 400) & (df['queue_gap'] > 200)),
    ("gap > 200 only", df['queue_gap'] > 200),
]

print(f"\n{'ì¡°ê±´':<40} {'ì •ë°€ë„':>10} {'ì¬í˜„ìœ¨':>10} {'ê°ì§€ìˆ˜':>10}")
print("-"*72)

# ê¸°ë³¸ Triple Check
tc_pred = base_cond.sum()
tc_hit = (base_cond & df['future_1700']).sum()
tc_prec = tc_hit / tc_pred * 100 if tc_pred > 0 else 0
tc_rec = tc_hit / total_1700 * 100
print(f"{'Triple Check (ê¸°ë³¸)':<40} {tc_prec:>9.1f}% {tc_rec:>9.1f}% {tc_hit:>10,}")

for name, add_cond in additional_conditions:
    combined = base_cond | add_cond
    pred = combined.sum()
    hit = (combined & df['future_1700']).sum()
    prec = hit / pred * 100 if pred > 0 else 0
    rec = hit / total_1700 * 100
    print(f"{'Triple + ' + name:<40} {prec:>9.1f}% {rec:>9.1f}% {hit:>10,}")

print("\nâœ… ë¶„ì„ ì™„ë£Œ!")