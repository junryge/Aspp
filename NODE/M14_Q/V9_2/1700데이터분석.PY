#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üî• AMHS Ï†ÑÏ≤¥ Ïª¨Îüº Î∂ÑÏÑù ÏΩîÎìú
109Í∞ú Ïª¨Îüº ‚Üí 1700+ Í∏âÏ¶ù/ÌïòÎùΩ ÏòàÏ∏° ÌïµÏã¨ Ïª¨Îüº Î∞úÍµ¥
"""

import pandas as pd
import numpy as np
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

# ============================================================
# 1. Îç∞Ïù¥ÌÑ∞ Î°úÎìú
# ============================================================
print("="*80)
print("üî• AMHS Ï†ÑÏ≤¥ Ïª¨Îüº Î∂ÑÏÑù (109Í∞ú Ïª¨Îüº)")
print("="*80)

# CSV Í≤ΩÎ°ú ÏÑ§Ï†ï (ÌïÑÏöîÏãú ÏàòÏ†ï)
CSV_PATH = '/mnt/user-data/uploads/OP22.CSV'

df = pd.read_csv(CSV_PATH, on_bad_lines='skip')
print(f"\nüìä Îç∞Ïù¥ÌÑ∞: {len(df):,}Ìñâ √ó {df.shape[1]}Ïó¥")

# ÏãúÍ∞Ñ ÌååÏã±
if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    print(f"üìÖ Í∏∞Í∞Ñ: {df['CURRTIME'].min()} ~ {df['CURRTIME'].max()}")

# ============================================================
# 2. TOTALCNT Î∂ÑÌè¨ Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üìä TOTALCNT Î∂ÑÌè¨")
print("="*80)

print(f"  Î≤îÏúÑ: {df['TOTALCNT'].min():.0f} ~ {df['TOTALCNT'].max():.0f}")
print(f"  ÌèâÍ∑†: {df['TOTALCNT'].mean():.1f}")
print(f"  ÌëúÏ§ÄÌé∏Ï∞®: {df['TOTALCNT'].std():.1f}")

# Íµ¨Í∞ÑÎ≥Ñ Î∂ÑÌè¨
thresholds = [1400, 1500, 1600, 1650, 1700, 1750, 1800]
for t in thresholds:
    cnt = (df['TOTALCNT'] >= t).sum()
    pct = cnt / len(df) * 100
    print(f"  {t}+: {cnt:,}Í∞ú ({pct:.2f}%)")

# ============================================================
# 3. Ï†ÑÏ≤¥ Ïª¨Îüº ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üìà Ï†ÑÏ≤¥ Ïª¨Îüº TOTALCNT ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ")
print("="*80)

# Í∏∞Ï°¥ ÏÇ¨Ïö© Ïª¨Îüº
KNOWN_COLS = [
    'CURRTIME', 'TOTALCNT', 'M14AM14B', 'M14AM14BSUM', 'M10AM14A',
    'M14.QUE.ALL.TRANSPORT4MINOVERCNT', 'M14.QUE.OHT.OHTUTIL',
    'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED'
]

correlations = []
numeric_cols = df.select_dtypes(include=[np.number]).columns

for col in numeric_cols:
    if col == 'TOTALCNT':
        continue
    
    valid = df[[col, 'TOTALCNT']].dropna()
    if len(valid) < 10:
        continue
    
    corr = valid[col].corr(valid['TOTALCNT'])
    
    # ÌÜµÍ≥Ñ
    col_mean = valid[col].mean()
    col_std = valid[col].std()
    col_min = valid[col].min()
    col_max = valid[col].max()
    na_count = df[col].isna().sum()
    
    correlations.append({
        'column': col,
        'correlation': corr,
        'abs_corr': abs(corr),
        'mean': col_mean,
        'std': col_std,
        'min': col_min,
        'max': col_max,
        'na_count': na_count,
        'is_new': col not in KNOWN_COLS
    })

corr_df = pd.DataFrame(correlations).sort_values('abs_corr', ascending=False)

# TOP 30 Ï∂úÎ†•
print(f"\nüèÜ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ TOP 30:")
print("-"*100)
print(f"{'ÏàúÏúÑ':>3} {'Ïª¨Îüº':<50} {'ÏÉÅÍ¥Ä':>8} {'ÌèâÍ∑†':>10} {'Î≤îÏúÑ':>20} {'Ïã†Í∑ú':>4}")
print("-"*100)

for idx, row in corr_df.head(30).iterrows():
    rank = corr_df.index.get_loc(idx) + 1
    new_flag = "üÜï" if row['is_new'] else ""
    range_str = f"{row['min']:.0f}~{row['max']:.0f}"
    print(f"{rank:>3} {row['column']:<50} {row['correlation']:>8.4f} {row['mean']:>10.1f} {range_str:>20} {new_flag:>4}")

# ============================================================
# 4. Ïã†Í∑ú Ïª¨ÎüºÎßå Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üÜï Ïã†Í∑ú Ïª¨Îüº TOP 20 (Í∏∞Ï°¥ ÎØ∏ÏÇ¨Ïö©)")
print("="*80)

new_cols = corr_df[corr_df['is_new']].head(20)
print("-"*90)
for idx, row in new_cols.iterrows():
    rank = new_cols.index.get_loc(idx) + 1
    print(f"{rank:>3}. {row['column']:<50} ÏÉÅÍ¥Ä: {row['correlation']:>8.4f}")

# ============================================================
# 5. ÌååÏÉùÎ≥ÄÏàò ÏÉùÏÑ± Î∞è Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üîß ÌååÏÉùÎ≥ÄÏàò Î∂ÑÏÑù")
print("="*80)

derived = {}

# queue_gap (Í∏∞Ï°¥)
if 'M14.QUE.ALL.CURRENTQCREATED' in df.columns and 'M14.QUE.ALL.CURRENTQCOMPLETED' in df.columns:
    df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    derived['queue_gap'] = df['queue_gap'].corr(df['TOTALCNT'])

# M14B queue_gap
if 'M14B.QUE.ALL.CURRENTQCREATED' in df.columns and 'M14B.QUE.ALL.CURRENTQCOMPLETED' in df.columns:
    df['queue_gap_M14B'] = df['M14B.QUE.ALL.CURRENTQCREATED'] - df['M14B.QUE.ALL.CURRENTQCOMPLETED']
    derived['queue_gap_M14B'] = df['queue_gap_M14B'].corr(df['TOTALCNT'])

# m14b_ratio
if 'M14B.QUE.ALL.CURRENTQCNT' in df.columns and 'M14.QUE.ALL.CURRENTQCNT' in df.columns:
    df['m14b_ratio'] = df['M14B.QUE.ALL.CURRENTQCNT'] / (df['M14.QUE.ALL.CURRENTQCNT'] + 1)
    derived['m14b_ratio'] = df['m14b_ratio'].corr(df['TOTALCNT'])

# OHT Ìï©Í≥Ñ
oht_cols = ['M14.QUE.OHT.CURRENTOHTQCNT', 'M14B.QUE.OHT.CURRENTOHTQCNT']
if all(c in df.columns for c in oht_cols):
    df['oht_total'] = df[oht_cols].sum(axis=1)
    derived['oht_total'] = df['oht_total'].corr(df['TOTALCNT'])

# Transport ratio
if 'M14.QUE.ALL.TRANSPORT4MINOVERCNT' in df.columns:
    df['trans_ratio'] = df['M14.QUE.ALL.TRANSPORT4MINOVERCNT'] / (df['TOTALCNT'] + 1)
    derived['trans_ratio'] = df['trans_ratio'].corr(df['TOTALCNT'])

# M14+M14B Ìï©Í≥Ñ
if 'M14AM14B' in df.columns and 'M14AM14BSUM' in df.columns:
    df['m14_combined'] = df['M14AM14B'] + df['M14AM14BSUM']
    derived['m14_combined'] = df['m14_combined'].corr(df['TOTALCNT'])

# CNV ÏãúÍ∞Ñ Ìï©Í≥Ñ
cnv_time_cols = ['M14.QUE.CNV.NORTHCNVTOM14TIME', 'M14.QUE.CNV.SOUTHCNVTOM14TIME']
if all(c in df.columns for c in cnv_time_cols):
    df['cnv_time_total'] = df[cnv_time_cols].sum(axis=1)
    derived['cnv_time_total'] = df['cnv_time_total'].corr(df['TOTALCNT'])

print("\nüìä ÌååÏÉùÎ≥ÄÏàò ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ:")
for name, corr in sorted(derived.items(), key=lambda x: abs(x[1]), reverse=True):
    print(f"  {name:<25}: {corr:>8.4f}")

# ============================================================
# 6. Ïª¨Îüº Í∑∏Î£πÎ≥Ñ Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üì¶ Ïª¨Îüº Í∑∏Î£πÎ≥Ñ TOP 3")
print("="*80)

groups = {
    'M14.QUE': [c for c in df.columns if c.startswith('M14.QUE')],
    'M14B.QUE': [c for c in df.columns if c.startswith('M14B.QUE')],
    'M16HUB': [c for c in df.columns if c.startswith('M16HUB')],
    'M16A/E': [c for c in df.columns if c.startswith('M16A') or c.startswith('M16E')],
    'M14AM': [c for c in df.columns if c.startswith('M14AM') or c.startswith('M14BM')],
}

for group_name, cols in groups.items():
    if not cols:
        continue
    group_corr = corr_df[corr_df['column'].isin(cols)].head(3)
    print(f"\nüîπ {group_name} ({len(cols)}Í∞ú)")
    for idx, row in group_corr.iterrows():
        print(f"   - {row['column']}: {row['correlation']:.4f}")

# ============================================================
# 7. ÏãúÍ∞Ñ ÏßÄÏó∞ Î∂ÑÏÑù (10Î∂Ñ ÌõÑ ÏòàÏ∏°Î†•)
# ============================================================
print("\n" + "="*80)
print("‚è∞ ÏãúÍ∞Ñ ÏßÄÏó∞ Î∂ÑÏÑù (10Î∂Ñ ÌõÑ TOTALCNT)")
print("="*80)

df['TOTALCNT_10min'] = df['TOTALCNT'].shift(-10)
df['delta_10min'] = df['TOTALCNT_10min'] - df['TOTALCNT']

# Í∞Å Ïª¨ÎüºÏùò 10Î∂Ñ ÌõÑ ÏòàÏ∏°Î†•
future_corr = []
for col in numeric_cols:
    if col == 'TOTALCNT':
        continue
    valid = df[[col, 'TOTALCNT_10min']].dropna()
    if len(valid) < 10:
        continue
    corr = valid[col].corr(valid['TOTALCNT_10min'])
    future_corr.append({'column': col, 'corr_future': corr})

future_df = pd.DataFrame(future_corr)
future_df['abs_corr'] = future_df['corr_future'].abs()
future_df = future_df.sort_values('abs_corr', ascending=False)

print(f"\nüéØ 10Î∂Ñ ÌõÑ ÏòàÏ∏°Î†• TOP 15:")
for idx, row in future_df.head(15).iterrows():
    print(f"  {row['column']:<50}: {row['corr_future']:.4f}")

# ============================================================
# 8. Í∏âÏ¶ù/Í∏âÎùΩ Ìå®ÌÑ¥ Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üìà Í∏âÏ¶ù/Í∏âÎùΩ Ìå®ÌÑ¥ Î∂ÑÏÑù")
print("="*80)

# 10Î∂ÑÍ∞Ñ Î≥ÄÌôîÎüâ
df['change_10min'] = df['TOTALCNT'].diff(10)

# Í∏âÏ¶ù: 10Î∂ÑÍ∞Ñ +100 Ïù¥ÏÉÅ
surge_mask = df['change_10min'] >= 100
# Í∏âÎùΩ: 10Î∂ÑÍ∞Ñ -100 Ïù¥ÏÉÅ
drop_mask = df['change_10min'] <= -100

print(f"Í∏âÏ¶ù(+100 Ïù¥ÏÉÅ): {surge_mask.sum()}Í±¥")
print(f"Í∏âÎùΩ(-100 Ïù¥ÏÉÅ): {drop_mask.sum()}Í±¥")

if surge_mask.sum() > 0:
    print(f"\nüî∫ Í∏âÏ¶ù ÏãúÏ†ê Ïª¨Îüº ÌèâÍ∑†:")
    surge_data = df[surge_mask]
    normal_data = df[~surge_mask & ~drop_mask]
    
    # Í∏âÏ¶ù vs Ï†ïÏÉÅ ÎπÑÍµê
    compare_cols = ['M14AM14B', 'M14AM14BSUM', 'queue_gap', 'M14.QUE.OHT.CURRENTOHTQCNT']
    for col in compare_cols:
        if col in df.columns:
            surge_mean = surge_data[col].mean()
            normal_mean = normal_data[col].mean()
            diff = surge_mean - normal_mean
            print(f"  {col:<40}: Í∏âÏ¶ù={surge_mean:.1f}, Ï†ïÏÉÅ={normal_mean:.1f}, Ï∞®Ïù¥={diff:+.1f}")

# ============================================================
# 9. Îç∞Ïù¥ÌÑ∞ ÎàÑÏ∂ú ÏúÑÌóò Ïª¨Îüº Ï≤¥ÌÅ¨
# ============================================================
print("\n" + "="*80)
print("‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ ÎàÑÏ∂ú ÏúÑÌóò Ï≤¥ÌÅ¨ (ÏÉÅÍ¥Ä > 0.95)")
print("="*80)

leak_risk = corr_df[corr_df['abs_corr'] > 0.95]
if len(leak_risk) > 0:
    print("üö® ÏÇ¨Ïö© Í∏àÏßÄ Ïª¨Îüº:")
    for idx, row in leak_risk.iterrows():
        print(f"  - {row['column']}: {row['correlation']:.4f}")
else:
    print("‚úÖ Îç∞Ïù¥ÌÑ∞ ÎàÑÏ∂ú ÏúÑÌóò Ïª¨Îüº ÏóÜÏùå")

# ============================================================
# 10. Í≤∞Ï∏°Í∞í Î∂ÑÏÑù
# ============================================================
print("\n" + "="*80)
print("üîç Í≤∞Ï∏°Í∞í Î∂ÑÏÑù")
print("="*80)

na_info = df.isna().sum()
na_cols = na_info[na_info > 0]
if len(na_cols) > 0:
    print(f"Í≤∞Ï∏°Í∞í ÏûàÎäî Ïª¨Îüº: {len(na_cols)}Í∞ú")
    for col, cnt in na_cols.items():
        pct = cnt / len(df) * 100
        if pct > 1:  # 1% Ïù¥ÏÉÅÎßå Ï∂úÎ†•
            print(f"  {col}: {cnt}Í∞ú ({pct:.1f}%)")
else:
    print("‚úÖ Í≤∞Ï∏°Í∞í ÏóÜÏùå")

# ============================================================
# 11. ÏµúÏ¢Ö Ï∂îÏ≤ú
# ============================================================
print("\n" + "="*80)
print("‚≠ê ÏµúÏ¢Ö Ï∂îÏ≤ú Ïª¨Îüº")
print("="*80)

print("\nüî• Í∞ïÎ†• Ï∂îÏ≤ú (ÏÉÅÍ¥Ä 0.4 Ïù¥ÏÉÅ Ïã†Í∑ú):")
strong = corr_df[(corr_df['is_new']) & (corr_df['abs_corr'] >= 0.4)]
for idx, row in strong.iterrows():
    print(f"  - {row['column']}: {row['correlation']:.4f}")

print("\nüìà Ï∂îÏ≤ú (ÏÉÅÍ¥Ä 0.3~0.4 Ïã†Í∑ú):")
medium = corr_df[(corr_df['is_new']) & (corr_df['abs_corr'] >= 0.3) & (corr_df['abs_corr'] < 0.4)]
for idx, row in medium.iterrows():
    print(f"  - {row['column']}: {row['correlation']:.4f}")

# ============================================================
# 12. Í≤∞Í≥º Ï†ÄÏû•
# ============================================================
output_path = '/mnt/user-data/outputs/column_analysis_result.csv'
corr_df.to_csv(output_path, index=False, encoding='utf-8-sig')
print(f"\nüíæ Í≤∞Í≥º Ï†ÄÏû•: {output_path}")

print("\n" + "="*80)
print("‚úÖ Î∂ÑÏÑù ÏôÑÎ£å!")
print("="*80)