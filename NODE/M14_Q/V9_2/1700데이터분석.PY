#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ í™©ê¸ˆíŒ¨í„´ ì´ë¡  ê²€ì¦ ì½”ë“œ
- queue_gap > 300 â†’ ìœ„í—˜
- M14B > 520 & SUM > 600 â†’ í™©ê¸ˆíŒ¨í„´
- ë‘˜ ë‹¤ ë§Œì¡± â†’ 96.5% í™•ë¥ 
"""

import pandas as pd
import numpy as np

# ============================================
# 1ë‹¨ê³„: CSV íŒŒì¼ ê²½ë¡œ ì„¤ì •
# ============================================
CSV_FILE = "YOUR_CSV_FILE.csv"  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½!

# ============================================
# 2ë‹¨ê³„: ë°ì´í„° ë¡œë“œ ë° ì»¬ëŸ¼ í™•ì¸
# ============================================
print("="*70)
print("ğŸ“‚ ë°ì´í„° ë¡œë“œ")
print("="*70)

df = pd.read_csv(CSV_FILE, on_bad_lines='skip')
print(f"ì´ {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")

print("\nğŸ“‹ ì „ì²´ ì»¬ëŸ¼ ëª©ë¡:")
for i, col in enumerate(df.columns):
    print(f"  [{i:3d}] {col}")

# ============================================
# 3ë‹¨ê³„: í•µì‹¬ ì»¬ëŸ¼ ìë™ íƒì§€
# ============================================
print("\n" + "="*70)
print("ğŸ” í•µì‹¬ ì»¬ëŸ¼ ìë™ íƒì§€")
print("="*70)

# TOTALCNT ì°¾ê¸°
totalcnt_col = None
for col in df.columns:
    if 'TOTALCNT' in col.upper():
        totalcnt_col = col
        print(f"âœ… TOTALCNT: {col}")
        break

# M14AM14B ì°¾ê¸°
m14b_col = None
for col in df.columns:
    if 'M14AM14B' in col.upper() and 'SUM' not in col.upper():
        m14b_col = col
        print(f"âœ… M14AM14B: {col}")
        break

# M14AM14BSUM ì°¾ê¸°
m14bsum_col = None
for col in df.columns:
    if 'M14AM14BSUM' in col.upper() or ('M14AM14B' in col.upper() and 'SUM' in col.upper()):
        m14bsum_col = col
        print(f"âœ… M14AM14BSUM: {col}")
        break

# CURRENTQCREATED ì°¾ê¸°
qcreated_col = None
for col in df.columns:
    if 'CURRENTQCREATED' in col.upper() or 'QCREATED' in col.upper():
        qcreated_col = col
        print(f"âœ… Q_CREATED: {col}")
        break

# CURRENTQCOMPLETED ì°¾ê¸°
qcompleted_col = None
for col in df.columns:
    if 'CURRENTQCOMPLETED' in col.upper() or 'QCOMPLETED' in col.upper():
        qcompleted_col = col
        print(f"âœ… Q_COMPLETED: {col}")
        break

# ============================================
# 4ë‹¨ê³„: ì»¬ëŸ¼ í™•ì¸ ìš”ì²­
# ============================================
print("\n" + "="*70)
print("â“ ì»¬ëŸ¼ í™•ì¸ í•„ìš”")
print("="*70)

missing = []
if not totalcnt_col:
    missing.append("TOTALCNT")
if not m14b_col:
    missing.append("M14AM14B")
if not m14bsum_col:
    missing.append("M14AM14BSUM")
if not qcreated_col:
    missing.append("CURRENTQCREATED")
if not qcompleted_col:
    missing.append("CURRENTQCOMPLETED")

if missing:
    print(f"âš ï¸ ìë™ íƒì§€ ì‹¤íŒ¨: {missing}")
    print("\nìœ„ ì»¬ëŸ¼ ëª©ë¡ì—ì„œ í•´ë‹¹ ì»¬ëŸ¼ëª…ì„ ì°¾ì•„ì„œ ì•Œë ¤ì£¼ì„¸ìš”!")
else:
    print("âœ… ëª¨ë“  í•µì‹¬ ì»¬ëŸ¼ íƒì§€ ì™„ë£Œ!")
    
    # ============================================
    # 5ë‹¨ê³„: í™©ê¸ˆíŒ¨í„´ ì´ë¡  ê²€ì¦
    # ============================================
    print("\n" + "="*70)
    print("ğŸ”¬ í™©ê¸ˆíŒ¨í„´ ì´ë¡  ê²€ì¦")
    print("="*70)
    
    # queue_gap ê³„ì‚°
    df['queue_gap'] = df[qcreated_col] - df[qcompleted_col]
    
    # ì¡°ê±´ë“¤
    df['is_1700'] = df[totalcnt_col] >= 1700
    df['gap_over_300'] = df['queue_gap'] > 300
    df['gold_pattern'] = (df[m14b_col] > 520) & (df[m14bsum_col] > 600)
    df['triple_check'] = (df[m14b_col] > 520) & (df[m14bsum_col] > 600) & (df['queue_gap'] > 250)
    
    total = len(df)
    cnt_1700 = df['is_1700'].sum()
    
    print(f"\nğŸ“Š ê¸°ë³¸ í†µê³„:")
    print(f"  ì „ì²´ ë°ì´í„°: {total:,}ê°œ")
    print(f"  1700+ ì´ë²¤íŠ¸: {cnt_1700:,}ê°œ ({cnt_1700/total*100:.2f}%)")
    
    # ì´ë¡  1: queue_gap > 300 â†’ ìœ„í—˜
    print(f"\nğŸ”¥ ì´ë¡  1: queue_gap > 300 â†’ 1700+")
    gap_over = df['gap_over_300'].sum()
    gap_and_1700 = (df['gap_over_300'] & df['is_1700']).sum()
    if gap_over > 0:
        print(f"  gap > 300: {gap_over:,}ê°œ")
        print(f"  ê·¸ ì¤‘ 1700+: {gap_and_1700:,}ê°œ ({gap_and_1700/gap_over*100:.1f}%)")
    else:
        print(f"  gap > 300: 0ê°œ (ë°ì´í„° ì—†ìŒ)")
    
    # ì´ë¡  2: í™©ê¸ˆíŒ¨í„´ â†’ 1700+
    print(f"\nğŸ† ì´ë¡  2: M14B>520 & SUM>600 â†’ 1700+")
    gold = df['gold_pattern'].sum()
    gold_and_1700 = (df['gold_pattern'] & df['is_1700']).sum()
    if gold > 0:
        print(f"  í™©ê¸ˆíŒ¨í„´: {gold:,}ê°œ")
        print(f"  ê·¸ ì¤‘ 1700+: {gold_and_1700:,}ê°œ ({gold_and_1700/gold*100:.1f}%)")
    else:
        print(f"  í™©ê¸ˆíŒ¨í„´: 0ê°œ (ë°ì´í„° ì—†ìŒ)")
    
    # ì´ë¡  3: Triple Check â†’ 96.5%
    print(f"\nâš¡ ì´ë¡  3: M14B>520 & SUM>600 & gap>250 â†’ 96.5%")
    triple = df['triple_check'].sum()
    triple_and_1700 = (df['triple_check'] & df['is_1700']).sum()
    if triple > 0:
        print(f"  Triple Check: {triple:,}ê°œ")
        print(f"  ê·¸ ì¤‘ 1700+: {triple_and_1700:,}ê°œ ({triple_and_1700/triple*100:.1f}%)")
    else:
        print(f"  Triple Check: 0ê°œ (ë°ì´í„° ì—†ìŒ)")
    
    # ì¶”ê°€: 1700+ ì¤‘ íŒ¨í„´ ë¯¸ì¶©ì¡± ì¼€ì´ìŠ¤
    print(f"\nâš ï¸ 1700+ ì¤‘ íŒ¨í„´ ë¯¸ì¶©ì¡± ì¼€ì´ìŠ¤:")
    no_pattern_1700 = df['is_1700'] & ~df['gold_pattern'] & ~df['gap_over_300']
    print(f"  í™©ê¸ˆíŒ¨í„´X & gap<=300 ì¸ë° 1700+: {no_pattern_1700.sum():,}ê°œ")
    
    # ìƒì„¸ ì„ê³„ê°’ ë¶„ì„
    print("\n" + "="*70)
    print("ğŸ“Š ì„ê³„ê°’ë³„ ìƒì„¸ ë¶„ì„")
    print("="*70)
    
    for gap_th in [200, 250, 300, 350, 400, 500]:
        cond = df['queue_gap'] > gap_th
        cnt = cond.sum()
        if cnt > 0:
            hit = (cond & df['is_1700']).sum()
            print(f"  gap > {gap_th}: {cnt:,}ê°œ ì¤‘ 1700+: {hit:,}ê°œ ({hit/cnt*100:.1f}%)")
    
    print()
    for m14b_th in [450, 480, 500, 520, 540]:
        cond = df[m14b_col] > m14b_th
        cnt = cond.sum()
        if cnt > 0:
            hit = (cond & df['is_1700']).sum()
            print(f"  M14B > {m14b_th}: {cnt:,}ê°œ ì¤‘ 1700+: {hit:,}ê°œ ({hit/cnt*100:.1f}%)")

print("\nâœ… ê²€ì¦ ì™„ë£Œ!")