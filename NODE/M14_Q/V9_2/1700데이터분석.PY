#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ ì‹œí€€ìŠ¤ ê¸¸ì´ ìµœì í™” ê²€ì¦
280ë¶„ vs 100ë¶„ vs 60ë¶„ vs 30ë¶„
"""

import pandas as pd
import numpy as np

CSV_FILE = "YOUR_CSV_FILE.csv"  # â† ì‹¤ì œ íŒŒì¼ ê²½ë¡œ!

print("="*70)
print("ğŸ”¬ ì‹œí€€ìŠ¤ ê¸¸ì´ ìµœì í™” ê²€ì¦")
print("="*70)

df = pd.read_csv(CSV_FILE, on_bad_lines='skip')
print(f"ì´ {len(df):,}í–‰")

# ì»¬ëŸ¼ ì§€ì •
totalcnt_col = 'TOTALCNT'
m14b_col = 'M14AM14B'
m14bsum_col = 'M14AM14BSUM'
qcreated_col = 'M14.QUE.ALL.CURRENTQCREATED'
qcompleted_col = 'M14.QUE.ALL.CURRENTQCOMPLETED'

# queue_gap ê³„ì‚°
df['queue_gap'] = df[qcreated_col] - df[qcompleted_col]

# 10ë¶„ í›„ íƒ€ê²Ÿ
PRED_MINUTES = 10
df['future_totalcnt'] = df[totalcnt_col].shift(-PRED_MINUTES)
df['future_1700'] = df['future_totalcnt'] >= 1700

# ============================================
# ì‹œí€€ìŠ¤ ê¸¸ì´ë³„ Feature ìƒì„± í•¨ìˆ˜
# ============================================
def create_features(df, idx, seq_len):
    """ê°„ë‹¨í•œ Feature ìƒì„± (ì‹œí€€ìŠ¤ ê¸¸ì´ë³„)"""
    if idx < seq_len:
        return None
    
    seq_total = df[totalcnt_col].iloc[idx-seq_len:idx].values
    seq_m14b = df[m14b_col].iloc[idx-seq_len:idx].values
    seq_m14bsum = df[m14bsum_col].iloc[idx-seq_len:idx].values
    seq_gap = df['queue_gap'].iloc[idx-seq_len:idx].values
    
    features = {
        'total_current': seq_total[-1],
        'total_mean': np.mean(seq_total),
        'total_max': np.max(seq_total),
        'total_slope': np.polyfit(np.arange(seq_len), seq_total, 1)[0],
        'm14b_current': seq_m14b[-1],
        'm14b_mean': np.mean(seq_m14b),
        'm14b_max': np.max(seq_m14b),
        'm14bsum_current': seq_m14bsum[-1],
        'm14bsum_mean': np.mean(seq_m14bsum),
        'gap_current': seq_gap[-1],
        'gap_mean': np.mean(seq_gap),
        'gap_max': np.max(seq_gap),
        'gap_slope': np.polyfit(np.arange(seq_len), seq_gap, 1)[0],
    }
    return features

# ============================================
# ì‹œí€€ìŠ¤ ê¸¸ì´ë³„ í…ŒìŠ¤íŠ¸
# ============================================
print("\n" + "="*70)
print("ğŸ“Š ì‹œí€€ìŠ¤ ê¸¸ì´ë³„ íŒ¨í„´ ê°ì§€ í…ŒìŠ¤íŠ¸")
print("="*70)

seq_lengths = [30, 60, 100, 150, 200, 280]

for seq_len in seq_lengths:
    print(f"\nğŸ” ì‹œí€€ìŠ¤ ê¸¸ì´: {seq_len}ë¶„")
    
    # ìœ íš¨ ë°ì´í„° ë²”ìœ„
    valid_start = seq_len
    valid_end = len(df) - PRED_MINUTES
    
    total_samples = valid_end - valid_start
    actual_1700 = df['future_1700'].iloc[valid_start:valid_end].sum()
    
    # íŒ¨í„´ ì²´í¬ (í˜„ì¬ ì‹œì  ê¸°ì¤€ - ì‹œí€€ìŠ¤ ë§ˆì§€ë§‰ ê°’)
    triple_check_count = 0
    triple_check_hit = 0
    
    for idx in range(valid_start, valid_end):
        # í˜„ì¬ê°’ (ì‹œí€€ìŠ¤ ë)
        current_m14b = df[m14b_col].iloc[idx-1]
        current_m14bsum = df[m14bsum_col].iloc[idx-1]
        current_gap = df['queue_gap'].iloc[idx-1]
        future_1700 = df['future_1700'].iloc[idx]
        
        # Triple Check
        if current_m14b > 520 and current_m14bsum > 600 and current_gap > 250:
            triple_check_count += 1
            if future_1700:
                triple_check_hit += 1
    
    precision = triple_check_hit / triple_check_count * 100 if triple_check_count > 0 else 0
    recall = triple_check_hit / actual_1700 * 100 if actual_1700 > 0 else 0
    
    print(f"  ìœ íš¨ ìƒ˜í”Œ: {total_samples:,}ê°œ")
    print(f"  ì‹¤ì œ 1700+: {actual_1700:,}ê°œ")
    print(f"  Triple Check ê°ì§€: {triple_check_count:,}ê°œ")
    print(f"  ì •ë°€ë„: {precision:.1f}%")
    print(f"  ì¬í˜„ìœ¨: {recall:.1f}%")

# ============================================
# slope ë¹„êµ (ì‹œí€€ìŠ¤ ê¸¸ì´ê°€ ì˜í–¥ ì£¼ëŠ” ë¶€ë¶„)
# ============================================
print("\n" + "="*70)
print("ğŸ“Š slope ë¹„êµ (ì‹œí€€ìŠ¤ ê¸¸ì´ ì˜í–¥)")
print("="*70)

# ìƒ˜í”Œ 1000ê°œë¡œ í…ŒìŠ¤íŠ¸
sample_indices = np.random.choice(range(280, len(df) - PRED_MINUTES), size=min(1000, len(df)-280-PRED_MINUTES), replace=False)

results = {seq_len: {'slopes': [], 'targets': []} for seq_len in seq_lengths}

for idx in sample_indices:
    target = df['future_totalcnt'].iloc[idx]
    if pd.isna(target):
        continue
    
    for seq_len in seq_lengths:
        if idx >= seq_len:
            seq_total = df[totalcnt_col].iloc[idx-seq_len:idx].values
            slope = np.polyfit(np.arange(seq_len), seq_total, 1)[0]
            results[seq_len]['slopes'].append(slope)
            results[seq_len]['targets'].append(target)

print(f"\n{'ì‹œí€€ìŠ¤':<10} {'slope í‰ê· ':>12} {'slope std':>12} {'íƒ€ê²Ÿ ìƒê´€':>12}")
print("-"*50)

for seq_len in seq_lengths:
    slopes = results[seq_len]['slopes']
    targets = results[seq_len]['targets']
    
    if len(slopes) > 0:
        mean_slope = np.mean(slopes)
        std_slope = np.std(slopes)
        corr = np.corrcoef(slopes, targets)[0, 1]
        print(f"{seq_len}ë¶„{'':<6} {mean_slope:>12.4f} {std_slope:>12.4f} {corr:>12.4f}")

# ============================================
# ì¶”ì²œ
# ============================================
print("\n" + "="*70)
print("ğŸ’¡ ê²°ë¡ ")
print("="*70)
print("""
íŒ¨í„´ ê¸°ë°˜ ì˜ˆì¸¡ì€ "í˜„ì¬ ì‹œì  ê°’"ë§Œ ì‚¬ìš©:
  - M14B[-1], SUM[-1], gap[-1], TOTALCNT[-1]
  â†’ ì‹œí€€ìŠ¤ ê¸¸ì´ê°€ íŒ¨í„´ ì •í™•ë„ì— ì˜í–¥ ì—†ìŒ!

ì‹œí€€ìŠ¤ê°€ ì˜í–¥ ì£¼ëŠ” ê²ƒ:
  - mean, max, slope ê°™ì€ í†µê³„ Feature
  - ML ëª¨ë¸ ì„±ëŠ¥

ê¶Œì¥:
  - 100ë¶„: ì¶©ë¶„í•œ íŠ¸ë Œë“œ + ë¹ ë¥¸ ì²˜ë¦¬
  - 280ë¶„: ê³¼ë„í•˜ê²Œ ê¹€ (4ì‹œê°„ 40ë¶„ ì „ ë°ì´í„°?)
""")

print("\nâœ… ê²€ì¦ ì™„ë£Œ!")