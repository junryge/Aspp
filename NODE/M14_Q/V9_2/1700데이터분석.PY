#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¥ 1700+ ê¸‰ì¦/í•˜ë½ ì˜ˆì¸¡ ì»¬ëŸ¼ ë¶„ì„
ëª©í‘œ: 10ë¶„ í›„ 1700+ ê¸‰ì¦ & ì•ˆì •í™” í•˜ë½ ì¡ëŠ” ì»¬ëŸ¼ ë°œêµ´
"""

import pandas as pd
import numpy as np
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

# ============================================================
# ì„¤ì • - CSV ê²½ë¡œ ìˆ˜ì •í•˜ì„¸ìš”!
# ============================================================
CSV_PATH = '/mnt/user-data/uploads/YOUR_3MONTH_DATA.CSV'  # â† ì—¬ê¸° ìˆ˜ì •!

print("="*80)
print("ğŸ”¥ 1700+ ê¸‰ì¦/í•˜ë½ ì˜ˆì¸¡ ì»¬ëŸ¼ ë¶„ì„")
print("="*80)

# ============================================================
# 1. ë°ì´í„° ë¡œë“œ
# ============================================================
df = pd.read_csv(CSV_PATH, on_bad_lines='skip')
print(f"\nğŸ“Š ë°ì´í„°: {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")

# ì‹œê°„ íŒŒì‹±
if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    print(f"ğŸ“… ê¸°ê°„: {df['CURRTIME'].min()} ~ {df['CURRTIME'].max()}")

# ============================================================
# 2. TOTALCNT ë¶„í¬
# ============================================================
print("\n" + "="*80)
print("ğŸ“Š TOTALCNT ë¶„í¬")
print("="*80)

print(f"  ë²”ìœ„: {df['TOTALCNT'].min():.0f} ~ {df['TOTALCNT'].max():.0f}")
print(f"  í‰ê· : {df['TOTALCNT'].mean():.1f}")

for t in [1600, 1650, 1700, 1750, 1800]:
    cnt = (df['TOTALCNT'] >= t).sum()
    pct = cnt / len(df) * 100
    print(f"  {t}+: {cnt:,}ê°œ ({pct:.2f}%)")

# ============================================================
# 3. í•µì‹¬ íŒŒìƒë³€ìˆ˜ ìƒì„±
# ============================================================
print("\n" + "="*80)
print("ğŸ”§ íŒŒìƒë³€ìˆ˜ ìƒì„±")
print("="*80)

# queue_gap (ê°€ì¥ ì¤‘ìš”!)
if 'M14.QUE.ALL.CURRENTQCREATED' in df.columns and 'M14.QUE.ALL.CURRENTQCOMPLETED' in df.columns:
    df['queue_gap'] = df['M14.QUE.ALL.CURRENTQCREATED'] - df['M14.QUE.ALL.CURRENTQCOMPLETED']
    print("âœ… queue_gap ìƒì„±")

# M14B queue_gap
if 'M14B.QUE.ALL.CURRENTQCREATED' in df.columns and 'M14B.QUE.ALL.CURRENTQCOMPLETED' in df.columns:
    df['queue_gap_M14B'] = df['M14B.QUE.ALL.CURRENTQCREATED'] - df['M14B.QUE.ALL.CURRENTQCOMPLETED']
    print("âœ… queue_gap_M14B ìƒì„±")

# m14_combined
if 'M14AM14B' in df.columns and 'M14AM14BSUM' in df.columns:
    df['m14_combined'] = df['M14AM14B'] + df['M14AM14BSUM']
    print("âœ… m14_combined ìƒì„±")

# ============================================================
# 4. íƒ€ê²Ÿ ë³€ìˆ˜ ìƒì„± (í•µì‹¬!)
# ============================================================
print("\n" + "="*80)
print("ğŸ¯ íƒ€ê²Ÿ ë³€ìˆ˜ ìƒì„±")
print("="*80)

# 10ë¶„ í›„ TOTALCNT
df['TOTAL_10min'] = df['TOTALCNT'].shift(-10)

# íƒ€ê²Ÿ 1: 10ë¶„ í›„ 1700+ ì—¬ë¶€
df['target_1700'] = (df['TOTAL_10min'] >= 1700).astype(int)

# íƒ€ê²Ÿ 2: ê¸‰ì¦ (í˜„ì¬ <1650 â†’ 10ë¶„í›„ >=1700)
df['target_surge'] = ((df['TOTALCNT'] < 1650) & (df['TOTAL_10min'] >= 1700)).astype(int)

# íƒ€ê²Ÿ 3: í•˜ë½ (í˜„ì¬ >=1700 â†’ 10ë¶„í›„ <1650)
df['target_drop'] = ((df['TOTALCNT'] >= 1700) & (df['TOTAL_10min'] < 1650)).astype(int)

# íƒ€ê²Ÿ 4: ìœ„í—˜ ì§„ì… (í˜„ì¬ <1700 â†’ 10ë¶„í›„ >=1700)
df['target_enter'] = ((df['TOTALCNT'] < 1700) & (df['TOTAL_10min'] >= 1700)).astype(int)

# íƒ€ê²Ÿ 5: ì•ˆì •í™” (í˜„ì¬ >=1700 â†’ 10ë¶„í›„ <1700)
df['target_stable'] = ((df['TOTALCNT'] >= 1700) & (df['TOTAL_10min'] < 1700)).astype(int)

print(f"ğŸ“Š íƒ€ê²Ÿ ë¶„í¬:")
print(f"  10ë¶„í›„ 1700+: {df['target_1700'].sum():,}ê±´ ({df['target_1700'].mean()*100:.2f}%)")
print(f"  ê¸‰ì¦(<1650â†’1700+): {df['target_surge'].sum():,}ê±´ ({df['target_surge'].mean()*100:.3f}%)")
print(f"  ìœ„í—˜ì§„ì…(<1700â†’1700+): {df['target_enter'].sum():,}ê±´ ({df['target_enter'].mean()*100:.2f}%)")
print(f"  ì•ˆì •í™”(1700+â†’<1700): {df['target_stable'].sum():,}ê±´ ({df['target_stable'].mean()*100:.2f}%)")
print(f"  ê¸‰ë½(1700+â†’<1650): {df['target_drop'].sum():,}ê±´ ({df['target_drop'].mean()*100:.3f}%)")

# ============================================================
# 5. ê° ì»¬ëŸ¼ì˜ ì˜ˆì¸¡ë ¥ ë¶„ì„
# ============================================================
print("\n" + "="*80)
print("ğŸ“ˆ ì»¬ëŸ¼ë³„ ì˜ˆì¸¡ë ¥ ë¶„ì„")
print("="*80)

numeric_cols = df.select_dtypes(include=[np.number]).columns
exclude_cols = ['TOTALCNT', 'TOTAL_10min', 'target_1700', 'target_surge', 
                'target_drop', 'target_enter', 'target_stable']

results = []

for col in numeric_cols:
    if col in exclude_cols:
        continue
    
    valid = df[[col, 'target_1700', 'target_surge', 'target_enter', 'target_stable']].dropna()
    if len(valid) < 100:
        continue
    
    # ê° íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê´€ê³„
    corr_1700 = valid[col].corr(valid['target_1700'])
    corr_surge = valid[col].corr(valid['target_surge'])
    corr_enter = valid[col].corr(valid['target_enter'])
    corr_stable = valid[col].corr(valid['target_stable'])
    
    # ê¸‰ì¦ ì‹œì  vs ì •ìƒ ì‹œì  í‰ê·  ë¹„êµ
    surge_mask = valid['target_surge'] == 1
    normal_mask = valid['target_surge'] == 0
    
    surge_mean = valid[surge_mask][col].mean() if surge_mask.sum() > 0 else np.nan
    normal_mean = valid[normal_mask][col].mean() if normal_mask.sum() > 0 else np.nan
    
    # êµ¬ë¶„ë„ (ê¸‰ì¦ì‹œ/ì •ìƒì‹œ ë¹„ìœ¨)
    if pd.notna(surge_mean) and pd.notna(normal_mean) and normal_mean != 0:
        discriminability = surge_mean / normal_mean
    else:
        discriminability = np.nan
    
    results.append({
        'column': col,
        'corr_1700': corr_1700,
        'corr_surge': corr_surge,
        'corr_enter': corr_enter,
        'corr_stable': corr_stable,
        'surge_mean': surge_mean,
        'normal_mean': normal_mean,
        'discriminability': discriminability
    })

result_df = pd.DataFrame(results)

# ============================================================
# 6. 10ë¶„ í›„ 1700+ ì˜ˆì¸¡ë ¥ TOP 30
# ============================================================
print("\n" + "="*80)
print("ğŸ¯ 10ë¶„ í›„ 1700+ ì˜ˆì¸¡ë ¥ TOP 30")
print("="*80)

top_1700 = result_df.copy()
top_1700['abs_corr'] = top_1700['corr_1700'].abs()
top_1700 = top_1700.sort_values('abs_corr', ascending=False).head(30)

print("-"*90)
print(f"{'ìˆœìœ„':>3} {'ì»¬ëŸ¼':<45} {'1700+ìƒê´€':>10} {'ê¸‰ì¦ìƒê´€':>10} {'ì§„ì…ìƒê´€':>10}")
print("-"*90)

for idx, row in top_1700.iterrows():
    rank = top_1700.index.get_loc(idx) + 1
    print(f"{rank:>3} {row['column']:<45} {row['corr_1700']:>10.4f} {row['corr_surge']:>10.4f} {row['corr_enter']:>10.4f}")

# ============================================================
# 7. ê¸‰ì¦ ì˜ˆì¸¡ë ¥ TOP 20 (í•µì‹¬!)
# ============================================================
print("\n" + "="*80)
print("ğŸ”¥ ê¸‰ì¦(<1650â†’1700+) ì˜ˆì¸¡ë ¥ TOP 20")
print("="*80)

top_surge = result_df.copy()
top_surge['abs_corr'] = top_surge['corr_surge'].abs()
top_surge = top_surge.sort_values('abs_corr', ascending=False).head(20)

print("-"*100)
print(f"{'ìˆœìœ„':>3} {'ì»¬ëŸ¼':<45} {'ê¸‰ì¦ìƒê´€':>10} {'ê¸‰ì¦ì‹œí‰ê· ':>12} {'ì •ìƒì‹œí‰ê· ':>12} {'êµ¬ë¶„ë„':>8}")
print("-"*100)

for idx, row in top_surge.iterrows():
    rank = top_surge.index.get_loc(idx) + 1
    disc = f"{row['discriminability']:.2f}" if pd.notna(row['discriminability']) else "N/A"
    surge_m = f"{row['surge_mean']:.1f}" if pd.notna(row['surge_mean']) else "N/A"
    normal_m = f"{row['normal_mean']:.1f}" if pd.notna(row['normal_mean']) else "N/A"
    print(f"{rank:>3} {row['column']:<45} {row['corr_surge']:>10.4f} {surge_m:>12} {normal_m:>12} {disc:>8}")

# ============================================================
# 8. ìœ„í—˜ ì§„ì… ì˜ˆì¸¡ë ¥ TOP 20
# ============================================================
print("\n" + "="*80)
print("âš ï¸ ìœ„í—˜ ì§„ì…(<1700â†’1700+) ì˜ˆì¸¡ë ¥ TOP 20")
print("="*80)

top_enter = result_df.copy()
top_enter['abs_corr'] = top_enter['corr_enter'].abs()
top_enter = top_enter.sort_values('abs_corr', ascending=False).head(20)

print("-"*90)
print(f"{'ìˆœìœ„':>3} {'ì»¬ëŸ¼':<45} {'ì§„ì…ìƒê´€':>10} {'1700+ìƒê´€':>10}")
print("-"*90)

for idx, row in top_enter.iterrows():
    rank = top_enter.index.get_loc(idx) + 1
    print(f"{rank:>3} {row['column']:<45} {row['corr_enter']:>10.4f} {row['corr_1700']:>10.4f}")

# ============================================================
# 9. ì•ˆì •í™”(í•˜ë½) ì˜ˆì¸¡ë ¥ TOP 20
# ============================================================
print("\n" + "="*80)
print("ğŸ“‰ ì•ˆì •í™”(1700+â†’<1700) ì˜ˆì¸¡ë ¥ TOP 20")
print("="*80)

top_stable = result_df.copy()
top_stable['abs_corr'] = top_stable['corr_stable'].abs()
top_stable = top_stable.sort_values('abs_corr', ascending=False).head(20)

print("-"*90)
print(f"{'ìˆœìœ„':>3} {'ì»¬ëŸ¼':<45} {'ì•ˆì •í™”ìƒê´€':>10} {'ë°©í–¥':>6}")
print("-"*90)

for idx, row in top_stable.iterrows():
    rank = top_stable.index.get_loc(idx) + 1
    direction = "â†“ë‚®ì„ìˆ˜ë¡" if row['corr_stable'] < 0 else "â†‘ë†’ì„ìˆ˜ë¡"
    print(f"{rank:>3} {row['column']:<45} {row['corr_stable']:>10.4f} {direction:>6}")

# ============================================================
# 10. queue_gap êµ¬ê°„ë³„ ê¸‰ì¦ í™•ë¥ 
# ============================================================
if 'queue_gap' in df.columns:
    print("\n" + "="*80)
    print("ğŸ”¥ queue_gap êµ¬ê°„ë³„ ê¸‰ì¦/1700+ í™•ë¥ ")
    print("="*80)
    
    gap_bins = [0, 100, 150, 200, 250, 300, 350, 400, 500, 1000]
    df['gap_bin'] = pd.cut(df['queue_gap'], bins=gap_bins)
    
    print(f"\n{'êµ¬ê°„':<15} {'ê±´ìˆ˜':>8} {'1700+í™•ë¥ ':>10} {'ê¸‰ì¦í™•ë¥ ':>10} {'ì§„ì…í™•ë¥ ':>10}")
    print("-"*60)
    
    for gap_range in df['gap_bin'].dropna().unique():
        mask = df['gap_bin'] == gap_range
        cnt = mask.sum()
        prob_1700 = df[mask]['target_1700'].mean() * 100
        prob_surge = df[mask]['target_surge'].mean() * 100
        prob_enter = df[mask]['target_enter'].mean() * 100
        print(f"{str(gap_range):<15} {cnt:>8,} {prob_1700:>9.1f}% {prob_surge:>9.2f}% {prob_enter:>9.1f}%")

# ============================================================
# 11. í™©ê¸ˆíŒ¨í„´ ë¶„ì„
# ============================================================
if 'M14AM14B' in df.columns and 'M14AM14BSUM' in df.columns:
    print("\n" + "="*80)
    print("ğŸ† í™©ê¸ˆíŒ¨í„´ ê¸‰ì¦ í™•ë¥ ")
    print("="*80)
    
    patterns = [
        ('M14B>520 & SUM>600', (df['M14AM14B'] > 520) & (df['M14AM14BSUM'] > 600)),
        ('M14B>540 & SUM>620', (df['M14AM14B'] > 540) & (df['M14AM14BSUM'] > 620)),
        ('M14B>500 & SUM>580', (df['M14AM14B'] > 500) & (df['M14AM14BSUM'] > 580)),
        ('M14B>450', df['M14AM14B'] > 450),
        ('M14B>400', df['M14AM14B'] > 400),
    ]
    
    if 'queue_gap' in df.columns:
        patterns.extend([
            ('queue_gap>250', df['queue_gap'] > 250),
            ('queue_gap>300', df['queue_gap'] > 300),
            ('queue_gap>350', df['queue_gap'] > 350),
            ('M14B>520 & gap>250', (df['M14AM14B'] > 520) & (df['queue_gap'] > 250)),
        ])
    
    print(f"\n{'íŒ¨í„´':<30} {'ê±´ìˆ˜':>8} {'1700+í™•ë¥ ':>10} {'ê¸‰ì¦í™•ë¥ ':>10} {'ì§„ì…í™•ë¥ ':>10}")
    print("-"*75)
    
    for name, mask in patterns:
        cnt = mask.sum()
        if cnt > 0:
            prob_1700 = df[mask]['target_1700'].mean() * 100
            prob_surge = df[mask]['target_surge'].mean() * 100
            prob_enter = df[mask]['target_enter'].mean() * 100
            print(f"{name:<30} {cnt:>8,} {prob_1700:>9.1f}% {prob_surge:>9.2f}% {prob_enter:>9.1f}%")

# ============================================================
# 12. ê²°ê³¼ ì €ì¥
# ============================================================
output_path = '/mnt/user-data/outputs/surge_prediction_analysis.csv'
result_df.to_csv(output_path, index=False, encoding='utf-8-sig')
print(f"\nğŸ’¾ ê²°ê³¼ ì €ì¥: {output_path}")

# ============================================================
# 13. ìµœì¢… ì¶”ì²œ
# ============================================================
print("\n" + "="*80)
print("â­ ìµœì¢… ì¶”ì²œ: ê¸‰ì¦/í•˜ë½ ì˜ˆì¸¡ í•µì‹¬ ì»¬ëŸ¼")
print("="*80)

print("\nğŸ”¥ ê¸‰ì¦ ì˜ˆì¸¡ TOP 5:")
for idx, row in top_surge.head(5).iterrows():
    print(f"  - {row['column']}: {row['corr_surge']:.4f}")

print("\nğŸ“‰ ì•ˆì •í™” ì˜ˆì¸¡ TOP 5:")
for idx, row in top_stable.head(5).iterrows():
    print(f"  - {row['column']}: {row['corr_stable']:.4f}")

print("\n" + "="*80)
print("âœ… ë¶„ì„ ì™„ë£Œ!")
print("="*80)