#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ“Š AMHS ì „ì²´ ì»¬ëŸ¼ vs TOTALCNT ê´€ê³„ì„± ë¶„ì„ (í•œê¸€íŒ)
ì‹¤í–‰: python column_correlation_korean.py ë°ì´í„°íŒŒì¼.csv
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy import stats
import warnings
import os
from datetime import datetime

warnings.filterwarnings('ignore')
plt.rcParams['axes.unicode_minus'] = False

print("="*80)
print("ğŸ“Š AMHS ì „ì²´ ì»¬ëŸ¼ vs TOTALCNT ê´€ê³„ì„± ë¶„ì„")
print("="*80)

# ========================================
# 1. ë°ì´í„° ë¡œë“œ
# ========================================
def load_data(file_path):
    print(f"\nğŸ“‚ ë°ì´í„° ë¡œë“œ: {file_path}")
    if not os.path.exists(file_path):
        print(f"âŒ íŒŒì¼ ì—†ìŒ: {file_path}")
        return None
    df = pd.read_csv(file_path, on_bad_lines='skip')
    print(f"âœ… {len(df):,}í–‰ Ã— {df.shape[1]}ì—´")
    return df

# ========================================
# 2. ê¸°ë³¸ ì •ë³´
# ========================================
def basic_info(df):
    print("\n" + "="*80)
    print("ğŸ“‹ ê¸°ë³¸ ì •ë³´")
    print("="*80)
    print(f"ì´ ì»¬ëŸ¼ ìˆ˜: {df.shape[1]}")
    print(f"ì´ í–‰ ìˆ˜: {len(df):,}")
    
    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
    object_cols = df.select_dtypes(include=['object']).columns.tolist()
    print(f"ìˆ˜ì¹˜í˜• ì»¬ëŸ¼: {len(numeric_cols)}ê°œ")
    
    return numeric_cols, object_cols

# ========================================
# 3. ê²°ì¸¡ì¹˜ ë¶„ì„
# ========================================
def missing_analysis(df, numeric_cols):
    print("\nğŸ” ê²°ì¸¡ì¹˜ ë¶„ì„ ì¤‘...")
    missing_info = []
    for col in numeric_cols:
        missing_count = df[col].isna().sum()
        missing_pct = missing_count / len(df) * 100
        zero_count = (df[col] == 0).sum()
        zero_pct = zero_count / len(df) * 100
        missing_info.append({
            'ì»¬ëŸ¼': col, 'ê²°ì¸¡ìˆ˜': missing_count, 'ê²°ì¸¡ë¥ ': round(missing_pct, 2),
            '0ê°’ìˆ˜': zero_count, '0ê°’ë¹„ìœ¨': round(zero_pct, 2)
        })
    df_missing = pd.DataFrame(missing_info).sort_values('ê²°ì¸¡ë¥ ', ascending=False)
    return df_missing

# ========================================
# 4. ìƒê´€ê´€ê³„ ë¶„ì„
# ========================================
def correlation_analysis(df, numeric_cols, target='TOTALCNT'):
    print(f"\nğŸ“ˆ {target}ì™€ ì „ì²´ ì»¬ëŸ¼ ìƒê´€ê´€ê³„ ë¶„ì„ ì¤‘...")
    if target not in df.columns:
        print(f"âŒ íƒ€ê²Ÿ ì»¬ëŸ¼ ì—†ìŒ: {target}")
        return None
    
    analysis_cols = [c for c in numeric_cols if c != target]
    results = []
    
    for col in analysis_cols:
        try:
            valid = ~(df[col].isna() | df[target].isna())
            x, y = df.loc[valid, col], df.loc[valid, target]
            if len(x) < 10: continue
            
            pearson, p_p = stats.pearsonr(x, y)
            spearman, s_p = stats.spearmanr(x, y)
            
            results.append({
                'ì»¬ëŸ¼': col, 'Pearson': round(pearson, 4), 'Spearman': round(spearman, 4),
                'í‰ê· ': round(x.mean(), 2), 'í‘œì¤€í¸ì°¨': round(x.std(), 2),
                'ìµœì†Œ': round(x.min(), 2), 'ìµœëŒ€': round(x.max(), 2)
            })
        except: pass
    
    df_corr = pd.DataFrame(results)
    df_corr['Pearson_abs'] = df_corr['Pearson'].abs()
    df_corr = df_corr.sort_values('Pearson_abs', ascending=False)
    print(f"âœ… ë¶„ì„ ì™„ë£Œ: {len(df_corr)}ê°œ ì»¬ëŸ¼")
    return df_corr

# ========================================
# 5. ë“±ê¸‰ ë¶„ë¥˜
# ========================================
def classify_correlation(df_corr):
    return {
        'very_strong': df_corr[df_corr['Pearson_abs'] >= 0.8],
        'strong': df_corr[(df_corr['Pearson_abs'] >= 0.6) & (df_corr['Pearson_abs'] < 0.8)],
        'moderate': df_corr[(df_corr['Pearson_abs'] >= 0.4) & (df_corr['Pearson_abs'] < 0.6)],
        'weak': df_corr[(df_corr['Pearson_abs'] >= 0.2) & (df_corr['Pearson_abs'] < 0.4)],
        'very_weak': df_corr[df_corr['Pearson_abs'] < 0.2]
    }

# ========================================
# 6. ì‹œê°í™”
# ========================================
def visualize_correlations(df_corr, output_dir):
    print("\nğŸ“Š ê·¸ë˜í”„ ìƒì„± ì¤‘...")
    os.makedirs(output_dir, exist_ok=True)
    
    # 1. TOP 30 ë°” ì°¨íŠ¸
    fig, ax = plt.subplots(figsize=(14, 10))
    top30 = df_corr.head(30)
    colors = ['red' if x >= 0.8 else 'orange' if x >= 0.6 else 'gold' if x >= 0.4 else 'green' 
              for x in top30['Pearson_abs']]
    
    ax.barh(range(len(top30)), top30['Pearson'], color=colors, alpha=0.8)
    ax.set_yticks(range(len(top30)))
    ax.set_yticklabels(top30['ì»¬ëŸ¼'], fontsize=8)
    ax.set_xlabel('Pearson Correlation', fontsize=12)
    ax.set_title('TOP 30 Correlation with TOTALCNT\n(Red>=0.8, Orange>=0.6, Yellow>=0.4, Green<0.4)', fontsize=14)
    ax.axvline(x=0.8, color='red', linestyle='--', linewidth=1, alpha=0.7)
    ax.axvline(x=0.6, color='orange', linestyle='--', linewidth=1, alpha=0.7)
    ax.axvline(x=0.4, color='gold', linestyle='--', linewidth=1, alpha=0.7)
    ax.axvline(x=0, color='black', linestyle='-', linewidth=0.5)
    ax.invert_yaxis()
    ax.grid(axis='x', alpha=0.3)
    plt.tight_layout()
    plt.savefig(f'{output_dir}/correlation_top30.png', dpi=150)
    plt.close()
    print(f"  âœ… correlation_top30.png")
    
    # 2. ë¶„í¬ íˆìŠ¤í† ê·¸ë¨
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    axes[0].hist(df_corr['Pearson'], bins=40, color='steelblue', alpha=0.7, edgecolor='black')
    axes[0].axvline(x=0.8, color='red', linestyle='--', label='0.8')
    axes[0].axvline(x=0.6, color='orange', linestyle='--', label='0.6')
    axes[0].axvline(x=0.4, color='gold', linestyle='--', label='0.4')
    axes[0].set_xlabel('Pearson Correlation')
    axes[0].set_title('Pearson Distribution')
    axes[0].legend()
    
    axes[1].hist(df_corr['Spearman'], bins=40, color='darkgreen', alpha=0.7, edgecolor='black')
    axes[1].axvline(x=0.8, color='red', linestyle='--', label='0.8')
    axes[1].axvline(x=0.6, color='orange', linestyle='--', label='0.6')
    axes[1].set_xlabel('Spearman Correlation')
    axes[1].set_title('Spearman Distribution')
    axes[1].legend()
    plt.tight_layout()
    plt.savefig(f'{output_dir}/correlation_distribution.png', dpi=150)
    plt.close()
    print(f"  âœ… correlation_distribution.png")
    
    # 3. Pearson vs Spearman
    fig, ax = plt.subplots(figsize=(8, 8))
    ax.scatter(df_corr['Pearson'], df_corr['Spearman'], alpha=0.5, c='steelblue', s=50)
    ax.plot([-1, 1], [-1, 1], 'r--', label='y=x')
    ax.set_xlabel('Pearson')
    ax.set_ylabel('Spearman')
    ax.set_title('Pearson vs Spearman')
    ax.legend()
    ax.grid(True, alpha=0.3)
    ax.set_xlim(-1, 1)
    ax.set_ylim(-1, 1)
    plt.tight_layout()
    plt.savefig(f'{output_dir}/pearson_vs_spearman.png', dpi=150)
    plt.close()
    print(f"  âœ… pearson_vs_spearman.png")

# ========================================
# 7. ì‚°ì ë„
# ========================================
def plot_scatter(df, df_corr, target='TOTALCNT', output_dir='output'):
    print("\nğŸ“‰ ì‚°ì ë„ ìƒì„± ì¤‘...")
    top_cols = df_corr.head(12)['ì»¬ëŸ¼'].tolist()
    
    fig, axes = plt.subplots(3, 4, figsize=(16, 12))
    axes = axes.flatten()
    
    for idx, col in enumerate(top_cols):
        ax = axes[idx]
        valid = ~(df[col].isna() | df[target].isna())
        x, y = df.loc[valid, col], df.loc[valid, target]
        
        if len(x) > 3000:
            sample = np.random.choice(len(x), 3000, replace=False)
            x, y = x.iloc[sample], y.iloc[sample]
        
        ax.scatter(x, y, alpha=0.3, s=5, c='steelblue')
        ax.axhline(y=1700, color='red', linestyle='--', alpha=0.7)
        ax.axhline(y=1600, color='orange', linestyle='--', alpha=0.5)
        
        corr = df_corr[df_corr['ì»¬ëŸ¼'] == col]['Pearson'].values[0]
        ax.set_title(f'{col[:35]}\nr={corr:.3f}', fontsize=9)
        ax.set_xlabel('')
        ax.set_ylabel('TOTALCNT' if idx % 4 == 0 else '')
    
    plt.tight_layout()
    plt.savefig(f'{output_dir}/scatter_top12.png', dpi=150)
    plt.close()
    print(f"  âœ… scatter_top12.png")

# ========================================
# 8. HTML ë¦¬í¬íŠ¸ (í•œê¸€!)
# ========================================
def generate_html_report(df_corr, classified, output_dir):
    print("\nğŸ“ HTML ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...")
    
    # ë°ì´í„° ëˆ„ìˆ˜ ìœ„í—˜ ì»¬ëŸ¼
    leakage = df_corr[df_corr['Pearson_abs'] >= 0.95]
    
    html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AMHS ì»¬ëŸ¼ ìƒê´€ê´€ê³„ ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <style>
        body {{ font-family: 'Malgun Gothic', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
        h1 {{ color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }}
        h2 {{ color: #34495e; margin-top: 30px; border-left: 4px solid #3498db; padding-left: 10px; }}
        h3 {{ color: #2980b9; }}
        .summary {{ display: flex; gap: 20px; flex-wrap: wrap; margin: 20px 0; }}
        .card {{ color: white; padding: 20px; border-radius: 10px; min-width: 150px; text-align: center; }}
        .card.danger {{ background: linear-gradient(135deg, #e74c3c, #c0392b); }}
        .card.warning {{ background: linear-gradient(135deg, #f39c12, #e67e22); }}
        .card.info {{ background: linear-gradient(135deg, #3498db, #2980b9); }}
        .card.success {{ background: linear-gradient(135deg, #27ae60, #2ecc71); }}
        .card h3 {{ margin: 0; font-size: 2.2em; color: white; }}
        .card p {{ margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95em; }}
        table {{ border-collapse: collapse; width: 100%; margin: 15px 0; }}
        th, td {{ border: 1px solid #ddd; padding: 10px; text-align: left; }}
        th {{ background: #3498db; color: white; }}
        tr:nth-child(even) {{ background: #f9f9f9; }}
        tr:hover {{ background: #e8f4f8; }}
        .high {{ color: #e74c3c; font-weight: bold; }}
        .medium {{ color: #f39c12; font-weight: bold; }}
        .low {{ color: #27ae60; }}
        .alert {{ background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 20px 0; }}
        .alert.danger {{ background: #f8d7da; border-color: #f5c6cb; }}
        .alert.info {{ background: #d1ecf1; border-color: #bee5eb; }}
        .alert.success {{ background: #d4edda; border-color: #c3e6cb; }}
        img {{ max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }}
        .img-box {{ background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; }}
        .conclusion {{ background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; padding: 25px; border-radius: 15px; margin-top: 30px; }}
        .conclusion h2 {{ color: #00d4ff; border-left: 4px solid #00d4ff; }}
        .conclusion ul {{ line-height: 2; }}
        .tag {{ display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.85em; margin: 2px; }}
        .tag.red {{ background: #e74c3c; color: white; }}
        .tag.green {{ background: #27ae60; color: white; }}
        .tag.blue {{ background: #3498db; color: white; }}
        .tag.yellow {{ background: #f1c40f; color: black; }}
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š AMHS ì»¬ëŸ¼ vs TOTALCNT ìƒê´€ê´€ê³„ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
    <p>ìƒì„±ì¼ì‹œ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    <p><strong>ëª©ì :</strong> TOTALCNT(ì „ì²´ ë¬¼ë¥˜ëŸ‰) ì˜ˆì¸¡ì„ ìœ„í•œ ì…ë ¥ ì»¬ëŸ¼ ì„ ì • ë° ë°ì´í„° ëˆ„ìˆ˜ íƒì§€</p>
    
    <h2>ğŸ“‹ ë¶„ì„ ìš”ì•½</h2>
    <div class="summary">
        <div class="card danger">
            <h3>{len(classified['very_strong'])}</h3>
            <p>ğŸ”´ ë§¤ìš° ê°•í•¨<br>(|r| â‰¥ 0.8)</p>
        </div>
        <div class="card warning">
            <h3>{len(classified['strong'])}</h3>
            <p>ğŸŸ  ê°•í•¨<br>(0.6~0.8)</p>
        </div>
        <div class="card info">
            <h3>{len(classified['moderate'])}</h3>
            <p>ğŸŸ¡ ì¤‘ê°„<br>(0.4~0.6)</p>
        </div>
        <div class="card success">
            <h3>{len(classified['weak']) + len(classified['very_weak'])}</h3>
            <p>ğŸŸ¢ ì•½í•¨<br>(|r| < 0.4)</p>
        </div>
    </div>
"""
    
    # ë°ì´í„° ëˆ„ìˆ˜ ê²½ê³ 
    if len(leakage) > 0:
        html += """
    <div class="alert danger">
        <h3>ğŸš¨ ë°ì´í„° ëˆ„ìˆ˜ ê²½ê³ !</h3>
        <p>ì•„ë˜ ì»¬ëŸ¼ë“¤ì€ TOTALCNTì™€ <strong>95% ì´ìƒ</strong> ë™ì¼í•œ ê°’ì…ë‹ˆë‹¤. <strong>í•™ìŠµì—ì„œ ë°˜ë“œì‹œ ì œì™¸</strong>í•˜ì„¸ìš”!</p>
        <ul>
"""
        for _, row in leakage.iterrows():
            html += f"<li><strong>{row['ì»¬ëŸ¼']}</strong> (r = {row['Pearson']:.4f})</li>\n"
        html += """
        </ul>
        <p>â†’ ì´ ì»¬ëŸ¼ì„ ë„£ìœ¼ë©´ ê°€ì§œ 100% ì •í™•ë„ê°€ ë‚˜ì˜µë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ì“¸ëª¨ì—†ìŒ!</p>
    </div>
"""
    
    # ìƒê´€ê´€ê³„ í•´ì„ ê°€ì´ë“œ
    html += """
    <div class="alert info">
        <h3>ğŸ“– ìƒê´€ê³„ìˆ˜ í•´ì„ ê°€ì´ë“œ</h3>
        <table>
            <tr><th>Pearson ê°’</th><th>ì˜ë¯¸</th><th>Featureë¡œ ì‚¬ìš©?</th></tr>
            <tr><td>0.0 ~ 0.2</td><td>TOTALCNTì™€ ê´€ê³„ ê±°ì˜ ì—†ìŒ</td><td>âŒ ì“¸ëª¨ì—†ìŒ</td></tr>
            <tr><td>0.2 ~ 0.4</td><td>ì•½í•œ ê´€ê³„</td><td>â–³ ë³´ì¡°ìš©</td></tr>
            <tr><td class="medium">0.4 ~ 0.8</td><td>ì ë‹¹íˆ ê°•í•œ ê´€ê³„</td><td>âœ… <strong>BEST! ì´ê±° ì“°ê¸°!</strong></td></tr>
            <tr><td class="high">0.95 ì´ìƒ</td><td>ê±°ì˜ ë˜‘ê°™ì€ ê°’</td><td>âŒ ë°ì´í„° ëˆ„ìˆ˜ ìœ„í—˜!</td></tr>
        </table>
    </div>
"""
    
    # ë§¤ìš° ê°•í•œ ìƒê´€ê´€ê³„
    html += """
    <h2>ğŸ”´ ë§¤ìš° ê°•í•œ ìƒê´€ê´€ê³„ (|r| â‰¥ 0.8)</h2>
    <p>âš ï¸ 0.95 ì´ìƒì€ ë°ì´í„° ëˆ„ìˆ˜ ìœ„í—˜! 0.8~0.95ëŠ” í•µì‹¬ Feature í›„ë³´</p>
    <table>
        <tr><th>ì»¬ëŸ¼ëª…</th><th>Pearson</th><th>Spearman</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>íŒì •</th></tr>
"""
    for _, row in classified['very_strong'].iterrows():
        if row['Pearson_abs'] >= 0.95:
            tag = '<span class="tag red">ì œì™¸ í•„ìˆ˜</span>'
        else:
            tag = '<span class="tag green">í•µì‹¬ Feature</span>'
        html += f"<tr><td>{row['ì»¬ëŸ¼']}</td><td class='high'>{row['Pearson']:.4f}</td><td>{row['Spearman']:.4f}</td><td>{row['í‰ê· ']:.2f}</td><td>{row['í‘œì¤€í¸ì°¨']:.2f}</td><td>{tag}</td></tr>\n"
    html += "</table>\n"
    
    # ê°•í•œ ìƒê´€ê´€ê³„
    html += """
    <h2>ğŸŸ  ê°•í•œ ìƒê´€ê´€ê³„ (0.6 â‰¤ |r| < 0.8)</h2>
    <p>âœ… ì¢‹ì€ Feature í›„ë³´ë“¤!</p>
    <table>
        <tr><th>ì»¬ëŸ¼ëª…</th><th>Pearson</th><th>Spearman</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>íŒì •</th></tr>
"""
    for _, row in classified['strong'].iterrows():
        html += f"<tr><td>{row['ì»¬ëŸ¼']}</td><td class='medium'>{row['Pearson']:.4f}</td><td>{row['Spearman']:.4f}</td><td>{row['í‰ê· ']:.2f}</td><td>{row['í‘œì¤€í¸ì°¨']:.2f}</td><td><span class='tag green'>ì¶”ì²œ</span></td></tr>\n"
    html += "</table>\n"
    
    # ì¤‘ê°„ ìƒê´€ê´€ê³„
    html += """
    <h2>ğŸŸ¡ ì¤‘ê°„ ìƒê´€ê´€ê³„ (0.4 â‰¤ |r| < 0.6)</h2>
    <p>âœ… ì ì ˆí•œ Featureë“¤ - í˜„ì¬ V8.3ì—ì„œ ë§ì´ ì‚¬ìš© ì¤‘</p>
    <table>
        <tr><th>ì»¬ëŸ¼ëª…</th><th>Pearson</th><th>Spearman</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>íŒì •</th></tr>
"""
    for _, row in classified['moderate'].iterrows():
        html += f"<tr><td>{row['ì»¬ëŸ¼']}</td><td>{row['Pearson']:.4f}</td><td>{row['Spearman']:.4f}</td><td>{row['í‰ê· ']:.2f}</td><td>{row['í‘œì¤€í¸ì°¨']:.2f}</td><td><span class='tag blue'>ê²€í† </span></td></tr>\n"
    html += "</table>\n"
    
    # ê·¸ë˜í”„ ì„¹ì…˜
    html += """
    <h2>ğŸ“Š TOP 30 ìƒê´€ê´€ê³„ ì°¨íŠ¸</h2>
    <p>ìƒê´€ê³„ìˆ˜ê°€ ë†’ì€ ìƒìœ„ 30ê°œ ì»¬ëŸ¼ (ë¹¨ê°•â‰¥0.8, ì£¼í™©â‰¥0.6, ë…¸ë‘â‰¥0.4, ì´ˆë¡&lt;0.4)</p>
    <div class="img-box">
        <img src="correlation_top30.png" alt="TOP 30 ìƒê´€ê´€ê³„">
    </div>
    
    <h2>ğŸ“ˆ ìƒê´€ê³„ìˆ˜ ë¶„í¬</h2>
    <p>ì „ì²´ ì»¬ëŸ¼ì˜ Pearson/Spearman ìƒê´€ê³„ìˆ˜ ë¶„í¬</p>
    <div class="img-box">
        <img src="correlation_distribution.png" alt="ìƒê´€ê³„ìˆ˜ ë¶„í¬">
    </div>
    
    <h2>ğŸ”— Pearson vs Spearman ë¹„êµ</h2>
    <p>ë‘ ê°’ì´ ë¹„ìŠ·í•˜ë©´ ì„ í˜•ê´€ê³„, ë‹¤ë¥´ë©´ ë¹„ì„ í˜•ê´€ê³„ ê°€ëŠ¥ì„±</p>
    <div class="img-box">
        <img src="pearson_vs_spearman.png" alt="Pearson vs Spearman">
    </div>
    
    <h2>ğŸ“‰ ìƒìœ„ 12ê°œ ì»¬ëŸ¼ ì‚°ì ë„</h2>
    <p>TOTALCNTì™€ ìƒê´€ê´€ê³„ ë†’ì€ ì»¬ëŸ¼ë“¤ì˜ ì‹¤ì œ ë¶„í¬ (ë¹¨ê°„ì„ =1700, ì£¼í™©ì„ =1600)</p>
    <div class="img-box">
        <img src="scatter_top12.png" alt="ì‚°ì ë„">
    </div>
"""
    
    # ê²°ë¡  ì„¹ì…˜
    best_features = classified['strong']['ì»¬ëŸ¼'].tolist()[:3] + classified['moderate']['ì»¬ëŸ¼'].tolist()[:5]
    exclude_features = leakage['ì»¬ëŸ¼'].tolist() if len(leakage) > 0 else []
    
    html += f"""
    <div class="conclusion">
        <h2>ğŸ“ ë¶„ì„ ê²°ê³¼ ë° ê¶Œì¥ì‚¬í•­</h2>
        
        <h3>1ï¸âƒ£ í•µì‹¬ ë°œê²¬ì‚¬í•­</h3>
        <ul>
            <li>ì´ <strong>{len(df_corr)}ê°œ</strong> ì»¬ëŸ¼ ë¶„ì„ ì™„ë£Œ</li>
            <li>ë§¤ìš° ê°•í•œ ìƒê´€ê´€ê³„ (|r|â‰¥0.8): <strong>{len(classified['very_strong'])}ê°œ</strong></li>
            <li>ì ì ˆí•œ ë²”ìœ„ (0.4~0.8): <strong>{len(classified['strong']) + len(classified['moderate'])}ê°œ</strong> â†’ Feature í›„ë³´!</li>
            <li>ë°ì´í„° ëˆ„ìˆ˜ ìœ„í—˜ (|r|â‰¥0.95): <strong>{len(leakage)}ê°œ</strong> â†’ ì œì™¸ í•„ìˆ˜!</li>
        </ul>
        
        <h3>2ï¸âƒ£ ì œì™¸í•´ì•¼ í•  ì»¬ëŸ¼ (ë°ì´í„° ëˆ„ìˆ˜)</h3>
        <ul>
"""
    if exclude_features:
        for col in exclude_features:
            html += f"<li><span class='tag red'>âŒ {col}</span></li>\n"
    else:
        html += "<li>ì—†ìŒ</li>\n"
    
    html += """
        </ul>
        
        <h3>3ï¸âƒ£ ì¶”ì²œ Feature (0.4 ~ 0.8 ë²”ìœ„)</h3>
        <ul>
"""
    for col in best_features[:8]:
        corr = df_corr[df_corr['ì»¬ëŸ¼'] == col]['Pearson'].values
        if len(corr) > 0:
            html += f"<li><span class='tag green'>âœ… {col}</span> (r={corr[0]:.3f})</li>\n"
    
    html += """
        </ul>
        
        <h3>4ï¸âƒ£ ìƒê´€ê³„ìˆ˜ í•´ì„ ìš”ì•½</h3>
        <p style="font-size: 1.1em; line-height: 1.8;">
            â€¢ <strong>0.4 ~ 0.8</strong> ë²”ìœ„ê°€ ì˜ˆì¸¡ ëª¨ë¸ì— ê°€ì¥ ì í•©<br>
            â€¢ ë„ˆë¬´ ë‚®ìœ¼ë©´ (0.2 ì´í•˜) â†’ ì˜ˆì¸¡ì— ë„ì›€ ì•ˆë¨<br>
            â€¢ ë„ˆë¬´ ë†’ìœ¼ë©´ (0.95 ì´ìƒ) â†’ ë°ì´í„° ëˆ„ìˆ˜, ê°€ì§œ ì„±ëŠ¥<br>
            â€¢ íŒŒìƒë³€ìˆ˜ (ì˜ˆ: queue_gap = CREATED - COMPLETED)ë„ ê³ ë ¤í•˜ì„¸ìš”!
        </p>
    </div>
"""
    
    # ì „ì²´ ì»¬ëŸ¼ í…Œì´ë¸”
    html += """
    <h2>ğŸ“‹ ì „ì²´ ì»¬ëŸ¼ ìƒê´€ê´€ê³„ (Pearson ì ˆëŒ€ê°’ ìˆœ)</h2>
    <table>
        <tr><th>#</th><th>ì»¬ëŸ¼ëª…</th><th>Pearson</th><th>Spearman</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Œ</th><th>ìµœëŒ€</th></tr>
"""
    for idx, (_, row) in enumerate(df_corr.iterrows(), 1):
        cls = 'high' if row['Pearson_abs'] >= 0.8 else 'medium' if row['Pearson_abs'] >= 0.6 else 'low'
        html += f"<tr><td>{idx}</td><td>{row['ì»¬ëŸ¼']}</td><td class='{cls}'>{row['Pearson']:.4f}</td><td>{row['Spearman']:.4f}</td><td>{row['í‰ê· ']:.2f}</td><td>{row['í‘œì¤€í¸ì°¨']:.2f}</td><td>{row['ìµœì†Œ']:.2f}</td><td>{row['ìµœëŒ€']:.2f}</td></tr>\n"
    
    html += """
    </table>
</div>
</body>
</html>
"""
    
    with open(f'{output_dir}/correlation_report_korean.html', 'w', encoding='utf-8') as f:
        f.write(html)
    print(f"  âœ… correlation_report_korean.html")

# ========================================
# ë©”ì¸ ì‹¤í–‰
# ========================================
def main(csv_file):
    output_dir = 'correlation_analysis'
    os.makedirs(output_dir, exist_ok=True)
    
    # 1. ë°ì´í„° ë¡œë“œ
    df = load_data(csv_file)
    if df is None: return
    
    # 2. ê¸°ë³¸ ì •ë³´
    numeric_cols, _ = basic_info(df)
    
    # 3. ê²°ì¸¡ì¹˜ ë¶„ì„
    df_missing = missing_analysis(df, numeric_cols)
    
    # 4. ìƒê´€ê´€ê³„ ë¶„ì„
    df_corr = correlation_analysis(df, numeric_cols)
    if df_corr is None: return
    
    # 5. ë“±ê¸‰ ë¶„ë¥˜
    classified = classify_correlation(df_corr)
    
    # 6. ì‹œê°í™”
    visualize_correlations(df_corr, output_dir)
    
    # 7. ì‚°ì ë„
    plot_scatter(df, df_corr, output_dir=output_dir)
    
    # 8. CSV ì €ì¥
    df_corr.to_csv(f'{output_dir}/correlation_all.csv', index=False, encoding='utf-8-sig')
    df_missing.to_csv(f'{output_dir}/missing_analysis.csv', index=False, encoding='utf-8-sig')
    print(f"\nğŸ’¾ CSV ì €ì¥ ì™„ë£Œ")
    
    # 9. HTML ë¦¬í¬íŠ¸
    generate_html_report(df_corr, classified, output_dir)
    
    print("\n" + "="*80)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print("="*80)
    print(f"\nğŸ“ ê²°ê³¼ í´ë”: {output_dir}/")
    print(f"   - correlation_report_korean.html (ë©”ì¸ ë¦¬í¬íŠ¸)")
    print(f"   - correlation_all.csv (ì „ì²´ ìƒê´€ê´€ê³„)")
    print(f"   - correlation_top30.png")
    print(f"   - correlation_distribution.png")
    print(f"   - pearson_vs_spearman.png")
    print(f"   - scatter_top12.png")

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) > 1:
        csv_file = sys.argv[1]
    else:
        # ê¸°ë³¸ íŒŒì¼ ì°¾ê¸°
        candidates = ['M14_Q_*.CSV', '*.csv', 'data/*.csv']
        import glob
        csv_file = None
        for pattern in candidates:
            files = glob.glob(pattern)
            if files:
                csv_file = files[0]
                break
        
        if csv_file is None:
            print("âŒ CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
            print("\nì‚¬ìš©ë²•: python column_correlation_korean.py ë°ì´í„°íŒŒì¼.csv")
            exit(1)
    
    main(csv_file)