# -*- coding: utf-8 -*-
"""
================================================================================
V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ ì½”ë“œ (HTML ê²°ê³¼ ì¶œë ¥)
ì¶”ê°€ëœ ì»¬ëŸ¼: AHTO+AHSO, REWORK, AHSO

[ì»¬ëŸ¼ ì„¤ëª…]
- AHTO+AHSO: Q-Time ìœ„ë°˜ ì•ŒëŒ í•©ê³„ (ëŠ¦ìŒ+ë¹ ë¦„)
- REWORK: Q-Time ìœ„ë°˜ í›„ ì¬ì‘ì—… ì²˜ë¶„ëœ Lot ìˆ˜
- AHSO: Q-Time í•˜í•œ ë¯¸ë‹¬ ì•ŒëŒ (ë„ˆë¬´ ë¹¨ë¦¬ ì´ë™)
================================================================================
"""

import os
import warnings
import glob
import numpy as np
import pandas as pd
from datetime import datetime

warnings.filterwarnings('ignore')

# ============================================================================
# ì„¤ì •
# ============================================================================
CONFIG = {
    'limit_value': 1700,
    'target_column': 'TOTALCNT',
}

NEW_COLUMNS = ['AHTO+AHSO', 'REWORK', 'AHSO']

print("=" * 70)
print("ğŸ” V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ (Q-Time Interlock ì•ŒëŒ)")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
def load_csv(filepath):
    encodings = ['utf-8', 'utf-8-sig', 'cp949', 'euc-kr']
    for enc in encodings:
        try:
            return pd.read_csv(filepath, encoding=enc, on_bad_lines='skip')
        except:
            continue
    raise ValueError(f"íŒŒì¼ ì¸ì½”ë”© ì˜¤ë¥˜: {filepath}")

def load_data(path_input):
    print(f"\n[1/6] ë°ì´í„° ë¡œë“œ ì¤‘...")
    if '*' in path_input:
        files = sorted(glob.glob(path_input))
    elif os.path.exists(path_input):
        files = [path_input]
    else:
        raise ValueError(f"íŒŒì¼ ì—†ìŒ: {path_input}")
    
    dfs = []
    for f in files:
        df = load_csv(f)
        print(f"  - {os.path.basename(f)}: {len(df):,}í–‰")
        dfs.append(df)
    
    result = pd.concat(dfs, ignore_index=True)
    print(f"  â†’ ì´: {len(result):,}í–‰")
    return result

# ============================================================================
# ë¶„ì„ í•¨ìˆ˜ë“¤
# ============================================================================
def analyze_new_columns(df):
    print("\n[2/6] ê¸°ë³¸ í†µê³„...")
    results = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            non_zero = data[data > 0]
            results[col] = {
                'mean': data.mean(),
                'std': data.std(),
                'min': data.min(),
                'max': data.max(),
                'median': data.median(),
                'zero_pct': (data == 0).sum() / len(data) * 100,
                'nonzero_mean': non_zero.mean() if len(non_zero) > 0 else 0,
                'nonzero_count': len(non_zero),
                'total_count': len(data),
            }
    return results

def analyze_correlation(df):
    print("[3/6] ìƒê´€ê´€ê³„...")
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    correlations = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            correlations[col] = target.corr(data)
    return correlations

def analyze_danger_zone(df):
    print("[4/6] ìœ„í—˜êµ¬ê°„...")
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    danger = target >= CONFIG['limit_value']
    safe = target < CONFIG['limit_value']
    
    analysis = {'danger_count': danger.sum(), 'safe_count': safe.sum()}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            d_mean = data[danger].mean() if danger.sum() > 0 else 0
            s_mean = data[safe].mean() if safe.sum() > 0 else 0
            diff_pct = ((d_mean - s_mean) / s_mean * 100) if s_mean != 0 else 0
            analysis[col] = {'danger_mean': d_mean, 'safe_mean': s_mean, 'diff_pct': diff_pct}
    return analysis

def analyze_lead_indicator(df, look_ahead=10):
    print("[5/6] ì„ í–‰ì§€í‘œ...")
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    future_danger = (target.shift(-look_ahead) >= CONFIG['limit_value']).astype(int)
    
    lead = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            valid = ~(data.isna() | future_danger.isna())
            if valid.sum() > 100:
                corr = data[valid].corr(future_danger[valid])
                # ì„ê³„ê°’ë³„ ìœ„í—˜í™•ë¥ 
                thresh_analysis = []
                for pct in [50, 75, 90]:
                    thresh = data.quantile(pct/100)
                    mask = (data >= thresh) & valid
                    if mask.sum() > 0:
                        rate = future_danger[mask].mean() * 100
                        thresh_analysis.append({'pct': pct, 'thresh': thresh, 'danger_rate': rate})
                lead[col] = {'corr': corr, 'thresholds': thresh_analysis}
    return lead

def analyze_time_pattern(df):
    print("[6/6] ì‹œê°„ëŒ€ë³„ íŒ¨í„´...")
    if 'CURRTIME' not in df.columns:
        return None
    
    df['HOUR'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce').dt.hour
    
    patterns = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            hourly = df.groupby('HOUR')[col].agg(['mean', 'sum']).reset_index()
            patterns[col] = hourly.to_dict('records')
    return patterns

# ============================================================================
# HTML ìƒì„±
# ============================================================================
def generate_html(df, stats, correlations, danger, lead, time_patterns, output_path):
    print("\nğŸ“Š HTML ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
    
    total_rows = len(df)
    danger_count = danger.get('danger_count', 0)
    danger_pct = danger_count / total_rows * 100 if total_rows > 0 else 0
    
    # ê¶Œì¥ì‚¬í•­ ê³„ì‚°
    recommendations = []
    for col in NEW_COLUMNS:
        if col in correlations:
            corr = correlations[col]
            diff = danger.get(col, {}).get('diff_pct', 0)
            score = abs(corr) * 50 + abs(diff) * 0.5
            if score >= 15:
                level = 'important'
            elif score >= 5:
                level = 'auxiliary'
            else:
                level = 'low'
            recommendations.append({'col': col, 'corr': corr, 'diff': diff, 'score': score, 'level': level})
    
    html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ ê²°ê³¼</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {{ margin: 0; padding: 0; box-sizing: border-box; }}
body {{ font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0a0a1a, #1a1a3e); min-height: 100vh; padding: 30px; color: #fff; }}
.container {{ max-width: 1400px; margin: 0 auto; }}
h1 {{ text-align: center; color: #00d4ff; font-size: 2rem; margin-bottom: 10px; }}
.subtitle {{ text-align: center; color: #888; margin-bottom: 30px; }}
.grid {{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }}
.card {{ background: rgba(255,255,255,0.05); border-radius: 16px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }}
.card h3 {{ color: #00d4ff; margin-bottom: 15px; font-size: 1.1rem; }}
.stat-row {{ display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }}
.stat-label {{ color: #888; }}
.stat-value {{ font-weight: bold; }}
.stat-value.green {{ color: #00ff88; }}
.stat-value.red {{ color: #ff4466; }}
.stat-value.yellow {{ color: #ffcc00; }}
.stat-value.cyan {{ color: #00d4ff; }}
.section {{ background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }}
.section h2 {{ color: #00d4ff; margin-bottom: 20px; }}
.chart-container {{ height: 300px; margin: 20px 0; }}
table {{ width: 100%; border-collapse: collapse; }}
th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }}
th {{ background: rgba(0,212,255,0.1); color: #00d4ff; }}
.badge {{ display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; }}
.badge-green {{ background: rgba(0,255,136,0.2); color: #00ff88; }}
.badge-yellow {{ background: rgba(255,204,0,0.2); color: #ffcc00; }}
.badge-gray {{ background: rgba(136,136,136,0.2); color: #888; }}
.recommendation {{ padding: 15px; margin: 10px 0; border-radius: 10px; }}
.rec-important {{ background: rgba(0,255,136,0.1); border-left: 4px solid #00ff88; }}
.rec-auxiliary {{ background: rgba(0,212,255,0.1); border-left: 4px solid #00d4ff; }}
.rec-low {{ background: rgba(136,136,136,0.1); border-left: 4px solid #888; }}
code {{ background: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-family: monospace; }}
.code-block {{ background: #0d1117; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre; overflow-x: auto; margin-top: 15px; }}
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ” V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ ê²°ê³¼</h1>
    <p class="subtitle">Q-Time Interlock ì•ŒëŒ ë³€ìˆ˜ (AHTO+AHSO, REWORK, AHSO)</p>
    
    <!-- ìš”ì•½ í†µê³„ -->
    <div class="grid">
        <div class="card">
            <h3>ğŸ“Š ë°ì´í„° ê°œìš”</h3>
            <div class="stat-row"><span class="stat-label">ì´ ë°ì´í„°</span><span class="stat-value cyan">{total_rows:,}í–‰</span></div>
            <div class="stat-row"><span class="stat-label">ìœ„í—˜êµ¬ê°„(1700+)</span><span class="stat-value red">{danger_count:,}ê°œ ({danger_pct:.2f}%)</span></div>
            <div class="stat-row"><span class="stat-label">ì•ˆì „êµ¬ê°„</span><span class="stat-value green">{danger.get('safe_count', 0):,}ê°œ</span></div>
        </div>
'''
    
    # ê° ì»¬ëŸ¼ë³„ í†µê³„ ì¹´ë“œ
    for col in NEW_COLUMNS:
        if col in stats:
            s = stats[col]
            corr = correlations.get(col, 0)
            corr_class = 'green' if abs(corr) >= 0.2 else 'yellow' if abs(corr) >= 0.1 else 'red'
            html += f'''
        <div class="card">
            <h3>ğŸ“ˆ {col}</h3>
            <div class="stat-row"><span class="stat-label">í‰ê· </span><span class="stat-value">{s['mean']:.3f}</span></div>
            <div class="stat-row"><span class="stat-label">ë²”ìœ„</span><span class="stat-value">{s['min']:.0f} ~ {s['max']:.0f}</span></div>
            <div class="stat-row"><span class="stat-label">0ê°’ ë¹„ìœ¨</span><span class="stat-value">{s['zero_pct']:.1f}%</span></div>
            <div class="stat-row"><span class="stat-label">ì–‘ìˆ˜ì¼ë•Œ í‰ê· </span><span class="stat-value yellow">{s['nonzero_mean']:.2f}</span></div>
            <div class="stat-row"><span class="stat-label">TOTALCNT ìƒê´€</span><span class="stat-value {corr_class}">{corr:.4f}</span></div>
        </div>
'''
    
    html += '''
    </div>
    
    <!-- ìœ„í—˜êµ¬ê°„ ë¶„ì„ -->
    <div class="section">
        <h2>âš ï¸ ìœ„í—˜êµ¬ê°„(1700+) vs ì•ˆì „êµ¬ê°„ ë¹„êµ</h2>
        <table>
            <tr><th>ì»¬ëŸ¼</th><th>ìœ„í—˜êµ¬ê°„ í‰ê· </th><th>ì•ˆì „êµ¬ê°„ í‰ê· </th><th>ì°¨ì´</th><th>íŒì •</th></tr>
'''
    
    for col in NEW_COLUMNS:
        if col in danger and isinstance(danger[col], dict):
            d = danger[col]
            diff = d.get('diff_pct', 0)
            if abs(diff) >= 30:
                badge = '<span class="badge badge-green">ğŸ”¥ ìœ ì˜ë¯¸</span>'
            elif abs(diff) >= 10:
                badge = '<span class="badge badge-yellow">âš¡ ì£¼ëª©</span>'
            else:
                badge = '<span class="badge badge-gray">ğŸ’¤ ë¯¸ë¯¸</span>'
            html += f'''
            <tr>
                <td><strong>{col}</strong></td>
                <td>{d.get('danger_mean', 0):.3f}</td>
                <td>{d.get('safe_mean', 0):.3f}</td>
                <td style="color: {'#00ff88' if diff > 0 else '#ff4466'}">{diff:+.1f}%</td>
                <td>{badge}</td>
            </tr>
'''
    
    html += '''
        </table>
    </div>
    
    <!-- ì„ í–‰ì§€í‘œ ë¶„ì„ -->
    <div class="section">
        <h2>ğŸ¯ ì„ í–‰ ì§€í‘œ ë¶„ì„ (10ë¶„ í›„ 1700+ ì˜ˆì¸¡ë ¥)</h2>
        <table>
            <tr><th>ì»¬ëŸ¼</th><th>10ë¶„í›„ ìœ„í—˜ ìƒê´€</th><th>ìƒìœ„ 10% ì„ê³„ê°’</th><th>í•´ë‹¹ì‹œ ìœ„í—˜í™•ë¥ </th></tr>
'''
    
    for col in NEW_COLUMNS:
        if col in lead:
            l = lead[col]
            corr = l.get('corr', 0)
            thresh_90 = next((t for t in l.get('thresholds', []) if t['pct'] == 90), None)
            if thresh_90:
                html += f'''
            <tr>
                <td><strong>{col}</strong></td>
                <td style="color: {'#00ff88' if abs(corr) >= 0.1 else '#888'}">{corr:.4f}</td>
                <td>{thresh_90['thresh']:.1f}</td>
                <td style="color: #ffcc00">{thresh_90['danger_rate']:.2f}%</td>
            </tr>
'''
    
    html += '''
        </table>
    </div>
    
    <!-- ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ì°¨íŠ¸ -->
    <div class="section">
        <h2>ğŸ• ì‹œê°„ëŒ€ë³„ ì•ŒëŒ íŒ¨í„´</h2>
        <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
    </div>
    
    <!-- ê¶Œì¥ì‚¬í•­ -->
    <div class="section">
        <h2>ğŸ“‹ V10_4 ëª¨ë¸ í†µí•© ê¶Œì¥ì‚¬í•­</h2>
'''
    
    for rec in sorted(recommendations, key=lambda x: -x['score']):
        level_class = f"rec-{rec['level']}"
        level_icon = 'âœ…' if rec['level'] == 'important' else 'âš¡' if rec['level'] == 'auxiliary' else 'ğŸ’¤'
        level_text = 'ê°•ë ¥ ì¶”ì²œ (important ê·¸ë£¹)' if rec['level'] == 'important' else 'ë³´ì¡° ë³€ìˆ˜ (auxiliary ê·¸ë£¹)' if rec['level'] == 'auxiliary' else 'ë‚®ì€ ìš°ì„ ìˆœìœ„'
        html += f'''
        <div class="recommendation {level_class}">
            <strong>{level_icon} {rec['col']}</strong>: {level_text}<br>
            <small>ìƒê´€ê³„ìˆ˜: {rec['corr']:.4f} | ìœ„í—˜êµ¬ê°„ ì°¨ì´: {rec['diff']:+.1f}% | ì ìˆ˜: {rec['score']:.1f}</small>
        </div>
'''
    
    # FEATURE_GROUPS ì½”ë“œ ìƒì„±
    important_cols = [r['col'] for r in recommendations if r['level'] == 'important']
    auxiliary_cols = [r['col'] for r in recommendations if r['level'] in ['auxiliary', 'low']]
    
    code_block = "# V10_4 FEATURE_GROUPS ì¶”ê°€ ì½”ë“œ\n\n"
    if important_cols:
        code_block += "# important ê·¸ë£¹ì— ì¶”ê°€:\n"
        for c in important_cols:
            code_block += f"    '{c}',\n"
    if auxiliary_cols:
        code_block += "\n# auxiliary ë˜ëŠ” pdt_new ê·¸ë£¹ì— ì¶”ê°€:\n"
        for c in auxiliary_cols:
            code_block += f"    '{c}',\n"
    
    html += f'''
        <div class="code-block">{code_block}</div>
    </div>
</div>

<script>
'''
    
    # ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸ ë°ì´í„°
    if time_patterns:
        for col in NEW_COLUMNS:
            if col in time_patterns:
                hours = [p['HOUR'] for p in time_patterns[col]]
                sums = [p['sum'] for p in time_patterns[col]]
                break
        else:
            hours = list(range(24))
            sums = [0] * 24
    else:
        hours = list(range(24))
        sums = [0] * 24
    
    html += f'''
const ctx = document.getElementById('hourlyChart').getContext('2d');
new Chart(ctx, {{
    type: 'bar',
    data: {{
        labels: {hours},
        datasets: [{{
            label: 'Q-Time ì•ŒëŒ í•©ê³„',
            data: {sums},
            backgroundColor: 'rgba(0, 212, 255, 0.6)',
            borderColor: '#00d4ff',
            borderWidth: 1
        }}]
    }},
    options: {{
        responsive: true,
        maintainAspectRatio: false,
        plugins: {{
            legend: {{ labels: {{ color: '#fff' }} }}
        }},
        scales: {{
            x: {{ 
                ticks: {{ color: '#888' }},
                grid: {{ color: 'rgba(255,255,255,0.1)' }},
                title: {{ display: true, text: 'ì‹œê°„ (Hour)', color: '#888' }}
            }},
            y: {{ 
                ticks: {{ color: '#888' }},
                grid: {{ color: 'rgba(255,255,255,0.1)' }},
                title: {{ display: true, text: 'ì•ŒëŒ ê±´ìˆ˜', color: '#888' }}
            }}
        }}
    }}
}});
</script>
</body>
</html>
'''
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(html)
    
    print(f"âœ… ì €ì¥ ì™„ë£Œ: {output_path}")
    return output_path

# ============================================================================
# ë©”ì¸
# ============================================================================
def main():
    print("\n" + "=" * 70)
    csv_path = input("ğŸ“‚ CSV íŒŒì¼ ê²½ë¡œ ì…ë ¥: ").strip()
    
    if not csv_path:
        print("âŒ íŒŒì¼ ê²½ë¡œ í•„ìš”")
        return None
    
    try:
        df = load_data(csv_path)
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")
        return None
    
    # ì»¬ëŸ¼ í™•ì¸
    found = [c for c in NEW_COLUMNS if c in df.columns]
    print(f"\n[ì»¬ëŸ¼ í™•ì¸] {len(found)}/{len(NEW_COLUMNS)}ê°œ ë°œê²¬: {found}")
    
    if not found:
        print("âŒ ë¶„ì„í•  ì»¬ëŸ¼ ì—†ìŒ")
        return None
    
    # ë¶„ì„
    stats = analyze_new_columns(df)
    correlations = analyze_correlation(df)
    danger = analyze_danger_zone(df)
    lead = analyze_lead_indicator(df)
    time_patterns = analyze_time_pattern(df)
    
    # HTML ìƒì„±
    output_path = f"V10_4_ì‹ ê·œì»¬ëŸ¼_ë¶„ì„ê²°ê³¼_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
    generate_html(df, stats, correlations, danger, lead, time_patterns, output_path)
    
    print("\n" + "=" * 70)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print("=" * 70)
    
    return output_path

if __name__ == "__main__":
    main()