# -*- coding: utf-8 -*-
"""
================================================================================
V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ ì½”ë“œ
ì¶”ê°€ëœ ì»¬ëŸ¼: AHTO+AHSO, REWORK, AHSO

[ì»¬ëŸ¼ ì„¤ëª…]
- AHTO+AHSO: Q-Time ìœ„ë°˜ ì•ŒëŒ í•©ê³„ (ëŠ¦ìŒ+ë¹ ë¦„)
- REWORK: Q-Time ìœ„ë°˜ í›„ ì¬ì‘ì—… ì²˜ë¶„ëœ Lot ìˆ˜
- AHSO: Q-Time í•˜í•œ ë¯¸ë‹¬ ì•ŒëŒ (ë„ˆë¬´ ë¹¨ë¦¬ ì´ë™)
================================================================================
"""

import os
import sys
import warnings
import glob
import numpy as np
import pandas as pd
from datetime import datetime

warnings.filterwarnings('ignore')

# ============================================================================
# ì„¤ì •
# ============================================================================
CONFIG = {
    'limit_value': 1700,
    'target_column': 'TOTALCNT',
}

# ì‹ ê·œ ì¶”ê°€ ì»¬ëŸ¼ (Q-Time Interlock ê´€ë ¨)
NEW_COLUMNS = ['AHTO+AHSO', 'REWORK', 'AHSO']

print("=" * 70)
print("ğŸ” V10_4 ì‹ ê·œ ì»¬ëŸ¼ ë¶„ì„ (Q-Time Interlock ì•ŒëŒ)")
print("   AHTO+AHSO: ëŒ€ê¸°ì‹œê°„ ìœ„ë°˜ ì•ŒëŒ í•©ê³„")
print("   REWORK: ì¬ì‘ì—… ì²˜ë¶„ Lot")
print("   AHSO: ëŒ€ê¸°ì‹œê°„ ë¯¸ë‹¬ (ë¹ ë¦„) ì•ŒëŒ")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
def load_csv(filepath):
    """CSV íŒŒì¼ ë¡œë“œ (ì—¬ëŸ¬ ì¸ì½”ë”© ì‹œë„)"""
    encodings = ['utf-8', 'utf-8-sig', 'cp949', 'euc-kr']
    for enc in encodings:
        try:
            df = pd.read_csv(filepath, encoding=enc, on_bad_lines='skip')
            return df
        except (UnicodeDecodeError, LookupError):
            continue
    raise ValueError(f"íŒŒì¼ ì¸ì½”ë”©ì„ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filepath}")


def load_data(path_input):
    """ë‹¨ì¼ íŒŒì¼ ë˜ëŠ” íŒ¨í„´ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ"""
    print(f"\n[1/6] ë°ì´í„° ë¡œë“œ ì¤‘...")
    
    # íŒ¨í„´ì´ë©´ glob, ì•„ë‹ˆë©´ ë‹¨ì¼ íŒŒì¼
    if '*' in path_input:
        files = sorted(glob.glob(path_input))
    elif os.path.exists(path_input):
        files = [path_input]
    else:
        raise ValueError(f"íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {path_input}")
    
    if not files:
        raise ValueError(f"ë§¤ì¹­ë˜ëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {path_input}")
    
    dfs = []
    for f in files:
        df = load_csv(f)
        print(f"  - {os.path.basename(f)}: {len(df):,}í–‰")
        dfs.append(df)
    
    result = pd.concat(dfs, ignore_index=True)
    print(f"  â†’ ì´ ë°ì´í„°: {len(result):,}í–‰, {len(result.columns)}ì»¬ëŸ¼")
    return result


def analyze_new_columns(df):
    """ì‹ ê·œ ì»¬ëŸ¼ ê¸°ë³¸ í†µê³„ ë¶„ì„"""
    print("\n[2/6] ì‹ ê·œ ì»¬ëŸ¼ ê¸°ë³¸ í†µê³„...")
    print("-" * 60)
    
    results = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            non_zero = data[data > 0]
            
            stats = {
                'ì»¬ëŸ¼ëª…': col,
                'ì¡´ì¬': 'âœ…',
                'ê°œìˆ˜': len(data.dropna()),
                'í‰ê· ': data.mean(),
                'í‘œì¤€í¸ì°¨': data.std(),
                'ìµœì†Œ': data.min(),
                '25%': data.quantile(0.25),
                'ì¤‘ì•™ê°’': data.median(),
                '75%': data.quantile(0.75),
                'ìµœëŒ€': data.max(),
                '0ê°’ë¹„ìœ¨': (data == 0).sum() / len(data) * 100,
                'ì–‘ìˆ˜í‰ê· ': non_zero.mean() if len(non_zero) > 0 else 0,
                'ì–‘ìˆ˜ê°œìˆ˜': len(non_zero),
            }
            results[col] = stats
            
            print(f"\nğŸ“Š {col}")
            print(f"   í‰ê· : {stats['í‰ê· ']:.3f} | í‘œì¤€í¸ì°¨: {stats['í‘œì¤€í¸ì°¨']:.3f}")
            print(f"   ë²”ìœ„: {stats['ìµœì†Œ']:.0f} ~ {stats['ìµœëŒ€']:.0f}")
            print(f"   0ê°’ ë¹„ìœ¨: {stats['0ê°’ë¹„ìœ¨']:.1f}% ({len(data) - stats['ì–‘ìˆ˜ê°œìˆ˜']:,}ê°œ)")
            print(f"   ì–‘ìˆ˜ì¼ë•Œ í‰ê· : {stats['ì–‘ìˆ˜í‰ê· ']:.2f} ({stats['ì–‘ìˆ˜ê°œìˆ˜']:,}ê°œ)")
        else:
            print(f"\nâš ï¸ {col}: ì»¬ëŸ¼ ì—†ìŒ")
            results[col] = {'ì»¬ëŸ¼ëª…': col, 'ì¡´ì¬': 'âŒ'}
    
    return results


def analyze_correlation_with_target(df):
    """TOTALCNTì™€ì˜ ìƒê´€ê´€ê³„ ë¶„ì„"""
    print("\n[3/6] TOTALCNTì™€ì˜ ìƒê´€ê´€ê³„ ë¶„ì„...")
    print("-" * 60)
    
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    
    correlations = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            corr = target.corr(data)
            correlations[col] = corr
            
            # ìƒê´€ê´€ê³„ í•´ì„
            if abs(corr) >= 0.4:
                strength = "ğŸ”¥ ê°•í•¨"
            elif abs(corr) >= 0.2:
                strength = "âš¡ ë³´í†µ"
            else:
                strength = "ğŸ’¤ ì•½í•¨"
            
            print(f"  {col}: {corr:.4f} {strength}")
    
    return correlations


def analyze_danger_zone(df):
    """1700+ ìœ„í—˜ êµ¬ê°„ì—ì„œì˜ ì‹ ê·œ ì»¬ëŸ¼ íŠ¹ì„±"""
    print("\n[4/6] ìœ„í—˜ êµ¬ê°„(1700+) ë¶„ì„...")
    print("-" * 60)
    
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    danger_mask = target >= CONFIG['limit_value']
    safe_mask = target < CONFIG['limit_value']
    
    danger_count = danger_mask.sum()
    safe_count = safe_mask.sum()
    
    print(f"  ì „ì²´: {len(df):,}ê°œ")
    print(f"  ìœ„í—˜(1700+): {danger_count:,}ê°œ ({100*danger_count/len(df):.2f}%)")
    print(f"  ì•ˆì „(<1700): {safe_count:,}ê°œ")
    
    analysis = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            
            danger_mean = data[danger_mask].mean()
            safe_mean = data[safe_mask].mean()
            diff = danger_mean - safe_mean
            diff_pct = (diff / safe_mean * 100) if safe_mean != 0 else 0
            
            analysis[col] = {
                'ìœ„í—˜í‰ê· ': danger_mean,
                'ì•ˆì „í‰ê· ': safe_mean,
                'ì°¨ì´': diff,
                'ì°¨ì´%': diff_pct,
            }
            
            # ì°¨ì´ í•´ì„
            if abs(diff_pct) >= 30:
                indicator = "ğŸ”¥ ìœ ì˜ë¯¸í•œ ì°¨ì´!"
            elif abs(diff_pct) >= 10:
                indicator = "âš¡ ì£¼ëª©í•  ë§Œí•œ ì°¨ì´"
            else:
                indicator = "ğŸ’¤ ì°¨ì´ ì ìŒ"
            
            print(f"\n  ğŸ“Š {col}")
            print(f"     ìœ„í—˜ êµ¬ê°„ í‰ê· : {danger_mean:.2f}")
            print(f"     ì•ˆì „ êµ¬ê°„ í‰ê· : {safe_mean:.2f}")
            print(f"     ì°¨ì´: {diff:+.2f} ({diff_pct:+.1f}%) {indicator}")
    
    return analysis


def analyze_lead_indicator(df, look_ahead=10):
    """ì„ í–‰ ì§€í‘œ ë¶„ì„ (10ë¶„ í›„ 1700+ ì˜ˆì¸¡ë ¥)"""
    print(f"\n[5/6] ì„ í–‰ ì§€í‘œ ë¶„ì„ ({look_ahead}ë¶„ í›„ ì˜ˆì¸¡ë ¥)...")
    print("-" * 60)
    
    target = pd.to_numeric(df[CONFIG['target_column']], errors='coerce')
    
    # look_aheadë¶„ í›„ ìœ„í—˜ ì—¬ë¶€
    future_danger = (target.shift(-look_ahead) >= CONFIG['limit_value']).astype(int)
    
    lead_analysis = {}
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            
            # í˜„ì¬ ê°’ê³¼ ë¯¸ë˜ ìœ„í—˜ì˜ ìƒê´€ê´€ê³„
            valid_mask = ~(data.isna() | future_danger.isna())
            if valid_mask.sum() > 100:
                corr = data[valid_mask].corr(future_danger[valid_mask])
                
                # ì„ê³„ê°’ ë¶„ì„
                thresholds = [
                    data.quantile(0.5),
                    data.quantile(0.75),
                    data.quantile(0.9),
                ]
                
                lead_analysis[col] = {
                    'ì„ í–‰ìƒê´€': corr,
                    'ì„ê³„ê°’ë¶„ì„': []
                }
                
                print(f"\n  ğŸ“Š {col}")
                print(f"     {look_ahead}ë¶„ í›„ ìœ„í—˜ê³¼ì˜ ìƒê´€: {corr:.4f}")
                
                for thresh in thresholds:
                    high_mask = (data >= thresh) & valid_mask
                    if high_mask.sum() > 0:
                        danger_rate = future_danger[high_mask].mean() * 100
                        print(f"     {col} >= {thresh:.1f}ì¼ ë•Œ ìœ„í—˜ í™•ë¥ : {danger_rate:.2f}%")
    
    return lead_analysis


def generate_report(df, stats, correlations, danger_analysis, lead_analysis):
    """ë¶„ì„ ë³´ê³ ì„œ ìƒì„±"""
    print("\n[6/6] ë¶„ì„ ìš”ì•½ ë³´ê³ ì„œ...")
    print("=" * 70)
    print("ğŸ“‹ V10_4 ëª¨ë¸ í†µí•© ê¶Œì¥ì‚¬í•­")
    print("=" * 70)
    
    recommendations = []
    
    for col in NEW_COLUMNS:
        if col in correlations:
            corr = correlations[col]
            danger_diff = danger_analysis.get(col, {}).get('ì°¨ì´%', 0)
            
            score = abs(corr) * 50 + abs(danger_diff) * 0.5
            
            if score >= 15:
                rec = f"âœ… {col}: ê°•ë ¥ ì¶”ì²œ (ìƒê´€={corr:.3f}, ìœ„í—˜êµ¬ê°„ì°¨ì´={danger_diff:+.1f}%)"
                recommendations.append((col, 'important', score))
            elif score >= 5:
                rec = f"âš¡ {col}: ë³´ì¡° ë³€ìˆ˜ë¡œ ì¶”ì²œ (ìƒê´€={corr:.3f}, ìœ„í—˜êµ¬ê°„ì°¨ì´={danger_diff:+.1f}%)"
                recommendations.append((col, 'auxiliary', score))
            else:
                rec = f"ğŸ’¤ {col}: ë‚®ì€ ìš°ì„ ìˆœìœ„ (ìƒê´€={corr:.3f}, ìœ„í—˜êµ¬ê°„ì°¨ì´={danger_diff:+.1f}%)"
                recommendations.append((col, 'low', score))
            
            print(f"  {rec}")
    
    # FEATURE_GROUPS ì¶”ê°€ ì½”ë“œ ì¶œë ¥
    print("\n" + "-" * 60)
    print("ğŸ“ V10_4 FEATURE_GROUPS ì¶”ê°€ ì½”ë“œ:")
    print("-" * 60)
    
    important_cols = [r[0] for r in recommendations if r[1] == 'important']
    auxiliary_cols = [r[0] for r in recommendations if r[1] in ['auxiliary', 'low']]
    
    if important_cols:
        print(f"\n# important ê·¸ë£¹ì— ì¶”ê°€:")
        for col in important_cols:
            print(f"    '{col}',")
    
    if auxiliary_cols:
        print(f"\n# auxiliary ë˜ëŠ” pdt_new ê·¸ë£¹ì— ì¶”ê°€:")
        for col in auxiliary_cols:
            print(f"    '{col}',")
    
    return recommendations


def analyze_time_pattern(df):
    """ì‹œê°„ëŒ€ë³„ ì•ŒëŒ íŒ¨í„´ ë¶„ì„"""
    print("\n[ì¶”ê°€] ì‹œê°„ëŒ€ë³„ Q-Time ì•ŒëŒ íŒ¨í„´...")
    print("-" * 60)
    
    if 'CURRTIME' not in df.columns:
        print("  âš ï¸ CURRTIME ì»¬ëŸ¼ ì—†ìŒ")
        return None
    
    # ì‹œê°„ íŒŒì‹±
    df['CURRTIME_DT'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df['HOUR'] = df['CURRTIME_DT'].dt.hour
    
    for col in NEW_COLUMNS:
        if col in df.columns:
            data = pd.to_numeric(df[col], errors='coerce')
            hourly = df.groupby('HOUR')[col].agg(['mean', 'sum', 'max'])
            
            # ì•ŒëŒì´ ë§ì€ ì‹œê°„ëŒ€ ì°¾ê¸°
            top_hours = hourly['sum'].nlargest(3)
            if top_hours.sum() > 0:
                print(f"\n  ğŸ“Š {col} - ì•ŒëŒ ë§ì€ ì‹œê°„ëŒ€:")
                for hour, val in top_hours.items():
                    print(f"     {hour:02d}ì‹œ: ì´ {val:.0f}ê±´")
    
    return df


def main():
    # CSV íŒŒì¼ ê²½ë¡œ ì…ë ¥
    print("\n" + "=" * 70)
    csv_path = input("ğŸ“‚ CSV íŒŒì¼ ê²½ë¡œ ì…ë ¥ (ì˜ˆ: M14_í•™ìŠµ.CSV ë˜ëŠ” *.CSV): ").strip()
    
    if not csv_path:
        print("âŒ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
        return None
    
    # ë°ì´í„° ë¡œë“œ
    try:
        df = load_data(csv_path)
    except ValueError as e:
        print(f"\nâŒ ì˜¤ë¥˜: {e}")
        return None
    
    # ì‹ ê·œ ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
    print("\n[ì»¬ëŸ¼ í™•ì¸]")
    found_cols = []
    for col in NEW_COLUMNS:
        if col in df.columns:
            print(f"  âœ… {col} ì¡´ì¬")
            found_cols.append(col)
        else:
            print(f"  âŒ {col} ì—†ìŒ")
    
    if not found_cols:
        print("\nâš ï¸ ë¶„ì„í•  ì‹ ê·œ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤!")
        return None
    
    # ë¶„ì„ ì‹¤í–‰
    stats = analyze_new_columns(df)
    correlations = analyze_correlation_with_target(df)
    danger_analysis = analyze_danger_zone(df)
    lead_analysis = analyze_lead_indicator(df, look_ahead=10)
    
    # ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ë¶„ì„
    df = analyze_time_pattern(df)
    
    # ë³´ê³ ì„œ ìƒì„±
    recommendations = generate_report(df, stats, correlations, danger_analysis, lead_analysis)
    
    print("\n" + "=" * 70)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print("=" * 70)
    
    return {
        'df': df,
        'stats': stats,
        'correlations': correlations,
        'danger_analysis': danger_analysis,
        'lead_analysis': lead_analysis,
        'recommendations': recommendations
    }


if __name__ == "__main__":
    results = main()