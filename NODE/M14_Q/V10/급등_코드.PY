# -*- coding: utf-8 -*-
"""
================================================================================
ğŸš€ "ê°‘ìê¸° íŠ€ëŠ”" ë°ì´í„° ì¶”ì¶œê¸°
- ê° ë²”ìœ„(3000, 2500, 2200, 2000, 1700ëŒ€)ë¡œ ì²˜ìŒ ì§„ì…í•˜ëŠ” ìˆœê°„ 30ê°œì”©
- ì›ë³¸ ë°ì´í„° í˜•ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€
- ë²”ìœ„ë³„ ë³„ë„ CSV ì €ì¥
================================================================================
"""

import pandas as pd
import numpy as np
from datetime import datetime
import os

# ============================================================================
# ì„¤ì •
# ============================================================================
CONFIG = {
    'input_file': 'M14_í‰ê°€.CSV',  # ë°ì´í„° íŒŒì¼
    'target_column': 'TOTALCNT',
    
    # ë²”ìœ„ ì„¤ì •: í•´ë‹¹ ê°’ ì´ìƒìœ¼ë¡œ "íŠ€ì–´ì˜¤ë¥´ëŠ”" ìˆœê°„ ì¶”ì¶œ
    'thresholds': [3000, 2500, 2200, 2000, 1700],
    'samples_per_range': 30,
}

print("=" * 70)
print("ğŸš€ 'ê°‘ìê¸° íŠ€ëŠ”' ë°ì´í„° ì¶”ì¶œê¸°")
print("   ê° ë²”ìœ„ë¡œ ì§„ì…í•˜ëŠ” ìˆœê°„ ì¶”ì¶œ â†’ ì›ë³¸ í˜•ì‹ ê·¸ëŒ€ë¡œ ì €ì¥")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
print(f"\n[1/3] ë°ì´í„° ë¡œë“œ ì¤‘... ({CONFIG['input_file']})")

encodings = ['utf-8', 'cp949', 'euc-kr']
df = None
for enc in encodings:
    try:
        df = pd.read_csv(CONFIG['input_file'], encoding=enc, on_bad_lines='skip')
        print(f"  âœ… ì¸ì½”ë”©: {enc}")
        break
    except:
        continue

if df is None:
    raise ValueError("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")

print(f"  â†’ ì´ ë°ì´í„°: {len(df):,}í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")

# ì›ë³¸ ì»¬ëŸ¼ ì €ì¥
original_columns = df.columns.tolist()

# ì‹œê°„ ì •ë ¬ (CURRTIME ìˆìœ¼ë©´)
if 'CURRTIME' in df.columns:
    df['_CURRTIME_DT'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df = df.dropna(subset=['_CURRTIME_DT']).sort_values('_CURRTIME_DT').reset_index(drop=True)

# ìˆ«ì ë³€í™˜
df[CONFIG['target_column']] = pd.to_numeric(df[CONFIG['target_column']], errors='coerce').fillna(0)

# ì´ì „ ê°’ ê³„ì‚° (ì¶”ì¶œìš©, ì €ì¥ ì•ˆí•¨)
df['_ì´ì „ê°’'] = df[CONFIG['target_column']].shift(1)
df['_ë³€í™”ëŸ‰'] = df[CONFIG['target_column']] - df['_ì´ì „ê°’']

# ============================================================================
# ë²”ìœ„ë³„ "ê°‘ìê¸° íŠ€ëŠ”" êµ¬ê°„ ì¶”ì¶œ
# ============================================================================
print("\n[2/3] ë²”ìœ„ë³„ ê¸‰ìƒìŠ¹ ì§„ì… êµ¬ê°„ ì¶”ì¶œ ì¤‘...")

output_files = []

for threshold in CONFIG['thresholds']:
    range_name = f"{threshold}ëŒ€"
    output_file = f"ê¸‰ìƒìŠ¹_{threshold}ëŒ€_30ê°œ.csv"
    
    print(f"\n  ğŸ” {range_name} ì¶”ì¶œ ì¤‘...")
    
    # "ê°‘ìê¸° íŠ€ëŠ”" ì¡°ê±´:
    # - í˜„ì¬ê°’ >= threshold
    # - ì´ì „ê°’ < threshold (ì²˜ìŒ ì§„ì…)
    mask = (df[CONFIG['target_column']] >= threshold) & (df['_ì´ì „ê°’'] < threshold)
    
    jump_df = df[mask].copy()
    
    if len(jump_df) == 0:
        print(f"     âš ï¸ {range_name}: ì§„ì… êµ¬ê°„ ì—†ìŒ")
        continue
    
    print(f"     â†’ ì „ì²´ ì§„ì… êµ¬ê°„: {len(jump_df)}ê°œ")
    
    # ë³€í™”ëŸ‰ì´ í° ìˆœìœ¼ë¡œ ì •ë ¬ (ë” "í™•" íŠ€ëŠ” ìˆœ)
    jump_df = jump_df.sort_values('_ë³€í™”ëŸ‰', ascending=False)
    
    # ìƒìœ„ Nê°œ ì¶”ì¶œ (ì¤‘ë³µ ì‹œê°„ëŒ€ ì œê±°)
    selected_indices = []
    used_times = set()
    
    for idx, row in jump_df.iterrows():
        if len(selected_indices) >= CONFIG['samples_per_range']:
            break
        
        # 30ë¶„ ì´ë‚´ ì¤‘ë³µ ì œê±°
        is_duplicate = False
        if '_CURRTIME_DT' in row and pd.notna(row['_CURRTIME_DT']):
            current_time = row['_CURRTIME_DT']
            for ut in used_times:
                if abs((current_time - ut).total_seconds()) < 1800:  # 30ë¶„
                    is_duplicate = True
                    break
            
            if not is_duplicate:
                selected_indices.append(idx)
                used_times.add(current_time)
        else:
            selected_indices.append(idx)
    
    print(f"     âœ… ì¶”ì¶œ: {len(selected_indices)}ê°œ")
    
    if len(selected_indices) == 0:
        continue
    
    # ì›ë³¸ ì»¬ëŸ¼ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥
    result_df = df.loc[selected_indices, original_columns].copy()
    
    # ì‹œê°„ìˆœ ì •ë ¬
    if 'CURRTIME' in result_df.columns:
        result_df = result_df.sort_values('CURRTIME')
    
    # CSV ì €ì¥
    result_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    output_files.append((range_name, output_file, len(result_df)))
    print(f"     ğŸ’¾ ì €ì¥: {output_file}")

# ============================================================================
# ê²°ê³¼ ìš”ì•½
# ============================================================================
print("\n" + "=" * 70)
print("ğŸ“Š ì¶”ì¶œ ê²°ê³¼ ìš”ì•½")
print("=" * 70)

print(f"\n{'ë²”ìœ„':<12} {'íŒŒì¼ëª…':<30} {'ê°œìˆ˜':>6}")
print("-" * 50)

total_count = 0
for range_name, filename, count in output_files:
    print(f"{range_name:<12} {filename:<30} {count:>6}ê°œ")
    total_count += count

print("-" * 50)
print(f"{'ì´ê³„':<12} {'':<30} {total_count:>6}ê°œ")

print(f"\nâœ… ì™„ë£Œ! {len(output_files)}ê°œ íŒŒì¼ ìƒì„±")
print("=" * 70)