# -*- coding: utf-8 -*-
"""
================================================================================
ðŸš€ ê¸‰ìƒìŠ¹ êµ¬ê°„ ë°ì´í„° ì¶”ì¶œê¸°
- 3000ëŒ€, 2500ëŒ€, 2200ëŒ€, 2000ëŒ€, 1700ëŒ€ ê°ê° 1ê°œ ì´ë²¤íŠ¸ ì„ íƒ
- í•´ë‹¹ ì´ë²¤íŠ¸ ì „í›„ 30ê°œ ë°ì´í„° ì¶”ì¶œ â†’ ë²”ìœ„ë³„ CSV ì €ìž¥
================================================================================
"""

import pandas as pd
import numpy as np
from datetime import datetime
import os

# ============================================================================
# ì„¤ì •
# ============================================================================
CONFIG = {
    'input_file': 'M14_í‰ê°€.CSV',
    'target_column': 'TOTALCNT',
    'thresholds': [3000, 2500, 2200, 2000, 1700],
    'data_range': 30,  # ì „í›„ 30ê°œ ë°ì´í„° (ì´ 30ê°œ)
}

print("=" * 70)
print("ðŸš€ ê¸‰ìƒìŠ¹ êµ¬ê°„ ë°ì´í„° ì¶”ì¶œê¸°")
print("   ê° ë²”ìœ„ë³„ 1ê°œ ì´ë²¤íŠ¸ â†’ ì „í›„ 30ê°œ ë°ì´í„° CSV ì €ìž¥")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
print(f"\n[1/3] ë°ì´í„° ë¡œë“œ ì¤‘...")

encodings = ['utf-8', 'cp949', 'euc-kr']
df = None
for enc in encodings:
    try:
        df = pd.read_csv(CONFIG['input_file'], encoding=enc, on_bad_lines='skip')
        break
    except:
        continue

if df is None:
    raise ValueError("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")

print(f"  â†’ ì´ ë°ì´í„°: {len(df):,}í–‰")

# ì‹œê°„ íŒŒì‹±
if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df = df.dropna(subset=['CURRTIME']).sort_values('CURRTIME').reset_index(drop=True)

df[CONFIG['target_column']] = pd.to_numeric(df[CONFIG['target_column']], errors='coerce').fillna(0)
df['ì´ì „ê°’'] = df[CONFIG['target_column']].shift(1)
df['ë³€í™”ëŸ‰'] = df[CONFIG['target_column']] - df['ì´ì „ê°’']

# ============================================================================
# ë²”ìœ„ë³„ ì¶”ì¶œ
# ============================================================================
print("\n[2/3] ë²”ìœ„ë³„ ê¸‰ìƒìŠ¹ ì´ë²¤íŠ¸ íƒìƒ‰...")

for threshold in CONFIG['thresholds']:
    range_name = f"{threshold}ëŒ€"
    print(f"\n  ðŸ” {range_name} ì²˜ë¦¬ ì¤‘...")
    
    # í•´ë‹¹ ë²”ìœ„ë¡œ ì²˜ìŒ ì§„ìž…í•˜ëŠ” ìˆœê°„ ì°¾ê¸°
    if threshold == 3000:
        mask = (df[CONFIG['target_column']] >= 3000)
    elif threshold == 2500:
        mask = (df[CONFIG['target_column']] >= 2500) & (df[CONFIG['target_column']] < 3000)
    elif threshold == 2200:
        mask = (df[CONFIG['target_column']] >= 2200) & (df[CONFIG['target_column']] < 2500)
    elif threshold == 2000:
        mask = (df[CONFIG['target_column']] >= 2000) & (df[CONFIG['target_column']] < 2200)
    else:  # 1700
        mask = (df[CONFIG['target_column']] >= 1700) & (df[CONFIG['target_column']] < 2000)
    
    # ì´ì „ê°’ì´ í•´ë‹¹ ë²”ìœ„ ë¯¸ë§Œì¸ ê²½ìš° (ì§„ìž… ìˆœê°„)
    entry_mask = mask & (df['ì´ì „ê°’'] < threshold)
    candidates = df[entry_mask]
    
    if len(candidates) == 0:
        print(f"     âš ï¸ ì§„ìž… ì´ë²¤íŠ¸ ì—†ìŒ, ìµœëŒ€ê°’ êµ¬ê°„ìœ¼ë¡œ ëŒ€ì²´")
        # ëŒ€ì•ˆ: í•´ë‹¹ ë²”ìœ„ ë‚´ ìµœëŒ€ê°’ ì‹œì 
        range_df = df[mask]
        if len(range_df) == 0:
            print(f"     âŒ {range_name} ë°ì´í„° ì—†ìŒ")
            continue
        peak_idx = range_df[CONFIG['target_column']].idxmax()
    else:
        # ë³€í™”ëŸ‰ì´ ê°€ìž¥ í° ì§„ìž… ì´ë²¤íŠ¸ ì„ íƒ
        peak_idx = candidates['ë³€í™”ëŸ‰'].idxmax()
    
    peak_value = df.loc[peak_idx, CONFIG['target_column']]
    peak_time = df.loc[peak_idx, 'CURRTIME'] if 'CURRTIME' in df.columns else ''
    
    print(f"     â†’ ì„ íƒëœ ì´ë²¤íŠ¸: {peak_time} | TOTALCNT: {peak_value:.0f}")
    
    # ì „í›„ 30ê°œ ë°ì´í„° ì¶”ì¶œ (15ê°œ ì „ ~ 14ê°œ í›„ = 30ê°œ)
    start_idx = max(0, peak_idx - 15)
    end_idx = min(len(df), peak_idx + 15)
    
    # ì •í™•ížˆ 30ê°œ ë§žì¶”ê¸°
    if end_idx - start_idx < CONFIG['data_range']:
        if start_idx == 0:
            end_idx = min(len(df), CONFIG['data_range'])
        else:
            start_idx = max(0, end_idx - CONFIG['data_range'])
    
    range_data = df.iloc[start_idx:end_idx].copy()
    
    # í”¼í¬ ì§€ì  í‘œì‹œ
    range_data['í”¼í¬ì—¬ë¶€'] = ''
    range_data.loc[peak_idx, 'í”¼í¬ì—¬ë¶€'] = 'â˜…'
    
    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
    output_cols = ['CURRTIME', CONFIG['target_column'], 'ì´ì „ê°’', 'ë³€í™”ëŸ‰', 'í”¼í¬ì—¬ë¶€']
    
    # ì¶”ê°€ ì»¬ëŸ¼ (ìžˆìœ¼ë©´)
    extra_cols = ['M14AM14B', 'M14AM14BSUM', 'M14BM14A', 'M14AM10ASUM',
                  'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED',
                  'M14.QUE.OHT.OHTUTIL', 'M14.QUE.ALL.TRANSPORT4MINOVERCNT']
    
    for col in extra_cols:
        if col in df.columns:
            output_cols.append(col)
    
    # ì¡´ìž¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ í•„í„°
    output_cols = [c for c in output_cols if c in range_data.columns]
    output_df = range_data[output_cols].copy()
    
    # ì‹œê°„ í¬ë§·
    if 'CURRTIME' in output_df.columns:
        output_df['CURRTIME'] = output_df['CURRTIME'].dt.strftime('%Y-%m-%d %H:%M')
    
    # CSV ì €ìž¥
    filename = f"ê¸‰ìƒìŠ¹_{threshold}ëŒ€_30ê°œ.csv"
    output_df.to_csv(filename, index=False, encoding='utf-8-sig')
    print(f"     âœ… ì €ìž¥: {filename} ({len(output_df)}ê°œ ë°ì´í„°)")

# ============================================================================
# ì™„ë£Œ
# ============================================================================
print("\n" + "=" * 70)
print("âœ… ì™„ë£Œ! ìƒì„±ëœ íŒŒì¼:")
for threshold in CONFIG['thresholds']:
    print(f"   â†’ ê¸‰ìƒìŠ¹_{threshold}ëŒ€_30ê°œ.csv")
print("=" * 70)