# -*- coding: utf-8 -*-
"""
================================================================================
ğŸš€ "í™• íŠ€ëŠ”" ë°ì´í„° ì¶”ì¶œê¸°
- ë²”ìœ„ë³„ (3000, 2500, 2200, 2000, 1700ëŒ€) ê¸‰ìƒìŠ¹ êµ¬ê°„ 30ê°œì”© ì¶”ì¶œ
================================================================================
"""

import pandas as pd
import numpy as np
from datetime import datetime
import os

# ============================================================================
# ì„¤ì •
# ============================================================================
CONFIG = {
    'input_file': 'M14_í‰ê°€.CSV',  # ë˜ëŠ” ë‹¤ë¥¸ ë°ì´í„° íŒŒì¼
    'output_file': f'ê¸‰ìƒìŠ¹_ë°ì´í„°_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv',
    'target_column': 'TOTALCNT',
    
    # ë²”ìœ„ ì„¤ì • (ê° ë²”ìœ„ì—ì„œ 30ê°œì”©)
    'ranges': [
        {'name': '3000ëŒ€', 'min': 3000, 'max': 3999},
        {'name': '2500ëŒ€', 'min': 2500, 'max': 2999},
        {'name': '2200ëŒ€', 'min': 2200, 'max': 2499},
        {'name': '2000ëŒ€', 'min': 2000, 'max': 2199},
        {'name': '1700ëŒ€', 'min': 1700, 'max': 1999},
    ],
    'samples_per_range': 30,
    
    # "í™• íŠ€ëŠ”" ê¸°ì¤€ (ì´ì „ ëŒ€ë¹„ ì¦ê°€ëŸ‰)
    'min_jump': 50,  # ìµœì†Œ 50 ì´ìƒ ìƒìŠ¹
}

print("=" * 70)
print("ğŸš€ 'í™• íŠ€ëŠ”' ë°ì´í„° ì¶”ì¶œê¸°")
print("   ë²”ìœ„ë³„ ê¸‰ìƒìŠ¹ êµ¬ê°„ ì¶”ì¶œ")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
print(f"\n[1/4] ë°ì´í„° ë¡œë“œ ì¤‘... ({CONFIG['input_file']})")

encodings = ['utf-8', 'cp949', 'euc-kr']
df = None
for enc in encodings:
    try:
        df = pd.read_csv(CONFIG['input_file'], encoding=enc, on_bad_lines='skip')
        print(f"  âœ… ì¸ì½”ë”©: {enc}")
        break
    except:
        continue

if df is None:
    raise ValueError("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")

print(f"  â†’ ì´ ë°ì´í„°: {len(df):,}í–‰")

# ì‹œê°„ íŒŒì‹±
if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df = df.dropna(subset=['CURRTIME']).sort_values('CURRTIME').reset_index(drop=True)

# ìˆ«ì ë³€í™˜
df[CONFIG['target_column']] = pd.to_numeric(df[CONFIG['target_column']], errors='coerce').fillna(0)

# ============================================================================
# "í™• íŠ€ëŠ”" êµ¬ê°„ ê³„ì‚°
# ============================================================================
print("\n[2/4] ê¸‰ìƒìŠ¹ êµ¬ê°„ ê³„ì‚° ì¤‘...")

# ì´ì „ ëŒ€ë¹„ ë³€í™”ëŸ‰
df['ë³€í™”ëŸ‰_1ë¶„'] = df[CONFIG['target_column']].diff(1)
df['ë³€í™”ëŸ‰_5ë¶„'] = df[CONFIG['target_column']].diff(5)
df['ë³€í™”ëŸ‰_10ë¶„'] = df[CONFIG['target_column']].diff(10)

# 5ë¶„ ì „ ê°’
df['5ë¶„ì „ê°’'] = df[CONFIG['target_column']].shift(5)
df['10ë¶„ì „ê°’'] = df[CONFIG['target_column']].shift(10)

# ê¸‰ìƒìŠ¹ ì ìˆ˜ (ë³€í™”ëŸ‰ í•©ì‚°)
df['ê¸‰ìƒìŠ¹ì ìˆ˜'] = (
    df['ë³€í™”ëŸ‰_1ë¶„'].fillna(0).clip(lower=0) * 3 +  # ìµœê·¼ 1ë¶„ ê°€ì¤‘ì¹˜
    df['ë³€í™”ëŸ‰_5ë¶„'].fillna(0).clip(lower=0) * 2 +  # 5ë¶„ ê°€ì¤‘ì¹˜
    df['ë³€í™”ëŸ‰_10ë¶„'].fillna(0).clip(lower=0) * 1    # 10ë¶„ ê°€ì¤‘ì¹˜
)

print(f"  â†’ ê¸‰ìƒìŠ¹ì ìˆ˜ ìµœëŒ€: {df['ê¸‰ìƒìŠ¹ì ìˆ˜'].max():.1f}")

# ============================================================================
# ë²”ìœ„ë³„ ì¶”ì¶œ
# ============================================================================
print("\n[3/4] ë²”ìœ„ë³„ ë°ì´í„° ì¶”ì¶œ ì¤‘...")

results = []

for r in CONFIG['ranges']:
    range_name = r['name']
    min_val = r['min']
    max_val = r['max']
    
    # í•´ë‹¹ ë²”ìœ„ í•„í„°ë§
    mask = (df[CONFIG['target_column']] >= min_val) & (df[CONFIG['target_column']] <= max_val)
    range_df = df[mask].copy()
    
    if len(range_df) == 0:
        print(f"  âš ï¸ {range_name}: ë°ì´í„° ì—†ìŒ")
        continue
    
    # ê¸‰ìƒìŠ¹ì ìˆ˜ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    range_df = range_df.sort_values('ê¸‰ìƒìŠ¹ì ìˆ˜', ascending=False)
    
    # ìƒìœ„ Nê°œ ì¶”ì¶œ (ì¤‘ë³µ ì‹œê°„ëŒ€ ì œê±°ë¥¼ ìœ„í•´ ì—¬ìœ ìˆê²Œ ì¶”ì¶œ í›„ í•„í„°ë§)
    selected = []
    used_times = set()
    
    for idx, row in range_df.iterrows():
        if len(selected) >= CONFIG['samples_per_range']:
            break
        
        # 10ë¶„ ì´ë‚´ ì¤‘ë³µ ì œê±°
        current_time = row['CURRTIME'] if 'CURRTIME' in row else idx
        
        # ì‹œê°„ ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ (ë¹„ìŠ·í•œ ì‹œê°„ëŒ€ ì œì™¸)
        is_duplicate = False
        if isinstance(current_time, pd.Timestamp):
            for ut in used_times:
                if abs((current_time - ut).total_seconds()) < 600:  # 10ë¶„
                    is_duplicate = True
                    break
        
        if not is_duplicate:
            selected.append(row)
            if isinstance(current_time, pd.Timestamp):
                used_times.add(current_time)
    
    print(f"  âœ… {range_name}: {len(selected)}ê°œ ì¶”ì¶œ (ì „ì²´ {len(range_df):,}ê°œ ì¤‘)")
    
    # ê²°ê³¼ì— ë²”ìœ„ ì •ë³´ ì¶”ê°€
    for row in selected:
        result_row = {
            'ë²”ìœ„': range_name,
            'ì‹œê°„': row['CURRTIME'].strftime('%Y-%m-%d %H:%M') if 'CURRTIME' in row and pd.notna(row['CURRTIME']) else '',
            'TOTALCNT': round(row[CONFIG['target_column']], 1),
            '5ë¶„ì „ê°’': round(row['5ë¶„ì „ê°’'], 1) if pd.notna(row['5ë¶„ì „ê°’']) else '',
            '10ë¶„ì „ê°’': round(row['10ë¶„ì „ê°’'], 1) if pd.notna(row['10ë¶„ì „ê°’']) else '',
            '5ë¶„ë³€í™”': round(row['ë³€í™”ëŸ‰_5ë¶„'], 1) if pd.notna(row['ë³€í™”ëŸ‰_5ë¶„']) else '',
            '10ë¶„ë³€í™”': round(row['ë³€í™”ëŸ‰_10ë¶„'], 1) if pd.notna(row['ë³€í™”ëŸ‰_10ë¶„']) else '',
            'ê¸‰ìƒìŠ¹ì ìˆ˜': round(row['ê¸‰ìƒìŠ¹ì ìˆ˜'], 1),
        }
        
        # ì£¼ìš” ì»¬ëŸ¼ ì¶”ê°€ (ìˆìœ¼ë©´)
        for col in ['M14AM14B', 'M14AM14BSUM', 'QUEUE_GAP', 
                    'M14.QUE.ALL.CURRENTQCREATED', 'M14.QUE.ALL.CURRENTQCOMPLETED',
                    'M14.QUE.OHT.OHTUTIL', 'M14.QUE.ALL.TRANSPORT4MINOVERCNT']:
            if col in row:
                result_row[col] = round(row[col], 1) if pd.notna(row[col]) else ''
        
        results.append(result_row)

# ============================================================================
# ê²°ê³¼ ì €ì¥
# ============================================================================
print("\n[4/4] ê²°ê³¼ ì €ì¥...")

df_result = pd.DataFrame(results)

# ë²”ìœ„ë³„ ì •ë ¬
range_order = {r['name']: i for i, r in enumerate(CONFIG['ranges'])}
df_result['ë²”ìœ„ìˆœì„œ'] = df_result['ë²”ìœ„'].map(range_order)
df_result = df_result.sort_values(['ë²”ìœ„ìˆœì„œ', 'ê¸‰ìƒìŠ¹ì ìˆ˜'], ascending=[True, False])
df_result = df_result.drop(columns=['ë²”ìœ„ìˆœì„œ'])

df_result.to_csv(CONFIG['output_file'], index=False, encoding='utf-8-sig')
print(f"  â†’ ì €ì¥: {CONFIG['output_file']}")

# ============================================================================
# ìš”ì•½ ì¶œë ¥
# ============================================================================
print("\n" + "=" * 70)
print("ğŸ“Š ì¶”ì¶œ ê²°ê³¼ ìš”ì•½")
print("=" * 70)

summary = df_result.groupby('ë²”ìœ„').agg({
    'TOTALCNT': ['count', 'min', 'max', 'mean'],
    'ê¸‰ìƒìŠ¹ì ìˆ˜': ['min', 'max', 'mean']
}).round(1)

print(f"\n{'ë²”ìœ„':<10} {'ê°œìˆ˜':>6} {'ìµœì†Œê°’':>8} {'ìµœëŒ€ê°’':>8} {'í‰ê· ':>8} {'ê¸‰ìƒìŠ¹ì ìˆ˜':>10}")
print("-" * 60)

for range_name in [r['name'] for r in CONFIG['ranges']]:
    range_data = df_result[df_result['ë²”ìœ„'] == range_name]
    if len(range_data) > 0:
        cnt = len(range_data)
        min_v = range_data['TOTALCNT'].min()
        max_v = range_data['TOTALCNT'].max()
        avg_v = range_data['TOTALCNT'].mean()
        avg_score = range_data['ê¸‰ìƒìŠ¹ì ìˆ˜'].mean()
        print(f"{range_name:<10} {cnt:>6} {min_v:>8.0f} {max_v:>8.0f} {avg_v:>8.0f} {avg_score:>10.1f}")

print(f"\nì´ ì¶”ì¶œ ë°ì´í„°: {len(df_result)}ê°œ")
print(f"\nâœ… ì™„ë£Œ! â†’ {CONFIG['output_file']}")
print("=" * 70)

# ============================================================================
# ìƒ˜í”Œ ì¶œë ¥
# ============================================================================
print("\nğŸ“‹ ìƒ˜í”Œ ë°ì´í„° (ê° ë²”ìœ„ ìƒìœ„ 3ê°œ):")
print("-" * 70)

for range_name in [r['name'] for r in CONFIG['ranges']]:
    range_data = df_result[df_result['ë²”ìœ„'] == range_name].head(3)
    if len(range_data) > 0:
        print(f"\nğŸ”¥ {range_name}:")
        for _, row in range_data.iterrows():
            print(f"   {row['ì‹œê°„']} | TOTALCNT: {row['TOTALCNT']:.0f} | "
                  f"5ë¶„ë³€í™”: +{row['5ë¶„ë³€í™”']:.0f} | ê¸‰ìƒìŠ¹ì ìˆ˜: {row['ê¸‰ìƒìŠ¹ì ìˆ˜']:.0f}")