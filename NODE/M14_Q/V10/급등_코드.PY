# -*- coding: utf-8 -*-
"""
================================================================================
ğŸš€ ê¸‰ìƒìŠ¹ êµ¬ê°„ ì›ë³¸ ë°ì´í„° ì¶”ì¶œê¸°
- ê° ë²”ìœ„ë³„ 1ê°œ ì´ë²¤íŠ¸ ì„ íƒ â†’ ì „í›„ 30ê°œ ì›ë³¸ ë°ì´í„° ê·¸ëŒ€ë¡œ ì €ì¥
================================================================================
"""

import pandas as pd
from datetime import datetime

# ============================================================================
# ì„¤ì •
# ============================================================================
INPUT_FILE = 'M14_í‰ê°€.CSV'
TARGET_COL = 'TOTALCNT'
THRESHOLDS = [3000, 2500, 2200, 2000, 1700]
DATA_COUNT = 30

print("=" * 70)
print("ğŸš€ ê¸‰ìƒìŠ¹ êµ¬ê°„ ì›ë³¸ ë°ì´í„° ì¶”ì¶œê¸°")
print("=" * 70)

# ============================================================================
# ë°ì´í„° ë¡œë“œ
# ============================================================================
print(f"\n[1/2] ë°ì´í„° ë¡œë“œ ì¤‘...")

for enc in ['utf-8', 'cp949', 'euc-kr']:
    try:
        df = pd.read_csv(INPUT_FILE, encoding=enc, on_bad_lines='skip')
        break
    except:
        continue

print(f"  â†’ ì´ {len(df):,}í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")

# ì‹œê°„ìˆœ ì •ë ¬
if 'CURRTIME' in df.columns:
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df = df.dropna(subset=['CURRTIME']).sort_values('CURRTIME').reset_index(drop=True)

df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce').fillna(0)

# ============================================================================
# ë²”ìœ„ë³„ ì¶”ì¶œ
# ============================================================================
print(f"\n[2/2] ë²”ìœ„ë³„ ì¶”ì¶œ ì¤‘...")

for threshold in THRESHOLDS:
    print(f"\n  ğŸ” {threshold}ëŒ€...")
    
    # í•´ë‹¹ ë²”ìœ„ ì§„ì… ì‹œì  ì°¾ê¸°
    prev_val = df[TARGET_COL].shift(1)
    
    if threshold == 3000:
        mask = (df[TARGET_COL] >= 3000) & (prev_val < 3000)
    elif threshold == 2500:
        mask = (df[TARGET_COL] >= 2500) & (prev_val < 2500)
    elif threshold == 2200:
        mask = (df[TARGET_COL] >= 2200) & (prev_val < 2200)
    elif threshold == 2000:
        mask = (df[TARGET_COL] >= 2000) & (prev_val < 2000)
    else:
        mask = (df[TARGET_COL] >= 1700) & (prev_val < 1700)
    
    candidates = df[mask]
    
    if len(candidates) == 0:
        # ëŒ€ì•ˆ: í•´ë‹¹ ë²”ìœ„ ìµœëŒ€ê°’
        if threshold == 3000:
            range_mask = df[TARGET_COL] >= 3000
        elif threshold == 2500:
            range_mask = (df[TARGET_COL] >= 2500) & (df[TARGET_COL] < 3000)
        elif threshold == 2200:
            range_mask = (df[TARGET_COL] >= 2200) & (df[TARGET_COL] < 2500)
        elif threshold == 2000:
            range_mask = (df[TARGET_COL] >= 2000) & (df[TARGET_COL] < 2200)
        else:
            range_mask = (df[TARGET_COL] >= 1700) & (df[TARGET_COL] < 2000)
        
        range_df = df[range_mask]
        if len(range_df) == 0:
            print(f"     âŒ ë°ì´í„° ì—†ìŒ")
            continue
        peak_idx = range_df[TARGET_COL].idxmax()
    else:
        # ë³€í™”ëŸ‰ ê°€ì¥ í° ì´ë²¤íŠ¸
        changes = df.loc[candidates.index, TARGET_COL] - prev_val.loc[candidates.index]
        peak_idx = changes.idxmax()
    
    peak_val = df.loc[peak_idx, TARGET_COL]
    print(f"     â†’ ì´ë²¤íŠ¸: idx={peak_idx}, TOTALCNT={peak_val:.0f}")
    
    # ì „í›„ 30ê°œ (15ê°œ ì „ ~ 14ê°œ í›„)
    start = max(0, peak_idx - 15)
    end = start + DATA_COUNT
    if end > len(df):
        end = len(df)
        start = max(0, end - DATA_COUNT)
    
    # ì›ë³¸ ë°ì´í„° ê·¸ëŒ€ë¡œ ì¶”ì¶œ
    output_df = df.iloc[start:end].copy()
    
    # ì €ì¥
    filename = f"ê¸‰ìƒìŠ¹_{threshold}ëŒ€_30ê°œ.csv"
    output_df.to_csv(filename, index=False, encoding='utf-8-sig')
    print(f"     âœ… ì €ì¥: {filename} ({len(output_df)}í–‰ x {len(output_df.columns)}ì»¬ëŸ¼)")

print("\n" + "=" * 70)
print("âœ… ì™„ë£Œ!")
print("=" * 70)