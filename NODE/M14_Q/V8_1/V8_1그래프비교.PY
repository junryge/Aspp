# -*- coding: utf-8 -*-
"""
280ë¶„ â†’ 10ë¶„/15ë¶„/25ë¶„ í›„ ì˜ˆì¸¡ ê²°ê³¼ ë¹„êµ ê·¸ë˜í”„
"""

import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import os

plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

def load_evaluation_results():
    """í‰ê°€ ê²°ê³¼ CSV ë¡œë“œ"""
    results = {}
    
    files = {
        '10min': 'evaluation_280to10_1year.csv',
        '15min': 'evaluation_280to15_1year.csv',
        '25min': 'evaluation_280to25_1year.csv'
    }
    
    print("="*80)
    print("ğŸ“Š í‰ê°€ ê²°ê³¼ íŒŒì¼ ë¡œë”©")
    print("="*80)
    
    for key, filename in files.items():
        if os.path.exists(filename):
            df = pd.read_csv(filename)
            results[key] = df
            print(f"âœ… {key} ë¡œë“œ: {len(df):,}ê°œ í–‰")
        else:
            print(f"âš ï¸ {filename} íŒŒì¼ ì—†ìŒ")
    
    if len(results) == 0:
        print("\nâŒ í‰ê°€ ê²°ê³¼ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!")
        print("ë¨¼ì € í‰ê°€ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:")
        print("  - python eval_280to10_1YEAR.py")
        print("  - python eval_280to15_1YEAR.py")
        print("  - python eval_280to25_1YEAR.py")
        return None
    
    return results

def create_comparison_graphs(results):
    """ë¹„êµ ê·¸ë˜í”„ 6ê°œ ìƒì„±"""
    
    fig = plt.figure(figsize=(20, 14))
    
    colors = {
        '10min': '#2E86AB',  # íŒŒë‘
        '15min': '#A23B72',  # ë³´ë¼
        '25min': '#F18F01'   # ì£¼í™©
    }
    
    labels_kr = {
        '10min': '10ë¶„ í›„ ì˜ˆì¸¡',
        '15min': '15ë¶„ í›„ ì˜ˆì¸¡',
        '25min': '25ë¶„ í›„ ì˜ˆì¸¡'
    }
    
    # ===== 1. MAE ë¶„í¬ íˆìŠ¤í† ê·¸ë¨ =====
    ax1 = plt.subplot(3, 3, 1)
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key]
            ax1.hist(df['ì ˆëŒ€ì˜¤ì°¨'], bins=50, alpha=0.6, 
                   label=f"{labels_kr[key]}\n(MAE: {df['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f})",
                   color=colors[key], edgecolor='black', linewidth=0.5)
    
    ax1.set_xlabel('Absolute Error', fontsize=11, fontweight='bold')
    ax1.set_ylabel('Frequency', fontsize=11, fontweight='bold')
    ax1.set_title('1) MAE Distribution', fontsize=12, fontweight='bold', pad=10)
    ax1.legend(loc='upper right', fontsize=9)
    ax1.grid(True, alpha=0.3)
    ax1.set_xlim(0, 200)
    
    # ===== 2. MAE ë°•ìŠ¤í”Œë¡¯ =====
    ax2 = plt.subplot(3, 3, 2)
    mae_data = []
    mae_labels = []
    mae_colors = []
    
    for key in ['10min', '15min', '25min']:
        if key in results:
            mae_data.append(results[key]['ì ˆëŒ€ì˜¤ì°¨'])
            mae_labels.append(labels_kr[key])
            mae_colors.append(colors[key])
    
    bp = ax2.boxplot(mae_data, labels=mae_labels, patch_artist=True, showfliers=False)
    for patch, color in zip(bp['boxes'], mae_colors):
        patch.set_facecolor(color)
        patch.set_alpha(0.7)
    
    ax2.set_ylabel('Absolute Error', fontsize=11, fontweight='bold')
    ax2.set_title('2) MAE Box Plot', fontsize=12, fontweight='bold', pad=10)
    ax2.grid(True, alpha=0.3, axis='y')
    
    # í‰ê· ê°’ í‘œì‹œ
    for i, key in enumerate(['10min', '15min', '25min']):
        if key in results:
            mean_val = results[key]['ì ˆëŒ€ì˜¤ì°¨'].mean()
            ax2.text(i+1, mean_val, f'{mean_val:.1f}', 
                    ha='center', va='bottom', fontweight='bold', fontsize=10)
    
    # ===== 3. í‰ê·  MAE ë§‰ëŒ€ ê·¸ë˜í”„ =====
    ax3 = plt.subplot(3, 3, 3)
    mae_means = []
    bar_labels = []
    bar_colors = []
    
    for key in ['10min', '15min', '25min']:
        if key in results:
            mae_means.append(results[key]['ì ˆëŒ€ì˜¤ì°¨'].mean())
            bar_labels.append(labels_kr[key])
            bar_colors.append(colors[key])
    
    bars = ax3.bar(range(len(mae_means)), mae_means, color=bar_colors, alpha=0.7, edgecolor='black')
    ax3.set_xticks(range(len(bar_labels)))
    ax3.set_xticklabels(bar_labels, fontsize=10)
    ax3.set_ylabel('Average MAE', fontsize=11, fontweight='bold')
    ax3.set_title('3) Average MAE Comparison', fontsize=12, fontweight='bold', pad=10)
    ax3.grid(True, alpha=0.3, axis='y')
    
    # ê°’ í‘œì‹œ
    for bar in bars:
        height = bar.get_height()
        ax3.text(bar.get_x() + bar.get_width()/2., height,
               f'{height:.2f}',
               ha='center', va='bottom', fontweight='bold', fontsize=11)
    
    # ===== 4. ì‹¤ì œê°’ vs ì˜ˆì¸¡ê°’ ì‚°ì ë„ =====
    ax4 = plt.subplot(3, 3, 4)
    
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key].sample(min(3000, len(results[key])), random_state=42)
            ax4.scatter(df['ì‹¤ì œê°’'], df['ì˜ˆì¸¡ê°’'], 
                      alpha=0.4, s=5, 
                      label=labels_kr[key],
                      color=colors[key])
    
    # ì™„ë²½í•œ ì˜ˆì¸¡ì„ 
    min_val = min([results[k]['ì‹¤ì œê°’'].min() for k in results])
    max_val = max([results[k]['ì‹¤ì œê°’'].max() for k in results])
    ax4.plot([min_val, max_val], [min_val, max_val], 
           'r--', linewidth=2, label='Perfect', alpha=0.8)
    
    ax4.set_xlabel('Actual TOTALCNT', fontsize=11, fontweight='bold')
    ax4.set_ylabel('Predicted TOTALCNT', fontsize=11, fontweight='bold')
    ax4.set_title('4) Actual vs Predicted (3K samples)', fontsize=12, fontweight='bold', pad=10)
    ax4.legend(loc='upper left', fontsize=9)
    ax4.grid(True, alpha=0.3)
    
    # ===== 5. ìœ„í—˜ êµ¬ê°„(1700+) ê°ì§€ìœ¨ =====
    ax5 = plt.subplot(3, 3, 5)
    
    detection_data = {}
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key]
            actual_danger = (df['ì‹¤ì œìœ„í—˜(1700+)'] == 'O').sum()
            detected = ((df['ì‹¤ì œìœ„í—˜(1700+)'] == 'O') & (df['ì˜ˆì¸¡ìœ„í—˜(1650+)'] == 'O')).sum()
            
            if actual_danger > 0:
                rate = detected / actual_danger * 100
                detection_data[key] = {
                    'rate': rate,
                    'actual': actual_danger,
                    'detected': detected
                }
    
    if detection_data:
        x_pos = range(len(detection_data))
        rates = [detection_data[k]['rate'] for k in ['10min', '15min', '25min'] if k in detection_data]
        bar_labels = [labels_kr[k] for k in ['10min', '15min', '25min'] if k in detection_data]
        bar_colors = [colors[k] for k in ['10min', '15min', '25min'] if k in detection_data]
        
        bars = ax5.bar(x_pos, rates, color=bar_colors, alpha=0.7, edgecolor='black')
        ax5.set_xticks(x_pos)
        ax5.set_xticklabels(bar_labels, fontsize=10)
        ax5.set_ylabel('Detection Rate (%)', fontsize=11, fontweight='bold')
        ax5.set_title('5) Danger Zone (1700+) Detection', fontsize=12, fontweight='bold', pad=10)
        ax5.grid(True, alpha=0.3, axis='y')
        ax5.set_ylim(0, 100)
        
        # ê°’ í‘œì‹œ
        for bar, key in zip(bars, detection_data.keys()):
            height = bar.get_height()
            det = detection_data[key]['detected']
            act = detection_data[key]['actual']
            ax5.text(bar.get_x() + bar.get_width()/2., height,
                   f'{height:.1f}%\n({det}/{act})',
                   ha='center', va='bottom', fontweight='bold', fontsize=9)
    
    # ===== 6. ì˜¤ì°¨ìœ¨(%) ë¶„í¬ =====
    ax6 = plt.subplot(3, 3, 6)
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key]
            error_rate = df['ì˜¤ì°¨ìœ¨(%)']
            error_rate_filtered = error_rate[error_rate <= 20]  # 20% ì´í•˜ë§Œ
            ax6.hist(error_rate_filtered, bins=50, alpha=0.6, 
                   label=f"{labels_kr[key]}\n(í‰ê· : {error_rate.mean():.2f}%)",
                   color=colors[key], edgecolor='black', linewidth=0.5)
    
    ax6.set_xlabel('Error Rate (%)', fontsize=11, fontweight='bold')
    ax6.set_ylabel('Frequency', fontsize=11, fontweight='bold')
    ax6.set_title('6) Error Rate Distribution (<20%)', fontsize=12, fontweight='bold', pad=10)
    ax6.legend(loc='upper right', fontsize=9)
    ax6.grid(True, alpha=0.3)
    
    # ===== 7. M14AM14B êµ¬ê°„ë³„ MAE =====
    ax7 = plt.subplot(3, 3, 7)
    
    m14b_ranges = [
        ('200-250', 200, 250),
        ('250-300', 250, 300),
        ('300-350', 300, 350),
        ('350-400', 350, 400),
        ('400-450', 400, 450),
        ('450+', 450, 9999)
    ]
    
    width = 0.25
    x = np.arange(len(m14b_ranges))
    
    for idx, key in enumerate(['10min', '15min', '25min']):
        if key in results:
            df = results[key]
            mae_by_range = []
            
            for _, low, high in m14b_ranges:
                mask = (df['M14AM14B'] >= low) & (df['M14AM14B'] < high)
                if mask.sum() > 0:
                    mae_by_range.append(df[mask]['ì ˆëŒ€ì˜¤ì°¨'].mean())
                else:
                    mae_by_range.append(0)
            
            offset = (idx - 1) * width
            ax7.bar(x + offset, mae_by_range, width, 
                   label=labels_kr[key], 
                   color=colors[key], alpha=0.7, edgecolor='black')
    
    ax7.set_xlabel('M14AM14B Range', fontsize=11, fontweight='bold')
    ax7.set_ylabel('Average MAE', fontsize=11, fontweight='bold')
    ax7.set_title('7) MAE by M14AM14B Range', fontsize=12, fontweight='bold', pad=10)
    ax7.set_xticks(x)
    ax7.set_xticklabels([r[0] for r in m14b_ranges], rotation=45, ha='right', fontsize=9)
    ax7.legend(loc='upper left', fontsize=9)
    ax7.grid(True, alpha=0.3, axis='y')
    
    # ===== 8. ì‹œê°„ëŒ€ë³„ ì˜ˆì¸¡ ì¶”ì´ (ìƒ˜í”Œ 200ê°œ) =====
    ax8 = plt.subplot(3, 3, 8)
    
    sample_size = 200
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key].iloc[:sample_size]
            ax8.plot(range(len(df)), df['ì‹¤ì œê°’'], 
                    label=f'{labels_kr[key]} (ì‹¤ì œ)', 
                    color=colors[key], alpha=0.4, linewidth=1)
            ax8.plot(range(len(df)), df['ì˜ˆì¸¡ê°’'], 
                    label=f'{labels_kr[key]} (ì˜ˆì¸¡)', 
                    color=colors[key], alpha=0.8, linewidth=2, linestyle='--')
    
    ax8.set_xlabel('Time Step', fontsize=11, fontweight='bold')
    ax8.set_ylabel('TOTALCNT', fontsize=11, fontweight='bold')
    ax8.set_title('8) Prediction Trend (First 200)', fontsize=12, fontweight='bold', pad=10)
    ax8.legend(loc='upper left', fontsize=8)
    ax8.grid(True, alpha=0.3)
    
    # ===== 9. ì¢…í•© ì„±ëŠ¥ ë¹„êµ í‘œ =====
    ax9 = plt.subplot(3, 3, 9)
    ax9.axis('off')
    
    # í‘œ ë°ì´í„° ìƒì„±
    table_data = []
    table_data.append(['Metric', '10ë¶„', '15ë¶„', '25ë¶„'])
    
    # MAE
    mae_row = ['MAE']
    for key in ['10min', '15min', '25min']:
        if key in results:
            mae_row.append(f"{results[key]['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")
        else:
            mae_row.append('-')
    table_data.append(mae_row)
    
    # ì˜¤ì°¨ìœ¨
    err_row = ['Error Rate (%)']
    for key in ['10min', '15min', '25min']:
        if key in results:
            err_row.append(f"{results[key]['ì˜¤ì°¨ìœ¨(%)'].mean():.2f}%")
        else:
            err_row.append('-')
    table_data.append(err_row)
    
    # ìœ„í—˜ ê°ì§€ìœ¨
    det_row = ['Detection Rate']
    for key in ['10min', '15min', '25min']:
        if key in results and key in detection_data:
            det_row.append(f"{detection_data[key]['rate']:.1f}%")
        else:
            det_row.append('-')
    table_data.append(det_row)
    
    # ìƒ˜í”Œ ìˆ˜
    count_row = ['Sample Count']
    for key in ['10min', '15min', '25min']:
        if key in results:
            count_row.append(f"{len(results[key]):,}")
        else:
            count_row.append('-')
    table_data.append(count_row)
    
    # í‘œ ìƒì„±
    table = ax9.table(cellText=table_data, cellLoc='center', loc='center',
                     colWidths=[0.25, 0.25, 0.25, 0.25])
    table.auto_set_font_size(False)
    table.set_fontsize(10)
    table.scale(1, 2.5)
    
    # í—¤ë” ìŠ¤íƒ€ì¼
    for i in range(4):
        table[(0, i)].set_facecolor('#4CAF50')
        table[(0, i)].set_text_props(weight='bold', color='white')
    
    # ë°ì´í„° í–‰ ìƒ‰ìƒ
    for i in range(1, len(table_data)):
        table[(i, 0)].set_facecolor('#E8F5E9')
        for j in range(1, 4):
            if j == 1:
                table[(i, j)].set_facecolor('#E3F2FD')
            elif j == 2:
                table[(i, j)].set_facecolor('#F3E5F5')
            else:
                table[(i, j)].set_facecolor('#FFF3E0')
    
    ax9.set_title('9) Performance Summary', fontsize=12, fontweight='bold', pad=10)
    
    # ì „ì²´ íƒ€ì´í‹€
    fig.suptitle('280min Sequence Prediction Comparison: 10min vs 15min vs 25min', 
                 fontsize=16, fontweight='bold', y=0.995)
    
    plt.tight_layout(rect=[0, 0, 1, 0.99])
    
    # ì €ì¥
    output_file = 'prediction_comparison_10_15_25min.png'
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"\nâœ… ê·¸ë˜í”„ ì €ì¥: {output_file}")
    
    plt.show()
    
    return fig

def print_summary_statistics(results):
    """í†µê³„ ìš”ì•½ ì¶œë ¥"""
    print("\n" + "="*80)
    print("ğŸ“Š ìµœì¢… ì„±ëŠ¥ ë¹„êµ ìš”ì•½")
    print("="*80)
    
    for key in ['10min', '15min', '25min']:
        if key in results:
            df = results[key]
            print(f"\nã€{key} ì˜ˆì¸¡ã€‘")
            print(f"  ìƒ˜í”Œ ìˆ˜: {len(df):,}ê°œ")
            print(f"  í‰ê·  MAE: {df['ì ˆëŒ€ì˜¤ì°¨'].mean():.2f}")
            print(f"  ì¤‘ì•™ MAE: {df['ì ˆëŒ€ì˜¤ì°¨'].median():.2f}")
            print(f"  ìµœëŒ€ ì˜¤ì°¨: {df['ì ˆëŒ€ì˜¤ì°¨'].max():.2f}")
            print(f"  í‰ê·  ì˜¤ì°¨ìœ¨: {df['ì˜¤ì°¨ìœ¨(%)'].mean():.2f}%")
            
            # ìœ„í—˜ êµ¬ê°„
            actual_danger = (df['ì‹¤ì œìœ„í—˜(1700+)'] == 'O').sum()
            detected = ((df['ì‹¤ì œìœ„í—˜(1700+)'] == 'O') & (df['ì˜ˆì¸¡ìœ„í—˜(1650+)'] == 'O')).sum()
            if actual_danger > 0:
                print(f"  ìœ„í—˜ ê°ì§€ìœ¨: {detected/actual_danger*100:.1f}% ({detected}/{actual_danger})")

if __name__ == '__main__':
    print("\nğŸš€ 10ë¶„/15ë¶„/25ë¶„ ì˜ˆì¸¡ ê²°ê³¼ ë¹„êµ ê·¸ë˜í”„ ìƒì„±\n")
    
    # ê²°ê³¼ ë¡œë“œ
    results = load_evaluation_results()
    
    if results is None or len(results) == 0:
        print("\nâŒ í‰ê°€ ê²°ê³¼ íŒŒì¼ì´ ì—†ì–´ì„œ ê·¸ë˜í”„ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        exit(1)
    
    # í†µê³„ ì¶œë ¥
    print_summary_statistics(results)
    
    # ê·¸ë˜í”„ ìƒì„±
    print("\n" + "="*80)
    print("ğŸ“Š ê·¸ë˜í”„ ìƒì„± ì¤‘...")
    print("="*80)
    
    fig = create_comparison_graphs(results)
    
    print("\nâœ… ì™„ë£Œ!")
    print("="*80)