# -*- coding: utf-8 -*-
"""
1ë…„ì¹˜ CSV ë°ì´í„°ë¡œ 1550+ â†’ 10ë¶„ í›„ 1700+ ì¦ê°€ íŒ¨í„´ ë¶„ì„
ë©”ëª¨ë¦¬ ìµœì í™” + ìƒì„¸ í†µê³„ + ì‹œê°í™”
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import gc
import warnings

warnings.filterwarnings('ignore')
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

def load_large_csv(filepath):
    """ëŒ€ìš©ëŸ‰ CSV ë¡œë“œ (ë©”ëª¨ë¦¬ ìµœì í™”)"""
    print("\n" + "="*80)
    print("ğŸ“‚ ë°ì´í„° ë¡œë”© ì¤‘...")
    print("="*80)
    
    # ë¨¼ì € ìƒ˜í”Œë¡œ ì»¬ëŸ¼ í™•ì¸
    sample_df = pd.read_csv(filepath, nrows=5)
    print(f"ì»¬ëŸ¼: {list(sample_df.columns)}")
    
    # ì²­í¬ ë‹¨ìœ„ë¡œ ì½ê¸°
    chunk_size = 100000
    chunks = []
    
    for i, chunk in enumerate(pd.read_csv(filepath, chunksize=chunk_size)):
        chunks.append(chunk)
        if (i + 1) % 5 == 0:
            print(f"  {(i+1)*chunk_size:,}ê°œ ë¡œë”©...")
    
    df = pd.concat(chunks, ignore_index=True)
    print(f"âœ… ë¡œë”© ì™„ë£Œ: {len(df):,}ê°œ í–‰")
    
    # CURRTIME ë³€í™˜
    if 'CURRTIME' in df.columns:
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'], format='%Y%m%d%H%M', errors='coerce')
        print(f"ê¸°ê°„: {df['CURRTIME'].min()} ~ {df['CURRTIME'].max()}")
    
    return df

def analyze_1550_to_1700_pattern(df):
    """1550+ â†’ 1700+ íŒ¨í„´ ë¶„ì„"""
    
    print("\n" + "="*80)
    print("ğŸ“Š 1550+ â†’ 10ë¶„ í›„ 1700+ ì¦ê°€ íŒ¨í„´ ë¶„ì„")
    print("="*80)
    print(f"ì „ì²´ ë°ì´í„°: {len(df):,}ê°œ")
    
    # ===== 1. 1550 ì´ìƒ êµ¬ê°„ ì°¾ê¸° =====
    print("\n" + "="*80)
    print("1ï¸âƒ£ TOTALCNT 1550+ êµ¬ê°„ ë¶„ì„")
    print("="*80)
    
    mask_1550 = df['TOTALCNT'] >= 1550
    count_1550 = mask_1550.sum()
    
    print(f"1550+ êµ¬ê°„: {count_1550:,}ê°œ ({count_1550/len(df)*100:.2f}%)")
    
    # ë¶„í¬ í™•ì¸
    print(f"\nTOTALCNT ë¶„í¬:")
    print(f"  ìµœì†Œê°’: {df['TOTALCNT'].min()}")
    print(f"  í‰ê· ê°’: {df['TOTALCNT'].mean():.2f}")
    print(f"  ì¤‘ì•™ê°’: {df['TOTALCNT'].median():.2f}")
    print(f"  ìµœëŒ€ê°’: {df['TOTALCNT'].max()}")
    print(f"  1400+: {(df['TOTALCNT'] >= 1400).sum():,}ê°œ")
    print(f"  1500+: {(df['TOTALCNT'] >= 1500).sum():,}ê°œ")
    print(f"  1550+: {count_1550:,}ê°œ")
    print(f"  1600+: {(df['TOTALCNT'] >= 1600).sum():,}ê°œ")
    print(f"  1700+: {(df['TOTALCNT'] >= 1700).sum():,}ê°œ")
    
    if count_1550 < 100:
        print(f"\nâš ï¸ 1550+ ë°ì´í„°ê°€ {count_1550}ê°œë¡œ ì ìŠµë‹ˆë‹¤.")
        threshold = 1500
        print(f"ğŸ”„ ì„ê³„ê°’ì„ {threshold}ìœ¼ë¡œ ì¡°ì •í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.")
    else:
        threshold = 1550
    
    # ===== 2. 10ë¶„ í›„ ë¹„êµ ë°ì´í„° ìƒì„± =====
    print("\n" + "="*80)
    print("2ï¸âƒ£ 10ë¶„ í›„ 1700+ ë„ë‹¬ ì—¬ë¶€ ë¶„ì„")
    print("="*80)
    
    results = []
    
    # ì¸ë±ìŠ¤ ìƒì„±
    valid_indices = df[df['TOTALCNT'] >= threshold].index
    total_valid = len(valid_indices)
    
    print(f"ë¶„ì„ ëŒ€ìƒ: {total_valid:,}ê°œ")
    print("10ë¶„ í›„ ë¹„êµ ë°ì´í„° ìƒì„± ì¤‘...")
    
    for count, idx in enumerate(valid_indices):
        if idx + 10 >= len(df):
            continue
        
        # ì§„í–‰ìƒí™© ì¶œë ¥
        if count % 10000 == 0 and count > 0:
            print(f"  {count:,}/{total_valid:,} ({count/total_valid*100:.1f}%)")
        
        current_totalcnt = df.loc[idx, 'TOTALCNT']
        future_totalcnt = df.loc[idx + 10, 'TOTALCNT']
        
        # ì¦ê°€ ì—¬ë¶€
        increase_to_1700 = (future_totalcnt >= 1700)
        increase_amount = future_totalcnt - current_totalcnt
        
        # í˜„ì¬ ì‹œì  ì»¬ëŸ¼ê°’
        result = {
            'index': idx,
            'currtime': df.loc[idx, 'CURRTIME'] if 'CURRTIME' in df.columns else idx,
            'current_totalcnt': current_totalcnt,
            'future_totalcnt': future_totalcnt,
            'increase': increase_amount,
            'reach_1700': increase_to_1700,
            'M14AM10A': df.loc[idx, 'M14AM10A'],
            'M10AM14A': df.loc[idx, 'M10AM14A'],
            'M14AM10ASUM': df.loc[idx, 'M14AM10ASUM'],
            'M14AM14B': df.loc[idx, 'M14AM14B'],
            'M14BM14A': df.loc[idx, 'M14BM14A'],
            'M14AM14BSUM': df.loc[idx, 'M14AM14BSUM'],
            'M14AM16': df.loc[idx, 'M14AM16'],
            'M16M14A': df.loc[idx, 'M16M14A'],
            'M14AM16SUM': df.loc[idx, 'M14AM16SUM']
        }
        
        results.append(result)
    
    results_df = pd.DataFrame(results)
    
    # ë©”ëª¨ë¦¬ ì •ë¦¬
    del valid_indices
    gc.collect()
    
    # í†µê³„
    total_cases = len(results_df)
    reach_1700_cases = results_df['reach_1700'].sum()
    
    print(f"\nâœ… ë¶„ì„ ì™„ë£Œ!")
    print(f"ë¶„ì„ ì¼€ì´ìŠ¤: {total_cases:,}ê°œ")
    print(f"10ë¶„ í›„ 1700+ ë„ë‹¬: {reach_1700_cases:,}ê°œ ({reach_1700_cases/total_cases*100:.2f}%)")
    print(f"10ë¶„ í›„ 1700 ë¯¸ë‹¬: {total_cases - reach_1700_cases:,}ê°œ ({(total_cases-reach_1700_cases)/total_cases*100:.2f}%)")
    
    # ===== 3. ê·¸ë£¹ ë¹„êµ =====
    print("\n" + "="*80)
    print("3ï¸âƒ£ 1700+ ë„ë‹¬ vs ë¯¸ë‹¬ ê·¸ë£¹ ë¹„êµ")
    print("="*80)
    
    group_reach = results_df[results_df['reach_1700'] == True]
    group_not_reach = results_df[results_df['reach_1700'] == False]
    
    print(f"\nã€1700+ ë„ë‹¬ ê·¸ë£¹ã€‘ {len(group_reach):,}ê°œ")
    print(f"ã€1700 ë¯¸ë‹¬ ê·¸ë£¹ã€‘ {len(group_not_reach):,}ê°œ")
    
    # ì»¬ëŸ¼ë³„ í‰ê·  ë¹„êµ
    comparison_cols = ['M14AM10A', 'M10AM14A', 'M14AM10ASUM', 
                       'M14AM14B', 'M14BM14A', 'M14AM14BSUM',
                       'M14AM16', 'M16M14A', 'M14AM16SUM']
    
    print("\n" + "-"*80)
    print(f"{'ì»¬ëŸ¼':<15} {'ë„ë‹¬ í‰ê· ':>12} {'ë¯¸ë‹¬ í‰ê· ':>12} {'ì°¨ì´':>12} {'ì°¨ì´ìœ¨':>10}")
    print("-"*80)
    
    comparison_results = []
    
    for col in comparison_cols:
        if len(group_reach) > 0 and len(group_not_reach) > 0:
            reach_mean = group_reach[col].mean()
            not_reach_mean = group_not_reach[col].mean()
            diff = reach_mean - not_reach_mean
            diff_rate = (diff / not_reach_mean * 100) if not_reach_mean != 0 else 0
            
            print(f"{col:<15} {reach_mean:>12.2f} {not_reach_mean:>12.2f} {diff:>12.2f} {diff_rate:>9.2f}%")
            
            comparison_results.append({
                'column': col,
                'reach_mean': reach_mean,
                'reach_std': group_reach[col].std(),
                'reach_median': group_reach[col].median(),
                'not_reach_mean': not_reach_mean,
                'not_reach_std': group_not_reach[col].std(),
                'not_reach_median': group_not_reach[col].median(),
                'diff': diff,
                'diff_rate': diff_rate
            })
    
    comparison_df = pd.DataFrame(comparison_results)
    
    # ===== 4. ì¤‘ìš” íŒ¨í„´ ë°œê²¬ =====
    print("\n" + "="*80)
    print("4ï¸âƒ£ ğŸ”¥ ì¦ê°€ ì˜ˆì¸¡ í•µì‹¬ íŒ¨í„´")
    print("="*80)
    
    # ì°¨ì´ìœ¨ ê¸°ì¤€ ì •ë ¬
    comparison_df_sorted = comparison_df.sort_values('diff_rate', ascending=False)
    
    print("\nã€ê°€ì¥ í° ì°¨ì´ë¥¼ ë³´ì´ëŠ” ì»¬ëŸ¼ TOP 5ã€‘")
    for idx, row in comparison_df_sorted.head(5).iterrows():
        direction = "ë†’ìŒ" if row['diff_rate'] > 0 else "ë‚®ìŒ"
        print(f"  {idx+1}. {row['column']}: ë„ë‹¬ê·¸ë£¹ì´ {abs(row['diff_rate']):.1f}% ë” {direction}")
        print(f"     ë„ë‹¬: {row['reach_mean']:.2f} (Â±{row['reach_std']:.2f}) vs ë¯¸ë‹¬: {row['not_reach_mean']:.2f} (Â±{row['not_reach_std']:.2f})")
    
    # ===== 5. ì„ê³„ê°’ ë¶„ì„ =====
    print("\n" + "="*80)
    print("5ï¸âƒ£ ì„ê³„ê°’ ê¸°ë°˜ ì˜ˆì¸¡ ê·œì¹™")
    print("="*80)
    
    if len(group_reach) > 0:
        print("\nã€1700+ ë„ë‹¬ ê·¸ë£¹ì˜ ì»¬ëŸ¼ ë¶„í¬ã€‘")
        
        for col in comparison_cols:
            reach_values = group_reach[col]
            
            percentile_10 = reach_values.quantile(0.10)
            percentile_25 = reach_values.quantile(0.25)
            percentile_50 = reach_values.median()
            percentile_75 = reach_values.quantile(0.75)
            percentile_90 = reach_values.quantile(0.90)
            
            print(f"\n{col}:")
            print(f"  ìµœì†Œ: {reach_values.min():.2f}")
            print(f"  10%: {percentile_10:.2f}")
            print(f"  25%: {percentile_25:.2f}")
            print(f"  ì¤‘ì•™: {percentile_50:.2f}")
            print(f"  75%: {percentile_75:.2f}")
            print(f"  90%: {percentile_90:.2f}")
            print(f"  ìµœëŒ€: {reach_values.max():.2f}")
    
    # ===== 6. ì˜ˆì¸¡ ê·œì¹™ ìƒì„± =====
    print("\n" + "="*80)
    print("6ï¸âƒ£ ğŸ’¡ ì˜ˆì¸¡ ê·œì¹™ ì œì•ˆ")
    print("="*80)
    
    if len(group_reach) > 0:
        # ë„ë‹¬ ê·¸ë£¹ì˜ ì¤‘ì•™ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ê·œì¹™ ìƒì„±
        rules = []
        
        for col in comparison_cols:
            reach_median = group_reach[col].median()
            not_reach_median = group_not_reach[col].median() if len(group_not_reach) > 0 else 0
            
            if reach_median > not_reach_median:
                rules.append({
                    'column': col,
                    'threshold': reach_median,
                    'direction': '>=',
                    'diff': reach_median - not_reach_median
                })
            elif reach_median < not_reach_median:
                rules.append({
                    'column': col,
                    'threshold': reach_median,
                    'direction': '<=',
                    'diff': not_reach_median - reach_median
                })
        
        # ì°¨ì´ê°€ í° ìˆœì„œë¡œ ì •ë ¬
        rules_sorted = sorted(rules, key=lambda x: abs(x['diff']), reverse=True)
        
        print(f"\nã€ì œì•ˆ ê·œì¹™ã€‘ í˜„ì¬ {threshold}+ ì¼ ë•Œ, 10ë¶„ í›„ 1700+ ì˜ˆì¸¡:")
        print("\nIF (ë‹¤ìŒ ì¡°ê±´ ì¤‘ 3ê°œ ì´ìƒ ë§Œì¡±):")
        
        for i, rule in enumerate(rules_sorted[:6], 1):
            print(f"  {i}. {rule['column']} {rule['direction']} {rule['threshold']:.2f}")
        
        print("\nTHEN: 10ë¶„ í›„ 1700+ ë„ë‹¬ ê°€ëŠ¥ì„± ë†’ìŒ")
        
        # ===== 7. ê·œì¹™ ê²€ì¦ =====
        print("\n" + "="*80)
        print("7ï¸âƒ£ ê·œì¹™ ê²€ì¦")
        print("="*80)
        
        if len(rules_sorted) >= 3:
            # ìƒìœ„ 5ê°œ ê·œì¹™ ì ìš©
            top_rules = rules_sorted[:5]
            
            # ê·œì¹™ ì ìš©
            conditions = []
            for rule in top_rules:
                col = rule['column']
                threshold_val = rule['threshold']
                direction = rule['direction']
                
                if direction == '>=':
                    condition = results_df[col] >= threshold_val
                else:
                    condition = results_df[col] <= threshold_val
                
                conditions.append(condition)
            
            # 3ê°œ ì´ìƒ ë§Œì¡±
            rule_match_3 = sum(conditions) >= 3
            
            # ê²€ì¦
            true_positive = (rule_match_3 & results_df['reach_1700']).sum()
            false_positive = (rule_match_3 & ~results_df['reach_1700']).sum()
            true_negative = (~rule_match_3 & ~results_df['reach_1700']).sum()
            false_negative = (~rule_match_3 & results_df['reach_1700']).sum()
            
            total = len(results_df)
            
            print(f"\nã€3ê°œ ì´ìƒ ê·œì¹™ ë§Œì¡± ì‹œã€‘")
            print(f"  True Positive (ê·œì¹™O, ì‹¤ì œO): {true_positive:,}ê°œ")
            print(f"  False Positive (ê·œì¹™O, ì‹¤ì œX): {false_positive:,}ê°œ")
            print(f"  True Negative (ê·œì¹™X, ì‹¤ì œX): {true_negative:,}ê°œ")
            print(f"  False Negative (ê·œì¹™X, ì‹¤ì œO): {false_negative:,}ê°œ")
            
            if true_positive + false_positive > 0:
                precision = true_positive / (true_positive + false_positive)
                print(f"\n  ì •í™•ë„ (Precision): {precision*100:.2f}%")
            
            if true_positive + false_negative > 0:
                recall = true_positive / (true_positive + false_negative)
                print(f"  ì¬í˜„ìœ¨ (Recall): {recall*100:.2f}%")
            
            if total > 0:
                accuracy = (true_positive + true_negative) / total
                print(f"  ì „ì²´ ì •í™•ë„: {accuracy*100:.2f}%")
            
            if precision > 0 and recall > 0:
                f1 = 2 * (precision * recall) / (precision + recall)
                print(f"  F1 Score: {f1*100:.2f}%")
    
    # ===== 8. ì¦ê°€ëŸ‰ ë¶„ì„ =====
    print("\n" + "="*80)
    print("8ï¸âƒ£ ì¦ê°€ëŸ‰ ìƒì„¸ ë¶„ì„")
    print("="*80)
    
    print(f"\nì¦ê°€ëŸ‰ í†µê³„:")
    print(f"  í‰ê·  ì¦ê°€: {results_df['increase'].mean():.2f}")
    print(f"  ì¤‘ì•™ ì¦ê°€: {results_df['increase'].median():.2f}")
    print(f"  ìµœëŒ€ ì¦ê°€: {results_df['increase'].max():.2f}")
    print(f"  ìµœì†Œ ì¦ê°€: {results_df['increase'].min():.2f}")
    
    print(f"\në„ë‹¬ ê·¸ë£¹ ì¦ê°€ëŸ‰:")
    if len(group_reach) > 0:
        print(f"  í‰ê· : {group_reach['increase'].mean():.2f}")
        print(f"  ì¤‘ì•™: {group_reach['increase'].median():.2f}")
        print(f"  ìµœëŒ€: {group_reach['increase'].max():.2f}")
    
    print(f"\në¯¸ë‹¬ ê·¸ë£¹ ì¦ê°€ëŸ‰:")
    if len(group_not_reach) > 0:
        print(f"  í‰ê· : {group_not_reach['increase'].mean():.2f}")
        print(f"  ì¤‘ì•™: {group_not_reach['increase'].median():.2f}")
        print(f"  ìµœì†Œ: {group_not_reach['increase'].min():.2f}")
    
    # ===== 9. CSV ì €ì¥ =====
    print("\n" + "="*80)
    print("9ï¸âƒ£ ê²°ê³¼ ì €ì¥")
    print("="*80)
    
    # ë¶„ì„ ê²°ê³¼
    output_csv = 'pattern_analysis_results_1year.csv'
    results_df.to_csv(output_csv, index=False, encoding='utf-8-sig')
    print(f"âœ… ë¶„ì„ ê²°ê³¼: {output_csv}")
    
    # ë¹„êµ í†µê³„
    comparison_output = 'pattern_comparison_stats_1year.csv'
    comparison_df.to_csv(comparison_output, index=False, encoding='utf-8-sig')
    print(f"âœ… ë¹„êµ í†µê³„: {comparison_output}")
    
    # ===== 10. ì‹œê°í™” =====
    print("\n" + "="*80)
    print("ğŸ”Ÿ ê·¸ë˜í”„ ìƒì„± ì¤‘...")
    print("="*80)
    
    create_analysis_graphs(results_df, comparison_df_sorted, group_reach, group_not_reach, threshold)
    
    return results_df, comparison_df

def create_analysis_graphs(results_df, comparison_df, group_reach, group_not_reach, threshold):
    """ë¶„ì„ ê·¸ë˜í”„ ìƒì„±"""
    
    fig = plt.figure(figsize=(20, 14))
    
    # 1. ì»¬ëŸ¼ë³„ í‰ê·  ë¹„êµ
    ax1 = plt.subplot(3, 3, 1)
    x = range(len(comparison_df))
    reach_means = comparison_df['reach_mean']
    not_reach_means = comparison_df['not_reach_mean']
    
    width = 0.35
    ax1.bar([i - width/2 for i in x], reach_means, width, label='1700+ Reach', alpha=0.7, color='#2E86AB')
    ax1.bar([i + width/2 for i in x], not_reach_means, width, label='1700 Not Reach', alpha=0.7, color='#F18F01')
    
    ax1.set_xlabel('Columns', fontsize=11, fontweight='bold')
    ax1.set_ylabel('Average Value', fontsize=11, fontweight='bold')
    ax1.set_title('1) Column Averages Comparison', fontsize=12, fontweight='bold')
    ax1.set_xticks(x)
    ax1.set_xticklabels(comparison_df['column'], rotation=45, ha='right', fontsize=9)
    ax1.legend()
    ax1.grid(True, alpha=0.3, axis='y')
    
    # 2. ì°¨ì´ìœ¨ ê°€ë¡œ ë§‰ëŒ€
    ax2 = plt.subplot(3, 3, 2)
    colors = ['#2E86AB' if v > 0 else '#F18F01' for v in comparison_df['diff_rate']]
    ax2.barh(range(len(comparison_df)), comparison_df['diff_rate'], 
            color=colors, alpha=0.7, edgecolor='black')
    ax2.set_yticks(range(len(comparison_df)))
    ax2.set_yticklabels(comparison_df['column'], fontsize=9)
    ax2.set_xlabel('Difference Rate (%)', fontsize=11, fontweight='bold')
    ax2.set_title('2) Difference Rate by Column', fontsize=12, fontweight='bold')
    ax2.axvline(x=0, color='red', linestyle='--', linewidth=2)
    ax2.grid(True, alpha=0.3, axis='x')
    
    # 3. ì¦ê°€ëŸ‰ ë¶„í¬
    ax3 = plt.subplot(3, 3, 3)
    ax3.hist(results_df['increase'], bins=50, alpha=0.7, color='#A23B72', edgecolor='black')
    ax3.axvline(x=results_df['increase'].mean(), color='red', linestyle='--', linewidth=2, 
              label=f'Mean: {results_df["increase"].mean():.1f}')
    ax3.axvline(x=0, color='black', linestyle='-', linewidth=1)
    ax3.set_xlabel('Increase Amount (10min)', fontsize=11, fontweight='bold')
    ax3.set_ylabel('Frequency', fontsize=11, fontweight='bold')
    ax3.set_title('3) TOTALCNT Increase Distribution', fontsize=12, fontweight='bold')
    ax3.legend()
    ax3.grid(True, alpha=0.3)
    
    # 4. í˜„ì¬ê°’ vs 10ë¶„ í›„
    ax4 = plt.subplot(3, 3, 4)
    if len(group_reach) > 0:
        ax4.scatter(group_reach['current_totalcnt'], group_reach['future_totalcnt'], 
                  alpha=0.5, s=20, color='#2E86AB', label='1700+ Reach')
    if len(group_not_reach) > 0:
        ax4.scatter(group_not_reach['current_totalcnt'], group_not_reach['future_totalcnt'], 
                  alpha=0.5, s=20, color='#F18F01', label='1700 Not Reach')
    
    ax4.axhline(y=1700, color='red', linestyle='--', linewidth=2, label='1700 Threshold')
    ax4.plot([threshold, 2000], [threshold, 2000], 'k--', alpha=0.3, label='No Change')
    
    ax4.set_xlabel('Current TOTALCNT', fontsize=11, fontweight='bold')
    ax4.set_ylabel('Future TOTALCNT (10min)', fontsize=11, fontweight='bold')
    ax4.set_title('4) Current vs Future TOTALCNT', fontsize=12, fontweight='bold')
    ax4.legend(fontsize=8)
    ax4.grid(True, alpha=0.3)
    
    # 5-9. ì£¼ìš” ì»¬ëŸ¼ ì‚°ì ë„
    key_columns = comparison_df.head(5)['column'].tolist()
    
    for idx, col in enumerate(key_columns):
        row = (idx + 4) // 3
        col_idx = (idx + 4) % 3
        ax = plt.subplot(3, 3, idx + 5)
        
        if len(group_reach) > 0:
            ax.scatter(group_reach[col], group_reach['future_totalcnt'], 
                      alpha=0.5, s=15, color='#2E86AB', label='1700+ Reach')
        
        if len(group_not_reach) > 0:
            ax.scatter(group_not_reach[col], group_not_reach['future_totalcnt'], 
                      alpha=0.5, s=15, color='#F18F01', label='1700 Not Reach')
        
        ax.axhline(y=1700, color='red', linestyle='--', linewidth=2, alpha=0.7)
        
        ax.set_xlabel(col, fontsize=10, fontweight='bold')
        ax.set_ylabel('Future TOTALCNT', fontsize=10, fontweight='bold')
        ax.set_title(f'{idx+5}) {col} vs Future', fontsize=11, fontweight='bold')
        ax.legend(fontsize=7)
        ax.grid(True, alpha=0.3)
    
    plt.suptitle(f'Pattern Analysis: {threshold}+ â†’ 10min later 1700+ (1 Year Data)', 
                 fontsize=16, fontweight='bold')
    
    plt.tight_layout()
    
    output_file = 'pattern_analysis_1550_to_1700_1year.png'
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"\nâœ… ê·¸ë˜í”„ ì €ì¥: {output_file}")
    
    plt.close()

if __name__ == '__main__':
    print("\n" + "="*80)
    print("ğŸš€ 1ë…„ì¹˜ ë°ì´í„°ë¡œ 1550+ â†’ 1700+ íŒ¨í„´ ë¶„ì„")
    print("="*80)
    
    # CSV íŒŒì¼ ê²½ë¡œ (ìˆ˜ì • í•„ìš”)
    csv_file = 'uu.csv'  # ë˜ëŠ” 'uu2.csv'
    
    # íŒŒì¼ ì¡´ì¬ í™•ì¸
    import os
    if not os.path.exists(csv_file):
        print(f"\nâŒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {csv_file}")
        print("\nì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼:")
        for f in ['uu.csv', 'uu2.csv', 'A.TXT']:
            if os.path.exists(f):
                print(f"  âœ… {f}")
        print("\nì½”ë“œ ìƒë‹¨ì˜ csv_file ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.")
        exit(1)
    
    # ë°ì´í„° ë¡œë“œ
    df = load_large_csv(csv_file)
    
    # íŒ¨í„´ ë¶„ì„
    results_df, comparison_df = analyze_1550_to_1700_pattern(df)
    
    print("\n" + "="*80)
    print("âœ… ì „ì²´ ë¶„ì„ ì™„ë£Œ!")
    print("="*80)
    print("\nìƒì„±ëœ íŒŒì¼:")
    print("  1. pattern_analysis_results_1year.csv - ì „ì²´ ë¶„ì„ ê²°ê³¼")
    print("  2. pattern_comparison_stats_1year.csv - ì»¬ëŸ¼ë³„ ë¹„êµ í†µê³„")
    print("  3. pattern_analysis_1550_to_1700_1year.png - 9ê°œ ê·¸ë˜í”„")
    print("\n" + "="*80)