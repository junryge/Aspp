import streamlit as st
import pandas as pd
import os
from datetime import datetime

st.set_page_config(page_title="ê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8", page_icon="ğŸ“Š", layout="wide")

# CSS ìŠ¤íƒ€ì¼
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, #00d4ff, #ff6b35);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 10px;
    }
    .sub-header {
        text-align: center;
        color: #888;
        margin-bottom: 30px;
    }
    .metric-card {
        background: #1a1a2e;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
    }
    .success { color: #00ff88; }
    .warning { color: #ffcc00; }
    .danger { color: #ff4466; }
</style>
""", unsafe_allow_html=True)

st.markdown('<h1 class="main-header">ğŸ“Š ê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ</h1>', unsafe_allow_html=True)
st.markdown('<p class="sub-header">HUBROOM V8.0 | M14_Q V8.3.1</p>', unsafe_allow_html=True)


def analyze_hubroom(df, threshold=350):
    """HUBROOM ë¶„ì„"""
    drop_cols = ['Unnamed: 22', 'Unnamed: 23']
    for col in drop_cols:
        if col in df.columns:
            df = df.drop(columns=[col])
    
    df['ì‚¬ì „ê°ì§€OK_NG'] = ''
    surge_condition = (df['ì‹¤ì œê°’'] >= threshold) & (df['í˜„ì¬ê°’'] <= threshold)
    df.loc[surge_condition, 'ì‚¬ì „ê°ì§€OK_NG'] = 'Y'
    
    df['ì‚¬ì „ê°ì§€ê²°ê³¼'] = ''
    ok_condition = surge_condition & (df['ì˜ˆì¸¡ê°’_MAX'] >= threshold)
    df.loc[ok_condition, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'OK'
    
    ng_condition = surge_condition & (df['ì˜ˆì¸¡ê°’_MAX'] < threshold)
    ng_indices = df[ng_condition].index.tolist()
    
    for idx in ng_indices:
        found = False
        for back in range(1, 6):
            prev_idx = idx - back
            if prev_idx >= 0:
                prev_pred = df.loc[prev_idx, 'ì˜ˆì¸¡ê°’_MAX']
                if prev_pred >= threshold:
                    df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = f'ì‚¬ì „ê°ì§€({back}ë¶„ì „)'
                    found = True
                    break
        if not found:
            df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'NG'
    
    df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = ''
    fp_condition = (df['ì‹¤ì œê°’'] < threshold) & (df['ì˜ˆì¸¡ê°’_MAX'] >= threshold)
    fp_indices = df[fp_condition].index.tolist()
    
    for idx in fp_indices:
        found = False
        for offset in range(-5, 6):
            if offset == 0:
                continue
            check_idx = idx + offset
            if 0 <= check_idx < len(df):
                if df.loc[check_idx, 'ì‹¤ì œê°’'] >= threshold:
                    df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒì‚¬ì „ê°ì§€'
                    found = True
                    break
        if not found:
            df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒ'
    
    cols = df.columns.tolist()
    cols.remove('ì‚¬ì „ê°ì§€OK_NG')
    cols.remove('ì‚¬ì „ê°ì§€ê²°ê³¼')
    cols.remove('ì˜¤íƒ/ì‚¬ì „ê°ì§€')
    actual_idx = cols.index('ì‹¤ì œê°’')
    new_cols = cols[:actual_idx+1] + ['ì‚¬ì „ê°ì§€OK_NG', 'ì‚¬ì „ê°ì§€ê²°ê³¼', 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] + cols[actual_idx+1:]
    df = df[new_cols]
    
    total_surge = len(df[surge_condition])
    ok_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'OK'])
    pre_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'].str.contains('ì‚¬ì „ê°ì§€', na=False)])
    ng_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'NG'])
    fp_total = len(fp_indices)
    fp_pre = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒì‚¬ì „ê°ì§€'])
    fp_real = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒ'])
    
    return df, {
        'total': total_surge, 'ok': ok_cnt, 'pre': pre_cnt, 'ng': ng_cnt,
        'fp_total': fp_total, 'fp_pre': fp_pre, 'fp_real': fp_real
    }


def analyze_m14(df, threshold=1700):
    """M14_Q ë¶„ì„"""
    drop_cols = ['12ë¶„ì „TOTALCNT', '12ë³€í™”ëŸ‰', 'Unnamed: 22', 'Unnamed: 23']
    for col in drop_cols:
        if col in df.columns:
            df = df.drop(columns=[col])
    
    df['ì‚¬ì „ê°ì§€OK_NG'] = ''
    surge_condition = (df['ì‹¤ì œê°’'] >= threshold) & (df['í˜„ì¬TOTALCNT'] <= threshold)
    df.loc[surge_condition, 'ì‚¬ì „ê°ì§€OK_NG'] = 'Y'
    
    df['ì‚¬ì „ê°ì§€ê²°ê³¼'] = ''
    ok_condition = surge_condition & (df['ìµœì¢…ì˜ˆì¸¡'] >= threshold)
    df.loc[ok_condition, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'OK'
    
    ng_condition = surge_condition & (df['ìµœì¢…ì˜ˆì¸¡'] < threshold)
    ng_indices = df[ng_condition].index.tolist()
    
    for idx in ng_indices:
        found = False
        for back in range(1, 6):
            prev_idx = idx - back
            if prev_idx >= 0:
                prev_pred = df.loc[prev_idx, 'ìµœì¢…ì˜ˆì¸¡']
                if prev_pred >= threshold:
                    df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = f'ì‚¬ì „ê°ì§€({back}ë¶„ì „)'
                    found = True
                    break
        if not found:
            df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'NG'
    
    df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = ''
    fp_condition = (df['ì‹¤ì œê°’'] < threshold) & (df['ìµœì¢…ì˜ˆì¸¡'] >= threshold)
    fp_indices = df[fp_condition].index.tolist()
    
    for idx in fp_indices:
        found = False
        for offset in range(-5, 6):
            if offset == 0:
                continue
            check_idx = idx + offset
            if 0 <= check_idx < len(df):
                if df.loc[check_idx, 'ì‹¤ì œê°’'] >= threshold:
                    df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒì‚¬ì „ê°ì§€'
                    found = True
                    break
        if not found:
            df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒ'
    
    cols = df.columns.tolist()
    cols.remove('ì‚¬ì „ê°ì§€OK_NG')
    cols.remove('ì‚¬ì „ê°ì§€ê²°ê³¼')
    cols.remove('ì˜¤íƒ/ì‚¬ì „ê°ì§€')
    actual_idx = cols.index('ì‹¤ì œê°’')
    new_cols = cols[:actual_idx+1] + ['ì‚¬ì „ê°ì§€OK_NG', 'ì‚¬ì „ê°ì§€ê²°ê³¼', 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] + cols[actual_idx+1:]
    df = df[new_cols]
    
    total_surge = len(df[surge_condition])
    ok_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'OK'])
    pre_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'].str.contains('ì‚¬ì „ê°ì§€', na=False)])
    ng_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'NG'])
    fp_total = len(fp_indices)
    fp_pre = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒì‚¬ì „ê°ì§€'])
    fp_real = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒ'])
    
    return df, {
        'total': total_surge, 'ok': ok_cnt, 'pre': pre_cnt, 'ng': ng_cnt,
        'fp_total': fp_total, 'fp_pre': fp_pre, 'fp_real': fp_real
    }


def generate_html_report(hub_stats, m14_stats, hub_df, m14_df):
    """HTML ë¦¬í¬íŠ¸ ìƒì„±"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    def calc_rates(stats):
        total = stats['total'] if stats['total'] > 0 else 1
        fp_total = stats['fp_total'] if stats['fp_total'] > 0 else 1
        return {
            'ok_rate': stats['ok'] / total * 100,
            'pre_rate': stats['pre'] / total * 100,
            'ng_rate': stats['ng'] / total * 100,
            'detect_rate': (stats['ok'] + stats['pre']) / total * 100,
            'fp_pre_rate': stats['fp_pre'] / fp_total * 100,
            'fp_real_rate': stats['fp_real'] / fp_total * 100
        }
    
    hub_rates = calc_rates(hub_stats) if hub_stats else None
    m14_rates = calc_rates(m14_stats) if m14_stats else None
    
    html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {{
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --accent-hub: #00d4ff;
            --accent-m14: #ff6b35;
            --success: #00ff88;
            --warning: #ffcc00;
            --danger: #ff4466;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --border: #2a2a3a;
        }}
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px 20px;
        }}
        .container {{ max-width: 1200px; margin: 0 auto; }}
        h1 {{
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-hub), var(--accent-m14));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }}
        .subtitle {{ text-align: center; color: var(--text-secondary); margin-bottom: 40px; }}
        .section {{ margin-bottom: 50px; }}
        .section-title {{
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }}
        .section-title.hub {{ color: var(--accent-hub); border-color: var(--accent-hub); }}
        .section-title.m14 {{ color: var(--accent-m14); border-color: var(--accent-m14); }}
        .grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }}
        .card {{
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border);
        }}
        .card-label {{ font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; }}
        .card-value {{ font-size: 2.5rem; font-weight: 900; font-family: 'JetBrains Mono', monospace; }}
        .card-sub {{ font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }}
        .success {{ color: var(--success); }}
        .warning {{ color: var(--warning); }}
        .danger {{ color: var(--danger); }}
        .hub-color {{ color: var(--accent-hub); }}
        .m14-color {{ color: var(--accent-m14); }}
        .chart-container {{ display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }}
        .chart-box {{ background: var(--bg-card); border-radius: 15px; padding: 25px; border: 1px solid var(--border); }}
        .chart-title {{ font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }}
        .chart-wrapper {{ height: 280px; position: relative; }}
        .summary-box {{
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border);
        }}
        .summary-title {{ font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; }}
        .summary-content {{
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }}
        .footer {{ text-align: center; color: var(--text-secondary); margin-top: 50px; font-size: 0.85rem; }}
        @media (max-width: 768px) {{
            .chart-container {{ grid-template-columns: 1fr; }}
            h1 {{ font-size: 1.8rem; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <p class="subtitle">ìƒì„±ì¼ì‹œ: {now}</p>
'''
    
    # HUBROOM Section
    if hub_stats and hub_stats['total'] > 0:
        html += f'''
        <div class="section">
            <h2 class="section-title hub">ğŸ  HUBROOM V8.0 ë¶„ì„ ê²°ê³¼</h2>
            <div class="grid">
                <div class="card">
                    <div class="card-label">ê¸‰ì¦ ì¼€ì´ìŠ¤</div>
                    <div class="card-value hub-color">{hub_stats['total']}</div>
                    <div class="card-sub">ê¸°ì¤€: 350</div>
                </div>
                <div class="card">
                    <div class="card-label">ì´ ê°ì§€ìœ¨</div>
                    <div class="card-value success">{hub_rates['detect_rate']:.1f}%</div>
                    <div class="card-sub">OK + ì‚¬ì „ê°ì§€</div>
                </div>
                <div class="card">
                    <div class="card-label">OK (ì¦‰ì‹œê°ì§€)</div>
                    <div class="card-value success">{hub_stats['ok']}</div>
                    <div class="card-sub">{hub_rates['ok_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">ì‚¬ì „ê°ì§€</div>
                    <div class="card-value warning">{hub_stats['pre']}</div>
                    <div class="card-sub">{hub_rates['pre_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">NG (ë¯¸ê°ì§€)</div>
                    <div class="card-value danger">{hub_stats['ng']}</div>
                    <div class="card-sub">{hub_rates['ng_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">ì˜¤íƒ</div>
                    <div class="card-value danger">{hub_stats['fp_real']}</div>
                    <div class="card-sub">{hub_rates['fp_real_rate']:.1f}% (ì „ì²´ {hub_stats['fp_total']}ê°œ)</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">ğŸ“ˆ ê°ì§€ ê²°ê³¼ ë¶„í¬</div>
                    <div class="chart-wrapper"><canvas id="hubPieChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ“‰ ì˜¤íƒ ë¶„ì„</div>
                    <div class="chart-wrapper"><canvas id="hubFpChart"></canvas></div>
                </div>
            </div>
            <div class="summary-box">
                <div class="summary-title">ğŸ“‹ HUBROOM ìš”ì•½</div>
                <pre class="summary-content">=== HUBROOM V8.0 ìµœì¢… ìš”ì•½ (ê¸°ì¤€: 350) ===

[ ê¸‰ì¦ ê°ì§€ ê²°ê³¼ ]
ê¸‰ì¦ ì¼€ì´ìŠ¤: {hub_stats['total']}ê°œ (100%)
OK: {hub_stats['ok']}ê°œ ({hub_rates['ok_rate']:.1f}%)
ì‚¬ì „ê°ì§€: {hub_stats['pre']}ê°œ ({hub_rates['pre_rate']:.1f}%)
NG: {hub_stats['ng']}ê°œ ({hub_rates['ng_rate']:.1f}%)
ì´ ê°ì§€ìœ¨: {hub_rates['detect_rate']:.1f}%

[ ì˜¤íƒ ë¶„ì„ ]
ì˜¤íƒ í›„ë³´: {hub_stats['fp_total']}ê°œ
ì˜¤íƒì‚¬ì „ê°ì§€: {hub_stats['fp_pre']}ê°œ ({hub_rates['fp_pre_rate']:.1f}%)
ì˜¤íƒ: {hub_stats['fp_real']}ê°œ ({hub_rates['fp_real_rate']:.1f}%)</pre>
            </div>
        </div>
'''
    
    # M14 Section
    if m14_stats and m14_stats['total'] > 0:
        html += f'''
        <div class="section">
            <h2 class="section-title m14">ğŸ­ M14_Q V8.3.1 ë¶„ì„ ê²°ê³¼</h2>
            <div class="grid">
                <div class="card">
                    <div class="card-label">ê¸‰ì¦ ì¼€ì´ìŠ¤</div>
                    <div class="card-value m14-color">{m14_stats['total']}</div>
                    <div class="card-sub">ê¸°ì¤€: 1700</div>
                </div>
                <div class="card">
                    <div class="card-label">ì´ ê°ì§€ìœ¨</div>
                    <div class="card-value success">{m14_rates['detect_rate']:.1f}%</div>
                    <div class="card-sub">OK + ì‚¬ì „ê°ì§€</div>
                </div>
                <div class="card">
                    <div class="card-label">OK (ì¦‰ì‹œê°ì§€)</div>
                    <div class="card-value success">{m14_stats['ok']}</div>
                    <div class="card-sub">{m14_rates['ok_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">ì‚¬ì „ê°ì§€</div>
                    <div class="card-value warning">{m14_stats['pre']}</div>
                    <div class="card-sub">{m14_rates['pre_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">NG (ë¯¸ê°ì§€)</div>
                    <div class="card-value danger">{m14_stats['ng']}</div>
                    <div class="card-sub">{m14_rates['ng_rate']:.1f}%</div>
                </div>
                <div class="card">
                    <div class="card-label">ì˜¤íƒ</div>
                    <div class="card-value danger">{m14_stats['fp_real']}</div>
                    <div class="card-sub">{m14_rates['fp_real_rate']:.1f}% (ì „ì²´ {m14_stats['fp_total']}ê°œ)</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">ğŸ“ˆ ê°ì§€ ê²°ê³¼ ë¶„í¬</div>
                    <div class="chart-wrapper"><canvas id="m14PieChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">ğŸ“‰ ì˜¤íƒ ë¶„ì„</div>
                    <div class="chart-wrapper"><canvas id="m14FpChart"></canvas></div>
                </div>
            </div>
            <div class="summary-box">
                <div class="summary-title">ğŸ“‹ M14_Q ìš”ì•½</div>
                <pre class="summary-content">=== M14_Q V8.3.1 ìµœì¢… ìš”ì•½ (ê¸°ì¤€: 1700) ===

[ ê¸‰ì¦ ê°ì§€ ê²°ê³¼ ]
ê¸‰ì¦ ì¼€ì´ìŠ¤: {m14_stats['total']}ê°œ (100%)
OK: {m14_stats['ok']}ê°œ ({m14_rates['ok_rate']:.1f}%)
ì‚¬ì „ê°ì§€: {m14_stats['pre']}ê°œ ({m14_rates['pre_rate']:.1f}%)
NG: {m14_stats['ng']}ê°œ ({m14_rates['ng_rate']:.1f}%)
ì´ ê°ì§€ìœ¨: {m14_rates['detect_rate']:.1f}%

[ ì˜¤íƒ ë¶„ì„ ]
ì˜¤íƒ í›„ë³´: {m14_stats['fp_total']}ê°œ
ì˜¤íƒì‚¬ì „ê°ì§€: {m14_stats['fp_pre']}ê°œ ({m14_rates['fp_pre_rate']:.1f}%)
ì˜¤íƒ: {m14_stats['fp_real']}ê°œ ({m14_rates['fp_real_rate']:.1f}%)</pre>
            </div>
        </div>
'''
    
    # Chart Scripts
    html += '''
        <div class="footer">ê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8 | AMHS ë¬¼ë¥˜ ì˜ˆì¸¡ ëª¨ë¸</div>
    </div>
    <script>
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#ffffff', font: { size: 11 } } }
            }
        };
'''
    
    if hub_stats and hub_stats['total'] > 0:
        html += f'''
        new Chart(document.getElementById('hubPieChart'), {{
            type: 'doughnut',
            data: {{
                labels: ['OK', 'ì‚¬ì „ê°ì§€', 'NG'],
                datasets: [{{ data: [{hub_stats['ok']}, {hub_stats['pre']}, {hub_stats['ng']}], backgroundColor: ['#00ff88', '#ffcc00', '#ff4466'], borderWidth: 0 }}]
            }},
            options: chartOptions
        }});
        new Chart(document.getElementById('hubFpChart'), {{
            type: 'doughnut',
            data: {{
                labels: ['ì˜¤íƒì‚¬ì „ê°ì§€', 'ì˜¤íƒ'],
                datasets: [{{ data: [{hub_stats['fp_pre']}, {hub_stats['fp_real']}], backgroundColor: ['#ffcc00', '#ff4466'], borderWidth: 0 }}]
            }},
            options: chartOptions
        }});
'''
    
    if m14_stats and m14_stats['total'] > 0:
        html += f'''
        new Chart(document.getElementById('m14PieChart'), {{
            type: 'doughnut',
            data: {{
                labels: ['OK', 'ì‚¬ì „ê°ì§€', 'NG'],
                datasets: [{{ data: [{m14_stats['ok']}, {m14_stats['pre']}, {m14_stats['ng']}], backgroundColor: ['#00ff88', '#ffcc00', '#ff4466'], borderWidth: 0 }}]
            }},
            options: chartOptions
        }});
        new Chart(document.getElementById('m14FpChart'), {{
            type: 'doughnut',
            data: {{
                labels: ['ì˜¤íƒì‚¬ì „ê°ì§€', 'ì˜¤íƒ'],
                datasets: [{{ data: [{m14_stats['fp_pre']}, {m14_stats['fp_real']}], backgroundColor: ['#ffcc00', '#ff4466'], borderWidth: 0 }}]
            }},
            options: chartOptions
        }});
'''
    
    html += '''
    </script>
</body>
</html>'''
    
    return html


# ============================================
# Streamlit UI
# ============================================
col1, col2 = st.columns(2)

with col1:
    st.subheader("ğŸ  HUBROOM V8.0")
    st.caption("ê¸°ì¤€ê°’: 350 | ì»¬ëŸ¼: í˜„ì¬ê°’, ì‹¤ì œê°’, ì˜ˆì¸¡ê°’_MAX")
    hub_file = st.file_uploader("HUBROOM CSV ì—…ë¡œë“œ", type=['csv'], key='hub')

with col2:
    st.subheader("ğŸ­ M14_Q V8.3.1")
    st.caption("ê¸°ì¤€ê°’: 1700 | ì»¬ëŸ¼: í˜„ì¬TOTALCNT, ì‹¤ì œê°’, ìµœì¢…ì˜ˆì¸¡")
    m14_file = st.file_uploader("M14_Q CSV ì—…ë¡œë“œ", type=['csv'], key='m14')

st.markdown("---")

if st.button("ğŸ” ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True):
    hub_stats = None
    m14_stats = None
    hub_df = None
    m14_df = None
    
    if hub_file:
        with st.spinner("HUBROOM ë¶„ì„ ì¤‘..."):
            df = pd.read_csv(hub_file)
            hub_df, hub_stats = analyze_hubroom(df.copy(), 350)
        
        st.success(f"âœ… HUBROOM ë¶„ì„ ì™„ë£Œ! ê¸‰ì¦ ì¼€ì´ìŠ¤: {hub_stats['total']}ê°œ")
        
        col1, col2, col3, col4 = st.columns(4)
        total = hub_stats['total'] if hub_stats['total'] > 0 else 1
        col1.metric("OK", f"{hub_stats['ok']}ê°œ", f"{hub_stats['ok']/total*100:.1f}%")
        col2.metric("ì‚¬ì „ê°ì§€", f"{hub_stats['pre']}ê°œ", f"{hub_stats['pre']/total*100:.1f}%")
        col3.metric("NG", f"{hub_stats['ng']}ê°œ", f"{hub_stats['ng']/total*100:.1f}%")
        col4.metric("ì´ ê°ì§€ìœ¨", f"{(hub_stats['ok']+hub_stats['pre'])/total*100:.1f}%")
        
        st.download_button("ğŸ“¥ HUBROOM CSV ë‹¤ìš´ë¡œë“œ", hub_df.to_csv(index=False, encoding='utf-8-sig'), "HUBROOM_ê²°ê³¼.csv", "text/csv")
    
    if m14_file:
        with st.spinner("M14_Q ë¶„ì„ ì¤‘..."):
            df = pd.read_csv(m14_file)
            m14_df, m14_stats = analyze_m14(df.copy(), 1700)
        
        st.success(f"âœ… M14_Q ë¶„ì„ ì™„ë£Œ! ê¸‰ì¦ ì¼€ì´ìŠ¤: {m14_stats['total']}ê°œ")
        
        col1, col2, col3, col4 = st.columns(4)
        total = m14_stats['total'] if m14_stats['total'] > 0 else 1
        col1.metric("OK", f"{m14_stats['ok']}ê°œ", f"{m14_stats['ok']/total*100:.1f}%")
        col2.metric("ì‚¬ì „ê°ì§€", f"{m14_stats['pre']}ê°œ", f"{m14_stats['pre']/total*100:.1f}%")
        col3.metric("NG", f"{m14_stats['ng']}ê°œ", f"{m14_stats['ng']/total*100:.1f}%")
        col4.metric("ì´ ê°ì§€ìœ¨", f"{(m14_stats['ok']+m14_stats['pre'])/total*100:.1f}%")
        
        st.download_button("ğŸ“¥ M14_Q CSV ë‹¤ìš´ë¡œë“œ", m14_df.to_csv(index=False, encoding='utf-8-sig'), "M14_ê²°ê³¼.csv", "text/csv")
    
    # HTML ë¦¬í¬íŠ¸ ìƒì„±
    if hub_stats or m14_stats:
        st.markdown("---")
        st.subheader("ğŸ“„ HTML ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ")
        html_report = generate_html_report(hub_stats, m14_stats, hub_df, m14_df)
        st.download_button(
            "ğŸ“¥ HTML ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ",
            html_report,
            f"ê¸‰ì¦ê°ì§€_ë¶„ì„ë¦¬í¬íŠ¸_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html",
            "text/html",
            use_container_width=True
        )