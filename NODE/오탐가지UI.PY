import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import pandas as pd
from datetime import datetime
import webbrowser
import os

class SurgeAnalyzer:
    def __init__(self, root):
        self.root = root
        self.root.title("ê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ V8")
        self.root.geometry("800x600")
        self.root.configure(bg='#1a1a2e')
        
        self.hub_file = None
        self.m14_file = None
        self.hub_df = None
        self.m14_df = None
        self.hub_stats = None
        self.m14_stats = None
        
        self.setup_ui()
    
    def setup_ui(self):
        # ìŠ¤íƒ€ì¼ ì„¤ì •
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TFrame', background='#1a1a2e')
        style.configure('TLabel', background='#1a1a2e', foreground='white', font=('ë§‘ì€ ê³ ë”•', 10))
        style.configure('Title.TLabel', font=('ë§‘ì€ ê³ ë”•', 24, 'bold'), foreground='#00d4ff')
        style.configure('Sub.TLabel', font=('ë§‘ì€ ê³ ë”•', 12), foreground='#888888')
        style.configure('TButton', font=('ë§‘ì€ ê³ ë”•', 11, 'bold'), padding=10)
        
        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)
        
        # íƒ€ì´í‹€
        ttk.Label(main_frame, text="ğŸ“Š ê¸‰ì¦ ê°ì§€ ë¶„ì„ ì‹œìŠ¤í…œ", style='Title.TLabel').pack(pady=(0, 5))
        ttk.Label(main_frame, text="HUBROOM V8.0 | M14_Q V8.3.1", style='Sub.TLabel').pack(pady=(0, 30))
        
        # íŒŒì¼ ì—…ë¡œë“œ í”„ë ˆì„
        upload_frame = ttk.Frame(main_frame)
        upload_frame.pack(fill=tk.X, pady=10)
        
        # HUBROOM
        hub_frame = tk.Frame(upload_frame, bg='#252540', relief='ridge', bd=2)
        hub_frame.pack(fill=tk.X, pady=10, ipady=15, ipadx=15)
        
        tk.Label(hub_frame, text="ğŸ  HUBROOM V8.0", font=('ë§‘ì€ ê³ ë”•', 14, 'bold'), 
                 bg='#252540', fg='#00d4ff').pack(anchor='w', padx=10, pady=(10,5))
        tk.Label(hub_frame, text="ê¸°ì¤€ê°’: 350 | ì»¬ëŸ¼: í˜„ì¬ê°’, ì‹¤ì œê°’, ì˜ˆì¸¡ê°’_MAX", 
                 font=('ë§‘ì€ ê³ ë”•', 9), bg='#252540', fg='#888888').pack(anchor='w', padx=10)
        
        hub_btn_frame = tk.Frame(hub_frame, bg='#252540')
        hub_btn_frame.pack(fill=tk.X, padx=10, pady=10)
        
        tk.Button(hub_btn_frame, text="ğŸ“ íŒŒì¼ ì„ íƒ", command=self.select_hub_file,
                  font=('ë§‘ì€ ê³ ë”•', 10), bg='#00d4ff', fg='black', width=15).pack(side=tk.LEFT)
        self.hub_label = tk.Label(hub_btn_frame, text="íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", 
                                   font=('ë§‘ì€ ê³ ë”•', 9), bg='#252540', fg='#888888')
        self.hub_label.pack(side=tk.LEFT, padx=15)
        
        # M14_Q
        m14_frame = tk.Frame(upload_frame, bg='#252540', relief='ridge', bd=2)
        m14_frame.pack(fill=tk.X, pady=10, ipady=15, ipadx=15)
        
        tk.Label(m14_frame, text="ğŸ­ M14_Q V8.3.1", font=('ë§‘ì€ ê³ ë”•', 14, 'bold'), 
                 bg='#252540', fg='#ff6b35').pack(anchor='w', padx=10, pady=(10,5))
        tk.Label(m14_frame, text="ê¸°ì¤€ê°’: 1700 | ì»¬ëŸ¼: í˜„ì¬TOTALCNT, ì‹¤ì œê°’, ìµœì¢…ì˜ˆì¸¡", 
                 font=('ë§‘ì€ ê³ ë”•', 9), bg='#252540', fg='#888888').pack(anchor='w', padx=10)
        
        m14_btn_frame = tk.Frame(m14_frame, bg='#252540')
        m14_btn_frame.pack(fill=tk.X, padx=10, pady=10)
        
        tk.Button(m14_btn_frame, text="ğŸ“ íŒŒì¼ ì„ íƒ", command=self.select_m14_file,
                  font=('ë§‘ì€ ê³ ë”•', 10), bg='#ff6b35', fg='black', width=15).pack(side=tk.LEFT)
        self.m14_label = tk.Label(m14_btn_frame, text="íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", 
                                   font=('ë§‘ì€ ê³ ë”•', 9), bg='#252540', fg='#888888')
        self.m14_label.pack(side=tk.LEFT, padx=15)
        
        # ë¶„ì„ ë²„íŠ¼
        tk.Button(main_frame, text="ğŸ” ë¶„ì„ ì‹œì‘", command=self.run_analysis,
                  font=('ë§‘ì€ ê³ ë”•', 14, 'bold'), bg='#00ff88', fg='black',
                  width=30, height=2).pack(pady=30)
        
        # ê²°ê³¼ ì˜ì—­
        self.result_frame = tk.Frame(main_frame, bg='#1a1a2e')
        self.result_frame.pack(fill=tk.BOTH, expand=True)
        
        self.result_text = tk.Text(self.result_frame, font=('Consolas', 10), 
                                    bg='#0d0d15', fg='white', height=12,
                                    relief='flat', padx=15, pady=15)
        self.result_text.pack(fill=tk.BOTH, expand=True)
        self.result_text.insert(tk.END, "CSV íŒŒì¼ì„ ì„ íƒí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”...")
        self.result_text.config(state=tk.DISABLED)
        
        # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í”„ë ˆì„
        self.download_frame = tk.Frame(main_frame, bg='#1a1a2e')
        self.download_frame.pack(fill=tk.X, pady=15)
    
    def select_hub_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.hub_file = file
            self.hub_label.config(text=f"âœ… {os.path.basename(file)}", fg='#00ff88')
    
    def select_m14_file(self):
        file = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if file:
            self.m14_file = file
            self.m14_label.config(text=f"âœ… {os.path.basename(file)}", fg='#00ff88')
    
    def analyze_hubroom(self, df, threshold=350):
        drop_cols = ['Unnamed: 22', 'Unnamed: 23']
        for col in drop_cols:
            if col in df.columns:
                df = df.drop(columns=[col])
        
        df['ì‚¬ì „ê°ì§€OK_NG'] = ''
        surge_condition = (df['ì‹¤ì œê°’'] >= threshold) & (df['í˜„ì¬ê°’'] <= threshold)
        df.loc[surge_condition, 'ì‚¬ì „ê°ì§€OK_NG'] = 'Y'
        
        df['ì‚¬ì „ê°ì§€ê²°ê³¼'] = ''
        ok_condition = surge_condition & (df['ì˜ˆì¸¡ê°’_MAX'] >= threshold)
        df.loc[ok_condition, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'OK'
        
        ng_condition = surge_condition & (df['ì˜ˆì¸¡ê°’_MAX'] < threshold)
        ng_indices = df[ng_condition].index.tolist()
        
        for idx in ng_indices:
            found = False
            for back in range(1, 6):
                prev_idx = idx - back
                if prev_idx >= 0:
                    prev_pred = df.loc[prev_idx, 'ì˜ˆì¸¡ê°’_MAX']
                    if prev_pred >= threshold:
                        df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = f'ì‚¬ì „ê°ì§€({back}ë¶„ì „)'
                        found = True
                        break
            if not found:
                df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'NG'
        
        df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = ''
        fp_condition = (df['ì‹¤ì œê°’'] < threshold) & (df['ì˜ˆì¸¡ê°’_MAX'] >= threshold)
        fp_indices = df[fp_condition].index.tolist()
        
        for idx in fp_indices:
            found = False
            for offset in range(-5, 6):
                if offset == 0:
                    continue
                check_idx = idx + offset
                if 0 <= check_idx < len(df):
                    if df.loc[check_idx, 'ì‹¤ì œê°’'] >= threshold:
                        df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒì‚¬ì „ê°ì§€'
                        found = True
                        break
            if not found:
                df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒ'
        
        cols = df.columns.tolist()
        cols.remove('ì‚¬ì „ê°ì§€OK_NG')
        cols.remove('ì‚¬ì „ê°ì§€ê²°ê³¼')
        cols.remove('ì˜¤íƒ/ì‚¬ì „ê°ì§€')
        actual_idx = cols.index('ì‹¤ì œê°’')
        new_cols = cols[:actual_idx+1] + ['ì‚¬ì „ê°ì§€OK_NG', 'ì‚¬ì „ê°ì§€ê²°ê³¼', 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] + cols[actual_idx+1:]
        df = df[new_cols]
        
        total_surge = len(df[surge_condition])
        ok_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'OK'])
        pre_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'].str.contains('ì‚¬ì „ê°ì§€', na=False)])
        ng_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'NG'])
        fp_total = len(fp_indices)
        fp_pre = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒì‚¬ì „ê°ì§€'])
        fp_real = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒ'])
        
        return df, {
            'total': total_surge, 'ok': ok_cnt, 'pre': pre_cnt, 'ng': ng_cnt,
            'fp_total': fp_total, 'fp_pre': fp_pre, 'fp_real': fp_real
        }
    
    def analyze_m14(self, df, threshold=1700):
        drop_cols = ['12ë¶„ì „TOTALCNT', '12ë³€í™”ëŸ‰', 'Unnamed: 22', 'Unnamed: 23']
        for col in drop_cols:
            if col in df.columns:
                df = df.drop(columns=[col])
        
        df['ì‚¬ì „ê°ì§€OK_NG'] = ''
        surge_condition = (df['ì‹¤ì œê°’'] >= threshold) & (df['í˜„ì¬TOTALCNT'] <= threshold)
        df.loc[surge_condition, 'ì‚¬ì „ê°ì§€OK_NG'] = 'Y'
        
        df['ì‚¬ì „ê°ì§€ê²°ê³¼'] = ''
        ok_condition = surge_condition & (df['ìµœì¢…ì˜ˆì¸¡'] >= threshold)
        df.loc[ok_condition, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'OK'
        
        ng_condition = surge_condition & (df['ìµœì¢…ì˜ˆì¸¡'] < threshold)
        ng_indices = df[ng_condition].index.tolist()
        
        for idx in ng_indices:
            found = False
            for back in range(1, 6):
                prev_idx = idx - back
                if prev_idx >= 0:
                    prev_pred = df.loc[prev_idx, 'ìµœì¢…ì˜ˆì¸¡']
                    if prev_pred >= threshold:
                        df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = f'ì‚¬ì „ê°ì§€({back}ë¶„ì „)'
                        found = True
                        break
            if not found:
                df.loc[idx, 'ì‚¬ì „ê°ì§€ê²°ê³¼'] = 'NG'
        
        df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = ''
        fp_condition = (df['ì‹¤ì œê°’'] < threshold) & (df['ìµœì¢…ì˜ˆì¸¡'] >= threshold)
        fp_indices = df[fp_condition].index.tolist()
        
        for idx in fp_indices:
            found = False
            for offset in range(-5, 6):
                if offset == 0:
                    continue
                check_idx = idx + offset
                if 0 <= check_idx < len(df):
                    if df.loc[check_idx, 'ì‹¤ì œê°’'] >= threshold:
                        df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒì‚¬ì „ê°ì§€'
                        found = True
                        break
            if not found:
                df.loc[idx, 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] = 'ì˜¤íƒ'
        
        cols = df.columns.tolist()
        cols.remove('ì‚¬ì „ê°ì§€OK_NG')
        cols.remove('ì‚¬ì „ê°ì§€ê²°ê³¼')
        cols.remove('ì˜¤íƒ/ì‚¬ì „ê°ì§€')
        actual_idx = cols.index('ì‹¤ì œê°’')
        new_cols = cols[:actual_idx+1] + ['ì‚¬ì „ê°ì§€OK_NG', 'ì‚¬ì „ê°ì§€ê²°ê³¼', 'ì˜¤íƒ/ì‚¬ì „ê°ì§€'] + cols[actual_idx+1:]
        df = df[new_cols]
        
        total_surge = len(df[surge_condition])
        ok_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'OK'])
        pre_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'].str.contains('ì‚¬ì „ê°ì§€', na=False)])
        ng_cnt = len(df[df['ì‚¬ì „ê°ì§€ê²°ê³¼'] == 'NG'])
        fp_total = len(fp_indices)
        fp_pre = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒì‚¬ì „ê°ì§€'])
        fp_real = len(df[df['ì˜¤íƒ/ì‚¬ì „ê°ì§€'] == 'ì˜¤íƒ'])
        
        return df, {
            'total': total_surge, 'ok': ok_cnt, 'pre': pre_cnt, 'ng': ng_cnt,
            'fp_total': fp_total, 'fp_pre': fp_pre, 'fp_real': fp_real
        }
    
    def run_analysis(self):
        if not self.hub_file and not self.m14_file:
            messagebox.showwarning("ê²½ê³ ", "CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!")
            return
        
        result_text = ""
        
        try:
            if self.hub_file:
                df = pd.read_csv(self.hub_file, encoding='utf-8-sig')
                self.hub_df, self.hub_stats = self.analyze_hubroom(df.copy(), 350)
                result_text += self.format_result("HUBROOM V8.0", self.hub_stats, 350)
            
            if self.m14_file:
                df = pd.read_csv(self.m14_file, encoding='utf-8-sig')
                self.m14_df, self.m14_stats = self.analyze_m14(df.copy(), 1700)
                result_text += self.format_result("M14_Q V8.3.1", self.m14_stats, 1700)
            
            # ê²°ê³¼ í‘œì‹œ
            self.result_text.config(state=tk.NORMAL)
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, result_text)
            self.result_text.config(state=tk.DISABLED)
            
            # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
            for widget in self.download_frame.winfo_children():
                widget.destroy()
            
            if self.hub_df is not None:
                tk.Button(self.download_frame, text="ğŸ“¥ HUBROOM CSV", command=self.save_hub_csv,
                          font=('ë§‘ì€ ê³ ë”•', 10), bg='#00d4ff', fg='black').pack(side=tk.LEFT, padx=5)
            
            if self.m14_df is not None:
                tk.Button(self.download_frame, text="ğŸ“¥ M14_Q CSV", command=self.save_m14_csv,
                          font=('ë§‘ì€ ê³ ë”•', 10), bg='#ff6b35', fg='black').pack(side=tk.LEFT, padx=5)
            
            tk.Button(self.download_frame, text="ğŸ“„ HTML ë¦¬í¬íŠ¸", command=self.save_html,
                      font=('ë§‘ì€ ê³ ë”•', 10, 'bold'), bg='#00ff88', fg='black').pack(side=tk.LEFT, padx=5)
            
            # ìë™ ì €ì¥
            save_dir = filedialog.askdirectory(title="ê²°ê³¼ ì €ì¥í•  í´ë” ì„ íƒ")
            if save_dir:
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                saved_files = []
                
                if self.hub_df is not None:
                    hub_csv = os.path.join(save_dir, f"HUBROOM_ê²°ê³¼_{timestamp}.csv")
                    self.hub_df.to_csv(hub_csv, index=False, encoding='utf-8-sig')
                    saved_files.append(hub_csv)
                
                if self.m14_df is not None:
                    m14_csv = os.path.join(save_dir, f"M14_ê²°ê³¼_{timestamp}.csv")
                    self.m14_df.to_csv(m14_csv, index=False, encoding='utf-8-sig')
                    saved_files.append(m14_csv)
                
                # HTML ë¦¬í¬íŠ¸ ì €ì¥
                html_file = os.path.join(save_dir, f"ê¸‰ì¦ê°ì§€_ë¦¬í¬íŠ¸_{timestamp}.html")
                html = self.generate_html()
                with open(html_file, 'w', encoding='utf-8') as f:
                    f.write(html)
                saved_files.append(html_file)
                
                # ë¸Œë¼ìš°ì €ì—ì„œ HTML ì—´ê¸°
                webbrowser.open(html_file)
                
                messagebox.showinfo("ì™„ë£Œ", f"ë¶„ì„ ì™„ë£Œ!\n\nì €ì¥ëœ íŒŒì¼:\n" + "\n".join(saved_files))
            else:
                messagebox.showinfo("ì™„ë£Œ", "ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n(ì €ì¥ ì·¨ì†Œë¨)")
            
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n{str(e)}")
    
    def format_result(self, name, stats, threshold):
        total = stats['total'] if stats['total'] > 0 else 1
        fp_total = stats['fp_total'] if stats['fp_total'] > 0 else 1
        
        return f"""
{'='*50}
  {name} (ê¸°ì¤€: {threshold})
{'='*50}

[ ê¸‰ì¦ ê°ì§€ ê²°ê³¼ ]
  ê¸‰ì¦ ì¼€ì´ìŠ¤: {stats['total']}ê°œ
  OK: {stats['ok']}ê°œ ({stats['ok']/total*100:.1f}%)
  ì‚¬ì „ê°ì§€: {stats['pre']}ê°œ ({stats['pre']/total*100:.1f}%)
  NG: {stats['ng']}ê°œ ({stats['ng']/total*100:.1f}%)
  ì´ ê°ì§€ìœ¨: {(stats['ok']+stats['pre'])/total*100:.1f}%

[ ì˜¤íƒ ë¶„ì„ ]
  ì˜¤íƒ í›„ë³´: {stats['fp_total']}ê°œ
  ì˜¤íƒì‚¬ì „ê°ì§€: {stats['fp_pre']}ê°œ ({stats['fp_pre']/fp_total*100:.1f}%)
  ì˜¤íƒ: {stats['fp_real']}ê°œ ({stats['fp_real']/fp_total*100:.1f}%)

"""
    
    def save_hub_csv(self):
        file = filedialog.asksaveasfilename(defaultextension=".csv", initialfile="HUBROOM_ê²°ê³¼.csv",
                                             filetypes=[("CSV files", "*.csv")])
        if file:
            self.hub_df.to_csv(file, index=False, encoding='utf-8-sig')
            messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"ì €ì¥ë¨: {file}")
    
    def save_m14_csv(self):
        file = filedialog.asksaveasfilename(defaultextension=".csv", initialfile="M14_ê²°ê³¼.csv",
                                             filetypes=[("CSV files", "*.csv")])
        if file:
            self.m14_df.to_csv(file, index=False, encoding='utf-8-sig')
            messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"ì €ì¥ë¨: {file}")
    
    def save_html(self):
        file = filedialog.asksaveasfilename(
            defaultextension=".html", 
            initialfile=f"ê¸‰ì¦ê°ì§€_ë¦¬í¬íŠ¸_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html",
            filetypes=[("HTML files", "*.html")]
        )
        if file:
            html = self.generate_html()
            with open(file, 'w', encoding='utf-8') as f:
                f.write(html)
            messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"ì €ì¥ë¨: {file}")
            webbrowser.open(file)
    
    def generate_html(self):
        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        def calc_rates(stats):
            total = stats['total'] if stats['total'] > 0 else 1
            fp_total = stats['fp_total'] if stats['fp_total'] > 0 else 1
            return {
                'ok_rate': stats['ok'] / total * 100,
                'pre_rate': stats['pre'] / total * 100,
                'ng_rate': stats['ng'] / total * 100,
                'detect_rate': (stats['ok'] + stats['pre']) / total * 100,
                'fp_pre_rate': stats['fp_pre'] / fp_total * 100,
                'fp_real_rate': stats['fp_real'] / fp_total * 100
            }
        
        html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: 'ë§‘ì€ ê³ ë”•', sans-serif; background: #0a0a0f; color: white; padding: 40px; }}
        .container {{ max-width: 1200px; margin: 0 auto; }}
        h1 {{ font-size: 2.5rem; text-align: center; background: linear-gradient(135deg, #00d4ff, #ff6b35); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }}
        .subtitle {{ text-align: center; color: #888; margin-bottom: 40px; }}
        .section {{ margin-bottom: 50px; }}
        .section-title {{ font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333; }}
        .section-title.hub {{ color: #00d4ff; border-color: #00d4ff; }}
        .section-title.m14 {{ color: #ff6b35; border-color: #ff6b35; }}
        .grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }}
        .card {{ background: #12121a; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #2a2a3a; }}
        .card-label {{ font-size: 0.8rem; color: #888; margin-bottom: 8px; }}
        .card-value {{ font-size: 2rem; font-weight: bold; }}
        .card-sub {{ font-size: 0.85rem; color: #888; margin-top: 5px; }}
        .success {{ color: #00ff88; }}
        .warning {{ color: #ffcc00; }}
        .danger {{ color: #ff4466; }}
        .hub-color {{ color: #00d4ff; }}
        .m14-color {{ color: #ff6b35; }}
        .chart-grid {{ display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }}
        .chart-box {{ background: #12121a; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3a; }}
        .chart-title {{ font-size: 1rem; margin-bottom: 15px; }}
        .chart-wrapper {{ height: 250px; }}
        .summary {{ background: #12121a; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3a; }}
        .summary pre {{ font-family: Consolas, monospace; white-space: pre-wrap; color: #aaa; line-height: 1.6; }}
        @media (max-width: 768px) {{ .chart-grid {{ grid-template-columns: 1fr; }} }}
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š ê¸‰ì¦ ê°ì§€ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
    <p class="subtitle">ìƒì„±: {now}</p>
'''
        
        if self.hub_stats and self.hub_stats['total'] > 0:
            r = calc_rates(self.hub_stats)
            s = self.hub_stats
            html += f'''
    <div class="section">
        <h2 class="section-title hub">ğŸ  HUBROOM V8.0</h2>
        <div class="grid">
            <div class="card"><div class="card-label">ê¸‰ì¦ ì¼€ì´ìŠ¤</div><div class="card-value hub-color">{s['total']}</div></div>
            <div class="card"><div class="card-label">ì´ ê°ì§€ìœ¨</div><div class="card-value success">{r['detect_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">OK</div><div class="card-value success">{s['ok']}</div><div class="card-sub">{r['ok_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">ì‚¬ì „ê°ì§€</div><div class="card-value warning">{s['pre']}</div><div class="card-sub">{r['pre_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">NG</div><div class="card-value danger">{s['ng']}</div><div class="card-sub">{r['ng_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">ì˜¤íƒ</div><div class="card-value danger">{s['fp_real']}</div><div class="card-sub">{r['fp_real_rate']:.1f}%</div></div>
        </div>
        <div class="chart-grid">
            <div class="chart-box"><div class="chart-title">ğŸ“ˆ ê°ì§€ ë¶„í¬</div><div class="chart-wrapper"><canvas id="hubPie"></canvas></div></div>
            <div class="chart-box"><div class="chart-title">ğŸ“‰ ì˜¤íƒ ë¶„ì„</div><div class="chart-wrapper"><canvas id="hubFp"></canvas></div></div>
        </div>
        <div class="summary"><pre>=== HUBROOM V8.0 ìš”ì•½ (ê¸°ì¤€: 350) ===
ê¸‰ì¦ ì¼€ì´ìŠ¤: {s['total']}ê°œ | OK: {s['ok']}ê°œ ({r['ok_rate']:.1f}%) | ì‚¬ì „ê°ì§€: {s['pre']}ê°œ ({r['pre_rate']:.1f}%) | NG: {s['ng']}ê°œ ({r['ng_rate']:.1f}%)
ì´ ê°ì§€ìœ¨: {r['detect_rate']:.1f}% | ì˜¤íƒ: {s['fp_real']}ê°œ/{s['fp_total']}ê°œ ({r['fp_real_rate']:.1f}%)</pre></div>
    </div>
'''
        
        if self.m14_stats and self.m14_stats['total'] > 0:
            r = calc_rates(self.m14_stats)
            s = self.m14_stats
            html += f'''
    <div class="section">
        <h2 class="section-title m14">ğŸ­ M14_Q V8.3.1</h2>
        <div class="grid">
            <div class="card"><div class="card-label">ê¸‰ì¦ ì¼€ì´ìŠ¤</div><div class="card-value m14-color">{s['total']}</div></div>
            <div class="card"><div class="card-label">ì´ ê°ì§€ìœ¨</div><div class="card-value success">{r['detect_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">OK</div><div class="card-value success">{s['ok']}</div><div class="card-sub">{r['ok_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">ì‚¬ì „ê°ì§€</div><div class="card-value warning">{s['pre']}</div><div class="card-sub">{r['pre_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">NG</div><div class="card-value danger">{s['ng']}</div><div class="card-sub">{r['ng_rate']:.1f}%</div></div>
            <div class="card"><div class="card-label">ì˜¤íƒ</div><div class="card-value danger">{s['fp_real']}</div><div class="card-sub">{r['fp_real_rate']:.1f}%</div></div>
        </div>
        <div class="chart-grid">
            <div class="chart-box"><div class="chart-title">ğŸ“ˆ ê°ì§€ ë¶„í¬</div><div class="chart-wrapper"><canvas id="m14Pie"></canvas></div></div>
            <div class="chart-box"><div class="chart-title">ğŸ“‰ ì˜¤íƒ ë¶„ì„</div><div class="chart-wrapper"><canvas id="m14Fp"></canvas></div></div>
        </div>
        <div class="summary"><pre>=== M14_Q V8.3.1 ìš”ì•½ (ê¸°ì¤€: 1700) ===
ê¸‰ì¦ ì¼€ì´ìŠ¤: {s['total']}ê°œ | OK: {s['ok']}ê°œ ({r['ok_rate']:.1f}%) | ì‚¬ì „ê°ì§€: {s['pre']}ê°œ ({r['pre_rate']:.1f}%) | NG: {s['ng']}ê°œ ({r['ng_rate']:.1f}%)
ì´ ê°ì§€ìœ¨: {r['detect_rate']:.1f}% | ì˜¤íƒ: {s['fp_real']}ê°œ/{s['fp_total']}ê°œ ({r['fp_real_rate']:.1f}%)</pre></div>
    </div>
'''
        
        html += '''
</div>
<script>
const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } };
'''
        
        if self.hub_stats and self.hub_stats['total'] > 0:
            s = self.hub_stats
            html += f'''
new Chart(document.getElementById('hubPie'), {{ type: 'doughnut', data: {{ labels: ['OK','ì‚¬ì „ê°ì§€','NG'], datasets: [{{ data: [{s['ok']},{s['pre']},{s['ng']}], backgroundColor: ['#00ff88','#ffcc00','#ff4466'] }}] }}, options: opts }});
new Chart(document.getElementById('hubFp'), {{ type: 'doughnut', data: {{ labels: ['ì˜¤íƒì‚¬ì „ê°ì§€','ì˜¤íƒ'], datasets: [{{ data: [{s['fp_pre']},{s['fp_real']}], backgroundColor: ['#ffcc00','#ff4466'] }}] }}, options: opts }});
'''
        
        if self.m14_stats and self.m14_stats['total'] > 0:
            s = self.m14_stats
            html += f'''
new Chart(document.getElementById('m14Pie'), {{ type: 'doughnut', data: {{ labels: ['OK','ì‚¬ì „ê°ì§€','NG'], datasets: [{{ data: [{s['ok']},{s['pre']},{s['ng']}], backgroundColor: ['#00ff88','#ffcc00','#ff4466'] }}] }}, options: opts }});
new Chart(document.getElementById('m14Fp'), {{ type: 'doughnut', data: {{ labels: ['ì˜¤íƒì‚¬ì „ê°ì§€','ì˜¤íƒ'], datasets: [{{ data: [{s['fp_pre']},{s['fp_real']}], backgroundColor: ['#ffcc00','#ff4466'] }}] }}, options: opts }});
'''
        
        html += '''
</script>
</body>
</html>'''
        
        return html


if __name__ == "__main__":
    root = tk.Tk()
    app = SurgeAnalyzer(root)
    root.mainloop()