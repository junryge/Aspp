# ========================================
# V4 ê·¹ë‹¨ê°’ ì†ì‹¤ í•¨ìˆ˜ (False Positive ë°©ì§€) - ìˆ˜ì • ì™„ë£Œ
# ========================================

class ExtremeLossV4(keras.losses.Loss):
    def __init__(self, extreme_focus=True):
        super().__init__()
        self.extreme_focus = extreme_focus
        
    def call(self, y_true, y_pred):
        # â­ ì¶”ê°€: shape ë§ì¶”ê¸°
        y_pred = tf.reshape(y_pred, tf.shape(y_true))
        
        error = y_true - y_pred
        mae = tf.abs(error)
        
        if self.extreme_focus:
            # V4: 335+ ê·¹ë‹¨ê°’ì— ë” ê°•í•œ í˜ë„í‹°
            weights = tf.where(y_true >= 0.9, 25.0,    # 335+ (ì •ê·œí™” ê¸°ì¤€)
                     tf.where(y_true >= 0.8, 15.0,     # 310-335
                     tf.where(y_true >= 0.7, 8.0,      # 300-310
                     tf.where(y_true >= 0.5, 3.0,      # 250-300
                              1.0))))                    # ë‚˜ë¨¸ì§€
            
            # ê·¹ë‹¨ê°’ ë¯¸íƒì§€ ì¶”ê°€ í˜ë„í‹° (False Negative)
            miss_penalty = tf.where(
                tf.logical_and(y_true >= 0.9, y_pred < 0.85),
                30.0 * mae,  # 335+ ë¯¸íƒì§€ ì‹œ ê°•ë ¥í•œ í˜ë„í‹°
                0.0
            )
            
            # False Positive ë°©ì§€ í˜ë„í‹° (300 ì´í•˜ë¥¼ 300 ì´ìƒìœ¼ë¡œ ì˜ˆì¸¡)
            false_positive_penalty = tf.where(
                tf.logical_and(y_true < 0.7, y_pred >= 0.7),  # 300 ì´í•˜ë¥¼ 300+ ì˜ˆì¸¡
                20.0 * mae,  # ì˜¤íƒ í˜ë„í‹°
                0.0
            )
            
            # íŠ¹íˆ 200-250 êµ¬ê°„ì„ 300+ë¡œ ì˜ˆì¸¡í•˜ë©´ ë” ê°•í•œ í˜ë„í‹°
            severe_fp_penalty = tf.where(
                tf.logical_and(y_true < 0.5, y_pred >= 0.7),  # 250 ì´í•˜ë¥¼ 300+ ì˜ˆì¸¡
                35.0 * mae,  # ì‹¬ê°í•œ ì˜¤íƒ í˜ë„í‹°
                0.0
            )
            
            # â­ ìˆ˜ì •: reduce_mean ì œê±°
            loss = weights * mae + miss_penalty + false_positive_penalty + severe_fp_penalty
            return loss  # ê·¸ëŒ€ë¡œ ë°˜í™˜
            
        else:
            # Model 1: ê· í˜•ì¡íŒ ê°€ì¤‘ì¹˜ + ê²½ë¯¸í•œ ì˜¤íƒ ë°©ì§€
            weights = tf.where(y_true >= 0.7, 5.0,
                     tf.where(y_true >= 0.5, 2.0, 1.0))
            
            # Model 1ì—ë„ ê²½ë¯¸í•œ ì˜¤íƒ ë°©ì§€
            fp_penalty = tf.where(
                tf.logical_and(y_true < 0.6, y_pred >= 0.7),
                5.0 * mae,
                0.0
            )
            
            # â­ ìˆ˜ì •: reduce_mean ì œê±°
            loss = weights * mae + fp_penalty
            return loss  # ê·¸ëŒ€ë¡œ ë°˜í™˜




def main():
    # ì²´í¬í¬ì¸íŠ¸ ê´€ë¦¬ì
    ckpt = CheckpointManager()
    
    # ì´ì „ ìƒíƒœ í™•ì¸
    state = ckpt.load_state()
    
    if state:
        print(f"\nğŸ“‚ ì´ì „ í•™ìŠµ ìƒíƒœ ë°œê²¬! (Step {state.get('step', 1)})")
        
        resume = input("ì´ì–´ì„œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y: ì´ì–´ì„œ, n: ì²˜ìŒë¶€í„°): ").lower()
        
        if resume != 'y':
            ckpt.clear_state()
            state = {}  # â­ ìˆ˜ì •: None â†’ {}
            step = 1
        else:
            step = state.get('step', 1)
            print(f"âœ… Step {step}ë¶€í„° ì¬ê°œí•©ë‹ˆë‹¤.")
    else:
        state = {}
        step = 1
        print("\nì´ì „ í•™ìŠµ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.")
        input("Enterë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”...")
    
    # ë°ì´í„° ì²˜ë¦¬ê¸°
    processor = DataProcessorV4()
    
    # ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ...