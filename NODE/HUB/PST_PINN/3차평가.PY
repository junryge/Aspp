# -*- coding: utf-8 -*-
import pandas as pd
import numpy as np
import torch
import joblib
from tqdm import tqdm
import os

# ======================================================================================
# [ CONFIG ] : 2ê°œ ëª¨ë¸ ë° ë°ì´í„° ê²½ë¡œ ì„¤ì • (âš ï¸ ì‚¬ìš© ì „ ë°˜ë“œì‹œ í™•ì¸ ë° ìˆ˜ì •!)
# ======================================================================================
# --- ê³µí†µ ì„¤ì • ---
# 1. í‰ê°€í•  ë°ì´í„° íŒŒì¼ ê²½ë¡œ
FILE_PATH = 'DATA/20250801_20250831.CSV'

# 2. í•™ìŠµ ë°ì´í„°ì— ì‚¬ìš©í–ˆë˜ ìŠ¤ì¼€ì¼ëŸ¬ íŒŒì¼ ê²½ë¡œ (ë‘ ëª¨ë¸ì´ ë™ì¼í•œ ìŠ¤ì¼€ì¼ëŸ¬ë¥¼ ì‚¬ìš©í–ˆë‹¤ê³  ê°€ì •)
SCALER_PATH = 'models/scaler.pkl'

# 3. ì˜ˆì¸¡ ê²°ê³¼ê°€ ì €ì¥ë  íŒŒì¼ ê²½ë¡œ
OUTPUT_PATH = 'results/comparison_predictions_202508.csv'

# --- ëª¨ë¸ 1 (V3) ì„¤ì • ---
MODEL_1_NAME = 'V3'
MODEL_1_PATH = 'models/v3_model.pth' # âš ï¸ V3 ëª¨ë¸ ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •

# --- ëª¨ë¸ 2 (PINN) ì„¤ì • ---
MODEL_2_NAME = 'PatchTST_PINN'
MODEL_2_PATH = 'models/patchtst_pinn_model.pth' # âš ï¸ PINN ëª¨ë¸ ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •

# --- ë°ì´í„° ì…ì¶œë ¥ ì„¤ì • ---
LOOKBACK_WINDOW = 20  # ê³¼ê±° 20ë¶„
FORECAST_HORIZON = 10 # 10ë¶„ í›„ ì˜ˆì¸¡

# --- í”¼ì²˜ ì»¬ëŸ¼ ì„¤ì • (ë‘ ëª¨ë¸ì´ ë™ì¼í•œ í”¼ì²˜ë¥¼ ì‚¬ìš©í–ˆë‹¤ê³  ê°€ì •) ---
FEATURE_COLUMNS = [
    'CURRENT_M16A_3F_JOB_2', 'M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2',
    'M14A_3F_TO_HUB_JOB2', 'M14B_7F_TO_HUB_JOB2', 'M16A_3F_TO_M16A_6F_JOB',
    'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB', 'M16A_3F_TO_M14B_7F_JOB',
    'M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD', 'M16A_3F_STORAGE_UTIL', 'BRIDGE_TIME'
]
TARGET_COLUMN = 'CURRENT_M16A_3F_JOB_2'
# ======================================================================================


def generate_comparison_predictions():
    """
    2ê°œì˜ í•™ìŠµëœ ëª¨ë¸ì„ ë¡œë“œí•˜ì—¬ í‰ê°€ ë°ì´í„°ì…‹ì— ëŒ€í•œ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•˜ê³  ë¹„êµ ê²°ê³¼ë¥¼ CSVë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    """
    print("="*50)
    print("2ê°œ ëª¨ë¸ ë¹„êµ í‰ê°€ìš© ì˜ˆì¸¡ ë°ì´í„° ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.")
    print("="*50)

    # --- 1. í•„ìˆ˜ íŒŒì¼ í™•ì¸ ---
    if not all(map(os.path.exists, [FILE_PATH, MODEL_1_PATH, MODEL_2_PATH, SCALER_PATH])):
        print("âŒ ì˜¤ë¥˜: í•„ìˆ˜ íŒŒì¼(ë°ì´í„°, ëª¨ë¸ 2ê°œ, ìŠ¤ì¼€ì¼ëŸ¬)ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # --- 2. ëª¨ë¸ ë° ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë”© ---
    try:
        print(f"ğŸ”„ ëª¨ë¸ 1 ({MODEL_1_NAME}) ë¡œë”© ì¤‘... ({MODEL_1_PATH})")
        model_1 = torch.load(MODEL_1_PATH)
        model_1.eval()
        
        print(f"ğŸ”„ ëª¨ë¸ 2 ({MODEL_2_NAME}) ë¡œë”© ì¤‘... ({MODEL_2_PATH})")
        model_2 = torch.load(MODEL_2_PATH)
        model_2.eval()
        
        print(f"ğŸ”„ ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë”© ì¤‘... ({SCALER_PATH})")
        scaler = joblib.load(SCALER_PATH)
        print("âœ… ëª¨ë“  ëª¨ë¸ ë° ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë”© ì™„ë£Œ.")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: ëª¨ë¸ ë˜ëŠ” ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. {e}")
        return

    # --- 3. í‰ê°€ ë°ì´í„° ì¤€ë¹„ ---
    print(f"ğŸ”„ í‰ê°€ ë°ì´í„° ë¡œë”© ë° ì „ì²˜ë¦¬ ì¤‘... ({FILE_PATH})")
    df = pd.read_csv(FILE_PATH, encoding='utf-8-sig')
    df['time'] = pd.to_datetime(df['STAT_DT'].astype(str), format='%Y%m%d%H%M')
    df.set_index('time', inplace=True)
    
    df_features = df[FEATURE_COLUMNS]
    df_scaled = df.copy()
    df_scaled[FEATURE_COLUMNS] = scaler.transform(df_features)
    print("âœ… ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ.")

    # --- 4. ìŠ¬ë¼ì´ë”© ìœˆë„ìš°ë¥¼ ì´ìš©í•œ ì˜ˆì¸¡ ìƒì„± ---
    print("ğŸš€ 2ê°œ ëª¨ë¸ì— ëŒ€í•œ ì˜ˆì¸¡ ë™ì‹œ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    results = []
    
    num_predictions = len(df) - LOOKBACK_WINDOW - FORECAST_HORIZON + 1
    for i in tqdm(range(num_predictions), desc="ì˜ˆì¸¡ ì§„í–‰ë¥ "):
        input_start = i
        input_end = i + LOOKBACK_WINDOW
        input_data = df_scaled.iloc[input_start:input_end][FEATURE_COLUMNS]
        target_time = df.index[input_end + FORECAST_HORIZON - 1]
        
        input_tensor = torch.FloatTensor(input_data.values).unsqueeze(0)

        with torch.no_grad():
            pred_1_scaled = model_1(input_tensor).item()
            pred_2_scaled = model_2(input_tensor).item()

        results.append({
            'timestamp': target_time,
            'prediction_1_scaled': pred_1_scaled,
            'prediction_2_scaled': pred_2_scaled
        })
    print("âœ… ì˜ˆì¸¡ ìƒì„± ì™„ë£Œ.")

    # --- 5. ê²°ê³¼ ë°ì´í„° í›„ì²˜ë¦¬ ë° ì €ì¥ ---
    print("ğŸ”„ ê²°ê³¼ ë°ì´í„° í›„ì²˜ë¦¬ ë° ì €ì¥ ì¤‘...")
    result_df = pd.DataFrame(results)

    # ìŠ¤ì¼€ì¼ ë³µì›ì„ ìœ„í•œ ì„ì‹œ ë°°ì—´ ìƒì„±
    target_idx = FEATURE_COLUMNS.index(TARGET_COLUMN)
    
    # ëª¨ë¸ 1 ì˜ˆì¸¡ ë³µì›
    temp_pred_1 = np.zeros((len(result_df), len(FEATURE_COLUMNS)))
    temp_pred_1[:, target_idx] = result_df['prediction_1_scaled']
    result_df[f'prediction_{MODEL_1_NAME}'] = scaler.inverse_transform(temp_pred_1)[:, target_idx]
    
    # ëª¨ë¸ 2 ì˜ˆì¸¡ ë³µì›
    temp_pred_2 = np.zeros((len(result_df), len(FEATURE_COLUMNS)))
    temp_pred_2[:, target_idx] = result_df['prediction_2_scaled']
    result_df[f'prediction_{MODEL_2_NAME}'] = scaler.inverse_transform(temp_pred_2)[:, target_idx]

    # ì‹¤ì œ ê°’ ë° ì˜¤ì°¨(MAE) ê³„ì‚°
    result_df['true_value'] = result_df['timestamp'].map(df[TARGET_COLUMN])
    result_df[f'MAE_{MODEL_1_NAME}'] = (result_df['true_value'] - result_df[f'prediction_{MODEL_1_NAME}']).abs()
    result_df[f'MAE_{MODEL_2_NAME}'] = (result_df['true_value'] - result_df[f'prediction_{MODEL_2_NAME}']).abs()
    
    # ìµœì¢… ê²°ê³¼ ì»¬ëŸ¼ ì •ë¦¬
    final_cols = [
        'true_value', 
        f'prediction_{MODEL_1_NAME}', 
        f'MAE_{MODEL_1_NAME}', 
        f'prediction_{MODEL_2_NAME}', 
        f'MAE_{MODEL_2_NAME}'
    ]
    final_df = result_df.set_index('timestamp')[final_cols]

    os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=True)
    final_df.to_csv(OUTPUT_PATH, encoding='utf-8-sig')
    
    print("\n" + "="*50)
    print(f"ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¹„êµ ê²°ê³¼ê°€ ì•„ë˜ íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print(f"   - íŒŒì¼ ê²½ë¡œ: {os.path.abspath(OUTPUT_PATH)}")
    print("="*50)
    print("\nìƒì„±ëœ íŒŒì¼ ìƒìœ„ 5ê°œ í–‰:")
    print(final_df.head())


if __name__ == '__main__':
    generate_comparison_predictions()
