# -*- coding: utf-8 -*-
"""
HUBROOM ê·¹ë‹¨ê°’ ì˜ˆì¸¡ ëª¨ë¸ í‰ê°€ - ìˆ˜ì •ë³¸
- í‰ê°€ ë°ì´í„°: 2025ë…„ 8ì›” (20250801_TO_20250831.CSV)
- í•™ìŠµëœ ëª¨ë¸ë¡œ ë°”ë¡œ ì˜ˆì¸¡ (ì‹œí€€ìŠ¤ ìƒì„± X)
"""

import numpy as np
import pandas as pd
import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import joblib
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import os
import warnings
warnings.filterwarnings('ignore')

print("="*80)
print("ğŸ¯ HUBROOM ëª¨ë¸ í‰ê°€ ì‹œìŠ¤í…œ - DIRECT PREDICTION")
print("ğŸ“… í‰ê°€ ë°ì´í„°: 2025ë…„ 8ì›”")
print("="*80)

# ========================================
# Model 1: PatchTST
# ========================================

class PatchTSTModel(keras.Model):
    def __init__(self, config):
        super().__init__()
        
        self.seq_len = config['seq_len']
        self.n_features = config['n_features']
        self.patch_len = config['patch_len']
        self.n_patches = self.seq_len // self.patch_len
        
        self.patch_embedding = layers.Dense(128, activation='relu')
        self.attention = layers.MultiHeadAttention(num_heads=8, key_dim=16)
        self.norm1 = layers.LayerNormalization()
        self.norm2 = layers.LayerNormalization()
        
        self.ffn = keras.Sequential([
            layers.Dense(256, activation='relu'),
            layers.Dropout(0.2),
            layers.Dense(128)
        ])
        
        self.flatten = layers.Flatten()
        self.dense1 = layers.Dense(128, activation='relu')
        self.dropout = layers.Dropout(0.3)
        self.dense2 = layers.Dense(64, activation='relu')
        self.output_layer = layers.Dense(1)
        
    def call(self, x, training=False):
        batch_size = tf.shape(x)[0]
        x = tf.reshape(x, [batch_size, self.n_patches, self.patch_len * self.n_features])
        x = self.patch_embedding(x)
        attn = self.attention(x, x, training=training)
        x = self.norm1(x + attn)
        ffn_out = self.ffn(x)
        x = self.norm2(x + ffn_out)
        x = self.flatten(x)
        x = self.dense1(x)
        x = self.dropout(x, training=training)
        x = self.dense2(x)
        output = self.output_layer(x)
        return tf.squeeze(output, axis=-1)

# ========================================
# Model 2: PatchTST + PINN
# ========================================

class PatchTSTPINN(keras.Model):
    def __init__(self, config):
        super().__init__()
        
        self.seq_len = config['seq_len']
        self.n_features = config['n_features']
        self.patch_len = config['patch_len']
        self.n_patches = self.seq_len // self.patch_len
        
        self.patch_embedding = layers.Dense(128, activation='relu')
        self.attention = layers.MultiHeadAttention(num_heads=8, key_dim=16)
        self.norm = layers.LayerNormalization()
        self.flatten = layers.Flatten()
        self.temporal_dense = layers.Dense(64, activation='relu')
        
        self.physics_net = keras.Sequential([
            layers.Dense(32, activation='relu'),
            layers.BatchNormalization(),
            layers.Dense(16, activation='relu')
        ])
        
        self.fusion = keras.Sequential([
            layers.Dense(64, activation='relu'),
            layers.Dropout(0.3),
            layers.Dense(32, activation='relu'),
            layers.Dense(16, activation='relu'),
            layers.Dense(1)
        ])
        
        self.extreme_boost = layers.Dense(1, activation='sigmoid')
        
    def call(self, inputs, training=False):
        x_seq, x_physics = inputs
        batch_size = tf.shape(x_seq)[0]
        
        x = tf.reshape(x_seq, [batch_size, self.n_patches, self.patch_len * self.n_features])
        x = self.patch_embedding(x)
        attn = self.attention(x, x, training=training)
        x = self.norm(x + attn)
        x = self.flatten(x)
        temporal_features = self.temporal_dense(x)
        
        physics_features = self.physics_net(x_physics)
        combined = tf.concat([temporal_features, physics_features], axis=-1)
        output = self.fusion(combined)
        
        boost_factor = self.extreme_boost(combined)
        output = output * (1 + boost_factor * 0.2)
        
        return tf.squeeze(output, axis=-1)

# ========================================
# ë©”ì¸ í‰ê°€ í•¨ìˆ˜
# ========================================

def evaluate_with_test_data():
    """ì´ë¯¸ ì¤€ë¹„ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ í‰ê°€"""
    
    print("\nğŸ“‚ ì €ì¥ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì¤‘...")
    
    try:
        # í•™ìŠµ ë•Œ ì €ì¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
        X_test_scaled = np.load('./test_data/X_test_scaled.npy')
        y_test_scaled = np.load('./test_data/y_test_scaled.npy')
        y_test = np.load('./test_data/y_test.npy')
        X_physics_test_scaled = np.load('./test_data/X_physics_test_scaled.npy')
        
        print(f"âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
        print(f"  ìƒ˜í”Œ ìˆ˜: {len(y_test)}")
        print(f"  ì…ë ¥ shape: {X_test_scaled.shape}")
        print(f"  ë¬¼ë¦¬ shape: {X_physics_test_scaled.shape}")
        
    except Exception as e:
        print(f"âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
        print("í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
        return None, None
    
    # ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ
    print("\nğŸ”§ ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ ì¤‘...")
    scaler_y = joblib.load('./scalers/scaler_y.pkl')
    print("âœ… ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ ì™„ë£Œ")
    
    # ë°ì´í„° ë¶„ì„
    print(f"\nğŸ“Š í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¶„ì„:")
    print(f"  íƒ€ê²Ÿ ë²”ìœ„: {y_test.min():.0f} ~ {y_test.max():.0f}")
    print(f"  í‰ê· : {y_test.mean():.1f}, ì¤‘ì•™ê°’: {np.median(y_test):.1f}")
    print(f"\n  ê·¹ë‹¨ê°’ ë¶„í¬:")
    print(f"    300+: {(y_test >= 300).sum()}ê°œ ({(y_test >= 300).sum()/len(y_test)*100:.2f}%)")
    print(f"    310+: {(y_test >= 310).sum()}ê°œ ({(y_test >= 310).sum()/len(y_test)*100:.2f}%)")
    print(f"    335+: {(y_test >= 335).sum()}ê°œ ({(y_test >= 335).sum()/len(y_test)*100:.2f}%)")
    
    # ëª¨ë¸ ì„¤ì •
    n_features = X_test_scaled.shape[2]
    config = {
        'seq_len': 20,
        'n_features': n_features,
        'patch_len': 5
    }
    
    # Model 1 ì˜ˆì¸¡
    print("\nğŸ¤– Model 1 (PatchTST) ì˜ˆì¸¡ ì¤‘...")
    model1 = PatchTSTModel(config)
    model1.compile(optimizer='adam', loss='mse')
    dummy_input = np.zeros((1, 20, n_features))
    _ = model1(dummy_input)
    model1.load_weights('./checkpoints/model1_v3.h5')
    
    y_pred1_scaled = model1.predict(X_test_scaled, batch_size=64, verbose=0)
    y_pred1 = scaler_y.inverse_transform(y_pred1_scaled.reshape(-1, 1)).flatten()
    print("âœ… Model 1 ì˜ˆì¸¡ ì™„ë£Œ")
    
    # Model 2 ì˜ˆì¸¡
    print("\nğŸ¤– Model 2 (PatchTST + PINN) ì˜ˆì¸¡ ì¤‘...")
    model2 = PatchTSTPINN(config)
    model2.compile(optimizer='adam', loss='mse')
    dummy_seq = np.zeros((1, 20, n_features))
    dummy_physics = np.zeros((1, 3))
    _ = model2([dummy_seq, dummy_physics])
    model2.load_weights('./checkpoints/model2_v3.h5')
    
    y_pred2_scaled = model2.predict([X_test_scaled, X_physics_test_scaled], batch_size=64, verbose=0)
    y_pred2 = scaler_y.inverse_transform(y_pred2_scaled.reshape(-1, 1)).flatten()
    print("âœ… Model 2 ì˜ˆì¸¡ ì™„ë£Œ")
    
    # ì•™ìƒë¸”
    y_ensemble = 0.4 * y_pred1 + 0.6 * y_pred2
    print("âœ… Ensemble ì˜ˆì¸¡ ì™„ë£Œ")
    
    # ì„±ëŠ¥ í‰ê°€
    print("\n" + "="*80)
    print("ğŸ“ˆ ëª¨ë¸ ì„±ëŠ¥ í‰ê°€")
    print("="*80)
    
    results = []
    
    for model_name, y_pred in [('Model1_PatchTST', y_pred1), 
                               ('Model2_PINN', y_pred2), 
                               ('Ensemble', y_ensemble)]:
        
        mae = mean_absolute_error(y_test, y_pred)
        rmse = np.sqrt(mean_squared_error(y_test, y_pred))
        r2 = r2_score(y_test, y_pred)
        
        print(f"\n[{model_name}]")
        print(f"  MAE: {mae:.2f}")
        print(f"  RMSE: {rmse:.2f}")
        print(f"  R2: {r2:.4f}")
        
        # êµ¬ê°„ë³„ ì„±ëŠ¥
        print("\n  êµ¬ê°„ë³„ MAE:")
        mask_low = y_test < 200
        mask_normal = (y_test >= 200) & (y_test < 300)
        mask_high = y_test >= 300
        mask_extreme = y_test >= 310
        mask_very_extreme = y_test >= 335
        
        if mask_low.sum() > 0:
            print(f"    ì €êµ¬ê°„(<200): {mean_absolute_error(y_test[mask_low], y_pred[mask_low]):.2f}")
        if mask_normal.sum() > 0:
            print(f"    ì •ìƒ(200-300): {mean_absolute_error(y_test[mask_normal], y_pred[mask_normal]):.2f}")
        if mask_high.sum() > 0:
            print(f"    ìœ„í—˜(300+): {mean_absolute_error(y_test[mask_high], y_pred[mask_high]):.2f}")
        if mask_extreme.sum() > 0:
            print(f"    ê·¹ë‹¨(310+): {mean_absolute_error(y_test[mask_extreme], y_pred[mask_extreme]):.2f}")
        if mask_very_extreme.sum() > 0:
            print(f"    ì´ˆê·¹ë‹¨(335+): {mean_absolute_error(y_test[mask_very_extreme], y_pred[mask_very_extreme]):.2f}")
        
        # ê·¹ë‹¨ê°’ ê°ì§€ìœ¨
        print("\n  ê·¹ë‹¨ê°’ ê°ì§€ìœ¨:")
        if mask_extreme.sum() > 0:
            detected_310 = ((y_pred >= 305)[mask_extreme].sum() / mask_extreme.sum()) * 100
            print(f"    310+ â†’ 305+ ì˜ˆì¸¡: {detected_310:.1f}%")
        
        if mask_very_extreme.sum() > 0:
            detected_335 = ((y_pred >= 330)[mask_very_extreme].sum() / mask_very_extreme.sum()) * 100
            print(f"    335+ â†’ 330+ ì˜ˆì¸¡: {detected_335:.1f}%")
        
        # ê²°ê³¼ ì €ì¥ìš©
        result = {
            'Model': model_name,
            'MAE': mae,
            'RMSE': rmse,
            'R2': r2,
            'MAE_Low': mean_absolute_error(y_test[mask_low], y_pred[mask_low]) if mask_low.sum() > 0 else 0,
            'MAE_Normal': mean_absolute_error(y_test[mask_normal], y_pred[mask_normal]) if mask_normal.sum() > 0 else 0,
            'MAE_High': mean_absolute_error(y_test[mask_high], y_pred[mask_high]) if mask_high.sum() > 0 else 0,
            'MAE_Extreme': mean_absolute_error(y_test[mask_extreme], y_pred[mask_extreme]) if mask_extreme.sum() > 0 else 0,
        }
        results.append(result)
    
    # ê²°ê³¼ DataFrame ìƒì„±
    results_df = pd.DataFrame(results)
    
    # ìƒì„¸ ì˜ˆì¸¡ ê²°ê³¼
    detail_df = pd.DataFrame({
        'Index': range(len(y_test)),
        'Actual': y_test,
        'Pred_Model1': y_pred1,
        'Pred_Model2': y_pred2,
        'Pred_Ensemble': y_ensemble,
        'Error_Model1': np.abs(y_test - y_pred1),
        'Error_Model2': np.abs(y_test - y_pred2),
        'Error_Ensemble': np.abs(y_test - y_ensemble),
        'Is_Extreme_310': y_test >= 310,
        'Is_Extreme_335': y_test >= 335
    })
    
    # ê²°ê³¼ ì €ì¥
    print("\n" + "="*80)
    print("ğŸ’¾ ê²°ê³¼ ì €ì¥ ì¤‘...")
    
    os.makedirs('./evaluation_results', exist_ok=True)
    
    # ì„±ëŠ¥ ìš”ì•½
    results_df.to_csv('./evaluation_results/test_performance_summary.csv', index=False)
    print("âœ… ì„±ëŠ¥ ìš”ì•½: ./evaluation_results/test_performance_summary.csv")
    
    # ìƒì„¸ ì˜ˆì¸¡
    detail_df.to_csv('./evaluation_results/test_detailed_predictions.csv', index=False)
    print("âœ… ìƒì„¸ ì˜ˆì¸¡: ./evaluation_results/test_detailed_predictions.csv")
    
    # ê·¹ë‹¨ê°’ë§Œ
    extreme_df = detail_df[detail_df['Is_Extreme_310']].copy()
    extreme_df.to_csv('./evaluation_results/test_extreme_predictions.csv', index=False)
    print("âœ… ê·¹ë‹¨ê°’ ì˜ˆì¸¡: ./evaluation_results/test_extreme_predictions.csv")
    
    # ìµœê³  ì„±ëŠ¥ ëª¨ë¸ì˜ ê·¹ë‹¨ê°’ Top 20
    print("\n" + "="*80)
    print("ğŸ¯ ê·¹ë‹¨ê°’ ì˜ˆì¸¡ Top 20 (ì‹¤ì œê°’ ê¸°ì¤€)")
    print("="*80)
    
    top20 = detail_df.nlargest(20, 'Actual')[['Actual', 'Pred_Model2', 'Error_Model2']]
    print(top20.to_string())
    
    print("\nâœ… í‰ê°€ ì™„ë£Œ!")
    print("="*80)
    
    return results_df, detail_df

# ========================================
# 8ì›” ë°ì´í„°ë¡œ ì‹¤ì‹œê°„ ì˜ˆì¸¡ (ì„ íƒì‚¬í•­)
# ========================================

def predict_august_realtime():
    """8ì›” ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì˜ˆì¸¡ (ì‹œë®¬ë ˆì´ì…˜)"""
    
    print("\n" + "="*80)
    print("ğŸ“… 2025ë…„ 8ì›” ë°ì´í„° ì‹¤ì‹œê°„ ì˜ˆì¸¡")
    print("="*80)
    
    # 8ì›” ë°ì´í„° ë¡œë“œ
    df_aug = pd.read_csv('data/20250801_TO_20250831.CSV')
    df_aug['timestamp'] = pd.to_datetime(df_aug.iloc[:, 0], format='%Y%m%d%H%M', errors='coerce')
    df_aug = df_aug.sort_values('timestamp').reset_index(drop=True)
    df_aug = df_aug.fillna(method='ffill').fillna(0)
    
    target_col = 'CURRENT_M16A_3F_JOB_2'
    
    print(f"âœ… 8ì›” ë°ì´í„° ë¡œë“œ: {len(df_aug)}ê°œ ì‹œì ")
    print(f"  ê¸°ê°„: {df_aug['timestamp'].min()} ~ {df_aug['timestamp'].max()}")
    print(f"  ì‹¤ì œ ê·¹ë‹¨ê°’(310+): {(df_aug[target_col] >= 310).sum()}ê°œ")
    print(f"  ì‹¤ì œ ì´ˆê·¹ë‹¨ê°’(335+): {(df_aug[target_col] >= 335).sum()}ê°œ")
    
    # ê·¹ë‹¨ê°’ ë°œìƒ ì‹œì ë§Œ ì¶”ì¶œ
    extreme_times = df_aug[df_aug[target_col] >= 310]['timestamp'].tolist()
    
    if extreme_times:
        print(f"\nğŸš¨ ê·¹ë‹¨ê°’ ë°œìƒ ì‹œì  (ì´ {len(extreme_times)}ê°œ):")
        for i, t in enumerate(extreme_times[:10]):  # ì²˜ìŒ 10ê°œë§Œ ì¶œë ¥
            value = df_aug[df_aug['timestamp'] == t][target_col].values[0]
            print(f"  {i+1}. {t} â†’ {value:.0f}")
        
        if len(extreme_times) > 10:
            print(f"  ... ì™¸ {len(extreme_times)-10}ê°œ")
    
    # 8ì›” ê·¹ë‹¨ê°’ í†µê³„
    august_summary = pd.DataFrame({
        'Month': ['2025-08'],
        'Total_Points': [len(df_aug)],
        'Extreme_310+': [(df_aug[target_col] >= 310).sum()],
        'Extreme_335+': [(df_aug[target_col] >= 335).sum()],
        'Max_Value': [df_aug[target_col].max()],
        'Extreme_Rate_%': [(df_aug[target_col] >= 310).sum() / len(df_aug) * 100]
    })
    
    august_summary.to_csv('./evaluation_results/august_extreme_summary.csv', index=False)
    print(f"\nâœ… 8ì›” ê·¹ë‹¨ê°’ ìš”ì•½ ì €ì¥: ./evaluation_results/august_extreme_summary.csv")
    
    return august_summary

# ========================================
# ì‹¤í–‰
# ========================================

if __name__ == "__main__":
    try:
        # 1. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ í‰ê°€
        print("\n[1ë‹¨ê³„] í…ŒìŠ¤íŠ¸ ë°ì´í„° í‰ê°€")
        results_df, detail_df = evaluate_with_test_data()
        
        # 2. 8ì›” ë°ì´í„° ë¶„ì„ (ì„ íƒ)
        print("\n[2ë‹¨ê³„] 8ì›” ë°ì´í„° ë¶„ì„")
        august_summary = predict_august_realtime()
        
        print("\nğŸ‰ ëª¨ë“  í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        print("ğŸ“ ê²°ê³¼ëŠ” ./evaluation_results/ í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
        
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()