# -*- coding: utf-8 -*-
"""
V4 ë²„ì „ êµ¬ì¶•ì„ ìœ„í•œ ë°ì´í„° ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
ì‹¤í–‰í•˜ë©´ í˜„ì¬ ë°ì´í„° ìƒíƒœì™€ V4 êµ¬ì¶• ê°€ëŠ¥ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.
"""

import pandas as pd
import numpy as np
import os
from datetime import datetime

def check_v4_readiness():
    """V4 êµ¬ì¶• ì¤€ë¹„ ìƒíƒœ ê²€ì¦"""
    
    print("="*80)
    print("ğŸ” V4 ë²„ì „ ë°ì´í„° ê²€ì¦ ì‹œì‘")
    print(f"ğŸ“… ê²€ì¦ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("="*80)
    
    # 1. ë°ì´í„° íŒŒì¼ í™•ì¸
    print("\n[Step 1] ë°ì´í„° íŒŒì¼ í™•ì¸")
    print("-"*40)
    
    data_path = 'data/HUB_0509_TO_0730_DATA.CSV'
    
    if not os.path.exists(data_path):
        print(f"âŒ ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {data_path}")
        return False
    
    print(f"âœ… ë°ì´í„° íŒŒì¼ ì¡´ì¬: {data_path}")
    
    # 2. ë°ì´í„° ë¡œë“œ ë° ê¸°ë³¸ ì •ë³´
    print("\n[Step 2] ë°ì´í„° ë¡œë“œ ë° ê¸°ë³¸ ì •ë³´")
    print("-"*40)
    
    try:
        df = pd.read_csv(data_path)
        print(f"âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ")
        print(f"  - ì „ì²´ í–‰ ìˆ˜: {len(df):,}")
        print(f"  - ì „ì²´ ì»¬ëŸ¼ ìˆ˜: {len(df.columns)}")
        print(f"  - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {df.memory_usage(deep=True).sum() / 1024**2:.2f} MB")
    except Exception as e:
        print(f"âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
        return False
    
    # 3. V3ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì»¬ëŸ¼ í™•ì¸
    print("\n[Step 3] V3 í˜„ì¬ ì‚¬ìš© ì»¬ëŸ¼ í™•ì¸")
    print("-"*40)
    
    v3_cols = {
        'íƒ€ê²Ÿ': 'CURRENT_M16A_3F_JOB_2',
        'ìœ ì…1': 'M16A_6F_TO_HUB_JOB',
        'ìœ ì…2': 'M16A_2F_TO_HUB_JOB2',
        'ìœ ì…3': 'M14A_3F_TO_HUB_JOB2',
        'ìœ ì…4': 'M14B_7F_TO_HUB_JOB2',
        'ìœ ì¶œ1': 'M16A_3F_TO_M16A_6F_JOB',
        'ìœ ì¶œ2': 'M16A_3F_TO_M16A_2F_JOB',
        'ìœ ì¶œ3': 'M16A_3F_TO_M14A_3F_JOB',
        'ìœ ì¶œ4': 'M16A_3F_TO_M14B_7F_JOB'
    }
    
    v3_missing = []
    for name, col in v3_cols.items():
        if col in df.columns:
            print(f"  âœ… {name}: {col}")
        else:
            print(f"  âŒ {name}: {col} - ì—†ìŒ!")
            v3_missing.append(col)
    
    if v3_missing:
        print(f"\nâš ï¸ ê²½ê³ : V3 í•„ìˆ˜ ì»¬ëŸ¼ {len(v3_missing)}ê°œ ëˆ„ë½")
    
    # 4. V4 í•µì‹¬ ì¶”ê°€ ì»¬ëŸ¼ í™•ì¸
    print("\n[Step 4] V4 í•µì‹¬ ì¶”ê°€ ì»¬ëŸ¼ í™•ì¸")
    print("-"*40)
    
    v4_critical = {
        'M16A_3F_STORAGE_UTIL': '95%',
        'M16A_3F_CMD': '85%',
        'M16A_3F_VHL_ERR_CNT': '80%',
        'CURRENT_M16A_3F_JOB': '70%'
    }
    
    v4_status = {}
    for col, importance in v4_critical.items():
        if col in df.columns:
            print(f"  âœ… {col} (ê¸°ì—¬ë„ {importance}) - ìˆìŒ")
            v4_status[col] = True
        else:
            print(f"  âŒ {col} (ê¸°ì—¬ë„ {importance}) - ì—†ìŒ!")
            v4_status[col] = False
    
    # 5. V4 ì¶”ê°€ ê¶Œì¥ ì»¬ëŸ¼ í™•ì¸
    print("\n[Step 5] V4 ì¶”ê°€ ê¶Œì¥ ì»¬ëŸ¼ í™•ì¸")
    print("-"*40)
    
    v4_recommended = [
        'M16A_6F_TO_HUB_CMD',
        'M14A_3F_TO_HUB_CMD',
        'M14B_7F_TO_HUB_CMD',
        'M16A_6F_LFT_MAXCAPA_UTIL',
        'M16A_3F_LFT_MAXCAPA_UTIL',
        'ALL_TO_HUB_JOB'
    ]
    
    recommended_count = 0
    for col in v4_recommended:
        if col in df.columns:
            print(f"  âœ… {col}")
            recommended_count += 1
        else:
            print(f"  â­• {col} - ì„ íƒì ")
    
    print(f"\nê¶Œì¥ ì»¬ëŸ¼ {recommended_count}/{len(v4_recommended)}ê°œ ì‚¬ìš© ê°€ëŠ¥")
    
    # 6. íƒ€ê²Ÿ ë³€ìˆ˜ ë¶„í¬ ë¶„ì„
    print("\n[Step 6] íƒ€ê²Ÿ ë³€ìˆ˜ ë¶„í¬ ë¶„ì„")
    print("-"*40)
    
    target_col = 'CURRENT_M16A_3F_JOB_2'
    
    if target_col in df.columns:
        target = df[target_col].dropna()
        
        print(f"  ë²”ìœ„: {target.min():.0f} ~ {target.max():.0f}")
        print(f"  í‰ê· : {target.mean():.1f}")
        print(f"  í‘œì¤€í¸ì°¨: {target.std():.1f}")
        
        print("\n  ê·¹ë‹¨ê°’ ë¶„í¬:")
        thresholds = [300, 310, 335, 350]
        for t in thresholds:
            count = (target >= t).sum()
            pct = count / len(target) * 100
            print(f"    {t}+ : {count:,}ê°œ ({pct:.2f}%)")
    
    # 7. ì»¬ëŸ¼ ìƒì„± ê°€ëŠ¥ì„± í™•ì¸
    print("\n[Step 7] ëŒ€ì²´ ì»¬ëŸ¼ ìƒì„± ê°€ëŠ¥ì„±")
    print("-"*40)
    
    # Storage í™œìš©ë¥  ëŒ€ì²´ ê°€ëŠ¥?
    if 'M16A_3F_STORAGE_UTIL' not in df.columns:
        if target_col in df.columns:
            print("  ğŸ“Œ Storage í™œìš©ë¥  ëŒ€ì²´: CURRENT_M16A_3F_JOB_2 / 541 (ìµœëŒ€ê°’)")
            df['M16A_3F_STORAGE_UTIL_PROXY'] = df[target_col] / 541 * 100
            print(f"     ìƒì„±ëœ í‰ê· ê°’: {df['M16A_3F_STORAGE_UTIL_PROXY'].mean():.1f}%")
    
    # CMD í•©ê³„ ìƒì„± ê°€ëŠ¥?
    cmd_cols = [col for col in df.columns if 'CMD' in col]
    if cmd_cols:
        print(f"  ğŸ“Œ CMD ê´€ë ¨ ì»¬ëŸ¼ {len(cmd_cols)}ê°œ ë°œê²¬")
        for col in cmd_cols[:5]:  # ì²˜ìŒ 5ê°œë§Œ í‘œì‹œ
            print(f"     - {col}")
    
    # 8. ìµœì¢… V4 êµ¬ì¶• ê°€ëŠ¥ì„± í‰ê°€
    print("\n" + "="*80)
    print("ğŸ“Š V4 êµ¬ì¶• ê°€ëŠ¥ì„± í‰ê°€")
    print("="*80)
    
    # ì ìˆ˜ ê³„ì‚°
    score = 0
    max_score = 100
    
    # V3 ê¸°ë³¸ ì»¬ëŸ¼ (40ì )
    v3_score = (len(v3_cols) - len(v3_missing)) / len(v3_cols) * 40
    score += v3_score
    print(f"\n1. V3 ê¸°ë³¸ ì»¬ëŸ¼: {v3_score:.1f}/40ì ")
    
    # V4 í•µì‹¬ ì»¬ëŸ¼ (40ì )
    v4_critical_score = sum(v4_status.values()) / len(v4_status) * 40
    score += v4_critical_score
    print(f"2. V4 í•µì‹¬ ì»¬ëŸ¼: {v4_critical_score:.1f}/40ì ")
    
    # V4 ê¶Œì¥ ì»¬ëŸ¼ (20ì )
    v4_recommended_score = recommended_count / len(v4_recommended) * 20
    score += v4_recommended_score
    print(f"3. V4 ê¶Œì¥ ì»¬ëŸ¼: {v4_recommended_score:.1f}/20ì ")
    
    print(f"\nì´ì : {score:.1f}/100ì ")
    
    # ë“±ê¸‰ íŒì •
    if score >= 80:
        grade = "A"
        message = "âœ… V4 êµ¬ì¶• ì¤€ë¹„ ì™„ë£Œ! ë°”ë¡œ ì‹œì‘ ê°€ëŠ¥"
    elif score >= 60:
        grade = "B"
        message = "âš ï¸ ì¼ë¶€ ì»¬ëŸ¼ ë³´ì™„ í›„ V4 êµ¬ì¶• ê°€ëŠ¥"
    elif score >= 40:
        grade = "C"
        message = "âš ï¸ í•µì‹¬ ì»¬ëŸ¼ í™•ë³´ í•„ìš”, ëŒ€ì²´ ë°©ì•ˆ ê²€í† "
    else:
        grade = "D"
        message = "âŒ V4 êµ¬ì¶• ì–´ë ¤ì›€, ë°ì´í„° ë³´ê°• í•„ìˆ˜"
    
    print(f"ë“±ê¸‰: {grade}")
    print(f"íŒì •: {message}")
    
    # 9. ê¶Œì¥ ì‚¬í•­
    print("\nğŸ“ ê¶Œì¥ ì‚¬í•­:")
    print("-"*40)
    
    if 'M16A_3F_STORAGE_UTIL' not in df.columns:
        print("1. M16A_3F_STORAGE_UTIL ì»¬ëŸ¼ ìš”ì²­ ë˜ëŠ” ëŒ€ì²´ ìƒì„±")
    
    if 'M16A_3F_CMD' not in df.columns:
        print("2. M16A_3F_CMD ì»¬ëŸ¼ ìš”ì²­ ë˜ëŠ” CMD ê´€ë ¨ ì»¬ëŸ¼ í•©ê³„ ì‚¬ìš©")
    
    if 'M16A_3F_VHL_ERR_CNT' not in df.columns:
        print("3. M16A_3F_VHL_ERR_CNT ì»¬ëŸ¼ ìš”ì²­ (ëŒ€ì²´ ì–´ë ¤ì›€)")
    
    if score < 80:
        print("4. ëˆ„ë½ëœ í•µì‹¬ ì»¬ëŸ¼ ë°ì´í„° ì œê³µì²˜ì— ìš”ì²­")
        print("5. V3 ëª¨ë¸ê³¼ ì•™ìƒë¸” ë°©ì‹ ê³ ë ¤")
    
    # 10. ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼ ëª©ë¡ ì¶œë ¥
    print("\n[ì°¸ê³ ] ì‹¤ì œ ë°ì´í„°ì˜ ì»¬ëŸ¼ ëª©ë¡ (ì²˜ìŒ 20ê°œ)")
    print("-"*40)
    for i, col in enumerate(df.columns[:20], 1):
        print(f"  {i:2}. {col}")
    
    if len(df.columns) > 20:
        print(f"  ... ì™¸ {len(df.columns)-20}ê°œ")
    
    return score >= 60  # 60ì  ì´ìƒì´ë©´ True

if __name__ == "__main__":
    # ê²€ì¦ ì‹¤í–‰
    result = check_v4_readiness()
    
    if result:
        print("\n" + "="*80)
        print("ğŸ‰ V4 êµ¬ì¶• ì‹œì‘ ê°€ëŠ¥!")
        print("ë‹¤ìŒ ë‹¨ê³„: V3 ì½”ë“œë¥¼ V4ë¡œ ìˆ˜ì •")
        print("="*80)
    else:
        print("\n" + "="*80)
        print("âš ï¸ ë°ì´í„° ë³´ê°• í•„ìš”")
        print("ìœ„ ê¶Œì¥ì‚¬í•­ì„ ì°¸ê³ í•˜ì—¬ ë°ì´í„° í™•ë³´ í›„ ì¬ì‹œë„")
        print("="*80)