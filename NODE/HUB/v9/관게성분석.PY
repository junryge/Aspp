import numpy as np
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

print("="*80)
print("ðŸŽ¯ ì „ì²´ ì»¬ëŸ¼ ê´€ê³„ì„± ë¶„ì„")
print("="*80)

# ========== ë°ì´í„° ë¡œë“œ ==========
DATA_FILE = '10ì›”_ë°ì´í„°.csv'  # â† íŒŒì¼ëª… ìˆ˜ì •!

try:
    df = pd.read_csv(DATA_FILE, encoding='utf-8', low_memory=False)
except:
    try:
        df = pd.read_csv(DATA_FILE, encoding='cp949', low_memory=False)
    except:
        df = pd.read_csv(DATA_FILE, encoding='euc-kr', low_memory=False)

print(f"\nâœ… ë°ì´í„°: {len(df)}í–‰ x {len(df.columns)}ì»¬ëŸ¼")

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'

# íƒ€ê²Ÿ ì „ì²˜ë¦¬
df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
df = df.dropna(subset=[TARGET_COL])

# 10ë¶„ í›„ íƒ€ê²Ÿê°’
df['TARGET_FUTURE_10'] = df[TARGET_COL].shift(-10)
df['TARGET_CHANGE_10'] = df['TARGET_FUTURE_10'] - df[TARGET_COL]

print(f"âœ… ìœ íš¨ ë°ì´í„°: {len(df)}í–‰")

# ========== ìƒê´€ê´€ê³„ ë¶„ì„ ==========
print("\nðŸ“Š ìƒê´€ê´€ê³„ ê³„ì‚° ì¤‘...")

results = []

for col in df.columns:
    if col in ['STAT_DT', TARGET_COL, 'TARGET_FUTURE_10', 'TARGET_CHANGE_10']:
        continue
    
    df[col] = pd.to_numeric(df[col], errors='coerce')
    
    if df[col].std() == 0 or df[col].isna().all():
        continue
    
    corr_current = df[col].corr(df[TARGET_COL])
    corr_future = df[col].corr(df['TARGET_FUTURE_10'])
    corr_change = df[col].corr(df['TARGET_CHANGE_10'])
    
    results.append({
        'ì»¬ëŸ¼ëª…': col,
        'í˜„ìž¬_ìƒê´€': round(corr_current, 4) if not np.isnan(corr_current) else 0,
        '10ë¶„í›„_ìƒê´€': round(corr_future, 4) if not np.isnan(corr_future) else 0,
        'ë³€í™”ëŸ‰_ìƒê´€': round(corr_change, 4) if not np.isnan(corr_change) else 0,
        'í‰ê· ': round(df[col].mean(), 2),
        'í‘œì¤€íŽ¸ì°¨': round(df[col].std(), 2),
        'ìµœì†Œ': round(df[col].min(), 2),
        'ìµœëŒ€': round(df[col].max(), 2)
    })

results_df = pd.DataFrame(results)

# ========== ê²°ê³¼ ì¶œë ¥ ==========
print("\n" + "="*80)
print("ðŸ”¥ í˜„ìž¬ íƒ€ê²Ÿ ìƒê´€ê´€ê³„ Top 30")
print("="*80)
top_current = results_df.reindex(results_df['í˜„ìž¬_ìƒê´€'].abs().sort_values(ascending=False).index).head(30)
for _, row in top_current.iterrows():
    d = "â†‘" if row['í˜„ìž¬_ìƒê´€'] > 0 else "â†“"
    print(f"  {row['ì»¬ëŸ¼ëª…']:55s} {row['í˜„ìž¬_ìƒê´€']:+.4f} {d}")

print("\n" + "="*80)
print("ðŸŽ¯ 10ë¶„ í›„ ì˜ˆì¸¡ë ¥ Top 30 â­")
print("="*80)
top_future = results_df.reindex(results_df['10ë¶„í›„_ìƒê´€'].abs().sort_values(ascending=False).index).head(30)
for _, row in top_future.iterrows():
    d = "â†‘" if row['10ë¶„í›„_ìƒê´€'] > 0 else "â†“"
    print(f"  {row['ì»¬ëŸ¼ëª…']:55s} {row['10ë¶„í›„_ìƒê´€']:+.4f} {d}")

print("\n" + "="*80)
print("ðŸ“ˆ ë³€í™”ëŸ‰ ì˜ˆì¸¡ë ¥ Top 30 â­â­")
print("="*80)
top_change = results_df.reindex(results_df['ë³€í™”ëŸ‰_ìƒê´€'].abs().sort_values(ascending=False).index).head(30)
for _, row in top_change.iterrows():
    d = "â†‘" if row['ë³€í™”ëŸ‰_ìƒê´€'] > 0 else "â†“"
    print(f"  {row['ì»¬ëŸ¼ëª…']:55s} {row['ë³€í™”ëŸ‰_ìƒê´€']:+.4f} {d}")

# CSV ì €ìž¥
output_file = 'ê´€ê³„ì„±_ë¶„ì„_ê²°ê³¼.csv'
results_df.sort_values('ë³€í™”ëŸ‰_ìƒê´€', key=abs, ascending=False).to_csv(output_file, index=False, encoding='utf-8-sig')
print(f"\nâœ… ê²°ê³¼ ì €ìž¥: {output_file}")

# ìš”ì•½
print("\n" + "="*80)
print("ðŸ“‹ ìš”ì•½")
print("="*80)
print(f"ë¶„ì„ ì»¬ëŸ¼: {len(results)}ê°œ")
print(f"ê°•í•œ í˜„ìž¬ ìƒê´€ (|r|â‰¥0.5): {len(results_df[results_df['í˜„ìž¬_ìƒê´€'].abs() >= 0.5])}ê°œ")
print(f"ê°•í•œ ë¯¸ëž˜ ìƒê´€ (|r|â‰¥0.5): {len(results_df[results_df['10ë¶„í›„_ìƒê´€'].abs() >= 0.5])}ê°œ")
print(f"ë³€í™”ëŸ‰ ìƒê´€ (|r|â‰¥0.1): {len(results_df[results_df['ë³€í™”ëŸ‰_ìƒê´€'].abs() >= 0.1])}ê°œ")

print("\nðŸŽ‰ ì™„ë£Œ!")