import pandas as pd
import numpy as np

def analyze_columns_for_model_selection():
    """
    ğŸ“Š V8+V9 ì „ì²´ ì»¬ëŸ¼ ë¶„ì„
    ëª©ì : MIN/MAX/AVG ì„ íƒì— ë„ì›€ë˜ëŠ” ì‹ í˜¸ ì°¾ê¸°
    """
    print("="*80)
    print("ğŸ“Š V8+V9 ì „ì²´ ì»¬ëŸ¼ ë¶„ì„: MIN/MAX/AVG ì„ íƒ ì‹ í˜¸ ì°¾ê¸°")
    print("="*80)
    
    # ë°ì´í„° ë¡œë“œ
    try:
        df = pd.read_csv('test_data.csv', encoding='utf-8', on_bad_lines='skip', low_memory=False)
    except:
        try:
            df = pd.read_csv('test_data.csv', encoding='cp949', on_bad_lines='skip', low_memory=False)
        except:
            df = pd.read_csv('test_data.csv', encoding='euc-kr', on_bad_lines='skip', low_memory=False)
    
    print(f"âœ… ë°ì´í„° ë¡œë“œ: {len(df)}í–‰")
    
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    
    # V8 ê¸°ì¡´ 14ê°œ
    V8_COLS = [
        'M16A_3F_STORAGE_UTIL',
        'CD_M163FSTORAGEUSE', 'CD_M163FSTORAGETOTAL', 'CD_M163FSTORAGEUTIL',
        'HUBROOMTOTAL',
        'M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD',
        'M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2', 'M14A_3F_TO_HUB_JOB2',
        'M16A_3F_TO_M16A_6F_JOB', 'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB',
        'M16A_6F_LFT_MAXCAPA', 'M16A_2F_LFT_MAXCAPA',
    ]
    
    # V9 ì‹ ê·œ 20ê°œ
    V9_COLS = [
        'M16A_LFTTOALL',
        'M16HUB_M16TOM14_CREATED',
        'M16A_ALLTONORTHCNV',
        'M16A_NORTHCNVTOALL',
        'M16A_M16ATOM14A',
        'M14_TOTALCNVCURRENTQCNT',
        'M16HUB_M16TOM14B_CREATED',
        'M16HUB_M14TOM16_CREATED',
        'M16A_CURRENTQCNT',
        'M16A_ALLTOSOUTHCNV',
        'M14_ALLTOSOUTHCNV',
        'M14_ALLTONORTHCNV',
        'M14_CURRENTQCREATED',
        'M14_RETURNTOM16',
        'M14B_LFTTOALL',
        'M14B_M14BTOM16A',
        'M16B_CURRENTQCREATED',
        'M16_SENDTOM14',
        'M16HUB_M14TOM16_MESCNT',
        'M16HUB_MESCURRENTQCNT',
    ]
    
    ALL_COLS = V8_COLS + V9_COLS
    
    # ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ
    available = [c for c in ALL_COLS if c in df.columns]
    missing = [c for c in ALL_COLS if c not in df.columns]
    
    print(f"\nğŸ“‹ ì»¬ëŸ¼ í˜„í™©:")
    print(f"  ì‚¬ìš© ê°€ëŠ¥: {len(available)}/{len(ALL_COLS)}ê°œ")
    if missing:
        print(f"  ëˆ„ë½: {missing}")
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ ì²˜ë¦¬
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    
    # 10ë¶„ í›„ ë³€í™”ëŸ‰ ê³„ì‚°
    df['future_change'] = df[TARGET_COL].shift(-10) - df[TARGET_COL]
    df = df.dropna(subset=['future_change'])
    
    # ë¶„ë¥˜
    df['category'] = 'normal'
    df.loc[df['future_change'] >= 50, 'category'] = 'surge'   # ê¸‰ë“±
    df.loc[df['future_change'] <= -50, 'category'] = 'drop'   # ê¸‰ë½
    
    surge_df = df[df['category'] == 'surge']
    drop_df = df[df['category'] == 'drop']
    normal_df = df[df['category'] == 'normal']
    
    print(f"\nğŸ“Š ë°ì´í„° ë¶„ë¥˜:")
    print(f"  ğŸ“ˆ ê¸‰ë“± (+50ì´ìƒ): {len(surge_df)}ê°œ ({len(surge_df)/len(df)*100:.2f}%)")
    print(f"  ğŸ“‰ ê¸‰ë½ (-50ì´í•˜): {len(drop_df)}ê°œ ({len(drop_df)/len(df)*100:.2f}%)")
    print(f"  âš–ï¸ ì¼ë°˜: {len(normal_df)}ê°œ ({len(normal_df)/len(df)*100:.2f}%)")
    
    # ========== ë¶„ì„ 1: í‰ê· ê°’ ë¹„êµ ==========
    print(f"\n" + "="*80)
    print("ğŸ“Š [ë¶„ì„ 1] ì»¬ëŸ¼ë³„ ê¸‰ë“±/ê¸‰ë½/ì¼ë°˜ í‰ê· ê°’ ë¹„êµ")
    print("="*80)
    
    results = []
    
    for col in available:
        try:
            col_data = pd.to_numeric(df[col], errors='coerce')
            
            surge_mean = col_data[df['category']=='surge'].mean()
            drop_mean = col_data[df['category']=='drop'].mean()
            normal_mean = col_data[df['category']=='normal'].mean()
            
            # ê¸‰ë“± vs ì¼ë°˜ ì°¨ì´ (%)
            if abs(normal_mean) > 0.001:
                surge_diff = (surge_mean - normal_mean) / abs(normal_mean) * 100
                drop_diff = (drop_mean - normal_mean) / abs(normal_mean) * 100
            else:
                surge_diff = 0
                drop_diff = 0
            
            results.append({
                'col': col,
                'surge_mean': surge_mean,
                'drop_mean': drop_mean,
                'normal_mean': normal_mean,
                'surge_diff%': surge_diff,
                'drop_diff%': drop_diff,
                'abs_diff': abs(surge_diff) + abs(drop_diff)
            })
        except Exception as e:
            print(f"  âš ï¸ {col} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
    
    results_df = pd.DataFrame(results)
    results_df = results_df.sort_values('abs_diff', ascending=False)
    
    print(f"\nğŸ”¥ ê¸‰ë“±/ê¸‰ë½ êµ¬ë¶„ì— ìœ ìš©í•œ ì»¬ëŸ¼ (ì°¨ì´ í° ìˆœ Top 20):")
    print("-"*90)
    print(f"{'ì»¬ëŸ¼':<30} {'ê¸‰ë“±í‰ê· ':>10} {'ê¸‰ë½í‰ê· ':>10} {'ì¼ë°˜í‰ê· ':>10} {'ê¸‰ë“±ì°¨ì´%':>10} {'ê¸‰ë½ì°¨ì´%':>10}")
    print("-"*90)
    
    for _, row in results_df.head(20).iterrows():
        print(f"{row['col']:<30} {row['surge_mean']:>10.1f} {row['drop_mean']:>10.1f} {row['normal_mean']:>10.1f} {row['surge_diff%']:>+10.1f} {row['drop_diff%']:>+10.1f}")
    
    # ========== ë¶„ì„ 2: ë³€ê³¡ì  ê°ì§€ ==========
    print(f"\n" + "="*80)
    print("ğŸ“Š [ë¶„ì„ 2] ë³€ê³¡ì  ê°ì§€ (í•˜ë½ì¶”ì„¸â†’ê¸‰ë“±, ìƒìŠ¹ì¶”ì„¸â†’ê¸‰ë½)")
    print("="*80)
    
    # 30ë¶„ ì¶”ì„¸ ê³„ì‚°
    slopes = []
    for i in range(30, len(df)):
        seq = df[TARGET_COL].iloc[i-30:i].values
        slope = np.polyfit(np.arange(30), seq, 1)[0]
        slopes.append(slope)
    
    df_with_slope = df.iloc[30:].copy()
    df_with_slope['slope'] = slopes
    
    # ë³€ê³¡ì  ë¶„ë¥˜
    # í•˜ë½ì¶”ì„¸(slope<0) + ê¸‰ë“± = ë³€ê³¡ì  ê¸‰ë“±
    # ìƒìŠ¹ì¶”ì„¸(slope>0) + ê¸‰ë½ = ë³€ê³¡ì  ê¸‰ë½
    ë³€ê³¡ì _ê¸‰ë“± = df_with_slope[(df_with_slope['slope'] < 0) & (df_with_slope['category'] == 'surge')]
    ë³€ê³¡ì _ê¸‰ë½ = df_with_slope[(df_with_slope['slope'] > 0) & (df_with_slope['category'] == 'drop')]
    ì¶”ì„¸ìœ ì§€_ê¸‰ë“± = df_with_slope[(df_with_slope['slope'] >= 0) & (df_with_slope['category'] == 'surge')]
    ì¶”ì„¸ìœ ì§€_ê¸‰ë½ = df_with_slope[(df_with_slope['slope'] <= 0) & (df_with_slope['category'] == 'drop')]
    
    print(f"\nğŸ“ˆ ê¸‰ë“± ë¶„ì„:")
    print(f"  ë³€ê³¡ì  ê¸‰ë“± (í•˜ë½ì¤‘â†’ê¸‰ë“±): {len(ë³€ê³¡ì _ê¸‰ë“±)}ê°œ")
    print(f"  ì¶”ì„¸ìœ ì§€ ê¸‰ë“± (ìƒìŠ¹ì¤‘â†’ê¸‰ë“±): {len(ì¶”ì„¸ìœ ì§€_ê¸‰ë“±)}ê°œ")
    
    print(f"\nğŸ“‰ ê¸‰ë½ ë¶„ì„:")
    print(f"  ë³€ê³¡ì  ê¸‰ë½ (ìƒìŠ¹ì¤‘â†’ê¸‰ë½): {len(ë³€ê³¡ì _ê¸‰ë½)}ê°œ")
    print(f"  ì¶”ì„¸ìœ ì§€ ê¸‰ë½ (í•˜ë½ì¤‘â†’ê¸‰ë½): {len(ì¶”ì„¸ìœ ì§€_ê¸‰ë½)}ê°œ")
    
    # ë³€ê³¡ì  vs ì¶”ì„¸ìœ ì§€ ì»¬ëŸ¼ ë¹„êµ
    if len(ë³€ê³¡ì _ê¸‰ë“±) > 0 and len(ì¶”ì„¸ìœ ì§€_ê¸‰ë“±) > 0:
        print(f"\nğŸ”¥ ë³€ê³¡ì  ê¸‰ë“± vs ì¶”ì„¸ìœ ì§€ ê¸‰ë“± ë¹„êµ:")
        print("-"*70)
        print(f"{'ì»¬ëŸ¼':<30} {'ë³€ê³¡ì ê¸‰ë“±':>12} {'ì¶”ì„¸ìœ ì§€ê¸‰ë“±':>12} {'ì°¨ì´':>10}")
        print("-"*70)
        
        diff_results = []
        for col in available:
            try:
                col_data = pd.to_numeric(df_with_slope[col], errors='coerce')
                ë³€ê³¡_mean = col_data[df_with_slope.index.isin(ë³€ê³¡ì _ê¸‰ë“±.index)].mean()
                ì¶”ì„¸_mean = col_data[df_with_slope.index.isin(ì¶”ì„¸ìœ ì§€_ê¸‰ë“±.index)].mean()
                diff = ë³€ê³¡_mean - ì¶”ì„¸_mean
                diff_results.append({'col': col, 'ë³€ê³¡ì ': ë³€ê³¡_mean, 'ì¶”ì„¸ìœ ì§€': ì¶”ì„¸_mean, 'diff': diff, 'abs_diff': abs(diff)})
            except:
                pass
        
        diff_df = pd.DataFrame(diff_results).sort_values('abs_diff', ascending=False)
        for _, row in diff_df.head(10).iterrows():
            print(f"{row['col']:<30} {row['ë³€ê³¡ì ']:>12.1f} {row['ì¶”ì„¸ìœ ì§€']:>12.1f} {row['diff']:>+10.1f}")
    
    # ========== ë¶„ì„ 3: ì„ê³„ê°’ ì°¾ê¸° ==========
    print(f"\n" + "="*80)
    print("ğŸ“Š [ë¶„ì„ 3] MIN/MAX/AVG ì„ íƒ ì„ê³„ê°’ í›„ë³´")
    print("="*80)
    
    print(f"\nê° ì»¬ëŸ¼ë³„ ê¸‰ë“±/ê¸‰ë½ ì‹œ ë¶„í¬:")
    
    for col in available[:10]:  # ìƒìœ„ 10ê°œë§Œ
        try:
            col_data = pd.to_numeric(df[col], errors='coerce')
            
            print(f"\n{col}:")
            print(f"  ê¸‰ë“± ì‹œ: min={col_data[df['category']=='surge'].min():.1f}, "
                  f"max={col_data[df['category']=='surge'].max():.1f}, "
                  f"median={col_data[df['category']=='surge'].median():.1f}")
            print(f"  ê¸‰ë½ ì‹œ: min={col_data[df['category']=='drop'].min():.1f}, "
                  f"max={col_data[df['category']=='drop'].max():.1f}, "
                  f"median={col_data[df['category']=='drop'].median():.1f}")
            print(f"  ì¼ë°˜ ì‹œ: min={col_data[df['category']=='normal'].min():.1f}, "
                  f"max={col_data[df['category']=='normal'].max():.1f}, "
                  f"median={col_data[df['category']=='normal'].median():.1f}")
        except:
            pass
    
    # ========== ê²°ê³¼ ì €ì¥ ==========
    output_file = 'ì»¬ëŸ¼ë¶„ì„_ê²°ê³¼.csv'
    results_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"\nâœ… ë¶„ì„ ê²°ê³¼ ì €ì¥: {output_file}")
    
    print(f"\n" + "="*80)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print("="*80)
    print(f"\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:")
    print(f"  1. ì°¨ì´ê°€ í° ì»¬ëŸ¼ì„ MIN/MAX/AVG ì„ íƒ ì¡°ê±´ì— ì¶”ê°€")
    print(f"  2. ë³€ê³¡ì  ê°ì§€ìš© íŠ¹ìˆ˜ ì¡°ê±´ ì„¤ê³„")
    print(f"  3. ì„ê³„ê°’ í…ŒìŠ¤íŠ¸")
    
    return results_df

if __name__ == '__main__':
    print("ğŸš€ V9 ì»¬ëŸ¼ ë¶„ì„ ì‹œì‘...\n")
    results = analyze_columns_for_model_selection()