#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
í ë³€í™”ëŸ‰ CSV í•„í„°ë§ ë° ë¶„ì„ ë„êµ¬
================================================================================
RESULT_2025_with_queue_analysis.csv íŒŒì¼ì˜ í•„í„°ë§ê³¼ í†µê³„ ë¶„ì„
"""

import pandas as pd
import numpy as np
import chardet
import os

def read_csv_safely(filepath):
    """í•œê¸€ CSV íŒŒì¼ ì•ˆì „í•˜ê²Œ ì½ê¸°"""
    # íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not os.path.exists(filepath):
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filepath}")
        return None
    
    # ë‹¤ì–‘í•œ ì¸ì½”ë”© ì‹œë„
    encodings = ['utf-8-sig', 'cp949', 'euc-kr', 'utf-8']
    
    for encoding in encodings:
        try:
            df = pd.read_csv(filepath, encoding=encoding)
            print(f"âœ… íŒŒì¼ ì½ê¸° ì„±ê³µ (ì¸ì½”ë”©: {encoding})")
            return df
        except UnicodeDecodeError:
            continue
    
    # ëª¨ë“  ì¸ì½”ë”© ì‹¤íŒ¨ì‹œ chardet ì‚¬ìš©
    try:
        with open(filepath, 'rb') as f:
            result = chardet.detect(f.read())
            encoding = result['encoding']
            print(f"ê°ì§€ëœ ì¸ì½”ë”©: {encoding}")
            df = pd.read_csv(filepath, encoding=encoding)
            return df
    except:
        print("âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

def filter_by_range_and_change(df, current_range='200-250', change_range='0~20', time_horizon=5):
    """
    íŠ¹ì • êµ¬ê°„ê³¼ ë³€í™”ëŸ‰ìœ¼ë¡œ í•„í„°ë§
    
    Parameters:
    - current_range: í˜„ì¬ê°’ êµ¬ê°„ (ì˜ˆ: '200-250', '250-300', '300-350')
    - change_range: ë³€í™”ëŸ‰ êµ¬ê°„ (ì˜ˆ: '0~20', '21~40', '41~60', '61~80', '81~100', '100+')
    - time_horizon: ì‹œê°„ëŒ€ (5, 10, 20, 30)
    """
    # ì»¬ëŸ¼ëª…
    range_col = 'í˜„ì¬ê°’êµ¬ê°„'
    change_col = f'ë³€í™”êµ¬ê°„_{time_horizon}ë¶„'
    direction_col = f'ë³€í™”ë°©í–¥_{time_horizon}ë¶„'
    
    # í•„í„°ë§
    filtered = df[(df[range_col] == current_range) & 
                  (df[change_col] == change_range)]
    
    # ìƒìŠ¹/í•˜ë½ ë¶„ë¦¬
    ìƒìŠ¹ = filtered[filtered[direction_col] == 'ìƒìŠ¹']
    í•˜ë½ = filtered[filtered[direction_col] == 'í•˜ë½']
    ìœ ì§€ = filtered[filtered[direction_col] == 'ìœ ì§€']
    
    # í†µê³„ ì¶œë ¥
    print(f"\n{'='*60}")
    print(f"ğŸ“Š {current_range} êµ¬ê°„, {time_horizon}ë¶„ ë³€í™”ëŸ‰ {change_range}")
    print(f"{'='*60}")
    print(f"- ì „ì²´: {len(filtered)}ê°œ")
    
    if len(filtered) > 0:
        print(f"- ìƒìŠ¹: {len(ìƒìŠ¹)}ê°œ ({len(ìƒìŠ¹)/len(filtered)*100:.1f}%)")
        print(f"- í•˜ë½: {len(í•˜ë½)}ê°œ ({len(í•˜ë½)/len(filtered)*100:.1f}%)")
        print(f"- ìœ ì§€: {len(ìœ ì§€)}ê°œ ({len(ìœ ì§€)/len(filtered)*100:.1f}%)")
    
    return filtered, ìƒìŠ¹, í•˜ë½, ìœ ì§€

def analyze_all_combinations(df):
    """ëª¨ë“  êµ¬ê°„ê³¼ ë³€í™”ëŸ‰ ì¡°í•© ë¶„ì„"""
    
    # ë¶„ì„í•  êµ¬ê°„ë“¤
    ranges = ['200-250', '250-300', '300-350']
    change_bins = ['0~20', '21~40', '41~60', '61~80', '81~100']
    time_horizons = [5, 10, 20, 30]
    
    # ê²°ê³¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    all_results = []
    
    for time in time_horizons:
        print(f"\n\nğŸ• {time}ë¶„ í›„ ë³€í™”ëŸ‰ ë¶„ì„")
        print("="*80)
        
        for current_range in ranges:
            for change_range in change_bins:
                filtered, ìƒìŠ¹, í•˜ë½, ìœ ì§€ = filter_by_range_and_change(
                    df, current_range, change_range, time
                )
                
                # ê²°ê³¼ ì €ì¥
                if len(filtered) > 0:
                    all_results.append({
                        'ì‹œê°„ëŒ€(ë¶„)': time,
                        'í˜„ì¬ê°’êµ¬ê°„': current_range,
                        'ë³€í™”ëŸ‰êµ¬ê°„': change_range,
                        'ì „ì²´ì¼€ì´ìŠ¤': len(filtered),
                        'ìƒìŠ¹': len(ìƒìŠ¹),
                        'í•˜ë½': len(í•˜ë½),
                        'ìœ ì§€': len(ìœ ì§€),
                        'ìƒìŠ¹ë¹„ìœ¨(%)': round(len(ìƒìŠ¹)/len(filtered)*100, 1),
                        'í•˜ë½ë¹„ìœ¨(%)': round(len(í•˜ë½)/len(filtered)*100, 1)
                    })
    
    # DataFrameìœ¼ë¡œ ë³€í™˜
    summary_df = pd.DataFrame(all_results)
    
    # ì—‘ì…€ë¡œ ì €ì¥
    output_file = 'queue_analysis_summary.xlsx'
    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        summary_df.to_excel(writer, sheet_name='ë³€í™”ëŸ‰ë¶„ì„í†µê³„', index=False)
        
        # ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
        worksheet = writer.sheets['ë³€í™”ëŸ‰ë¶„ì„í†µê³„']
        for column in worksheet.columns:
            max_length = 0
            column = [cell for cell in column]
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 30)
            worksheet.column_dimensions[column[0].column_letter].width = adjusted_width
    
    print(f"\n\nğŸ’¾ ë¶„ì„ ê²°ê³¼ê°€ '{output_file}'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return summary_df

def analyze_stable_cases(df):
    """ì•ˆì • êµ¬ê°„ ì¼€ì´ìŠ¤ ë¶„ì„"""
    
    stable_col = 'ì•ˆì •êµ¬ê°„_ê³¼ê±°30ë¶„<300_í–¥í›„10ë¶„â‰¤300'
    
    if stable_col in df.columns:
        stable_cases = df[df[stable_col] == 'O']
        print(f"\n\nğŸ·ï¸ ì•ˆì • êµ¬ê°„ ë¶„ì„")
        print("="*60)
        print(f"- ì „ì²´ ë°ì´í„°: {len(df)}ê°œ")
        print(f"- ì•ˆì • êµ¬ê°„ ì¼€ì´ìŠ¤: {len(stable_cases)}ê°œ")
        print(f"- ë¹„ìœ¨: {len(stable_cases)/len(df)*100:.2f}%")
        
        # ì•ˆì • êµ¬ê°„ ì¼€ì´ìŠ¤ë§Œ ë³„ë„ ì €ì¥
        if len(stable_cases) > 0:
            stable_cases.to_csv('stable_cases.csv', index=False, encoding='utf-8-sig')
            print(f"- ì•ˆì • ì¼€ì´ìŠ¤ê°€ 'stable_cases.csv'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print(f"âš ï¸ '{stable_col}' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    
    print("="*80)
    print("ğŸ“Š í ë³€í™”ëŸ‰ CSV í•„í„°ë§ ë° ë¶„ì„ ì‹œì‘")
    print("="*80)
    
    # 1. CSV íŒŒì¼ ì½ê¸°
    filepath = 'RESULT_2025_with_queue_analysis.csv'
    df = read_csv_safely(filepath)
    
    if df is None:
        return
    
    print(f"\nâœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df)} í–‰")
    print(f"ì»¬ëŸ¼ ìˆ˜: {len(df.columns)}")
    
    # 2. íŠ¹ì • í•„í„°ë§ ì˜ˆì œ (200-250 êµ¬ê°„, 5ë¶„ ë³€í™” 0~20)
    print("\n\n[ì˜ˆì œ] 200-250 êµ¬ê°„, 5ë¶„ ë³€í™”ëŸ‰ 0~20 í•„í„°ë§")
    filtered, ìƒìŠ¹, í•˜ë½, ìœ ì§€ = filter_by_range_and_change(df, '200-250', '0~20', 5)
    
    # í•„í„°ë§ëœ ë°ì´í„° ì €ì¥
    if len(filtered) > 0:
        filtered.to_csv('filtered_200_250_change_0_20.csv', index=False, encoding='utf-8-sig')
        print(f"ğŸ’¾ í•„í„°ë§ ê²°ê³¼ê°€ 'filtered_200_250_change_0_20.csv'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    # 3. ì „ì²´ ì¡°í•© ë¶„ì„
    analyze_all = input("\nì „ì²´ êµ¬ê°„ê³¼ ë³€í™”ëŸ‰ ì¡°í•©ì„ ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
    if analyze_all.lower() == 'y':
        summary_df = analyze_all_combinations(df)
        
        # ìš”ì•½ í†µê³„ ì¶œë ¥
        print("\n\nğŸ“ˆ ìš”ì•½ í†µê³„")
        print("="*60)
        for time in [5, 10, 20, 30]:
            time_data = summary_df[summary_df['ì‹œê°„ëŒ€(ë¶„)'] == time]
            if len(time_data) > 0:
                print(f"\n{time}ë¶„ í›„:")
                print(f"  - í‰ê·  ìƒìŠ¹ ë¹„ìœ¨: {time_data['ìƒìŠ¹ë¹„ìœ¨(%)'].mean():.1f}%")
                print(f"  - í‰ê·  í•˜ë½ ë¹„ìœ¨: {time_data['í•˜ë½ë¹„ìœ¨(%)'].mean():.1f}%")
    
    # 4. ì•ˆì • êµ¬ê°„ ë¶„ì„
    analyze_stable_cases(df)
    
    print("\n\nâœ… ëª¨ë“  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

if __name__ == "__main__":
    main()