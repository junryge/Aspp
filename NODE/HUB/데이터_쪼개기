import pandas as pd
import os
from datetime import datetime, timedelta

def split_csv_by_20minutes(input_file='full.csv', output_dir='split_data'):
    """
    CSV íŒŒì¼ì„ 20ë¶„ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ëŠ” í•¨ìˆ˜
    
    Parameters:
    -----------
    input_file : str
        ì…ë ¥ CSV íŒŒì¼ ê²½ë¡œ
    output_dir : str
        ì¶œë ¥ ë””ë ‰í† ë¦¬ ê²½ë¡œ
    """
    
    # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
        print(f"ğŸ“ ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±: {output_dir}")
    
    # CSV íŒŒì¼ ì½ê¸°
    print(f"ğŸ“‚ íŒŒì¼ ì½ê¸° ì¤‘: {input_file}")
    df = pd.read_csv(input_file)
    
    # timestamp ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    
    # ë°ì´í„° ì •ë³´ ì¶œë ¥
    print(f"\nğŸ“Š ë°ì´í„° ì •ë³´:")
    print(f"  - ì „ì²´ í–‰ ìˆ˜: {len(df):,}")
    print(f"  - ì‹œì‘ ì‹œê°„: {df['timestamp'].min()}")
    print(f"  - ì¢…ë£Œ ì‹œê°„: {df['timestamp'].max()}")
    print(f"  - ì „ì²´ ê¸°ê°„: {df['timestamp'].max() - df['timestamp'].min()}")
    
    # timestamp ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    df = df.sort_values('timestamp')
    
    # 20ë¶„ ë‹¨ìœ„ë¡œ ê·¸ë£¹ ìƒì„±
    # ì‹œì‘ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ 20ë¶„ ê°„ê²© ì„¤ì •
    start_time = df['timestamp'].min()
    
    # ì‹œì‘ ì‹œê°„ì´ ì •í™•íˆ 20ë¶„ ë‹¨ìœ„ê°€ ì•„ë‹ ê²½ìš° ì¡°ì •
    if start_time.minute % 20 != 0:
        # ë‹¤ìŒ 20ë¶„ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼
        minutes_to_add = 20 - (start_time.minute % 20)
        start_time = start_time + timedelta(minutes=minutes_to_add)
        start_time = start_time.replace(second=0, microsecond=0)
    
    print(f"\nâ° 20ë¶„ ë‹¨ìœ„ ì‹œì‘ ì‹œê°„: {start_time}")
    
    # 20ë¶„ ë‹¨ìœ„ ê·¸ë£¹ í• ë‹¹
    df['group'] = ((df['timestamp'] - start_time) // timedelta(minutes=20)).astype(int)
    
    # ìŒìˆ˜ ê·¸ë£¹(ì‹œì‘ ì‹œê°„ ì´ì „ ë°ì´í„°)ì€ 0ìœ¼ë¡œ ì„¤ì •
    df.loc[df['group'] < 0, 'group'] = -1
    
    # ê·¸ë£¹ë³„ë¡œ íŒŒì¼ ì €ì¥
    groups = df.groupby('group')
    
    print(f"\nğŸ“ˆ ì´ {len(groups)}ê°œì˜ 20ë¶„ ë‹¨ìœ„ ê·¸ë£¹ ìƒì„±")
    print("\nğŸ”„ íŒŒì¼ ë¶„í•  ì§„í–‰ ì¤‘...")
    
    saved_files = []
    
    for group_id, group_data in groups:
        if group_id == -1:
            # ì‹œì‘ ì‹œê°„ ì´ì „ ë°ì´í„°
            filename = f"before_start_time.csv"
        else:
            # í•´ë‹¹ ê·¸ë£¹ì˜ ì‹œì‘ ì‹œê°„ ê³„ì‚°
            group_start = start_time + timedelta(minutes=20 * group_id)
            group_end = group_start + timedelta(minutes=20)
            
            # íŒŒì¼ëª… ìƒì„± (YYYYMMDD_HHMM_to_HHMM.csv)
            filename = f"{group_start.strftime('%Y%m%d_%H%M')}_to_{group_end.strftime('%H%M')}.csv"
        
        # group ì»¬ëŸ¼ ì œê±°í•˜ê³  ì €ì¥
        output_path = os.path.join(output_dir, filename)
        group_data.drop(columns=['group']).to_csv(output_path, index=False)
        
        # ì €ì¥ ì •ë³´ ê¸°ë¡
        saved_files.append({
            'filename': filename,
            'rows': len(group_data),
            'start_time': group_data['timestamp'].min(),
            'end_time': group_data['timestamp'].max()
        })
        
        # ì§„í–‰ìƒí™© ì¶œë ¥ (10ê°œë§ˆë‹¤)
        if len(saved_files) % 10 == 0:
            print(f"  âœ… {len(saved_files)}ê°œ íŒŒì¼ ì €ì¥ ì™„ë£Œ...")
    
    print(f"\nâœ¨ ë¶„í•  ì™„ë£Œ! ì´ {len(saved_files)}ê°œ íŒŒì¼ ìƒì„±")
    
    # ê²°ê³¼ ìš”ì•½ ì¶œë ¥
    print("\nğŸ“‹ ë¶„í•  ê²°ê³¼ ìš”ì•½:")
    print("-" * 80)
    print(f"{'íŒŒì¼ëª…':45} {'í–‰ ìˆ˜':>10} {'ì‹œì‘ ì‹œê°„':20} {'ì¢…ë£Œ ì‹œê°„':20}")
    print("-" * 80)
    
    # ì²˜ìŒ 5ê°œì™€ ë§ˆì§€ë§‰ 5ê°œ íŒŒì¼ ì •ë³´ ì¶œë ¥
    display_files = saved_files[:5] + ['...'] + saved_files[-5:] if len(saved_files) > 10 else saved_files
    
    for file_info in display_files:
        if file_info == '...':
            print(f"{'...':45} {'...':>10} {'...':20} {'...':20}")
        else:
            print(f"{file_info['filename']:45} {file_info['rows']:>10,} "
                  f"{str(file_info['start_time']):20} {str(file_info['end_time']):20}")
    
    print("-" * 80)
    
    # í†µê³„ ì •ë³´
    total_rows = sum(f['rows'] for f in saved_files)
    avg_rows = total_rows / len(saved_files)
    
    print(f"\nğŸ“Š í†µê³„:")
    print(f"  - ì´ íŒŒì¼ ìˆ˜: {len(saved_files)}ê°œ")
    print(f"  - ì´ ë°ì´í„° í–‰ ìˆ˜: {total_rows:,}")
    print(f"  - í‰ê·  í–‰ ìˆ˜/íŒŒì¼: {avg_rows:,.1f}")
    print(f"  - ìµœëŒ€ í–‰ ìˆ˜: {max(f['rows'] for f in saved_files):,}")
    print(f"  - ìµœì†Œ í–‰ ìˆ˜: {min(f['rows'] for f in saved_files):,}")
    
    return saved_files

def analyze_20min_data(input_file='full.csv'):
    """
    20ë¶„ ë‹¨ìœ„ ë°ì´í„° ë¶„ì„ (ë¶„í•  ì „ ë¯¸ë¦¬ë³´ê¸°)
    """
    print("ğŸ“Š 20ë¶„ ë‹¨ìœ„ ë°ì´í„° ë¶„ì„ ì¤‘...")
    
    # CSV íŒŒì¼ ì½ê¸°
    df = pd.read_csv(input_file)
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    df = df.sort_values('timestamp')
    
    # ì‹œì‘ ì‹œê°„ ì°¾ê¸°
    start_time = df['timestamp'].min()
    print(f"\nğŸ• ë°ì´í„° ì‹œì‘ ì‹œê°„: {start_time}")
    
    # 20ë¶„ ë‹¨ìœ„ë¡œ ì¡°ì •ëœ ì‹œì‘ ì‹œê°„
    if start_time.minute % 20 != 0:
        minutes_to_add = 20 - (start_time.minute % 20)
        adjusted_start = start_time + timedelta(minutes=minutes_to_add)
        adjusted_start = adjusted_start.replace(second=0, microsecond=0)
    else:
        adjusted_start = start_time.replace(second=0, microsecond=0)
    
    print(f"ğŸ• 20ë¶„ ë‹¨ìœ„ ì¡°ì • ì‹œê°„: {adjusted_start}")
    
    # ì²˜ìŒ ëª‡ ê°œì˜ 20ë¶„ êµ¬ê°„ ë¯¸ë¦¬ë³´ê¸°
    print("\nğŸ“… ì²˜ìŒ 10ê°œ êµ¬ê°„ ë¯¸ë¦¬ë³´ê¸°:")
    print("-" * 60)
    
    for i in range(10):
        interval_start = adjusted_start + timedelta(minutes=20 * i)
        interval_end = interval_start + timedelta(minutes=20)
        
        # í•´ë‹¹ êµ¬ê°„ì˜ ë°ì´í„° ìˆ˜ ê³„ì‚°
        mask = (df['timestamp'] >= interval_start) & (df['timestamp'] < interval_end)
        count = mask.sum()
        
        if count > 0:
            print(f"[{i+1:2d}] {interval_start.strftime('%Y-%m-%d %H:%M')} ~ "
                  f"{interval_end.strftime('%H:%M')} : {count:,}ê°œ ë°ì´í„°")
    
    print("-" * 60)

# ì‹¤í–‰ ì˜ˆì œ
if __name__ == "__main__":
    # 1. ë¨¼ì € ë°ì´í„° ë¶„ì„
    print("="* 80)
    print("ğŸ” 20ë¶„ ë‹¨ìœ„ ë°ì´í„° ë¶„ì„")
    print("="* 80)
    analyze_20min_data('full.csv')
    
    # 2. ì‚¬ìš©ì í™•ì¸
    print("\n" + "="* 80)
    user_input = input("\nğŸ“Œ ë°ì´í„°ë¥¼ 20ë¶„ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
    
    if user_input.lower() == 'y':
        print("\n" + "="* 80)
        print("âœ‚ï¸ CSV íŒŒì¼ 20ë¶„ ë‹¨ìœ„ ë¶„í•  ì‹œì‘")
        print("="* 80)
        
        # ë¶„í•  ì‹¤í–‰
        split_csv_by_20minutes('full.csv', 'split_data_20min')
        
        print("\nâœ… ì‘ì—… ì™„ë£Œ!")
        print(f"ğŸ“ ë¶„í• ëœ íŒŒì¼ë“¤ì€ 'split_data_20min' í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print("\nâŒ ë¶„í•  ì‘ì—…ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.")