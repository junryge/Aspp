import numpy as np
import pandas as pd
import pickle
from datetime import datetime, timedelta

def realtime_prediction():
    # ëª¨ë¸ ë¡œë“œ
    try:
        with open('xgboost_model_30min_10min.pkl', 'rb') as f:
            model = pickle.load(f)
    except:
        print("âŒ ëª¨ë¸ íŒŒì¼ ì—†ìŒ")
        return None
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_csv('data/HUBROOM_PIVOT_DATA.CSV', on_bad_lines='skip')
    
    # ìµœê·¼ 30ê°œ ë°ì´í„°
    recent_30 = df.tail(30).copy()
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    seq_target = recent_30[TARGET_COL].values
    
    # STAT_DT ì²˜ë¦¬
    if 'STAT_DT' in recent_30.columns:
        try:
            recent_30['STAT_DT'] = pd.to_datetime(recent_30['STAT_DT'].astype(str), format='%Y%m%d%H%M')
        except:
            base_time = datetime(2024, 1, 1, 0, 0)
            recent_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    
    seq_start = recent_30['STAT_DT'].iloc[0]
    seq_end = recent_30['STAT_DT'].iloc[-1]
    prediction_start = seq_end + timedelta(minutes=1)
    prediction_end = seq_end + timedelta(minutes=10)
    
    # Feature ìƒì„±
    features = {
        'target_mean': np.mean(seq_target),
        'target_std': np.std(seq_target),
        'target_last_5_mean': np.mean(seq_target[-5:]),
        'target_max': np.max(seq_target),
        'target_min': np.min(seq_target),
        'target_slope': np.polyfit(np.arange(30), seq_target, 1)[0],
        'target_last_10_mean': np.mean(seq_target[-10:]),
        'target_first_10_mean': np.mean(seq_target[:10])
    }
    
    X_pred = pd.DataFrame([features])
    
    # ì˜ˆì¸¡ (10ë¶„ êµ¬ê°„ MAX)
    prediction_max = model.predict(X_pred)[0]
    
    # ê²°ê³¼ ì¶œë ¥
    print("\n" + "="*60)
    print("ğŸš€ ì‹¤ì‹œê°„ HUBROOM ì˜ˆì¸¡")
    print("="*60)
    print(f"í˜„ì¬ì‹œê°„: {seq_end.strftime('%Y-%m-%d %H:%M')}")
    print(f"ì‹œí€€ìŠ¤: {seq_start.strftime('%H:%M')} ~ {seq_end.strftime('%H:%M')} (30ë¶„)")
    print(f"ì˜ˆì¸¡êµ¬ê°„: {prediction_start.strftime('%H:%M')} ~ {prediction_end.strftime('%H:%M')} (10ë¶„)")
    print(f"\nğŸ“Š 10ë¶„ êµ¬ê°„ MAX ì˜ˆì¸¡ê°’: {prediction_max:.2f}")
    
    if prediction_max >= 300:
        print("âš ï¸ ìƒíƒœ: ğŸ”´ ê·¹ë‹¨ê°’ ê²½ê³ ! (10ë¶„ ë‚´ 300+ ì˜ˆìƒ)")
    elif prediction_max >= 280:
        print("âš ï¸ ìƒíƒœ: ğŸŸ¡ ì£¼ì˜ í•„ìš” (10ë¶„ ë‚´ 280+ ì˜ˆìƒ)")
    else:
        print("âœ… ìƒíƒœ: ğŸŸ¢ ì •ìƒ ë²”ìœ„")
    
    # ì í”„ ê°€ëŠ¥ì„± ì²´í¬
    if features['target_max'] < 280 and prediction_max >= 300:
        print("\nğŸ”¥ ì í”„ ê²½ê³ : í˜„ì¬ 280 ë¯¸ë§Œ â†’ 10ë¶„ ë‚´ 300+ ì˜ˆìƒ!")
    
    print("="*60)
    
    return prediction_max

# ì‹¤í–‰
if __name__ == '__main__':
    result = realtime_prediction()
    print(f"\nìµœì¢… ê²°ê³¼: 10ë¶„ ë‚´ ìµœëŒ€ê°’ {result:.2f} ì˜ˆìƒ")