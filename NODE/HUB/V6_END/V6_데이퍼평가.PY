import numpy as np
import pandas as pd
import pickle
from datetime import datetime, timedelta
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

def evaluate_and_save_csv(test_file='BBB.CSV'):
    """
    ê° ì‹œì ì˜ ì‹¤ì œê°’ ê·¸ëŒ€ë¡œ + ì˜ˆì¸¡ê°’ ë¹„êµ
    """
    # ëª¨ë¸ ë¡œë“œ
    try:
        with open('xgboost_model_30min_10min.pkl', 'rb') as f:
            model = pickle.load(f)
    except:
        print("âŒ ëª¨ë¸ íŒŒì¼ ì—†ìŒ")
        return
    
    # ë°ì´í„° ë¡œë“œ
    df_test = pd.read_csv(test_file, on_bad_lines='skip')
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    
    # STAT_DT ì²˜ë¦¬
    if 'STAT_DT' in df_test.columns:
        try:
            df_test['STAT_DT'] = pd.to_datetime(df_test['STAT_DT'].astype(str), format='%Y%m%d%H%M')
        except:
            base_date = datetime(2024, 1, 1, 10, 0)  # 10:00 ì‹œì‘
            df_test['STAT_DT'] = [base_date + timedelta(minutes=i) for i in range(len(df_test))]
    
    # ì „ì²´ ë°ì´í„°ì— ì‹¤ì œê°’ ì¶”ê°€
    all_results = []
    
    # ëª¨ë“  ì‹œì ì˜ ì‹¤ì œê°’ ì €ì¥
    for i in range(len(df_test)):
        all_results.append({
            'ë‚ ì§œì‹œê°„': df_test['STAT_DT'].iloc[i].strftime('%Y-%m-%d %H:%M'),
            'ì‹¤ì œê°’': round(df_test[TARGET_COL].iloc[i], 2)
        })
    
    # ì˜ˆì¸¡ ì¶”ê°€ (30ë¶„ ì‹œí€€ìŠ¤ í•„ìš”)
    for i in range(30, len(df_test) - 10):
        seq = df_test[TARGET_COL].iloc[i-30:i].values
        
        features = pd.DataFrame([{
            'target_mean': np.mean(seq),
            'target_std': np.std(seq),
            'target_last_5_mean': np.mean(seq[-5:]),
            'target_max': np.max(seq),
            'target_min': np.min(seq),
            'target_slope': np.polyfit(np.arange(30), seq, 1)[0],
            'target_last_10_mean': np.mean(seq[-10:]),
            'target_first_10_mean': np.mean(seq[:10])
        }])
        
        # ì˜ˆì¸¡ (10ë¶„ êµ¬ê°„ MAX)
        pred_value = model.predict(features)[0]
        max_10min = df_test[TARGET_COL].iloc[i:i+10].max()
        
        # i+10 ì‹œì ì— ì˜ˆì¸¡ê°’ ì¶”ê°€
        if i + 10 < len(all_results):
            all_results[i + 10]['ì˜ˆì¸¡ê°’'] = round(pred_value, 2)
            all_results[i + 10]['10ë¶„êµ¬ê°„MAX'] = round(max_10min, 2)
            all_results[i + 10]['ì‹œí€€ìŠ¤MAX'] = round(np.max(seq), 2)
            all_results[i + 10]['ì‹œí€€ìŠ¤MIN'] = round(np.min(seq), 2)
    
    df_results = pd.DataFrame(all_results)
    
    # ì˜ˆì¸¡ê°’ì´ ìˆëŠ” í–‰ë§Œ í‰ê°€
    eval_df = df_results.dropna(subset=['ì˜ˆì¸¡ê°’'])
    
    if len(eval_df) > 0:
        # MAX ê¸°ì¤€ í‰ê°€ (ëª¨ë¸ì´ MAX ì˜ˆì¸¡í•˜ë„ë¡ í•™ìŠµë¨)
        actual = eval_df['10ë¶„êµ¬ê°„MAX'].values
        predicted = eval_df['ì˜ˆì¸¡ê°’'].values
        
        mae = mean_absolute_error(actual, predicted)
        rmse = np.sqrt(mean_squared_error(actual, predicted))
        r2 = r2_score(actual, predicted)
        
        print(f"\nğŸ“Š í‰ê°€ ê²°ê³¼:")
        print(f"  MAE:  {mae:.2f}")
        print(f"  RMSE: {rmse:.2f}")
        print(f"  RÂ²:   {r2:.3f}")
    
    # CSV ì €ì¥
    df_results.to_csv('evaluation_results.csv', index=False, encoding='utf-8-sig')
    print(f"\nâœ… ì €ì¥: evaluation_results.csv")
    
    # ìƒ˜í”Œ ì¶œë ¥
    print("\nìƒ˜í”Œ:")
    print(df_results[['ë‚ ì§œì‹œê°„', 'ì‹¤ì œê°’', 'ì˜ˆì¸¡ê°’']].head(50))
    
    return df_results

# ì‹¤í–‰
if __name__ == '__main__':
    results = evaluate_and_save_csv('BBB.CSV')