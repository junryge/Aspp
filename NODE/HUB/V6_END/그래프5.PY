import tkinter as tk
from tkinter import filedialog, messagebox, colorchooser, scrolledtext, ttk
import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import webbrowser
import os

# --------------------------------------------------------------------------
# ì¸ì½”ë”© ìë™ ê°ì§€ í•¨ìˆ˜ ì¶”ê°€
# --------------------------------------------------------------------------
def read_csv_safe(filepath):
    """ì—¬ëŸ¬ ì¸ì½”ë”©ì„ ì‹œë„í•˜ì—¬ CSV íŒŒì¼ì„ ì•ˆì „í•˜ê²Œ ì½ìŠµë‹ˆë‹¤."""
    encodings = ['utf-8', 'cp949', 'euc-kr', 'ms949', 'latin-1']
    
    for encoding in encodings:
        try:
            return pd.read_csv(filepath, encoding=encoding)
        except UnicodeDecodeError:
            continue
    
    return pd.read_csv(filepath, encoding='utf-8', errors='ignore')

# --------------------------------------------------------------------------
# ì„±ëŠ¥ ì •ë³´ ì°½ í´ë˜ìŠ¤
# --------------------------------------------------------------------------
class PerformanceWindow:
    def __init__(self, parent):
        self.window = tk.Toplevel(parent)
        self.window.title("í‰ê°€ ê²°ê³¼ ë¶„ì„ ì…ë ¥")
        self.window.geometry("600x700")
        
        self.values = None
        
        main_frame = tk.Frame(self.window)
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        top_frame = tk.LabelFrame(main_frame, text="ğŸ“Š ì „ì²´ ì„±ëŠ¥ ì§€í‘œ ì…ë ¥", padx=10, pady=10)
        top_frame.pack(fill='x', pady=(0, 10))
        
        input_frame = tk.Frame(top_frame)
        input_frame.pack(pady=10)
        
        tk.Label(input_frame, text="MAE:", font=('Arial', 10)).grid(row=0, column=0, sticky='e', padx=5, pady=5)
        self.mae_var = tk.StringVar(value="30.23")
        tk.Entry(input_frame, textvariable=self.mae_var, width=15).grid(row=0, column=1, padx=5, pady=5)
        
        tk.Label(input_frame, text="RMSE:", font=('Arial', 10)).grid(row=1, column=0, sticky='e', padx=5, pady=5)
        self.rmse_var = tk.StringVar(value="36.02")
        tk.Entry(input_frame, textvariable=self.rmse_var, width=15).grid(row=1, column=1, padx=5, pady=5)
        
        tk.Label(input_frame, text="RÂ²:", font=('Arial', 10)).grid(row=2, column=0, sticky='e', padx=5, pady=5)
        self.r2_var = tk.StringVar(value="0.72")
        tk.Entry(input_frame, textvariable=self.r2_var, width=15).grid(row=2, column=1, padx=5, pady=5)
        
        bottom_frame = tk.LabelFrame(main_frame, text="ğŸ“ ê¸°íƒ€ ì •ë³´ (ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)", padx=10, pady=10)
        bottom_frame.pack(fill='both', expand=True)
        
        self.text_widget = scrolledtext.ScrolledText(bottom_frame, height=20, width=70, wrap=tk.WORD)
        self.text_widget.pack(fill='both', expand=True)
        
        self.text_widget.insert('1.0', """ğŸ“Š í‰ê°€ ê²°ê³¼ ë¶„ì„""")
        
        tk.Button(main_frame, text="í™•ì¸", 
                 command=self.save_and_close,
                 bg='#3498DB', fg='white',
                 font=('Arial', 10, 'bold')).pack(pady=10)
        
    def save_and_close(self):
        self.values = {
            'mae': self.mae_var.get(),
            'rmse': self.rmse_var.get(),
            'r2': self.r2_var.get(),
            'other_info': self.text_widget.get('1.0', 'end-1c')
        }
        self.window.destroy()

# --------------------------------------------------------------------------
# ê·¸ë˜í”„ ìƒì„± ë¡œì§
# --------------------------------------------------------------------------
def create_graph(params, perf_values=None):
    try:
        df = read_csv_safe(params['file_path'])
        
        actual_x_col = params['actual_x']
        actual_y_col = params['actual_y']
        hubroom_x_col = params['hubroom_x']
        hubroom_y_col = params['hubroom_y']
        predicted1_x_col = params['predicted1_x']
        predicted1_y_col = params['predicted1_y']
        predicted2_x_col = params['predicted2_x']
        predicted2_y_col = params['predicted2_y']
        predicted3_x_col = params['predicted3_x']
        predicted3_y_col = params['predicted3_y']
        
        # Yê°’ì„ ìˆ«ìë¡œ ë³€í™˜
        df[actual_y_col] = pd.to_numeric(df[actual_y_col], errors='coerce')
        df[hubroom_y_col] = pd.to_numeric(df[hubroom_y_col], errors='coerce')
        df[predicted1_y_col] = pd.to_numeric(df[predicted1_y_col], errors='coerce')
        df[predicted2_y_col] = pd.to_numeric(df[predicted2_y_col], errors='coerce')
        df[predicted3_y_col] = pd.to_numeric(df[predicted3_y_col], errors='coerce')
        
        # íŠ¸ë Œë“œ ë°ì´í„° ì²˜ë¦¬
        trend_data = params.get('trend_data', [])
        for trend_info in trend_data:
            x_col = trend_info['x_col']
            y_col = trend_info['y_col']
            if x_col in df.columns and y_col in df.columns:
                df[y_col] = pd.to_numeric(df[y_col], errors='coerce')
                try:
                    df[x_col] = pd.to_datetime(df[x_col])
                except:
                    pass
        
        # í•„ìˆ˜ ì»¬ëŸ¼ë§Œ NaN ì²´í¬
        required_cols = [actual_y_col, hubroom_y_col, predicted1_y_col, predicted2_y_col, predicted3_y_col]
        df = df.dropna(subset=required_cols)
        
        # ë‚ ì§œ ë³€í™˜
        try:
            df[actual_x_col] = pd.to_datetime(df[actual_x_col])
        except:
            pass
            
        try:
            df[hubroom_x_col] = pd.to_datetime(df[hubroom_x_col])
        except:
            pass
            
        try:
            df[predicted1_x_col] = pd.to_datetime(df[predicted1_x_col])
        except:
            pass
            
        try:
            df[predicted2_x_col] = pd.to_datetime(df[predicted2_x_col])
        except:
            pass
            
        try:
            df[predicted3_x_col] = pd.to_datetime(df[predicted3_x_col])
        except:
            pass
        
        # ì‹¤ì œê°’ì˜ ì‹œê°„ì„ ê³µí†µ ì‹œê°„ì¶•ìœ¼ë¡œ ì‚¬ìš©
        df['common_time'] = df[actual_x_col]

        fig = go.Figure()

        # ê¸°ë³¸ í˜¸ë²„ í…œí”Œë¦¿
        base_hover = '<b style="color: #2E86C1; font-size: 14px;">ğŸ“Š INFO</b><br>' + \
                     '<b>ì‹œê°„:</b> %{x}<br>' + \
                     '<b>ê°’:</b> %{y:.2f}' + \
                     '<extra></extra>'

        # ì‹¤ì œê°’ ë¼ì¸
        fig.add_trace(go.Scattergl(
            x=df['common_time'],
            y=df[actual_y_col], 
            mode='lines+markers',
            name='ì‹¤ì œê°’ (Actual)',
            line=dict(color=params['actual_color'], 
                     dash=None if params['actual_style'] == 'Solid' else params['actual_style'].lower(), 
                     width=3),
            marker=dict(size=6),
            hovertemplate=base_hover
        ))
        
        # HUBROOM ë¼ì¸
        fig.add_trace(go.Scattergl(
            x=df['common_time'],
            y=df[hubroom_y_col], 
            mode='lines+markers',
            name='HUBROOM',
            line=dict(color=params['hubroom_color'], 
                     dash=None if params['hubroom_style'] == 'Solid' else params['hubroom_style'].lower(), 
                     width=3),
            marker=dict(size=6),
            hovertemplate=base_hover
        ))
        
        # ì˜ˆì¸¡ê°’1 ë¼ì¸
        fig.add_trace(go.Scattergl(
            x=df['common_time'],
            y=df[predicted1_y_col], 
            mode='lines+markers',
            name='ì˜ˆì¸¡ê°’1 (Predicted1)',
            line=dict(color=params['predicted1_color'], 
                     dash=None if params['predicted1_style'] == 'Solid' else params['predicted1_style'].lower(), 
                     width=3),
            marker=dict(size=6),
            hovertemplate=base_hover
        ))
        
        # ì˜ˆì¸¡ê°’2 ë¼ì¸
        fig.add_trace(go.Scattergl(
            x=df['common_time'],
            y=df[predicted2_y_col], 
            mode='lines+markers',
            name='ì˜ˆì¸¡ê°’2 (Predicted2)',
            line=dict(color=params['predicted2_color'], 
                     dash=None if params['predicted2_style'] == 'Solid' else params['predicted2_style'].lower(), 
                     width=3),
            marker=dict(size=6),
            hovertemplate=base_hover
        ))
        
        # ì˜ˆì¸¡ê°’3 ë¼ì¸ (ìƒˆë¡œ ì¶”ê°€!)
        fig.add_trace(go.Scattergl(
            x=df['common_time'],
            y=df[predicted3_y_col], 
            mode='lines+markers',
            name='ì˜ˆì¸¡ê°’3 (Predicted3)',
            line=dict(color=params['predicted3_color'], 
                     dash=None if params['predicted3_style'] == 'Solid' else params['predicted3_style'].lower(), 
                     width=3),
            marker=dict(size=6),
            hovertemplate=base_hover
        ))
        
        # íŠ¸ë Œë“œ ë°ì´í„° ë¼ì¸ë“¤
        trend_colors = ['#808080', '#A9A9A9', '#696969', '#778899', '#708090', 
                       '#2F4F4F', '#556B2F', '#8B4513', '#A0522D', '#B8860B',
                       '#BDB76B', '#8B008B', '#9932CC', '#8B0000', '#DC143C',
                       '#FF6347', '#FF4500']
        
        for idx, trend_info in enumerate(trend_data):
            x_col = trend_info['x_col']
            y_col = trend_info['y_col']
            name = trend_info['name']
            
            if x_col in df.columns and y_col in df.columns:
                color = trend_colors[idx % len(trend_colors)]
                fig.add_trace(go.Scattergl(
                    x=df[x_col],  # ê° íŠ¸ë Œë“œ ë°ì´í„°ì˜ ê³ ìœ  Xì¶• ì‚¬ìš©
                    y=df[y_col],
                    mode='lines',
                    name=f'Trend: {name}',
                    line=dict(color=color, dash='dot', width=1.5),
                    opacity=0.7,
                    hovertemplate=f'<b>{name}</b><br>' + 
                                 'ì‹œê°„: %{x}<br>' + 
                                 'ê°’: %{y:.2f}' +
                                 '<extra></extra>'
                ))
        
        # ë¦¬ë¯¸íŠ¸ì„ 
        try:
            limit_value = float(params.get('limit_value', 300))
            all_x = df['common_time'].sort_values()
            limit_x = pd.date_range(start=all_x.iloc[0], end=all_x.iloc[-1], periods=100)
            limit_y = [limit_value] * 100
            
            fig.add_trace(go.Scatter(
                x=limit_x,
                y=limit_y,
                mode='lines',
                name=f'ë¦¬ë¯¸íŠ¸ì„  ({limit_value})',
                line=dict(color='red', width=2.5),
                hovertemplate='<b style="color: red;">âš ï¸ ë¦¬ë¯¸íŠ¸ì„ </b><br>' +
                             f'<span style="color: red;">ì„¤ì •ê°’: {limit_value:.2f}</span><br>' +
                             '<extra></extra>'
            ))
        except:
            pass
        
        # ë ˆì´ì•„ì›ƒ
        fig.update_layout(
            title=params['title'], 
            xaxis_title='ì‹œê°„', 
            yaxis_title='ê°’', 
            hovermode='closest',
            plot_bgcolor='white',
            xaxis=dict(showgrid=True, gridcolor='lightgray'),
            yaxis=dict(showgrid=True, gridcolor='lightgray'),
            showlegend=True,
            legend=dict(
                yanchor="top",
                y=0.99,
                xanchor="left",
                x=0.01
            ),
            hoverlabel=dict(
                bgcolor="white",
                font_size=12,
                font_family="Arial",
                bordercolor="#2E86C1"
            )
        )

        output_filename = "final_guided_graph.html"
        html_content = fig.to_html(include_plotlyjs='cdn')

        if perf_values:
            other_info = perf_values.get('other_info', 'ì •ë³´ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
            other_info_escaped = other_info.replace('<', '&lt;').replace('>', '&gt;')
            
            performance_section = f"""
            <div style="margin: 30px auto; max-width: 1200px; padding: 0 20px;">
                <div style="background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="color: #2E86C1; text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2E86C1; padding-bottom: 15px;">
                        ğŸ“Š í‰ê°€ ê²°ê³¼ ë¶„ì„ - ê¸°íƒ€ ì •ë³´
                    </h2>
                    <div style="white-space: pre-wrap; line-height: 1.8; font-size: 14px; color: #333; background-color: #f8f9fa; padding: 25px; border-radius: 8px; border: 2px solid #dee2e6; font-family: 'Courier New', monospace;">
{other_info_escaped}
                    </div>
                </div>
            </div>
            """
        else:
            performance_section = ""

        html_content = html_content.replace('</body>', performance_section + '</body>')

        style_section = """
        <style>
            body {
                background-color: #f8f9fa;
                margin: 0;
                padding: 20px 0;
            }
            .plotly-graph-div {
                margin: 0 auto;
                max-width: 1400px;
            }
        </style>
        """
        html_content = html_content.replace('</head>', style_section + '</head>')

        with open(output_filename, 'w', encoding='utf-8') as f:
            f.write(html_content)

        webbrowser.open('file://' + os.path.realpath(output_filename))

        trend_count = len(trend_data)
        messagebox.showinfo("ì„±ê³µ", 
            f"'{output_filename}' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n"
            f"âœ… ì‹¤ì œê°’ + HUBROOM + ì˜ˆì¸¡ê°’3ê°œ (ì´ 5ê°œ ë©”ì¸ ë¼ì¸)\n"
            f"âœ… íŠ¸ë Œë“œ {trend_count}ê°œ (ê°ê° ê³ ìœ  Xì¶• ì‚¬ìš©)\n"
            f"âœ… ë²”ë¡€ í´ë¦­ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€ ê°€ëŠ¥")
            
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ê·¸ë˜í”„ ìƒì„± ì¤‘ ì˜¤ë¥˜:\n{e}")

# --------------------------------------------------------------------------
# GUI ì• í”Œë¦¬ì¼€ì´ì…˜
# --------------------------------------------------------------------------
class GraphApp:
    def __init__(self, root):
        self.root = root
        self.root.title("ë‹¨ê³„ë³„ ê·¸ë˜í”„ ìƒì„±ê¸° v4.0 (ì˜ˆì¸¡ê°’3ê°œ + íŠ¸ë Œë“œ X/Yì¶•)")
        self.root.geometry("1100x900")
        
        self.file_path = ""
        self.df_columns = []
        self.perf_values = None
        self.trend_widgets = []

        # ì „ì²´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë©”ì¸ ì»¨í…Œì´ë„ˆ
        main_canvas = tk.Canvas(root)
        scrollbar = tk.Scrollbar(root, orient="vertical", command=main_canvas.yview)
        self.scrollable_frame = tk.Frame(main_canvas)
        
        self.scrollable_frame.bind(
            "<Configure>",
            lambda e: main_canvas.configure(scrollregion=main_canvas.bbox("all"))
        )
        
        main_canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        main_canvas.configure(yscrollcommand=scrollbar.set)
        
        # ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ ì§€ì›
        def _on_mousewheel(event):
            main_canvas.yview_scroll(int(-1*(event.delta/120)), "units")
        main_canvas.bind_all("<MouseWheel>", _on_mousewheel)
        
        main_canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

        # ìƒë‹¨ ë²„íŠ¼ í”„ë ˆì„
        top_button_frame = tk.Frame(self.scrollable_frame)
        top_button_frame.pack(fill='x', padx=10, pady=10)
        
        tk.Button(top_button_frame, text="ğŸ“Š ë‚´ìš©ì •ë³´ ì…ë ¥", 
                 command=self.open_performance_window,
                 font=('Arial', 10, 'bold'),
                 bg='#2ECC71', fg='white',
                 width=15, height=2).pack(side='right', padx=5)

        # 1ë‹¨ê³„: íŒŒì¼ ì„ íƒ
        self.step1_frame = tk.LabelFrame(self.scrollable_frame, text="âœ… 1ë‹¨ê³„: íŒŒì¼ ì„ íƒ", padx=10, pady=10)
        self.step1_frame.pack(fill='x', padx=10, pady=5)
        
        tk.Button(self.step1_frame, text="CSV íŒŒì¼ ì—´ê¸°", command=self.select_file, 
                 font=('Helvetica', 10, 'bold'), bg='#e8f4f8').pack(side='left')
        self.file_label = tk.Label(self.step1_frame, text="ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", fg="blue")
        self.file_label.pack(side='left', padx=10)
        
        # 2ë‹¨ê³„: ë°ì´í„° ì»¬ëŸ¼ ì„ íƒ
        self.step2_frame = tk.LabelFrame(self.scrollable_frame, text="ğŸ”’ 2ë‹¨ê³„: ë©”ì¸ ë°ì´í„° ì»¬ëŸ¼ ì„ íƒ", padx=10, pady=10)
        self.step2_frame.pack(fill='x', padx=10, pady=5)
        self.create_step2_widgets()
        
        # 2.5ë‹¨ê³„: íŠ¸ë Œë“œ ë°ì´í„° ì„ íƒ
        self.step2_5_frame = tk.LabelFrame(self.scrollable_frame, text="ğŸ”’ 2.5ë‹¨ê³„: íŠ¸ë Œë“œ ë°ì´í„° ì„ íƒ (ê°ê° Xì¶•/Yì¶• ì§€ì •)", padx=10, pady=10)
        self.step2_5_frame.pack(fill='x', padx=10, pady=5)
        self.create_step2_5_widgets()

        # 3ë‹¨ê³„: ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ ì„¤ì •
        self.step3_frame = tk.LabelFrame(self.scrollable_frame, text="ğŸ”’ 3ë‹¨ê³„: ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ ì„¤ì •", padx=10, pady=10)
        self.step3_frame.pack(fill='x', padx=10, pady=5)
        self.create_step3_widgets()
        
        # 4ë‹¨ê³„: ê·¸ë˜í”„ ìƒì„±
        self.step4_frame = tk.LabelFrame(self.scrollable_frame, text="ğŸ”’ 4ë‹¨ê³„: ê·¸ë˜í”„ ìƒì„±", padx=10, pady=10)
        self.step4_frame.pack(fill='x', padx=10, pady=5)
        self.create_step4_widgets()
        
        # ì´ˆê¸° ë¹„í™œì„±í™”
        self.toggle_widgets_state(self.step2_frame, 'disabled')
        self.toggle_widgets_state(self.step2_5_frame, 'disabled')
        self.toggle_widgets_state(self.step3_frame, 'disabled')
        self.toggle_widgets_state(self.step4_frame, 'disabled')
    
    def open_performance_window(self):
        perf_window = PerformanceWindow(self.root)
        self.root.wait_window(perf_window.window)
        self.perf_values = perf_window.values
    
    def toggle_widgets_state(self, frame, state):
        for child in frame.winfo_children():
            try:
                child.config(state=state)
            except tk.TclError:
                pass

    def create_step2_widgets(self):
        # ì‹¤ì œê°’ + HUBROOM + ì˜ˆì¸¡ê°’3ê°œ = ì´ 10ê°œ ì»¬ëŸ¼
        labels = [
            "ì‹¤ì œê°’ Xì¶• (ì‹œê°„):", 
            "ì‹¤ì œê°’ Yì¶• (ê°’):", 
            "HUBROOM Xì¶• (ì‹œê°„):",
            "HUBROOM Yì¶• (ê°’):",
            "ì˜ˆì¸¡ê°’1 Xì¶• (ì‹œê°„):", 
            "ì˜ˆì¸¡ê°’1 Yì¶• (ê°’):",
            "ì˜ˆì¸¡ê°’2 Xì¶• (ì‹œê°„):",
            "ì˜ˆì¸¡ê°’2 Yì¶• (ê°’):",
            "ì˜ˆì¸¡ê°’3 Xì¶• (ì‹œê°„):",  # ìƒˆë¡œ ì¶”ê°€
            "ì˜ˆì¸¡ê°’3 Yì¶• (ê°’):"      # ìƒˆë¡œ ì¶”ê°€
        ]
        self.column_vars = [tk.StringVar() for _ in labels]
        self.column_menus = []

        for i, label_text in enumerate(labels):
            tk.Label(self.step2_frame, text=label_text).grid(row=i, column=0, sticky='w', padx=5, pady=2)
            menu = tk.OptionMenu(self.step2_frame, self.column_vars[i], "")
            menu.config(width=30)
            menu.grid(row=i, column=1, sticky='ew', padx=5, pady=2)
            self.column_menus.append(menu)
    
    def create_step2_5_widgets(self):
        """íŠ¸ë Œë“œ ë°ì´í„° ì„ íƒ ìœ„ì ¯ - ê°ê° Xì¶•/Yì¶• ì§€ì • ê°€ëŠ¥"""
        # íŠ¸ë Œë“œ ë°ì´í„° ëª©ë¡
        trend_list = [
            'M14A_3F_CNV_MAXCAP',
            'M14A_3F_TO_HUB_JOB2',
            'M14A_3F_TO_HUB_JOB_ALT',
            'M14B_7F_LFT_MAXCAP',
            'M14B_7F_TO_HUB_JOB2',
            'M14B_7F_TO_HUB_JOB_ALT',
            'M16A_2F_LFT_MAXCAP',
            'M16A_2F_TO_HUB_JOB2',
            'M16A_2F_TO_HUB_JOB_ALT',
            'M16A_3F_CNV_MAXCAP',
            'M16A_3F_LFT_MAXCAP',
            'M16A_3F_M14BLFT_MAXCAP',
            'M16A_3F_STORAGE_UTIL',
            'M16A_6F_LFT_MAXCAP',
            'M16A_6F_TO_HUB_JOB',
            'M16A_6F_TO_HUB_JOB_ALT',
            'M16B_10F_TO_HUB_JOB'
        ]
        
        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í”„ë ˆì„
        canvas = tk.Canvas(self.step2_5_frame, height=300)
        scrollbar_trend = tk.Scrollbar(self.step2_5_frame, orient="vertical", command=canvas.yview)
        scrollable_trend_frame = tk.Frame(canvas)
        
        scrollable_trend_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_trend_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar_trend.set)
        
        # í—¤ë”
        tk.Label(scrollable_trend_frame, text="ì‚¬ìš©", font=('Arial', 9, 'bold')).grid(row=0, column=0, padx=5, pady=5)
        tk.Label(scrollable_trend_frame, text="íŠ¸ë Œë“œ ì´ë¦„", font=('Arial', 9, 'bold')).grid(row=0, column=1, padx=5, pady=5, sticky='w')
        tk.Label(scrollable_trend_frame, text="Xì¶• (ì‹œê°„)", font=('Arial', 9, 'bold')).grid(row=0, column=2, padx=5, pady=5)
        tk.Label(scrollable_trend_frame, text="Yì¶• (ê°’)", font=('Arial', 9, 'bold')).grid(row=0, column=3, padx=5, pady=5)
        
        # ì²´í¬ë°•ìŠ¤ì™€ ë“œë¡­ë‹¤ìš´ ìƒì„±
        self.trend_widgets = []
        
        for idx, trend_name in enumerate(trend_list):
            row = idx + 1
            
            # ì²´í¬ë°•ìŠ¤
            var = tk.BooleanVar(value=False)
            cb = tk.Checkbutton(scrollable_trend_frame, variable=var)
            cb.grid(row=row, column=0, padx=5, pady=2)
            
            # ì´ë¦„ ë¼ë²¨
            tk.Label(scrollable_trend_frame, text=trend_name, font=('Arial', 8)).grid(row=row, column=1, sticky='w', padx=5, pady=2)
            
            # Xì¶• ì„ íƒ
            x_var = tk.StringVar()
            x_menu = tk.OptionMenu(scrollable_trend_frame, x_var, "")
            x_menu.config(width=20)
            x_menu.grid(row=row, column=2, padx=5, pady=2)
            
            # Yì¶• ì„ íƒ
            y_var = tk.StringVar()
            y_menu = tk.OptionMenu(scrollable_trend_frame, y_var, "")
            y_menu.config(width=20)
            y_menu.grid(row=row, column=3, padx=5, pady=2)
            
            self.trend_widgets.append({
                'name': trend_name,
                'enabled': var,
                'x_var': x_var,
                'x_menu': x_menu,
                'y_var': y_var,
                'y_menu': y_menu
            })
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar_trend.pack(side="right", fill="y")
            
    def create_step3_widgets(self):
        tk.Label(self.step3_frame, text="ê·¸ë˜í”„ ì œëª©:").grid(row=0, column=0, sticky='w', padx=5, pady=2)
        self.title_var = tk.StringVar(value="ì‚¬ìš©ì ì •ì˜ ê·¸ë˜í”„")
        tk.Entry(self.step3_frame, textvariable=self.title_var, width=50).grid(row=0, column=1, columnspan=3, sticky='ew', padx=5, pady=2)
        
        # ì‹¤ì œê°’ ë¼ì¸
        tk.Label(self.step3_frame, text="[ì‹¤ì œê°’ ë¼ì¸]").grid(row=1, column=0, sticky='w', padx=5, pady=5)
        self.actual_color_var = tk.StringVar(value='#1f77b4')
        self.actual_color_btn = tk.Button(self.step3_frame, text="ìƒ‰ìƒ", 
                                         command=lambda: self.choose_color(self.actual_color_var, self.actual_color_btn), 
                                         bg=self.actual_color_var.get())
        self.actual_color_btn.grid(row=1, column=1, padx=5)
        self.actual_style_var = tk.StringVar(value='Solid')
        tk.OptionMenu(self.step3_frame, self.actual_style_var, 'Solid', 'Dash', 'Dot').grid(row=1, column=2, padx=5)

        # HUBROOM ë¼ì¸
        tk.Label(self.step3_frame, text="[HUBROOM ë¼ì¸]").grid(row=2, column=0, sticky='w', padx=5, pady=5)
        self.hubroom_color_var = tk.StringVar(value='#9467bd')
        self.hubroom_color_btn = tk.Button(self.step3_frame, text="ìƒ‰ìƒ", 
                                         command=lambda: self.choose_color(self.hubroom_color_var, self.hubroom_color_btn), 
                                         bg=self.hubroom_color_var.get())
        self.hubroom_color_btn.grid(row=2, column=1, padx=5)
        self.hubroom_style_var = tk.StringVar(value='Solid')
        tk.OptionMenu(self.step3_frame, self.hubroom_style_var, 'Solid', 'Dash', 'Dot').grid(row=2, column=2, padx=5)

        # ì˜ˆì¸¡ê°’1 ë¼ì¸
        tk.Label(self.step3_frame, text="[ì˜ˆì¸¡ê°’1 ë¼ì¸]").grid(row=3, column=0, sticky='w', padx=5, pady=5)
        self.predicted1_color_var = tk.StringVar(value='#ff7f0e')
        self.predicted1_color_btn = tk.Button(self.step3_frame, text="ìƒ‰ìƒ", 
                                           command=lambda: self.choose_color(self.predicted1_color_var, self.predicted1_color_btn), 
                                           bg=self.predicted1_color_var.get())
        self.predicted1_color_btn.grid(row=3, column=1, padx=5)
        self.predicted1_style_var = tk.StringVar(value='Dash')
        tk.OptionMenu(self.step3_frame, self.predicted1_style_var, 'Solid', 'Dash', 'Dot').grid(row=3, column=2, padx=5)
        
        # ì˜ˆì¸¡ê°’2 ë¼ì¸
        tk.Label(self.step3_frame, text="[ì˜ˆì¸¡ê°’2 ë¼ì¸]").grid(row=4, column=0, sticky='w', padx=5, pady=5)
        self.predicted2_color_var = tk.StringVar(value='#2ca02c')
        self.predicted2_color_btn = tk.Button(self.step3_frame, text="ìƒ‰ìƒ", 
                                           command=lambda: self.choose_color(self.predicted2_color_var, self.predicted2_color_btn), 
                                           bg=self.predicted2_color_var.get())
        self.predicted2_color_btn.grid(row=4, column=1, padx=5)
        self.predicted2_style_var = tk.StringVar(value='Dot')
        tk.OptionMenu(self.step3_frame, self.predicted2_style_var, 'Solid', 'Dash', 'Dot').grid(row=4, column=2, padx=5)
        
        # ì˜ˆì¸¡ê°’3 ë¼ì¸ (ìƒˆë¡œ ì¶”ê°€!)
        tk.Label(self.step3_frame, text="[ì˜ˆì¸¡ê°’3 ë¼ì¸]").grid(row=5, column=0, sticky='w', padx=5, pady=5)
        self.predicted3_color_var = tk.StringVar(value='#d62728')
        self.predicted3_color_btn = tk.Button(self.step3_frame, text="ìƒ‰ìƒ", 
                                           command=lambda: self.choose_color(self.predicted3_color_var, self.predicted3_color_btn), 
                                           bg=self.predicted3_color_var.get())
        self.predicted3_color_btn.grid(row=5, column=1, padx=5)
        self.predicted3_style_var = tk.StringVar(value='Dash')
        tk.OptionMenu(self.step3_frame, self.predicted3_style_var, 'Solid', 'Dash', 'Dot').grid(row=5, column=2, padx=5)
        
        # ë¦¬ë¯¸íŠ¸ì„  ì„¤ì •
        tk.Label(self.step3_frame, text="[ğŸ”´ ë¦¬ë¯¸íŠ¸ì„ ]").grid(row=6, column=0, sticky='w', padx=5, pady=5)
        tk.Label(self.step3_frame, text="ê°’:").grid(row=6, column=1, sticky='e', padx=(0, 5))
        self.limit_value_var = tk.StringVar(value="300")
        tk.Entry(self.step3_frame, textvariable=self.limit_value_var, width=10).grid(row=6, column=2, sticky='w', padx=5)

    def create_step4_widgets(self):
        self.generate_button = tk.Button(self.step4_frame, text="ê·¸ë˜í”„ ìƒì„± ì‹¤í–‰", 
                                        command=self.generate_graph, 
                                        font=('Helvetica', 12, 'bold'), 
                                        bg='#d3ffd3')
        self.generate_button.pack(fill='x')

    def choose_color(self, color_var, button):
        color_code = colorchooser.askcolor(title="ìƒ‰ìƒ ì„ íƒ")[1]
        if color_code:
            color_var.set(color_code)
            button.config(bg=color_code)

    def select_file(self):
        path = filedialog.askopenfilename(filetypes=[("CSV files", "*.csv")])
        if not path: return
        
        self.file_path = path
        filename = os.path.basename(path)
        self.file_label.config(text=f"ì„ íƒë¨: {filename}")
        
        try:
            df = read_csv_safe(self.file_path)
            self.df_columns = df.columns.tolist()
            
            # ë©”ì¸ ë°ì´í„° ì»¬ëŸ¼ ë©”ë‰´ ì—…ë°ì´íŠ¸
            for i, menu in enumerate(self.column_menus):
                menu['menu'].delete(0, 'end')
                for col in self.df_columns:
                    menu['menu'].add_command(label=col, command=tk._setit(self.column_vars[i], col))
            
            # íŠ¸ë Œë“œ ë°ì´í„° ì»¬ëŸ¼ ë©”ë‰´ ì—…ë°ì´íŠ¸
            for widget_dict in self.trend_widgets:
                # Xì¶• ë©”ë‰´ ì—…ë°ì´íŠ¸
                widget_dict['x_menu']['menu'].delete(0, 'end')
                for col in self.df_columns:
                    widget_dict['x_menu']['menu'].add_command(label=col, command=tk._setit(widget_dict['x_var'], col))
                
                # Yì¶• ë©”ë‰´ ì—…ë°ì´íŠ¸
                widget_dict['y_menu']['menu'].delete(0, 'end')
                for col in self.df_columns:
                    widget_dict['y_menu']['menu'].add_command(label=col, command=tk._setit(widget_dict['y_var'], col))
            
            # ì»¬ëŸ¼ ìë™ ì¶”ì²œ
            patterns = [
                ['ë‚ ì§œ', 'date', 'time'],
                ['ì‹¤ì œê°’', 'actual', 'real'],
                ['hubroom', 'hub'],
                ['hubroom', 'hub'],
                ['ì˜ˆì¸¡ë‚ ì§œ', 'pred_date', 'forecast'],
                ['ì˜ˆì¸¡ê°’', 'predicted', 'pred'],
                ['ì˜ˆì¸¡ë‚ ì§œ', 'pred_date', 'forecast', '2'],
                ['ì˜ˆì¸¡ê°’', 'predicted', 'pred', '2'],
                ['ì˜ˆì¸¡ë‚ ì§œ', 'pred_date', 'forecast', '3'],  # ì˜ˆì¸¡ê°’3
                ['ì˜ˆì¸¡ê°’', 'predicted', 'pred', '3']          # ì˜ˆì¸¡ê°’3
            ]
            
            for idx, pattern_list in enumerate(patterns):
                for col in self.df_columns:
                    col_lower = col.lower()
                    if any(p in col_lower for p in pattern_list):
                        self.column_vars[idx].set(col)
                        break

            self.step2_frame.config(text="âœ… 2ë‹¨ê³„: ë©”ì¸ ë°ì´í„° ì»¬ëŸ¼ ì„ íƒ")
            self.toggle_widgets_state(self.step2_frame, 'normal')
            self.step2_5_frame.config(text="âœ… 2.5ë‹¨ê³„: íŠ¸ë Œë“œ ë°ì´í„° ì„ íƒ")
            self.toggle_widgets_state(self.step2_5_frame, 'normal')
            self.step3_frame.config(text="âœ… 3ë‹¨ê³„: ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ ì„¤ì •")
            self.toggle_widgets_state(self.step3_frame, 'normal')
            self.step4_frame.config(text="âœ… 4ë‹¨ê³„: ê·¸ë˜í”„ ìƒì„±")
            self.toggle_widgets_state(self.step4_frame, 'normal')

        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"CSV íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n{e}")

    def generate_graph(self):
        # ì„ íƒëœ íŠ¸ë Œë“œ ë°ì´í„° ìˆ˜ì§‘
        selected_trends = []
        for widget_dict in self.trend_widgets:
            if widget_dict['enabled'].get():
                x_col = widget_dict['x_var'].get()
                y_col = widget_dict['y_var'].get()
                if x_col and y_col:
                    selected_trends.append({
                        'name': widget_dict['name'],
                        'x_col': x_col,
                        'y_col': y_col
                    })
        
        params = {
            'file_path': self.file_path, 
            'title': self.title_var.get(),
            'actual_x': self.column_vars[0].get(), 
            'actual_y': self.column_vars[1].get(),
            'hubroom_x': self.column_vars[2].get(),
            'hubroom_y': self.column_vars[3].get(),
            'predicted1_x': self.column_vars[4].get(), 
            'predicted1_y': self.column_vars[5].get(),
            'predicted2_x': self.column_vars[6].get(),
            'predicted2_y': self.column_vars[7].get(),
            'predicted3_x': self.column_vars[8].get(),  # ì˜ˆì¸¡ê°’3 ì¶”ê°€
            'predicted3_y': self.column_vars[9].get(),  # ì˜ˆì¸¡ê°’3 ì¶”ê°€
            'actual_color': self.actual_color_var.get(), 
            'actual_style': self.actual_style_var.get(),
            'hubroom_color': self.hubroom_color_var.get(),
            'hubroom_style': self.hubroom_style_var.get(),
            'predicted1_color': self.predicted1_color_var.get(), 
            'predicted1_style': self.predicted1_style_var.get(),
            'predicted2_color': self.predicted2_color_var.get(),
            'predicted2_style': self.predicted2_style_var.get(),
            'predicted3_color': self.predicted3_color_var.get(),  # ì˜ˆì¸¡ê°’3 ì¶”ê°€
            'predicted3_style': self.predicted3_style_var.get(),  # ì˜ˆì¸¡ê°’3 ì¶”ê°€
            'limit_value': self.limit_value_var.get(),
            'trend_data': selected_trends
        }
        
        if not all([params['actual_x'], params['actual_y'], 
                   params['hubroom_x'], params['hubroom_y'],
                   params['predicted1_x'], params['predicted1_y'],
                   params['predicted2_x'], params['predicted2_y'],
                   params['predicted3_x'], params['predicted3_y']]):
            messagebox.showwarning("ê²½ê³ ", "2ë‹¨ê³„ì—ì„œ ëª¨ë“  ë©”ì¸ ë°ì´í„° ì¶•(X, Y)ì˜ ì»¬ëŸ¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return
        
        if not self.perf_values:
            self.perf_values = {
                'mae': '30.23',
                'rmse': '36.02',
                'r2': '0.72',
                'other_info': 'ê¸°íƒ€ ì •ë³´ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
            }
            
        create_graph(params, self.perf_values)

if __name__ == "__main__":
    root = tk.Tk()
    app = GraphApp(root)
    root.mainloop()