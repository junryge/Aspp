import numpy as np
import pandas as pd
import pickle
import warnings
from datetime import datetime, timedelta
import matplotlib.pyplot as plt

warnings.filterwarnings('ignore')
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

def realtime_prediction():
    """
    í•™ìŠµëœ ëª¨ë¸ë¡œ ì‹¤ì‹œê°„ ì˜ˆì¸¡ ìˆ˜í–‰
    data/HUBROOM_PIVOT_DATA.CSV ì‚¬ìš©
    """
    print("="*80)
    print("ğŸš€ ì‹¤ì‹œê°„ HUBROOM ì˜ˆì¸¡ ì‹œìŠ¤í…œ")
    print("="*80)
    
    # ===== 1. ëª¨ë¸ ë¡œë“œ =====
    print("\n[STEP 1] í•™ìŠµëœ ëª¨ë¸ ë¡œë“œ")
    print("-"*40)
    
    try:
        with open('xgboost_model_30min_10min.pkl', 'rb') as f:
            model = pickle.load(f)
        print("âœ… ëª¨ë¸ ë¡œë“œ ì„±ê³µ: xgboost_model_30min_10min.pkl")
    except FileNotFoundError:
        print("âŒ ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª¨ë¸ì„ í•™ìŠµì‹œì¼œì£¼ì„¸ìš”.")
        return None
    
    # ===== 2. ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ =====
    print("\n[STEP 2] ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ")
    print("-"*40)
    
    try:
        df = pd.read_csv('data/HUBROOM_PIVOT_DATA.CSV', on_bad_lines='skip')
        print(f"âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ: {len(df)}ê°œ í–‰")
    except FileNotFoundError:
        print("âŒ ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: data/HUBROOM_PIVOT_DATA.CSV")
        return None
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ í™•ì¸
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    
    if TARGET_COL not in df.columns:
        print(f"âŒ íƒ€ê²Ÿ ì»¬ëŸ¼ '{TARGET_COL}'ì´ ì—†ìŠµë‹ˆë‹¤.")
        print(f"ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼: {df.columns.tolist()}")
        return None
    
    # ===== 3. ìµœê·¼ 30ë¶„ ë°ì´í„° ì¶”ì¶œ =====
    print("\n[STEP 3] ìµœê·¼ 30ë¶„ ì‹œí€€ìŠ¤ ì¶”ì¶œ")
    print("-"*40)
    
    # ìµœê·¼ 30ê°œ ë°ì´í„° í™•ì¸
    if len(df) < 30:
        print(f"âŒ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 30ê°œ í•„ìš” (í˜„ì¬: {len(df)}ê°œ)")
        return None
    
    # ìµœê·¼ 30ê°œ ì¶”ì¶œ
    recent_30 = df.tail(30).copy()
    
    # ì‹œê°„ ì •ë³´ ì²˜ë¦¬
    if 'STAT_DT' in recent_30.columns:
        try:
            recent_30['STAT_DT'] = pd.to_datetime(recent_30['STAT_DT'], format='%Y%m%d%H%M')
        except:
            try:
                recent_30['STAT_DT'] = pd.to_datetime(recent_30['STAT_DT'])
            except:
                base_time = datetime.now() - timedelta(minutes=29)
                recent_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    else:
        base_time = datetime.now() - timedelta(minutes=29)
        recent_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    
    # ì‹œí€€ìŠ¤ ì •ë³´ ì¶œë ¥
    seq_start = recent_30['STAT_DT'].iloc[0]
    seq_end = recent_30['STAT_DT'].iloc[-1]
    
    print(f"ğŸ“… ì‹œí€€ìŠ¤ ê¸°ê°„:")
    print(f"   ì‹œì‘: {seq_start.strftime('%Y-%m-%d %H:%M')}")
    print(f"   ì¢…ë£Œ: {seq_end.strftime('%Y-%m-%d %H:%M')}")
    
    # ===== 4. Feature ìƒì„± =====
    print("\n[STEP 4] Feature ìƒì„±")
    print("-"*40)
    
    # íƒ€ê²Ÿ ì‹œí€€ìŠ¤
    seq_target = recent_30[TARGET_COL].values
    
    # Feature ê³„ì‚°
    features = {
        'target_mean': np.mean(seq_target),
        'target_std': np.std(seq_target),
        'target_last_5_mean': np.mean(seq_target[-5:]),
        'target_max': np.max(seq_target),
        'target_min': np.min(seq_target),
        'target_slope': np.polyfit(np.arange(30), seq_target, 1)[0],
        'target_last_10_mean': np.mean(seq_target[-10:]),
        'target_first_10_mean': np.mean(seq_target[:10])
    }
    
    # í˜„ì¬ ìƒíƒœ ë¶„ì„
    print("ğŸ“Š í˜„ì¬ ì‹œí€€ìŠ¤ ë¶„ì„:")
    print(f"   í‰ê· ê°’: {features['target_mean']:.2f}")
    print(f"   ìµœê·¼ 5ë¶„ í‰ê· : {features['target_last_5_mean']:.2f}")
    print(f"   ìµœëŒ€ê°’: {features['target_max']:.2f}")
    print(f"   ìµœì†Œê°’: {features['target_min']:.2f}")
    print(f"   ë³€ë™í­: {features['target_max'] - features['target_min']:.2f}")
    print(f"   ì¶”ì„¸: {'ìƒìŠ¹' if features['target_slope'] > 0 else 'í•˜ë½'} ({features['target_slope']:.3f})")
    
    # DataFrameìœ¼ë¡œ ë³€í™˜
    X_pred = pd.DataFrame([features])
    
    # ===== 5. ì˜ˆì¸¡ ìˆ˜í–‰ =====
    print("\n[STEP 5] ì˜ˆì¸¡ ìˆ˜í–‰")
    print("-"*40)
    
    # ì˜ˆì¸¡
    prediction = model.predict(X_pred)[0]
    
    # ì˜ˆì¸¡ ì‹œì 
    prediction_time = seq_end + timedelta(minutes=10)
    
    print("\nğŸ¯ ì˜ˆì¸¡ ê²°ê³¼:")
    print("="*60)
    print(f"  ì˜ˆì¸¡ ì‹œì : {prediction_time.strftime('%Y-%m-%d %H:%M')}")
    print(f"  ì˜ˆì¸¡ê°’: {prediction:.2f}")
    
    # ìœ„í—˜ë„ í‰ê°€
    if prediction >= 300:
        risk_level = "ğŸ”´ ê·¹ë‹¨ê°’ ê²½ê³ !"
        risk_color = 'red'
    elif prediction >= 280:
        risk_level = "ğŸŸ¡ ì£¼ì˜ í•„ìš”"
        risk_color = 'orange'
    else:
        risk_level = "ğŸŸ¢ ì •ìƒ ë²”ìœ„"
        risk_color = 'green'
    
    print(f"  ìœ„í—˜ë„: {risk_level}")
    print("="*60)
    
    # ì í”„ ê°€ëŠ¥ì„± í‰ê°€
    if features['target_max'] < 280 and prediction >= 300:
        print("\nâš ï¸ ì í”„ ê²½ê³ : í˜„ì¬ 280 ë¯¸ë§Œì—ì„œ 300+ ì˜ˆì¸¡!")
    
    # ===== 6. ì‹œê°í™” =====
    print("\n[STEP 6] ì˜ˆì¸¡ ì‹œê°í™”")
    print("-"*40)
    
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(16, 6))
    
    # ì™¼ìª½: ì‹œí€€ìŠ¤ + ì˜ˆì¸¡
    ax1.plot(range(30), seq_target, 'b-', linewidth=2, label='Current Sequence')
    ax1.scatter(29, seq_target[-1], color='blue', s=100, zorder=5)
    
    # ì˜ˆì¸¡ê°’ í‘œì‹œ
    ax1.scatter(39, prediction, color=risk_color, s=200, marker='*', 
               label=f'Prediction: {prediction:.1f}', zorder=5)
    ax1.plot([29, 39], [seq_target[-1], prediction], 'r--', alpha=0.5)
    
    # ìœ„í—˜ êµ¬ê°„ í‘œì‹œ
    ax1.axhline(y=300, color='red', linestyle='--', alpha=0.3, label='Extreme (300)')
    ax1.axhline(y=280, color='orange', linestyle='--', alpha=0.3, label='Warning (280)')
    
    ax1.set_xlabel('Time (minutes)')
    ax1.set_ylabel('HUBROOM Value')
    ax1.set_title(f'Real-time Prediction\n{seq_end.strftime("%Y-%m-%d %H:%M")} â†’ +10min')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # ì˜¤ë¥¸ìª½: Feature ì¤‘ìš”ë„
    feature_names = list(features.keys())
    feature_values = list(features.values())
    
    # ì •ê·œí™” (ì‹œê°í™”ìš©)
    normalized_values = [(v - min(feature_values)) / (max(feature_values) - min(feature_values) + 0.001) 
                        for v in feature_values]
    
    colors = ['red' if 'last_5' in name else 'blue' for name in feature_names]
    bars = ax2.barh(range(len(feature_names)), normalized_values, color=colors, alpha=0.6)
    
    ax2.set_yticks(range(len(feature_names)))
    ax2.set_yticklabels(feature_names)
    ax2.set_xlabel('Normalized Value')
    ax2.set_title('Current Feature Values')
    
    # ê°’ í‘œì‹œ
    for i, (bar, val) in enumerate(zip(bars, feature_values)):
        ax2.text(bar.get_width() + 0.02, bar.get_y() + bar.get_height()/2, 
                f'{val:.1f}', va='center')
    
    plt.tight_layout()
    plt.savefig('realtime_prediction.png', dpi=150, bbox_inches='tight')
    print("âœ… ê·¸ë˜í”„ ì €ì¥: realtime_prediction.png")
    plt.show()
    
    # ===== 7. ê²°ê³¼ ì €ì¥ =====
    print("\n[STEP 7] ì˜ˆì¸¡ ê²°ê³¼ ì €ì¥")
    print("-"*40)
    
    # ê²°ê³¼ DataFrame
    result_df = pd.DataFrame([{
        'ì˜ˆì¸¡ì‹œê°': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'ì‹œí€€ìŠ¤ì‹œì‘': seq_start.strftime('%Y-%m-%d %H:%M'),
        'ì‹œí€€ìŠ¤ì¢…ë£Œ': seq_end.strftime('%Y-%m-%d %H:%M'),
        'ì˜ˆì¸¡ì‹œì ': prediction_time.strftime('%Y-%m-%d %H:%M'),
        'ì˜ˆì¸¡ê°’': round(prediction, 2),
        'ìœ„í—˜ë„': risk_level.split()[1] if len(risk_level.split()) > 1 else risk_level,
        'í˜„ì¬í‰ê· ': round(features['target_mean'], 2),
        'ìµœê·¼5ë¶„í‰ê· ': round(features['target_last_5_mean'], 2),
        'ìµœëŒ€ê°’': round(features['target_max'], 2),
        'ìµœì†Œê°’': round(features['target_min'], 2),
        'ì¶”ì„¸': round(features['target_slope'], 3)
    }])
    
    # ê¸°ì¡´ ì˜ˆì¸¡ ê¸°ë¡ì— ì¶”ê°€
    try:
        history = pd.read_csv('realtime_predictions_history.csv')
        history = pd.concat([history, result_df], ignore_index=True)
    except:
        history = result_df
    
    history.to_csv('realtime_predictions_history.csv', index=False, encoding='utf-8-sig')
    print("âœ… ì˜ˆì¸¡ ê¸°ë¡ ì €ì¥: realtime_predictions_history.csv")
    
    # í˜„ì¬ ì˜ˆì¸¡ë§Œ ë³„ë„ ì €ì¥
    result_df.to_csv('latest_prediction.csv', index=False, encoding='utf-8-sig')
    print("âœ… ìµœì‹  ì˜ˆì¸¡ ì €ì¥: latest_prediction.csv")
    
    # ===== 8. ì¶”ì²œ ì¡°ì¹˜ì‚¬í•­ =====
    print("\n" + "="*80)
    print("ğŸ’¡ ì¶”ì²œ ì¡°ì¹˜ì‚¬í•­")
    print("="*80)
    
    if prediction >= 300:
        print("ğŸ”´ ê·¹ë‹¨ê°’ ì˜ˆìƒ:")
        print("   1. ì¦‰ì‹œ ëª¨ë‹ˆí„°ë§ ê°•í™”")
        print("   2. ëŒ€ì‘ ì¸ë ¥ ì¤€ë¹„")
        print("   3. ì‹œìŠ¤í…œ ë¶€í•˜ ë¶„ì‚° ê²€í† ")
    elif prediction >= 280:
        print("ğŸŸ¡ ì£¼ì˜ ë‹¨ê³„:")
        print("   1. ëª¨ë‹ˆí„°ë§ ì£¼ì‹œ")
        print("   2. ì˜ˆë¹„ ì¡°ì¹˜ ì¤€ë¹„")
    else:
        print("ğŸŸ¢ ì •ìƒ ìš´ì˜:")
        print("   1. ì •ê¸° ëª¨ë‹ˆí„°ë§ ìœ ì§€")
    
    print("\n" + "="*80)
    print("âœ… ì‹¤ì‹œê°„ ì˜ˆì¸¡ ì™„ë£Œ!")
    print("="*80)
    
    return {
        'prediction': prediction,
        'prediction_time': prediction_time,
        'risk_level': risk_level,
        'features': features,
        'sequence': seq_target
    }

def continuous_monitoring(interval_minutes=1):
    """
    ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ ëª¨ë“œ (ì„ íƒì‚¬í•­)
    """
    import time
    
    print("ğŸ”„ ì—°ì† ëª¨ë‹ˆí„°ë§ ëª¨ë“œ ì‹œì‘ (Ctrl+Cë¡œ ì¢…ë£Œ)")
    print("-"*60)
    
    while True:
        try:
            result = realtime_prediction()
            if result:
                print(f"\nâ° ë‹¤ìŒ ì˜ˆì¸¡ê¹Œì§€ {interval_minutes}ë¶„ ëŒ€ê¸°...")
                time.sleep(interval_minutes * 60)
                print("\n" + "="*80)
        except KeyboardInterrupt:
            print("\n\nëª¨ë‹ˆí„°ë§ ì¢…ë£Œ")
            break
        except Exception as e:
            print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
            time.sleep(10)

# ì‹¤í–‰
if __name__ == '__main__':
    # ë‹¨ì¼ ì˜ˆì¸¡
    result = realtime_prediction()
    
    # ì—°ì† ëª¨ë‹ˆí„°ë§ ì›í•  ê²½ìš° ì•„ë˜ ì£¼ì„ í•´ì œ
    # continuous_monitoring(interval_minutes=1)