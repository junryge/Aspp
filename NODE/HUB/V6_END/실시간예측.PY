import numpy as np
import pandas as pd
import pickle
from datetime import datetime, timedelta

def realtime_prediction():
    # ëª¨ë¸ ë¡œë“œ
    try:
        with open('xgboost_model_30min_10min.pkl', 'rb') as f:
            model = pickle.load(f)
    except:
        print("âŒ ëª¨ë¸ íŒŒì¼ ì—†ìŒ")
        return None
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_csv('data/HUBROOM_PIVOT_DATA.CSV', on_bad_lines='skip')
    
    # ìµœê·¼ 30ê°œ ë°ì´í„°
    recent_30 = df.tail(30).copy()
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    seq_target = recent_30[TARGET_COL].values
    
    # STAT_DT ì²˜ë¦¬
    if 'STAT_DT' in recent_30.columns:
        try:
            recent_30['STAT_DT'] = pd.to_datetime(recent_30['STAT_DT'].astype(str), format='%Y%m%d%H%M')
        except:
            base_time = datetime(2024, 1, 1, 0, 0)
            recent_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    
    seq_end = recent_30['STAT_DT'].iloc[-1]
    prediction_time = seq_end + timedelta(minutes=10)
    
    # Feature ìƒì„±
    features = {
        'target_mean': np.mean(seq_target),
        'target_std': np.std(seq_target),
        'target_last_5_mean': np.mean(seq_target[-5:]),
        'target_max': np.max(seq_target),
        'target_min': np.min(seq_target),
        'target_slope': np.polyfit(np.arange(30), seq_target, 1)[0],
        'target_last_10_mean': np.mean(seq_target[-10:]),
        'target_first_10_mean': np.mean(seq_target[:10])
    }
    
    X_pred = pd.DataFrame([features])
    
    # ì˜ˆì¸¡
    prediction = model.predict(X_pred)[0]
    
    # ê²°ê³¼ ì¶œë ¥
    print(f"\ní˜„ì¬ì‹œê°„: {seq_end.strftime('%Y-%m-%d %H:%M')}")
    print(f"ì˜ˆì¸¡ì‹œì : {prediction_time.strftime('%Y-%m-%d %H:%M')}")
    print(f"ì˜ˆì¸¡ê°’: {prediction:.2f}")
    
    if prediction >= 300:
        print("ìƒíƒœ: ğŸ”´ ê·¹ë‹¨ê°’")
    elif prediction >= 280:
        print("ìƒíƒœ: ğŸŸ¡ ì£¼ì˜")
    else:
        print("ìƒíƒœ: ğŸŸ¢ ì •ìƒ")
    
    return prediction

# ì‹¤í–‰
if __name__ == '__main__':
    result = realtime_prediction()
    print(f"\nê²°ê³¼: {result}")