"""
V7 ì‹ ê·œ 8ê°œ ì»¬ëŸ¼ ê²€ì¦ ì½”ë“œ
- NULL ê°’ ìë™ ì œê±°
- ê¸°ë³¸ í†µê³„ ë¶„ì„
- ìƒê´€ê´€ê³„ ë¶„ì„
- ê¸‰ì¦ ì˜ˆì¸¡ë ¥ í…ŒìŠ¤íŠ¸
"""

import pandas as pd
import numpy as np
import sys

# ì‹ ê·œ 8ê°œ ì»¬ëŸ¼
NEW_COLS_V7 = [
    'M16HUB.QUE.M16TOM14B.MESCURRENTQCNT',
    'M16HUB.QUE.ALL.CURRENTQCNT',
    'M16HUB.QUE.M16TOM14.MESCURRENTQCNT',
    'M16HUB.QUE.OHT.CURRENTOHTQCNT',
    'M16HUB.QUE.M16TOM14A.MESCURRENTQCNT',
    'M14.QUE.CNV.M14ATOM16ACURRNETQCNT',
    'M16HUB.QUE.OHT.OHTUTIL',
    'M16HUB.QUE.M14TOM16.MESCURRENTQCNT',
]

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'


def validate_v7_columns(csv_file):
    """V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦"""
    
    print("="*80)
    print("ğŸ” V7 ì‹ ê·œ 8ê°œ ì»¬ëŸ¼ ê²€ì¦ (NULL ìë™ ì œê±°)")
    print("="*80)
    
    # ë°ì´í„° ë¡œë“œ
    try:
        df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='utf-8', low_memory=False)
    except:
        try:
            df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='cp949', low_memory=False)
        except:
            try:
                df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='euc-kr', low_memory=False)
            except Exception as e:
                print(f"âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
                return None
    
    print(f"\nâœ… ë°ì´í„° ë¡œë“œ: {len(df)}ê°œ í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")
    
    # ========================================
    # NULL ê°’ ì²˜ë¦¬
    # ========================================
    print(f"\nğŸ” NULL ê°’ ì²´í¬ ë° ì œê±° ì¤‘...")
    initial_len = len(df)
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ NULL ì œê±°
    if TARGET_COL not in df.columns:
        print(f"âŒ íƒ€ê²Ÿ ì»¬ëŸ¼ '{TARGET_COL}' ì—†ìŒ!")
        return None
    
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    before = len(df)
    df = df.dropna(subset=[TARGET_COL])
    if before != len(df):
        print(f"   íƒ€ê²Ÿ ì»¬ëŸ¼ NULL ì œê±°: {before} â†’ {len(df)}ê°œ ({before - len(df)}ê°œ ì œê±°)")
    
    # ì‹ ê·œ ì»¬ëŸ¼ë“¤ NULL ì œê±°
    for col in NEW_COLS_V7:
        if col in df.columns:
            before = len(df)
            df[col] = pd.to_numeric(df[col], errors='coerce')
            null_count = df[col].isna().sum()
            
            if null_count > 0:
                print(f"   {col.split('.')[-1]}: NULL {null_count}ê°œ ë°œê²¬")
                df = df.dropna(subset=[col])
                print(f"      â†’ {before} â†’ {len(df)}ê°œ ({before - len(df)}ê°œ ì œê±°)")
    
    print(f"\nâœ… NULL ì œê±° ì™„ë£Œ: {len(df)}ê°œ í–‰ ë‚¨ìŒ (ì›ë³¸ì˜ {len(df)/initial_len*100:.1f}%)")
    
    if len(df) < 100:
        print(f"âš ï¸ ê²½ê³ : ë°ì´í„°ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤! ({len(df)}ê°œ)")
        print(f"   ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê²€ì¦ì„ ìœ„í•´ ìµœì†Œ 1000ê°œ ì´ìƒ ê¶Œì¥")
    
    # ========================================
    # 1ë‹¨ê³„: ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 1ë‹¨ê³„: ì‹ ê·œ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€")
    print("="*80)
    
    available = []
    missing = []
    
    for i, col in enumerate(NEW_COLS_V7, 1):
        if col in df.columns:
            available.append(col)
            valid_count = df[col].notna().sum()
            print(f"âœ… {i}. {col}")
            print(f"      ìœ íš¨ ë°ì´í„°: {valid_count}ê°œ")
        else:
            missing.append(col)
            print(f"âŒ {i}. {col} - ì—†ìŒ!")
    
    print(f"\nğŸ“Š ê²°ê³¼: {len(available)}/{len(NEW_COLS_V7)}ê°œ ì¡´ì¬")
    
    if len(available) == 0:
        print("\nâŒ ì‹ ê·œ ì»¬ëŸ¼ì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤!")
        print("\nğŸ’¡ ë°ì´í„° íŒŒì¼ì— ë‹¤ìŒ ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤:")
        for col in NEW_COLS_V7:
            print(f"   - {col}")
        return None
    
    # ========================================
    # 2ë‹¨ê³„: ê¸°ë³¸ í†µê³„
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 2ë‹¨ê³„: ê¸°ë³¸ í†µê³„ (NULL ì œì™¸)")
    print("="*80)
    
    stats_list = []
    
    for col in available:
        data = df[col]
        mean = data.mean()
        std = data.std()
        cv = (std / mean * 100) if mean != 0 else 0
        
        stats_list.append({
            'ì»¬ëŸ¼': col.split('.')[-1],
            'í‰ê· ': round(mean, 1),
            'í‘œì¤€í¸ì°¨': round(std, 1),
            'ìµœì†Œ': round(data.min(), 1),
            'ìµœëŒ€': round(data.max(), 1),
            'ë²”ìœ„': round(data.max() - data.min(), 1),
            'ë³€ë™ê³„ìˆ˜(%)': round(cv, 1),
        })
        
        # ë³€ë™ê³„ìˆ˜ì— ë”°ë¥¸ ë§ˆì»¤
        if cv >= 20:
            marker = "ğŸŸ¢"
            comment = "(ì¶©ë¶„í•œ ë³€ë™)"
        elif cv >= 10:
            marker = "ğŸŸ¡"
            comment = "(ë³´í†µ ë³€ë™)"
        elif cv >= 5:
            marker = "ğŸŸ "
            comment = "(ë‚®ì€ ë³€ë™)"
        else:
            marker = "ğŸ”´"
            comment = "(ê±°ì˜ ê³ ì •)"
        
        print(f"\n{marker} {col.split('.')[-1]}:")
        print(f"   í‰ê· : {mean:.1f}, í‘œì¤€í¸ì°¨: {std:.1f}")
        print(f"   ë²”ìœ„: {data.min():.0f} ~ {data.max():.0f}")
        print(f"   ë³€ë™ê³„ìˆ˜: {cv:.1f}% {comment}")
    
    # ========================================
    # 3ë‹¨ê³„: íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê´€ê³„
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 3ë‹¨ê³„: íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê´€ê³„")
    print("="*80)
    
    corr_list = []
    
    for col in available:
        corr = df[TARGET_COL].corr(df[col])
        
        # 300+ vs 300- ë¹„êµ
        high_df = df[df[TARGET_COL] >= 300]
        low_df = df[df[TARGET_COL] < 300]
        
        if len(high_df) > 0 and len(low_df) > 0:
            high = high_df[col].mean()
            low = low_df[col].mean()
            diff_pct = abs(high - low) / low * 100 if low != 0 else 0
        else:
            high = 0
            low = 0
            diff_pct = 0
        
        corr_list.append({
            'ì»¬ëŸ¼': col.split('.')[-1],
            'ìƒê´€ê³„ìˆ˜': round(corr, 4),
            '300+í‰ê· ': round(high, 1),
            '300-í‰ê· ': round(low, 1),
            'ì°¨ì´(%)': round(diff_pct, 1),
        })
        
        print(f"\n{col.split('.')[-1]}:")
        print(f"   ìƒê´€ê³„ìˆ˜: {corr:+.4f}")
        print(f"   300+ í‰ê· : {high:.1f}")
        print(f"   300- í‰ê· : {low:.1f}")
        print(f"   ì°¨ì´: {diff_pct:.1f}%", end="")
        
        if diff_pct >= 15:
            print(" ğŸ”¥ (ë§¤ìš° ìœ ìš©!)")
        elif diff_pct >= 10:
            print(" âš¡ (ìœ ìš©)")
        elif diff_pct >= 5:
            print(" ğŸ“Š (ë³´í†µ)")
        else:
            print(" âš ï¸ (ì œí•œì )")
    
    # ========================================
    # 4ë‹¨ê³„: ê¸‰ì¦ ì˜ˆì¸¡ë ¥ í…ŒìŠ¤íŠ¸
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 4ë‹¨ê³„: ê¸‰ì¦ ì˜ˆì¸¡ë ¥ í…ŒìŠ¤íŠ¸ (ì„ê³„ê°’ ê¸°ë°˜)")
    print("="*80)
    
    # ê¸‰ì¦ ì¼€ì´ìŠ¤ ì°¾ê¸°
    surge_indices = []
    for i in range(30, len(df) - 10):
        seq_max = df[TARGET_COL].iloc[i-30:i].max()
        actual = df[TARGET_COL].iloc[i:i+10].max()
        if seq_max < 300 and actual >= 300:
            surge_indices.append(i)
    
    print(f"âœ… ê¸‰ì¦ ì¼€ì´ìŠ¤: {len(surge_indices)}ê°œ ë°œê²¬")
    
    if len(surge_indices) == 0:
        print("âš ï¸ ê¸‰ì¦ ì¼€ì´ìŠ¤ê°€ ì—†ì–´ì„œ ì˜ˆì¸¡ë ¥ í…ŒìŠ¤íŠ¸ ë¶ˆê°€")
        print("   (ì‹œí€€ìŠ¤MAX<300 â†’ ì‹¤ì œê°’â‰¥300 ì¼€ì´ìŠ¤)")
    else:
        print("\nì„ê³„ê°’ ê¸°ë°˜ ê°ì§€ìœ¨:")
        
        surge_results = []
        
        for col in available:
            correct = 0
            
            for idx in surge_indices:
                last_val = df[col].iloc[idx-1]
                detected = False
                
                # ì»¬ëŸ¼ë³„ ì„ê³„ê°’
                if 'M16TOM14B' in col and last_val < 120:
                    detected = True
                elif 'ALL.CURRENT' in col and last_val > 850:
                    detected = True
                elif 'M16TOM14.MES' in col and last_val < 300:
                    detected = True
                elif 'OHT.CURRENT' in col and last_val > 230:
                    detected = True
                elif 'M16TOM14A' in col and last_val < 160:
                    detected = True
                elif 'M14ATOM16A' in col and last_val > 220:
                    detected = True
                elif 'OHTUTIL' in col and last_val > 85:
                    detected = True
                elif 'M14TOM16' in col and last_val < 200:
                    detected = True
                
                if detected:
                    correct += 1
            
            rate = correct / len(surge_indices) * 100
            
            surge_results.append({
                'ì»¬ëŸ¼': col.split('.')[-1],
                'ê°ì§€': correct,
                'ì „ì²´': len(surge_indices),
                'ê°ì§€ìœ¨(%)': round(rate, 1),
            })
            
            # ë§ˆì»¤
            if rate >= 80:
                marker = "ğŸ”¥"
            elif rate >= 60:
                marker = "âš¡"
            elif rate >= 40:
                marker = "ğŸ“Š"
            else:
                marker = "  "
            
            print(f"   {marker} {col.split('.')[-1]}: {correct}/{len(surge_indices)} = {rate:.1f}%")
    
    # ========================================
    # CSV ì €ì¥
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“ ê²°ê³¼ ì €ì¥")
    print("="*80)
    
    try:
        stats_df = pd.DataFrame(stats_list)
        corr_df = pd.DataFrame(corr_list).sort_values('ìƒê´€ê³„ìˆ˜', ascending=False, key=abs)
        
        stats_df.to_csv('V7_ê²€ì¦_ê¸°ë³¸í†µê³„.csv', index=False, encoding='utf-8-sig')
        print("âœ… V7_ê²€ì¦_ê¸°ë³¸í†µê³„.csv")
        
        corr_df.to_csv('V7_ê²€ì¦_ìƒê´€ê´€ê³„.csv', index=False, encoding='utf-8-sig')
        print("âœ… V7_ê²€ì¦_ìƒê´€ê´€ê³„.csv")
        
        if len(surge_indices) > 0:
            surge_df = pd.DataFrame(surge_results).sort_values('ê°ì§€ìœ¨(%)', ascending=False)
            surge_df.to_csv('V7_ê²€ì¦_ê¸‰ì¦ì˜ˆì¸¡ë ¥.csv', index=False, encoding='utf-8-sig')
            print("âœ… V7_ê²€ì¦_ê¸‰ì¦ì˜ˆì¸¡ë ¥.csv")
    except Exception as e:
        print(f"âš ï¸ CSV ì €ì¥ ì‹¤íŒ¨: {e}")
        print("   (ê²°ê³¼ëŠ” í™”ë©´ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥)")
    
    # ========================================
    # ìµœì¢… íŒì •
    # ========================================
    print("\n" + "="*80)
    print("ğŸ¯ ìµœì¢… íŒì •")
    print("="*80)
    
    print(f"\në°ì´í„° í’ˆì§ˆ:")
    print(f"   ì›ë³¸: {initial_len}ê°œ í–‰")
    print(f"   NULL ì œê±° í›„: {len(df)}ê°œ í–‰")
    print(f"   ì‚¬ìš© ê°€ëŠ¥ìœ¨: {len(df)/initial_len*100:.1f}%")
    
    if len(df) < initial_len * 0.5:
        print(f"   âš ï¸ ê²½ê³ : 50% ì´ìƒ ë°ì´í„° ì†ì‹¤!")
        print(f"   âš ï¸ NULLì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ë°ì´í„° í’ˆì§ˆ ì ê²€ í•„ìš”!")
    
    print(f"\nì»¬ëŸ¼ ìƒíƒœ:")
    print(f"   ì¡´ì¬: {len(available)}/{len(NEW_COLS_V7)}ê°œ")
    
    if len(missing) > 0:
        print(f"   ë¶€ì¡±: {len(missing)}ê°œ")
        for col in missing:
            print(f"      âŒ {col}")
    
    print(f"\nìµœì¢… ê²°ë¡ :")
    
    if len(available) == len(NEW_COLS_V7):
        print(f"   âœ… 8ê°œ ì»¬ëŸ¼ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥!")
        print(f"   âœ… V7 ëª¨ë¸ í•™ìŠµ ì§„í–‰ ê°€ëŠ¥!")
        
        # ì¶”ê°€ ê¶Œì¥ì‚¬í•­
        high_corr = sum(1 for item in corr_list if abs(item['ìƒê´€ê³„ìˆ˜']) >= 0.4)
        print(f"\n   ğŸ“Š ê³ ìƒê´€(â‰¥0.4) ì»¬ëŸ¼: {high_corr}ê°œ")
        
        if len(surge_indices) > 0:
            high_detect = sum(1 for item in surge_results if item['ê°ì§€ìœ¨(%)'] >= 60)
            print(f"   ğŸ¯ ê³ ê°ì§€(â‰¥60%) ì»¬ëŸ¼: {high_detect}ê°œ")
        
        return True
        
    elif len(available) >= 6:
        print(f"   âš ï¸ {len(available)}ê°œ ì»¬ëŸ¼ë§Œ ì‚¬ìš© ê°€ëŠ¥")
        print(f"   âš ï¸ V7 í•™ìŠµ ê°€ëŠ¥í•˜ë‚˜ ì„±ëŠ¥ì´ ì œí•œì ì¼ ìˆ˜ ìˆìŒ")
        return True
        
    elif len(available) >= 4:
        print(f"   âš ï¸ {len(available)}ê°œ ì»¬ëŸ¼ë§Œ ì‚¬ìš© ê°€ëŠ¥")
        print(f"   âš ï¸ V7 í•™ìŠµ ê°€ëŠ¥í•˜ë‚˜ ì„±ëŠ¥ì´ ë§¤ìš° ì œí•œì ")
        print(f"   ğŸ’¡ V6 ëª¨ë¸ ì‚¬ìš© ê¶Œì¥")
        return False
        
    else:
        print(f"   âŒ ì‹ ê·œ ì»¬ëŸ¼ ë¶€ì¡± ({len(available)}ê°œ)")
        print(f"   âŒ V6 ëª¨ë¸ ì‚¬ìš© ê¶Œì¥")
        return False


if __name__ == '__main__':
    print("\n" + "="*80)
    print("ğŸš€ V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦ ë„êµ¬ (NULL ìë™ ì²˜ë¦¬)")
    print("="*80)
    
    # íŒŒì¼ëª… ì…ë ¥
    if len(sys.argv) > 1:
        csv_file = sys.argv[1]
    else:
        print("\nğŸ“ ê²€ì¦í•  CSV íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:")
        print("   ì˜ˆ: HUB_0509_TO_0929_DATA.csv")
        csv_file = input("\níŒŒì¼ëª…: ").strip()
    
    if not csv_file:
        print("\nâŒ íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤!")
        print("\nì‚¬ìš©ë²•:")
        print("   python V7_ì»¬ëŸ¼ê²€ì¦.py [íŒŒì¼ëª….csv]")
        print("   ë˜ëŠ”")
        print("   python V7_ì»¬ëŸ¼ê²€ì¦.py")
        print("   (íŒŒì¼ëª… ì…ë ¥)")
        sys.exit(1)
    
    # ê²€ì¦ ì‹¤í–‰
    result = validate_v7_columns(csv_file)
    
    if result is None:
        print("\n" + "="*80)
        print("âŒ ê²€ì¦ ì‹¤íŒ¨!")
        print("="*80)
        sys.exit(1)
    elif result:
        print("\n" + "="*80)
        print("âœ… ê²€ì¦ ì™„ë£Œ! V7 ì§„í–‰ ê°€ëŠ¥!")
        print("="*80)
        sys.exit(0)
    else:
        print("\n" + "="*80)
        print("âš ï¸ ê²€ì¦ ì™„ë£Œ! V6 ì‚¬ìš© ê¶Œì¥!")
        print("="*80)
        sys.exit(0)