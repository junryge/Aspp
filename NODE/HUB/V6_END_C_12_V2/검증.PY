import pandas as pd
import numpy as np
from datetime import datetime, timedelta

"""
================================================================================
ğŸ” ìƒˆ ë°ì´í„° ê²€ì¦ - V6 í•™ìŠµì½”ë“œ í˜¸í™˜ì„± ì²´í¬
================================================================================
ì‚¬ìš©ë²•:
1. ì´ íŒŒì¼ì„ ë°ì´í„° íŒŒì¼ê³¼ ê°™ì€ í´ë”ì— ì €ì¥
2. ì•„ë˜ FILE_PATHì— ì‹¤ì œ íŒŒì¼ëª… ì…ë ¥
3. ì‹¤í–‰: python ë°ì´í„°_ê²€ì¦.py
================================================================================
"""

# âš™ï¸ ì—¬ê¸°ì— ì‹¤ì œ íŒŒì¼ëª… ì…ë ¥í•˜ì„¸ìš”!
FILE_PATH = 'HUB0905101512.csv'  # ë˜ëŠ” ì‹¤ì œ íŒŒì¼ëª…

print("="*80)
print("ğŸ” ìƒˆ ë°ì´í„° ê²€ì¦ ì‹œì‘")
print("="*80)

# V6 í•™ìŠµì½”ë“œì—ì„œ ìš”êµ¬í•˜ëŠ” í•„ìˆ˜ ì»¬ëŸ¼
REQUIRED_COLS = {
    'target': 'CURRENT_M16A_3F_JOB_2',
    'storage': ['M16A_3F_STORAGE_UTIL'],
    'fs_storage': ['CD_M163FSTORAGEUSE', 'CD_M163FSTORAGETOTAL', 'CD_M163FSTORAGEUTIL'],
    'hub': ['HUBROOMTOTAL'],
    'cmd': ['M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD'],
    'inflow': ['M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2', 'M14A_3F_TO_HUB_JOB2'],
    'outflow': ['M16A_3F_TO_M16A_6F_JOB', 'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB'],
    'maxcapa': ['M16A_6F_LFT_MAXCAPA', 'M16A_2F_LFT_MAXCAPA']
}

# 1. ë°ì´í„° ë¡œë“œ
print(f"\nğŸ“‚ ë°ì´í„° ë¡œë“œ ì‹œë„: {FILE_PATH}")
try:
    df = pd.read_csv(FILE_PATH, on_bad_lines='skip', encoding='utf-8', low_memory=False)
    print(f"âœ… ì„±ê³µ! {len(df)}ê°œ í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼\n")
except:
    try:
        df = pd.read_csv(FILE_PATH, on_bad_lines='skip', encoding='cp949', low_memory=False)
        print(f"âœ… ì„±ê³µ! (cp949 ì¸ì½”ë”©) {len(df)}ê°œ í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼\n")
    except Exception as e:
        print(f"âŒ ì‹¤íŒ¨: {e}")
        exit()

# 2. ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
print("="*80)
print("1ï¸âƒ£ í•„ìˆ˜ ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸")
print("="*80)

all_required = [REQUIRED_COLS['target']]
for group_name, cols in REQUIRED_COLS.items():
    if group_name != 'target':
        all_required.extend(cols)

missing_cols = []
present_cols = []

for col in all_required:
    if col in df.columns:
        print(f"âœ… {col}")
        present_cols.append(col)
    else:
        print(f"âŒ {col} - ì—†ìŒ!")
        missing_cols.append(col)

print(f"\nğŸ“Š ê²°ê³¼: {len(present_cols)}/{len(all_required)}ê°œ ì¡´ì¬")

if missing_cols:
    print(f"\nâš ï¸ ê²½ê³ : {len(missing_cols)}ê°œ ì»¬ëŸ¼ ëˆ„ë½!")
    print("ëˆ„ë½ ì»¬ëŸ¼:", missing_cols)
else:
    print("\nğŸ‰ ëª¨ë“  í•„ìˆ˜ ì»¬ëŸ¼ ì¡´ì¬!")

# 3. STAT_DT í™•ì¸
print("\n" + "="*80)
print("2ï¸âƒ£ STAT_DT ë‚ ì§œ í™•ì¸")
print("="*80)

if 'STAT_DT' in df.columns:
    print(f"âœ… STAT_DT ì»¬ëŸ¼ ì¡´ì¬")
    print(f"   ìƒ˜í”Œ ê°’: {df['STAT_DT'].iloc[0]}")
    
    try:
        df['STAT_DT_TEST'] = pd.to_datetime(df['STAT_DT'].astype(str), format='%Y%m%d%H%M')
        print(f"âœ… ë‚ ì§œ ë³€í™˜ ì„±ê³µ")
        print(f"   ì‹œì‘: {df['STAT_DT_TEST'].iloc[0]}")
        print(f"   ì¢…ë£Œ: {df['STAT_DT_TEST'].iloc[-1]}")
        
        duration = (df['STAT_DT_TEST'].iloc[-1] - df['STAT_DT_TEST'].iloc[0])
        print(f"   ì´ ê¸°ê°„: {duration.days}ì¼ {duration.seconds//3600}ì‹œê°„")
    except Exception as e:
        print(f"âš ï¸ ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨: {e}")
        print("   (í•™ìŠµ ì‹œ ìë™ ìƒì„±ë˜ë¯€ë¡œ ë¬¸ì œì—†ìŒ)")
else:
    print(f"âš ï¸ STAT_DT ì—†ìŒ (í•™ìŠµ ì‹œ ìë™ ìƒì„±)")

# 4. íƒ€ê²Ÿ ì»¬ëŸ¼ ë¶„ì„
print("\n" + "="*80)
print("3ï¸âƒ£ íƒ€ê²Ÿ ì»¬ëŸ¼ ë¶„ì„ (CURRENT_M16A_3F_JOB_2)")
print("="*80)

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'

if TARGET_COL not in df.columns:
    print(f"âŒ íƒ€ê²Ÿ ì»¬ëŸ¼ ì—†ìŒ!")
else:
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    
    print(f"ë°ì´í„° íƒ€ì…: {df[TARGET_COL].dtype}")
    print(f"ì´ ë°ì´í„°: {len(df)}ê°œ")
    print(f"ê²°ì¸¡ì¹˜: {df[TARGET_COL].isna().sum()}ê°œ ({df[TARGET_COL].isna().sum()/len(df)*100:.2f}%)")
    print(f"\nê¸°ë³¸ í†µê³„:")
    print(f"  ìµœì†Œê°’: {df[TARGET_COL].min():.1f}")
    print(f"  ìµœëŒ€ê°’: {df[TARGET_COL].max():.1f}")
    print(f"  í‰ê· : {df[TARGET_COL].mean():.1f}")
    print(f"  ì¤‘ê°„ê°’: {df[TARGET_COL].median():.1f}")
    print(f"  í‘œì¤€í¸ì°¨: {df[TARGET_COL].std():.1f}")

# 5. ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶„ì„
print("\n" + "="*80)
print("4ï¸âƒ£ ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶„ì„ (300 ê¸°ì¤€)")
print("="*80)

if TARGET_COL in df.columns:
    # 300 ì´ìƒ ì¼€ì´ìŠ¤
    extreme_cases = (df[TARGET_COL] >= 300).sum()
    print(f"300 ì´ìƒ: {extreme_cases}ê°œ ({extreme_cases/len(df)*100:.2f}%)")
    
    # êµ¬ê°„ë³„ ë¶„í¬
    print(f"\nêµ¬ê°„ë³„ ë¶„í¬:")
    print(f"  350 ì´ìƒ: {(df[TARGET_COL] >= 350).sum()}ê°œ")
    print(f"  300-350: {((df[TARGET_COL] >= 300) & (df[TARGET_COL] < 350)).sum()}ê°œ")
    print(f"  290-300: {((df[TARGET_COL] >= 290) & (df[TARGET_COL] < 300)).sum()}ê°œ")
    print(f"  280-290: {((df[TARGET_COL] >= 280) & (df[TARGET_COL] < 290)).sum()}ê°œ")
    print(f"  270-280: {((df[TARGET_COL] >= 270) & (df[TARGET_COL] < 280)).sum()}ê°œ")
    
    # ê¸‰ì¦ íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ (30ë¶„ ìœˆë„ìš°)
    print(f"\nğŸ¯ ê¸‰ì¦ íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ (30ë¶„ ì‹œí€€ìŠ¤ ê¸°ë°˜):")
    
    surge_count = 0
    surge_indices = []
    
    for i in range(30, len(df)):
        seq_max = df[TARGET_COL].iloc[i-30:i].max()
        current_val = df[TARGET_COL].iloc[i]
        
        # ì‹œí€€ìŠ¤ ìµœëŒ€ê°’ < 300 ì´ì§€ë§Œ í˜„ì¬ê°’ >= 300 (ê¸‰ì¦!)
        if seq_max < 300 and current_val >= 300:
            surge_count += 1
            surge_indices.append(i)
    
    print(f"   ë°œê²¬ëœ ê¸‰ì¦: {surge_count}ê°œ")
    print(f"   ë¹„ìœ¨: {surge_count/(len(df)-30)*100:.3f}%")
    
    if surge_count > 0:
        print(f"\n   ì²˜ìŒ 5ê°œ ê¸‰ì¦ ì¼€ì´ìŠ¤:")
        for idx in surge_indices[:5]:
            seq_max = df[TARGET_COL].iloc[idx-30:idx].max()
            current = df[TARGET_COL].iloc[idx]
            print(f"   - ì¸ë±ìŠ¤ {idx}: ì‹œí€€ìŠ¤MAX={seq_max:.1f} â†’ í˜„ì¬={current:.1f}")

# 6. ì£¼ìš” Feature ì»¬ëŸ¼ í†µê³„
print("\n" + "="*80)
print("5ï¸âƒ£ ì£¼ìš” Feature ì»¬ëŸ¼ í†µê³„")
print("="*80)

key_cols = {
    'HUBROOMTOTAL': 'í—ˆë¸Œë£¸ ì´ëŸ‰',
    'CD_M163FSTORAGEUTIL': 'FS ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ë¥ ',
    'M16A_3F_CMD': '3F CMD',
    'M16A_3F_STORAGE_UTIL': '3F ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ë¥ '
}

for col, desc in key_cols.items():
    if col in df.columns:
        df[col] = pd.to_numeric(df[col], errors='coerce')
        print(f"\n{desc} ({col}):")
        print(f"  ë²”ìœ„: {df[col].min():.1f} ~ {df[col].max():.1f}")
        print(f"  í‰ê· : {df[col].mean():.1f}")
        print(f"  í‘œì¤€í¸ì°¨: {df[col].std():.1f}")
        print(f"  ê²°ì¸¡ì¹˜: {df[col].isna().sum()}ê°œ")
    else:
        print(f"\n{desc} ({col}): âŒ ì—†ìŒ")

# 7. ë°ì´í„° í’ˆì§ˆ ì²´í¬
print("\n" + "="*80)
print("6ï¸âƒ£ ë°ì´í„° í’ˆì§ˆ ì²´í¬")
print("="*80)

quality_issues = []

# ë°ì´í„° ì–‘
if len(df) < 1000:
    quality_issues.append(f"ë°ì´í„° ë¶€ì¡±: {len(df)}ê°œ (ìµœì†Œ 1000ê°œ ê¶Œì¥)")
    print(f"âš ï¸ ë°ì´í„° ì–‘ ë¶€ì¡±: {len(df)}ê°œ")
else:
    print(f"âœ… ë°ì´í„° ì–‘ ì¶©ë¶„: {len(df)}ê°œ")

# íƒ€ê²Ÿ ê²°ì¸¡ì¹˜
if TARGET_COL in df.columns:
    missing_rate = df[TARGET_COL].isna().sum() / len(df) * 100
    if missing_rate > 10:
        quality_issues.append(f"íƒ€ê²Ÿ ê²°ì¸¡ì¹˜ ê³¼ë‹¤: {missing_rate:.1f}%")
        print(f"âš ï¸ íƒ€ê²Ÿ ê²°ì¸¡ì¹˜ ë§ìŒ: {missing_rate:.1f}%")
    else:
        print(f"âœ… íƒ€ê²Ÿ ê²°ì¸¡ì¹˜ ì–‘í˜¸: {missing_rate:.2f}%")

# ê¸‰ì¦ ì¼€ì´ìŠ¤
if surge_count < 10:
    quality_issues.append(f"ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶€ì¡±: {surge_count}ê°œ")
    print(f"âš ï¸ ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶€ì¡±: {surge_count}ê°œ (ìµœì†Œ 10ê°œ ê¶Œì¥)")
elif surge_count < 50:
    print(f"âš ï¸ ê¸‰ì¦ ì¼€ì´ìŠ¤ ì ìŒ: {surge_count}ê°œ (50ê°œ ì´ìƒ ê¶Œì¥)")
else:
    print(f"âœ… ê¸‰ì¦ ì¼€ì´ìŠ¤ ì¶©ë¶„: {surge_count}ê°œ")

# 8. ìµœì¢… íŒì •
print("\n" + "="*80)
print("âœ¨ ìµœì¢… íŒì •")
print("="*80)

if missing_cols:
    print("âŒ ì‚¬ìš© ë¶ˆê°€: í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½")
    print(f"\nëˆ„ë½ëœ ì»¬ëŸ¼ ({len(missing_cols)}ê°œ):")
    for col in missing_cols:
        print(f"  - {col}")
elif len(df) < 500:
    print("âŒ ì‚¬ìš© ë¶ˆê°€: ë°ì´í„° ì–‘ ë¶€ì¡±")
else:
    print("ğŸ‰ V6 í•™ìŠµì½”ë“œ ì‚¬ìš© ê°€ëŠ¥!")
    
    if len(found_v7) == 8:
        print("ğŸš€ V7 ì—…ê·¸ë ˆì´ë“œë„ ê°€ëŠ¥! (ê³ ìƒê´€ Feature 8ê°œ ëª¨ë‘ ì¡´ì¬)")
    
    if quality_issues:
        print("\nâš ï¸ ì£¼ì˜ì‚¬í•­:")
        for issue in quality_issues:
            print(f"  - {issue}")
    
    print("\n" + "="*80)
    print("ğŸš€ ë‹¤ìŒ ë‹¨ê³„")
    print("="*80)
    
    if len(found_v7) == 8:
        print("\nâ­ ê¶Œì¥: V7 í•™ìŠµ (ê³ ìƒê´€ Feature í¬í•¨)")
        print("\n1. V7_í•™ìŠµì½”ë“œ.PY íŒŒì¼ ìƒì„± (V6 ê¸°ë°˜ + 8ê°œ Feature ì¶”ê°€)")
        print(f"   df_train = pd.read_csv('{FILE_PATH}', ...)")
        print("\n2. ë˜ëŠ” ê¸°ì¡´ V6ë¡œ ë¨¼ì € í…ŒìŠ¤íŠ¸:")
    else:
        print("\n1. V6_í•™ìŠµì½”ë“œ.PY íŒŒì¼ ì—´ê¸°")
    
    print(f"   df_train = pd.read_csv('{FILE_PATH}', ...)")
    print("\n3. ì‹¤í–‰:")
    print("   python V6_í•™ìŠµì½”ë“œ.py")
    print("\n4. í•™ìŠµ ì™„ë£Œ í›„ í‰ê°€:")
    print("   python V6_í‰ê°€.py")

# 9. V7 ê³ ìƒê´€ Feature 8ê°œ ì²´í¬
print("\n" + "="*80)
print("ğŸ”¥ V7 ê³ ìƒê´€ Feature 8ê°œ í™•ì¸ (ìƒê´€ê³„ìˆ˜ 0.32~0.59)")
print("="*80)

v7_features = {
    'M16HUB.QUE.M16TOM14B.MESCURRENTQCNT': {'corr': 0.59, 'desc': 'M16â†’M14B ìœ ì¶œ í'},
    'M16HUB.QUE.ALL.CURRENTQCNT': {'corr': 0.57, 'desc': 'M16HUB ì „ì²´ í'},
    'M16HUB.QUE.M16TOM14.MESCURRENTQCNT': {'corr': 0.48, 'desc': 'M16â†’M14 ì „ì²´ ìœ ì¶œ'},
    'M16HUB.QUE.OHT.CURRENTOHTQCNT': {'corr': 0.46, 'desc': 'OHT í ìˆ˜'},
    'M16HUB.QUE.M16TOM14A.MESCURRENTQCNT': {'corr': 0.42, 'desc': 'M16â†’M14A ìœ ì¶œ'},
    'M14.QUE.CNV.M14ATOM16ACURRNETQCNT': {'corr': 0.36, 'desc': 'M14Aâ†’M16A ìœ ì…'},
    'M16HUB.QUE.OHT.OHTUTIL': {'corr': 0.34, 'desc': 'OHT ì‚¬ìš©ë¥ (%)'},
    'M16HUB.QUE.M14TOM16.MESCURRENTQCNT': {'corr': -0.32, 'desc': 'M14â†’M16 ìœ ì…'},
}

found_v7 = []
missing_v7 = []

print(f"\n{'ìˆœìœ„':<4} {'ì»¬ëŸ¼ëª…':<45} {'ìƒê´€ê³„ìˆ˜':<8} {'ìƒíƒœ'}")
print("-" * 80)

for idx, (col, info) in enumerate(v7_features.items(), 1):
    if col in df.columns:
        found_v7.append(col)
        print(f"{idx:<4} {col:<45} {info['corr']:>+5.2f}   âœ…")
    else:
        missing_v7.append(col)
        print(f"{idx:<4} {col:<45} {info['corr']:>+5.2f}   âŒ ì—†ìŒ")

print("-" * 80)
print(f"ë°œê²¬: {len(found_v7)}/8ê°œ")

if len(found_v7) == 8:
    print("\nğŸ‰ ëª¨ë“  V7 Feature ì¡´ì¬! V7 ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥!")
    
    # V7 Feature í†µê³„
    print("\nğŸ“Š V7 Feature ê¸°ë³¸ í†µê³„:")
    for col in found_v7:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')
            print(f"\n{v7_features[col]['desc']} ({col}):")
            print(f"  ë²”ìœ„: {df[col].min():.1f} ~ {df[col].max():.1f}")
            print(f"  í‰ê· : {df[col].mean():.1f}")
            print(f"  ê²°ì¸¡ì¹˜: {df[col].isna().sum()}ê°œ")
            
elif len(found_v7) > 0:
    print(f"\nâš ï¸ ì¼ë¶€ë§Œ ì¡´ì¬ ({len(found_v7)}/8ê°œ)")
    print(f"ëˆ„ë½: {missing_v7}")
else:
    print("\nâŒ V7 Feature ì—†ìŒ - V6ë§Œ ì‚¬ìš© ê°€ëŠ¥")

print("\n" + "="*80)
print("ğŸ“‹ ìµœì¢… ìš”ì•½")
print("="*80)

summary = []
summary.append(f"âœ… ë°ì´í„° í–‰: {len(df)}ê°œ")
summary.append(f"âœ… V6 í•„ìˆ˜ ì»¬ëŸ¼: {len(present_cols)}/{len(all_required)}ê°œ")

if len(found_v7) == 8:
    summary.append(f"ğŸš€ V7 ê³ ìƒê´€ Feature: {len(found_v7)}/8ê°œ (ì™„ë²½!)")
elif len(found_v7) > 0:
    summary.append(f"âš ï¸ V7 ê³ ìƒê´€ Feature: {len(found_v7)}/8ê°œ (ì¼ë¶€)")

if TARGET_COL in df.columns:
    summary.append(f"âœ… ê¸‰ì¦ ì¼€ì´ìŠ¤: {surge_count}ê°œ")

print()
for line in summary:
    print(line)

print("\n" + "="*80)
print("ê²€ì¦ ì™„ë£Œ!")
print("="*80)