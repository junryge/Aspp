import pandas as pd
import numpy as np

def verify_v7_features():
    """
    ğŸ” V7 ì‹ ê·œ Feature í›„ë³´ 8ê°œ ê²€ì¦
    """
    print("="*80)
    print("ğŸ” V7 ì‹ ê·œ Feature ê²€ì¦ ì‹œì‘")
    print("="*80)
    
    # ê²€ì¦í•  ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
    new_features = [
        'M16HUB.QUE.M16TOM14B.MESCURRENTQCNT',  # +0.59
        'M16HUB.QUE.ALL.CURRENTQCNT',           # +0.57
        'M16HUB.QUE.M16TOM14.MESCURRENTQCNT',   # +0.48
        'M16HUB.QUE.OHT.CURRENTOHTQCNT',        # +0.46
        'M16HUB.QUE.M16TOM14A.MESCURRENTQCNT',  # +0.42
        'M14.QUE.CNV.M14ATOM16ACURRNETQCNT',    # +0.36
        'M16HUB.QUE.OHT.OHTUTIL',               # +0.34
        'M16HUB.QUE.M14TOM16.MESCURRENTQCNT'    # -0.32
    ]
    
    expected_corr = [0.59, 0.57, 0.48, 0.46, 0.42, 0.36, 0.34, -0.32]
    
    TARGET_COL = 'CURRENT_M16A_3F_JOB_2'
    
    # ë°ì´í„° ë¡œë“œ
    print("\n[1] ë°ì´í„° ë¡œë“œ...")
    
    # âœ… íŒŒì¼ëª…ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”!
    data_file = '20250904_TO_20251020.csv'
    
    print(f"ğŸ“‚ íŒŒì¼: {data_file}")
    
    try:
        df = pd.read_csv(data_file, on_bad_lines='skip', encoding='utf-8', low_memory=False)
    except:
        try:
            df = pd.read_csv(data_file, on_bad_lines='skip', encoding='cp949', low_memory=False)
        except:
            df = pd.read_csv(data_file, on_bad_lines='skip', encoding='euc-kr', low_memory=False)
    
    print(f"âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df)}ê°œ í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ í™•ì¸
    if TARGET_COL not in df.columns:
        print(f"\nâŒ íƒ€ê²Ÿ ì»¬ëŸ¼ ì—†ìŒ: {TARGET_COL}")
        return
    
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    df = df.dropna(subset=[TARGET_COL])
    print(f"âœ… íƒ€ê²Ÿ ì»¬ëŸ¼ ì „ì²˜ë¦¬ ì™„ë£Œ: {len(df)}ê°œ í–‰")
    
    # ê²€ì¦ ì‹œì‘
    print("\n[2] ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ & ìƒê´€ê³„ìˆ˜ ê²€ì¦")
    print("-"*80)
    
    results = []
    
    for i, col in enumerate(new_features):
        result = {
            'ìˆœìœ„': i+1,
            'ì»¬ëŸ¼ëª…': col,
            'ì¡´ì¬ì—¬ë¶€': '',
            'ê²°ì¸¡ë¥ (%)': 0,
            'ê³„ì‚°ìƒê´€ê³„ìˆ˜': 0,
            'ì˜ˆìƒìƒê´€ê³„ìˆ˜': expected_corr[i],
            'ì˜¤ì°¨': 0,
            'ê²€ì¦': ''
        }
        
        # ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if col in df.columns:
            result['ì¡´ì¬ì—¬ë¶€'] = 'âœ…'
            
            # ìˆ«ì ë³€í™˜
            col_data = pd.to_numeric(df[col], errors='coerce')
            
            # ê²°ì¸¡ë¥  ê³„ì‚°
            missing_rate = col_data.isna().sum() / len(col_data) * 100
            result['ê²°ì¸¡ë¥ (%)'] = round(missing_rate, 2)
            
            # ìƒê´€ê³„ìˆ˜ ê³„ì‚°
            valid_mask = col_data.notna() & df[TARGET_COL].notna()
            if valid_mask.sum() > 0:
                corr = col_data[valid_mask].corr(df[TARGET_COL][valid_mask])
                result['ê³„ì‚°ìƒê´€ê³„ìˆ˜'] = round(corr, 4)
                result['ì˜¤ì°¨'] = round(abs(corr - expected_corr[i]), 4)
                
                # ê²€ì¦ (ì˜¤ì°¨ 0.05 ì´ë‚´ë©´ OK)
                if abs(corr - expected_corr[i]) <= 0.05:
                    result['ê²€ì¦'] = 'âœ…'
                else:
                    result['ê²€ì¦'] = f'âš ï¸ ì°¨ì´í¼'
            else:
                result['ê²€ì¦'] = 'âŒ ê³„ì‚°ë¶ˆê°€'
        else:
            result['ì¡´ì¬ì—¬ë¶€'] = 'âŒ'
            result['ê²€ì¦'] = 'âŒ ì»¬ëŸ¼ì—†ìŒ'
        
        results.append(result)
        
        # ì‹¤ì‹œê°„ ì¶œë ¥
        status = result['ê²€ì¦']
        print(f"{i+1}. {col[:40]:<40} | ì¡´ì¬:{result['ì¡´ì¬ì—¬ë¶€']} | ìƒê´€:{result['ê³„ì‚°ìƒê´€ê³„ìˆ˜']:>7.4f} | ì˜ˆìƒ:{expected_corr[i]:>6.2f} | {status}")
    
    # DataFrame ë³€í™˜
    results_df = pd.DataFrame(results)
    
    # ê²°ê³¼ ì €ì¥
    output_file = 'V7_feature_ê²€ì¦ê²°ê³¼.csv'
    results_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"\nâœ… ê²°ê³¼ ì €ì¥: {output_file}")
    
    # í†µê³„ ìš”ì•½
    print("\n" + "="*80)
    print("ğŸ“Š ê²€ì¦ ìš”ì•½")
    print("="*80)
    
    total = len(results_df)
    exists = (results_df['ì¡´ì¬ì—¬ë¶€'] == 'âœ…').sum()
    verified = (results_df['ê²€ì¦'] == 'âœ…').sum()
    
    print(f"\nì´ ê²€ì¦ ëŒ€ìƒ: {total}ê°œ")
    print(f"ì»¬ëŸ¼ ì¡´ì¬: {exists}/{total}ê°œ ({exists/total*100:.1f}%)")
    print(f"ìƒê´€ê³„ìˆ˜ ì¼ì¹˜: {verified}/{total}ê°œ ({verified/total*100:.1f}%)")
    
    # ë¬¸ì œ ì»¬ëŸ¼
    problems = results_df[results_df['ê²€ì¦'] != 'âœ…']
    if len(problems) > 0:
        print(f"\nâš ï¸ ë¬¸ì œ ì»¬ëŸ¼ ({len(problems)}ê°œ):")
        for idx, row in problems.iterrows():
            print(f"  - {row['ì»¬ëŸ¼ëª…']}: {row['ê²€ì¦']}")
    else:
        print(f"\nğŸ‰ ëª¨ë“  ì»¬ëŸ¼ ê²€ì¦ ì™„ë£Œ!")
    
    # ìƒê´€ê³„ìˆ˜ TOP 8 ì¬í™•ì¸
    print(f"\nğŸ”¥ ìƒê´€ê³„ìˆ˜ TOP 8 (ì¬ê³„ì‚°):")
    verified_cols = results_df[results_df['ì¡´ì¬ì—¬ë¶€'] == 'âœ…'].copy()
    verified_cols = verified_cols.sort_values('ê³„ì‚°ìƒê´€ê³„ìˆ˜', key=abs, ascending=False)
    
    for idx, row in verified_cols.iterrows():
        marker = "â­" if abs(row['ê³„ì‚°ìƒê´€ê³„ìˆ˜']) >= 0.40 else "  "
        print(f"{marker} {row['ìˆœìœ„']}. {row['ì»¬ëŸ¼ëª…'][:50]:<50} : {row['ê³„ì‚°ìƒê´€ê³„ìˆ˜']:>7.4f}")
    
    return results_df

if __name__ == '__main__':
    print("ğŸš€ V7 ì‹ ê·œ Feature ê²€ì¦ ì‹œì‘...\n")
    results = verify_v7_features()
    
    if results is not None:
        print(f"\nâœ… ê²€ì¦ ì™„ë£Œ!")
        print(f"ğŸ“ ê²°ê³¼: V7_feature_ê²€ì¦ê²°ê³¼.csv")