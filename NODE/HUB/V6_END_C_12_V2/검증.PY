"""
V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦ ì½”ë“œ
- 8ê°œ ì‹ ê·œ ì»¬ëŸ¼ì˜ ì‹¤ì œ ì˜ˆì¸¡ë ¥ ê²€ì¦
- V6 vs V7 ì„±ëŠ¥ ë¹„êµ
- ì»¬ëŸ¼ë³„ ê¸°ì—¬ë„ ë¶„ì„
"""

import numpy as np
import pandas as pd
import pickle
from datetime import datetime, timedelta
import warnings

warnings.filterwarnings('ignore')

# ===================================
# V7 ì‹ ê·œ ì»¬ëŸ¼ ì •ì˜
# ===================================
NEW_COLS_V7 = [
    'M16HUB.QUE.M16TOM14B.MESCURRENTQCNT',    # 1ìˆœìœ„ (0.59)
    'M16HUB.QUE.ALL.CURRENTQCNT',             # 2ìˆœìœ„ (0.57)
    'M16HUB.QUE.M16TOM14.MESCURRENTQCNT',     # 3ìˆœìœ„ (0.48)
    'M16HUB.QUE.OHT.CURRENTOHTQCNT',          # 4ìˆœìœ„ (0.46)
    'M16HUB.QUE.M16TOM14A.MESCURRENTQCNT',    # 5ìˆœìœ„ (0.42)
    'M14.QUE.CNV.M14ATOM16ACURRNETQCNT',      # 6ìˆœìœ„ (0.36)
    'M16HUB.QUE.OHT.OHTUTIL',                 # 7ìˆœìœ„ (0.34)
    'M16HUB.QUE.M14TOM16.MESCURRENTQCNT',     # 8ìˆœìœ„ (0.32)
]

# V6 ê¸°ì¡´ ì»¬ëŸ¼
V6_FEATURE_COLS = {
    'storage': ['M16A_3F_STORAGE_UTIL'],
    'fs_storage': ['CD_M163FSTORAGEUSE', 'CD_M163FSTORAGETOTAL', 'CD_M163FSTORAGEUTIL'],
    'hub': ['HUBROOMTOTAL'],
    'cmd': ['M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD'],
    'inflow': ['M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2', 'M14A_3F_TO_HUB_JOB2'],
    'outflow': ['M16A_3F_TO_M16A_6F_JOB', 'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB'],
    'maxcapa': ['M16A_6F_LFT_MAXCAPA', 'M16A_2F_LFT_MAXCAPA']
}

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'


def validate_new_columns(csv_file):
    """
    V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦ ë©”ì¸ í•¨ìˆ˜
    """
    print("="*80)
    print("ğŸ” V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦ ì‹œì‘")
    print("="*80)
    
    # ë°ì´í„° ë¡œë“œ
    try:
        df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='utf-8', low_memory=False)
    except:
        try:
            df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='cp949', low_memory=False)
        except:
            df = pd.read_csv(csv_file, on_bad_lines='skip', encoding='euc-kr', low_memory=False)
    
    print(f"\nâœ… ë°ì´í„° ë¡œë“œ: {len(df)}ê°œ í–‰")
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ í™•ì¸
    if TARGET_COL not in df.columns:
        print(f"âŒ íƒ€ê²Ÿ ì»¬ëŸ¼ '{TARGET_COL}' ì—†ìŒ!")
        return None
    
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    df = df.dropna(subset=[TARGET_COL])
    
    print(f"âœ… íƒ€ê²Ÿ ì»¬ëŸ¼ ì „ì²˜ë¦¬ ì™„ë£Œ: {len(df)}ê°œ í–‰")
    
    # ========================================
    # 1ë‹¨ê³„: ì‹ ê·œ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 1ë‹¨ê³„: ì‹ ê·œ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸")
    print("="*80)
    
    available_cols = []
    missing_cols = []
    
    for i, col in enumerate(NEW_COLS_V7, 1):
        if col in df.columns:
            available_cols.append(col)
            print(f"âœ… {i}. {col}")
        else:
            missing_cols.append(col)
            print(f"âŒ {i}. {col} - ì—†ìŒ!")
    
    print(f"\nğŸ“Š ê²°ê³¼: {len(available_cols)}/{len(NEW_COLS_V7)}ê°œ ì¡´ì¬")
    
    if len(available_cols) == 0:
        print("\nâŒ ì‹ ê·œ ì»¬ëŸ¼ì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤!")
        print("ğŸ’¡ íŒŒì¼ì— ë‹¤ìŒ ì»¬ëŸ¼ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”:")
        for col in NEW_COLS_V7:
            print(f"   - {col}")
        return None
    
    # ========================================
    # 2ë‹¨ê³„: ì‹ ê·œ ì»¬ëŸ¼ ê¸°ë³¸ í†µê³„
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 2ë‹¨ê³„: ì‹ ê·œ ì»¬ëŸ¼ ê¸°ë³¸ í†µê³„")
    print("="*80)
    
    stats_list = []
    
    for col in available_cols:
        data = df[col]
        
        stats = {
            'ì»¬ëŸ¼': col.split('.')[-1],  # ì§§ê²Œ í‘œì‹œ
            'í‰ê· ': round(data.mean(), 1),
            'í‘œì¤€í¸ì°¨': round(data.std(), 1),
            'ìµœì†Œ': round(data.min(), 1),
            'ìµœëŒ€': round(data.max(), 1),
            'ë²”ìœ„': round(data.max() - data.min(), 1),
            'ë³€ë™ê³„ìˆ˜(%)': round(data.std() / data.mean() * 100, 1) if data.mean() != 0 else 0,
        }
        stats_list.append(stats)
    
    stats_df = pd.DataFrame(stats_list)
    print(stats_df.to_string(index=False))
    
    # ========================================
    # 3ë‹¨ê³„: íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê´€ê³„
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 3ë‹¨ê³„: íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê´€ê³„")
    print("="*80)
    
    corr_list = []
    
    for col in available_cols:
        corr = df[TARGET_COL].corr(df[col])
        
        # ê¸‰ì¦ ì‹œ vs ì •ìƒ ì‹œ í‰ê·  ì°¨ì´
        high = df[df[TARGET_COL] >= 300][col].mean()
        low = df[df[TARGET_COL] < 300][col].mean()
        diff_pct = abs(high - low) / low * 100 if low != 0 else 0
        
        corr_list.append({
            'ì»¬ëŸ¼': col.split('.')[-1],
            'ìƒê´€ê³„ìˆ˜': round(corr, 4),
            '300+ í‰ê· ': round(high, 1),
            '300- í‰ê· ': round(low, 1),
            'ì°¨ì´(%)': round(diff_pct, 1),
        })
    
    corr_df = pd.DataFrame(corr_list).sort_values('ìƒê´€ê³„ìˆ˜', ascending=False, key=abs)
    print(corr_df.to_string(index=False))
    
    # ========================================
    # 4ë‹¨ê³„: ê¸‰ì¦ ì˜ˆì¸¡ë ¥ ê°œë³„ í…ŒìŠ¤íŠ¸
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 4ë‹¨ê³„: ê¸‰ì¦ ì˜ˆì¸¡ë ¥ ê°œë³„ í…ŒìŠ¤íŠ¸ (ë‹¨ì¼ Feature)")
    print("="*80)
    
    surge_results = []
    
    # ê¸‰ì¦ ì¼€ì´ìŠ¤ ì°¾ê¸°
    surge_indices = []
    for i in range(30, len(df) - 10):
        seq_max = df[TARGET_COL].iloc[i-30:i].max()
        actual = df[TARGET_COL].iloc[i:i+10].max()
        
        if seq_max < 300 and actual >= 300:
            surge_indices.append(i)
    
    print(f"âœ… ê¸‰ì¦ ì¼€ì´ìŠ¤: {len(surge_indices)}ê°œ ë°œê²¬")
    
    if len(surge_indices) > 0:
        for col in available_cols:
            # ê° ì»¬ëŸ¼ì˜ ë§ˆì§€ë§‰ ê°’ìœ¼ë¡œ ê°„ë‹¨í•œ ì„ê³„ê°’ í…ŒìŠ¤íŠ¸
            correct = 0
            
            for idx in surge_indices:
                last_value = df[col].iloc[idx-1]
                
                # ì»¬ëŸ¼ë³„ ì„ê³„ê°’ (ì„ì‹œ)
                if 'M16TOM14B' in col:
                    threshold = 120
                    detected = (last_value < threshold)
                elif 'ALL.CURRENT' in col:
                    threshold = 850
                    detected = (last_value > threshold)
                elif 'M16TOM14.MES' in col:
                    threshold = 300
                    detected = (last_value < threshold)
                elif 'OHT.CURRENT' in col:
                    threshold = 230
                    detected = (last_value > threshold)
                elif 'M16TOM14A' in col:
                    threshold = 160
                    detected = (last_value < threshold)
                elif 'M14ATOM16A' in col:
                    threshold = 220
                    detected = (last_value > threshold)
                elif 'OHTUTIL' in col:
                    threshold = 85
                    detected = (last_value > threshold)
                elif 'M14TOM16' in col:
                    threshold = 200
                    detected = (last_value < threshold)
                else:
                    detected = False
                
                if detected:
                    correct += 1
            
            detection_rate = correct / len(surge_indices) * 100
            
            surge_results.append({
                'ì»¬ëŸ¼': col.split('.')[-1],
                'ê°ì§€': correct,
                'ì „ì²´': len(surge_indices),
                'ê°ì§€ìœ¨(%)': round(detection_rate, 1),
            })
        
        surge_df = pd.DataFrame(surge_results).sort_values('ê°ì§€ìœ¨(%)', ascending=False)
        print(surge_df.to_string(index=False))
    
    # ========================================
    # 5ë‹¨ê³„: V6 vs V7 ë¹„êµ (ëª¨ë¸ í•„ìš” ì—†ëŠ” ê°„ë‹¨ ë¹„êµ)
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 5ë‹¨ê³„: ë³µí•© ì‹ í˜¸ í…ŒìŠ¤íŠ¸")
    print("="*80)
    
    if len(surge_indices) > 0:
        # V6 ë°©ì‹ (ê¸°ì¡´ ì§€í‘œë§Œ)
        v6_correct = 0
        # V7 ë°©ì‹ (ì‹ ê·œ ì§€í‘œ í¬í•¨)
        v7_correct = 0
        
        for idx in surge_indices:
            # V6 ì‹ í˜¸
            v6_signals = 0
            if 'HUBROOMTOTAL' in df.columns:
                if df['HUBROOMTOTAL'].iloc[idx-1] < 610:
                    v6_signals += 1
            if 'CD_M163FSTORAGEUTIL' in df.columns:
                if df['CD_M163FSTORAGEUTIL'].iloc[idx-1] >= 7:
                    v6_signals += 1
            if 'M16A_3F_CMD' in df.columns:
                if df['M16A_3F_CMD'].iloc[idx-1] < 220:
                    v6_signals += 1
            
            if v6_signals >= 2:
                v6_correct += 1
            
            # V7 ì‹ í˜¸ (V6 + ì‹ ê·œ)
            v7_signals = v6_signals
            
            if 'M16HUB.QUE.M16TOM14B.MESCURRENTQCNT' in df.columns:
                if df['M16HUB.QUE.M16TOM14B.MESCURRENTQCNT'].iloc[idx-1] < 120:
                    v7_signals += 2  # ê°€ì¤‘ì¹˜
            if 'M16HUB.QUE.ALL.CURRENTQCNT' in df.columns:
                if df['M16HUB.QUE.ALL.CURRENTQCNT'].iloc[idx-1] > 850:
                    v7_signals += 2  # ê°€ì¤‘ì¹˜
            if 'M16HUB.QUE.OHT.OHTUTIL' in df.columns:
                if df['M16HUB.QUE.OHT.OHTUTIL'].iloc[idx-1] > 85:
                    v7_signals += 1
            
            if v7_signals >= 3:
                v7_correct += 1
        
        print(f"\nğŸ“Š ë³µí•© ì‹ í˜¸ ê¸°ë°˜ ê¸‰ì¦ ê°ì§€:")
        print(f"   V6 ë°©ì‹ (ê¸°ì¡´ ì§€í‘œ): {v6_correct}/{len(surge_indices)} = {v6_correct/len(surge_indices)*100:.1f}%")
        print(f"   V7 ë°©ì‹ (ì‹ ê·œ ì¶”ê°€): {v7_correct}/{len(surge_indices)} = {v7_correct/len(surge_indices)*100:.1f}%")
        print(f"   ê°œì„ : {(v7_correct-v6_correct)/len(surge_indices)*100:+.1f}%p")
    
    # ========================================
    # 6ë‹¨ê³„: ê²°ê³¼ ì €ì¥
    # ========================================
    print("\n" + "="*80)
    print("ğŸ“Š 6ë‹¨ê³„: ê²°ê³¼ ì €ì¥")
    print("="*80)
    
    # í†µê³„ ì €ì¥
    stats_df.to_csv('V7_ì‹ ê·œì»¬ëŸ¼_ê¸°ë³¸í†µê³„.csv', index=False, encoding='utf-8-sig')
    print("âœ… V7_ì‹ ê·œì»¬ëŸ¼_ê¸°ë³¸í†µê³„.csv")
    
    # ìƒê´€ê´€ê³„ ì €ì¥
    corr_df.to_csv('V7_ì‹ ê·œì»¬ëŸ¼_ìƒê´€ê´€ê³„.csv', index=False, encoding='utf-8-sig')
    print("âœ… V7_ì‹ ê·œì»¬ëŸ¼_ìƒê´€ê´€ê³„.csv")
    
    # ê¸‰ì¦ ì˜ˆì¸¡ë ¥ ì €ì¥
    if len(surge_indices) > 0:
        surge_df.to_csv('V7_ì‹ ê·œì»¬ëŸ¼_ê¸‰ì¦ì˜ˆì¸¡ë ¥.csv', index=False, encoding='utf-8-sig')
        print("âœ… V7_ì‹ ê·œì»¬ëŸ¼_ê¸‰ì¦ì˜ˆì¸¡ë ¥.csv")
    
    # ========================================
    # ìµœì¢… ìš”ì•½
    # ========================================
    print("\n" + "="*80)
    print("ğŸ¯ ìµœì¢… ìš”ì•½")
    print("="*80)
    
    print(f"\n1ï¸âƒ£ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€:")
    print(f"   ì¡´ì¬: {len(available_cols)}/{len(NEW_COLS_V7)}ê°œ")
    if len(missing_cols) > 0:
        print(f"   ë¶€ì¡±: {missing_cols}")
    
    print(f"\n2ï¸âƒ£ ìƒê´€ê´€ê³„ ìš°ìˆ˜:")
    top_3 = corr_df.head(3)
    for _, row in top_3.iterrows():
        print(f"   â€¢ {row['ì»¬ëŸ¼']}: {row['ìƒê´€ê³„ìˆ˜']:+.4f}")
    
    print(f"\n3ï¸âƒ£ ê¸‰ì¦ ì˜ˆì¸¡ë ¥ ìš°ìˆ˜:")
    if len(surge_indices) > 0:
        top_3_surge = surge_df.head(3)
        for _, row in top_3_surge.iterrows():
            print(f"   â€¢ {row['ì»¬ëŸ¼']}: {row['ê°ì§€ìœ¨(%)']}%")
    
    print(f"\n4ï¸âƒ£ ê¶Œì¥ì‚¬í•­:")
    if len(available_cols) == len(NEW_COLS_V7):
        print(f"   âœ… ëª¨ë“  ì»¬ëŸ¼ ì‚¬ìš© ê°€ëŠ¥!")
        print(f"   âœ… V7 ëª¨ë¸ í•™ìŠµ ì§„í–‰ ê°€ëŠ¥!")
    elif len(available_cols) >= 6:
        print(f"   âš ï¸ {len(available_cols)}ê°œ ì»¬ëŸ¼ë§Œ ì‚¬ìš© ê°€ëŠ¥")
        print(f"   âš ï¸ V7 ëª¨ë¸ í•™ìŠµì€ ê°€ëŠ¥í•˜ë‚˜ ì„±ëŠ¥ ì œí•œì ")
    else:
        print(f"   âŒ ì‹ ê·œ ì»¬ëŸ¼ ë¶€ì¡± ({len(available_cols)}ê°œ)")
        print(f"   âŒ V6 ëª¨ë¸ ì‚¬ìš© ê¶Œì¥")
    
    return {
        'available_cols': available_cols,
        'missing_cols': missing_cols,
        'stats_df': stats_df,
        'corr_df': corr_df,
        'surge_df': surge_df if len(surge_indices) > 0 else None,
    }


if __name__ == '__main__':
    import sys
    
    print("\n" + "="*80)
    print("ğŸš€ V7 ì‹ ê·œ ì»¬ëŸ¼ ê²€ì¦ ë„êµ¬")
    print("="*80)
    
    # íŒŒì¼ëª… ì…ë ¥
    if len(sys.argv) > 1:
        csv_file = sys.argv[1]
    else:
        print("\nğŸ“ ê²€ì¦í•  CSV íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:")
        print("   ì˜ˆ: HUB_0509_TO_0929_DATA.csv")
        csv_file = input("\níŒŒì¼ëª…: ").strip()
    
    if not csv_file:
        print("\nâŒ íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤!")
        print("\nì‚¬ìš©ë²•:")
        print("   python V7_ì»¬ëŸ¼ê²€ì¦.py [íŒŒì¼ëª….csv]")
        print("   ë˜ëŠ”")
        print("   python V7_ì»¬ëŸ¼ê²€ì¦.py")
        print("   (íŒŒì¼ëª… ì…ë ¥)")
    else:
        result = validate_new_columns(csv_file)
        
        if result:
            print("\n" + "="*80)
            print("âœ… ê²€ì¦ ì™„ë£Œ!")
            print("="*80)
            print(f"\nğŸ“ ê²°ê³¼ íŒŒì¼:")
            print(f"   â€¢ V7_ì‹ ê·œì»¬ëŸ¼_ê¸°ë³¸í†µê³„.csv")
            print(f"   â€¢ V7_ì‹ ê·œì»¬ëŸ¼_ìƒê´€ê´€ê³„.csv")
            print(f"   â€¢ V7_ì‹ ê·œì»¬ëŸ¼_ê¸‰ì¦ì˜ˆì¸¡ë ¥.csv")
        else:
            print("\n" + "="*80)
            print("âŒ ê²€ì¦ ì‹¤íŒ¨!")
            print("="*80)