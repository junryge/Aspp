# -*- coding: utf-8 -*-
"""
V6 Feature ê´€ê³„ì„± ë¶„ì„ ë° ì‹œê°í™”
- Feature ê°„ ìƒê´€ê³„ìˆ˜ ê³„ì‚°
- ì¸í„°ë™í‹°ë¸Œ íˆíŠ¸ë§µ ìƒì„±
- ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ìƒì„±
- ì¹´í…Œê³ ë¦¬ë³„ ê´€ê³„ë„
"""

import numpy as np
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import warnings

warnings.filterwarnings('ignore')

# Feature ì»¬ëŸ¼ ê·¸ë£¹
FEATURE_COLS = {
    'storage': ['M16A_3F_STORAGE_UTIL'],
    'fs_storage': ['CD_M163FSTORAGEUSE', 'CD_M163FSTORAGETOTAL', 'CD_M163FSTORAGEUTIL'],
    'hub': ['HUBROOMTOTAL'],
    'cmd': ['M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD'],
    'inflow': ['M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2', 'M14A_3F_TO_HUB_JOB2'],
    'outflow': ['M16A_3F_TO_M16A_6F_JOB', 'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB'],
    'maxcapa': ['M16A_6F_LFT_MAXCAPA', 'M16A_2F_LFT_MAXCAPA']
}

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'

def create_features_for_correlation(df, start_idx=30):
    """ìƒê´€ê³„ìˆ˜ ë¶„ì„ìš© Feature ìƒì„±"""
    features_list = []
    labels = []
    
    for i in range(start_idx, len(df) - 10):
        seq_target = df[TARGET_COL].iloc[i-30:i].values
        
        # íƒ€ê²Ÿ ê¸°ë³¸ í†µê³„
        features = {
            'target_mean': np.mean(seq_target),
            'target_std': np.std(seq_target),
            'target_max': np.max(seq_target),
            'target_min': np.min(seq_target),
            'target_last_value': seq_target[-1],
            'target_last_5_mean': np.mean(seq_target[-5:]),
            'target_slope': np.polyfit(np.arange(30), seq_target, 1)[0],
        }
        
        # Momentum Feature
        features['target_acceleration'] = (seq_target[-5:].mean() - seq_target[-10:-5].mean()) / 5
        features['target_is_rising'] = 1 if seq_target[-1] > seq_target[-5] else 0
        features['target_rapid_rise'] = 1 if (seq_target[-1] - seq_target[-5] > 10) else 0
        features['target_last_10_mean'] = np.mean(seq_target[-10:])
        
        # ê° ì»¬ëŸ¼ ê·¸ë£¹ë³„ Feature
        for group_name, cols in FEATURE_COLS.items():
            for col in cols:
                if col not in df.columns:
                    continue
                
                col_seq = df[col].iloc[i-30:i].values
                
                if group_name == 'maxcapa':
                    features[f'{col}_last_value'] = col_seq[-1]
                
                elif group_name in ['cmd', 'storage', 'fs_storage', 'hub']:
                    features[f'{col}_mean'] = np.mean(col_seq)
                    features[f'{col}_std'] = np.std(col_seq)
                    features[f'{col}_max'] = np.max(col_seq)
                    features[f'{col}_min'] = np.min(col_seq)
                    features[f'{col}_last_value'] = col_seq[-1]
                    features[f'{col}_last_5_mean'] = np.mean(col_seq[-5:])
                    features[f'{col}_slope'] = np.polyfit(np.arange(30), col_seq, 1)[0]
                
                else:
                    features[f'{col}_mean'] = np.mean(col_seq)
                    features[f'{col}_last_value'] = col_seq[-1]
                    features[f'{col}_slope'] = np.polyfit(np.arange(30), col_seq, 1)[0]
        
        # FS Storage Feature
        if 'CD_M163FSTORAGEUSE' in df.columns and 'CD_M163FSTORAGETOTAL' in df.columns:
            storage_use = df['CD_M163FSTORAGEUSE'].iloc[i-30:i].values
            storage_total = df['CD_M163FSTORAGETOTAL'].iloc[i-30:i].values
            storage_util = df['CD_M163FSTORAGEUTIL'].iloc[i-30:i].values
            
            features['storage_use_rate'] = (storage_use[-1] - storage_use[0]) / 30
            features['storage_remaining'] = storage_total[-1] - storage_use[-1]
            features['storage_util_last'] = storage_util[-1]
            features['storage_util_high'] = 1 if storage_util[-1] >= 7 else 0
            features['storage_util_critical'] = 1 if storage_util[-1] >= 10 else 0
        
        # HUBROOMTOTAL Feature
        if 'HUBROOMTOTAL' in df.columns:
            hub_seq = df['HUBROOMTOTAL'].iloc[i-30:i].values
            hub_last = hub_seq[-1]
            
            features['hub_critical'] = 1 if hub_last < 590 else 0
            features['hub_high'] = 1 if hub_last < 610 else 0
            features['hub_warning'] = 1 if hub_last < 620 else 0
            features['hub_decrease_rate'] = (hub_seq[0] - hub_last) / 30
            
            if 'CD_M163FSTORAGEUTIL' in df.columns:
                storage_util_last = df['CD_M163FSTORAGEUTIL'].iloc[i-1]
                features['hub_storage_risk'] = 1 if (hub_last < 610 and storage_util_last >= 7) else 0
        
        # ìœ ì…-ìœ ì¶œ, CMD
        inflow_sum = sum(df[col].iloc[i-1] for col in FEATURE_COLS['inflow'] if col in df.columns)
        outflow_sum = sum(df[col].iloc[i-1] for col in FEATURE_COLS['outflow'] if col in df.columns)
        features['net_flow'] = inflow_sum - outflow_sum
        
        cmd_sum = sum(df[col].iloc[i-1] for col in FEATURE_COLS['cmd'] if col in df.columns)
        features['total_cmd'] = cmd_sum
        features['total_cmd_low'] = 1 if cmd_sum < 220 else 0
        features['total_cmd_very_low'] = 1 if cmd_sum < 200 else 0
        
        if 'HUBROOMTOTAL' in df.columns:
            hub_last = df['HUBROOMTOTAL'].iloc[i-1]
            features['hub_cmd_bottleneck'] = 1 if (hub_last < 610 and cmd_sum < 220) else 0
        
        if 'M16A_3F_STORAGE_UTIL' in df.columns:
            storage_util = df['M16A_3F_STORAGE_UTIL'].iloc[i-1]
            features['storage_util_critical'] = 1 if storage_util >= 205 else 0
            features['storage_util_high_risk'] = 1 if storage_util >= 207 else 0
        
        # ê¸‰ì¦ ìœ„í—˜ë„ ì ìˆ˜
        features['surge_risk_score'] = (
            features.get('hub_high', 0) * 3 +
            features.get('storage_util_critical', 0) * 2 +
            features.get('total_cmd_low', 0) * 1 +
            features.get('storage_util_high', 0) * 1
        )
        
        # ê¸‰ì¦ ì„ë°• ì‹ í˜¸
        features['surge_imminent'] = 1 if (
            seq_target[-1] > 272 and
            features.get('target_acceleration', 0) > 0.2 and
            features.get('hub_high', 0) == 1
        ) else 0
        
        features_list.append(features)
        labels.append(df[TARGET_COL].iloc[i:i+10].max())
    
    return pd.DataFrame(features_list), np.array(labels)


def create_correlation_heatmap(corr_matrix, title="Feature ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ"):
    """ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ ìƒì„±"""
    fig = go.Figure(data=go.Heatmap(
        z=corr_matrix.values,
        x=corr_matrix.columns,
        y=corr_matrix.index,
        colorscale='RdBu_r',
        zmid=0,
        zmin=-1,
        zmax=1,
        text=np.round(corr_matrix.values, 2),
        texttemplate='%{text}',
        textfont={"size": 8},
        colorbar=dict(title="ìƒê´€ê³„ìˆ˜")
    ))
    
    fig.update_layout(
        title=title,
        width=1400,
        height=1400,
        xaxis_tickangle=-45,
        font=dict(size=10)
    )
    
    return fig


def create_target_correlation_chart(df_features, labels):
    """íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê³„ìˆ˜ ë§‰ëŒ€ ê·¸ë˜í”„"""
    # íƒ€ê²Ÿ ì¶”ê°€
    df_with_target = df_features.copy()
    df_with_target['TARGET'] = labels
    
    # íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê³„ìˆ˜ ê³„ì‚°
    target_corr = df_with_target.corr()['TARGET'].drop('TARGET').sort_values(ascending=False)
    
    # ìƒìœ„ 30ê°œë§Œ
    top_30 = target_corr.head(30)
    
    fig = go.Figure()
    
    colors = ['red' if x > 0.8 else 'orange' if x > 0.6 else 'lightblue' for x in top_30.values]
    
    fig.add_trace(go.Bar(
        x=top_30.values,
        y=top_30.index,
        orientation='h',
        marker=dict(color=colors),
        text=np.round(top_30.values, 3),
        textposition='auto'
    ))
    
    fig.update_layout(
        title="íƒ€ê²Ÿ(CURRENT_M16A_3F_JOB_2)ê³¼ì˜ ìƒê´€ê³„ìˆ˜ Top 30",
        xaxis_title="ìƒê´€ê³„ìˆ˜",
        yaxis_title="Feature",
        height=900,
        width=1000,
        showlegend=False
    )
    
    return fig, target_corr


def create_category_correlation_matrix(df_features):
    """ì¹´í…Œê³ ë¦¬ë³„ ìƒê´€ê³„ìˆ˜ ë§¤íŠ¸ë¦­ìŠ¤"""
    # Featureë¥¼ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜
    category_features = {
        'Target_ê¸°ë³¸í†µê³„': [c for c in df_features.columns if c.startswith('target_') and 
                          c not in ['target_acceleration', 'target_is_rising', 'target_rapid_rise', 'target_last_10_mean']],
        'Momentum': ['target_acceleration', 'target_is_rising', 'target_rapid_rise', 'target_last_10_mean'],
        'Hub': [c for c in df_features.columns if 'HUBROOM' in c or c.startswith('hub_')],
        'Storage': [c for c in df_features.columns if 'M16A_3F_STORAGE' in c or c.startswith('storage_')],
        'FS_Storage': [c for c in df_features.columns if 'CD_M163F' in c],
        'CMD': [c for c in df_features.columns if 'CMD' in c or c.startswith('total_cmd')],
        'Inflow': [c for c in df_features.columns if 'TO_HUB_JOB' in c],
        'Outflow': [c for c in df_features.columns if 'M16A_3F_TO_' in c and '_JOB' in c],
        'ìœ„í—˜ì‹ í˜¸': ['surge_risk_score', 'surge_imminent', 'hub_storage_risk', 'hub_cmd_bottleneck', 'net_flow']
    }
    
    # ê° ì¹´í…Œê³ ë¦¬ ëŒ€í‘œ Feature ì„ íƒ
    selected_features = []
    feature_names = []
    
    for cat, features in category_features.items():
        valid_features = [f for f in features if f in df_features.columns]
        if valid_features:
            # ê° ì¹´í…Œê³ ë¦¬ì—ì„œ ìµœëŒ€ 5ê°œì”©
            selected = valid_features[:5]
            selected_features.extend(selected)
            feature_names.extend([f"{cat}_{f}" for f in selected])
    
    # ìƒê´€ê³„ìˆ˜ ê³„ì‚°
    corr_matrix = df_features[selected_features].corr()
    corr_matrix.index = feature_names
    corr_matrix.columns = feature_names
    
    return corr_matrix


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("="*80)
    print("ğŸ” V6 Feature ê´€ê³„ì„± ë¶„ì„ ì‹œì‘")
    print("="*80)
    
    # ë°ì´í„° ë¡œë“œ
    print("\n[1] ë°ì´í„° ë¡œë“œ ì¤‘...")
    try:
        df = pd.read_csv('20250904_TO_20251020.csv', on_bad_lines='skip', encoding='utf-8', low_memory=False)
    except:
        try:
            df = pd.read_csv('20250904_TO_20251020.csv', on_bad_lines='skip', encoding='cp949', low_memory=False)
        except:
            df = pd.read_csv('20250904_TO_20251020.csv', on_bad_lines='skip', encoding='euc-kr', low_memory=False)
    
    df[TARGET_COL] = pd.to_numeric(df[TARGET_COL], errors='coerce')
    df = df.dropna(subset=[TARGET_COL])
    
    print(f"âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df)}ê°œ í–‰")
    
    # Feature ìƒì„±
    print("\n[2] Feature ìƒì„± ì¤‘...")
    df_features, labels = create_features_for_correlation(df)
    print(f"âœ… Feature ìƒì„± ì™„ë£Œ: {len(df_features.columns)}ê°œ Feature, {len(df_features)}ê°œ ìƒ˜í”Œ")
    
    # ìƒê´€ê³„ìˆ˜ ê³„ì‚°
    print("\n[3] ìƒê´€ê³„ìˆ˜ ê³„ì‚° ì¤‘...")
    corr_matrix = df_features.corr()
    print(f"âœ… ìƒê´€ê³„ìˆ˜ ê³„ì‚° ì™„ë£Œ: {corr_matrix.shape[0]}x{corr_matrix.shape[1]} ë§¤íŠ¸ë¦­ìŠ¤")
    
    # 1. ì „ì²´ ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ
    print("\n[4] ì „ì²´ ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ ìƒì„± ì¤‘...")
    fig1 = create_correlation_heatmap(corr_matrix, "V6 Feature ê°„ ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ (ì „ì²´)")
    fig1.write_html('V6_Feature_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ_ì „ì²´.html')
    print("âœ… ì €ì¥: V6_Feature_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ_ì „ì²´.html")
    
    # 2. íƒ€ê²Ÿê³¼ì˜ ìƒê´€ê³„ìˆ˜
    print("\n[5] íƒ€ê²Ÿ ìƒê´€ê³„ìˆ˜ ì°¨íŠ¸ ìƒì„± ì¤‘...")
    fig2, target_corr = create_target_correlation_chart(df_features, labels)
    fig2.write_html('V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_Top30.html')
    print("âœ… ì €ì¥: V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_Top30.html")
    
    # íƒ€ê²Ÿ ìƒê´€ê³„ìˆ˜ CSV ì €ì¥
    target_corr_df = pd.DataFrame({
        'Feature': target_corr.index,
        'íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜': target_corr.values,
        'ì ˆëŒ€ê°’': np.abs(target_corr.values)
    }).sort_values('ì ˆëŒ€ê°’', ascending=False)
    target_corr_df.to_csv('V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_ì „ì²´.csv', index=False, encoding='utf-8-sig')
    print("âœ… ì €ì¥: V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_ì „ì²´.csv")
    
    # 3. ì¹´í…Œê³ ë¦¬ë³„ ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ
    print("\n[6] ì¹´í…Œê³ ë¦¬ë³„ ìƒê´€ê³„ìˆ˜ íˆíŠ¸ë§µ ìƒì„± ì¤‘...")
    category_corr = create_category_correlation_matrix(df_features)
    fig3 = create_correlation_heatmap(category_corr, "V6 Feature ì¹´í…Œê³ ë¦¬ë³„ ìƒê´€ê³„ìˆ˜ (ëŒ€í‘œ Feature)")
    fig3.write_html('V6_ì¹´í…Œê³ ë¦¬ë³„_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ.html')
    print("âœ… ì €ì¥: V6_ì¹´í…Œê³ ë¦¬ë³„_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ.html")
    
    # 4. ê³ ìƒê´€ Feature ìŒ ì¶”ì¶œ
    print("\n[7] ê³ ìƒê´€ Feature ìŒ ì¶”ì¶œ ì¤‘...")
    high_corr_pairs = []
    for i in range(len(corr_matrix.columns)):
        for j in range(i+1, len(corr_matrix.columns)):
            corr_val = corr_matrix.iloc[i, j]
            if abs(corr_val) > 0.7:  # ìƒê´€ê³„ìˆ˜ 0.7 ì´ìƒ
                high_corr_pairs.append({
                    'Feature1': corr_matrix.columns[i],
                    'Feature2': corr_matrix.columns[j],
                    'ìƒê´€ê³„ìˆ˜': round(corr_val, 3),
                    'ì ˆëŒ€ê°’': round(abs(corr_val), 3)
                })
    
    high_corr_df = pd.DataFrame(high_corr_pairs).sort_values('ì ˆëŒ€ê°’', ascending=False)
    high_corr_df.to_csv('V6_ê³ ìƒê´€_FeatureìŒ.csv', index=False, encoding='utf-8-sig')
    print(f"âœ… ì €ì¥: V6_ê³ ìƒê´€_FeatureìŒ.csv ({len(high_corr_df)}ê°œ ìŒ)")
    
    # 5. í†µê³„ ìš”ì•½
    print("\n[8] í†µê³„ ìš”ì•½ ìƒì„± ì¤‘...")
    
    print("\n" + "="*80)
    print("ğŸ“Š ë¶„ì„ ê²°ê³¼ ìš”ì•½")
    print("="*80)
    
    print(f"\nğŸ¯ íƒ€ê²Ÿê³¼ ê°€ì¥ ê°•í•œ ìƒê´€ê´€ê³„ Top 10:")
    for idx, (feat, corr) in enumerate(target_corr.head(10).items(), 1):
        print(f"  {idx:2d}. {feat:40s}: {corr:+.3f}")
    
    print(f"\nâš ï¸ íƒ€ê²Ÿê³¼ ê°€ì¥ ì•½í•œ ìƒê´€ê´€ê³„ Bottom 10:")
    for idx, (feat, corr) in enumerate(target_corr.tail(10).items(), 1):
        print(f"  {idx:2d}. {feat:40s}: {corr:+.3f}")
    
    print(f"\nğŸ”— ê°€ì¥ ê°•í•œ Feature ê°„ ìƒê´€ê´€ê³„ Top 10:")
    for idx, row in high_corr_df.head(10).iterrows():
        print(f"  {idx+1:2d}. {row['Feature1']:35s} â†” {row['Feature2']:35s}: {row['ìƒê´€ê³„ìˆ˜']:+.3f}")
    
    print("\n" + "="*80)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print("="*80)
    
    print("\nğŸ“ ìƒì„±ëœ íŒŒì¼:")
    print("  1. V6_Feature_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ_ì „ì²´.html")
    print("  2. V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_Top30.html")
    print("  3. V6_ì¹´í…Œê³ ë¦¬ë³„_ìƒê´€ê³„ìˆ˜_íˆíŠ¸ë§µ.html")
    print("  4. V6_íƒ€ê²Ÿ_ìƒê´€ê³„ìˆ˜_ì „ì²´.csv")
    print("  5. V6_ê³ ìƒê´€_FeatureìŒ.csv")


if __name__ == '__main__':
    main()