# -*- coding: utf-8 -*-
"""
V6 ì‹¤ì‹œê°„ ì˜ˆì¸¡ ì‹œìŠ¤í…œ
- 30ë¶„ ì‹œí€€ìŠ¤ â†’ 10ë¶„ í›„ ì˜ˆì¸¡
- Momentum Feature í¬í•¨
- 300 ì´ìƒ ë‹¬ì„± í™•ë¥  ê³„ì‚°
- ìƒìŠ¹ ì›ì¸ ë¶„ì„
"""

import numpy as np
import pandas as pd
import pickle
from datetime import datetime, timedelta
import os
import webbrowser  # ë¸Œë¼ìš°ì € ìë™ ì—´ê¸°ìš©

# ê²½ë¡œ ì„¤ì •
script_dir = os.path.dirname(os.path.abspath(__file__))
model_path = os.path.join(script_dir, 'model', 'xgboost_ì™„ë²½ë²„ì „_ê°€ì¤‘ì¹˜5ë°°_ì„ê³„ê°’280_momentum.pkl')
data_path = os.path.join(script_dir, 'data', 'HUBROOM_PIVOT_DATA.csv')

# V6 Feature ì»¬ëŸ¼ ì •ì˜
FEATURE_COLS = {
    'storage': ['M16A_3F_STORAGE_UTIL'],
    'fs_storage': ['CD_M163FSTORAGEUSE', 'CD_M163FSTORAGETOTAL', 'CD_M163FSTORAGEUTIL'],
    'hub': ['HUBROOMTOTAL'],
    'cmd': ['M16A_3F_CMD', 'M16A_6F_TO_HUB_CMD'],
    'inflow': ['M16A_6F_TO_HUB_JOB', 'M16A_2F_TO_HUB_JOB2', 'M14A_3F_TO_HUB_JOB2'],
    'outflow': ['M16A_3F_TO_M16A_6F_JOB', 'M16A_3F_TO_M16A_2F_JOB', 'M16A_3F_TO_M14A_3F_JOB'],
    'maxcapa': ['M16A_6F_LFT_MAXCAPA', 'M16A_2F_LFT_MAXCAPA']
}

TARGET_COL = 'CURRENT_M16A_3F_JOB_2'

def calculate_exceed_300_probability(prediction, features):
    """
    10ë¶„ ë‚´ 300 ì´ìƒ ë‹¬ì„± í™•ë¥  ê³„ì‚°
    """
    # 1. ì˜ˆì¸¡ê°’ ê¸°ë°˜ í™•ë¥ 
    if prediction >= 310:
        base_prob = 95
    elif prediction >= 300:
        base_prob = 85
    elif prediction >= 290:
        base_prob = 60
    elif prediction >= 280:
        base_prob = 35
    elif prediction >= 270:
        base_prob = 20
    else:
        base_prob = 5
    
    # 2. Momentum ë³´ì •
    momentum_boost = 0
    if features.get('surge_imminent', 0) == 1:
        momentum_boost += 15
    if features.get('target_acceleration', 0) > 1.0:
        momentum_boost += 10
    elif features.get('target_acceleration', 0) > 0.5:
        momentum_boost += 5
    
    # 3. ìœ„í—˜ ìš”ì¸ ë³´ì •
    risk_boost = 0
    if features.get('hub_high', 0) == 1:
        risk_boost += 10
    if features.get('storage_util_critical', 0) == 1:
        risk_boost += 5
    if features.get('total_cmd_low', 0) == 1:
        risk_boost += 5
    
    # 4. ìµœì¢… í™•ë¥  (0~100% ë²”ìœ„)
    final_prob = min(100, max(0, base_prob + momentum_boost + risk_boost))
    
    return f"{final_prob}%"

def analyze_surge_cause(features, seq_target):
    """
    ìƒìŠ¹ ì›ì¸ ë¶„ì„
    """
    causes = []
    
    # HUB ë³‘ëª©
    hub_last = features.get('HUBROOMTOTAL_last_value', 650)
    if hub_last < 590:
        causes.append(f"HUBì‹¬ê°ë³‘ëª©({int(hub_last)})")
    elif hub_last < 610:
        causes.append(f"HUBë³‘ëª©({int(hub_last)})")
    
    # ê°€ì†ë„
    acceleration = features.get('target_acceleration', 0)
    if acceleration > 1.0:
        causes.append(f"ë§¤ìš°ë†’ì€ê°€ì†ë„({acceleration:.1f})")
    elif acceleration > 0.5:
        causes.append(f"ë†’ì€ê°€ì†ë„({acceleration:.1f})")
    
    # CMD ë¶€ì¡±
    total_cmd = features.get('total_cmd', 300)
    if total_cmd < 200:
        causes.append(f"CMDì‹¬ê°ë¶€ì¡±({int(total_cmd)})")
    elif total_cmd < 220:
        causes.append(f"CMDë¶€ì¡±({int(total_cmd)})")
    
    # ìŠ¤í† ë¦¬ì§€ ê³¼ë¶€í•˜
    storage_util = features.get('M16A_3F_STORAGE_UTIL_last_value', 0)
    if storage_util >= 207:
        causes.append(f"ìŠ¤í† ë¦¬ì§€ì‹¬ê°({int(storage_util)})")
    elif storage_util >= 205:
        causes.append(f"ìŠ¤í† ë¦¬ì§€ê³¼ë¶€í•˜({int(storage_util)})")
    
    # FS ì €ì¥ê³µê°„ ë¶€ì¡±
    fs_util = features.get('CD_M163FSTORAGEUTIL_last_value', 0)
    if fs_util >= 10:
        causes.append(f"FSì‹¬ê°ë¶€ì¡±({fs_util:.1f})")
    elif fs_util >= 7:
        causes.append(f"FSë¶€ì¡±({fs_util:.1f})")
    
    # ê¸‰ë“± íŒ¨í„´
    if features.get('target_rapid_rise', 0) == 1:
        causes.append("5ë¶„ê¸‰ë“±íŒ¨í„´")
    
    # ê¸‰ì¦ ì„ë°•
    if features.get('surge_imminent', 0) == 1:
        causes.append("ê¸‰ì¦ì„ë°•ì‹ í˜¸")
    
    # ì›ì¸ì´ ì—†ìœ¼ë©´
    if not causes:
        # í˜„ì¬ê°’ í™•ì¸
        current_value = seq_target[-1]
        if current_value < 250:
            causes.append("ì •ìƒë²”ìœ„")
        else:
            causes.append("ì™„ë§Œí•œìƒìŠ¹ì¶”ì„¸")
    
    return " + ".join(causes)

def create_features_realtime(df_30):
    """
    ì‹¤ì‹œê°„ Feature ìƒì„± (í•™ìŠµ ì½”ë“œì™€ ë™ì¼)
    """
    seq_target = df_30[TARGET_COL].values
    
    # íƒ€ê²Ÿ ê¸°ë³¸ í†µê³„
    features = {
        'target_mean': np.mean(seq_target),
        'target_std': np.std(seq_target),
        'target_max': np.max(seq_target),
        'target_min': np.min(seq_target),
        'target_last_value': seq_target[-1],
        'target_last_5_mean': np.mean(seq_target[-5:]),
        'target_slope': np.polyfit(np.arange(30), seq_target, 1)[0],
    }
    
    # ğŸ†• Momentum Feature ì¶”ê°€
    features['target_acceleration'] = (seq_target[-5:].mean() - seq_target[-10:-5].mean()) / 5
    features['target_is_rising'] = 1 if seq_target[-1] > seq_target[-5] else 0
    features['target_rapid_rise'] = 1 if (seq_target[-1] - seq_target[-5] > 10) else 0
    features['target_last_10_mean'] = np.mean(seq_target[-10:])
    
    # ê° ì»¬ëŸ¼ ê·¸ë£¹ë³„ Feature
    for group_name, cols in FEATURE_COLS.items():
        for col in cols:
            if col not in df_30.columns:
                continue
            
            col_seq = df_30[col].values
            
            if group_name == 'maxcapa':
                features[f'{col}_last_value'] = col_seq[-1]
            
            elif group_name in ['cmd', 'storage', 'fs_storage', 'hub']:
                features[f'{col}_mean'] = np.mean(col_seq)
                features[f'{col}_std'] = np.std(col_seq)
                features[f'{col}_max'] = np.max(col_seq)
                features[f'{col}_min'] = np.min(col_seq)
                features[f'{col}_last_value'] = col_seq[-1]
                features[f'{col}_last_5_mean'] = np.mean(col_seq[-5:])
                features[f'{col}_slope'] = np.polyfit(np.arange(30), col_seq, 1)[0]
            
            else:
                features[f'{col}_mean'] = np.mean(col_seq)
                features[f'{col}_last_value'] = col_seq[-1]
                features[f'{col}_slope'] = np.polyfit(np.arange(30), col_seq, 1)[0]
    
    # FS Storage Feature
    if 'CD_M163FSTORAGEUSE' in df_30.columns and 'CD_M163FSTORAGETOTAL' in df_30.columns:
        storage_use = df_30['CD_M163FSTORAGEUSE'].values
        storage_total = df_30['CD_M163FSTORAGETOTAL'].values
        storage_util = df_30['CD_M163FSTORAGEUTIL'].values
        
        features['storage_use_rate'] = (storage_use[-1] - storage_use[0]) / 30
        features['storage_remaining'] = storage_total[-1] - storage_use[-1]
        features['storage_util_last'] = storage_util[-1]
        features['storage_util_high'] = 1 if storage_util[-1] >= 7 else 0
        features['storage_util_critical'] = 1 if storage_util[-1] >= 10 else 0
    
    # HUBROOMTOTAL Feature
    if 'HUBROOMTOTAL' in df_30.columns:
        hub_seq = df_30['HUBROOMTOTAL'].values
        hub_last = hub_seq[-1]
        
        features['hub_critical'] = 1 if hub_last < 590 else 0
        features['hub_high'] = 1 if hub_last < 610 else 0
        features['hub_warning'] = 1 if hub_last < 620 else 0
        features['hub_decrease_rate'] = (hub_seq[0] - hub_last) / 30
        
        if 'CD_M163FSTORAGEUTIL' in df_30.columns:
            storage_util_last = df_30['CD_M163FSTORAGEUTIL'].iloc[-1]
            features['hub_storage_risk'] = 1 if (hub_last < 610 and storage_util_last >= 7) else 0
    
    # ìœ ì…-ìœ ì¶œ, CMD
    inflow_sum = sum(df_30[col].iloc[-1] for col in FEATURE_COLS['inflow'] if col in df_30.columns)
    outflow_sum = sum(df_30[col].iloc[-1] for col in FEATURE_COLS['outflow'] if col in df_30.columns)
    features['net_flow'] = inflow_sum - outflow_sum
    
    cmd_sum = sum(df_30[col].iloc[-1] for col in FEATURE_COLS['cmd'] if col in df_30.columns)
    features['total_cmd'] = cmd_sum
    features['total_cmd_low'] = 1 if cmd_sum < 220 else 0
    features['total_cmd_very_low'] = 1 if cmd_sum < 200 else 0
    
    # HUB Ã— CMD ë³µí•©
    if 'HUBROOMTOTAL' in df_30.columns:
        hub_last = df_30['HUBROOMTOTAL'].iloc[-1]
        features['hub_cmd_bottleneck'] = 1 if (hub_last < 610 and cmd_sum < 220) else 0
    
    # Storage Util ìœ„í—˜
    if 'M16A_3F_STORAGE_UTIL' in df_30.columns:
        storage_util = df_30['M16A_3F_STORAGE_UTIL'].iloc[-1]
        features['storage_util_critical'] = 1 if storage_util >= 205 else 0
        features['storage_util_high_risk'] = 1 if storage_util >= 207 else 0
    
    # ğŸ”¥ ê¸‰ì¦ ìœ„í—˜ë„ ì ìˆ˜
    features['surge_risk_score'] = (
        features.get('hub_high', 0) * 3 +
        features.get('storage_util_critical', 0) * 2 +
        features.get('total_cmd_low', 0) * 1 +
        features.get('storage_util_high', 0) * 1
    )
    
    # ğŸ†• ê¸‰ì¦ ì„ë°• ì‹ í˜¸
    features['surge_imminent'] = 1 if (
        seq_target[-1] > 272 and
        features.get('target_acceleration', 0) > 0.2 and
        features.get('hub_high', 0) == 1
    ) else 0
    
    return features, seq_target

def realtime_prediction():
    """
    ì‹¤ì‹œê°„ ì˜ˆì¸¡ ë©”ì¸ í•¨ìˆ˜
    """
    # ëª¨ë¸ ë¡œë“œ
    try:
        with open(model_path, 'rb') as f:
            model = pickle.load(f)
    except FileNotFoundError:
        return None, "MODEL_FILE_NOT_FOUND"
    except Exception as e:
        return None, f"MODEL_LOAD_ERROR: {str(e)}"
    
    # ë°ì´í„° ë¡œë“œ
    try:
        df = pd.read_csv(data_path, on_bad_lines='skip', encoding='utf-8', low_memory=False)
    except FileNotFoundError:
        return None, "DATA_FILE_NOT_FOUND"
    except Exception as e:
        return None, f"DATA_LOAD_ERROR: {str(e)}"
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ í™•ì¸
    if TARGET_COL not in df.columns:
        return None, "TARGET_COLUMN_NOT_FOUND"
    
    # ìµœê·¼ 30ê°œ ë°ì´í„° ì¶”ì¶œ
    if len(df) < 30:
        return None, "INSUFFICIENT_DATA"
    
    df_30 = df.tail(30).copy()
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼ ì „ì²˜ë¦¬
    df_30[TARGET_COL] = pd.to_numeric(df_30[TARGET_COL], errors='coerce')
    df_30 = df_30.dropna(subset=[TARGET_COL])
    
    if len(df_30) < 30:
        return None, "INSUFFICIENT_VALID_DATA"
    
    # STAT_DT ì²˜ë¦¬
    if 'STAT_DT' in df_30.columns:
        try:
            df_30['STAT_DT'] = pd.to_datetime(df_30['STAT_DT'].astype(str), format='%Y%m%d%H%M')
        except:
            base_time = datetime.now() - timedelta(minutes=29)
            df_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    else:
        base_time = datetime.now() - timedelta(minutes=29)
        df_30['STAT_DT'] = [base_time + timedelta(minutes=i) for i in range(30)]
    
    current_time = df_30['STAT_DT'].iloc[-1]
    prediction_start = current_time + timedelta(minutes=1)
    prediction_end = current_time + timedelta(minutes=10)
    
    # Feature ìƒì„±
    features, seq_target = create_features_realtime(df_30)
    
    # DataFrame ë³€í™˜
    X_pred = pd.DataFrame([features])
    
    # ì˜ˆì¸¡
    prediction = model.predict(X_pred)[0]
    current_value = seq_target[-1]
    
    # ìƒìŠ¹ë¥  ê³„ì‚°
    increase_rate = (prediction - current_value) / current_value * 100
    
    # STATUS ê²°ì •
    if prediction >= 300:
        status = "DANGEROUS"
    elif prediction >= 280:
        status = "WARNING"
    else:
        status = "NORMAL"
    
    # SURGE_RISK ê²°ì •
    risk_score = features.get('surge_risk_score', 0)
    if risk_score >= 5:
        surge_risk = "CRITICAL"
    elif risk_score >= 3:
        surge_risk = "HIGH"
    elif risk_score >= 1:
        surge_risk = "MEDIUM"
    else:
        surge_risk = "LOW"
    
    # 300 ì´ìƒ ë‹¬ì„± í™•ë¥ 
    exceed_300_prob = calculate_exceed_300_probability(prediction, features)
    
    # ìƒìŠ¹ ì›ì¸ ë¶„ì„
    cause_analysis = analyze_surge_cause(features, seq_target)
    
    # ê²°ê³¼ ìƒì„±
    result = {
        "CURRENT_VALUE": round(current_value, 1),
        "PREDICTED_VALUE": int(round(prediction)),  # ì •ìˆ˜ë¡œ ë³€ê²½!
        "INCREASE_RATE": f"{increase_rate:+.1f}%",
        "EXCEED_300_PROBABILITY": exceed_300_prob,
        "STATUS": status,
        "SURGE_RISK": surge_risk,
        "CAUSE_ANALYSIS": cause_analysis,
        "MOMENTUM_SIGNAL": {
            "acceleration": round(features.get('target_acceleration', 0), 2),
            "is_rising": bool(features.get('target_is_rising', 0)),
            "rapid_rise": bool(features.get('target_rapid_rise', 0)),
            "surge_imminent": bool(features.get('surge_imminent', 0))
        },
        "KEY_FACTORS": {
            "HUBROOMTOTAL": int(features.get('HUBROOMTOTAL_last_value', 0)),
            "FS_STORAGE_UTIL": round(features.get('CD_M163FSTORAGEUTIL_last_value', 0), 1),
            "TOTAL_CMD": int(features.get('total_cmd', 0)),
            "STORAGE_UTIL": int(features.get('M16A_3F_STORAGE_UTIL_last_value', 0))
        },
        "PREDICTION_TIME": f"{prediction_start.strftime('%Y-%m-%d %H:%M:%S')}~{prediction_end.strftime('%Y-%m-%d %H:%M:%S')}",
        "MODEL_VERSION": "V6_MOMENTUM_W5X_T280"
    }
    
    return result, None

def generate_html_dashboard(result):
    """
    ì˜ˆì¸¡ ê²°ê³¼ë¥¼ HTML ëŒ€ì‹œë³´ë“œë¡œ ìƒì„±
    """
    # í™•ë¥ ì—ì„œ % ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
    prob_value = int(result['EXCEED_300_PROBABILITY'].replace('%', ''))
    
    # ìƒìŠ¹ë¥ ì—ì„œ % ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
    increase_rate_text = result['INCREASE_RATE']
    
    # ì›ì¸ ë¶„ì„ì„ í•­ëª©ë³„ë¡œ ë¶„ë¦¬
    causes = result['CAUSE_ANALYSIS'].split(' + ')
    cause_items_html = ""
    for cause in causes:
        if any(word in cause for word in ['ì‹¬ê°', 'ë§¤ìš°ë†’ì€', 'ê¸‰ì¦ì„ë°•']):
            icon_class = "cause-icon-critical"
            icon = "ğŸ”´"
        else:
            icon_class = "cause-icon-warning"
            icon = "âš ï¸"
        
        cause_items_html += f"""
                <div class="cause-item">
                    <div class="cause-icon {icon_class}">{icon}</div>
                    <div class="cause-text">{cause}</div>
                </div>
        """
    
    # STATUSì— ë”°ë¥¸ í´ë˜ìŠ¤ ê²°ì •
    status_class = f"status-{result['STATUS'].lower()}"
    
    # SURGE_RISKì— ë”°ë¥¸ í´ë˜ìŠ¤ ê²°ì •
    risk_class = f"risk-{result['SURGE_RISK'].lower()}"
    
    # í™•ë¥ ì— ë”°ë¥¸ ì¡°ì¹˜ ìƒí™©
    if prob_value >= 80:
        action_level = "âš ï¸ ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”"
        action_desc = "ë§¤ìš° ë†’ì€ í™•ë¥ ë¡œ 300 ì´ˆê³¼ ì˜ˆìƒ"
        action_class = "action-needed"
    elif prob_value >= 60:
        action_level = "âš¡ ì‚¬ì „ ì¤€ë¹„ í•„ìš”"
        action_desc = "ë†’ì€ í™•ë¥ ë¡œ ë°œìƒ ê°€ëŠ¥"
        action_class = "action-needed"
    else:
        action_level = "ğŸ“Š ëª¨ë‹ˆí„°ë§ ê°•í™”"
        action_desc = "ì£¼ì˜ ê´€ì°° í•„ìš”"
        action_class = "action-needed"
    
    # Momentum ì²´í¬ í‘œì‹œ
    momentum_checks = {
        'acceleration': 'âœ…' if result['MOMENTUM_SIGNAL']['acceleration'] > 0.5 else 'âŒ',
        'is_rising': 'âœ…' if result['MOMENTUM_SIGNAL']['is_rising'] else 'âŒ',
        'rapid_rise': 'âœ…' if result['MOMENTUM_SIGNAL']['rapid_rise'] else 'âŒ',
        'surge_imminent': 'âœ…' if result['MOMENTUM_SIGNAL']['surge_imminent'] else 'âŒ'
    }
    
    # KEY_FACTORS ìƒ‰ìƒ ê²°ì •
    hub_class = "factor-critical" if result['KEY_FACTORS']['HUBROOMTOTAL'] < 610 else ""
    fs_class = "factor-warning" if result['KEY_FACTORS']['FS_STORAGE_UTIL'] >= 7 else ""
    storage_class = "factor-warning" if result['KEY_FACTORS']['STORAGE_UTIL'] >= 205 else ""
    
    # ì˜ˆì¸¡ ì‹œê°„ ë²”ìœ„ ë¶„ë¦¬
    time_parts = result['PREDICTION_TIME'].split('~')
    pred_start = time_parts[0] if len(time_parts) > 0 else ""
    pred_end = time_parts[1] if len(time_parts) > 1 else ""
    
    # í˜„ì¬ ì‹œê°„ (ì˜ˆì¸¡ ì‹œì‘ ì‹œê°„ - 1ë¶„)
    current_time_str = pred_start.split(' ')[1] if ' ' in pred_start else "00:00:00"
    
    html_content = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V6 ì‹¤ì‹œê°„ ê¸‰ì¦ ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }}
        
        .container {{
            max-width: 1400px;
            margin: 0 auto;
        }}
        
        .header {{
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .header h1 {{
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
        }}
        
        .header .subtitle {{
            color: #718096;
            font-size: 16px;
        }}
        
        .model-info {{
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }}
        
        .timestamp {{
            float: right;
            color: #a0aec0;
            font-size: 14px;
        }}
        
        .main-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }}
        
        .card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .card-title {{
            font-size: 14px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            font-weight: 600;
        }}
        
        .big-number {{
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }}
        
        .current-value {{
            color: #4299e1;
        }}
        
        .predicted-value {{
            color: #f56565;
        }}
        
        .increase-rate {{
            color: #ed8936;
        }}
        
        .sub-info {{
            font-size: 14px;
            color: #a0aec0;
            margin-top: 5px;
        }}
        
        .status-badge {{
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            margin-top: 10px;
        }}
        
        .status-normal {{
            background: #c6f6d5;
            color: #2f855a;
        }}
        
        .status-warning {{
            background: #feebc8;
            color: #c05621;
        }}
        
        .status-dangerous {{
            background: #fed7d7;
            color: #c53030;
        }}
        
        .probability-section {{
            text-align: center;
        }}
        
        .probability-circle {{
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(#f56565 0% {prob_value}%, #e2e8f0 {prob_value}% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.3);
        }}
        
        .probability-inner {{
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }}
        
        .probability-number {{
            font-size: 48px;
            font-weight: 700;
            color: #f56565;
        }}
        
        .probability-label {{
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }}
        
        .action-needed {{
            background: #fed7d7;
            border-left: 4px solid #f56565;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }}
        
        .action-needed-title {{
            font-weight: 700;
            color: #c53030;
            margin-bottom: 5px;
        }}
        
        .action-needed-text {{
            color: #742a2a;
            font-size: 14px;
        }}
        
        .risk-indicator {{
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }}
        
        .risk-badge {{
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 18px;
        }}
        
        .risk-low {{
            background: #c6f6d5;
            color: #2f855a;
        }}
        
        .risk-medium {{
            background: #feebc8;
            color: #c05621;
        }}
        
        .risk-high {{
            background: #ffd4b3;
            color: #dd6b20;
        }}
        
        .risk-critical {{
            background: #fed7d7;
            color: #c53030;
        }}
        
        .cause-analysis {{
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }}
        
        .cause-item {{
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }}
        
        .cause-icon {{
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }}
        
        .cause-icon-critical {{
            background: #fed7d7;
        }}
        
        .cause-icon-warning {{
            background: #feebc8;
        }}
        
        .cause-text {{
            font-size: 15px;
            color: #2d3748;
            font-weight: 500;
        }}
        
        .momentum-grid {{
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }}
        
        .momentum-item {{
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }}
        
        .momentum-label {{
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }}
        
        .momentum-value {{
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }}
        
        .momentum-active {{
            color: #f56565;
        }}
        
        .factors-grid {{
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }}
        
        .factor-item {{
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
        }}
        
        .factor-label {{
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }}
        
        .factor-value {{
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }}
        
        .factor-critical {{
            color: #f56565;
        }}
        
        .factor-warning {{
            color: #ed8936;
        }}
        
        .prediction-range {{
            background: #fef5e7;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }}
        
        .prediction-range-title {{
            font-size: 12px;
            color: #d68910;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }}
        
        .prediction-range-time {{
            font-size: 16px;
            font-weight: 700;
            color: #c77b00;
        }}
        
        .alert-box {{
            background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 30px rgba(245, 101, 101, 0.3);
            margin-bottom: 20px;
        }}
        
        .alert-title {{
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }}
        
        .alert-message {{
            font-size: 16px;
            line-height: 1.6;
        }}
        
        .footer {{
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
        }}
        
        @keyframes pulse {{
            0%, 100% {{ opacity: 1; }}
            50% {{ opacity: 0.5; }}
        }}
        
        .alert-icon {{
            animation: pulse 2s infinite;
        }}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="timestamp">ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</div>
            <h1>ğŸš¨ V6 ì‹¤ì‹œê°„ ê¸‰ì¦ ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="subtitle">30ë¶„ ì‹œí€€ìŠ¤ â†’ 10ë¶„ í›„ ì˜ˆì¸¡ | Momentum Feature ê¸°ë°˜ ë¶„ì„</p>
            <span class="model-info">{result['MODEL_VERSION']}</span>
        </div>

        <!-- Alert Box (DANGEROUSì¼ ë•Œë§Œ) -->
        {f'''<div class="alert-box">
            <div class="alert-title">
                <span class="alert-icon">ğŸš¨</span> ê¸´ê¸‰ ì•Œë¦¼: ê¸‰ì¦ ìœ„í—˜ ê°ì§€
            </div>
            <div class="alert-message">
                í˜„ì¬ ì‹œìŠ¤í…œì—ì„œ ê¸‰ê²©í•œ ìƒìŠ¹ ì¶”ì„¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ 10ë¶„ ë‚´ì— 300ì„ ì´ˆê³¼í•  í™•ë¥ ì´ <strong>{result['EXCEED_300_PROBABILITY']}</strong>ì…ë‹ˆë‹¤. {action_level.split()[1] if len(action_level.split()) > 1 else 'ì£¼ì˜ê°€'} í•„ìš”í•©ë‹ˆë‹¤.
            </div>
        </div>''' if result['STATUS'] == 'DANGEROUS' else ''}

        <!-- Main Metrics Grid -->
        <div class="main-grid">
            <!-- Current Value -->
            <div class="card">
                <div class="card-title">í˜„ì¬ê°’</div>
                <div class="big-number current-value">{result['CURRENT_VALUE']}</div>
                <div class="sub-info">30ë¶„ ì‹œí€€ìŠ¤ì˜ ë§ˆì§€ë§‰ ê°’</div>
                <div class="sub-info">í˜„ì¬ ì‹œê°„: {current_time_str}</div>
            </div>

            <!-- Predicted Value -->
            <div class="card">
                <div class="card-title">ì˜ˆì¸¡ê°’ (10ë¶„ í›„)</div>
                <div class="big-number predicted-value">{result['PREDICTED_VALUE']}</div>
                <div class="sub-info">ì˜ˆì¸¡ êµ¬ê°„ ìµœëŒ€ê°’</div>
                <span class="status-badge {status_class}">{result['STATUS']}</span>
            </div>

            <!-- Increase Rate -->
            <div class="card">
                <div class="card-title">ìƒìŠ¹ë¥ </div>
                <div class="big-number increase-rate">{increase_rate_text}</div>
                <div class="sub-info">({result['PREDICTED_VALUE']} - {result['CURRENT_VALUE']}) / {result['CURRENT_VALUE']}</div>
                <div class="risk-indicator">
                    <span class="risk-badge {risk_class}">{result['SURGE_RISK']}</span>
                </div>
            </div>

            <!-- 300 Exceed Probability -->
            <div class="card probability-section">
                <div class="card-title">300 ë‹¬ì„± í™•ë¥ </div>
                <div class="probability-circle">
                    <div class="probability-inner">
                        <div class="probability-number">{result['EXCEED_300_PROBABILITY']}</div>
                        <div class="probability-label">ì˜ˆì¸¡ êµ¬ê°„ ë‚´</div>
                    </div>
                </div>
                <div class="{action_class}">
                    <div class="action-needed-title">{action_level}</div>
                    <div class="action-needed-text">{action_desc}</div>
                </div>
            </div>
        </div>

        <!-- Prediction Range -->
        <div class="card">
            <div class="prediction-range">
                <div class="prediction-range-title">ğŸ¯ ì˜ˆì¸¡ ë²”ìœ„</div>
                <div class="prediction-range-time">{result['PREDICTION_TIME']}</div>
            </div>
        </div>

        <!-- Cause Analysis -->
        <div class="card">
            <div class="card-title">ğŸ” ìƒìŠ¹ ì›ì¸ ë¶„ì„</div>
            <div class="cause-analysis">
                {cause_items_html}
            </div>
        </div>

        <!-- Momentum & Key Factors Grid -->
        <div class="main-grid">
            <!-- Momentum Signals -->
            <div class="card">
                <div class="card-title">ğŸ¯ Momentum ì‹ í˜¸</div>
                <div class="momentum-grid">
                    <div class="momentum-item">
                        <div class="momentum-label">ê°€ì†ë„</div>
                        <div class="momentum-value {'momentum-active' if result['MOMENTUM_SIGNAL']['acceleration'] > 0.5 else ''}">{result['MOMENTUM_SIGNAL']['acceleration']}</div>
                    </div>
                    <div class="momentum-item">
                        <div class="momentum-label">ìƒìŠ¹ ì¤‘</div>
                        <div class="momentum-value {'momentum-active' if result['MOMENTUM_SIGNAL']['is_rising'] else ''}">{momentum_checks['is_rising']}</div>
                    </div>
                    <div class="momentum-item">
                        <div class="momentum-label">ê¸‰ë“± ì—¬ë¶€</div>
                        <div class="momentum-value {'momentum-active' if result['MOMENTUM_SIGNAL']['rapid_rise'] else ''}">{momentum_checks['rapid_rise']}</div>
                    </div>
                    <div class="momentum-item">
                        <div class="momentum-label">ê¸‰ì¦ ì„ë°•</div>
                        <div class="momentum-value {'momentum-active' if result['MOMENTUM_SIGNAL']['surge_imminent'] else ''}">{momentum_checks['surge_imminent']}</div>
                    </div>
                </div>
            </div>

            <!-- Key Factors -->
            <div class="card">
                <div class="card-title">ğŸ“Š ì£¼ìš” ì§€í‘œ</div>
                <div class="factors-grid">
                    <div class="factor-item">
                        <div class="factor-label">HUBROOMTOTAL</div>
                        <div class="factor-value {hub_class}">{result['KEY_FACTORS']['HUBROOMTOTAL']}</div>
                    </div>
                    <div class="factor-item">
                        <div class="factor-label">FS STORAGE UTIL</div>
                        <div class="factor-value {fs_class}">{result['KEY_FACTORS']['FS_STORAGE_UTIL']}</div>
                    </div>
                    <div class="factor-item">
                        <div class="factor-label">TOTAL CMD</div>
                        <div class="factor-value">{result['KEY_FACTORS']['TOTAL_CMD']}</div>
                    </div>
                    <div class="factor-item">
                        <div class="factor-label">STORAGE UTIL</div>
                        <div class="factor-value {storage_class}">{result['KEY_FACTORS']['STORAGE_UTIL']}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>ğŸ¤– V6 Momentum Model | Powered by XGBoost + Momentum Features</p>
            <p>30ë¶„ ì‹œí€€ìŠ¤ ê¸°ë°˜ 10ë¶„ í›„ ì˜ˆì¸¡ ì‹œìŠ¤í…œ</p>
        </div>
    </div>
</body>
</html>"""
    
    return html_content

def predict_realtime():
    """
    ì‹¤ì‹œê°„ ì˜ˆì¸¡ ì‹¤í–‰ ë° ì¶œë ¥ + HTML ëŒ€ì‹œë³´ë“œ ìë™ ìƒì„±
    """
    result, error = realtime_prediction()
    
    if error:
        print([{"ERROR": error}])
    else:
        # 1. ì½˜ì†” ì¶œë ¥
        print([result])
        
        # 2. HTML ëŒ€ì‹œë³´ë“œ ìë™ ìƒì„±
        try:
            html_content = generate_html_dashboard(result)
            
            # íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•œ íŒŒì¼ëª…
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            html_filename = f'V6_ì‹¤ì‹œê°„ì˜ˆì¸¡_ëŒ€ì‹œë³´ë“œ_{timestamp}.html'
            
            # HTML íŒŒì¼ ì €ì¥
            html_path = os.path.join(script_dir, html_filename)
            with open(html_path, 'w', encoding='utf-8') as f:
                f.write(html_content)
            
            print(f"\nâœ… HTML ëŒ€ì‹œë³´ë“œ ìƒì„± ì™„ë£Œ: {html_filename}")
            print(f"ğŸ“‚ íŒŒì¼ ìœ„ì¹˜: {html_path}")
            
            # ğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ ìë™ìœ¼ë¡œ ì—´ê¸°!
            try:
                webbrowser.open('file://' + os.path.abspath(html_path))
                print(f"ğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ ëŒ€ì‹œë³´ë“œë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as browser_error:
                print(f"âš ï¸ ë¸Œë¼ìš°ì € ìë™ ì—´ê¸° ì‹¤íŒ¨: {str(browser_error)}")
                print(f"ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”: {html_path}")
            
        except Exception as e:
            print(f"\nâš ï¸ HTML ìƒì„± ì‹¤íŒ¨: {str(e)}")

if __name__ == '__main__':
    predict_realtime()