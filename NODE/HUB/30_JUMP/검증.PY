#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
ğŸ“Š ëª¨ë“  ì»¬ëŸ¼ í™œìš© ì í”„ ì‹ í˜¸ ì¢…í•© ë¶„ì„
================================================================================
"""

import numpy as np
import pandas as pd
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

def analyze_all_columns_for_jump_signals(filepath='evaluation_results.csv'):
    """ëª¨ë“  ì»¬ëŸ¼ì„ í™œìš©í•œ ì í”„ ì‹ í˜¸ ë¶„ì„"""
    
    print("="*80)
    print("ğŸ” ì „ì²´ ì»¬ëŸ¼ ê¸°ë°˜ ì í”„ ì‹ í˜¸ ë¶„ì„")
    print("="*80)
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_csv(filepath)
    
    # íƒ€ê²Ÿ ì»¬ëŸ¼
    target_col = 'CURRENT_M16A_3F_JOB_2'
    
    # ì‹œê°„ ì²˜ë¦¬
    df['datetime'] = pd.to_datetime(df['STAT_DT'].astype(str), format='%Y%m%d%H%M')
    
    # ëª¨ë“  ì»¬ëŸ¼ ì¶œë ¥
    print("\nğŸ“‹ ì „ì²´ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸")
    print("-" * 60)
    for i, col in enumerate(df.columns, 1):
        if col not in ['STAT_DT', 'datetime']:
            print(f"  {i:2d}. {col}")
    
    # ì£¼ìš” ì»¬ëŸ¼ ê·¸ë£¹ ì •ì˜
    inflow_cols = [
        'M16A_6F_TO_HUB_JOB',
        'M16A_2F_TO_HUB_JOB2', 
        'M14A_3F_TO_HUB_JOB2',
        'M14B_7F_TO_HUB_JOB2',
        'M16B_10F_TO_HUB_JOB'
    ]
    
    outflow_cols = [
        'M16A_3F_TO_M16A_6F_JOB',
        'M16A_3F_TO_M16A_2F_JOB',
        'M16A_3F_TO_M14A_3F_JOB',
        'M16A_3F_TO_M14B_7F_JOB',
        'M16A_3F_TO_3F_MLUD_JOB'
    ]
    
    cmd_cols = [
        'M16A_3F_CMD',
        'M16A_6F_TO_HUB_CMD',
        'M16A_2F_TO_HUB_CMD',
        'M14A_3F_TO_HUB_CMD',
        'M14B_7F_TO_HUB_CMD'
    ]
    
    maxcapa_cols = [
        'M16A_6F_LFT_MAXCAPA',
        'M16A_2F_LFT_MAXCAPA',
        'M14A_3F_CNV_MAXCAPA',
        'M14B_7F_LFT_MAXCAPA',
        'M16A_3F_LFT_MAXCAPA',
        'M16A_3F_CNV_MAXCAPA'
    ]
    
    special_cols = [
        'M16A_3F_STORAGE_UTIL',
        'M14_TO_M16_OFS_CUR',
        'M16_TO_M14_OFS_CUR'
    ]
    
    # ========================================
    # 1. ì í”„ ì¼€ì´ìŠ¤ ì°¾ê¸°
    # ========================================
    print(f"\nğŸš€ ì í”„ ì¼€ì´ìŠ¤ íƒìƒ‰ (30ë¶„ ì‹œí€€ìŠ¤)")
    print("-" * 60)
    
    seq_len = 30
    jump_cases = []
    
    for i in range(seq_len, len(df) - 10):
        # ê³¼ê±° 30ë¶„ ë°ì´í„°
        past_30_target = df[target_col].iloc[i-seq_len:i].values
        
        # 10ë¶„ í›„ ê°’
        if i + 10 >= len(df):
            continue
        future_val = df[target_col].iloc[i+10]
        
        # ì í”„ ì¡°ê±´
        past_max = max(past_30_target)
        if past_max < 280 and future_val >= 300:
            
            # ëª¨ë“  ì»¬ëŸ¼ì˜ 30ë¶„ ë°ì´í„° ìˆ˜ì§‘
            jump_data = {
                'index': i,
                'time': df['datetime'].iloc[i],
                'past_max': past_max,
                'past_mean': np.mean(past_30_target),
                'future_value': future_val,
                'jump_amount': future_val - past_max
            }
            
            # ê° ì»¬ëŸ¼ ê·¸ë£¹ë³„ í†µê³„
            for col_group, col_list in [
                ('inflow', inflow_cols),
                ('outflow', outflow_cols),
                ('cmd', cmd_cols)
            ]:
                # ê·¸ë£¹ ë‚´ ì»¬ëŸ¼ë“¤ì˜ í•©ê³„
                group_sum = 0
                group_mean = 0
                for col in col_list:
                    if col in df.columns:
                        past_values = df[col].iloc[i-seq_len:i].values
                        # ìˆ«ìí˜• ë°ì´í„°ë§Œ ì²˜ë¦¬
                        try:
                            numeric_values = pd.to_numeric(past_values, errors='coerce')
                            numeric_values = numeric_values[~np.isnan(numeric_values)]
                            if len(numeric_values) > 0:
                                group_sum += np.sum(numeric_values[-5:])  # ë§ˆì§€ë§‰ 5ë¶„ í•©
                                group_mean += np.mean(numeric_values)
                        except:
                            pass
                
                jump_data[f'{col_group}_last5_sum'] = group_sum
                jump_data[f'{col_group}_mean'] = group_mean
            
            # íŠ¹ìˆ˜ ì»¬ëŸ¼ë“¤
            for col in special_cols:
                if col in df.columns:
                    try:
                        past_values = pd.to_numeric(df[col].iloc[i-seq_len:i], errors='coerce')
                        past_values = past_values[~np.isnan(past_values)]
                        if len(past_values) > 0:
                            jump_data[f'{col}_mean'] = np.mean(past_values)
                            jump_data[f'{col}_max'] = np.max(past_values)
                    except:
                        jump_data[f'{col}_mean'] = 0
                        jump_data[f'{col}_max'] = 0
            
            jump_cases.append(jump_data)
    
    print(f"  ë°œê²¬ëœ ì í”„ ì¼€ì´ìŠ¤: {len(jump_cases)}ê°œ")
    
    if not jump_cases:
        print("  âš ï¸ ì í”„ ì¼€ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None, df
    
    # ========================================
    # 2. ì»¬ëŸ¼ë³„ ìƒê´€ê´€ê³„ ë¶„ì„
    # ========================================
    print(f"\nğŸ“Š ì í”„ì™€ ê° ì»¬ëŸ¼ì˜ ê´€ê³„")
    print("-" * 60)
    
    # DataFrame ë³€í™˜
    jump_df = pd.DataFrame(jump_cases)
    
    # ìœ ì…/ìœ ì¶œ ë¶„ì„
    if 'inflow_last5_sum' in jump_df.columns and 'outflow_last5_sum' in jump_df.columns:
        print("\n  [ìœ ì…/ìœ ì¶œ íŒ¨í„´]")
        print(f"    í‰ê·  ìœ ì…(ë§ˆì§€ë§‰5ë¶„): {jump_df['inflow_last5_sum'].mean():.1f}")
        print(f"    í‰ê·  ìœ ì¶œ(ë§ˆì§€ë§‰5ë¶„): {jump_df['outflow_last5_sum'].mean():.1f}")
        
        # ìœ ì… > ìœ ì¶œì¸ ì¼€ì´ìŠ¤
        inflow_dominant = (jump_df['inflow_last5_sum'] > jump_df['outflow_last5_sum']).sum()
        print(f"    ìœ ì… > ìœ ì¶œ: {inflow_dominant}/{len(jump_df)} ({inflow_dominant/len(jump_df)*100:.1f}%)")
    
    # CMD ë¶„ì„
    if 'cmd_mean' in jump_df.columns:
        print(f"\n  [CMD íŒ¨í„´]")
        print(f"    í‰ê·  CMD: {jump_df['cmd_mean'].mean():.1f}")
    
    # STORAGE_UTIL ë¶„ì„
    if 'M16A_3F_STORAGE_UTIL_mean' in jump_df.columns:
        print(f"\n  [STORAGE_UTIL íŒ¨í„´]")
        print(f"    í‰ê· : {jump_df['M16A_3F_STORAGE_UTIL_mean'].mean():.1f}")
        print(f"    ìµœëŒ€: {jump_df['M16A_3F_STORAGE_UTIL_max'].mean():.1f}")
    
    # ========================================
    # 3. ì í”„ ì „ íŠ¹ì§•ì  íŒ¨í„´
    # ========================================
    print(f"\nğŸ¯ ì í”„ ì „ íŠ¹ì§•ì  ì‹ í˜¸")
    print("-" * 60)
    
    # ê° ì í”„ ì¼€ì´ìŠ¤ì˜ íŠ¹ì§• ì ìˆ˜ ê³„ì‚°
    for idx, jump in enumerate(jump_cases):
        signals = []
        
        # ì‹ í˜¸ 1: ê³¼ê±° MAXê°€ ë†’ìŒ
        if jump['past_max'] >= 270:
            signals.append("MAX>=270")
        
        # ì‹ í˜¸ 2: ìœ ì… > ìœ ì¶œ
        if 'inflow_last5_sum' in jump and 'outflow_last5_sum' in jump:
            if jump['inflow_last5_sum'] > jump['outflow_last5_sum']:
                signals.append("ìœ ì…ìš°ì„¸")
        
        # ì‹ í˜¸ 3: STORAGE_UTIL ë†’ìŒ
        if 'M16A_3F_STORAGE_UTIL_max' in jump:
            if jump['M16A_3F_STORAGE_UTIL_max'] > 50:
                signals.append("STORAGE>50")
        
        jump_cases[idx]['signals'] = signals
        jump_cases[idx]['signal_count'] = len(signals)
    
    # ì‹ í˜¸ ê°œìˆ˜ë³„ í†µê³„
    signal_counts = [j['signal_count'] for j in jump_cases]
    print(f"  í‰ê·  ì‹ í˜¸ ê°œìˆ˜: {np.mean(signal_counts):.1f}")
    print(f"  ì‹ í˜¸ 2ê°œ ì´ìƒ: {sum(1 for s in signal_counts if s >= 2)}/{len(jump_cases)}")
    
    # ========================================
    # 4. ìƒìœ„ ì í”„ ì¼€ì´ìŠ¤ ìƒì„¸
    # ========================================
    print(f"\nğŸ”¥ ëŒ€í‘œ ì í”„ ì¼€ì´ìŠ¤ (ìƒìœ„ 5ê°œ)")
    print("-" * 60)
    
    sorted_jumps = sorted(jump_cases, key=lambda x: x['jump_amount'], reverse=True)[:5]
    
    for idx, jump in enumerate(sorted_jumps, 1):
        print(f"\n  [{idx}] {jump['time'].strftime('%m/%d %H:%M')}")
        print(f"      ê³¼ê±°: MAX={jump['past_max']:.0f}, MEAN={jump['past_mean']:.0f}")
        print(f"      ë¯¸ë˜: {jump['future_value']:.0f} (+{jump['jump_amount']:.0f})")
        
        if 'inflow_last5_sum' in jump:
            print(f"      ìœ ì…/ìœ ì¶œ: {jump['inflow_last5_sum']:.0f}/{jump.get('outflow_last5_sum', 0):.0f}")
        
        if jump.get('signals'):
            print(f"      ì‹ í˜¸: {', '.join(jump['signals'])}")
    
    # ========================================
    # 5. ì»¬ëŸ¼ ì¤‘ìš”ë„ ìˆœìœ„
    # ========================================
    print(f"\nğŸ“ˆ ì í”„ ì˜ˆì¸¡ì— ì¤‘ìš”í•œ ì»¬ëŸ¼")
    print("-" * 60)
    
    # ê° ì»¬ëŸ¼ê³¼ ì í”„ëŸ‰ì˜ ìƒê´€ê´€ê³„
    correlations = {}
    
    numeric_cols = df.select_dtypes(include=[np.number]).columns
    for col in numeric_cols:
        if col != target_col and col != 'STAT_DT':
            try:
                # ì í”„ ì‹œì ì˜ ì»¬ëŸ¼ ê°’ë“¤
                jump_col_values = []
                for jump in jump_cases:
                    idx = jump['index']
                    if idx < len(df):
                        val = df[col].iloc[idx]
                        if pd.notna(val):
                            jump_col_values.append(float(val))
                
                if len(jump_col_values) >= 5:
                    # ì í”„ëŸ‰ê³¼ì˜ ìƒê´€ê´€ê³„
                    jump_amounts = [j['jump_amount'] for j in jump_cases[:len(jump_col_values)]]
                    corr, _ = stats.pearsonr(jump_col_values, jump_amounts)
                    if not np.isnan(corr):
                        correlations[col] = abs(corr)
            except:
                pass
    
    # ìƒìœ„ 10ê°œ ì»¬ëŸ¼
    if correlations:
        sorted_corr = sorted(correlations.items(), key=lambda x: x[1], reverse=True)[:10]
        print("\n  ìƒê´€ê´€ê³„ TOP 10:")
        for col, corr in sorted_corr:
            print(f"    {col:30s}: {corr:.3f}")
    
    # ========================================
    # 6. ì‹¤ì‹œê°„ ê°ì§€ ê·œì¹™ ì œì•ˆ
    # ========================================
    print(f"\nğŸ’¡ ì í”„ ê°ì§€ ê·œì¹™ ì œì•ˆ")
    print("-" * 60)
    
    print("\n  IF (ë‹¤ìŒ ì¡°ê±´ ì¤‘ 2ê°œ ì´ìƒ):")
    print("    1. past_max >= 265 AND gap > 20")
    print("    2. ë§ˆì§€ë§‰ 5ë¶„ ìœ ì… > ìœ ì¶œ")
    print("    3. STORAGE_UTIL > 50")
    print("    4. ë§ˆì§€ë§‰ 5ë¶„ ìƒìŠ¹ ì¶”ì„¸")
    print("  THEN:")
    print("    â†’ ì í”„ ê°€ëŠ¥ì„± HIGH")
    print("    â†’ ì˜ˆì¸¡ = mean Ã— 1.15~1.25")
    
    return jump_cases, df

# ì‹¤í–‰
if __name__ == "__main__":
    jump_cases, df = analyze_all_columns_for_jump_signals('evaluation_results.csv')
    
    print("\n" + "="*80)
    print("âœ… ì „ì²´ ì»¬ëŸ¼ ë¶„ì„ ì™„ë£Œ!")
    print("="*80)
    
    if jump_cases:
        # ê²°ê³¼ ì €ì¥
        jump_df = pd.DataFrame(jump_cases)
        jump_df.to_csv('jump_analysis_all_columns.csv', index=False)
        print(f"\nğŸ’¾ ë¶„ì„ ê²°ê³¼ ì €ì¥: jump_analysis_all_columns.csv")