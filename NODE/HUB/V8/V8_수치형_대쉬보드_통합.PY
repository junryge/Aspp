# -*- coding: utf-8 -*-
"""
V8 ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ - ìˆ˜ì¹˜í˜• ì „ìš©
10ë¶„, 15ë¶„, 25ë¶„ ìˆ˜ì¹˜í˜• ì˜ˆì¸¡ì„ ì‹œê°í™”
"""

import subprocess
import json
import os
from datetime import datetime
import webbrowser

script_dir = os.path.dirname(os.path.abspath(__file__))

def get_numerical_predictions():
    """ìˆ˜ì¹˜í˜• í†µí•© ì˜ˆì¸¡ ì‹¤í–‰"""
    try:
        result = subprocess.run(
            ['python', os.path.join(script_dir, 'V8_Numerical_Real_time_DO.py')],
            capture_output=True,
            text=True,
            timeout=30
        )
        data = json.loads(result.stdout)
        return data
    except Exception as e:
        print(f"âŒ ìˆ˜ì¹˜í˜• ì˜ˆì¸¡ ì‹¤íŒ¨: {e}")
        return []

def generate_html_dashboard(data):
    """ìˆ˜ì¹˜í˜• HTML ëŒ€ì‹œë³´ë“œ ìƒì„±"""
    
    if not data or len(data) == 0:
        return "<html><body><h1>ë°ì´í„° ì—†ìŒ</h1></body></html>"
    
    # ë°ì´í„° ì¶”ì¶œ
    current_time = data[0].get('CURRENT_TIME', '')
    current_value = data[0].get('CURRENT_VALUE', 0)
    
    pred_10 = data[0] if len(data) > 0 else {}
    pred_15 = data[1] if len(data) > 1 else {}
    pred_25 = data[2] if len(data) > 2 else {}
    
    # ìµœëŒ€ê°’ ì°¾ê¸°
    max_value = max(
        pred_10.get('PREDICT_MAX', 0),
        pred_15.get('PREDICT_MAX', 0),
        pred_25.get('PREDICT_MAX', 0)
    )
    
    # ì¶”ì„¸ íŒë‹¨
    if pred_10.get('PREDICT_MAX', 0) < pred_15.get('PREDICT_MAX', 0) < pred_25.get('PREDICT_MAX', 0):
        trend = "ğŸ“ˆ ì§€ì† ìƒìŠ¹ ì¶”ì„¸"
        trend_color = "#e53e3e"
        trend_alert = "ìœ„í—˜ë„ê°€ ì‹œê°„ì— ë”°ë¼ ì¦ê°€í•©ë‹ˆë‹¤"
    elif pred_10.get('PREDICT_MAX', 0) > pred_15.get('PREDICT_MAX', 0) > pred_25.get('PREDICT_MAX', 0):
        trend = "ğŸ“‰ ì§€ì† í•˜ë½ ì¶”ì„¸"
        trend_color = "#38a169"
        trend_alert = "ì•ˆì •í™” ì¤‘ì…ë‹ˆë‹¤"
    else:
        trend = "ğŸ“Š ë³€ë™ ì¶”ì„¸"
        trend_color = "#d69e2e"
        trend_alert = "ë³€í™”ê°€ ë¶ˆê·œì¹™í•©ë‹ˆë‹¤"
    
    # ìœ„í—˜ ë ˆë²¨
    if max_value >= 300:
        risk_level = "CRITICAL"
        risk_color = "#c53030"
        risk_icon = "ğŸ”´"
    elif max_value >= 280:
        risk_level = "WARNING"
        risk_color = "#dd6b20"
        risk_icon = "ğŸŸ "
    elif max_value >= 270:
        risk_level = "CAUTION"
        risk_color = "#d69e2e"
        risk_icon = "ğŸŸ¡"
    else:
        risk_level = "NORMAL"
        risk_color = "#38a169"
        risk_icon = "ğŸŸ¢"
    
    html = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V8 ìˆ˜ì¹˜í˜• ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }}
        
        .container {{
            max-width: 1400px;
            margin: 0 auto;
        }}
        
        .header {{
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .header h1 {{
            font-size: 36px;
            color: #2d3748;
            margin-bottom: 10px;
        }}
        
        .header .subtitle {{
            color: #718096;
            font-size: 16px;
        }}
        
        .header-grid {{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }}
        
        .header-item {{
            text-align: center;
        }}
        
        .header-label {{
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }}
        
        .header-value {{
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }}
        
        .current-value {{
            color: #4299e1;
        }}
        
        .max-value {{
            color: {risk_color};
        }}
        
        .summary-card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .risk-banner {{
            background: {risk_color};
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }}
        
        .risk-banner-icon {{
            font-size: 48px;
            margin-bottom: 10px;
        }}
        
        .risk-banner-text {{
            font-size: 24px;
            font-weight: 700;
        }}
        
        .trend-card {{
            background: #f7fafc;
            border-left: 4px solid {trend_color};
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }}
        
        .trend-title {{
            font-size: 20px;
            font-weight: 700;
            color: {trend_color};
            margin-bottom: 10px;
        }}
        
        .trend-desc {{
            font-size: 16px;
            color: #4a5568;
        }}
        
        .predictions-grid {{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }}
        
        .prediction-card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .card-header {{
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }}
        
        .time-badge {{
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }}
        
        .time-range {{
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }}
        
        .metric-section {{
            margin-bottom: 20px;
        }}
        
        .metric-title {{
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }}
        
        .metric-big {{
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }}
        
        .metric-max {{
            color: #e53e3e;
        }}
        
        .metric-avg {{
            color: #ed8936;
        }}
        
        .metric-min {{
            color: #48bb78;
        }}
        
        .metric-row {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
        }}
        
        .metric-label {{
            font-size: 14px;
            color: #4a5568;
        }}
        
        .metric-value {{
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
        }}
        
        .status-badge {{
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 10px;
        }}
        
        .status-normal {{
            background: #c6f6d5;
            color: #2f855a;
        }}
        
        .status-caution {{
            background: #fefcbf;
            color: #b7791f;
        }}
        
        .status-warning {{
            background: #feebc8;
            color: #c05621;
        }}
        
        .status-critical {{
            background: #fed7d7;
            color: #c53030;
        }}
        
        .chart-container {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .chart-title {{
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }}
        
        .timeline {{
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 250px;
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
        }}
        
        .timeline-item {{
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }}
        
        .bar {{
            width: 80%;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }}
        
        .bar:hover {{
            transform: scale(1.05);
        }}
        
        .bar-label {{
            margin-top: 15px;
            font-weight: 700;
            font-size: 16px;
            color: #2d3748;
        }}
        
        .bar-value {{
            margin-top: 5px;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }}
        
        .footer {{
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“Š V8 ìˆ˜ì¹˜í˜• ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="subtitle">MIN/MAX/AVG ë³€í™”ëŸ‰ ì˜ˆì¸¡ | 10ë¶„/15ë¶„/25ë¶„ ì‹œê°„ëŒ€ ë¶„ì„</p>
            <div class="header-grid">
                <div class="header-item">
                    <div class="header-label">í˜„ì¬ê°’</div>
                    <div class="header-value current-value">{current_value}</div>
                </div>
                <div class="header-item">
                    <div class="header-label">ìµœëŒ€ ì˜ˆì¸¡ê°’</div>
                    <div class="header-value max-value">{max_value:.1f}</div>
                </div>
                <div class="header-item">
                    <div class="header-label">ìœ„í—˜ ë ˆë²¨</div>
                    <div class="header-value" style="color: {risk_color};">{risk_icon} {risk_level}</div>
                </div>
            </div>
        </div>

        <!-- Risk Banner -->
        <div class="risk-banner">
            <div class="risk-banner-icon">{risk_icon}</div>
            <div class="risk-banner-text">ìœ„í—˜ ë ˆë²¨: {risk_level}</div>
            <div style="margin-top: 10px; font-size: 16px;">ë°ì´í„° ì‹œê°„: {current_time}</div>
        </div>

        <!-- Trend Card -->
        <div class="summary-card">
            <div class="trend-card">
                <div class="trend-title">{trend}</div>
                <div class="trend-desc">{trend_alert}</div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“ˆ ì‹œê°„ëŒ€ë³„ MAX ê°’ ë³€í™”</div>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="bar" style="height: {pred_10.get('PREDICT_MAX', 0) / max_value * 100 if max_value > 0 else 0}%;"></div>
                    <div class="bar-label">10ë¶„ í›„</div>
                    <div class="bar-value">{pred_10.get('PREDICT_MAX', 0):.1f}</div>
                </div>
                <div class="timeline-item">
                    <div class="bar" style="height: {pred_15.get('PREDICT_MAX', 0) / max_value * 100 if max_value > 0 else 0}%;"></div>
                    <div class="bar-label">15ë¶„ í›„</div>
                    <div class="bar-value">{pred_15.get('PREDICT_MAX', 0):.1f}</div>
                </div>
                <div class="timeline-item">
                    <div class="bar" style="height: {pred_25.get('PREDICT_MAX', 0) / max_value * 100 if max_value > 0 else 0}%;"></div>
                    <div class="bar-label">25ë¶„ í›„</div>
                    <div class="bar-value">{pred_25.get('PREDICT_MAX', 0):.1f}</div>
                </div>
            </div>
        </div>

        <!-- Predictions Grid -->
        <div class="predictions-grid">
            <!-- 10ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 10ë¶„ í›„</div>
                    <div class="time-range">{pred_10.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="metric-section">
                    <div class="metric-title">MAX ì˜ˆì¸¡ê°’</div>
                    <div class="metric-big metric-max">{pred_10.get('PREDICT_MAX', 0):.1f}</div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">MIN</span>
                    <span class="metric-value">{pred_10.get('PREDICT_MIN', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">AVG</span>
                    <span class="metric-value">{pred_10.get('PREDICT_AVG', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ë³€í™”ëŸ‰ (MAX)</span>
                    <span class="metric-value">{pred_10.get('CHANGE_MAX', 0):+.1f}</span>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <span class="status-badge status-{pred_10.get('STATUS', '').lower()}">{pred_10.get('STATUS', '')}</span>
                </div>
                
                {'<div style="margin-top: 15px; padding: 10px; background: #fed7d7; border-radius: 8px; text-align: center; color: #c53030; font-weight: 700;">ğŸš¨ ê¸‰ì¦ ê²½ê³ </div>' if pred_10.get('SURGE_WARNING', 0) == 1 else ''}
            </div>

            <!-- 15ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 15ë¶„ í›„</div>
                    <div class="time-range">{pred_15.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="metric-section">
                    <div class="metric-title">MAX ì˜ˆì¸¡ê°’</div>
                    <div class="metric-big metric-max">{pred_15.get('PREDICT_MAX', 0):.1f}</div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">MIN</span>
                    <span class="metric-value">{pred_15.get('PREDICT_MIN', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">AVG</span>
                    <span class="metric-value">{pred_15.get('PREDICT_AVG', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ë³€í™”ëŸ‰ (MAX)</span>
                    <span class="metric-value">{pred_15.get('CHANGE_MAX', 0):+.1f}</span>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <span class="status-badge status-{pred_15.get('STATUS', '').lower()}">{pred_15.get('STATUS', '')}</span>
                </div>
                
                {'<div style="margin-top: 15px; padding: 10px; background: #fed7d7; border-radius: 8px; text-align: center; color: #c53030; font-weight: 700;">ğŸš¨ ê¸‰ì¦ ê²½ê³ </div>' if pred_15.get('SURGE_WARNING', 0) == 1 else ''}
            </div>

            <!-- 25ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 25ë¶„ í›„</div>
                    <div class="time-range">{pred_25.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="metric-section">
                    <div class="metric-title">MAX ì˜ˆì¸¡ê°’</div>
                    <div class="metric-big metric-max">{pred_25.get('PREDICT_MAX', 0):.1f}</div>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">MIN</span>
                    <span class="metric-value">{pred_25.get('PREDICT_MIN', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">AVG</span>
                    <span class="metric-value">{pred_25.get('PREDICT_AVG', 0):.1f}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ë³€í™”ëŸ‰ (MAX)</span>
                    <span class="metric-value">{pred_25.get('CHANGE_MAX', 0):+.1f}</span>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <span class="status-badge status-{pred_25.get('STATUS', '').lower()}">{pred_25.get('STATUS', '')}</span>
                </div>
                
                {'<div style="margin-top: 15px; padding: 10px; background: #fed7d7; border-radius: 8px; text-align: center; color: #c53030; font-weight: 700;">ğŸš¨ ê¸‰ì¦ ê²½ê³ </div>' if pred_25.get('SURGE_WARNING', 0) == 1 else ''}
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>ğŸ¤– V8 Numerical Prediction System | XGBoost Regression Model</p>
            <p>ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>
    </div>
</body>
</html>"""
    
    return html

def main():
    """ë©”ì¸ ì‹¤í–‰"""
    print("="*60)
    print("V8 ìˆ˜ì¹˜í˜• ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
    print("="*60)
    
    print("\n[1/2] ìˆ˜ì¹˜í˜• ì˜ˆì¸¡ ì‹¤í–‰ ì¤‘...")
    data = get_numerical_predictions()
    
    if not data:
        print("\nâŒ ì˜ˆì¸¡ ì‹¤íŒ¨!")
        return
    
    print("[2/2] HTML ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
    html_content = generate_html_dashboard(data)
    
    # íŒŒì¼ ì €ì¥
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f'V8_ìˆ˜ì¹˜í˜•_ëŒ€ì‹œë³´ë“œ_{timestamp}.html'
    filepath = os.path.join(script_dir, filename)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"\nâœ… ëŒ€ì‹œë³´ë“œ ìƒì„± ì™„ë£Œ!")
    print(f"ğŸ“‚ íŒŒì¼: {filename}")
    print(f"ğŸ“ ìœ„ì¹˜: {filepath}")
    
    # ë¸Œë¼ìš°ì € ì—´ê¸°
    try:
        webbrowser.open('file://' + os.path.abspath(filepath))
        print(f"\nğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ ëŒ€ì‹œë³´ë“œë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤!")
    except Exception as e:
        print(f"\nâš ï¸ ë¸Œë¼ìš°ì € ìë™ ì—´ê¸° ì‹¤íŒ¨: {e}")
        print(f"ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”: {filepath}")

if __name__ == '__main__':
    main()