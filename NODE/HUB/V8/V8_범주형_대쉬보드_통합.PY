# -*- coding: utf-8 -*-
"""
V8 ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ - ë²”ì£¼í˜• ì „ìš©
10ë¶„, 15ë¶„, 25ë¶„ ë²”ì£¼í˜• ì˜ˆì¸¡ì„ ì‹œê°í™”
"""

import subprocess
import json
import os
from datetime import datetime
import webbrowser

script_dir = os.path.dirname(os.path.abspath(__file__))

def get_categorical_predictions():
    """ë²”ì£¼í˜• í†µí•© ì˜ˆì¸¡ ì‹¤í–‰"""
    try:
        result = subprocess.run(
            ['python', os.path.join(script_dir, 'V8_ì‹¤ì‹œê°„_ë²”ì£¼í˜•_í†µí•©.py')],
            capture_output=True,
            text=True,
            timeout=30
        )
        data = json.loads(result.stdout)
        return data
    except Exception as e:
        print(f"âŒ ë²”ì£¼í˜• ì˜ˆì¸¡ ì‹¤íŒ¨: {e}")
        return []

def generate_html_dashboard(data):
    """ë²”ì£¼í˜• HTML ëŒ€ì‹œë³´ë“œ ìƒì„±"""
    
    if not data or len(data) == 0:
        return "<html><body><h1>ë°ì´í„° ì—†ìŒ</h1></body></html>"
    
    # ë°ì´í„° ì¶”ì¶œ
    current_time = data[0].get('CURRENT_TIME', '')
    current_value = data[0].get('CURRENT_VALUE', 0)
    
    pred_10 = data[0] if len(data) > 0 else {}
    pred_15 = data[1] if len(data) > 1 else {}
    pred_25 = data[2] if len(data) > 2 else {}
    
    # ê¸‰ì¦ í™•ë¥  ìµœëŒ€ê°’
    max_surge_prob = max(
        pred_10.get('CLASS_2_PROB', 0),
        pred_15.get('CLASS_2_PROB', 0),
        pred_25.get('CLASS_2_PROB', 0)
    )
    
    # ì¶”ì„¸ íŒë‹¨ (ê¸‰ì¦ í™•ë¥  ê¸°ì¤€)
    surge_10 = pred_10.get('CLASS_2_PROB', 0)
    surge_15 = pred_15.get('CLASS_2_PROB', 0)
    surge_25 = pred_25.get('CLASS_2_PROB', 0)
    
    if surge_10 < surge_15 < surge_25:
        trend = "ğŸ“ˆ ê¸‰ì¦ í™•ë¥  ì¦ê°€ ì¶”ì„¸"
        trend_color = "#e53e3e"
        trend_alert = "ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ê¸‰ì¦ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤"
    elif surge_10 > surge_15 > surge_25:
        trend = "ğŸ“‰ ê¸‰ì¦ í™•ë¥  ê°ì†Œ ì¶”ì„¸"
        trend_color = "#38a169"
        trend_alert = "ê¸‰ì¦ ìœ„í—˜ì´ ì¤„ì–´ë“¤ê³  ìˆìŠµë‹ˆë‹¤"
    else:
        trend = "ğŸ“Š ê¸‰ì¦ í™•ë¥  ë³€ë™ ì¶”ì„¸"
        trend_color = "#d69e2e"
        trend_alert = "ê¸‰ì¦ í™•ë¥ ì´ ë¶ˆê·œì¹™í•˜ê²Œ ë³€í™”í•©ë‹ˆë‹¤"
    
    # ìœ„í—˜ ë ˆë²¨ (ìµœëŒ€ ê¸‰ì¦ í™•ë¥  ê¸°ì¤€)
    if max_surge_prob >= 70:
        risk_level = "CRITICAL"
        risk_color = "#c53030"
        risk_icon = "ğŸ”´"
        risk_desc = "ë§¤ìš° ë†’ì€ ê¸‰ì¦ ìœ„í—˜"
    elif max_surge_prob >= 50:
        risk_level = "HIGH"
        risk_color = "#dd6b20"
        risk_icon = "ğŸŸ "
        risk_desc = "ë†’ì€ ê¸‰ì¦ ìœ„í—˜"
    elif max_surge_prob >= 30:
        risk_level = "MEDIUM"
        risk_color = "#d69e2e"
        risk_icon = "ğŸŸ¡"
        risk_desc = "ì¤‘ê°„ ìˆ˜ì¤€ ê¸‰ì¦ ìœ„í—˜"
    else:
        risk_level = "LOW"
        risk_color = "#38a169"
        risk_icon = "ğŸŸ¢"
        risk_desc = "ë‚®ì€ ê¸‰ì¦ ìœ„í—˜"
    
    html = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V8 ë²”ì£¼í˜• ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            min-height: 100vh;
        }}
        
        .container {{
            max-width: 1400px;
            margin: 0 auto;
        }}
        
        .header {{
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .header h1 {{
            font-size: 36px;
            color: #2d3748;
            margin-bottom: 10px;
        }}
        
        .header .subtitle {{
            color: #718096;
            font-size: 16px;
        }}
        
        .header-grid {{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }}
        
        .header-item {{
            text-align: center;
        }}
        
        .header-label {{
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }}
        
        .header-value {{
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }}
        
        .current-value {{
            color: #4299e1;
        }}
        
        .surge-prob {{
            color: {risk_color};
        }}
        
        .summary-card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .risk-banner {{
            background: {risk_color};
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }}
        
        .risk-banner-icon {{
            font-size: 48px;
            margin-bottom: 10px;
        }}
        
        .risk-banner-text {{
            font-size: 24px;
            font-weight: 700;
        }}
        
        .risk-banner-desc {{
            margin-top: 10px;
            font-size: 16px;
        }}
        
        .trend-card {{
            background: #f7fafc;
            border-left: 4px solid {trend_color};
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }}
        
        .trend-title {{
            font-size: 20px;
            font-weight: 700;
            color: {trend_color};
            margin-bottom: 10px;
        }}
        
        .trend-desc {{
            font-size: 16px;
            color: #4a5568;
        }}
        
        .chart-container {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .chart-title {{
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }}
        
        .probability-bars {{
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 250px;
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
        }}
        
        .prob-bar-item {{
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }}
        
        .prob-bar {{
            width: 80%;
            background: linear-gradient(to top, #f093fb, #f5576c);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }}
        
        .prob-bar:hover {{
            transform: scale(1.05);
        }}
        
        .prob-bar-label {{
            margin-top: 15px;
            font-weight: 700;
            font-size: 16px;
            color: #2d3748;
        }}
        
        .prob-bar-value {{
            margin-top: 5px;
            font-size: 24px;
            font-weight: 700;
            color: #f5576c;
        }}
        
        .predictions-grid {{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }}
        
        .prediction-card {{
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }}
        
        .card-header {{
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }}
        
        .time-badge {{
            font-size: 24px;
            font-weight: 700;
            color: #f5576c;
        }}
        
        .time-range {{
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }}
        
        .result-highlight {{
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }}
        
        .class-section {{
            margin-bottom: 15px;
        }}
        
        .class-label {{
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }}
        
        .class-bar-container {{
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }}
        
        .class-bar-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }}
        
        .class-name {{
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }}
        
        .class-prob {{
            font-size: 18px;
            font-weight: 700;
            color: #f5576c;
        }}
        
        .class-bar {{
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }}
        
        .class-bar-fill {{
            height: 100%;
            background: linear-gradient(to right, #f093fb, #f5576c);
            transition: width 0.5s;
        }}
        
        .status-badge {{
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            margin-top: 15px;
        }}
        
        .status-normal {{
            background: #c6f6d5;
            color: #2f855a;
        }}
        
        .status-caution {{
            background: #fefcbf;
            color: #b7791f;
        }}
        
        .status-warning {{
            background: #feebc8;
            color: #c05621;
        }}
        
        .status-critical {{
            background: #fed7d7;
            color: #c53030;
        }}
        
        .alert-box {{
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            margin-top: 15px;
        }}
        
        .alert-surge {{
            background: #fed7d7;
            color: #c53030;
            border: 2px solid #fc8181;
        }}
        
        .footer {{
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ V8 ë²”ì£¼í˜• ì˜ˆì¸¡ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="subtitle">3-Class Classification | 10ë¶„/15ë¶„/25ë¶„ ì‹œê°„ëŒ€ ë¶„ì„</p>
            <div class="header-grid">
                <div class="header-item">
                    <div class="header-label">í˜„ì¬ê°’</div>
                    <div class="header-value current-value">{current_value}</div>
                </div>
                <div class="header-item">
                    <div class="header-label">ìµœëŒ€ ê¸‰ì¦ í™•ë¥ </div>
                    <div class="header-value surge-prob">{max_surge_prob:.1f}%</div>
                </div>
                <div class="header-item">
                    <div class="header-label">ìœ„í—˜ ë ˆë²¨</div>
                    <div class="header-value" style="color: {risk_color};">{risk_icon} {risk_level}</div>
                </div>
            </div>
        </div>

        <!-- Risk Banner -->
        <div class="risk-banner">
            <div class="risk-banner-icon">{risk_icon}</div>
            <div class="risk-banner-text">{risk_desc}</div>
            <div class="risk-banner-desc">ë°ì´í„° ì‹œê°„: {current_time}</div>
        </div>

        <!-- Trend Card -->
        <div class="summary-card">
            <div class="trend-card">
                <div class="trend-title">{trend}</div>
                <div class="trend-desc">{trend_alert}</div>
            </div>
        </div>

        <!-- Probability Chart -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“Š ì‹œê°„ëŒ€ë³„ ê¸‰ì¦(Class 2) í™•ë¥  ë³€í™”</div>
            <div class="probability-bars">
                <div class="prob-bar-item">
                    <div class="prob-bar" style="height: {surge_10}%;"></div>
                    <div class="prob-bar-label">10ë¶„ í›„</div>
                    <div class="prob-bar-value">{surge_10:.1f}%</div>
                </div>
                <div class="prob-bar-item">
                    <div class="prob-bar" style="height: {surge_15}%;"></div>
                    <div class="prob-bar-label">15ë¶„ í›„</div>
                    <div class="prob-bar-value">{surge_15:.1f}%</div>
                </div>
                <div class="prob-bar-item">
                    <div class="prob-bar" style="height: {surge_25}%;"></div>
                    <div class="prob-bar-label">25ë¶„ í›„</div>
                    <div class="prob-bar-value">{surge_25:.1f}%</div>
                </div>
            </div>
        </div>

        <!-- Predictions Grid -->
        <div class="predictions-grid">
            <!-- 10ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 10ë¶„ í›„</div>
                    <div class="time-range">{pred_10.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="result-highlight">
                    {pred_10.get('RESULT', '')}
                </div>
                
                <div class="class-section">
                    <div class="class-label">í´ë˜ìŠ¤ë³„ í™•ë¥ </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸ”´ Class 2 (ê¸‰ì¦)</span>
                            <span class="class-prob">{pred_10.get('CLASS_2_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_10.get('CLASS_2_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¡ Class 1 (ì†Œí­ì¦ê°€)</span>
                            <span class="class-prob">{pred_10.get('CLASS_1_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_10.get('CLASS_1_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¢ Class 0 (í•˜ë½/ì •ì²´)</span>
                            <span class="class-prob">{pred_10.get('CLASS_0_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_10.get('CLASS_0_PROB', 0)}%;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <span class="status-badge status-{pred_10.get('STATUS', '').lower()}">{pred_10.get('STATUS', '')}</span>
                </div>
                
                {'<div class="alert-box alert-surge">ğŸš¨ ê¸‰ì¦ ê²½ê³  ë°œë ¹</div>' if pred_10.get('SURGE_ALERT', 0) == 1 else ''}
            </div>

            <!-- 15ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 15ë¶„ í›„</div>
                    <div class="time-range">{pred_15.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="result-highlight">
                    {pred_15.get('RESULT', '')}
                </div>
                
                <div class="class-section">
                    <div class="class-label">í´ë˜ìŠ¤ë³„ í™•ë¥ </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸ”´ Class 2 (ê¸‰ì¦)</span>
                            <span class="class-prob">{pred_15.get('CLASS_2_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_15.get('CLASS_2_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¡ Class 1 (ì†Œí­ì¦ê°€)</span>
                            <span class="class-prob">{pred_15.get('CLASS_1_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_15.get('CLASS_1_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¢ Class 0 (í•˜ë½/ì •ì²´)</span>
                            <span class="class-prob">{pred_15.get('CLASS_0_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_15.get('CLASS_0_PROB', 0)}%;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <span class="status-badge status-{pred_15.get('STATUS', '').lower()}">{pred_15.get('STATUS', '')}</span>
                </div>
                
                {'<div class="alert-box alert-surge">ğŸš¨ ê¸‰ì¦ ê²½ê³  ë°œë ¹</div>' if pred_15.get('SURGE_ALERT', 0) == 1 else ''}
            </div>

            <!-- 25ë¶„ -->
            <div class="prediction-card">
                <div class="card-header">
                    <div class="time-badge">â±ï¸ 25ë¶„ í›„</div>
                    <div class="time-range">{pred_25.get('PREDICTION_TIME', '')}</div>
                </div>
                
                <div class="result-highlight">
                    {pred_25.get('RESULT', '')}
                </div>
                
                <div class="class-section">
                    <div class="class-label">í´ë˜ìŠ¤ë³„ í™•ë¥ </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸ”´ Class 2 (ê¸‰ì¦)</span>
                            <span class="class-prob">{pred_25.get('CLASS_2_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_25.get('CLASS_2_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¡ Class 1 (ì†Œí­ì¦ê°€)</span>
                            <span class="class-prob">{pred_25.get('CLASS_1_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_25.get('CLASS_1_PROB', 0)}%;"></div>
                        </div>
                    </div>
                    
                    <div class="class-bar-container">
                        <div class="class-bar-header">
                            <span class="class-name">ğŸŸ¢ Class 0 (í•˜ë½/ì •ì²´)</span>
                            <span class="class-prob">{pred_25.get('CLASS_0_PROB', 0):.1f}%</span>
                        </div>
                        <div class="class-bar">
                            <div class="class-bar-fill" style="width: {pred_25.get('CLASS_0_PROB', 0)}%;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <span class="status-badge status-{pred_25.get('STATUS', '').lower()}">{pred_25.get('STATUS', '')}</span>
                </div>
                
                {'<div class="alert-box alert-surge">ğŸš¨ ê¸‰ì¦ ê²½ê³  ë°œë ¹</div>' if pred_25.get('SURGE_ALERT', 0) == 1 else ''}
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>ğŸ¤– V8 Categorical Prediction System | XGBoost Classifier</p>
            <p>ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>
    </div>
</body>
</html>"""
    
    return html

def main():
    """ë©”ì¸ ì‹¤í–‰"""
    print("="*60)
    print("V8 ë²”ì£¼í˜• ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
    print("="*60)
    
    print("\n[1/2] ë²”ì£¼í˜• ì˜ˆì¸¡ ì‹¤í–‰ ì¤‘...")
    data = get_categorical_predictions()
    
    if not data:
        print("\nâŒ ì˜ˆì¸¡ ì‹¤íŒ¨!")
        return
    
    print("[2/2] HTML ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
    html_content = generate_html_dashboard(data)
    
    # íŒŒì¼ ì €ì¥
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f'V8_ë²”ì£¼í˜•_ëŒ€ì‹œë³´ë“œ_{timestamp}.html'
    filepath = os.path.join(script_dir, filename)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"\nâœ… ëŒ€ì‹œë³´ë“œ ìƒì„± ì™„ë£Œ!")
    print(f"ğŸ“‚ íŒŒì¼: {filename}")
    print(f"ğŸ“ ìœ„ì¹˜: {filepath}")
    
    # ë¸Œë¼ìš°ì € ì—´ê¸°
    try:
        webbrowser.open('file://' + os.path.abspath(filepath))
        print(f"\nğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ ëŒ€ì‹œë³´ë“œë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤!")
    except Exception as e:
        print(f"\nâš ï¸ ë¸Œë¼ìš°ì € ìë™ ì—´ê¸° ì‹¤íŒ¨: {e}")
        print(f"ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”: {filepath}")

if __name__ == '__main__':
    main()