import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np

# 1. CSV ì½ê¸°
df = pd.read_csv('RAL', encoding='utf-8')
df = df.dropna(subset=['CRT_TM'])
df['CRT_TM'] = pd.to_datetime(df['CRT_TM'])

# ë‚ ì§œ í¬ë§· ë³€í™˜ (202601010000 í˜•ì‹)
df['CRT_TM_STR'] = df['CRT_TM'].dt.strftime('%Y%m%d%H%M')

# 2. íŒŒìƒ ì»¬ëŸ¼ ìƒì„±
df['6ECMB101_ratio'] = (df['6ECMB101_WELL'] / df['RAIL-TRANSFERPAUSED_WELL'] * 100).fillna(0)
df['date'] = df['CRT_TM'].dt.date
df['date_str'] = df['CRT_TM'].dt.strftime('%Y%m%d')
df['hour'] = df['CRT_TM'].dt.hour
df['weekday'] = df['CRT_TM'].dt.dayofweek

# 3. ì´ìƒì¹˜ íƒì§€ (JOB_2 >= 400 ë˜ëŠ” 6ECMB101 ë¹„ìœ¨ >= 70%)
df['is_anomaly'] = ((df['CURRENT_M16A_3F_JOB_2_max'] >= 400) | (df['6ECMB101_ratio'] >= 70))

# 4. ì¼ë³„ ì§‘ê³„
daily = df.groupby(['date', 'date_str']).agg({
    'RAIL-TRANSFERPAUSED_WELL': 'sum',
    '6ECMB101_WELL': 'sum',
    'CURRENT_M16A_3F_JOB_2_max': 'max',
    'CURRENT_M16A_3F_JOB_2_mean': 'mean',
    'M16HUB_AVGTOTALTIME1MIN_max': 'max',
    'M16HUB_AVGTOTALTIME1MIN_mean': 'mean'
}).reset_index()
daily['ratio'] = daily['6ECMB101_WELL'] / daily['RAIL-TRANSFERPAUSED_WELL'] * 100

# 5. ì‹œê°„ëŒ€ë³„ ì§‘ê³„
hourly = df.groupby('hour').agg({
    'RAIL-TRANSFERPAUSED_WELL': 'mean',
    '6ECMB101_WELL': 'mean',
    'CURRENT_M16A_3F_JOB_2_mean': 'mean'
}).reset_index()

# 6. ìš”ì¼ë³„ ì§‘ê³„
weekday_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
weekday_agg = df.groupby('weekday').agg({
    'RAIL-TRANSFERPAUSED_WELL': 'mean',
    '6ECMB101_WELL': 'mean'
}).reset_index()
weekday_agg['weekday_name'] = weekday_agg['weekday'].apply(lambda x: weekday_names[x])

# 7. ìƒê´€ê´€ê³„ ê³„ì‚°
corr_cols = ['RAIL-TRANSFERPAUSED_WELL', '6ECMB101_WELL', 'CURRENT_M16A_3F_JOB_2_mean', 'M16HUB_AVGTOTALTIME1MIN_mean']
corr_matrix = df[corr_cols].corr()

# ========== HTML ëŒ€ì‹œë³´ë“œ ìƒì„± ==========

# ë©”ì¸ íŠ¸ë Œë“œ ê·¸ë˜í”„ (4ê°œ subplot)
fig1 = make_subplots(
    rows=4, cols=1,
    shared_xaxes=True,
    vertical_spacing=0.05,
    subplot_titles=(
        'ğŸ“Š RAIL-TRANSFERPAUSED ë°œìƒ ê±´ìˆ˜ (ì „ì²´ vs 6ECMB101)',
        'ğŸ“ˆ CURRENT_M16A_3F_JOB_2 (í‰ê· /ìµœëŒ€) - ê¸‰ì¦ ì„ê³„ê°’: 300',
        'â±ï¸ M16HUB_AVGTOTALTIME1MIN (í‰ê· /ìµœëŒ€)',
        'ğŸ“‰ 6ECMB101 ë¹„ìœ¨ (%) - ì „ì²´ PAUSE ëŒ€ë¹„'
    ),
    row_heights=[0.25, 0.25, 0.25, 0.25]
)

# 1) PAUSE ê±´ìˆ˜
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['RAIL-TRANSFERPAUSED_WELL'], name='ì „ì²´ PAUSE', line=dict(color='blue', width=1), opacity=0.7), row=1, col=1)
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['6ECMB101_WELL'], name='6ECMB101', line=dict(color='red', width=1), opacity=0.7), row=1, col=1)

# 2) JOB_2
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['CURRENT_M16A_3F_JOB_2_mean'], name='JOB_2 í‰ê· ', line=dict(color='green', width=1), opacity=0.7), row=2, col=1)
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['CURRENT_M16A_3F_JOB_2_max'], name='JOB_2 ìµœëŒ€', line=dict(color='orange', width=1), opacity=0.5), row=2, col=1)
fig1.add_hline(y=300, line_dash="dash", line_color="red", annotation_text="ê¸‰ì¦ ì„ê³„ê°’ (300)", row=2, col=1)
fig1.add_hline(y=400, line_dash="dash", line_color="darkred", annotation_text="ìœ„í—˜ (400)", row=2, col=1)

# 3) AvgTime
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['M16HUB_AVGTOTALTIME1MIN_mean'], name='AvgTime í‰ê· ', line=dict(color='purple', width=1), opacity=0.7), row=3, col=1)
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['M16HUB_AVGTOTALTIME1MIN_max'], name='AvgTime ìµœëŒ€', line=dict(color='magenta', width=1), opacity=0.5), row=3, col=1)
fig1.add_hline(y=10, line_dash="dash", line_color="orange", annotation_text="ê²½ê³  (10ë¶„)", row=3, col=1)
fig1.add_hline(y=20, line_dash="dash", line_color="red", annotation_text="ìœ„í—˜ (20ë¶„)", row=3, col=1)

# 4) ë¹„ìœ¨
fig1.add_trace(go.Scatter(x=df['CRT_TM_STR'], y=df['6ECMB101_ratio'], name='6ECMB101 ë¹„ìœ¨', line=dict(color='brown', width=1), opacity=0.7), row=4, col=1)
fig1.add_hline(y=50, line_dash="dash", line_color="red", annotation_text="50%", row=4, col=1)

# ì´ìƒì¹˜ ë§ˆì»¤
anomaly_df = df[df['is_anomaly']]
fig1.add_trace(go.Scatter(x=anomaly_df['CRT_TM_STR'], y=anomaly_df['CURRENT_M16A_3F_JOB_2_max'], mode='markers', name='âš ï¸ ì´ìƒì¹˜', marker=dict(color='red', size=8, symbol='x')), row=2, col=1)

fig1.update_layout(
    height=1200,
    title_text='<b>RAIL-TRANSFERPAUSED íŠ¸ë Œë“œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</b><br><sup>ê¸°ê°„: 202511250000 ~ 202601060700 (10ë¶„ ë‹¨ìœ„)</sup>',
    showlegend=True,
    hovermode='x unified',
    xaxis4=dict(
        rangeslider=dict(visible=True),
        type='category'
    )
)

# ========== ì¼ë³„ ìš”ì•½ ê·¸ë˜í”„ ==========
fig2 = make_subplots(
    rows=2, cols=2,
    subplot_titles=(
        'ğŸ“Š ì¼ë³„ PAUSE ê±´ìˆ˜', 
        'ğŸ“ˆ ì¼ë³„ JOB_2 ìµœëŒ€ê°’',
        'ğŸ“‰ ì¼ë³„ 6ECMB101 ë¹„ìœ¨ (%)',
        'â±ï¸ ì¼ë³„ AvgTime ìµœëŒ€ê°’'
    ),
    vertical_spacing=0.12,
    horizontal_spacing=0.08
)

# 1) ì¼ë³„ PAUSE
fig2.add_trace(go.Bar(x=daily['date_str'], y=daily['RAIL-TRANSFERPAUSED_WELL'], name='ì „ì²´', marker_color='blue', opacity=0.7), row=1, col=1)
fig2.add_trace(go.Bar(x=daily['date_str'], y=daily['6ECMB101_WELL'], name='6ECMB101', marker_color='red', opacity=0.7), row=1, col=1)

# 2) ì¼ë³„ JOB_2 Max
colors_job = ['red' if v >= 400 else 'orange' if v >= 300 else 'green' for v in daily['CURRENT_M16A_3F_JOB_2_max']]
fig2.add_trace(go.Bar(x=daily['date_str'], y=daily['CURRENT_M16A_3F_JOB_2_max'], name='JOB_2 Max', marker_color=colors_job), row=1, col=2)
fig2.add_hline(y=300, line_dash="dash", line_color="orange", row=1, col=2)
fig2.add_hline(y=400, line_dash="dash", line_color="red", row=1, col=2)

# 3) ì¼ë³„ ë¹„ìœ¨
colors_ratio = ['red' if v >= 70 else 'orange' if v >= 50 else 'green' for v in daily['ratio']]
fig2.add_trace(go.Bar(x=daily['date_str'], y=daily['ratio'], name='ë¹„ìœ¨', marker_color=colors_ratio), row=2, col=1)
fig2.add_hline(y=50, line_dash="dash", line_color="red", row=2, col=1)

# 4) ì¼ë³„ AvgTime Max
colors_time = ['red' if v >= 20 else 'orange' if v >= 10 else 'purple' for v in daily['M16HUB_AVGTOTALTIME1MIN_max']]
fig2.add_trace(go.Bar(x=daily['date_str'], y=daily['M16HUB_AVGTOTALTIME1MIN_max'], name='AvgTime Max', marker_color=colors_time), row=2, col=2)
fig2.add_hline(y=10, line_dash="dash", line_color="orange", row=2, col=2)
fig2.add_hline(y=20, line_dash="dash", line_color="red", row=2, col=2)

fig2.update_layout(
    height=800,
    title_text='<b>ì¼ë³„ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</b>',
    showlegend=True,
    barmode='group'
)

# ========== ì‹œê°„ëŒ€ë³„/ìš”ì¼ë³„ íŒ¨í„´ ==========
fig3 = make_subplots(
    rows=1, cols=3,
    subplot_titles=(
        'ğŸ• ì‹œê°„ëŒ€ë³„ PAUSE íŒ¨í„´',
        'ğŸ• ì‹œê°„ëŒ€ë³„ JOB_2 íŒ¨í„´',
        'ğŸ“… ìš”ì¼ë³„ 6ECMB101 íŒ¨í„´'
    ),
    horizontal_spacing=0.08
)

# ì‹œê°„ëŒ€ë³„ PAUSE
fig3.add_trace(go.Bar(x=hourly['hour'], y=hourly['RAIL-TRANSFERPAUSED_WELL'], name='ì „ì²´', marker_color='blue', opacity=0.7), row=1, col=1)
fig3.add_trace(go.Bar(x=hourly['hour'], y=hourly['6ECMB101_WELL'], name='6ECMB101', marker_color='red', opacity=0.7), row=1, col=1)

# ì‹œê°„ëŒ€ë³„ JOB_2
fig3.add_trace(go.Bar(x=hourly['hour'], y=hourly['CURRENT_M16A_3F_JOB_2_mean'], name='JOB_2 í‰ê· ', marker_color='green', opacity=0.7), row=1, col=2)
fig3.add_hline(y=300, line_dash="dash", line_color="red", row=1, col=2)

# ìš”ì¼ë³„
fig3.add_trace(go.Bar(x=weekday_agg['weekday_name'], y=weekday_agg['RAIL-TRANSFERPAUSED_WELL'], name='ì „ì²´', marker_color='blue', opacity=0.7), row=1, col=3)
fig3.add_trace(go.Bar(x=weekday_agg['weekday_name'], y=weekday_agg['6ECMB101_WELL'], name='6ECMB101', marker_color='red', opacity=0.7), row=1, col=3)

fig3.update_layout(
    height=500,
    title_text='<b>ì‹œê°„ëŒ€ë³„/ìš”ì¼ë³„ íŒ¨í„´ ë¶„ì„</b>',
    showlegend=True,
    barmode='group'
)

# ========== ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ ==========
fig4 = go.Figure(data=go.Heatmap(
    z=corr_matrix.values,
    x=['ì „ì²´PAUSE', '6ECMB101', 'JOB_2í‰ê· ', 'AvgTimeí‰ê· '],
    y=['ì „ì²´PAUSE', '6ECMB101', 'JOB_2í‰ê· ', 'AvgTimeí‰ê· '],
    colorscale='RdBu',
    zmid=0,
    text=np.round(corr_matrix.values, 2),
    texttemplate='%{text}',
    textfont={"size": 14},
    hovertemplate='%{x} vs %{y}: %{z:.3f}<extra></extra>'
))

fig4.update_layout(
    height=500,
    title_text='<b>ìƒê´€ê´€ê³„ ë¶„ì„</b><br><sup>1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì–‘ì˜ ìƒê´€ê´€ê³„, -1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ìŒì˜ ìƒê´€ê´€ê³„</sup>'
)

# ========== ì‚°ì ë„ (JOB_2 vs PAUSE) ==========
fig5 = go.Figure()
fig5.add_trace(go.Scatter(
    x=df['CURRENT_M16A_3F_JOB_2_mean'],
    y=df['6ECMB101_WELL'],
    mode='markers',
    marker=dict(
        size=5,
        color=df['M16HUB_AVGTOTALTIME1MIN_mean'],
        colorscale='Viridis',
        showscale=True,
        colorbar=dict(title='AvgTime')
    ),
    text=df['CRT_TM_STR'],
    hovertemplate='ì‹œê°„: %{text}<br>JOB_2: %{x:.1f}<br>6ECMB101: %{y}<br>AvgTime: %{marker.color:.1f}<extra></extra>'
))

fig5.add_vline(x=300, line_dash="dash", line_color="red", annotation_text="JOB_2 ê¸‰ì¦ ì„ê³„ê°’")
fig5.add_hline(y=50, line_dash="dash", line_color="orange", annotation_text="6ECMB101 ê²½ê³ ")

fig5.update_layout(
    height=600,
    title_text='<b>JOB_2 vs 6ECMB101 ì‚°ì ë„</b><br><sup>ìƒ‰ìƒ: AvgTime (ì§„í• ìˆ˜ë¡ ì§€ì—° ì‹¬í•¨)</sup>',
    xaxis_title='CURRENT_M16A_3F_JOB_2 í‰ê· ',
    yaxis_title='6ECMB101 PAUSE ê±´ìˆ˜'
)

# ========== HTML íŒŒì¼ ìƒì„± ==========
html_content = f'''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAIL-TRANSFERPAUSED ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {{
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .header {{
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }}
        .header h1 {{
            margin: 0;
            font-size: 28px;
        }}
        .header p {{
            margin: 10px 0 0 0;
            opacity: 0.9;
        }}
        .summary-cards {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }}
        .card {{
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }}
        .card h3 {{
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }}
        .card .value {{
            font-size: 32px;
            font-weight: bold;
            color: #1e3c72;
        }}
        .card .sub {{
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }}
        .card.warning .value {{
            color: #ff9800;
        }}
        .card.danger .value {{
            color: #f44336;
        }}
        .chart-container {{
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }}
        .section-title {{
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3c72;
        }}
        .insight-box {{
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }}
        .insight-box.danger {{
            background: #f8d7da;
            border-left-color: #dc3545;
        }}
        .insight-box h4 {{
            margin: 0 0 10px 0;
            color: #856404;
        }}
        .insight-box.danger h4 {{
            color: #721c24;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš¦ RAIL-TRANSFERPAUSED ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ğŸ“… ë¶„ì„ ê¸°ê°„: 202511250000 ~ 202601060700 | ğŸ“Š ë°ì´í„°: 10ë¶„ ë‹¨ìœ„ {len(df):,}ê±´</p>
    </div>

    <div class="summary-cards">
        <div class="card">
            <h3>ğŸ“Š ì´ PAUSE ê±´ìˆ˜</h3>
            <div class="value">{df['RAIL-TRANSFERPAUSED_WELL'].sum():,.0f}</div>
            <div class="sub">ì „ì²´ ê¸°ê°„ í•©ê³„</div>
        </div>
        <div class="card">
            <h3>ğŸ”´ 6ECMB101 ê±´ìˆ˜</h3>
            <div class="value">{df['6ECMB101_WELL'].sum():,.0f}</div>
            <div class="sub">ì „ì²´ ëŒ€ë¹„ {df['6ECMB101_WELL'].sum()/df['RAIL-TRANSFERPAUSED_WELL'].sum()*100:.1f}%</div>
        </div>
        <div class="card {'warning' if df['CURRENT_M16A_3F_JOB_2_max'].max() >= 400 else ''}">
            <h3>ğŸ“ˆ JOB_2 ìµœëŒ€ê°’</h3>
            <div class="value">{df['CURRENT_M16A_3F_JOB_2_max'].max():.0f}</div>
            <div class="sub">ê¸‰ì¦ ì„ê³„ê°’: 300</div>
        </div>
        <div class="card {'danger' if df['M16HUB_AVGTOTALTIME1MIN_max'].max() >= 20 else 'warning' if df['M16HUB_AVGTOTALTIME1MIN_max'].max() >= 10 else ''}">
            <h3>â±ï¸ AvgTime ìµœëŒ€ê°’</h3>
            <div class="value">{df['M16HUB_AVGTOTALTIME1MIN_max'].max():.1f}ë¶„</div>
            <div class="sub">ê²½ê³ : 10ë¶„ / ìœ„í—˜: 20ë¶„</div>
        </div>
        <div class="card">
            <h3>âš ï¸ ì´ìƒì¹˜ ë°œìƒ</h3>
            <div class="value">{len(anomaly_df):,}ê±´</div>
            <div class="sub">JOBâ‰¥400 ë˜ëŠ” ë¹„ìœ¨â‰¥70%</div>
        </div>
        <div class="card">
            <h3>ğŸ“… ë¶„ì„ ì¼ìˆ˜</h3>
            <div class="value">{len(daily)}ì¼</div>
            <div class="sub">10ë¶„ ë‹¨ìœ„ {len(df):,}ê±´</div>
        </div>
    </div>

    <div class="insight-box danger">
        <h4>ğŸš¨ ì£¼ìš” ë°œê²¬ ì‚¬í•­</h4>
        <ul>
            <li>6ECMB101 ì¥ë¹„ê°€ ì „ì²´ PAUSEì˜ <b>{df['6ECMB101_WELL'].sum()/df['RAIL-TRANSFERPAUSED_WELL'].sum()*100:.1f}%</b>ë¥¼ ì°¨ì§€ â†’ ì§‘ì¤‘ ì ê²€ í•„ìš”</li>
            <li>JOB_2 ìµœëŒ€ê°’ <b>{df['CURRENT_M16A_3F_JOB_2_max'].max():.0f}</b> ê¸°ë¡ (ê¸‰ì¦ ì„ê³„ê°’ 300 ì´ˆê³¼)</li>
            <li>AvgTime ìµœëŒ€ <b>{df['M16HUB_AVGTOTALTIME1MIN_max'].max():.1f}ë¶„</b> â†’ ì‹¬ê°í•œ ì§€ì—° ë°œìƒ ì´ë ¥</li>
        </ul>
    </div>

    <div class="chart-container">
        <div class="section-title">ğŸ“ˆ ì „ì²´ ê¸°ê°„ íŠ¸ë Œë“œ (ë“œë˜ê·¸í•˜ì—¬ ì¤Œ, ë”ë¸”í´ë¦­í•˜ì—¬ ë¦¬ì…‹)</div>
        <div id="chart1"></div>
    </div>

    <div class="chart-container">
        <div class="section-title">ğŸ“Š ì¼ë³„ ìš”ì•½</div>
        <div id="chart2"></div>
    </div>

    <div class="chart-container">
        <div class="section-title">ğŸ• ì‹œê°„ëŒ€ë³„/ìš”ì¼ë³„ íŒ¨í„´</div>
        <div id="chart3"></div>
    </div>

    <div class="chart-container">
        <div class="section-title">ğŸ”— ìƒê´€ê´€ê³„ ë¶„ì„</div>
        <div id="chart4"></div>
    </div>

    <div class="chart-container">
        <div class="section-title">ğŸ” JOB_2 vs 6ECMB101 ì‚°ì ë„ (ìƒ‰ìƒ: AvgTime)</div>
        <div id="chart5"></div>
    </div>

    <script>
        var chart1 = {fig1.to_json()};
        var chart2 = {fig2.to_json()};
        var chart3 = {fig3.to_json()};
        var chart4 = {fig4.to_json()};
        var chart5 = {fig5.to_json()};
        
        Plotly.newPlot('chart1', chart1.data, chart1.layout, {{responsive: true}});
        Plotly.newPlot('chart2', chart2.data, chart2.layout, {{responsive: true}});
        Plotly.newPlot('chart3', chart3.data, chart3.layout, {{responsive: true}});
        Plotly.newPlot('chart4', chart4.data, chart4.layout, {{responsive: true}});
        Plotly.newPlot('chart5', chart5.data, chart5.layout, {{responsive: true}});
    </script>
</body>
</html>
'''

# HTML íŒŒì¼ ì €ì¥
with open('RAIL_TRANSFERPAUSED_ëŒ€ì‹œë³´ë“œ.html', 'w', encoding='utf-8') as f:
    f.write(html_content)

print("ì €ì¥ ì™„ë£Œ: RAIL_TRANSFERPAUSED_ëŒ€ì‹œë³´ë“œ.html")