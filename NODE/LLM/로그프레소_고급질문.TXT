ë¡œê·¸í”„ë ˆì†Œ RAG ì‹œìŠ¤í…œ - ê³ ê¸‰ ê¸°ëŠ¥ ì§ˆë¬¸ ëª¨ìŒ

============================================================
ğŸ“š 1. ì—¬ëŸ¬ MD íŒŒì¼ í†µí•©
============================================================

Q: ë¡œê·¸í”„ë ˆì†Œ ë§¤ë‰´ì–¼ì´ ì—¬ëŸ¬ ê°œì˜ MD íŒŒì¼ë¡œ ë‚˜ë‰˜ì–´ ìˆì–´ìš”.
   ëª¨ë‘ í•©ì³ì„œ í•˜ë‚˜ì˜ RAG ì‹œìŠ¤í…œìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆë‚˜ìš”?

A: ê°€ëŠ¥í•©ë‹ˆë‹¤! ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

ë°©ë²• 1: íŒŒì¼ í•©ì¹˜ê¸°
-------------------
# ë²¡í„°DB_ê³ ê¸‰.py ìˆ˜ì •

md_files = [
    "ë¡œê·¸í”„ë ˆì†Œ_ë§¤ë‰´ì–¼_1.md",
    "ë¡œê·¸í”„ë ˆì†Œ_ë§¤ë‰´ì–¼_2.md",
    "ë¡œê·¸í”„ë ˆì†Œ_ë§¤ë‰´ì–¼_3.md"
]

all_content = ""
for md_file in md_files:
    with open(md_file, 'r', encoding='utf-8') as f:
        all_content += f"\n\n# íŒŒì¼: {md_file}\n\n"
        all_content += f.read()

# ì´í›„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
documents = split_markdown_smart(all_content)


ë°©ë²• 2: ê°œë³„ ì²˜ë¦¬ í›„ ë³‘í•©
--------------------------
documents = []
for md_file in md_files:
    with open(md_file, 'r', encoding='utf-8') as f:
        content = f.read()
    
    chunks = split_markdown_smart(content)
    
    # íŒŒì¼ëª… ë©”íƒ€ë°ì´í„° ì¶”ê°€
    for chunk in chunks:
        chunk['metadata']['source_file'] = md_file
    
    documents.extend(chunks)

# ì„ë² ë”© ìƒì„±
texts = [doc['content'] for doc in documents]
embeddings = model.encode(texts)


Q: ì–´ë–¤ íŒŒì¼ì—ì„œ ë‚˜ì˜¨ ë‹µë³€ì¸ì§€ ì•Œ ìˆ˜ ìˆë‚˜ìš”?

A: ë©”íƒ€ë°ì´í„°ì— íŒŒì¼ëª…ì„ ì €ì¥í•˜ë©´ ë©ë‹ˆë‹¤!

# ê²€ìƒ‰ ì‹œ íŒŒì¼ëª… í‘œì‹œ
def _search_similar(self, query, k=3):
    # ... ê²€ìƒ‰ ë¡œì§ ...
    
    results = []
    for idx, score, content in similarities[:k]:
        source = self.documents[idx].get('metadata', {}).get('source_file', 'ì•Œ ìˆ˜ ì—†ìŒ')
        results.append({
            'content': content,
            'source': source,
            'score': score
        })
    
    return results

# ë‹µë³€ ì‹œ ì¶œë ¥
print(f"\nğŸ“š ì°¸ê³  ë¬¸ì„œ:")
for r in similar_docs:
    print(f"   - {r['source']} (ìœ ì‚¬ë„: {r['score']:.2f})")

============================================================
ğŸŒ 2. ì›¹ ì¸í„°í˜ì´ìŠ¤ (Streamlit)
============================================================

Q: í„°ë¯¸ë„ì´ ì•„ë‹ˆë¼ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ì–´ìš”.

A: Streamlitìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ì„¤ì¹˜:
-----
pip install streamlit


ì½”ë“œ: ë¡œê·¸í”„ë ˆì†Œ_ì›¹UI.py
--------------------------
import streamlit as st
from ë¡œê·¸í”„ë ˆì†Œ_RAG import LogpressoRAG

st.title("ğŸ” ë¡œê·¸í”„ë ˆì†Œ ë§¤ë‰´ì–¼ ê²€ìƒ‰")

# ì´ˆê¸°í™” (ìºì‹œ)
@st.cache_resource
def load_rag():
    return LogpressoRAG(
        model_path="Qwen3-Coder-30B-A3B-Instruct-Q3_K_M.gguf"
    )

rag = load_rag()

# ì§ˆë¬¸ ì…ë ¥
question = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:", "")

if st.button("ê²€ìƒ‰") and question:
    with st.spinner("ë‹µë³€ ìƒì„± ì¤‘..."):
        answer = rag.ask(question)
    
    st.success("ë‹µë³€:")
    st.write(answer)
    
# ì‚¬ì´ë“œë°”ì— ì˜ˆì œ ì§ˆë¬¸
st.sidebar.header("ì˜ˆì œ ì§ˆë¬¸")
examples = [
    "set ëª…ë ¹ì–´ ì‚¬ìš©ë²•",
    "í”„ë¡œì‹œì €ë€?",
    "ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜"
]
for ex in examples:
    if st.sidebar.button(ex):
        question = ex


ì‹¤í–‰:
-----
streamlit run ë¡œê·¸í”„ë ˆì†Œ_ì›¹UI.py

ë¸Œë¼ìš°ì € ìë™ ì—´ë¦¼: http://localhost:8501

============================================================
ğŸ”Œ 3. API ì„œë²„ (FastAPI)
============================================================

Q: ë‹¤ë¥¸ ì‹œìŠ¤í…œì—ì„œ HTTPë¡œ í˜¸ì¶œí•˜ê³  ì‹¶ì–´ìš”.

A: FastAPIë¡œ REST API ë§Œë“¤ê¸°!

ì„¤ì¹˜:
-----
pip install fastapi uvicorn


ì½”ë“œ: ë¡œê·¸í”„ë ˆì†Œ_API.py
------------------------
from fastapi import FastAPI
from pydantic import BaseModel
from ë¡œê·¸í”„ë ˆì†Œ_RAG import LogpressoRAG

app = FastAPI()

# ì´ˆê¸°í™”
rag = LogpressoRAG(
    model_path="Qwen3-Coder-30B-A3B-Instruct-Q3_K_M.gguf"
)

class Question(BaseModel):
    question: str

@app.post("/ask")
def ask_question(q: Question):
    answer = rag.ask(q.question)
    return {
        "question": q.question,
        "answer": answer
    }

@app.get("/health")
def health_check():
    return {"status": "ok"}


ì‹¤í–‰:
-----
uvicorn ë¡œê·¸í”„ë ˆì†Œ_API:app --reload

í…ŒìŠ¤íŠ¸:
-------
curl -X POST "http://localhost:8000/ask" \
  -H "Content-Type: application/json" \
  -d '{"question": "set ëª…ë ¹ì–´ ì‚¬ìš©ë²•"}'

============================================================
ğŸ’¾ 4. íˆìŠ¤í† ë¦¬ ì €ì¥
============================================================

Q: ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ì €ì¥í•´ì„œ ë‚˜ì¤‘ì— í™•ì¸í•˜ê³  ì‹¶ì–´ìš”.

A: SQLiteë¡œ ê°„ë‹¨í•˜ê²Œ ì €ì¥!

ì½”ë“œ ì¶”ê°€:
----------
import sqlite3
from datetime import datetime

class LogpressoRAG:
    def __init__(self, ...):
        # ... ê¸°ì¡´ ì½”ë“œ ...
        
        # DB ì´ˆê¸°í™”
        self.conn = sqlite3.connect('logpresso_history.db')
        self.cursor = self.conn.cursor()
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS history (
                id INTEGER PRIMARY KEY,
                timestamp TEXT,
                question TEXT,
                answer TEXT
            )
        ''')
        self.conn.commit()
    
    def ask(self, question):
        answer = # ... ê¸°ì¡´ ë‹µë³€ ìƒì„± ...
        
        # íˆìŠ¤í† ë¦¬ ì €ì¥
        self.cursor.execute(
            'INSERT INTO history (timestamp, question, answer) VALUES (?, ?, ?)',
            (datetime.now().isoformat(), question, answer)
        )
        self.conn.commit()
        
        return answer
    
    def get_history(self, limit=10):
        """ìµœê·¼ íˆìŠ¤í† ë¦¬ ì¡°íšŒ"""
        self.cursor.execute(
            'SELECT timestamp, question, answer FROM history ORDER BY id DESC LIMIT ?',
            (limit,)
        )
        return self.cursor.fetchall()


ì‚¬ìš©:
-----
# íˆìŠ¤í† ë¦¬ í™•ì¸
history = rag.get_history(5)
for timestamp, question, answer in history:
    print(f"\n[{timestamp}]")
    print(f"Q: {question}")
    print(f"A: {answer}")

============================================================
ğŸ”„ 5. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (íŒŒì¼ ê°ì‹œ)
============================================================

Q: MD íŒŒì¼ì´ ìˆ˜ì •ë˜ë©´ ìë™ìœ¼ë¡œ ë²¡í„°DBë¥¼ ë‹¤ì‹œ ë§Œë“¤ê³  ì‹¶ì–´ìš”.

A: watchdog ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ íŒŒì¼ ê°ì‹œ!

ì„¤ì¹˜:
-----
pip install watchdog


ì½”ë“œ: ë¡œê·¸í”„ë ˆì†Œ_ìë™ì—…ë°ì´íŠ¸.py
---------------------------------
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import os
import time

class MarkdownHandler(FileSystemEventHandler):
    def on_modified(self, event):
        if event.src_path.endswith('.md'):
            print(f"\nğŸ”„ MD íŒŒì¼ ë³€ê²½ ê°ì§€: {event.src_path}")
            print("ë²¡í„°DB ì¬ìƒì„± ì¤‘...")
            
            # ë²¡í„°DB ì¬ìƒì„±
            os.system("python ë¡œê·¸í”„ë ˆì†Œ_ë²¡í„°DB_ê³ ê¸‰.py")
            
            print("âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!")

# ê°ì‹œ ì‹œì‘
observer = Observer()
observer.schedule(MarkdownHandler(), path='.', recursive=False)
observer.start()

print("ğŸ“‚ MD íŒŒì¼ ê°ì‹œ ì¤‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    observer.stop()

observer.join()


ì‹¤í–‰:
-----
python ë¡œê·¸í”„ë ˆì†Œ_ìë™ì—…ë°ì´íŠ¸.py

# ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
nohup python ë¡œê·¸í”„ë ˆì†Œ_ìë™ì—…ë°ì´íŠ¸.py &

============================================================
ğŸ” 6. ì˜ë¯¸ ê²€ìƒ‰ + í‚¤ì›Œë“œ ê²€ìƒ‰ í•˜ì´ë¸Œë¦¬ë“œ
============================================================

Q: ì˜ë¯¸ ê²€ìƒ‰ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•´ìš”. íŠ¹ì • í‚¤ì›Œë“œë„ í¬í•¨í•˜ê³  ì‹¶ì–´ìš”.

A: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ êµ¬í˜„!

ì½”ë“œ ìˆ˜ì •:
----------
def _search_hybrid(self, query, k=3, keyword=None):
    """í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰: ì˜ë¯¸ + í‚¤ì›Œë“œ"""
    
    # 1. ì˜ë¯¸ ê²€ìƒ‰
    query_embedding = self.embedding_model.encode([query])[0]
    
    similarities = []
    for i, doc_embedding in enumerate(self.embeddings):
        sim = self._cosine_similarity(query_embedding, doc_embedding)
        
        # í‚¤ì›Œë“œ ë³´ë„ˆìŠ¤
        keyword_bonus = 0
        if keyword:
            if keyword.lower() in self.documents[i]['content'].lower():
                keyword_bonus = 0.2  # 20% ê°€ì¤‘ì¹˜
        
        final_score = sim + keyword_bonus
        similarities.append((i, final_score, self.documents[i]['content']))
    
    similarities.sort(key=lambda x: x[1], reverse=True)
    
    return similarities[:k]


ì‚¬ìš©:
-----
# "set"ì´ í¬í•¨ëœ ë¬¸ì„œ ìš°ì„ 
results = rag._search_hybrid("ëª…ë ¹ì–´ ì‚¬ìš©ë²•", keyword="set")

============================================================
ğŸ“Š 7. ê²€ìƒ‰ ê²°ê³¼ ì‹œê°í™”
============================================================

Q: ì–´ë–¤ ë¬¸ì„œê°€ ì–¼ë§ˆë‚˜ ê´€ë ¨ìˆëŠ”ì§€ ì‹œê°í™”í•˜ê³  ì‹¶ì–´ìš”.

A: matplotlibìœ¼ë¡œ ìœ ì‚¬ë„ ì‹œê°í™”!

ì„¤ì¹˜:
-----
pip install matplotlib


ì½”ë“œ:
-----
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

# í•œê¸€ í°íŠ¸ ì„¤ì • (í•„ìš”ì‹œ)
plt.rcParams['font.family'] = 'Malgun Gothic'

def visualize_search(self, query, k=10):
    """ê²€ìƒ‰ ê²°ê³¼ ì‹œê°í™”"""
    
    query_embedding = self.embedding_model.encode([query])[0]
    
    similarities = []
    for i, doc_embedding in enumerate(self.embeddings):
        sim = self._cosine_similarity(query_embedding, doc_embedding)
        
        # ë¬¸ì„œ ì œëª© ì¶”ì¶œ (ì²« ì¤„)
        title = self.documents[i]['content'].split('\n')[0][:30]
        
        similarities.append((title, sim))
    
    similarities.sort(key=lambda x: x[1], reverse=True)
    top_k = similarities[:k]
    
    # ê·¸ë˜í”„
    titles = [t[0] for t in top_k]
    scores = [t[1] for t in top_k]
    
    plt.figure(figsize=(10, 6))
    plt.barh(range(len(titles)), scores)
    plt.yticks(range(len(titles)), titles)
    plt.xlabel('ìœ ì‚¬ë„')
    plt.title(f'ê²€ìƒ‰ì–´: {query}')
    plt.tight_layout()
    plt.savefig('search_result.png')
    plt.show()
    
    print("âœ… search_result.png ì €ì¥ ì™„ë£Œ")


ì‚¬ìš©:
-----
rag.visualize_search("set ëª…ë ¹ì–´", k=10)

============================================================
ğŸŒ 8. ë‹¤êµ­ì–´ ì§€ì›
============================================================

Q: ì˜ì–´ ë§¤ë‰´ì–¼ë„ í•¨ê»˜ ê²€ìƒ‰í•˜ê³  ì‹¶ì–´ìš”.

A: ë‹¤êµ­ì–´ ì„ë² ë”© ëª¨ë¸ ì‚¬ìš©!

ëª¨ë¸ ë³€ê²½:
----------
# ê¸°ì¡´: all-MiniLM-L6-v2 (ì˜ì–´ ìµœì í™”)
# ë³€ê²½: multilingual-e5-large (100ê°œ ì–¸ì–´ ì§€ì›)

pip install sentence-transformers

# ë²¡í„°DB_ê³ ê¸‰.py ìˆ˜ì •
model = SentenceTransformer('intfloat/multilingual-e5-large')


í•œì˜ í˜¼í•© ê²€ìƒ‰:
---------------
# í•œêµ­ì–´ MD + ì˜ì–´ MD í•¨ê»˜ ì²˜ë¦¬
md_files = [
    "ë¡œê·¸í”„ë ˆì†Œ_ë§¤ë‰´ì–¼_í•œêµ­ì–´.md",
    "logpresso_manual_english.md"
]

# ì–¸ì–´ íƒœê·¸ ì¶”ê°€
for md_file in md_files:
    lang = 'ko' if 'í•œêµ­ì–´' in md_file else 'en'
    # ... ì²˜ë¦¬ ì‹œ metadataì— ì–¸ì–´ ì •ë³´ ì¶”ê°€ ...

============================================================
ğŸ” 9. ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬
============================================================

Q: íŠ¹ì • ì‚¬ìš©ìëŠ” íŠ¹ì • ë¬¸ì„œë§Œ ë³¼ ìˆ˜ ìˆê²Œ í•˜ê³  ì‹¶ì–´ìš”.

A: ë©”íƒ€ë°ì´í„°ë¡œ ê¶Œí•œ ê´€ë¦¬!

ë¬¸ì„œì— ê¶Œí•œ ì •ë³´ ì¶”ê°€:
-----------------------
# ë²¡í„°DB ìƒì„± ì‹œ
for chunk in documents:
    # ë¬¸ì„œë³„ ê¶Œí•œ ì„¤ì •
    if 'admin' in chunk['header'].lower():
        chunk['metadata']['required_role'] = 'admin'
    else:
        chunk['metadata']['required_role'] = 'user'


ê²€ìƒ‰ ì‹œ í•„í„°ë§:
---------------
def ask(self, question, user_role='user'):
    """ê¶Œí•œ ê¸°ë°˜ ê²€ìƒ‰"""
    
    # ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰
    all_results = self._search_similar(question, k=10)
    
    # ê¶Œí•œ í•„í„°ë§
    filtered_results = []
    for doc in all_results:
        required_role = doc.get('metadata', {}).get('required_role', 'user')
        
        if user_role == 'admin' or required_role == 'user':
            filtered_results.append(doc)
    
    # ìƒìœ„ 3ê°œë§Œ
    similar_docs = filtered_results[:3]
    
    # ... ë‹µë³€ ìƒì„± ...


ì‚¬ìš©:
-----
# ì¼ë°˜ ì‚¬ìš©ì
answer = rag.ask("í”„ë¡œì‹œì €", user_role='user')

# ê´€ë¦¬ì
answer = rag.ask("ì‹œìŠ¤í…œ ì„¤ì •", user_role='admin')

============================================================
ğŸ“ˆ 10. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
============================================================

Q: ê²€ìƒ‰ ì†ë„, ë‹µë³€ í’ˆì§ˆ ë“±ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì‹¶ì–´ìš”.

A: ë¡œê¹… + ë©”íŠ¸ë¦­ ìˆ˜ì§‘!

ì½”ë“œ:
-----
import time
import logging

class LogpressoRAG:
    def __init__(self, ...):
        # ... ê¸°ì¡´ ì½”ë“œ ...
        
        # ë©”íŠ¸ë¦­ ì´ˆê¸°í™”
        self.metrics = {
            'total_queries': 0,
            'avg_search_time': 0,
            'avg_answer_time': 0
        }
    
    def ask(self, question):
        start_time = time.time()
        
        # ê²€ìƒ‰
        search_start = time.time()
        similar_docs = self._search_similar(question)
        search_time = time.time() - search_start
        
        # ë‹µë³€ ìƒì„±
        answer_start = time.time()
        answer = self._call_llm(...)
        answer_time = time.time() - answer_start
        
        total_time = time.time() - start_time
        
        # ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        self.metrics['total_queries'] += 1
        self.metrics['avg_search_time'] = (
            (self.metrics['avg_search_time'] * (self.metrics['total_queries'] - 1) + search_time)
            / self.metrics['total_queries']
        )
        self.metrics['avg_answer_time'] = (
            (self.metrics['avg_answer_time'] * (self.metrics['total_queries'] - 1) + answer_time)
            / self.metrics['total_queries']
        )
        
        # ë¡œê¹…
        logging.info(f"Query: {question[:50]}...")
        logging.info(f"Search time: {search_time:.2f}s")
        logging.info(f"Answer time: {answer_time:.2f}s")
        logging.info(f"Total time: {total_time:.2f}s")
        
        return answer
    
    def get_metrics(self):
        """ë©”íŠ¸ë¦­ ì¡°íšŒ"""
        return self.metrics


ì‚¬ìš©:
-----
# ë©”íŠ¸ë¦­ í™•ì¸
metrics = rag.get_metrics()
print(f"\nğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­:")
print(f"ì´ ì§ˆë¬¸ ìˆ˜: {metrics['total_queries']}")
print(f"í‰ê·  ê²€ìƒ‰ ì‹œê°„: {metrics['avg_search_time']:.2f}ì´ˆ")
print(f"í‰ê·  ë‹µë³€ ì‹œê°„: {metrics['avg_answer_time']:.2f}ì´ˆ")

============================================================