# ===== 3. ì—‘ì…€ íŒŒì¼ ìƒì„± ë° ì´ë¯¸ì§€ ì‚½ì… =====
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.drawing.image import Image as XLImage

wb = Workbook()

# ========== Sheet 1: Architecture Diagram (ì´ë¯¸ì§€) ==========
ws1 = wb.active
ws1.title = "Architecture Diagram"

# íƒ€ì´í‹€
ws1.merge_cells('A1:J1')
ws1['A1'] = "Text Generation WebUI RAG Architecture"
ws1['A1'].font = Font(bold=True, color="FFFFFF", size=16)
ws1['A1'].fill = PatternFill(start_color="1A237E", end_color="1A237E", fill_type="solid")
ws1['A1'].alignment = Alignment(horizontal='center', vertical='center')
ws1.row_dimensions[1].height = 35

# ì´ë¯¸ì§€ ì‚½ì…
img1 = XLImage('/mnt/user-data/outputs/architecture_professional.png')
img1.width = 1200  # ë„ˆë¹„ ì¡°ì •
img1.height = 840  # ë†’ì´ ì¡°ì •
ws1.add_image(img1, 'A3')

# ì—´ ë„ˆë¹„ ì¡°ì •
for col in range(1, 11):
    ws1.column_dimensions[chr(64 + col)].width = 15

# ========== Sheet 2: Data Flow Diagram (ì´ë¯¸ì§€) ==========
ws2 = wb.create_sheet("Data Flow Diagram")

# íƒ€ì´í‹€
ws2.merge_cells('A1:J1')
ws2['A1'] = "Data Flow Diagram"
ws2['A1'].font = Font(bold=True, color="FFFFFF", size=16)
ws2['A1'].fill = PatternFill(start_color="1A237E", end_color="1A237E", fill_type="solid")
ws2['A1'].alignment = Alignment(horizontal='center', vertical='center')
ws2.row_dimensions[1].height = 35

# ì´ë¯¸ì§€ ì‚½ì…
img2 = XLImage('/mnt/user-data/outputs/dataflow_professional.png')
img2.width = 1080
img2.height = 720
ws2.add_image(img2, 'A3')

# ì—´ ë„ˆë¹„ ì¡°ì •
for col in range(1, 11):
    ws2.column_dimensions[chr(64 + col)].width = 15

# ========== Sheet 3: Architecture Overview (í‘œ) ==========
ws3 = wb.create_sheet("Architecture Overview")
ws3.column_dimensions['A'].width = 20
ws3.column_dimensions['B'].width = 35
ws3.column_dimensions['C'].width = 50

header_fill = PatternFill(start_color="1A237E", end_color="1A237E", fill_type="solid")
header_font = Font(bold=True, color="FFFFFF", size=14)

layer_fills = {
    'user': PatternFill(start_color="E3F2FD", end_color="E3F2FD", fill_type="solid"),
    'router': PatternFill(start_color="FFF3E0", end_color="FFF3E0", fill_type="solid"),
    'processing': PatternFill(start_color="E8F5E9", end_color="E8F5E9", fill_type="solid"),
    'data': PatternFill(start_color="FFF9C4", end_color="FFF9C4", fill_type="solid"),
    'llm': PatternFill(start_color="F3E5F5", end_color="F3E5F5", fill_type="solid"),
    'response': PatternFill(start_color="E0F7FA", end_color="E0F7FA", fill_type="solid"),
}

border = Border(
    left=Side(style='thin'),
    right=Side(style='thin'),
    top=Side(style='thin'),
    bottom=Side(style='thin')
)

# íƒ€ì´í‹€
ws3.merge_cells('A1:C1')
ws3['A1'] = "Architecture Overview"
ws3['A1'].font = header_font
ws3['A1'].fill = header_fill
ws3['A1'].alignment = Alignment(horizontal='center', vertical='center')
ws3.row_dimensions[1].height = 30

# í—¤ë”
ws3['A3'] = "Layer"
ws3['B3'] = "Component"
ws3['C3'] = "Description"
for col in ['A', 'B', 'C']:
    ws3[f'{col}3'].font = Font(bold=True, size=12)
    ws3[f'{col}3'].fill = PatternFill(start_color="CCCCCC", end_color="CCCCCC", fill_type="solid")
    ws3[f'{col}3'].border = border
    ws3[f'{col}3'].alignment = Alignment(horizontal='center', vertical='center')

# ë°ì´í„°
data = [
    ("User Layer", "ì‚¬ìš©ì ì§ˆì˜", "â€¢ V7 ëª¨ë¸ë¡œ ì˜ˆì¸¡í•´ì¤˜\nâ€¢ ì™œ ê¸‰ì¦ ì˜ˆì¸¡í–ˆì–´?\nâ€¢ ê³¼ê±° ìœ ì‚¬ ì¼€ì´ìŠ¤ ì°¾ì•„ì¤˜"),
    ("Routing Layer", "FastAPI Router", "ì§ˆì˜ ìœ í˜• ìë™ íŒë³„\nâ€¢ SEARCH: ë°ì´í„° ê²€ìƒ‰\nâ€¢ PREDICT: ì˜ˆì¸¡ ìˆ˜í–‰\nâ€¢ EXPLAIN: ì˜ˆì¸¡ ì„¤ëª…"),
    ("Processing Layer", "RAG Engine", "LangChain + ChromaDB\nâ€¢ ê³¼ê±° ì´ë ¥ ê²€ìƒ‰\nâ€¢ ë¬¸ì„œ ì„ë² ë”©\nâ€¢ ìœ ì‚¬ë„ ë§¤ì¹­"),
    ("", "Prediction Engine", "ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê´€ë¦¬\nâ€¢ XGBoost V7 ëª¨ë¸\nâ€¢ XGBoost V6 ëª¨ë¸\nâ€¢ ê¸°íƒ€ ì˜ˆì¸¡ ëª¨ë¸"),
    ("", "Explainability Engine", "SHAP ë¶„ì„\nâ€¢ Feature ì¤‘ìš”ë„ ê³„ì‚°\nâ€¢ ì˜í–¥ë„ ë¶„ì„\nâ€¢ ìƒìœ„ Nê°œ Feature ì¶”ì¶œ"),
    ("Data Layer", "Vector Database", "ChromaDB\nâ€¢ ê³¼ê±° ë°ì´í„° ì„ë² ë”© ì €ì¥\nâ€¢ ìœ ì‚¬ë„ ê¸°ë°˜ ê²€ìƒ‰\nâ€¢ ë²¡í„° ì¸ë±ì‹±"),
    ("", "Model Storage", ".pkl íŒŒì¼ ì €ì¥ì†Œ\nâ€¢ V7.pkl (30ë¶„â†’10ë¶„ ì˜ˆì¸¡)\nâ€¢ V6.pkl (ê¸°ì¡´ ëª¨ë¸)\nâ€¢ ê¸°íƒ€ ëª¨ë¸ íŒŒì¼"),
    ("LLM Layer", "Text Generation WebUI", "Qwen 80B (H200 GPU)\nâ€¢ RAG ë‹µë³€ ìƒì„±\nâ€¢ ì˜ˆì¸¡ ê²°ê³¼ í•´ì„\nâ€¢ SHAP â†’ ìì—°ì–´ ë³€í™˜\nâ€¢ í†µí•© ì„¤ëª… ìƒì„±"),
    ("Response Layer", "í†µí•© ì‘ë‹µ", "â€¢ ì˜ˆì¸¡ê°’ + ì‹ ë¢°ë„\nâ€¢ ì£¼ìš” ì›ì¸ ì„¤ëª…\nâ€¢ ê³¼ê±° ìœ ì‚¬ ì¼€ì´ìŠ¤\nâ€¢ ìì—°ì–´ ì„¤ëª…")
]

row = 4
for layer, component, description in data:
    if layer:
        ws3[f'A{row}'] = layer
        ws3[f'A{row}'].font = Font(bold=True, size=11)
        ws3[f'A{row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        if 'User' in layer:
            ws3[f'A{row}'].fill = layer_fills['user']
        elif 'Routing' in layer:
            ws3[f'A{row}'].fill = layer_fills['router']
        elif 'Processing' in layer:
            ws3[f'A{row}'].fill = layer_fills['processing']
        elif 'Data' in layer:
            ws3[f'A{row}'].fill = layer_fills['data']
        elif 'LLM' in layer:
            ws3[f'A{row}'].fill = layer_fills['llm']
        elif 'Response' in layer:
            ws3[f'A{row}'].fill = layer_fills['response']
    
    ws3[f'B{row}'] = component
    ws3[f'C{row}'] = description
    
    ws3[f'B{row}'].font = Font(bold=True, size=11)
    ws3[f'B{row}'].alignment = Alignment(horizontal='left', vertical='top', wrap_text=True)
    ws3[f'C{row}'].alignment = Alignment(horizontal='left', vertical='top', wrap_text=True)
    
    for col in ['A', 'B', 'C']:
        ws3[f'{col}{row}'].border = border
    
    ws3.row_dimensions[row].height = 60
    row += 1

# ì…€ ë³‘í•©
ws3.merge_cells('A4:A4')
ws3.merge_cells('A5:A5')
ws3.merge_cells('A6:A8')
ws3.merge_cells('A9:A10')
ws3.merge_cells('A11:A11')
ws3.merge_cells('A12:A12')

# ========== Sheet 4: Technical Specs ==========
ws4 = wb.create_sheet("Technical Specs")
ws4.column_dimensions['A'].width = 25
ws4.column_dimensions['B'].width = 60

ws4.merge_cells('A1:B1')
ws4['A1'] = "Technical Specifications"
ws4['A1'].font = header_font
ws4['A1'].fill = header_fill
ws4['A1'].alignment = Alignment(horizontal='center', vertical='center')
ws4.row_dimensions[1].height = 30

specs = [
    ("LLM Model", "Qwen 80B (Text Generation WebUI)"),
    ("GPU", "H200 (4ê°œ ë¶„ì‚°: Dev, Staging, Prod)"),
    ("Vector DB", "ChromaDB"),
    ("RAG Framework", "LangChain"),
    ("Embedding Model", "ko-sroberta-multitask"),
    ("Prediction Models", "XGBoost V7, V6, ê¸°íƒ€"),
    ("Explainability", "SHAP (TreeExplainer)"),
    ("API Framework", "FastAPI"),
    ("Feature Engineering", "Momentum, hub/storage/cmd flags, surge_risk_score"),
    ("Model Files", "V7.pkl (30ë¶„â†’10ë¶„ ì˜ˆì¸¡), V6.pkl (ê¸°ì¡´ ëª¨ë¸)")
]

row = 3
for spec_name, spec_value in specs:
    ws4[f'A{row}'] = spec_name
    ws4[f'B{row}'] = spec_value
    
    ws4[f'A{row}'].font = Font(bold=True, size=11)
    ws4[f'A{row}'].alignment = Alignment(horizontal='left', vertical='center')
    ws4[f'B{row}'].alignment = Alignment(horizontal='left', vertical='center', wrap_text=True)
    
    for col in ['A', 'B']:
        ws4[f'{col}{row}'].border = border
    
    ws4.row_dimensions[row].height = 30
    row += 1

# ì €ì¥
wb.save('/mnt/user-data/outputs/architecture_documentation.xlsx')
print("âœ… ì—‘ì…€ ë¬¸ì„œ ìƒì„± ì™„ë£Œ! (ì´ë¯¸ì§€ í¬í•¨)")
print("\nğŸ“¦ ìƒì„±ëœ íŒŒì¼:")
print("  â€¢ architecture_documentation.xlsx")
print("    - Sheet 1: Architecture Diagram (ì´ë¯¸ì§€)")
print("    - Sheet 2: Data Flow Diagram (ì´ë¯¸ì§€)")
print("    - Sheet 3: Architecture Overview (í‘œ)")
print("    - Sheet 4: Technical Specs (í‘œ)")