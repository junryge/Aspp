"""
# SKí•˜ì´ë‹‰ìŠ¤ DRM í•´ì œ ì„¤ì •
# ì•„ë˜ ê°’ë“¤ì„ ì…ë ¥í•˜ì„¸ìš”

CDN_KEY=ì—¬ê¸°ì—_CDNí‚¤_ì…ë ¥
DRM_TOKEN=ì—¬ê¸°ì—_DRMí† í°_ì…ë ¥
EMP_NO=ì—¬ê¸°ì—_ì‚¬ë²ˆ_ì…ë ¥


SKí•˜ì´ë‹‰ìŠ¤ DRM í•´ì œ í†µí•© ë„êµ¬
ë¡œì»¬ íŒŒì¼ â†’ CDN ì—…ë¡œë“œ â†’ DRM í•´ì œ â†’ CSV/Excel ì €ì¥

ì‚¬ìš©ë²•: python drm_parser.py íŒŒì¼ê²½ë¡œ
ì˜ˆì‹œ: python drm_parser.py APS_20250105.CSV
"""

import requests
import json
from flask import Flask, request as flask_request
import threading
import time
import os
import csv
import sys

# ============== ì„¤ì • ==============
CDN_URL = "https://cdn.skhynix.com"
CDN_UPLOAD_API = f"{CDN_URL}/api/pub/v1/upload"
CDN_DELETE_API = f"{CDN_URL}/api/pub/v1/upload/del/seq"

DRM_API_SINGLE = "https://workplace.skhynix.com/api/common/v1/drm/excel/parse"
DRM_API_MULTI = "https://workplace.skhynix.com/api/common/v1/drm/excel/sheetParse"

CONFIG_FILE = "CONFIG.TXT"
OUTPUT_DIR = "./output"

CALLBACK_PORT = 5000
result_data = None
current_file_info = {}


# ============== ì„¤ì • ë¡œë“œ ==============
def load_config():
    if not os.path.exists(CONFIG_FILE):
        print(f"âŒ {CONFIG_FILE} ì—†ìŒ!")
        return None
    
    config = {}
    with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if '=' in line and not line.startswith('#'):
                key, value = line.split('=', 1)
                config[key.strip()] = value.strip()
    
    required = ['CDN_KEY', 'DRM_TOKEN', 'EMP_NO']
    missing = [k for k in required if not config.get(k) or config.get(k).startswith('ì—¬ê¸°ì—')]
    
    if missing:
        print(f"âŒ CONFIG.TXT ë¯¸ì…ë ¥: {missing}")
        return None
    
    print("âœ… ì„¤ì • ë¡œë“œ ì™„ë£Œ")
    return config


# ============== CDN ì—…ë¡œë“œ ==============
def upload_to_cdn(filepath, cdn_key, emp_no):
    if not os.path.exists(filepath):
        print(f"âŒ íŒŒì¼ ì—†ìŒ: {filepath}")
        return None
    
    filename = os.path.basename(filepath)
    filesize = os.path.getsize(filepath)
    
    print(f"\nğŸ“¤ [1/3] CDN ì—…ë¡œë“œ ì¤‘...")
    print(f"   íŒŒì¼: {filename} ({filesize:,} bytes)")
    
    with open(filepath, 'rb') as f:
        files = {'file': (filename, f)}
        params = {'key': cdn_key, 'empNo': emp_no}
        response = requests.post(CDN_UPLOAD_API, files=files, params=params)
    
    if response.status_code != 200:
        print(f"âŒ CDN ì‹¤íŒ¨: {response.status_code} - {response.text}")
        return None
    
    result = response.json()
    if result.get('code') != 300:
        print(f"âŒ CDN ì—ëŸ¬: {result}")
        return None
    
    print(f"âœ… CDN ì—…ë¡œë“œ ì„±ê³µ! SEQ: {result.get('seq')}")
    return result


# ============== CDN ì‚­ì œ ==============
def delete_from_cdn(seq, cdn_key, emp_no):
    """CDNì—ì„œ íŒŒì¼ ì‚­ì œ (ì •ë¦¬ìš©)"""
    payload = {'seq': seq, 'empNo': emp_no, 'key': cdn_key}
    try:
        requests.post(CDN_DELETE_API, json=payload)
        print(f"ğŸ—‘ï¸ CDN íŒŒì¼ ì‚­ì œ ì™„ë£Œ")
    except:
        pass


# ============== íŒŒì¼ ì €ì¥ ==============
def save_to_csv(headers, datas, filepath):
    with open(filepath, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        if headers:
            writer.writerow(headers)
        writer.writerows(datas)
    print(f"ğŸ“ ì €ì¥: {filepath}")


def save_to_excel(headers, datas, filepath):
    try:
        import pandas as pd
        df = pd.DataFrame(datas, columns=headers if headers else None)
        df.to_excel(filepath, index=False, engine='openpyxl')
        print(f"ğŸ“ ì €ì¥: {filepath}")
    except ImportError:
        csv_path = filepath.rsplit('.', 1)[0] + '.csv'
        save_to_csv(headers, datas, csv_path)
        print("âš ï¸ pandas ì—†ì–´ì„œ CSVë¡œ ì €ì¥ë¨")


def save_result(result, original_filename):
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    headers = result.get('headers') or result.get('heasers', [])
    datas = result.get('datas', [])
    
    name, ext = os.path.splitext(original_filename)
    ext = ext.lower()
    output_path = os.path.join(OUTPUT_DIR, original_filename)
    
    # ë‹¤ì¤‘ ì‹œíŠ¸ ì²´í¬
    is_multi = isinstance(datas, list) and len(datas) > 0 and isinstance(datas[0], dict) and 'sheet' in datas[0]
    
    if ext == '.csv':
        save_to_csv(headers, datas, output_path)
    elif ext in ['.xlsx', '.xls']:
        if is_multi:
            # ë‹¤ì¤‘ ì‹œíŠ¸ Excel
            try:
                import pandas as pd
                headers_list = headers if isinstance(headers, list) and isinstance(headers[0], dict) else []
                with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
                    for i, d in enumerate(datas):
                        sheet_headers = headers_list[i].get('header', []) if i < len(headers_list) else []
                        sheet_data = d.get('sheet', [])
                        df = pd.DataFrame(sheet_data, columns=sheet_headers if sheet_headers else None)
                        df.to_excel(writer, sheet_name=f'Sheet{i+1}', index=False)
                print(f"ğŸ“ ì €ì¥: {output_path}")
            except ImportError:
                csv_path = os.path.join(OUTPUT_DIR, name + '.csv')
                save_to_csv(headers, datas, csv_path)
        else:
            save_to_excel(headers, datas, output_path)
    else:
        csv_path = os.path.join(OUTPUT_DIR, name + '.csv')
        save_to_csv(headers, datas, csv_path)
    
    # JSON ë°±ì—…
    json_path = os.path.join(OUTPUT_DIR, name + '_raw.json')
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)


# ============== ì½œë°± ì„œë²„ ==============
app = Flask(__name__)

@app.route('/callback', methods=['POST'])
def callback():
    global result_data
    result_data = flask_request.json
    
    status = result_data.get('parseStatus')
    if status == 3:
        print(f"\nâœ… [3/3] DRM í•´ì œ ì„±ê³µ!")
        save_result(result_data, current_file_info.get('filename', 'output.csv'))
    elif status == 9:
        print(f"\nâŒ DRM í•´ì œ ì‹¤íŒ¨: {result_data.get('errorMsg')}")
    
    return {'status': 'received'}


def start_callback_server():
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)
    app.run(host='0.0.0.0', port=CALLBACK_PORT, threaded=True, use_reloader=False)


# ============== DRM í•´ì œ ìš”ì²­ ==============
def request_drm_parse(cdn_result, drm_token, emp_no, callback_url):
    global current_file_info
    
    filename = cdn_result.get('fileName')
    seq = cdn_result.get('seq')
    file_ext = cdn_result.get('fileExt', 'xlsx')
    file_size = cdn_result.get('fileSize', 0)
    
    current_file_info = {'filename': filename, 'seq': seq}
    
    print(f"\nğŸ”“ [2/3] DRM í•´ì œ ìš”ì²­ ì¤‘...")
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {drm_token}"
    }
    
    payload = {
        "file": {
            "down": cdn_result.get('down'),
            "fileExt": file_ext,
            "fileName": filename,
            "fileSize": file_size,
            "fileType": cdn_result.get('fileType', 1),
            "link": cdn_result.get('link', ''),
            "seq": seq,
            "size": file_size
        },
        "header": {
            "headerType": 1,
            "headerRow": 1,
            "headerNames": []
        },
        "startRow": 2,
        "returnType": "json",
        "callbackUrl": callback_url,
        "requestUser": emp_no
    }
    
    response = requests.post(DRM_API_SINGLE, json=payload, headers=headers)
    
    if response.status_code == 200:
        print(f"âœ… DRM ìš”ì²­ ì ‘ìˆ˜ë¨, ê²°ê³¼ ëŒ€ê¸°ì¤‘...")
    else:
        print(f"âŒ DRM ìš”ì²­ ì‹¤íŒ¨: {response.status_code} - {response.text}")
    
    return response


# ============== ë©”ì¸ ==============
def main():
    print("="*60)
    print("SKí•˜ì´ë‹‰ìŠ¤ DRM í•´ì œ ë„êµ¬")
    print("="*60)
    
    # íŒŒì¼ ê²½ë¡œ í™•ì¸
    if len(sys.argv) < 2:
        print("\nì‚¬ìš©ë²•: python drm_parser.py íŒŒì¼ê²½ë¡œ")
        print("ì˜ˆì‹œ: python drm_parser.py APS_20250105.CSV")
        return
    
    filepath = sys.argv[1]
    if not os.path.exists(filepath):
        print(f"âŒ íŒŒì¼ ì—†ìŒ: {filepath}")
        return
    
    # ì„¤ì • ë¡œë“œ
    config = load_config()
    if not config:
        return
    
    cdn_key = config['CDN_KEY']
    drm_token = config['DRM_TOKEN']
    emp_no = config['EMP_NO']
    
    # ì½œë°± ì„œë²„ ì‹œì‘
    print(f"\nğŸš€ ì½œë°± ì„œë²„ ì‹œì‘ (port {CALLBACK_PORT})...")
    server_thread = threading.Thread(target=start_callback_server, daemon=True)
    server_thread.start()
    time.sleep(1)
    
    # ì½œë°± URL (ì‚¬ë‚´ë§ IPë¡œ ë³€ê²½ í•„ìš”ì‹œ ì—¬ê¸° ìˆ˜ì •)
    callback_url = f"http://localhost:{CALLBACK_PORT}/callback"
    
    # 1. CDN ì—…ë¡œë“œ
    cdn_result = upload_to_cdn(filepath, cdn_key, emp_no)
    if not cdn_result:
        return
    
    seq = cdn_result.get('seq')
    
    try:
        # 2. DRM í•´ì œ ìš”ì²­
        response = request_drm_parse(cdn_result, drm_token, emp_no, callback_url)
        
        if response.status_code != 200:
            return
        
        # 3. ê²°ê³¼ ëŒ€ê¸°
        global result_data
        timeout = 120
        start = time.time()
        
        while result_data is None and (time.time() - start) < timeout:
            time.sleep(1)
        
        if result_data is None:
            print(f"\nâ° íƒ€ì„ì•„ì›ƒ! ì½œë°± URL í™•ì¸ í•„ìš”")
            print(f"   í˜„ì¬ ì„¤ì •: {callback_url}")
            print(f"   ì‚¬ë‚´ë§ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ IP:PORTë¡œ ë³€ê²½í•˜ì„¸ìš”")
        else:
            print(f"\nâœ… ì™„ë£Œ! ê²°ê³¼: {OUTPUT_DIR}/")
    
    finally:
        # CDN íŒŒì¼ ì‚­ì œ (ì •ë¦¬)
        delete_from_cdn(seq, cdn_key, emp_no)


if __name__ == "__main__":
    main()