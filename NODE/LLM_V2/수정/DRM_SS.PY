"""
SKí•˜ì´ë‹‰ìŠ¤ DRM í•´ì œ â†’ ë¡œì»¬ ì €ì¥
- CSV, Excel, ë‹¤ì¤‘ì‹œíŠ¸ ì§€ì›
- TOKEN.TXTì— API í† í° ì…ë ¥
"""

import requests
import json
from flask import Flask, request
import threading
import time
import os
import csv
import pandas as pd

# ============== ì„¤ì • ==============
API_URL_SINGLE = "https://workplace.skhynix.com/api/common/v1/drm/excel/parse"
API_URL_MULTI = "https://workplace.skhynix.com/api/common/v1/drm/excel/sheetParse"
CDN_BASE = "https://cdn.skhynix.com"

TOKEN_FILE = "TOKEN.TXT"
OUTPUT_DIR = "./output"  # ì €ì¥ í´ë”

CALLBACK_PORT = 5000
CALLBACK_HOST = "0.0.0.0"

result_data = None
current_file_info = {}


# ============== í† í° ë¡œë“œ ==============
def load_token():
    if not os.path.exists(TOKEN_FILE):
        print(f"âŒ {TOKEN_FILE} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!")
        return None
    with open(TOKEN_FILE, 'r', encoding='utf-8') as f:
        token = f.read().strip()
    if not token:
        print(f"âŒ {TOKEN_FILE} íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
        return None
    print(f"âœ… í† í° ë¡œë“œ ì™„ë£Œ")
    return token


# ============== íŒŒì¼ ì €ì¥ í•¨ìˆ˜ ==============
def save_to_csv(headers, datas, filepath):
    """CSVë¡œ ì €ì¥"""
    with open(filepath, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        if headers:
            writer.writerow(headers)
        writer.writerows(datas)
    print(f"ğŸ“ CSV ì €ì¥: {filepath}")


def save_to_excel(headers, datas, filepath):
    """Excelë¡œ ì €ì¥"""
    df = pd.DataFrame(datas, columns=headers if headers else None)
    df.to_excel(filepath, index=False, engine='openpyxl')
    print(f"ğŸ“ Excel ì €ì¥: {filepath}")


def save_to_excel_multi(sheets_data, filepath):
    """ë‹¤ì¤‘ ì‹œíŠ¸ Excel ì €ì¥"""
    with pd.ExcelWriter(filepath, engine='openpyxl') as writer:
        for i, sheet in enumerate(sheets_data):
            headers = sheet.get('headers', [])
            datas = sheet.get('datas', [])
            sheet_name = sheet.get('name', f'Sheet{i+1}')
            df = pd.DataFrame(datas, columns=headers if headers else None)
            df.to_excel(writer, sheet_name=sheet_name, index=False)
    print(f"ğŸ“ ë‹¤ì¤‘ì‹œíŠ¸ Excel ì €ì¥: {filepath}")


def save_result(result, original_filename):
    """ê²°ê³¼ë¥¼ ì›ë³¸ í˜•ì‹ìœ¼ë¡œ ì €ì¥"""
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    headers = result.get('headers') or result.get('heasers', [])
    datas = result.get('datas', [])
    
    name, ext = os.path.splitext(original_filename)
    ext = ext.lower()
    
    output_path = os.path.join(OUTPUT_DIR, original_filename)
    
    if ext == '.csv':
        save_to_csv(headers, datas, output_path)
    elif ext in ['.xlsx', '.xls']:
        if isinstance(datas, list) and len(datas) > 0 and isinstance(datas[0], dict) and 'sheet' in datas[0]:
            sheets_data = []
            headers_list = headers if isinstance(headers, list) and len(headers) > 0 and isinstance(headers[0], dict) else []
            for i, d in enumerate(datas):
                sheet_headers = headers_list[i].get('header', []) if i < len(headers_list) else []
                sheets_data.append({
                    'headers': sheet_headers,
                    'datas': d.get('sheet', []),
                    'name': f'Sheet{i+1}'
                })
            save_to_excel_multi(sheets_data, output_path)
        else:
            save_to_excel(headers, datas, output_path)
    else:
        csv_path = os.path.join(OUTPUT_DIR, name + '.csv')
        save_to_csv(headers, datas, csv_path)
    
    json_path = os.path.join(OUTPUT_DIR, name + '_raw.json')
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    print(f"ğŸ“ JSON ë°±ì—…: {json_path}")


# ============== ì½œë°± ì„œë²„ ==============
app = Flask(__name__)

@app.route('/callback', methods=['POST'])
def callback():
    global result_data
    result_data = request.json
    
    print("\n" + "="*60)
    print("âœ… DRM í•´ì œ ê²°ê³¼ ìˆ˜ì‹ !")
    print("="*60)
    
    status = result_data.get('parseStatus')
    
    if status == 3:
        original_filename = current_file_info.get('filename', 'output.csv')
        save_result(result_data, original_filename)
        print("\nâœ… ì €ì¥ ì™„ë£Œ!")
    elif status == 9:
        print(f"âŒ ì—ëŸ¬: {result_data.get('errorMsg')}")
    else:
        print(f"â³ ì§„í–‰ì¤‘... (status={status})")
    
    return {'status': 'received'}


def start_callback_server():
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)
    app.run(host=CALLBACK_HOST, port=CALLBACK_PORT, threaded=True, use_reloader=False)


# ============== API í˜¸ì¶œ ==============
def parse_drm_file(
    token: str,
    file_seq: str,
    file_name: str,
    file_ext: str = None,
    file_size: int = 0,
    header_type: int = 1,
    header_row: int = 1,
    start_row: int = 2,
    callback_url: str = None,
    request_user: str = ""
):
    global current_file_info
    
    if file_ext is None:
        file_ext = os.path.splitext(file_name)[1].lstrip('.').lower()
        if not file_ext:
            file_ext = 'xlsx'
    
    current_file_info = {'filename': file_name, 'ext': file_ext}
    
    if callback_url is None:
        callback_url = f"http://localhost:{CALLBACK_PORT}/callback"
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }
    
    payload = {
        "file": {
            "down": f"{CDN_BASE}/down/file/{file_seq}",
            "fileExt": file_ext,
            "fileName": file_name,
            "fileSize": file_size,
            "fileType": 1,
            "link": f"{CDN_BASE}/img/icon/{file_ext}",
            "seq": file_seq,
            "size": file_size
        },
        "header": {
            "headerType": header_type,
            "headerRow": header_row,
            "headerNames": []
        },
        "startRow": start_row,
        "returnType": "json",
        "callbackUrl": callback_url,
        "requestUser": request_user
    }
    
    print(f"\nğŸ“¤ API í˜¸ì¶œì¤‘...")
    print(f"   íŒŒì¼: {file_name}")
    print(f"   SEQ: {file_seq}")
    
    response = requests.post(API_URL_SINGLE, json=payload, headers=headers)
    print(f"   ì‘ë‹µ: {response.status_code}")
    
    return response


# ============== ë©”ì¸ ==============
if __name__ == "__main__":
    print("="*60)
    print("SKí•˜ì´ë‹‰ìŠ¤ DRM í•´ì œ â†’ ë¡œì»¬ ì €ì¥")
    print("="*60)
    
    token = load_token()
    if not token:
        exit(1)
    
    print(f"\nğŸš€ ì½œë°± ì„œë²„ ì‹œì‘ (port {CALLBACK_PORT})...")
    server_thread = threading.Thread(target=start_callback_server, daemon=True)
    server_thread.start()
    time.sleep(1)
    
    # ========================================
    # âš ï¸ ì—¬ê¸° ìˆ˜ì •!
    # ========================================
    FILE_SEQ = "YOUR_FILE_SEQ"           # CDNì—ì„œ ë°›ì€ seq
    FILE_NAME = "APS_20250105.CSV"       # ì›ë³¸ íŒŒì¼ëª…
    FILE_SIZE = 0
    REQUEST_USER = "X0000000"            # ì‚¬ì›ë²ˆí˜¸
    CALLBACK_URL = f"http://localhost:{CALLBACK_PORT}/callback"
    # ========================================
    
    if FILE_SEQ == "YOUR_FILE_SEQ":
        print("\nâŒ FILE_SEQë¥¼ ì…ë ¥í•˜ì„¸ìš”!")
        print("\n[ì‚¬ìš©ë²•]")
        print("1. TOKEN.TXT â†’ API í† í°")
        print("2. FILE_SEQ â†’ CDN seq ê°’")
        print("3. FILE_NAME â†’ ì›ë³¸ íŒŒì¼ëª…")
        print("4. ì‹¤í–‰ â†’ ./output í´ë”ì— ì €ì¥")
    else:
        response = parse_drm_file(
            token=token,
            file_seq=FILE_SEQ,
            file_name=FILE_NAME,
            file_size=FILE_SIZE,
            callback_url=CALLBACK_URL,
            request_user=REQUEST_USER
        )
        
        if response.status_code == 200:
            print("\nâ³ ê²°ê³¼ ëŒ€ê¸°ì¤‘...")
            try:
                while result_data is None:
                    time.sleep(1)
            except KeyboardInterrupt:
                print("\nì¢…ë£Œ")
        else:
            print(f"âŒ ì˜¤ë¥˜: {response.text}")