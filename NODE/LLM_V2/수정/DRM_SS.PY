"""
SKí•˜ì´ë‹‰ìŠ¤ DRM Excel Export API í˜¸ì¶œ ìŠ¤í¬ë¦½íŠ¸
- TOKEN.TXT íŒŒì¼ì— API í† í° ê¸°ì… í•„ìš”
- ìš´ì˜ URL: https://workplace.skhynix.com/api/common/v1/drm/excel/sheetParse
"""

import requests
import json
from flask import Flask, request
import threading
import time
import os

# ============== ì„¤ì • ==============
API_URL_SINGLE = "https://workplace.skhynix.com/api/common/v1/drm/excel/parse"
API_URL_MULTI = "https://workplace.skhynix.com/api/common/v1/drm/excel/sheetParse"
CDN_BASE = "https://cdn.skhynix.com"

# í† í° íŒŒì¼ ê²½ë¡œ
TOKEN_FILE = "TOKEN.TXT"

# ì½œë°± ì„œë²„ ì„¤ì •
CALLBACK_PORT = 5000
CALLBACK_HOST = "0.0.0.0"

result_data = None


# ============== í† í° ë¡œë“œ ==============
def load_token():
    """TOKEN.TXTì—ì„œ í† í° ì½ê¸°"""
    if not os.path.exists(TOKEN_FILE):
        print(f"âŒ {TOKEN_FILE} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!")
        print(f"   {TOKEN_FILE} íŒŒì¼ ìƒì„± í›„ API í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return None
    
    with open(TOKEN_FILE, 'r', encoding='utf-8') as f:
        token = f.read().strip()
    
    if not token:
        print(f"âŒ {TOKEN_FILE} íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
        return None
    
    print(f"âœ… í† í° ë¡œë“œ ì™„ë£Œ ({len(token)}ì)")
    return token


# ============== ì½œë°± ì„œë²„ ==============
app = Flask(__name__)

@app.route('/callback', methods=['POST'])
def callback():
    """API ê²°ê³¼ ìˆ˜ì‹ """
    global result_data
    result_data = request.json
    
    print("\n" + "="*60)
    print("âœ… DRM í•´ì œ ê²°ê³¼ ìˆ˜ì‹ !")
    print("="*60)
    print(f"ì½”ë“œ: {result_data.get('code')}")
    print(f"ìƒíƒœ: {result_data.get('parseStatus')} (1=ë“±ë¡, 2=ë³€í™˜ì¤‘, 3=ì„±ê³µ, 9=ì‹¤íŒ¨)")
    
    if result_data.get('parseStatus') == 3:
        headers = result_data.get('headers') or result_data.get('heasers', [])
        datas = result_data.get('datas', [])
        
        print(f"í—¤ë”: {headers}")
        print(f"ë°ì´í„° í–‰ìˆ˜: {len(datas)}")
        
        # JSON ì €ì¥
        with open('drm_result.json', 'w', encoding='utf-8') as f:
            json.dump(result_data, f, ensure_ascii=False, indent=2)
        print(f"\nğŸ“ ì €ì¥: drm_result.json")
        
    elif result_data.get('parseStatus') == 9:
        print(f"âŒ ì—ëŸ¬: {result_data.get('errorMsg')}")
    
    return {'status': 'received'}


def start_callback_server():
    """ì½œë°± ì„œë²„ ì‹œì‘"""
    app.run(host=CALLBACK_HOST, port=CALLBACK_PORT, threaded=True, use_reloader=False)


# ============== API í˜¸ì¶œ ==============
def parse_drm_excel(
    token: str,
    file_seq: str,
    file_name: str,
    file_ext: str = "xlsx",
    file_size: int = 0,
    header_type: int = 1,
    header_row: int = 1,
    start_row: int = 2,
    callback_url: str = None,
    request_user: str = ""
):
    """ë‹¨ì¼ ì‹œíŠ¸ íŒŒì‹±"""
    if callback_url is None:
        callback_url = f"http://localhost:{CALLBACK_PORT}/callback"
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }
    
    payload = {
        "file": {
            "down": f"{CDN_BASE}/down/file/{file_seq}",
            "fileExt": file_ext,
            "fileName": file_name,
            "fileSize": file_size,
            "fileType": 1,
            "link": f"{CDN_BASE}/img/icon/{file_ext}",
            "seq": file_seq,
            "size": file_size
        },
        "header": {
            "headerType": header_type,
            "headerRow": header_row,
            "headerNames": []
        },
        "startRow": start_row,
        "returnType": "json",
        "callbackUrl": callback_url,
        "requestUser": request_user
    }
    
    print(f"\nğŸ“¤ API í˜¸ì¶œ: {API_URL_SINGLE}")
    print(f"   íŒŒì¼: {file_name} (seq: {file_seq})")
    
    response = requests.post(API_URL_SINGLE, json=payload, headers=headers)
    print(f"   ì‘ë‹µ: {response.status_code}")
    
    return response


def parse_drm_excel_multi(
    token: str,
    file_seq: str,
    file_name: str,
    sheets_config: list,
    file_ext: str = "xlsx",
    file_size: int = 0,
    callback_url: str = None,
    request_user: str = ""
):
    """
    ë‹¤ì¤‘ ì‹œíŠ¸ íŒŒì‹±
    
    sheets_config ì˜ˆì‹œ:
    [
        {"sheet_index": 0, "header_row": 1, "start_row": 2, "calculate": True},
        {"sheet_index": 1, "header_row": 1, "start_row": 2, "calculate": False},
    ]
    """
    if callback_url is None:
        callback_url = f"http://localhost:{CALLBACK_PORT}/callback"
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }
    
    sheets = []
    for cfg in sheets_config:
        sheet = {
            "header": {
                "headerType": cfg.get("header_type", 1),
                "headerRow": cfg.get("header_row", 1),
                "headerNames": cfg.get("header_names", []),
                "parseType": cfg.get("parse_type", 1),
                "sheetIndex": cfg.get("sheet_index", 0)
            },
            "calculate": cfg.get("calculate", False),
            "startRow": cfg.get("start_row", 2)
        }
        sheets.append(sheet)
    
    payload = {
        "file": {
            "down": f"{CDN_BASE}/down/file/{file_seq}",
            "fileExt": file_ext,
            "fileName": file_name,
            "fileSize": file_size,
            "fileType": 1,
            "link": f"{CDN_BASE}/img/icon/{file_ext}",
            "seq": file_seq,
            "size": file_size
        },
        "sheets": sheets,
        "returnType": "json",
        "callbackUrl": callback_url,
        "requestUser": request_user
    }
    
    print(f"\nğŸ“¤ ë‹¤ì¤‘ì‹œíŠ¸ API í˜¸ì¶œ: {API_URL_MULTI}")
    print(f"   íŒŒì¼: {file_name} (seq: {file_seq})")
    print(f"   ì‹œíŠ¸ ìˆ˜: {len(sheets)}")
    
    response = requests.post(API_URL_MULTI, json=payload, headers=headers)
    print(f"   ì‘ë‹µ: {response.status_code}")
    
    return response


# ============== ë©”ì¸ ==============
if __name__ == "__main__":
    print("="*60)
    print("SKí•˜ì´ë‹‰ìŠ¤ DRM Excel Export API")
    print("="*60)
    
    # 1. í† í° ë¡œë“œ
    token = load_token()
    if not token:
        exit(1)
    
    # 2. ì½œë°± ì„œë²„ ì‹œì‘
    print(f"\nğŸš€ ì½œë°± ì„œë²„ ì‹œì‘ (port {CALLBACK_PORT})...")
    server_thread = threading.Thread(target=start_callback_server, daemon=True)
    server_thread.start()
    time.sleep(1)
    
    # 3. ì„¤ì •ê°’ (ìˆ˜ì • í•„ìš”)
    print("\n" + "-"*60)
    print("âš ï¸  ì•„ë˜ ê°’ë“¤ì„ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”")
    print("-"*60)
    
    FILE_SEQ = "YOUR_FILE_SEQ"       # CDN ì—…ë¡œë“œ í›„ ë°›ì€ seq
    FILE_NAME = "your_file.xlsx"     # íŒŒì¼ëª…
    FILE_SIZE = 0                    # íŒŒì¼ í¬ê¸°
    REQUEST_USER = "X0000000"        # ì‚¬ì›ë²ˆí˜¸
    
    # ì½œë°± URL (ì‚¬ë‚´ë§ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì£¼ì†Œë¡œ ë³€ê²½)
    CALLBACK_URL = f"http://localhost:{CALLBACK_PORT}/callback"
    
    if FILE_SEQ == "YOUR_FILE_SEQ":
        print("\nâŒ FILE_SEQë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í›„ ì‹¤í–‰í•˜ì„¸ìš”!")
        print("\n[ì‚¬ìš©ë²•]")
        print("1. TOKEN.TXTì— API í† í° ì…ë ¥")
        print("2. CDNì— Excel íŒŒì¼ ì—…ë¡œë“œ â†’ seq ê°’ íšë“")
        print("3. FILE_SEQ, FILE_NAME, REQUEST_USER ìˆ˜ì •")
        print("4. CALLBACK_URLì„ ì‚¬ë‚´ë§ ì ‘ê·¼ ê°€ëŠ¥í•œ ì£¼ì†Œë¡œ ë³€ê²½")
        print("5. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰")
    else:
        # ë‹¨ì¼ ì‹œíŠ¸ í˜¸ì¶œ ì˜ˆì‹œ
        response = parse_drm_excel(
            token=token,
            file_seq=FILE_SEQ,
            file_name=FILE_NAME,
            file_size=FILE_SIZE,
            header_type=1,
            header_row=1,
            start_row=2,
            callback_url=CALLBACK_URL,
            request_user=REQUEST_USER
        )
        
        print(f"\nì‘ë‹µ: {response.text}")
        
        # ê²°ê³¼ ëŒ€ê¸°
        print("\nâ³ ê²°ê³¼ ëŒ€ê¸° ì¤‘... (Ctrl+C ì¢…ë£Œ)")
        try:
            while result_data is None:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\nì¢…ë£Œ")