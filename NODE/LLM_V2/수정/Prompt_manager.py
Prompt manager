#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
프롬프트 관리 + 컨텍스트 관리 모듈
"""

import os
import logging

logger = logging.getLogger(__name__)

# ========================================
# 프롬프트 저장소
# ========================================
prompts = {
    "system_local": "",
    "fewshot_local": "",
    "system_api": "",
    "fewshot_api": ""
}

# 대화 컨텍스트
conversation_history = []

# ========================================
# 프롬프트 로드/저장
# ========================================
def load_prompts():
    """파일에서 프롬프트 로드"""
    global prompts
    
    files = {
        "system_local": "AMHS_LOG_ANALYSIS_SYSTEM_PROMPT_LOCAL.md",
        "fewshot_local": "AMHS_LOG_ANALYSIS_FEWSHOT_PROMPT_LOCAL.md",
        "system_api": "AMHS_LOG_ANALYSIS_SYSTEM_PROMPT.md",
        "fewshot_api": "AMHS_LOG_ANALYSIS_FEWSHOT_PROMPT.md"
    }
    
    for key, filename in files.items():
        try:
            with open(filename, "r", encoding="utf-8") as f:
                prompts[key] = f.read()
            logger.info(f"✅ {filename} 로드 완료")
        except Exception as e:
            logger.warning(f"⚠️ {filename} 로드 실패: {e}")
            prompts[key] = ""

def save_prompts_to_file():
    """프롬프트를 파일에 저장"""
    files = {
        "system_local": "AMHS_LOG_ANALYSIS_SYSTEM_PROMPT_LOCAL.md",
        "fewshot_local": "AMHS_LOG_ANALYSIS_FEWSHOT_PROMPT_LOCAL.md",
        "system_api": "AMHS_LOG_ANALYSIS_SYSTEM_PROMPT.md",
        "fewshot_api": "AMHS_LOG_ANALYSIS_FEWSHOT_PROMPT.md"
    }
    
    for key, filename in files.items():
        try:
            with open(filename, "w", encoding="utf-8") as f:
                f.write(prompts[key])
            logger.info(f"✅ {filename} 저장 완료")
        except Exception as e:
            logger.error(f"❌ {filename} 저장 실패: {e}")
            raise e

def get_prompts():
    """현재 프롬프트 반환"""
    return prompts.copy()

def set_prompts(new_prompts: dict):
    """프롬프트 설정 (메모리)"""
    global prompts
    for key in prompts:
        if key in new_prompts:
            prompts[key] = new_prompts[key]

def get_system_prompt(mode: str) -> str:
    """모드에 맞는 시스템 프롬프트 반환"""
    if mode == "local":
        return prompts["system_local"]
    return prompts["system_api"]

def get_fewshot_prompt(mode: str) -> str:
    """모드에 맞는 Few-shot 프롬프트 반환"""
    if mode == "local":
        return prompts["fewshot_local"]
    return prompts["fewshot_api"]

def get_full_prompt(mode: str) -> str:
    """시스템 + Few-shot 합친 전체 프롬프트"""
    return get_system_prompt(mode) + "\n\n" + get_fewshot_prompt(mode)

# ========================================
# 컨텍스트 관리
# ========================================
def add_to_history(role: str, content: str):
    """대화 히스토리에 추가"""
    conversation_history.append({"role": role, "content": content})

def get_history(limit: int = None):
    """대화 히스토리 반환"""
    if limit:
        return conversation_history[-limit:]
    return conversation_history.copy()

def reset_history():
    """대화 히스토리 초기화"""
    global conversation_history
    count = len(conversation_history)
    conversation_history = []
    return count

def get_context_status():
    """컨텍스트 상태 반환"""
    total_chars = sum(len(m.get("content", "")) for m in conversation_history)
    return {
        "message_count": len(conversation_history),
        "total_characters": total_chars,
        "estimated_tokens": total_chars // 4
    }