#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
STAR DB ë¬¸ì„œ ê²€ìƒ‰ ëª¨ë“ˆ
MD ë¬¸ì„œë¥¼ ì„¹ì…˜ë³„ë¡œ íŒŒì‹±í•˜ì—¬ í‚¤ì›Œë“œ ê²€ìƒ‰ â†’ LLM ì»¨í…ìŠ¤íŠ¸ ì œê³µ
"""

import os
import re
import logging
from typing import Optional, Dict, Tuple

logger = logging.getLogger(__name__)

# ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ ê¸°ì¤€ ê²½ë¡œ
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
MD_PATH = os.path.join(SCRIPT_DIR, 'STAR_READ.md')

# ì „ì—­ ë³€ìˆ˜
_sections = None
_raw_content = None


def load_md() -> bool:
    """MD íŒŒì¼ ë¡œë“œ ë° ì„¹ì…˜ íŒŒì‹±"""
    global _sections, _raw_content
    
    if not os.path.exists(MD_PATH):
        logger.error(f"âŒ MD íŒŒì¼ ì—†ìŒ: {MD_PATH}")
        return False
    
    try:
        with open(MD_PATH, 'r', encoding='utf-8') as f:
            _raw_content = f.read()
        
        _sections = parse_sections(_raw_content)
        logger.info(f"âœ… MD ë¡œë“œ ì™„ë£Œ: {len(_sections)}ê°œ ì„¹ì…˜")
        return True
    except Exception as e:
        logger.error(f"âŒ MD ë¡œë“œ ì‹¤íŒ¨: {e}")
        return False


def parse_sections(content: str) -> Dict[str, str]:
    """MD ë‚´ìš©ì„ ì„¹ì…˜ë³„ë¡œ íŒŒì‹±"""
    sections = {}
    
    # ì „ì²´ ë¬¸ì„œ
    sections['ì „ì²´'] = content
    
    # ê³µí†µ ê³„ì •
    account_match = re.search(r'(## ê³µí†µ ê³„ì •.*?)(?=---|\Z)', content, re.DOTALL)
    if account_match:
        sections['ê³„ì •'] = account_match.group(1).strip()
    
    # ì²­ì£¼ ì „ì²´
    cheongju_match = re.search(r'(## ì²­ì£¼.*?)(?=## ì´ì²œ|---\s*## í•œëˆˆ|\Z)', content, re.DOTALL)
    if cheongju_match:
        cheongju_content = cheongju_match.group(1).strip()
        sections['ì²­ì£¼_ì „ì²´'] = cheongju_content
        
        # ì²­ì£¼ ìš´ì˜
        cj_prod_match = re.search(r'(### ìš´ì˜ í™˜ê²½.*?)(?=### QA|\Z)', cheongju_content, re.DOTALL)
        if cj_prod_match:
            sections['ì²­ì£¼_ìš´ì˜'] = "## ì²­ì£¼ ìš´ì˜ í™˜ê²½\n\n" + cj_prod_match.group(1).strip()
        
        # ì²­ì£¼ QA
        cj_qa_match = re.search(r'(### QA í™˜ê²½.*?)(?=---|\Z)', cheongju_content, re.DOTALL)
        if cj_qa_match:
            sections['ì²­ì£¼_QA'] = "## ì²­ì£¼ QA í™˜ê²½\n\n" + cj_qa_match.group(1).strip()
    
    # ì´ì²œ ì „ì²´
    icheon_match = re.search(r'(## ì´ì²œ.*?)(?=---\s*## í•œëˆˆ|\Z)', content, re.DOTALL)
    if icheon_match:
        icheon_content = icheon_match.group(1).strip()
        sections['ì´ì²œ_ì „ì²´'] = icheon_content
        
        # ì´ì²œ ìš´ì˜
        ic_prod_match = re.search(r'(### ìš´ì˜ í™˜ê²½.*?)(?=### QA|\Z)', icheon_content, re.DOTALL)
        if ic_prod_match:
            sections['ì´ì²œ_ìš´ì˜'] = "## ì´ì²œ ìš´ì˜ í™˜ê²½\n\n" + ic_prod_match.group(1).strip()
        
        # ì´ì²œ QA
        ic_qa_match = re.search(r'(### QA í™˜ê²½.*?)(?=---|\Z)', icheon_content, re.DOTALL)
        if ic_qa_match:
            sections['ì´ì²œ_QA'] = "## ì´ì²œ QA í™˜ê²½\n\n" + ic_qa_match.group(1).strip()
    
    # í•œëˆˆì— ë³´ê¸°
    summary_match = re.search(r'(## í•œëˆˆì— ë³´ê¸°.*?)(?=---|\Z)', content, re.DOTALL)
    if summary_match:
        sections['ìš”ì•½'] = summary_match.group(1).strip()
    
    # Failover
    failover_match = re.search(r'(## Failover.*?)(?=---|\Z)', content, re.DOTALL)
    if failover_match:
        sections['Failover'] = failover_match.group(1).strip()
    
    return sections


def find_section(query: str) -> Tuple[str, str]:
    """ì¿¼ë¦¬ì—ì„œ ê´€ë ¨ ì„¹ì…˜ ì°¾ê¸°"""
    global _sections
    
    if _sections is None:
        load_md()
    
    if not _sections:
        return None, ""
    
    query_lower = query.lower()
    
    # ì‚¬ì´íŠ¸ + í™˜ê²½ ì¡°í•©
    is_cheongju = any(k in query_lower for k in ['ì²­ì£¼', 'cheongju', 'cj'])
    is_icheon = any(k in query_lower for k in ['ì´ì²œ', 'icheon', 'ic'])
    is_qa = any(k in query_lower for k in ['qa', 'í…ŒìŠ¤íŠ¸', 'test'])
    is_prod = any(k in query_lower for k in ['ìš´ì˜', 'prod', 'ì‹¤ì„œë²„'])
    
    # ê³µí†µ ê³„ì • ì •ë³´ (í•­ìƒ í¬í•¨)
    account_info = _sections.get('ê³„ì •', '')
    
    # ì§ì ‘ ë§¤í•‘
    if is_cheongju and is_qa:
        section = _sections.get('ì²­ì£¼_QA', '')
        return 'ì²­ì£¼_QA', account_info + "\n\n---\n\n" + section
    elif is_cheongju and (is_prod or not is_qa):
        section = _sections.get('ì²­ì£¼_ìš´ì˜', '')
        return 'ì²­ì£¼_ìš´ì˜', account_info + "\n\n---\n\n" + section
    elif is_icheon and is_qa:
        section = _sections.get('ì´ì²œ_QA', '')
        return 'ì´ì²œ_QA', account_info + "\n\n---\n\n" + section
    elif is_icheon and (is_prod or not is_qa):
        section = _sections.get('ì´ì²œ_ìš´ì˜', '')
        return 'ì´ì²œ_ìš´ì˜', account_info + "\n\n---\n\n" + section
    
    # ê¸°íƒ€ í‚¤ì›Œë“œ
    if any(k in query_lower for k in ['ê³„ì •', 'ë¹„ë°€ë²ˆí˜¸', 'password', 'user']):
        return 'ê³„ì •', _sections.get('ê³„ì •', '')
    
    if any(k in query_lower for k in ['failover', 'íŽ˜ì¼ì˜¤ë²„', 'ìž¥ì• ', 'ìž¬ì‹œë„']):
        return 'Failover', _sections.get('Failover', '')
    
    # ê¸°ë³¸ê°’: ìš”ì•½ (í•œëˆˆì— ë³´ê¸°)
    return 'ìš”ì•½', account_info + "\n\n---\n\n" + _sections.get('ìš”ì•½', '')


def search(query: str) -> Tuple[Optional[str], str]:
    """
    STAR DB ë¬¸ì„œ ê²€ìƒ‰ (ë©”ì¸ í•¨ìˆ˜)
    
    Returns:
        (ì„¹ì…˜í‚¤, ì„¹ì…˜ë‚´ìš©)
    """
    global _sections
    
    if _sections is None:
        if not load_md():
            return None, "âŒ STAR_READ.md íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    section_key, section_content = find_section(query)
    
    if not section_content:
        return None, "âŒ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    return section_key, section_content


def get_context_for_llm(query: str) -> str:
    """LLMì— ì „ë‹¬í•  ì»¨í…ìŠ¤íŠ¸ ë°˜í™˜"""
    section_key, section_content = find_section(query)
    return section_content


def is_star_query(query: str) -> bool:
    """STAR DB ê´€ë ¨ ì¿¼ë¦¬ì¸ì§€ íŒë‹¨"""
    keywords = [
        'star', 'ìŠ¤íƒ€', 'db', 'ë°ì´í„°ë² ì´ìŠ¤', 'ì ‘ì†', 'tns', 
        'ì²­ì£¼', 'ì´ì²œ', 'cheongju', 'icheon',
        'oracle', 'ì˜¤ë¼í´', 'connection', 'ì—°ê²°',
        'staread', 'fc1star', 'icastar'
    ]
    query_lower = query.lower()
    return any(k in query_lower for k in keywords)


# í…ŒìŠ¤íŠ¸
if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    print("\n" + "=" * 60)
    print("STAR DB ë¬¸ì„œ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    test_queries = [
        "ì²­ì£¼ ìš´ì˜ ì ‘ì†ì •ë³´",
        "ì²­ì£¼ QA",
        "ì´ì²œ ìš´ì˜",
        "ì´ì²œ qa",
        "ì „ì²´ ëª©ë¡",
        "ê³„ì • ì •ë³´"
    ]
    
    for q in test_queries:
        print(f"\nðŸ” ì¿¼ë¦¬: {q}")
        print("-" * 40)
        key, text = search(q)
        print(f"ì„¹ì…˜: {key}")
        print(text[:300] + "..." if len(text) > 300 else text)