import pandas as pd
import os
from datetime import datetime

def split_csv_by_date(input_file, output_folder='output_by_date'):
    """
    CSV íŒŒì¼ì„ CURRTIME ì»¬ëŸ¼ì˜ ë‚ ì§œë³„ë¡œ ë¶„ë¦¬í•˜ëŠ” í•¨ìˆ˜
    
    Parameters:
    -----------
    input_file : str
        ì…ë ¥ CSV íŒŒì¼ ê²½ë¡œ
    output_folder : str
        ì¶œë ¥ í´ë” ê²½ë¡œ (ê¸°ë³¸ê°’: 'output_by_date')
    """
    
    # CSV íŒŒì¼ ì½ê¸°
    try:
        df = pd.read_csv(input_file)
        print(f"âœ… CSV íŒŒì¼ ì½ê¸° ì™„ë£Œ: {input_file}")
        print(f"   ì´ {len(df)}ê°œ í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")
    except FileNotFoundError:
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {input_file}")
        return
    except Exception as e:
        print(f"âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {e}")
        return
    
    # CURRTIME ì»¬ëŸ¼ í™•ì¸
    if 'CURRTIME' not in df.columns:
        print("âŒ CURRTIME ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        print(f"   ì‚¬ìš© ê°€ëŠ¥í•œ ì»¬ëŸ¼: {', '.join(df.columns)}")
        return
    
    # ì¶œë ¥ í´ë” ìƒì„±
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)
        print(f"ğŸ“ ì¶œë ¥ í´ë” ìƒì„±: {output_folder}")
    
    # CURRTIMEì„ datetimeìœ¼ë¡œ ë³€í™˜
    try:
        # ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ì„ ìë™ìœ¼ë¡œ íŒŒì‹±
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'])
    except Exception as e:
        print(f"âš ï¸ ë‚ ì§œ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ, ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤: {e}")
    
    # ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì‹œê°„ ì œê±°)
    if pd.api.types.is_datetime64_any_dtype(df['CURRTIME']):
        df['date_only'] = df['CURRTIME'].dt.date
    else:
        # ë¬¸ìì—´ì¸ ê²½ìš° ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ ì‹œë„
        df['date_only'] = df['CURRTIME'].apply(lambda x: str(x).split(' ')[0] if pd.notna(x) else 'unknown')
    
    # ê³ ìœ í•œ ë‚ ì§œ ëª©ë¡
    unique_dates = df['date_only'].unique()
    print(f"\nğŸ“… ë°œê²¬ëœ ë‚ ì§œ: {len(unique_dates)}ê°œ")
    
    # ë‚ ì§œë³„ë¡œ íŒŒì¼ ë¶„ë¦¬ ë° ì €ì¥
    for date in unique_dates:
        # í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ë§Œ í•„í„°ë§
        date_df = df[df['date_only'] == date].copy()
        
        # ì„ì‹œ ì»¬ëŸ¼ ì œê±°
        date_df = date_df.drop('date_only', axis=1)
        
        # íŒŒì¼ëª… ìƒì„± (ì•ˆì „í•œ íŒŒì¼ëª…ì„ ìœ„í•´ íŠ¹ìˆ˜ë¬¸ì ì œê±°)
        safe_date = str(date).replace('/', '-').replace(':', '-')
        output_file = os.path.join(output_folder, f'data_{safe_date}.csv')
        
        # CSVë¡œ ì €ì¥
        date_df.to_csv(output_file, index=False)
        print(f"   âœ… {safe_date}: {len(date_df)}ê°œ í–‰ â†’ {output_file}")
    
    print(f"\nğŸ‰ ì™„ë£Œ! ì´ {len(unique_dates)}ê°œ íŒŒì¼ë¡œ ë¶„ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print(f"   ì¶œë ¥ í´ë”: {output_folder}")


def analyze_csv_dates(input_file):
    """
    CSV íŒŒì¼ì˜ CURRTIME ì»¬ëŸ¼ì„ ë¶„ì„í•˜ëŠ” í•¨ìˆ˜
    
    Parameters:
    -----------
    input_file : str
        ì…ë ¥ CSV íŒŒì¼ ê²½ë¡œ
    """
    
    # CSV íŒŒì¼ ì½ê¸°
    try:
        df = pd.read_csv(input_file)
        print(f"ğŸ“Š CSV íŒŒì¼ ë¶„ì„: {input_file}")
        print(f"   ì´ í–‰ ìˆ˜: {len(df)}")
        print(f"   ì»¬ëŸ¼: {', '.join(df.columns)}")
    except Exception as e:
        print(f"âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {e}")
        return
    
    if 'CURRTIME' not in df.columns:
        print("âŒ CURRTIME ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # CURRTIME ìƒ˜í”Œ ì¶œë ¥
    print(f"\nğŸ“… CURRTIME ìƒ˜í”Œ (ì²˜ìŒ 5ê°œ):")
    for i, val in enumerate(df['CURRTIME'].head()):
        print(f"   {i+1}. {val}")
    
    # ë‚ ì§œ í˜•ì‹ ë¶„ì„
    try:
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'])
        
        print(f"\nğŸ“ˆ ë‚ ì§œ ë²”ìœ„:")
        print(f"   ì‹œì‘: {df['CURRTIME'].min()}")
        print(f"   ì¢…ë£Œ: {df['CURRTIME'].max()}")
        
        # ë‚ ì§œë³„ ë°ì´í„° ê°œìˆ˜
        date_counts = df['CURRTIME'].dt.date.value_counts().sort_index()
        print(f"\nğŸ“Š ë‚ ì§œë³„ ë°ì´í„° ê°œìˆ˜:")
        for date, count in date_counts.items():
            print(f"   {date}: {count}ê°œ")
            
    except Exception as e:
        print(f"\nâš ï¸ ë‚ ì§œ í˜•ì‹ ìë™ íŒŒì‹± ì‹¤íŒ¨: {e}")
        print("   ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.")
        
        # ë¬¸ìì—´ë¡œ ë‚ ì§œ ì¶”ì¶œ ì‹œë„
        df['date_only'] = df['CURRTIME'].apply(lambda x: str(x).split(' ')[0] if pd.notna(x) else 'unknown')
        date_counts = df['date_only'].value_counts().sort_index()
        
        print(f"\nğŸ“Š ë‚ ì§œë³„ ë°ì´í„° ê°œìˆ˜ (ë¬¸ìì—´ ê¸°ì¤€):")
        for date, count in date_counts.items():
            print(f"   {date}: {count}ê°œ")


# ì‚¬ìš© ì˜ˆì œ
if __name__ == "__main__":
    # ì…ë ¥ íŒŒì¼ ê²½ë¡œ ì„¤ì •
    input_csv = "your_file.csv"  # ì—¬ê¸°ì— ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”
    
    # ì˜µì…˜ 1: CSV ë¶„ì„ë§Œ ìˆ˜í–‰
    print("=" * 50)
    print("1. CSV íŒŒì¼ ë¶„ì„")
    print("=" * 50)
    analyze_csv_dates(input_csv)
    
    # ì˜µì…˜ 2: ë‚ ì§œë³„ë¡œ íŒŒì¼ ë¶„ë¦¬
    print("\n" + "=" * 50)
    print("2. ë‚ ì§œë³„ íŒŒì¼ ë¶„ë¦¬")
    print("=" * 50)
    split_csv_by_date(input_csv, output_folder='split_by_date')
    
    # ì˜µì…˜ 3: íŠ¹ì • ë‚ ì§œ í˜•ì‹ì´ ìˆëŠ” ê²½ìš° (ì˜ˆ: YYYYMMDD)
    # í•„ìš”ì‹œ ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì§œ í˜•ì‹ì„ ëª…ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    """
    df = pd.read_csv(input_csv)
    # íŠ¹ì • í˜•ì‹ìœ¼ë¡œ íŒŒì‹± (ì˜ˆ: 20240101 í˜•ì‹)
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'], format='%Y%m%d')
    """