"""
TOTALCNT ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶„ì„
ê³¼ê±° 20ë¶„ ë™ì•ˆ 1700 ì´í•˜ â†’ 10ë¶„ í›„ 1700ê°œ ì´ìƒ ê¸‰ì¦ ì¼€ì´ìŠ¤ ì¶”ì¶œ
"""

import pandas as pd
import numpy as np
from datetime import datetime
import matplotlib.pyplot as plt

# í•œê¸€ í°íŠ¸ ì„¤ì •
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# ============================================
# 1. ë°ì´í„° ë¡œë“œ
# ============================================
print("="*60)
print("ğŸ” TOTALCNT ê¸‰ì¦ ì¼€ì´ìŠ¤ ë¶„ì„ (1700ê°œ ê¸°ì¤€)")
print("="*60)

# CSV íŒŒì¼ ì½ê¸°
print("\nğŸ“‚ ë°ì´í„° ë¡œë”© ì¤‘...")
df = pd.read_csv('20250807_DATA.CSV')
print(f"âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df):,}í–‰")

# ì‹œê°„ ë³€í™˜
df['datetime'] = pd.to_datetime(df['TIME'], format='%Y%m%d%H%M')
df = df.sort_values('datetime').reset_index(drop=True)

print(f"\nğŸ“… ë°ì´í„° ì •ë³´:")
print(f"  ê¸°ê°„: {df['datetime'].min()} ~ {df['datetime'].max()}")
print(f"  TOTALCNT ë²”ìœ„: {df['TOTALCNT'].min()} ~ {df['TOTALCNT'].max()}")

# ============================================
# 2. ê¸‰ì¦ ì¼€ì´ìŠ¤ ì°¾ê¸°
# ============================================
print("\nğŸ” ê¸‰ì¦ ì¼€ì´ìŠ¤ ê²€ìƒ‰ ì¤‘...")
print("  ì¡°ê±´: ê³¼ê±° 20ë¶„ ëª¨ë‘ < 1700 AND 10ë¶„ í›„ >= 1700")

spike_cases = []

# ë°ì´í„°ê°€ 1ë¶„ ë‹¨ìœ„ì¸ì§€ í™•ì¸
time_diff = (df['datetime'].iloc[1] - df['datetime'].iloc[0]).total_seconds() / 60
print(f"  ë°ì´í„° ê°„ê²©: {time_diff}ë¶„")

# ê° ì‹œì  ê²€ì‚¬
for i in range(20, len(df) - 10):
    # ê³¼ê±° 20ë¶„ (í˜„ì¬ í¬í•¨ 21ê°œ ë°ì´í„°)
    past_20min_values = df.iloc[i-20:i+1]['TOTALCNT'].values
    
    # 10ë¶„ í›„
    future_value = df.iloc[i+10]['TOTALCNT']
    
    # ì¡°ê±´ ì²´í¬
    if all(past_20min_values < 1700) and future_value >= 1700:
        spike_cases.append({
            'index': i,
            'time': df.iloc[i]['datetime'],
            'current_TOTALCNT': df.iloc[i]['TOTALCNT'],
            'past_20min_max': max(past_20min_values),
            'past_20min_min': min(past_20min_values),
            'past_20min_avg': np.mean(past_20min_values),
            'future_10min_TOTALCNT': future_value,
            'spike_amount': future_value - df.iloc[i]['TOTALCNT'],
            'spike_rate': ((future_value - df.iloc[i]['TOTALCNT']) / df.iloc[i]['TOTALCNT'] * 100),
            'M14AM14B': df.iloc[i]['M14AM14B'],
            'M14AM10A': df.iloc[i]['M14AM10A'],
            'M14AM16': df.iloc[i]['M14AM16'],
            'M14BM14A': df.iloc[i]['M14BM14A'],
            'M16M14A': df.iloc[i]['M16M14A']
        })

# ============================================
# 3. ê²°ê³¼ ì¶œë ¥
# ============================================
print(f"\nâœ… ê²€ìƒ‰ ì™„ë£Œ!")
print(f"ğŸ¯ ì´ ê¸‰ì¦ ì¼€ì´ìŠ¤: {len(spike_cases)}ê±´")

if spike_cases:
    spike_df = pd.DataFrame(spike_cases)
    
    print("\nğŸ“Š ê¸‰ì¦ í†µê³„:")
    print(f"  í‰ê·  ê¸‰ì¦ëŸ‰: {spike_df['spike_amount'].mean():.0f}ê°œ")
    print(f"  ìµœëŒ€ ê¸‰ì¦ëŸ‰: {spike_df['spike_amount'].max():.0f}ê°œ")
    print(f"  í‰ê·  ê¸‰ì¦ë¥ : {spike_df['spike_rate'].mean():.1f}%")
    print(f"  ìµœëŒ€ ê¸‰ì¦ë¥ : {spike_df['spike_rate'].max():.1f}%")
    
    # ============================================
    # 4. ìƒìœ„ 10ê°œ ì¼€ì´ìŠ¤ ìƒì„¸
    # ============================================
    print("\nğŸ” ê¸‰ì¦ëŸ‰ ìƒìœ„ 10ê°œ ì¼€ì´ìŠ¤:")
    print("-"*120)
    print(f"{'No':>3} | {'ì‹œê°„':^20} | {'í˜„ì¬':>6} | {'20ë¶„ìµœëŒ€':>8} | {'10ë¶„í›„':>7} | {'ê¸‰ì¦ëŸ‰':>7} | {'ê¸‰ì¦ë¥ ':>7} | {'M14AM14B':>8} | {'M14AM10A':>8}")
    print("-"*120)
    
    top_10 = spike_df.nlargest(10, 'spike_amount')
    for idx, (_, row) in enumerate(top_10.iterrows(), 1):
        print(f"{idx:3d} | {row['time'].strftime('%Y-%m-%d %H:%M')} | "
              f"{row['current_TOTALCNT']:6,d} | {row['past_20min_max']:8,d} | "
              f"{row['future_10min_TOTALCNT']:7,d} | {row['spike_amount']:+7,d} | "
              f"{row['spike_rate']:6.1f}% | {row['M14AM14B']:8.0f} | {row['M14AM10A']:8.0f}")
    
    # ============================================
    # 5. M14 ì»¬ëŸ¼ ë¶„ì„
    # ============================================
    print("\nğŸ“Š ê¸‰ì¦ ì‹œì ì˜ M14 ì»¬ëŸ¼ íŠ¹ì„±:")
    print(f"  M14AM14B í‰ê· : {spike_df['M14AM14B'].mean():.1f} (ì „ì²´ í‰ê· : {df['M14AM14B'].mean():.1f})")
    print(f"  M14AM10A í‰ê· : {spike_df['M14AM10A'].mean():.1f} (ì „ì²´ í‰ê· : {df['M14AM10A'].mean():.1f})")
    
    # M14AM14B êµ¬ê°„ë³„ ë¶„í¬
    print("\n  M14AM14B êµ¬ê°„ë³„ ê¸‰ì¦ ì¼€ì´ìŠ¤:")
    for low, high in [(0, 300), (300, 350), (350, 400), (400, 450), (450, 1000)]:
        count = ((spike_df['M14AM14B'] >= low) & (spike_df['M14AM14B'] < high)).sum()
        if count > 0:
            print(f"    {low:3d}~{high:3d}: {count:3d}ê±´ ({count/len(spike_df)*100:5.1f}%)")
    
    # M14B/M14A ë¹„ìœ¨ ë¶„ì„
    spike_df['ratio_M14B_M14A'] = spike_df['M14AM14B'] / spike_df['M14AM10A'].clip(lower=1)
    print(f"\n  M14B/M14A ë¹„ìœ¨ í‰ê· : {spike_df['ratio_M14B_M14A'].mean():.2f}")
    
    # ============================================
    # 6. ì‹œê°í™”
    # ============================================
    fig, axes = plt.subplots(2, 3, figsize=(18, 10))
    fig.suptitle('TOTALCNT ê¸‰ì¦ íŒ¨í„´ ë¶„ì„ (ê³¼ê±° 20ë¶„ <1700 â†’ 10ë¶„ í›„ â‰¥1700)', fontsize=16)
    
    # 1. ê¸‰ì¦ëŸ‰ íˆìŠ¤í† ê·¸ë¨
    ax = axes[0, 0]
    ax.hist(spike_df['spike_amount'], bins=15, edgecolor='black', color='skyblue')
    ax.axvline(spike_df['spike_amount'].mean(), color='red', linestyle='--', 
               label=f'í‰ê· : {spike_df["spike_amount"].mean():.0f}')
    ax.set_title('ê¸‰ì¦ëŸ‰ ë¶„í¬')
    ax.set_xlabel('ê¸‰ì¦ëŸ‰ (ê°œ)')
    ax.set_ylabel('ë¹ˆë„')
    ax.legend()
    
    # 2. M14AM14B vs ê¸‰ì¦ëŸ‰ ì‚°ì ë„
    ax = axes[0, 1]
    scatter = ax.scatter(spike_df['M14AM14B'], spike_df['spike_amount'], 
                        c=spike_df['spike_rate'], cmap='Reds', alpha=0.7)
    ax.set_title('M14AM14B vs ê¸‰ì¦ëŸ‰')
    ax.set_xlabel('M14AM14B')
    ax.set_ylabel('ê¸‰ì¦ëŸ‰ (ê°œ)')
    plt.colorbar(scatter, ax=ax, label='ê¸‰ì¦ë¥ (%)')
    
    # 3. ì‹œê°„ëŒ€ë³„ ë°œìƒ ë¹ˆë„
    ax = axes[0, 2]
    spike_df['hour'] = spike_df['time'].dt.hour
    hour_counts = spike_df['hour'].value_counts().sort_index()
    ax.bar(hour_counts.index, hour_counts.values, color='orange', edgecolor='black')
    ax.set_title('ì‹œê°„ëŒ€ë³„ ê¸‰ì¦ ë°œìƒ')
    ax.set_xlabel('ì‹œê°„ëŒ€')
    ax.set_ylabel('ë°œìƒ íšŸìˆ˜')
    ax.set_xticks(range(0, 24, 2))
    
    # 4. M14B/M14A ë¹„ìœ¨ vs ê¸‰ì¦ë¥ 
    ax = axes[1, 0]
    ax.scatter(spike_df['ratio_M14B_M14A'], spike_df['spike_rate'], alpha=0.7, color='green')
    ax.axvline(4, color='red', linestyle='--', label='ë¹„ìœ¨=4')
    ax.set_title('M14B/M14A ë¹„ìœ¨ vs ê¸‰ì¦ë¥ ')
    ax.set_xlabel('M14AM14B / M14AM10A')
    ax.set_ylabel('ê¸‰ì¦ë¥  (%)')
    ax.legend()
    
    # 5. í˜„ì¬ê°’ vs 10ë¶„í›„ê°’
    ax = axes[1, 1]
    ax.scatter(spike_df['current_TOTALCNT'], spike_df['future_10min_TOTALCNT'], alpha=0.7)
    ax.plot([1000, 1700], [1700, 1700], 'r--', label='y=1700')
    ax.plot([1000, 1700], [1000, 1700], 'k--', alpha=0.3, label='y=x')
    ax.set_title('í˜„ì¬ TOTALCNT vs 10ë¶„ í›„ TOTALCNT')
    ax.set_xlabel('í˜„ì¬ TOTALCNT')
    ax.set_ylabel('10ë¶„ í›„ TOTALCNT')
    ax.legend()
    
    # 6. ê¸‰ì¦ ì¼€ì´ìŠ¤ ì‹œê³„ì—´
    ax = axes[1, 2]
    ax.plot(spike_df['time'], spike_df['spike_amount'], 'o-', markersize=4)
    ax.set_title('ê¸‰ì¦ ì¼€ì´ìŠ¤ ì‹œê³„ì—´')
    ax.set_xlabel('ì‹œê°„')
    ax.set_ylabel('ê¸‰ì¦ëŸ‰')
    ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.show()
    
    # ============================================
    # 7. ê²°ê³¼ ì €ì¥
    # ============================================
    output_file = 'TOTALCNT_spike_1700_cases.csv'
    spike_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"\nğŸ’¾ ê²°ê³¼ ì €ì¥: {output_file}")
    
    # ============================================
    # 8. ì˜ˆì¸¡ ê°€ëŠ¥ì„± ë¶„ì„
    # ============================================
    print("\nğŸ¯ ì˜ˆì¸¡ ê°€ëŠ¥ì„± ë¶„ì„:")
    
    # í™©ê¸ˆ íŒ¨í„´ ë¶„ì„
    golden_pattern = spike_df[(spike_df['M14AM14B'] >= 300) & (spike_df['M14AM10A'] < 80)]
    print(f"\n  í™©ê¸ˆ íŒ¨í„´ (M14AM14Bâ‰¥300 & M14AM10A<80): {len(golden_pattern)}ê±´ ({len(golden_pattern)/len(spike_df)*100:.1f}%)")
    
    # M14AM14B ì„ê³„ê°’ë³„ í¬ì°©ë¥ 
    print("\n  M14AM14B ì„ê³„ê°’ë³„ í¬ì°©ë¥ :")
    for threshold in [250, 300, 350, 400]:
        caught = (spike_df['M14AM14B'] >= threshold).sum()
        print(f"    M14AM14B >= {threshold}: {caught}ê±´ ({caught/len(spike_df)*100:.1f}%)")
    
    # ë¹„ìœ¨ ê¸°ë°˜ í¬ì°©ë¥ 
    print("\n  M14B/M14A ë¹„ìœ¨ë³„ í¬ì°©ë¥ :")
    for ratio in [3, 4, 5, 6]:
        caught = (spike_df['ratio_M14B_M14A'] >= ratio).sum()
        print(f"    ë¹„ìœ¨ >= {ratio}: {caught}ê±´ ({caught/len(spike_df)*100:.1f}%)")
    
    print("\n" + "="*60)
    print("âœ… ë¶„ì„ ì™„ë£Œ!")
    print(f"   ì´ {len(spike_cases)}ê±´ì˜ ê¸‰ì¦ ì¼€ì´ìŠ¤ ë°œê²¬")
    print(f"   ê²°ê³¼ íŒŒì¼: {output_file}")
    print("="*60)
    
else:
    print("\nâš ï¸ ì¡°ê±´ì— ë§ëŠ” ê¸‰ì¦ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
    print("   (ê³¼ê±° 20ë¶„ ëª¨ë‘ < 1700 â†’ 10ë¶„ í›„ >= 1700)")