python"""
V8.0 ì‹œê³„ì—´ íŠ¸ë Œë“œ ê¸°ë°˜ ê·¹ë‹¨ê°’ ì˜ˆì¸¡
í•µì‹¬: 100ê°œ ì‹œí€€ìŠ¤ì˜ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ê·¹ë‹¨ê°’ ì˜ˆì¸¡ ì „ëµ ì„ íƒ
"""

class TrendBasedExtremePredictor:
    def __init__(self):
        self.seq_len = 100
        self.extreme_threshold = 1650
        
    def analyze_sequence_trend(self, sequence_data):
        """100ê°œ ì‹œí€€ìŠ¤ì˜ íŠ¸ë Œë“œ ë¶„ì„"""
        # ìµœëŒ€ê°’ í™•ì¸
        max_value = np.max(sequence_data)
        
        # íŠ¸ë Œë“œ ê³„ì‚° (ì„ í˜• íšŒê·€)
        x = np.arange(len(sequence_data))
        z = np.polyfit(x, sequence_data, 1)
        slope = z[0]  # ê¸°ìš¸ê¸°
        
        # ìµœê·¼ 20ê°œ vs ì²˜ìŒ 20ê°œ ë¹„êµ
        recent_mean = np.mean(sequence_data[-20:])
        early_mean = np.mean(sequence_data[:20])
        trend_ratio = recent_mean / early_mean
        
        # ë³€ë™ì„± ê³„ì‚°
        volatility = np.std(sequence_data[-30:])
        
        return {
            'max_value': max_value,
            'slope': slope,
            'trend_ratio': trend_ratio,
            'volatility': volatility,
            'recent_mean': recent_mean
        }
    
    def select_prediction_strategy(self, trend_info, m14b, m14a):
        """íŠ¸ë Œë“œì— ë”°ë¥¸ ì˜ˆì¸¡ ì „ëµ ì„ íƒ"""
        
        max_val = trend_info['max_value']
        slope = trend_info['slope']
        trend_ratio = trend_info['trend_ratio']
        
        # ì¼€ì´ìŠ¤ 1: ê·¹ë‹¨ê°’ ìƒìŠ¹ íŒ¨í„´ (ìµœëŒ€ê°’ 1650+ & ìƒìŠ¹ íŠ¸ë Œë“œ)
        if max_val >= 1650 and slope > 0 and trend_ratio > 1.05:
            return 'EXTREME_UP'
            
        # ì¼€ì´ìŠ¤ 2: ê·¹ë‹¨ê°’ ìœ ì§€ íŒ¨í„´ (ìµœëŒ€ê°’ 1650+ & ì•ˆì •)
        elif max_val >= 1650 and abs(slope) < 1 and 0.95 <= trend_ratio <= 1.05:
            return 'EXTREME_STABLE'
            
        # ì¼€ì´ìŠ¤ 3: ê·¹ë‹¨ê°’ í•˜ë½ íŒ¨í„´ (ìµœëŒ€ê°’ 1650+ & í•˜ë½ íŠ¸ë Œë“œ)
        elif max_val >= 1650 and slope < -1 and trend_ratio < 0.95:
            return 'EXTREME_DOWN'
            
        # ì¼€ì´ìŠ¤ 4: ê¸‰ìƒìŠ¹ íŒ¨í„´ (ì•„ì§ ê·¹ë‹¨ê°’ ì•„ë‹ˆì§€ë§Œ ë¹ ë¥´ê²Œ ìƒìŠ¹)
        elif slope > 2 and trend_ratio > 1.1:
            return 'RAPID_UP'
            
        # ì¼€ì´ìŠ¤ 5: ì¼ë°˜ íŒ¨í„´
        else:
            return 'NORMAL'
    
    def predict_extreme(self, sequence_data, m14b, m14a, base_predictions):
        """íŠ¸ë Œë“œ ê¸°ë°˜ ê·¹ë‹¨ê°’ ì˜ˆì¸¡"""
        
        # 1. ì‹œí€€ìŠ¤ íŠ¸ë Œë“œ ë¶„ì„
        trend_info = self.analyze_sequence_trend(sequence_data)
        strategy = self.select_prediction_strategy(trend_info, m14b, m14a)
        
        # 2. ì „ëµë³„ ì˜ˆì¸¡
        if strategy == 'EXTREME_UP':
            # ê·¹ë‹¨ ìƒìŠ¹: ë§¤ìš° ê³µê²©ì  ì˜ˆì¸¡
            if m14b > 500:
                pred = max(1950, trend_info['recent_mean'] * 1.3)
            elif m14b > 450:
                pred = max(1850, trend_info['recent_mean'] * 1.25)
            else:
                pred = max(1750, trend_info['recent_mean'] * 1.2)
                
        elif strategy == 'EXTREME_STABLE':
            # ê·¹ë‹¨ ìœ ì§€: í˜„ì¬ ìˆ˜ì¤€ ìœ ì§€ + ì•ŒíŒŒ
            pred = max(1700, trend_info['recent_mean'] * 1.05)
            if m14b > 450:
                pred = max(pred, 1750)
                
        elif strategy == 'EXTREME_DOWN':
            # ê·¹ë‹¨ í•˜ë½: ë³´ìˆ˜ì ì´ì§€ë§Œ ì—¬ì „íˆ ë†’ê²Œ
            pred = max(1650, trend_info['recent_mean'] * 0.98)
            # M14Bê°€ ì—¬ì „íˆ ë†’ìœ¼ë©´ í•˜í•œì„  ë³´ì¥
            if m14b > 450:
                pred = max(pred, 1700)
                
        elif strategy == 'RAPID_UP':
            # ê¸‰ìƒìŠ¹: ì„ ì œì  ê·¹ë‹¨ê°’ ì˜ˆì¸¡
            pred = max(1700, trend_info['recent_mean'] * 1.15)
            if slope > 3:  # ë§¤ìš° ê°€íŒŒë¥¸ ìƒìŠ¹
                pred = pred * 1.1
                
        else:  # NORMAL
            # ì¼ë°˜: ê¸°ì¡´ ì•™ìƒë¸” ì‚¬ìš©
            pred = np.mean(base_predictions)
        
        # 3. í™©ê¸ˆ íŒ¨í„´ ë³´ì •
        if m14b > 300 and m14a < 80:
            pred = pred * 1.15
        
        # 4. ìµœì¢… í´ë¦¬í•‘
        pred = np.clip(pred, 1000, 2100)
        
        return pred, strategy

    def evaluate_with_trend(self, test_df):
        """íŠ¸ë Œë“œ ê¸°ë°˜ í‰ê°€"""
        
        predictions = []
        strategies = []
        
        for i in range(100, len(test_df)):
            # 100ê°œ ì‹œí€€ìŠ¤ ì¶”ì¶œ
            sequence = test_df['TOTALCNT'].iloc[i-100:i].values
            m14b = test_df['M14AM14B'].iloc[i]
            m14a = test_df['M14AM10A'].iloc[i]
            
            # ê¸°ì¡´ ëª¨ë¸ ì˜ˆì¸¡ê°’ë“¤ (ìˆë‹¤ë©´)
            base_preds = []
            for col in ['ExtremeNet_ì˜ˆì¸¡', 'PatchTST_ì˜ˆì¸¡', 'StableLSTM_ì˜ˆì¸¡']:
                if col in test_df.columns:
                    base_preds.append(test_df[col].iloc[i])
            
            if len(base_preds) == 0:
                base_preds = [test_df['TOTALCNT'].iloc[i] * 1.05]  # ê¸°ë³¸ê°’
            
            # íŠ¸ë Œë“œ ê¸°ë°˜ ì˜ˆì¸¡
            pred, strategy = self.predict_extreme(sequence, m14b, m14a, base_preds)
            predictions.append(pred)
            strategies.append(strategy)
        
        # ê²°ê³¼ ì €ì¥
        result_df = test_df.iloc[100:].copy()
        result_df['íŠ¸ë Œë“œì˜ˆì¸¡'] = predictions
        result_df['ì˜ˆì¸¡ì „ëµ'] = strategies
        
        # ì„±ëŠ¥ í‰ê°€
        high_mask = result_df['TOTALCNT'] >= 1700
        if high_mask.any():
            high_df = result_df[high_mask]
            hit_count = (high_df['íŠ¸ë Œë“œì˜ˆì¸¡'] >= 1700).sum()
            print(f"\nğŸ¯ íŠ¸ë Œë“œ ê¸°ë°˜ 1700+ ì ì¤‘ë¥ : {hit_count}/{len(high_df)} "
                  f"({hit_count/len(high_df)*100:.1f}%)")
            
            # ì „ëµë³„ ë¶„ì„
            for strategy in ['EXTREME_UP', 'EXTREME_STABLE', 'EXTREME_DOWN', 'RAPID_UP']:
                strategy_mask = high_df['ì˜ˆì¸¡ì „ëµ'] == strategy
                if strategy_mask.any():
                    strategy_df = high_df[strategy_mask]
                    strategy_hit = (strategy_df['íŠ¸ë Œë“œì˜ˆì¸¡'] >= 1700).sum()
                    print(f"  {strategy}: {strategy_hit}/{len(strategy_df)} "
                          f"({strategy_hit/len(strategy_df)*100:.1f}%)")
        
        return result_df

# ë©”ì¸ ì‹¤í–‰ ë¶€ë¶„ì— ì¶”ê°€
def enhanced_extreme_prediction(test_file):
    """ê°•í™”ëœ ê·¹ë‹¨ê°’ ì˜ˆì¸¡"""
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_csv(test_file)
    
    # íŠ¸ë Œë“œ ê¸°ë°˜ ì˜ˆì¸¡ê¸° ìƒì„±
    trend_predictor = TrendBasedExtremePredictor()
    
    # í‰ê°€ ì‹¤í–‰
    result = trend_predictor.evaluate_with_trend(df)
    
    # ì €ì¥
    result.to_csv('v8_trend_extreme_predictions.csv', index=False)
    
    print("\nâœ… í•µì‹¬ ê°œì„ :")
    print("  1. 100ê°œ ì‹œí€€ìŠ¤ ìµœëŒ€ê°’ 1650+ â†’ ê·¹ë‹¨ ì „ëµ")
    print("  2. ìƒìŠ¹ íŠ¸ë Œë“œ â†’ ê³µê²©ì  ì˜ˆì¸¡ (1950+)")
    print("  3. ì•ˆì • íŠ¸ë Œë“œ â†’ í˜„ì¬ ìˆ˜ì¤€ ìœ ì§€")
    print("  4. í•˜ë½ íŠ¸ë Œë“œ â†’ ë³´ìˆ˜ì  but í•˜í•œì„ ")
    print("  5. ê¸‰ìƒìŠ¹ íŒ¨í„´ â†’ ì„ ì œì  ê·¹ë‹¨ê°’")
    
    return result