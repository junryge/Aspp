"""
ğŸ“Š V6.9 - 1700+ êµ¬ê°„ ì•™ìƒë¸” ìµœì¢… í•´ê²°
========================================================
ë¬¸ì œ: ì‹¤ì œê°’ 1700+ êµ¬ê°„ì—ì„œ ëª¨ë“  ëª¨ë¸ì´ ì €ì¡°í•œ ì˜ˆì¸¡
í•´ê²°: ê°•ë ¥í•œ ì•™ìƒë¸” + M14B ê¸°ë°˜ ê·œì¹™ ì ìš©
"""

import numpy as np
import pandas as pd
import tensorflow as tf
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import pickle
import json
import os
import warnings
from datetime import datetime, timedelta

warnings.filterwarnings('ignore')
tf.keras.config.enable_unsafe_deserialization()

class ExtremeFixer:
    """1700+ êµ¬ê°„ ê°•ì œ ìˆ˜ì •ê¸°"""
    
    def __init__(self):
        # M14B ê¸°ë°˜ ë§¤í•‘ (ì‹¤ì œ ë°ì´í„° ë¶„ì„ ê¸°ë°˜)
        self.m14b_rules = {
            600: 1900,  # ì´ˆê·¹ë‹¨
            550: 1850,
            500: 1800,
            450: 1750,
            400: 1700,
            350: 1650,
            300: 1600
        }
    
    def fix_prediction(self, pred, m14b, m14a, model_name):
        """ì˜ˆì¸¡ê°’ ê°•ì œ ìˆ˜ì •"""
        
        # 1. ê¸°ë³¸ ìµœì†Œê°’ ì„¤ì •
        min_value = 1400
        for threshold, base_value in self.m14b_rules.items():
            if m14b >= threshold:
                min_value = base_value
                break
        
        # 2. ëª¨ë¸ë³„ ì¡°ì •
        if model_name == 'ExtremeNet':
            # ExtremeNetì€ ì–¸ì œë‚˜ ë‚®ê²Œ ì˜ˆì¸¡í•˜ë¯€ë¡œ ê°•ë ¥ ë³´ì •
            if m14b >= 450:
                fixed = max(pred * 1.3, min_value)
            elif m14b >= 400:
                fixed = max(pred * 1.2, min_value)
            else:
                fixed = max(pred * 1.1, pred)
        
        elif model_name in ['SpikeDetector', 'GoldenRule']:
            # ì´ ëª¨ë¸ë“¤ì€ ê·¸ë‚˜ë§ˆ ë‚˜ìœ¼ë¯€ë¡œ ìµœì†Œê°’ë§Œ
            fixed = max(pred, min_value * 0.95)
        
        else:
            # ë‚˜ë¨¸ì§€
            fixed = max(pred * 1.05, min_value * 0.98)
        
        # 3. í™©ê¸ˆ íŒ¨í„´ ë³´ë„ˆìŠ¤
        if m14b > 300 and m14a < 80:
            fixed = fixed * 1.1
        
        return fixed

def evaluate_with_fix(test_file='data/M14_20250916_20250817.csv'):
    """í‰ê°€ ë° ìˆ˜ì •"""
    
    print("="*80)
    print("ğŸ”¥ V6.9 - 1700+ êµ¬ê°„ í•´ê²°")
    print("="*80)
    
    # ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ
    with open('scalers/feature_scaler.pkl', 'rb') as f:
        feature_scaler = pickle.load(f)
    with open('scalers/target_scaler.pkl', 'rb') as f:
        target_scaler = pickle.load(f)
    with open('scalers/config.json', 'r') as f:
        config = json.load(f)
        seq_len = config['seq_len']
        pred_len = config['pred_len']
        feature_columns = config['feature_columns']
    
    # ëª¨ë¸ ë¡œë“œ
    models = {}
    model_dir = 'models/'
    for model_file in os.listdir(model_dir):
        if model_file.endswith('.keras'):
            model_name = model_file.replace('.keras', '')
            try:
                models[model_name] = tf.keras.models.load_model(
                    os.path.join(model_dir, model_file), safe_mode=False
                )
                print(f"âœ… {model_name} ë¡œë“œ")
            except:
                pass
    
    # ë°ì´í„° ë¡œë“œ
    df = pd.read_csv(test_file)
    df = df[df['TOTALCNT'] > 0].reset_index(drop=True)
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M', errors='coerce')
    df = df.sort_values('CURRTIME').reset_index(drop=True)
    
    # íŠ¹ì§• ìƒì„±
    df['RATIO'] = df['M14AM14B'] / (df['M14AM10A'] + 1)
    df['GOLDEN'] = ((df['M14AM14B'] > 300) & (df['M14AM10A'] < 80)).astype(float)
    df['HOUR'] = df['CURRTIME'].dt.hour
    df['HOUR_SIN'] = np.sin(2 * np.pi * df['HOUR'] / 24)
    df['HOUR_COS'] = np.cos(2 * np.pi * df['HOUR'] / 24)
    
    for w in [10, 30]:
        df[f'MA_{w}'] = df['TOTALCNT'].rolling(w, min_periods=1).mean()
        df[f'STD_{w}'] = df['TOTALCNT'].rolling(w, min_periods=1).std().fillna(0)
    
    df['CHANGE_1'] = df['TOTALCNT'].diff(1).fillna(0)
    df['CHANGE_10'] = df['TOTALCNT'].diff(10).fillna(0)
    
    print(f"\nğŸ“Š ë°ì´í„°: {len(df)}í–‰")
    high_count = (df['TOTALCNT'] >= 1700).sum()
    print(f"  ê³ ê°’(1700+): {high_count}ê°œ")
    
    # Fixer ì´ˆê¸°í™”
    fixer = ExtremeFixer()
    
    # ì˜ˆì¸¡ ì‹œì‘
    start_idx = seq_len
    end_idx = len(df) - pred_len
    
    results = []
    
    print(f"\nğŸ”® ì˜ˆì¸¡ ì‹œì‘...")
    for idx in range(start_idx, end_idx):
        if (idx - start_idx) % 100 == 0:
            print(f"  {idx - start_idx}/{end_idx - start_idx} ì²˜ë¦¬ ì¤‘...")
        
        # ì‹œê°„ ì •ë³´
        pred_time = df.iloc[idx]['CURRTIME']
        target_time = pred_time + timedelta(minutes=pred_len)
        actual_idx = idx + pred_len
        
        if actual_idx >= len(df):
            continue
        
        # í˜„ì¬ ì •ë³´
        row_data = {
            'ì˜ˆì¸¡ì‹œì ': pred_time.strftime('%Y-%m-%d %H:%M'),
            'ì˜ˆì¸¡ëŒ€ìƒì‹œê°„': target_time.strftime('%Y-%m-%d %H:%M'),
            'ì‹¤ì œê°’': df.iloc[actual_idx]['TOTALCNT'],
            'M14AM14B': df.iloc[idx]['M14AM14B'],
            'M14AM10A': df.iloc[idx]['M14AM10A']
        }
        
        # ì‹œí€€ìŠ¤ ì¶”ì¶œ
        seq_data = df.iloc[idx-seq_len:idx][feature_columns].values
        if len(seq_data) != seq_len:
            continue
        
        seq_scaled = feature_scaler.transform(seq_data)
        seq_scaled = seq_scaled.reshape(1, seq_len, -1)
        
        # ê° ëª¨ë¸ ì˜ˆì¸¡
        model_preds_raw = {}
        model_preds_fixed = {}
        
        for model_name, model in models.items():
            # ì›ë³¸ ì˜ˆì¸¡
            pred = model.predict(seq_scaled, verbose=0)
            if isinstance(pred, list):
                pred = pred[0]
            pred_value = target_scaler.inverse_transform(pred.reshape(-1, 1))[0, 0]
            
            # ì›ë³¸ ì €ì¥
            row_data[f'{model_name}_ì›ë³¸'] = round(pred_value)
            model_preds_raw[model_name] = pred_value
            
            # ìˆ˜ì •ëœ ì˜ˆì¸¡
            fixed_value = fixer.fix_prediction(
                pred_value,
                row_data['M14AM14B'],
                row_data['M14AM10A'],
                model_name
            )
            
            row_data[f'{model_name}_ìˆ˜ì •'] = round(fixed_value)
            model_preds_fixed[model_name] = fixed_value
        
        # ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸” (M14B ê¸°ë°˜)
        m14b = row_data['M14AM14B']
        
        # 1. ê¸°ë³¸ ì•™ìƒë¸” (ì›ë³¸)
        basic_ensemble = np.mean(list(model_preds_raw.values()))
        row_data['ê¸°ë³¸ì•™ìƒë¸”'] = round(basic_ensemble)
        
        # 2. ìˆ˜ì • ì•™ìƒë¸” (ìˆ˜ì •ëœ ê°’)
        fixed_ensemble = np.mean(list(model_preds_fixed.values()))
        row_data['ìˆ˜ì •ì•™ìƒë¸”'] = round(fixed_ensemble)
        
        # 3. ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸” (ê°€ì¤‘ì¹˜ ì¡°ì •)
        if m14b >= 450:
            # ê³ ê°’ êµ¬ê°„: SpikeDetector, GoldenRule ì¤‘ì‹œ
            weights = {
                'SpikeDetector': 0.35,
                'GoldenRule': 0.30,
                'PatchTST': 0.15,
                'ExtremeNet': 0.10,
                'StableLSTM': 0.10
            }
        elif m14b >= 400:
            weights = {
                'SpikeDetector': 0.25,
                'GoldenRule': 0.25,
                'PatchTST': 0.20,
                'ExtremeNet': 0.15,
                'StableLSTM': 0.15
            }
        else:
            # ì¼ë°˜ êµ¬ê°„
            weights = {
                'PatchTST': 0.25,
                'StableLSTM': 0.25,
                'ExtremeNet': 0.20,
                'SpikeDetector': 0.15,
                'GoldenRule': 0.15
            }
        
        smart_ensemble = 0
        total_weight = 0
        for model_name, value in model_preds_fixed.items():
            weight = weights.get(model_name, 0.2)
            smart_ensemble += value * weight
            total_weight += weight
        
        if total_weight > 0:
            smart_ensemble = smart_ensemble / total_weight
        
        # ìµœì¢… ë³´ì •
        if m14b >= 500:
            smart_ensemble = max(smart_ensemble, 1800)
        elif m14b >= 450:
            smart_ensemble = max(smart_ensemble, 1750)
        elif m14b >= 400:
            smart_ensemble = max(smart_ensemble, 1700)
        
        row_data['ìŠ¤ë§ˆíŠ¸ì•™ìƒë¸”'] = round(smart_ensemble)
        
        # 4. ê·œì¹™ ê¸°ë°˜ ì˜ˆì¸¡ (ìˆœìˆ˜ M14B)
        rule_pred = 1400
        for threshold, value in fixer.m14b_rules.items():
            if m14b >= threshold:
                rule_pred = value
                break
        row_data['ê·œì¹™ì˜ˆì¸¡'] = rule_pred
        
        # 5. ìµœì¢… í•˜ì´ë¸Œë¦¬ë“œ
        hybrid = smart_ensemble * 0.7 + rule_pred * 0.3
        row_data['ìµœì¢…ì˜ˆì¸¡'] = round(hybrid)
        
        # ì˜¤ì°¨ ê³„ì‚°
        row_data['ìµœì¢…ì˜¤ì°¨'] = round(hybrid - row_data['ì‹¤ì œê°’'])
        row_data['ìµœì¢…ì˜¤ì°¨ìœ¨(%)'] = round(abs(hybrid - row_data['ì‹¤ì œê°’']) / row_data['ì‹¤ì œê°’'] * 100, 2)
        
        results.append(row_data)
    
    # DataFrame ë³€í™˜
    df_results = pd.DataFrame(results)
    
    # ì„±ëŠ¥ ë¶„ì„
    print("\n" + "="*80)
    print("ğŸ“Š ì„±ëŠ¥ ë¶„ì„")
    print("="*80)
    
    # ì „ì²´ ì„±ëŠ¥
    actuals = df_results['ì‹¤ì œê°’'].values
    
    methods = ['ê¸°ë³¸ì•™ìƒë¸”', 'ìˆ˜ì •ì•™ìƒë¸”', 'ìŠ¤ë§ˆíŠ¸ì•™ìƒë¸”', 'ê·œì¹™ì˜ˆì¸¡', 'ìµœì¢…ì˜ˆì¸¡']
    
    print(f"\n[ì „ì²´ ì„±ëŠ¥]")
    print(f"{'ë°©ë²•':<15} {'MAE':>8} {'RMSE':>8} {'MAPE(%)':>8} {'ì •í™•ë„(%)':>10}")
    print("-" * 55)
    
    for method in methods:
        preds = df_results[method].values
        mae = mean_absolute_error(actuals, preds)
        rmse = np.sqrt(mean_squared_error(actuals, preds))
        mape = np.mean(abs(preds - actuals) / actuals) * 100
        
        marker = "â­â­â­" if method == 'ìµœì¢…ì˜ˆì¸¡' else ""
        print(f"{method:<15} {mae:8.2f} {rmse:8.2f} {mape:8.2f} {100-mape:10.2f} {marker}")
    
    # ê³ ê°’ êµ¬ê°„ ë¶„ì„
    high_mask = df_results['ì‹¤ì œê°’'] >= 1700
    if high_mask.any():
        high_df = df_results[high_mask]
        
        print(f"\n[1700+ êµ¬ê°„ ì ì¤‘ë¥ ] - {len(high_df)}ê°œ ìƒ˜í”Œ")
        print("-" * 60)
        
        for method in methods:
            preds = high_df[method].values
            hit_1700 = (preds >= 1700).sum()
            hit_1650 = (preds >= 1650).sum()
            
            marker = "ğŸ”¥ğŸ”¥ğŸ”¥" if method == 'ìµœì¢…ì˜ˆì¸¡' else ""
            print(f"{method:<15}: {hit_1700:2d}/{len(high_df)} ({hit_1700/len(high_df)*100:.1f}%) "
                  f"[1650+: {hit_1650}/{len(high_df)}] {marker}")
        
        # ê°œë³„ ëª¨ë¸ ì„±ëŠ¥
        print(f"\n[ê°œë³„ ëª¨ë¸ ì›ë³¸ vs ìˆ˜ì •]")
        for model_name in models.keys():
            if f'{model_name}_ì›ë³¸' in high_df.columns:
                orig = high_df[f'{model_name}_ì›ë³¸'].values
                fixed = high_df[f'{model_name}_ìˆ˜ì •'].values
                
                orig_hit = (orig >= 1700).sum()
                fixed_hit = (fixed >= 1700).sum()
                
                print(f"{model_name:15}: ì›ë³¸ {orig_hit:2d} â†’ ìˆ˜ì • {fixed_hit:2d} (+{fixed_hit-orig_hit})")
        
        # ìƒì„¸ ìƒ˜í”Œ
        print(f"\n[ìµœì¢…ì˜ˆì¸¡ ìƒì„¸ - ì²˜ìŒ 20ê°œ]")
        print(f"{'ì‹¤ì œ':>6} {'ìµœì¢…':>6} {'M14B':>5} {'M14A':>5} {'ì˜¤ì°¨':>6} {'ê²°ê³¼':>8}")
        print("-" * 45)
        
        for idx in high_df.head(20).index:
            row = df_results.loc[idx]
            actual = row['ì‹¤ì œê°’']
            final = row['ìµœì¢…ì˜ˆì¸¡']
            m14b = row['M14AM14B']
            m14a = row['M14AM10A']
            error = final - actual
            
            if abs(error) <= 50:
                result = "âœ… GOOD"
            elif abs(error) <= 100:
                result = "âš ï¸ OK"
            else:
                result = "âŒ BAD"
            
            print(f"{actual:6.0f} {final:6.0f} {m14b:5.0f} {m14a:5.0f} {error:+6.0f} {result:>8}")
    
    # CSV ì €ì¥
    output_file = f'v69_final_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv'
    df_results.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"\nğŸ’¾ ì €ì¥: {output_file}")
    
    return df_results

def main():
    """ë©”ì¸ ì‹¤í–‰"""
    print("\nğŸš€ V6.9 - 1700+ êµ¬ê°„ ìµœì¢… í•´ê²°!")
    
    # í‰ê°€ ì‹¤í–‰
    results = evaluate_with_fix()
    
    print("\nâœ… ì™„ë£Œ!")
    print("\ní•µì‹¬ í•´ê²°ì±…:")
    print("  1. M14B ê¸°ë°˜ ê°•ì œ ìµœì†Œê°’ ì ìš©")
    print("  2. ExtremeNet 30% ìƒí–¥ ë³´ì •")
    print("  3. ìŠ¤ë§ˆíŠ¸ ì•™ìƒë¸” (ê°€ì¤‘ì¹˜ ë™ì  ì¡°ì •)")
    print("  4. ê·œì¹™ ê¸°ë°˜ ì˜ˆì¸¡ 30% í˜¼í•©")
    print("  5. ìµœì¢… í•˜ì´ë¸Œë¦¬ë“œ = ì•™ìƒë¸” 70% + ê·œì¹™ 30%")

if __name__ == "__main__":
    main()