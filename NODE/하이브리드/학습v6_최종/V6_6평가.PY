"""
ğŸ“Š V6.7 ê³ ê¸‰ ê·¹ë‹¨ê°’ ì˜ˆì¸¡ í‰ê°€ ì‹œìŠ¤í…œ
========================================================
í•µì‹¬ ê¸°ëŠ¥:
1. ì‹œí€€ìŠ¤ maxê°’ 1682+ & ì¦ê°€ ì¶”ì„¸ â†’ ExtremeNet ë¶€ìŠ¤íŒ…
2. ì—°ì† ìƒìŠ¹/í•˜ë½ ì¹´ìš´íŠ¸ ë° ê°•ë„ ì¸¡ì •
3. ê³ í‰ì›(1700+) ìƒíƒœ ì„¸ë¶„í™”
4. ê·¹ë‹¨ì  ë³€í™” ê°ì§€ (10ë¶„+ ì—°ì†)
"""

import numpy as np
import pandas as pd
import tensorflow as tf
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import pickle
import json
import os
import warnings
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import seaborn as sns

warnings.filterwarnings('ignore')
tf.keras.config.enable_unsafe_deserialization()

# ====================== ê³ ê¸‰ ê·¹ë‹¨ê°’ ë³´ì • í´ë˜ìŠ¤ ======================
class AdvancedExtremeValueBooster:
    """ì—°ì† ìƒìŠ¹/í•˜ë½ ê°ë„ë¥¼ í¬í•¨í•œ ìŠ¤ë§ˆíŠ¸ ê·¹ë‹¨ê°’ ì˜ˆì¸¡"""
    
    def __init__(self):
        print("ğŸ”¥ ê³ ê¸‰ ê·¹ë‹¨ê°’ ë¶€ìŠ¤í„° ì´ˆê¸°í™”")
        print("  - ì—°ì† ìƒìŠ¹/í•˜ë½ ê°ì§€")
        print("  - ë³€í™” ê°•ë„ ì¸¡ì •")
        print("  - ê³ í‰ì› ìƒíƒœ ì„¸ë¶„í™”")
        
    def analyze_sequence(self, sequence_data):
        """ì‹œí€€ìŠ¤ ë¶„ì„: maxê°’, ì¶”ì„¸, ì—°ì† ìƒìŠ¹/í•˜ë½ ì •ë„ ê³„ì‚°"""
        if len(sequence_data) == 0:
            return {
                'max': None,
                'min': None,
                'mean': None,
                'trend': 'stable',
                'is_high_plateau': False,
                'consecutive_rises': 0,
                'consecutive_falls': 0,
                'rise_strength': 0,
                'fall_strength': 0,
                'volatility': 0
            }
        
        # 1. ê¸°ë³¸ í†µê³„
        seq_max = np.max(sequence_data)
        seq_min = np.min(sequence_data)
        seq_mean = np.mean(sequence_data[-30:]) if len(sequence_data) >= 30 else np.mean(sequence_data)
        
        # 2. ê³ í‰ì› ìƒíƒœ ì²´í¬ (ìµœê·¼ 30ê°œ í‰ê· ì´ 1700 ì´ìƒ)
        is_high_plateau = seq_mean >= 1700
        
        # 3. ì—°ì† ìƒìŠ¹ ì¹´ìš´íŠ¸ ê³„ì‚°
        consecutive_rises = 0
        for i in range(len(sequence_data)-1, 0, -1):
            if sequence_data[i] > sequence_data[i-1]:
                consecutive_rises += 1
            else:
                break
        
        # 4. ì—°ì† í•˜ë½ ì¹´ìš´íŠ¸ ê³„ì‚°  
        consecutive_falls = 0
        for i in range(len(sequence_data)-1, 0, -1):
            if sequence_data[i] < sequence_data[i-1]:
                consecutive_falls += 1
            else:
                break
        
        # 5. ìƒìŠ¹/í•˜ë½ ê°•ë„ ê³„ì‚° (ìµœê·¼ 10ê°œ ë°ì´í„°)
        rise_strength = 0
        fall_strength = 0
        if len(sequence_data) >= 10:
            recent_10 = sequence_data[-10:]
            change = recent_10[-1] - recent_10[0]  # 10ë¶„ê°„ ì´ ë³€í™”ëŸ‰
            if change > 0:
                rise_strength = change
            else:
                fall_strength = abs(change)
        
        # 6. ë³€ë™ì„± ì§€í‘œ (ìµœê·¼ 10ê°œì˜ í‘œì¤€í¸ì°¨)
        volatility = np.std(sequence_data[-10:]) if len(sequence_data) >= 10 else 0
        
        # 7. ì¶”ì„¸ ë¶„ì„ (ë§ˆì§€ë§‰ 30ê°œ ë°ì´í„°)
        trend = 'stable'
        if len(sequence_data) >= 30:
            recent = sequence_data[-30:]
            x = np.arange(len(recent))
            coeffs = np.polyfit(x, recent, 1)
            slope = coeffs[0]
            
            # ê³ í‰ì› ìƒíƒœì—ì„œì˜ ì¶”ì„¸ íŒë‹¨
            if is_high_plateau:
                # ê³ í‰ì›(1700+)ì—ì„œì˜ ê·¹ë‹¨ì  ë³€í™” ê°ì§€
                if consecutive_rises >= 10 and rise_strength > 50:
                    trend = 'extreme_rising'  # ê·¹ë‹¨ì  ìƒìŠ¹
                elif consecutive_falls >= 10 and fall_strength > 50:
                    trend = 'extreme_falling'  # ê·¹ë‹¨ì  í•˜ë½
                elif slope > 1 or consecutive_rises >= 5:
                    trend = 'high_increasing'  # ê³ í‰ì› ìƒìŠ¹
                elif slope < -1 or consecutive_falls >= 5:
                    trend = 'high_decreasing'  # ê³ í‰ì› í•˜ë½
                else:
                    trend = 'high_stable'  # ê³ í‰ì› ìœ ì§€
            else:
                # ì¼ë°˜ êµ¬ê°„ ì¶”ì„¸ íŒë‹¨
                if consecutive_rises >= 10 and rise_strength > 50:
                    trend = 'strong_rising'  # ê°•í•œ ì—°ì† ìƒìŠ¹
                elif consecutive_falls >= 10 and fall_strength > 50:
                    trend = 'strong_falling'  # ê°•í•œ ì—°ì† í•˜ë½
                elif consecutive_rises >= 7 and rise_strength > 30:
                    trend = 'rapid_increasing'  # ë¹ ë¥¸ ìƒìŠ¹
                elif consecutive_falls >= 7 and fall_strength > 30:
                    trend = 'rapid_decreasing'  # ë¹ ë¥¸ í•˜ë½
                elif slope > 2:
                    trend = 'increasing'
                elif slope < -2:
                    trend = 'decreasing'
                else:
                    trend = 'stable'
        
        return {
            'max': seq_max,
            'min': seq_min,
            'mean': seq_mean,
            'trend': trend,
            'is_high_plateau': is_high_plateau,
            'consecutive_rises': consecutive_rises,
            'consecutive_falls': consecutive_falls,
            'rise_strength': rise_strength,
            'fall_strength': fall_strength,
            'volatility': volatility
        }
    
    def boost_prediction(self, pred, m14b_value, m14a_value=None, model_name=None, 
                        sequence_info=None):
        """ì‹œí€€ìŠ¤ ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë¶€ìŠ¤íŒ… (ìƒìŠ¹/í•˜ë½ ê°ë„ í¬í•¨)"""
        if not sequence_info:
            return pred
            
        original = pred
        boosted = pred
        seq_max = sequence_info.get('max', 0)
        seq_trend = sequence_info.get('trend', 'stable')
        consecutive_rises = sequence_info.get('consecutive_rises', 0)
        consecutive_falls = sequence_info.get('consecutive_falls', 0)
        rise_strength = sequence_info.get('rise_strength', 0)
        fall_strength = sequence_info.get('fall_strength', 0)
        
        # ========== ExtremeNet íŠ¹ë³„ ì²˜ë¦¬ ==========
        if model_name == 'ExtremeNet':
            
            # ğŸš€ ê·¹ë‹¨ì  ìƒìŠ¹ (10ë¶„+ ì—°ì† ìƒìŠ¹)
            if seq_trend == 'extreme_rising':
                # ìƒìŠ¹ ê°•ë„ì— ë¹„ë¡€í•œ ë¶€ìŠ¤íŒ…
                boost_factor = 1.5 + (rise_strength / 100) * 0.3  # ìµœëŒ€ 1.8ë°°
                boosted = pred * min(boost_factor, 1.8)
                boosted = max(boosted, 1900)
                
            # ğŸ’¥ ê·¹ë‹¨ì  í•˜ë½ (10ë¶„+ ì—°ì† í•˜ë½)
            elif seq_trend == 'extreme_falling':
                # í•˜ë½ ê°•ë„ì— ë¹„ë¡€í•œ ê°ì†Œ
                reduction_factor = 0.9 - (fall_strength / 100) * 0.1  # ìµœëŒ€ 20% ê°ì†Œ
                boosted = pred * max(reduction_factor, 0.8)
                
            # ğŸ“ˆ ê°•í•œ ìƒìŠ¹ ì¶”ì„¸
            elif seq_trend in ['strong_rising', 'rapid_increasing']:
                boost_factor = 1.3 + (consecutive_rises / 20) * 0.2
                boosted = pred * min(boost_factor, 1.5)
                if seq_max >= 1682:
                    boosted = max(boosted, 1750)
                    
            # ğŸ“‰ ê°•í•œ í•˜ë½ ì¶”ì„¸
            elif seq_trend in ['strong_falling', 'rapid_decreasing']:
                reduction_factor = 0.95 - (consecutive_falls / 20) * 0.05
                boosted = pred * max(reduction_factor, 0.85)
                
            # ğŸ”¥ ê³ í‰ì› ìƒíƒœë³„ ì²˜ë¦¬
            elif seq_trend == 'high_increasing':
                if m14b_value > 500:
                    boosted = max(pred * 1.6, 1850)
                else:
                    boosted = max(pred * 1.4, 1750)
                    
            elif seq_trend == 'high_stable':
                boosted = max(pred, 1700)  # ìµœì†Œ 1700 ë³´ì¥
                
            elif seq_trend == 'high_decreasing':
                boosted = pred * 0.98
                
            # ì¼ë°˜ ìƒìŠ¹ (ê¸°ì¡´ ì¡°ê±´)
            elif seq_max >= 1682 and seq_trend == 'increasing':
                if m14b_value > 450:
                    boosted = max(pred * 1.4, 1700)
                else:
                    boosted = pred * 1.2
                    
            # ì¼ë°˜ í•˜ë½
            elif seq_trend == 'decreasing':
                if seq_max >= 1682:
                    boosted = pred * 0.95
                else:
                    boosted = pred
            
            # ì•ˆì •ì ì´ê±°ë‚˜ maxê°’ ë¯¸ë‹¬
            else:
                boosted = pred
                
        # ========== SpikeDetector, GoldenRule ==========
        elif model_name in ['SpikeDetector', 'GoldenRule']:
            # ê·¹ë‹¨ì  ë³€í™” ì²˜ë¦¬
            if seq_trend in ['extreme_rising', 'strong_rising']:
                # ê·¹ë‹¨ ìƒìŠ¹ â†’ ì¶”ê°€ ë¶€ìŠ¤íŒ…
                boost_factor = 1.1 + (consecutive_rises / 30) * 0.1
                boosted = pred * min(boost_factor, 1.2)
                boosted = max(boosted, 1800)
                
            elif seq_trend in ['extreme_falling', 'strong_falling']:
                # ê·¹ë‹¨ í•˜ë½ â†’ í•˜í–¥ ì¡°ì •
                reduction_factor = 0.95 - (consecutive_falls / 30) * 0.05
                boosted = pred * max(reduction_factor, 0.85)
                
            # ê³ í‰ì› ìƒíƒœ ì²˜ë¦¬
            elif seq_trend in ['high_increasing', 'high_stable', 'high_decreasing']:
                if seq_trend == 'high_increasing':
                    boosted = max(pred * 1.05, 1800)
                elif seq_trend == 'high_stable':
                    boosted = max(pred, 1700)
                else:  # high_decreasing
                    boosted = pred * 0.98
            else:
                # ì¼ë°˜ ìƒíƒœ
                if m14b_value > 450:
                    boosted = max(pred, 1700)
                
        # ========== ê¸°íƒ€ ëª¨ë¸ (PatchTST, StableLSTM) ==========
        else:
            # ê·¹ë‹¨ì  ë³€í™” ìš°ì„  ì²˜ë¦¬
            if seq_trend == 'extreme_rising':
                # ê·¹ë‹¨ ìƒìŠ¹ â†’ ìµœê°• ë¶€ìŠ¤íŒ…
                boost_factor = 1.4 + (rise_strength / 100) * 0.2
                boosted = pred * min(boost_factor, 1.6)
                boosted = max(boosted, 1850)
                
            elif seq_trend == 'extreme_falling':
                # ê·¹ë‹¨ í•˜ë½ â†’ ê°•í•œ í•˜í–¥
                reduction_factor = 0.85 - (fall_strength / 100) * 0.1
                boosted = pred * max(reduction_factor, 0.75)
                
            elif seq_trend in ['strong_rising', 'rapid_increasing']:
                # ê°•í•œ ìƒìŠ¹
                boosted = pred * 1.3
                if seq_max >= 1682:
                    boosted = max(boosted, 1700)
                    
            elif seq_trend in ['strong_falling', 'rapid_decreasing']:
                # ê°•í•œ í•˜ë½
                boosted = pred * 0.9
                
            # ê³ í‰ì› ìƒíƒœ
            elif seq_trend in ['high_increasing', 'high_stable', 'high_decreasing']:
                if seq_trend == 'high_increasing':
                    boosted = max(pred * 1.3, 1750)
                elif seq_trend == 'high_stable':
                    boosted = max(pred, 1700)
                else:  # high_decreasing
                    boosted = pred * 0.97
                    
            # ì¼ë°˜ ì¦ê°€/ê°ì†Œ
            elif seq_trend == 'increasing':
                if m14b_value > 450:
                    boosted = max(pred * 1.25, 1700)
                else:
                    boosted = pred * 1.1
                    
            elif seq_trend == 'decreasing':
                boosted = pred * 0.95
            else:
                boosted = pred
        
        # í™©ê¸ˆ íŒ¨í„´ ì¶”ê°€ ë¶€ìŠ¤íŒ… (ëª¨ë“  ëª¨ë¸ ê³µí†µ)
        if m14b_value > 300 and m14a_value and m14a_value < 80:
            if seq_trend in ['increasing', 'strong_rising', 'extreme_rising', 'high_increasing']:
                boosted = boosted * 1.15  # ì¦ê°€ ì¶”ì„¸ë©´ ë” ê°•í•˜ê²Œ
            else:
                boosted = boosted * 1.08  # ì•„ë‹ˆë©´ ì•½í•˜ê²Œ
            
        return boosted

class AdvancedModelEvaluator:
    def __init__(self, scaler_path='scalers/'):
        """ê³ ê¸‰ í‰ê°€ê¸° ì´ˆê¸°í™”"""
        print("="*80)
        print("ğŸ”¥ V6.7 ê³ ê¸‰ ê·¹ë‹¨ê°’ í‰ê°€ ì‹œìŠ¤í…œ")
        print("  âœ… ì‹œí€€ìŠ¤ max 1682+ & ì¦ê°€ ì¶”ì„¸ â†’ ExtremeNet ë¶€ìŠ¤íŒ…")
        print("  âœ… ì—°ì† ìƒìŠ¹/í•˜ë½ ê°ì§€ (ìµœëŒ€ ì—°ì† ë¶„ ì¹´ìš´íŠ¸)")
        print("  âœ… ë³€í™” ê°•ë„ ì¸¡ì • (10ë¶„ê°„ ì´ ë³€í™”ëŸ‰)")
        print("  âœ… ê³ í‰ì›(1700+) ìƒíƒœ ì„¸ë¶„í™”")
        print("="*80)
        
        # ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ
        with open(f'{scaler_path}feature_scaler.pkl', 'rb') as f:
            self.feature_scaler = pickle.load(f)
        with open(f'{scaler_path}target_scaler.pkl', 'rb') as f:
            self.target_scaler = pickle.load(f)
        with open(f'{scaler_path}config.json', 'r') as f:
            config = json.load(f)
            self.seq_len = config['seq_len']
            self.pred_len = config['pred_len']
            self.feature_columns = config['feature_columns']
        print(f"âœ… ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ ì™„ë£Œ")
        
        self.models = {}
        self.extreme_booster = AdvancedExtremeValueBooster()
        
    def load_all_models(self, model_dir='models/'):
        """ëª¨ë“  ëª¨ë¸ ë¡œë“œ"""
        print(f"\nğŸ“ ëª¨ë¸ ë¡œë”©...")
        
        model_files = [f for f in os.listdir(model_dir) if f.endswith('.keras')]
        
        for model_file in model_files:
            model_name = model_file.replace('.keras', '')
            model_path = os.path.join(model_dir, model_file)
            
            try:
                self.models[model_name] = tf.keras.models.load_model(
                    model_path, safe_mode=False
                )
                print(f"  âœ… {model_name} ë¡œë“œ ì™„ë£Œ")
            except Exception as e:
                print(f"  âŒ {model_name} ë¡œë“œ ì‹¤íŒ¨: {e}")
        
        print(f"\nì´ {len(self.models)}ê°œ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ")
        return self.models
    
    def load_test_data(self, filepath):
        """í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ"""
        print(f"\nğŸ“‚ í‰ê°€ ë°ì´í„° ë¡œë”©: {filepath}")
        df = pd.read_csv(filepath)
        print(f"  ì›ë³¸: {df.shape[0]:,}í–‰")
        
        # 0ê°’ ì œê±°
        df = df[df['TOTALCNT'] > 0].reset_index(drop=True)
        
        # ì‹œê°„ ë³€í™˜
        df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), 
                                       format='%Y%m%d%H%M', errors='coerce')
        df = df.sort_values('CURRTIME').reset_index(drop=True)
        
        print(f"  ìœ íš¨: {df.shape[0]:,}í–‰")
        
        # ê³ ê°’ í†µê³„ ì¶œë ¥
        high_count = (df['TOTALCNT'] >= 1700).sum()
        very_high_count = (df['TOTALCNT'] >= 1750).sum()
        extreme_count = (df['TOTALCNT'] >= 1800).sum()
        max_1682_count = (df['TOTALCNT'] >= 1682).sum()
        
        print(f"\nğŸ¯ ê³ ê°’ êµ¬ê°„ ë¶„í¬:")
        print(f"  1682+: {max_1682_count}ê°œ ({max_1682_count/len(df)*100:.1f}%) â† ê¸°ì¤€ê°’")
        print(f"  1700+: {high_count}ê°œ ({high_count/len(df)*100:.1f}%)")
        print(f"  1750+: {very_high_count}ê°œ ({very_high_count/len(df)*100:.1f}%)")
        print(f"  1800+: {extreme_count}ê°œ ({extreme_count/len(df)*100:.1f}%)")
        
        return df
    
    def create_features(self, df):
        """íŠ¹ì„± ìƒì„±"""
        df['RATIO'] = df['M14AM14B'] / (df['M14AM10A'] + 1)
        df['GOLDEN'] = ((df['M14AM14B'] > 300) & (df['M14AM10A'] < 80)).astype(float)
        
        df['HOUR'] = df['CURRTIME'].dt.hour
        df['HOUR_SIN'] = np.sin(2 * np.pi * df['HOUR'] / 24)
        df['HOUR_COS'] = np.cos(2 * np.pi * df['HOUR'] / 24)
        
        for w in [10, 30]:
            df[f'MA_{w}'] = df['TOTALCNT'].rolling(w, min_periods=1).mean()
            df[f'STD_{w}'] = df['TOTALCNT'].rolling(w, min_periods=1).std().fillna(0)
        
        df['CHANGE_1'] = df['TOTALCNT'].diff(1).fillna(0)
        df['CHANGE_10'] = df['TOTALCNT'].diff(10).fillna(0)
        
        return df
    
    def evaluate_all_models(self, test_file):
        """ê³ ê¸‰ ëª¨ë¸ í‰ê°€ - ì—°ì† ìƒìŠ¹/í•˜ë½ ê°ë„ í¬í•¨"""
        
        # ë°ì´í„° ë¡œë“œ
        df = self.load_test_data(test_file)
        df = self.create_features(df)
        
        # ì˜ˆì¸¡ ê°€ëŠ¥ ë²”ìœ„
        start_idx = self.seq_len
        end_idx = len(df) - self.pred_len
        total = end_idx - start_idx
        
        print(f"\nğŸ”® ì˜ˆì¸¡ ì‹œì‘...")
        print(f"  ì‹œí€€ìŠ¤: {self.seq_len}ë¶„ â†’ ì˜ˆì¸¡: {self.pred_len}ë¶„ í›„")
        print(f"  ì˜ˆì¸¡ ê°œìˆ˜: {total:,}ê°œ")
        
        # ëª¨ë“  ì˜ˆì¸¡ì„ ì €ì¥í•  DataFrame ì¤€ë¹„
        all_predictions = pd.DataFrame()
        
        # ì‹œê°„ ë° íŠ¹ì§• ì •ë³´ ìˆ˜ì§‘
        timestamps_pred = []
        timestamps_target = []
        actuals = []
        m14b_values = []
        m14a_values = []
        sequence_infos = []
        
        print("\nğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ë° ì‹œí€€ìŠ¤ ë¶„ì„ ì¤‘...")
        for i in range(start_idx, end_idx):
            pred_time = df.iloc[i]['CURRTIME']
            target_time = pred_time + timedelta(minutes=self.pred_len)
            
            actual_idx = i + self.pred_len
            if actual_idx < len(df):
                # ê¸°ë³¸ ì •ë³´
                timestamps_pred.append(pred_time)
                timestamps_target.append(target_time)
                actuals.append(df.iloc[actual_idx]['TOTALCNT'])
                m14b_values.append(df.iloc[i]['M14AM14B'])
                m14a_values.append(df.iloc[i]['M14AM10A'])
                
                # ì‹œí€€ìŠ¤ ë¶„ì„ (ê³¼ê±° 100ë¶„ TOTALCNT)
                seq_data = df.iloc[i-self.seq_len:i]['TOTALCNT'].values
                seq_info = self.extreme_booster.analyze_sequence(seq_data)
                sequence_infos.append(seq_info)
        
        # ê¸°ë³¸ ì •ë³´ ì €ì¥
        all_predictions['ì˜ˆì¸¡ì‹œì '] = [t.strftime('%Y-%m-%d %H:%M') for t in timestamps_pred]
        all_predictions['ì˜ˆì¸¡ëŒ€ìƒì‹œê°„'] = [t.strftime('%Y-%m-%d %H:%M') for t in timestamps_target]
        all_predictions['ì‹¤ì œê°’'] = actuals
        all_predictions['M14AM14B'] = m14b_values
        all_predictions['M14AM10A'] = m14a_values
        all_predictions['ì‹œí€€ìŠ¤_MAX'] = [s['max'] for s in sequence_infos]
        all_predictions['ì‹œí€€ìŠ¤_MIN'] = [s['min'] for s in sequence_infos]
        all_predictions['ì‹œí€€ìŠ¤_ì¶”ì„¸'] = [s['trend'] for s in sequence_infos]
        all_predictions['ì—°ì†ìƒìŠ¹'] = [s['consecutive_rises'] for s in sequence_infos]
        all_predictions['ì—°ì†í•˜ë½'] = [s['consecutive_falls'] for s in sequence_infos]
        all_predictions['ìƒìŠ¹ê°•ë„'] = [s['rise_strength'] for s in sequence_infos]
        all_predictions['í•˜ë½ê°•ë„'] = [s['fall_strength'] for s in sequence_infos]
        
        print(f"  ì˜ˆì¸¡í•  ë°ì´í„°: {len(all_predictions)}ê°œ")
        
        # ì‹œí€€ìŠ¤ ë¶„ì„ í†µê³„
        print(f"\nğŸ“ˆ ì‹œí€€ìŠ¤ ë¶„ì„ ê²°ê³¼:")
        
        # ì¶”ì„¸ë³„ ë¶„í¬
        trend_counts = all_predictions['ì‹œí€€ìŠ¤_ì¶”ì„¸'].value_counts()
        for trend, count in trend_counts.items():
            print(f"  {trend}: {count}ê°œ ({count/len(all_predictions)*100:.1f}%)")
        
        # ì—°ì† ìƒìŠ¹/í•˜ë½ ìµœëŒ€ê°’
        max_rises = all_predictions['ì—°ì†ìƒìŠ¹'].max()
        max_falls = all_predictions['ì—°ì†í•˜ë½'].max()
        print(f"\n  ìµœëŒ€ ì—°ì† ìƒìŠ¹: {max_rises}ë¶„")
        print(f"  ìµœëŒ€ ì—°ì† í•˜ë½: {max_falls}ë¶„")
        
        # ê·¹ë‹¨ì  ì¼€ì´ìŠ¤
        extreme_rise_count = ((all_predictions['ì—°ì†ìƒìŠ¹'] >= 10) & 
                             (all_predictions['ìƒìŠ¹ê°•ë„'] > 50)).sum()
        extreme_fall_count = ((all_predictions['ì—°ì†í•˜ë½'] >= 10) & 
                             (all_predictions['í•˜ë½ê°•ë„'] > 50)).sum()
        print(f"  ê·¹ë‹¨ ìƒìŠ¹ ì¼€ì´ìŠ¤: {extreme_rise_count}ê°œ")
        print(f"  ê·¹ë‹¨ í•˜ë½ ì¼€ì´ìŠ¤: {extreme_fall_count}ê°œ")
        
        # ê° ëª¨ë¸ë³„ ì˜ˆì¸¡
        model_metrics = {}
        
        for model_name, model in self.models.items():
            print(f"\nğŸ¯ {model_name} ì˜ˆì¸¡ ì¤‘...")
            predictions = []
            
            # ë°°ì¹˜ ì˜ˆì¸¡
            batch_size = 500
            for i in range(start_idx, end_idx, batch_size):
                batch_end = min(i + batch_size, end_idx)
                
                # ë°°ì¹˜ ë°ì´í„° ì¤€ë¹„
                X_batch = []
                for j in range(i, batch_end):
                    seq_data = df.iloc[j-self.seq_len:j][self.feature_columns].values
                    X_batch.append(seq_data)
                
                if len(X_batch) == 0:
                    continue
                
                # ìŠ¤ì¼€ì¼ë§
                X_batch = np.array(X_batch)
                X_batch_scaled = []
                for seq in X_batch:
                    seq_scaled = self.feature_scaler.transform(seq)
                    X_batch_scaled.append(seq_scaled)
                X_batch_scaled = np.array(X_batch_scaled)
                
                # ì˜ˆì¸¡
                preds = model.predict(X_batch_scaled, verbose=0)
                
                if isinstance(preds, list):
                    y_pred_scaled = preds[0].flatten()
                else:
                    y_pred_scaled = preds.flatten()
                
                # ì—­ë³€í™˜
                y_pred = self.target_scaler.inverse_transform(
                    y_pred_scaled.reshape(-1, 1)).flatten()
                
                # ìˆ˜ì§‘
                for k in range(len(y_pred)):
                    actual_idx = i - start_idx + k
                    if actual_idx < len(all_predictions):
                        predictions.append(y_pred[k])
            
            # ì˜ˆì¸¡ê°’ ì €ì¥
            predictions = predictions[:len(all_predictions)]
            
            # ì›ë³¸ ì˜ˆì¸¡ê°’ ì €ì¥
            all_predictions[f'{model_name}_ì›ë³¸'] = [round(p) for p in predictions]
            
            # ê³ ê¸‰ ì‹œí€€ìŠ¤ ê¸°ë°˜ ë¶€ìŠ¤íŒ…
            print(f"  ğŸ”¥ {model_name} ê³ ê¸‰ ë¶€ìŠ¤íŒ… ì ìš© ì¤‘...")
            boosted_predictions = []
            
            for i in range(len(predictions)):
                m14b = all_predictions.iloc[i]['M14AM14B']
                m14a = all_predictions.iloc[i]['M14AM10A']
                seq_info = sequence_infos[i]
                original = predictions[i]
                
                # ì‹œí€€ìŠ¤ ê¸°ë°˜ ë¶€ìŠ¤íŒ… ì ìš©
                boosted = self.extreme_booster.boost_prediction(
                    original, m14b, m14a, model_name,
                    sequence_info=seq_info
                )
                
                boosted_predictions.append(boosted)
            
            all_predictions[f'{model_name}_ì˜ˆì¸¡'] = [round(p) for p in boosted_predictions]
            all_predictions[f'{model_name}_ì˜¤ì°¨'] = all_predictions[f'{model_name}_ì˜ˆì¸¡'] - all_predictions['ì‹¤ì œê°’']
            all_predictions[f'{model_name}_ì˜¤ì°¨ìœ¨(%)'] = round(
                abs(all_predictions[f'{model_name}_ì˜¤ì°¨']) / all_predictions['ì‹¤ì œê°’'] * 100, 2
            )
            
            # ì„±ëŠ¥ ê³„ì‚°
            mae = mean_absolute_error(all_predictions['ì‹¤ì œê°’'], boosted_predictions)
            rmse = np.sqrt(mean_squared_error(all_predictions['ì‹¤ì œê°’'], boosted_predictions))
            r2 = r2_score(all_predictions['ì‹¤ì œê°’'], boosted_predictions)
            mape = np.mean(abs(all_predictions[f'{model_name}_ì˜¤ì°¨']) / all_predictions['ì‹¤ì œê°’']) * 100
            
            model_metrics[model_name] = {
                'MAE': mae,
                'RMSE': rmse,
                'R2': r2,
                'MAPE': mape,
                'ì •í™•ë„(%)': 100 - mape
            }
            
            print(f"  âœ… {model_name} ì™„ë£Œ: MAE={mae:.2f}, RÂ²={r2:.4f}, ì •í™•ë„={100-mape:.2f}%")
        
        # ê³ ê¸‰ ì•™ìƒë¸” ìƒì„±
        print("\nğŸ”¥ ê³ ê¸‰ ì•™ìƒë¸” ìƒì„± (ì¶”ì„¸ë³„ ë™ì  ê°€ì¤‘ì¹˜)...")
        
        advanced_ensemble = []
        for i in range(len(all_predictions)):
            m14b = all_predictions.iloc[i]['M14AM14B']
            seq_info = sequence_infos[i]
            seq_trend = seq_info['trend']
            
            # ì¶”ì„¸ë³„ ë™ì  ê°€ì¤‘ì¹˜
            if seq_trend in ['extreme_rising', 'strong_rising']:
                # ê·¹ë‹¨ ìƒìŠ¹ â†’ SpikeDetector ê·¹ëŒ€í™”
                weights = {
                    'SpikeDetector': 0.50,
                    'GoldenRule': 0.25,
                    'ExtremeNet': 0.15,
                    'PatchTST': 0.05,
                    'StableLSTM': 0.05
                }
            elif seq_trend in ['extreme_falling', 'strong_falling']:
                # ê·¹ë‹¨ í•˜ë½ â†’ ì•ˆì • ëª¨ë¸ ìš°ì„ 
                weights = {
                    'PatchTST': 0.35,
                    'StableLSTM': 0.35,
                    'GoldenRule': 0.15,
                    'ExtremeNet': 0.10,
                    'SpikeDetector': 0.05
                }
            elif seq_trend in ['high_increasing', 'high_stable', 'high_decreasing']:
                # ê³ í‰ì› ìƒíƒœ â†’ ê· í˜•ì¡íŒ ê°€ì¤‘ì¹˜
                weights = {
                    'SpikeDetector': 0.25,
                    'GoldenRule': 0.25,
                    'PatchTST': 0.20,
                    'StableLSTM': 0.15,
                    'ExtremeNet': 0.15
                }
            else:
                # ì¼ë°˜ ìƒíƒœ
                weights = {
                    'PatchTST': 0.30,
                    'StableLSTM': 0.25,
                    'ExtremeNet': 0.20,
                    'SpikeDetector': 0.15,
                    'GoldenRule': 0.10
                }
            
            ensemble_pred = 0
            total_weight = 0
            
            for model_name in self.models.keys():
                if model_name in weights:
                    weight = weights[model_name]
                    ensemble_pred += all_predictions.iloc[i][f'{model_name}_ì˜ˆì¸¡'] * weight
                    total_weight += weight
            
            if total_weight > 0:
                ensemble_pred = ensemble_pred / total_weight
            
            advanced_ensemble.append(ensemble_pred)
        
        # ê³ ê¸‰ ì•™ìƒë¸” ê²°ê³¼ ì¶”ê°€
        all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜ˆì¸¡'] = [round(p) for p in advanced_ensemble]
        all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜¤ì°¨'] = all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜ˆì¸¡'] - all_predictions['ì‹¤ì œê°’']
        all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜¤ì°¨ìœ¨(%)'] = round(
            abs(all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜¤ì°¨']) / all_predictions['ì‹¤ì œê°’'] * 100, 2
        )
        
        # ê³ ê¸‰ ì•™ìƒë¸” ì„±ëŠ¥
        ensemble_mae = mean_absolute_error(all_predictions['ì‹¤ì œê°’'], advanced_ensemble)
        ensemble_rmse = np.sqrt(mean_squared_error(all_predictions['ì‹¤ì œê°’'], advanced_ensemble))
        ensemble_r2 = r2_score(all_predictions['ì‹¤ì œê°’'], advanced_ensemble)
        ensemble_mape = np.mean(abs(all_predictions['ê³ ê¸‰ì•™ìƒë¸”_ì˜¤ì°¨']) / all_predictions['ì‹¤ì œê°’']) * 100
        
        model_metrics['ê³ ê¸‰ì•™ìƒë¸”'] = {
            'MAE': ensemble_mae,
            'RMSE': ensemble_rmse,
            'R2': ensemble_r2,
            'MAPE': ensemble_mape,
            'ì •í™•ë„(%)': 100 - ensemble_mape
        }
        
        print(f"âœ… ê³ ê¸‰ì•™ìƒë¸”: MAE={ensemble_mae:.2f}, RÂ²={ensemble_r2:.4f}, ì •í™•ë„={100-ensemble_mape:.2f}%")
        
        # CSV ì €ì¥
        output_file = f'v67_advanced_predictions_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv'
        all_predictions.to_csv(output_file, index=False, encoding='utf-8-sig')
        print(f"\nğŸ’¾ ì˜ˆì¸¡ê°’ ì €ì¥: {output_file}")
        
        # ê³ ê°’ êµ¬ê°„ ìƒì„¸ ë¶„ì„
        print("\n" + "="*80)
        print("ğŸ¯ ê³ ê°’ êµ¬ê°„ (1700+) ìƒì„¸ ë¶„ì„")
        print("="*80)
        
        high_mask = all_predictions['ì‹¤ì œê°’'] >= 1700
        if high_mask.any():
            high_df = all_predictions[high_mask]
            print(f"\nğŸ“Š ê³ ê°’ ìƒ˜í”Œ: {high_mask.sum()}ê°œ")
            
            # ì¶”ì„¸ë³„ ê³ ê°’ ë¶„í¬
            print(f"\n[ê³ ê°’ êµ¬ê°„ ì¶”ì„¸ ë¶„í¬]")
            high_trends = high_df['ì‹œí€€ìŠ¤_ì¶”ì„¸'].value_counts()
            for trend, count in high_trends.items():
                print(f"  {trend}: {count}ê°œ")
            
            # ì—°ì† ìƒìŠ¹/í•˜ë½ í†µê³„
            print(f"\n[ê³ ê°’ êµ¬ê°„ ì—°ì† ë³€í™”]")
            print(f"  í‰ê·  ì—°ì† ìƒìŠ¹: {high_df['ì—°ì†ìƒìŠ¹'].mean():.1f}ë¶„")
            print(f"  í‰ê·  ì—°ì† í•˜ë½: {high_df['ì—°ì†í•˜ë½'].mean():.1f}ë¶„")
            print(f"  í‰ê·  ìƒìŠ¹ ê°•ë„: {high_df['ìƒìŠ¹ê°•ë„'].mean():.1f}")
            print(f"  í‰ê·  í•˜ë½ ê°•ë„: {high_df['í•˜ë½ê°•ë„'].mean():.1f}")
        
        # ì„±ëŠ¥ ìš”ì•½
        print("\n" + "="*80)
        print("ğŸ“Š ì „ì²´ ëª¨ë¸ ì„±ëŠ¥ ìš”ì•½")
        print("="*80)
        
        metrics_df = pd.DataFrame(model_metrics).T
        metrics_df = metrics_df.sort_values('R2', ascending=False)
        
        print(f"\n{'ëª¨ë¸':<15} {'MAE':>8} {'RMSE':>8} {'RÂ²':>8} {'MAPE(%)':>8} {'ì •í™•ë„(%)':>10}")
        print("-" * 65)
        
        for model_name, row in metrics_df.iterrows():
            if model_name == 'ê³ ê¸‰ì•™ìƒë¸”':
                print(f"{'ğŸ”¥ ' + model_name:<15} {row['MAE']:8.2f} {row['RMSE']:8.2f} "
                      f"{row['R2']:8.4f} {row['MAPE']:8.2f} {row['ì •í™•ë„(%)']:10.2f} â­â­â­")
            else:
                print(f"{model_name:<15} {row['MAE']:8.2f} {row['RMSE']:8.2f} "
                      f"{row['R2']:8.4f} {row['MAPE']:8.2f} {row['ì •í™•ë„(%)']:10.2f}")
        
        return all_predictions, metrics_df

def main():
    """ë©”ì¸ ì‹¤í–‰"""
    
    print("\nğŸš€ V6.7 ê³ ê¸‰ ê·¹ë‹¨ê°’ í‰ê°€ ì‹œì‘!")
    print("í•µì‹¬ ê¸°ëŠ¥:")
    print("  âœ… ì—°ì† ìƒìŠ¹/í•˜ë½ ê°ì§€ (ìµœëŒ€ ì—°ì† ë¶„)")
    print("  âœ… ë³€í™” ê°•ë„ ì¸¡ì • (10ë¶„ê°„ ì´ ë³€í™”ëŸ‰)")
    print("  âœ… ê³ í‰ì› ìƒíƒœ ì„¸ë¶„í™” (1700+ ìœ ì§€)")
    print("  âœ… ê·¹ë‹¨ì  ë³€í™” íŠ¹ë³„ ì²˜ë¦¬")
    
    # í‰ê°€ê¸° ìƒì„±
    evaluator = AdvancedModelEvaluator()
    
    # ëª¨ë“  ëª¨ë¸ ë¡œë“œ
    models = evaluator.load_all_models('models/')
    
    if not models:
        print("âŒ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤!")
        return
    
    # í…ŒìŠ¤íŠ¸ íŒŒì¼
    test_files = [
        'data/M14_20250916_20250817.csv',
        'data/test_data.csv', 
        '/mnt/user-data/uploads/test.csv'
    ]
    
    test_file = None
    for file in test_files:
        if os.path.exists(file):
            test_file = file
            break
    
    if not test_file:
        print("âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        return
    
    # í‰ê°€ ì‹¤í–‰
    all_predictions, metrics = evaluator.evaluate_all_models(test_file)
    
    print("\n" + "="*80)
    print("ğŸ† V6.7 ê³ ê¸‰ ê·¹ë‹¨ê°’ í‰ê°€ ì™„ë£Œ!")
    print("="*80)
    print("\nğŸ“ ì €ì¥ëœ íŒŒì¼:")
    print(f"  v67_advanced_predictions_YYYYMMDD.csv")
    print("\nğŸ”¥ í•µì‹¬ ê¸°ëŠ¥:")
    print("  âœ… 10ë¶„+ ì—°ì† ìƒìŠ¹ â†’ ê·¹ë‹¨ ë¶€ìŠ¤íŒ…")
    print("  âœ… 10ë¶„+ ì—°ì† í•˜ë½ â†’ ë³´ìˆ˜ì  ì˜ˆì¸¡")
    print("  âœ… ê³ í‰ì› ìƒíƒœ â†’ ì•ˆì •ì  ì˜ˆì¸¡")
    print("  âœ… ì¶”ì„¸ë³„ ë™ì  ì•™ìƒë¸” ê°€ì¤‘ì¹˜")
    print("="*80)

if __name__ == "__main__":
    main()