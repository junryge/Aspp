"""
ğŸ”¥ ExtremeNet ì˜ˆì¸¡ ì‹œìŠ¤í…œ - ì‹¤ì œ CSV ì§ì ‘ ì‚¬ìš©
data/20250807_DATA.CSV íŒŒì¼ ë¡œë“œ
"""

import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import os

print("="*80)
print("ğŸ”¥ ExtremeNet ì˜ˆì¸¡ ì‹œìŠ¤í…œ")
print("ğŸ“Š ì •ìƒ(900-1400) / ì£¼ì˜(1400-1699) / ì‹¬ê°(1700+)")
print("="*80)

# ====================== UU1/UU2 íŒ¨í„´ ê°ì§€ ======================
def detect_pattern(df):
    """UU1/UU2 íŒ¨í„´ ê°ì§€"""
    
    print("\nğŸ” íŒ¨í„´ ê°ì§€ ì¤‘...")
    
    # í†µê³„ ê³„ì‚°
    totalcnt_max = df['TOTALCNT'].max()
    m14b_mean = df['M14AM14B'].mean()
    m14b_max = df['M14AM14B'].max()
    high_cases = len(df[df['TOTALCNT'] >= 1682])
    m14b_350_ratio = (df['M14AM14B'] > 350).sum() / len(df)
    
    print(f"  TOTALCNT ìµœëŒ€: {totalcnt_max:,}")
    print(f"  M14AM14B í‰ê· : {m14b_mean:.0f}")
    print(f"  M14AM14B ìµœëŒ€: {m14b_max}")
    print(f"  1682+ ì¼€ì´ìŠ¤: {high_cases}ê°œ")
    
    # íŒ¨í„´ íŒì •
    if high_cases > 0 and m14b_mean > 380:
        pattern = "UU2"
        print("  ğŸ”¥ UU2 íŒ¨í„´ ê°ì§€: ê³ ê°’ ìœ ì§€ ìƒíƒœ")
    elif m14b_350_ratio > 0.3:
        pattern = "UU2"
        print("  ğŸ”¥ UU2 íŒ¨í„´ ê°ì§€: M14B ë†’ìŒ")
    else:
        pattern = "UU1"
        print("  ğŸ“ˆ UU1 íŒ¨í„´ ê°ì§€: ê¸‰ì¦ ê°€ëŠ¥")
    
    return pattern

# ====================== ExtremeNet ì˜ˆì¸¡ ======================
def extremenet_predict(df, pattern):
    """ExtremeNet ì˜ˆì¸¡ê°’ ê³„ì‚°"""
    
    # í˜„ì¬ ìƒíƒœ
    current_val = df['TOTALCNT'].iloc[-1]
    m14b = df['M14AM14B'].iloc[-1]
    m14a = df['M14AM10A'].iloc[-1]
    ratio = m14b / (m14a + 1)
    
    # ì—°ì† ìƒìŠ¹ ê³„ì‚°
    consecutive_rises = 0
    for i in range(len(df)-1, 0, -1):
        if df['TOTALCNT'].iloc[i] > df['TOTALCNT'].iloc[i-1]:
            consecutive_rises += 1
        else:
            break
    
    # ì¶”ì„¸ íŒë‹¨
    recent_10 = df['TOTALCNT'].tail(10).values
    change = recent_10[-1] - recent_10[0] if len(recent_10) >= 2 else 0
    trend = "increasing" if change > 30 else "decreasing" if change < -30 else "stable"
    
    print(f"\nğŸ“Š í˜„ì¬ ìƒíƒœ:")
    print(f"  TOTALCNT: {current_val:,}")
    print(f"  M14AM14B: {m14b}")
    print(f"  M14AM10A: {m14a}")
    print(f"  ë¹„ìœ¨: {ratio:.2f}")
    print(f"  ì—°ì†ìƒìŠ¹: {consecutive_rises}íšŒ")
    print(f"  ì¶”ì„¸: {trend}")
    
    # ExtremeNet ì˜ˆì¸¡ ë¡œì§
    if pattern == "UU1":
        # UU1: ê¸‰ì¦ ê°€ëŠ¥
        if current_val >= 1650 and trend == "increasing" and m14b > 300:
            predicted = max(1700, current_val * 1.20)
        elif m14b > 300 and m14a < 80:  # í™©ê¸ˆ íŒ¨í„´
            predicted = max(1680, current_val * 1.15)
        elif consecutive_rises >= 10:
            predicted = max(1650, current_val * 1.12)
        elif m14b >= 400:
            predicted = 1550
        elif m14b >= 350:
            predicted = 1520
        elif m14b >= 300:
            predicted = 1480
        else:
            predicted = current_val * 1.02
            
        # ì¶”ì„¸ ë³´ì •
        if trend == "increasing":
            predicted *= 1.05
        elif trend == "decreasing":
            predicted *= 0.98
            
    else:  # UU2
        # UU2: ë³´ìˆ˜ì  ì˜ˆì¸¡
        if m14b >= 450:
            predicted = min(1750, current_val * 1.02)
        elif m14b >= 400:
            predicted = min(1700, current_val * 1.01)
        else:
            predicted = current_val * 0.99
    
    return int(predicted)

# ====================== í™•ë¥  ê³„ì‚° ======================
def calculate_probabilities(predicted_value, pattern):
    """ì •ìƒ/ì£¼ì˜/ì‹¬ê° í™•ë¥  ê³„ì‚°"""
    
    if pattern == "UU1":
        if predicted_value < 1400:
            probs = {'ì •ìƒí™•ë¥ ': 85, 'ì£¼ì˜í™•ë¥ ': 15, 'ì‹¬ê°í™•ë¥ ': 0}
        elif 1400 <= predicted_value < 1500:
            probs = {'ì •ìƒí™•ë¥ ': 10, 'ì£¼ì˜í™•ë¥ ': 85, 'ì‹¬ê°í™•ë¥ ': 5}
        elif 1500 <= predicted_value < 1600:
            probs = {'ì •ìƒí™•ë¥ ': 5, 'ì£¼ì˜í™•ë¥ ': 80, 'ì‹¬ê°í™•ë¥ ': 15}
        elif 1600 <= predicted_value < 1700:
            probs = {'ì •ìƒí™•ë¥ ': 0, 'ì£¼ì˜í™•ë¥ ': 60, 'ì‹¬ê°í™•ë¥ ': 40}
        elif 1700 <= predicted_value < 1800:
            probs = {'ì •ìƒí™•ë¥ ': 0, 'ì£¼ì˜í™•ë¥ ': 20, 'ì‹¬ê°í™•ë¥ ': 80}
        else:
            probs = {'ì •ìƒí™•ë¥ ': 0, 'ì£¼ì˜í™•ë¥ ': 5, 'ì‹¬ê°í™•ë¥ ': 95}
    else:  # UU2
        if predicted_value < 1400:
            probs = {'ì •ìƒí™•ë¥ ': 90, 'ì£¼ì˜í™•ë¥ ': 10, 'ì‹¬ê°í™•ë¥ ': 0}
        elif 1400 <= predicted_value < 1600:
            probs = {'ì •ìƒí™•ë¥ ': 10, 'ì£¼ì˜í™•ë¥ ': 80, 'ì‹¬ê°í™•ë¥ ': 10}
        elif 1600 <= predicted_value < 1700:
            probs = {'ì •ìƒí™•ë¥ ': 0, 'ì£¼ì˜í™•ë¥ ': 50, 'ì‹¬ê°í™•ë¥ ': 50}
        else:
            probs = {'ì •ìƒí™•ë¥ ': 0, 'ì£¼ì˜í™•ë¥ ': 20, 'ì‹¬ê°í™•ë¥ ': 80}
    
    return probs

# ====================== ë©”ì¸ ì‹¤í–‰ ======================
def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    
    # CSV íŒŒì¼ ê²½ë¡œ
    csv_file = 'data/20250807_DATA.CSV'
    
    # íŒŒì¼ ì²´í¬
    if not os.path.exists(csv_file):
        print(f"âŒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {csv_file}")
        return
    
    # ë°ì´í„° ë¡œë“œ
    print(f"\nğŸ“‚ ë°ì´í„° ë¡œë”©: {csv_file}")
    df = pd.read_csv(csv_file)
    
    # ì‹œê°„ ì •ë ¬
    df['CURRTIME'] = pd.to_datetime(df['CURRTIME'].astype(str), format='%Y%m%d%H%M')
    df = df.sort_values('CURRTIME').reset_index(drop=True)
    
    print(f"  ë¡œë“œ ì™„ë£Œ: {len(df)}ê°œ í–‰")
    
    # íŒ¨í„´ ê°ì§€
    pattern = detect_pattern(df)
    
    # ExtremeNet ì˜ˆì¸¡
    predicted_value = extremenet_predict(df, pattern)
    
    # í™•ë¥  ê³„ì‚°
    probabilities = calculate_probabilities(predicted_value, pattern)
    
    # ê²°ê³¼ ì¤€ë¹„
    simple_dict = {
        'ì˜ˆì¸¡ê°’': predicted_value,
        'ì •ìƒí™•ë¥ ': probabilities['ì •ìƒí™•ë¥ '],
        'ì£¼ì˜í™•ë¥ ': probabilities['ì£¼ì˜í™•ë¥ '],
        'ì‹¬ê°í™•ë¥ ': probabilities['ì‹¬ê°í™•ë¥ ']
    }
    
    # ê²°ê³¼ íŒì •
    if predicted_value >= 1700:
        simple_result = "ğŸ”´ ì‹¬ê° - ë¬¼ë¥˜ëŸ‰ ê¸‰ì¦!"
    elif predicted_value >= 1400:
        simple_result = "ğŸŸ¡ ì£¼ì˜ - ë¬¼ë¥˜ëŸ‰ ì¦ê°€ ëŒ€ë¹„"
    else:
        simple_result = "ğŸŸ¢ ì •ìƒ - ì•ˆì •ì "
    
    # ê²°ê³¼ ì¶œë ¥
    print("\n" + "="*80)
    print("ğŸ”¥ ExtremeNet ìµœì¢… ì˜ˆì¸¡")
    print("="*80)
    
    current_time = df['CURRTIME'].iloc[-1]
    pred_time = current_time + timedelta(minutes=10)
    
    print(f"\níŒ¨í„´: {pattern}")
    print(f"í˜„ì¬ì‹œê°„: {current_time.strftime('%Y-%m-%d %H:%M')}")
    print(f"ì˜ˆì¸¡ì‹œê°„: {pred_time.strftime('%Y-%m-%d %H:%M')} (10ë¶„ í›„)")
    
    print("\n" + "-"*50)
    print(f"ì˜ˆì¸¡ê°’: {simple_dict['ì˜ˆì¸¡ê°’']}")
    print(f"ğŸŸ¢ì •ìƒí™•ë¥ : {simple_dict['ì •ìƒí™•ë¥ ']}%")
    print(f"ğŸŸ¡ì£¼ì˜í™•ë¥ : {simple_dict['ì£¼ì˜í™•ë¥ ']}%")
    print(f"ğŸ”´ì‹¬ê°í™•ë¥ : {simple_dict['ì‹¬ê°í™•ë¥ ']}%")
    print(f"ê²°ê³¼: {simple_result}")
    print("-"*50)
    
    # ====================== ê°„ë‹¨ ì¶œë ¥ ì¶”ê°€ ======================
    print("\n" + "="*50)
    print("ğŸ“Œ ê°„ë‹¨ ê²°ê³¼")
    print("="*50)
    
    # ê°€ì¥ ë†’ì€ í™•ë¥  ì°¾ê¸°
    max_prob_key = max(simple_dict, key=lambda k: simple_dict[k] if k != 'ì˜ˆì¸¡ê°’' else 0)
    max_prob_value = simple_dict[max_prob_key]
    
    # í•œê¸€ ë³€í™˜
    status_map = {
        'ì •ìƒí™•ë¥ ': 'ì •ìƒ',
        'ì£¼ì˜í™•ë¥ ': 'ì£¼ì˜', 
        'ì‹¬ê°í™•ë¥ ': 'ì‹¬ê°'
    }
    
    print(f"ì˜ˆì¸¡ê°’: {simple_dict['ì˜ˆì¸¡ê°’']}")
    print(f"{status_map[max_prob_key]}: {max_prob_value}%")

if __name__ == "__main__":
    main()