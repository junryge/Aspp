"""
scaler_from_sequence.py
ì´ë¯¸ ìˆëŠ” ì‹œí€€ìŠ¤ íŒŒì¼(sequences_v6.npz)ì—ì„œ ìŠ¤ì¼€ì¼ëŸ¬ë§Œ ìƒì„±
CPU ë²„ì „ - ë¹ ë¥´ê²Œ ì‹¤í–‰
"""

import numpy as np
from sklearn.preprocessing import RobustScaler
import pickle
import os
from datetime import datetime

print("="*60)
print("ğŸ”§ ì‹œí€€ìŠ¤ì—ì„œ ìŠ¤ì¼€ì¼ëŸ¬ ì¶”ì¶œ/ìƒì„± í”„ë¡œê·¸ë¨")
print("="*60)

# ============================================
# ì„¤ì •
# ============================================
class Config:
    # ê¸°ì¡´ ì‹œí€€ìŠ¤ íŒŒì¼ ê²½ë¡œ (ì´ë¯¸ ìˆëŠ” íŒŒì¼)
    SEQUENCE_FILE = './sequences_v6.npz'  # ğŸ‘ˆ ì—¬ê¸°ì— ì‹¤ì œ ì‹œí€€ìŠ¤ íŒŒì¼ ê²½ë¡œ
    
    # ìƒì„±í•  ìŠ¤ì¼€ì¼ëŸ¬ íŒŒì¼ ê²½ë¡œ
    SCALER_FILE = './scalers_v6_gpu.pkl'  # ğŸ‘ˆ ì €ì¥í•  ìŠ¤ì¼€ì¼ëŸ¬ íŒŒì¼ëª…
    
    # ìŠ¤ì¼€ì¼ ë°©ì‹
    USE_ROBUST = True  # True: RobustScaler, False: StandardScaler

# ============================================
# ë©”ì¸ í•¨ìˆ˜
# ============================================
def create_scaler_from_sequence():
    """ê¸°ì¡´ ì‹œí€€ìŠ¤ì—ì„œ ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±"""
    
    print(f"\nğŸ“‚ ì‹œí€€ìŠ¤ íŒŒì¼ ë¡œë“œ ì¤‘: {Config.SEQUENCE_FILE}")
    
    # 1. ì‹œí€€ìŠ¤ íŒŒì¼ í™•ì¸
    if not os.path.exists(Config.SEQUENCE_FILE):
        print(f"âŒ ì‹œí€€ìŠ¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {Config.SEQUENCE_FILE}")
        print("íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!")
        return False
    
    # 2. ì‹œí€€ìŠ¤ ë¡œë“œ
    try:
        data = np.load(Config.SEQUENCE_FILE)
        print("âœ… ì‹œí€€ìŠ¤ ë¡œë“œ ì„±ê³µ")
        
        # ë°ì´í„° í™•ì¸
        print("\nğŸ“Š ë¡œë“œëœ ë°ì´í„°:")
        for key in data.files:
            if isinstance(data[key], np.ndarray):
                print(f"  - {key}: shape {data[key].shape}, dtype {data[key].dtype}")
            else:
                print(f"  - {key}: {type(data[key])}")
    except Exception as e:
        print(f"âŒ ì‹œí€€ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: {e}")
        return False
    
    # 3. í•„ìˆ˜ ë°ì´í„° ì¶”ì¶œ
    print("\nğŸ“¦ ë°ì´í„° ì¶”ì¶œ ì¤‘...")
    
    # X ë°ì´í„° (ì´ë¯¸ ìŠ¤ì¼€ì¼ëœ ë°ì´í„°ì¼ ìˆ˜ë„ ìˆìŒ)
    if 'X' in data.files:
        X = data['X']
        print(f"  âœ… X ë°ì´í„°: {X.shape}")
    else:
        print("âŒ X ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return False
    
    # y ë°ì´í„° (ì›ë³¸ ë˜ëŠ” ìŠ¤ì¼€ì¼ëœ ë²„ì „)
    y_original = None
    y_scaled = None
    
    if 'y_original' in data.files:
        y_original = data['y_original']
        print(f"  âœ… y_original: {y_original.shape}")
    elif 'y' in data.files:
        y_original = data['y']
        print(f"  âœ… y: {y_original.shape}")
    
    if 'y_scaled' in data.files:
        y_scaled = data['y_scaled']
        print(f"  âœ… y_scaled: {y_scaled.shape}")
    
    # M14 íŠ¹ì§•
    m14_features = None
    m14_features_scaled = None
    
    if 'm14_features' in data.files:
        m14_features = data['m14_features']
        print(f"  âœ… m14_features: {m14_features.shape}")
    
    if 'm14_features_scaled' in data.files:
        m14_features_scaled = data['m14_features_scaled']
        print(f"  âœ… m14_features_scaled: {m14_features_scaled.shape}")
    
    # íŠ¹ì§• ì´ë¦„ (ìˆìœ¼ë©´)
    feature_names = None
    if 'feature_names' in data.files:
        feature_names = data['feature_names']
        print(f"  âœ… feature_names: {len(feature_names)}ê°œ")
    
    # ============================================
    # 4. ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±
    # ============================================
    print("\nğŸ“ ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„± ì¤‘...")
    
    # ìŠ¤ì¼€ì¼ëŸ¬ íƒ€ì… ì„ íƒ
    if Config.USE_ROBUST:
        ScalerClass = RobustScaler
        print("  ìŠ¤ì¼€ì¼ëŸ¬ íƒ€ì…: RobustScaler (ì´ìƒì¹˜ì— ê°•í•¨)")
    else:
        from sklearn.preprocessing import StandardScaler
        ScalerClass = StandardScaler
        print("  ìŠ¤ì¼€ì¼ëŸ¬ íƒ€ì…: StandardScaler")
    
    # 1. X íŠ¹ì§• ìŠ¤ì¼€ì¼ëŸ¬
    print("\n  1ï¸âƒ£ X íŠ¹ì§• ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±...")
    feature_scalers = {}
    
    n_features = X.shape[2]
    print(f"    íŠ¹ì§• ìˆ˜: {n_features}ê°œ")
    
    for i in range(n_features):
        # ê° íŠ¹ì§•ë³„ë¡œ ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±
        scaler = ScalerClass()
        
        # 2Dë¡œ reshapeí•˜ì—¬ fit
        feature_data = X[:, :, i].reshape(-1, 1)
        scaler.fit(feature_data)
        
        # ì €ì¥
        feature_scalers[f'feature_{i}'] = scaler
        
        # ì§„í–‰ í‘œì‹œ
        if (i + 1) % 10 == 0 or i == n_features - 1:
            print(f"      {i + 1}/{n_features} ì™„ë£Œ")
    
    print(f"  âœ… {len(feature_scalers)}ê°œ íŠ¹ì§• ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„± ì™„ë£Œ")
    
    # 2. y ìŠ¤ì¼€ì¼ëŸ¬
    y_scaler = None
    if y_original is not None:
        print("\n  2ï¸âƒ£ y(íƒ€ê²Ÿ) ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±...")
        y_scaler = ScalerClass()
        y_scaler.fit(y_original.reshape(-1, 1))
        
        print(f"  âœ… y ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„± ì™„ë£Œ")
        print(f"    ì›ë³¸ ë²”ìœ„: {y_original.min():.0f} ~ {y_original.max():.0f}")
        
        # ê²€ì¦: ìŠ¤ì¼€ì¼ í…ŒìŠ¤íŠ¸
        y_test = y_scaler.transform(y_original[:10].reshape(-1, 1))
        print(f"    í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¼ ë²”ìœ„: {y_test.min():.2f} ~ {y_test.max():.2f}")
    
    # 3. M14 ìŠ¤ì¼€ì¼ëŸ¬
    m14_scaler = None
    if m14_features is not None:
        print("\n  3ï¸âƒ£ M14 íŠ¹ì§• ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„±...")
        m14_scaler = ScalerClass()
        m14_scaler.fit(m14_features)
        
        print(f"  âœ… M14 ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„± ì™„ë£Œ")
        print(f"    M14 shape: {m14_features.shape}")
        print(f"    M14B ë²”ìœ„: {m14_features[:, 0].min():.0f} ~ {m14_features[:, 0].max():.0f}")
        print(f"    M10A ë²”ìœ„: {m14_features[:, 1].min():.0f} ~ {m14_features[:, 1].max():.0f}")
    
    # ============================================
    # 5. ìŠ¤ì¼€ì¼ëŸ¬ ì €ì¥
    # ============================================
    print("\nğŸ’¾ ìŠ¤ì¼€ì¼ëŸ¬ ì €ì¥ ì¤‘...")
    
    # ì €ì¥í•  ë”•ì…”ë„ˆë¦¬
    scaler_dict = {
        'feature_scalers': feature_scalers,
        'y_scaler': y_scaler,
        'm14_scaler': m14_scaler,
        'creation_time': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'scaler_type': 'RobustScaler' if Config.USE_ROBUST else 'StandardScaler',
        'source_file': Config.SEQUENCE_FILE,
        'data_info': {
            'n_samples': X.shape[0],
            'n_timesteps': X.shape[1],
            'n_features': X.shape[2],
        }
    }
    
    # íŠ¹ì§• ì´ë¦„ ì¶”ê°€ (ìˆìœ¼ë©´)
    if feature_names is not None:
        scaler_dict['feature_names'] = feature_names
    
    # y ë²”ìœ„ ì •ë³´ ì¶”ê°€
    if y_original is not None:
        scaler_dict['data_info']['y_range'] = [float(y_original.min()), float(y_original.max())]
    
    # pkl íŒŒì¼ë¡œ ì €ì¥
    try:
        with open(Config.SCALER_FILE, 'wb') as f:
            pickle.dump(scaler_dict, f)
        
        print(f"  âœ… ìŠ¤ì¼€ì¼ëŸ¬ ì €ì¥ ì™„ë£Œ: {Config.SCALER_FILE}")
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        file_size = os.path.getsize(Config.SCALER_FILE) / 1024  # KB
        print(f"  ğŸ“ íŒŒì¼ í¬ê¸°: {file_size:.1f} KB")
    except Exception as e:
        print(f"âŒ ì €ì¥ ì‹¤íŒ¨: {e}")
        return False
    
    # ============================================
    # 6. ê²€ì¦ (ë‹¤ì‹œ ë¡œë“œí•´ì„œ í…ŒìŠ¤íŠ¸)
    # ============================================
    print("\nğŸ” ìŠ¤ì¼€ì¼ëŸ¬ ê²€ì¦ ì¤‘...")
    
    try:
        # ì €ì¥ëœ ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ
        with open(Config.SCALER_FILE, 'rb') as f:
            loaded_scalers = pickle.load(f)
        
        print("  âœ… ìŠ¤ì¼€ì¼ëŸ¬ ë¡œë“œ ì„±ê³µ")
        print(f"    íŠ¹ì§• ìŠ¤ì¼€ì¼ëŸ¬ ìˆ˜: {len(loaded_scalers['feature_scalers'])}")
        print(f"    ìŠ¤ì¼€ì¼ëŸ¬ íƒ€ì…: {loaded_scalers['scaler_type']}")
        print(f"    ìƒì„± ì‹œê°„: {loaded_scalers['creation_time']}")
        print(f"    ì†ŒìŠ¤ íŒŒì¼: {loaded_scalers['source_file']}")
        
        # ìƒ˜í”Œ ë³€í™˜ í…ŒìŠ¤íŠ¸
        print("\n  ğŸ“Š ìƒ˜í”Œ ë³€í™˜ í…ŒìŠ¤íŠ¸:")
        
        # X í…ŒìŠ¤íŠ¸
        test_feature = X[0, :, 0].reshape(-1, 1)  # ì²« ë²ˆì§¸ ìƒ˜í”Œì˜ ì²« ë²ˆì§¸ íŠ¹ì§•
        test_scaler = loaded_scalers['feature_scalers']['feature_0']
        test_scaled = test_scaler.transform(test_feature[:5].reshape(-1, 1))
        print(f"    X ì›ë³¸ ìƒ˜í”Œ: {test_feature[:5].flatten()}")
        print(f"    X ìŠ¤ì¼€ì¼ ìƒ˜í”Œ: {test_scaled.flatten()}")
        
        # y í…ŒìŠ¤íŠ¸
        if loaded_scalers['y_scaler'] is not None and y_original is not None:
            test_y = y_original[:5].reshape(-1, 1)
            test_y_scaled = loaded_scalers['y_scaler'].transform(test_y)
            print(f"    y ì›ë³¸ ìƒ˜í”Œ: {test_y.flatten()}")
            print(f"    y ìŠ¤ì¼€ì¼ ìƒ˜í”Œ: {test_y_scaled.flatten()}")
            
            # ì—­ë³€í™˜ í…ŒìŠ¤íŠ¸
            test_y_inverse = loaded_scalers['y_scaler'].inverse_transform(test_y_scaled)
            print(f"    y ì—­ë³€í™˜ ìƒ˜í”Œ: {test_y_inverse.flatten()}")
            print(f"    ì—­ë³€í™˜ ì˜¤ì°¨: {np.abs(test_y.flatten() - test_y_inverse.flatten()).mean():.6f}")
        
        print("\nâœ… ëª¨ë“  ê²€ì¦ í†µê³¼!")
        
    except Exception as e:
        print(f"âŒ ê²€ì¦ ì‹¤íŒ¨: {e}")
        return False
    
    # ============================================
    # 7. ì™„ë£Œ
    # ============================================
    print("\n" + "="*60)
    print("ğŸ‰ ìŠ¤ì¼€ì¼ëŸ¬ ìƒì„± ì™„ë£Œ!")
    print("="*60)
    print(f"ğŸ“ ìŠ¤ì¼€ì¼ëŸ¬ íŒŒì¼: {Config.SCALER_FILE}")
    print(f"ğŸ“Š íŠ¹ì§• ìˆ˜: {n_features}ê°œ")
    if y_original is not None:
        print(f"ğŸ“Š y ë²”ìœ„: {y_original.min():.0f} ~ {y_original.max():.0f}")
    if m14_features is not None:
        print(f"ğŸ“Š M14 íŠ¹ì§•: {m14_features.shape[1]}ê°œ")
    print("\nğŸ’¡ ì´ì œ í•™ìŠµ ì½”ë“œì—ì„œ ì´ ìŠ¤ì¼€ì¼ëŸ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
    
    return True

# ============================================
# ì‹¤í–‰
# ============================================
if __name__ == "__main__":
    success = create_scaler_from_sequence()
    
    if success:
        print("\nâœ… í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ")
    else:
        print("\nâŒ í”„ë¡œê·¸ë¨ ì‹¤íŒ¨")