# -*- coding: utf-8 -*-
"""
V6_GPU_ì‹œí€€ìŠ¤ìƒì„±_ìµœì¢…ë³¸.py - GPU ê°€ì† ì‹œí€€ìŠ¤ ìƒì„±ê¸°
ë°˜ë„ì²´ ë¬¼ë¥˜ ì˜ˆì¸¡ì„ ìœ„í•œ 100ë¶„ ì‹œí€€ìŠ¤ ë°ì´í„° ìƒì„±
TensorFlow 2.15.0 GPU ê°€ì† ë²„ì „
"""

import numpy as np
import pandas as pd
import tensorflow as tf
from sklearn.preprocessing import RobustScaler
import pickle
import warnings
from datetime import datetime
import os
import gc
warnings.filterwarnings('ignore')

# ============================================
# GPU ì„¤ì • ë° í™•ì¸
# ============================================
def setup_gpu():
    """GPU ì„¤ì • ë° ìƒíƒœ í™•ì¸"""
    print("\nðŸŽ® GPU ì„¤ì • ì¤‘...")
    
    # GPU ì‚¬ìš© ê°€ëŠ¥ í™•ì¸
    gpus = tf.config.list_physical_devices('GPU')
    
    if gpus:
        try:
            # GPU ë©”ëª¨ë¦¬ ì¦ê°€ í—ˆìš©
            for gpu in gpus:
                tf.config.experimental.set_memory_growth(gpu, True)
            
            # GPU ì •ë³´ ì¶œë ¥
            print(f"  âœ… GPU ê°ì§€: {len(gpus)}ê°œ")
            for i, gpu in enumerate(gpus):
                print(f"    GPU {i}: {gpu.name}")
            
            # CUDA ì •ë³´
            print(f"  ðŸ“Š TensorFlow: {tf.__version__}")
            print(f"  ðŸ”§ CUDA Built: {tf.test.is_built_with_cuda()}")
            print(f"  ðŸš€ GPU ê°€ì†: í™œì„±í™”")
            
            return True
            
        except RuntimeError as e:
            print(f"  âš ï¸ GPU ì„¤ì • ì˜¤ë¥˜: {e}")
            return False
    else:
        print("  âš ï¸ GPU ì—†ìŒ - CPU ëª¨ë“œë¡œ ì‹¤í–‰")
        return False

# ============================================
# ì„¤ì •
# ============================================
class Config:
    # ë°ì´í„° íŒŒì¼
    DATA_FILE = '20250101_TO_20250630000.CSV'
    
    # ì‹œí€€ìŠ¤ ì„¤ì •
    LOOKBACK = 100  # ê³¼ê±° 100ë¶„
    FORECAST = 10   # 10ë¶„ í›„ ì˜ˆì¸¡
    
    # GPU ë°°ì¹˜ ì„¤ì •
    GPU_BATCH_SIZE = 10000  # GPU ë©”ëª¨ë¦¬ì— ë”°ë¼ ì¡°ì •
    
    # M14 ìž„ê³„ê°’ (ë¬¼ë¥˜ëŸ‰ë³„)
    M14B_THRESHOLDS = {
        1400: 320,
        1500: 400,
        1600: 450,
        1700: 500
    }
    
    RATIO_THRESHOLDS = {
        1400: 4,
        1500: 5,
        1600: 6,
        1700: 7
    }
    
    # ì €ìž¥ ê²½ë¡œ
    SAVE_PATH = './sequences_v6_gpu.npz'
    SCALER_PATH = './scalers_v6_gpu.pkl'

# ============================================
# GPU ê°€ì† í•¨ìˆ˜
# ============================================
@tf.function
def create_sequences_gpu(data_tensor, lookback, forecast):
    """GPUì—ì„œ ì‹œí€€ìŠ¤ ìƒì„± (TensorFlow ì—°ì‚°)"""
    
    data_len = tf.shape(data_tensor)[0]
    num_sequences = data_len - lookback - forecast + 1
    
    # ì¸ë±ìŠ¤ ìƒì„±
    indices = tf.range(num_sequences)
    
    # ì‹œí€€ìŠ¤ ì¸ë±ì‹±ì„ ìœ„í•œ ë¸Œë¡œë“œìºìŠ¤íŒ…
    seq_indices = tf.expand_dims(indices, 1) + tf.range(lookback)
    target_indices = indices + lookback + forecast - 1
    
    # ì‹œí€€ìŠ¤ ì¶”ì¶œ
    X = tf.gather(data_tensor, seq_indices)
    y = tf.gather(data_tensor[:, 0], target_indices)  # TOTALCNTë§Œ íƒ€ê²Ÿìœ¼ë¡œ
    
    return X, y

@tf.function
def extract_m14_features_gpu(data_tensor, lookback, forecast):
    """GPUì—ì„œ M14 íŠ¹ì§• ì¶”ì¶œ"""
    
    data_len = tf.shape(data_tensor)[0]
    num_sequences = data_len - lookback - forecast + 1
    
    # í˜„ìž¬ ì‹œì  ì¸ë±ìŠ¤
    current_indices = tf.range(lookback, data_len - forecast)
    
    # M14 íŠ¹ì§• ì¶”ì¶œ (í˜„ìž¬ ì‹œì ì˜ M14AM14B, M14AM10A, M14AM16, ratio)
    m14_features = tf.gather(data_tensor, current_indices)
    
    return m14_features

@tf.function
def scale_features_gpu(data_tensor):
    """GPUì—ì„œ íŠ¹ì§• ìŠ¤ì¼€ì¼ë§ (RobustScaler ìœ ì‚¬)"""
    
    # ê° íŠ¹ì§•ë³„ í†µê³„ ê³„ì‚°
    median = tf.reduce_mean(data_tensor, axis=[0, 1], keepdims=True)
    mad = tf.reduce_mean(tf.abs(data_tensor - median), axis=[0, 1], keepdims=True)
    
    # ìŠ¤ì¼€ì¼ë§
    scaled = (data_tensor - median) / (mad + 1e-8)
    
    return scaled, median, mad

# ============================================
# íŠ¹ì§• ì—”ì§€ë‹ˆì–´ë§ (GPU ê°€ì†)
# ============================================
def create_features_gpu(df, config):
    """GPUë¥¼ ì‚¬ìš©í•œ íŠ¹ì§• ìƒì„±"""
    print("\nðŸ”§ GPU íŠ¹ì§• ì—”ì§€ë‹ˆì–´ë§ ì¤‘...")
    
    # DataFrameì„ GPU í…ì„œë¡œ ë³€í™˜
    with tf.device('/GPU:0'):
        # ê¸°ë³¸ ì»¬ëŸ¼ì„ í…ì„œë¡œ ë³€í™˜
        tensor_dict = {}
        for col in df.columns:
            if df[col].dtype in [np.float64, np.float32, np.int64, np.int32]:
                tensor_dict[col] = tf.constant(df[col].values, dtype=tf.float32)
        
        # 1. ê¸°ë³¸ M14 íŠ¹ì§• ì •ê·œí™”
        if 'M14AM14B' in tensor_dict:
            tensor_dict['M14B_norm'] = tensor_dict['M14AM14B'] / 600.0
        
        if 'M14AM10A' in tensor_dict:
            tensor_dict['M10A_inverse'] = (100.0 - tensor_dict['M14AM10A']) / 100.0
        
        if 'M14AM16' in tensor_dict:
            tensor_dict['M16_norm'] = tensor_dict['M14AM16'] / 100.0
        
        # 2. ë¹„ìœ¨ íŠ¹ì§• (GPU ì—°ì‚°)
        if 'M14AM14B' in tensor_dict and 'M14AM10A' in tensor_dict:
            m10a_safe = tf.maximum(tensor_dict['M14AM10A'], 1.0)
            tensor_dict['ratio_14B_10A'] = tensor_dict['M14AM14B'] / m10a_safe
        
        if 'M14AM14B' in tensor_dict and 'M14AM16' in tensor_dict:
            m16_safe = tf.maximum(tensor_dict['M14AM16'], 1.0)
            tensor_dict['ratio_14B_16'] = tensor_dict['M14AM14B'] / m16_safe
        
        # 3. ì´ë™í‰ê·  (GPU ê°€ì† ì»¨ë³¼ë£¨ì…˜)
        for col in ['current_value', 'M14AM14B', 'M14AM10A', 'M14AM16']:
            if col in tensor_dict:
                # 5ë¶„ ë³€í™”ëŸ‰
                padded_5 = tf.concat([tf.zeros(5), tensor_dict[col]], axis=0)
                tensor_dict[f'{col}_change_5'] = tensor_dict[col] - padded_5[:-5]
                
                # 10ë¶„ ë³€í™”ëŸ‰
                padded_10 = tf.concat([tf.zeros(10), tensor_dict[col]], axis=0)
                tensor_dict[f'{col}_change_10'] = tensor_dict[col] - padded_10[:-10]
                
                # ì´ë™í‰ê·  (1D ì»¨ë³¼ë£¨ì…˜ ì‚¬ìš©)
                data_expanded = tf.expand_dims(tf.expand_dims(tensor_dict[col], 0), -1)
                
                # 10ë¶„ ì´ë™í‰ê· 
                kernel_10 = tf.ones([10, 1, 1]) / 10.0
                ma_10 = tf.nn.conv1d(data_expanded, kernel_10, stride=1, padding='SAME')
                tensor_dict[f'{col}_ma_10'] = tf.squeeze(ma_10)
                
                # 30ë¶„ ì´ë™í‰ê· 
                kernel_30 = tf.ones([30, 1, 1]) / 30.0
                ma_30 = tf.nn.conv1d(data_expanded, kernel_30, stride=1, padding='SAME')
                tensor_dict[f'{col}_ma_30'] = tf.squeeze(ma_30)
        
        # 4. ê¸‰ì¦ ì‹ í˜¸ (ìž„ê³„ê°’ ê¸°ë°˜)
        if 'M14AM14B' in tensor_dict:
            for level, threshold in config.M14B_THRESHOLDS.items():
                tensor_dict[f'signal_{level}'] = tf.cast(
                    tensor_dict['M14AM14B'] >= threshold, tf.float32
                )
        
        # 5. ë¹„ìœ¨ ì‹ í˜¸
        if 'ratio_14B_10A' in tensor_dict:
            for level, threshold in config.RATIO_THRESHOLDS.items():
                tensor_dict[f'ratio_signal_{level}'] = tf.cast(
                    tensor_dict['ratio_14B_10A'] >= threshold, tf.float32
                )
        
        # 6. í™©ê¸ˆ íŒ¨í„´ íŠ¹ì§•
        if 'M14AM14B' in tensor_dict and 'M14AM10A' in tensor_dict:
            golden_cond = tf.logical_and(
                tensor_dict['M14AM14B'] >= 350,
                tensor_dict['M14AM10A'] < 70
            )
            tensor_dict['golden_pattern'] = tf.cast(golden_cond, tf.float32)
            
            spike_cond = tf.logical_or(
                tensor_dict['M14AM14B'] >= 400,
                tensor_dict.get('ratio_14B_10A', tf.zeros_like(tensor_dict['M14AM14B'])) >= 5
            )
            tensor_dict['spike_imminent'] = tf.cast(spike_cond, tf.float32)
        
        # í…ì„œë¥¼ numpyë¡œ ë³€í™˜í•˜ì—¬ DataFrame ìƒì„±
        result_dict = {}
        for key, value in tensor_dict.items():
            result_dict[key] = value.numpy()
        
        # ìƒˆë¡œìš´ DataFrame ìƒì„±
        df_new = pd.DataFrame(result_dict)
        
        # ì›ë³¸ DataFrameì˜ non-numeric ì»¬ëŸ¼ ì¶”ê°€
        for col in df.columns:
            if col not in df_new.columns:
                df_new[col] = df[col].values
        
        return df_new

# ============================================
# ë©”ì¸ í•¨ìˆ˜
# ============================================
def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("="*60)
    print("ðŸš€ ë°˜ë„ì²´ ë¬¼ë¥˜ GPU ì‹œí€€ìŠ¤ ìƒì„±ê¸° V6")
    print(f"ðŸ“¦ TensorFlow 2.15.0 GPU ê°€ì†")
    print("="*60)
    
    # GPU ì„¤ì •
    gpu_available = setup_gpu()
    device = '/GPU:0' if gpu_available else '/CPU:0'
    
    start_time = datetime.now()
    
    # ============================================
    # 1. ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬
    # ============================================
    print(f"\nðŸ“‚ ë°ì´í„° ë¡œë”©: {Config.DATA_FILE}")
    df = pd.read_csv(Config.DATA_FILE)
    print(f"  âœ… ë¡œë“œ ì™„ë£Œ: {len(df):,}í–‰")
    
    # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ ë° ìƒì„±
    if 'TOTALCNT' in df.columns:
        df['current_value'] = df['TOTALCNT']
    else:
        numeric_cols = df.select_dtypes(include=[np.number]).columns
        if len(numeric_cols) > 0:
            df['current_value'] = df[numeric_cols[0]]
        else:
            raise ValueError("ìˆ«ìží˜• ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤!")
    
    # M14 ì»¬ëŸ¼ í™•ì¸
    for col in ['M14AM10A', 'M14AM14B', 'M14AM16']:
        if col not in df.columns:
            print(f"  âš ï¸ {col} ì—†ìŒ â†’ 0ìœ¼ë¡œ ì´ˆê¸°í™”")
            df[col] = 0
    
    # íƒ€ê²Ÿ ìƒì„± (10ë¶„ í›„)
    df['target'] = df['current_value'].shift(-Config.FORECAST)
    
    # ============================================
    # 2. GPU íŠ¹ì§• ìƒì„±
    # ============================================
    df = create_features_gpu(df, Config)
    
    # íŠ¹ì§• ì»¬ëŸ¼ ì„ íƒ
    exclude_cols = ['TIME', 'CURRTIME', 'TOTALCNT']
    feature_cols = [col for col in df.columns if col not in exclude_cols]
    
    # ê²°ì¸¡ì¹˜ ì²˜ë¦¬
    df = df.fillna(0)
    df = df.dropna(subset=['target'])
    
    print(f"  âœ… íŠ¹ì§• ìƒì„± ì™„ë£Œ: {len(feature_cols)}ê°œ")
    
    # ============================================
    # 3. GPU ì‹œí€€ìŠ¤ ìƒì„±
    # ============================================
    print(f"\nðŸ“Š GPU ì‹œí€€ìŠ¤ ìƒì„± ì¤‘...")
    
    with tf.device(device):
        # DataFrameì„ í…ì„œë¡œ ë³€í™˜
        data_array = df[feature_cols].values.astype(np.float32)
        data_tensor = tf.constant(data_array)
        
        print(f"  ë°ì´í„° í…ì„œ shape: {data_tensor.shape}")
        print(f"  GPU ë©”ëª¨ë¦¬ ì‚¬ìš© ì¤‘...")
        
        # ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì‹œí€€ìŠ¤ ìƒì„±
        total_sequences = len(df) - Config.LOOKBACK - Config.FORECAST
        print(f"  ì˜ˆìƒ ì‹œí€€ìŠ¤ ìˆ˜: {total_sequences:,}ê°œ")
        
        X_list = []
        y_list = []
        m14_list = []
        
        # ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì²˜ë¦¬ (GPU ë©”ëª¨ë¦¬ ê´€ë¦¬)
        for batch_start in range(0, len(df) - Config.LOOKBACK - Config.FORECAST, Config.GPU_BATCH_SIZE):
            batch_end = min(batch_start + Config.GPU_BATCH_SIZE + Config.LOOKBACK + Config.FORECAST, len(df))
            batch_tensor = data_tensor[batch_start:batch_end]
            
            # GPUì—ì„œ ì‹œí€€ìŠ¤ ìƒì„±
            X_batch, y_batch = create_sequences_gpu(batch_tensor, Config.LOOKBACK, Config.FORECAST)
            
            # M14 íŠ¹ì§• ì¶”ì¶œ (M14AM14B, M14AM10A, M14AM16, ratio_14B_10A ì¸ë±ìŠ¤)
            m14_indices = [
                feature_cols.index('M14AM14B') if 'M14AM14B' in feature_cols else 0,
                feature_cols.index('M14AM10A') if 'M14AM10A' in feature_cols else 0,
                feature_cols.index('M14AM16') if 'M14AM16' in feature_cols else 0,
                feature_cols.index('ratio_14B_10A') if 'ratio_14B_10A' in feature_cols else 0
            ]
            
            # í˜„ìž¬ ì‹œì  M14 íŠ¹ì§• ì¶”ì¶œ
            current_indices = tf.range(batch_start + Config.LOOKBACK, 
                                      min(batch_start + Config.GPU_BATCH_SIZE + Config.LOOKBACK, 
                                          len(df) - Config.FORECAST))
            m14_batch = tf.gather(data_tensor[current_indices], m14_indices, axis=1)
            
            # CPUë¡œ ì´ë™í•˜ì—¬ ì €ìž¥
            X_list.append(X_batch.numpy())
            y_list.append(y_batch.numpy())
            m14_list.append(m14_batch.numpy())
            
            # ì§„í–‰ë¥  í‘œì‹œ
            progress = (batch_start + Config.GPU_BATCH_SIZE) / (len(df) - Config.LOOKBACK - Config.FORECAST) * 100
            print(f"    ì²˜ë¦¬ ì¤‘: {progress:.1f}%", end='\r')
        
        print("\n  âœ… GPU ì‹œí€€ìŠ¤ ìƒì„± ì™„ë£Œ")
        
        # ê²°ê³¼ ë³‘í•©
        X = np.concatenate(X_list, axis=0)
        y = np.concatenate(y_list, axis=0)
        m14_features = np.concatenate(m14_list, axis=0)
        
        # ë©”ëª¨ë¦¬ ì •ë¦¬
        del X_list, y_list, m14_list
        gc.collect()
        
        print(f"\nðŸ“ ìƒì„±ëœ ì‹œí€€ìŠ¤:")
        print(f"  X shape: {X.shape}")
        print(f"  y shape: {y.shape}")
        print(f"  m14_features shape: {m14_features.shape}")
        print(f"  ë©”ëª¨ë¦¬ ì‚¬ìš©: {(X.nbytes + y.nbytes + m14_features.nbytes) / 1024**3:.2f}GB")
        
        # ============================================
        # 4. GPU ìŠ¤ì¼€ì¼ë§
        # ============================================
        print("\nðŸ“ GPU ë°ì´í„° ìŠ¤ì¼€ì¼ë§...")
        
        # GPUì—ì„œ ìŠ¤ì¼€ì¼ë§
        X_tensor = tf.constant(X)
        X_scaled_tensor, median, mad = scale_features_gpu(X_tensor)
        X_scaled = X_scaled_tensor.numpy()
        
        # ìŠ¤ì¼€ì¼ëŸ¬ ì •ë³´ ì €ìž¥
        scalers = {
            'median': median.numpy(),
            'mad': mad.numpy(),
            'method': 'gpu_robust'
        }
        
        print("  âœ… GPU ìŠ¤ì¼€ì¼ë§ ì™„ë£Œ")
    
    # ============================================
    # 5. ì €ìž¥
    # ============================================
    print(f"\nðŸ’¾ ë°ì´í„° ì €ìž¥ ì¤‘...")
    
    # ì‹œí€€ìŠ¤ ì••ì¶• ì €ìž¥
    np.savez_compressed(
        Config.SAVE_PATH,
        X=X_scaled,
        y=y,
        m14_features=m14_features,
        feature_names=feature_cols
    )
    
    # ìŠ¤ì¼€ì¼ëŸ¬ ì €ìž¥
    with open(Config.SCALER_PATH, 'wb') as f:
        pickle.dump(scalers, f)
    
    print(f"  âœ… ì‹œí€€ìŠ¤ ì €ìž¥: {Config.SAVE_PATH}")
    print(f"  âœ… ìŠ¤ì¼€ì¼ëŸ¬ ì €ìž¥: {Config.SCALER_PATH}")
    
    # ============================================
    # 6. í†µê³„ ì¶œë ¥
    # ============================================
    print("\nðŸ“Š ë°ì´í„° í†µê³„:")
    print(f"  íƒ€ê²Ÿê°’ ë²”ìœ„: {y.min():.0f} ~ {y.max():.0f}")
    print(f"  í‰ê· : {y.mean():.0f}, í‘œì¤€íŽ¸ì°¨: {y.std():.0f}")
    
    print(f"\n  ë¬¼ë¥˜ëŸ‰ êµ¬ê°„ë³„ ë¶„í¬:")
    for level in [1400, 1500, 1600, 1700]:
        count = (y >= level).sum()
        ratio = (y >= level).mean()
        print(f"    {level}+ : {ratio:6.2%} ({count:,}ê°œ)")
    
    # M14 íŠ¹ì§• í†µê³„
    print(f"\n  M14 íŠ¹ì§• í†µê³„:")
    print(f"    M14AM14B í‰ê· : {m14_features[:, 0].mean():.1f}")
    print(f"    M14AM10A í‰ê· : {m14_features[:, 1].mean():.1f}")
    print(f"    M14AM16  í‰ê· : {m14_features[:, 2].mean():.1f}")
    print(f"    ë¹„ìœ¨(14B/10A) í‰ê· : {m14_features[:, 3].mean():.2f}")
    
    # í™©ê¸ˆ íŒ¨í„´ ê²€ì¶œ
    golden_pattern_count = ((m14_features[:, 0] > 300) & (m14_features[:, 1] < 80)).sum()
    print(f"\n  ðŸ† í™©ê¸ˆ íŒ¨í„´ ê°ì§€: {golden_pattern_count:,}ê°œ")
    
    total_time = datetime.now() - start_time
    
    print("\n" + "="*60)
    print("âœ… GPU ì‹œí€€ìŠ¤ ìƒì„± ì™„ë£Œ!")
    print(f"â±ï¸  ì´ ì†Œìš” ì‹œê°„: {total_time}")
    if gpu_available:
        print(f"ðŸš€ GPU ê°€ì†: í™œì„±í™” (ì•½ 10-20ë°° ì†ë„ í–¥ìƒ)")
    else:
        print(f"âš ï¸  GPU ì—†ìŒ: CPU ëª¨ë“œë¡œ ì‹¤í–‰ë¨")
    print(f"ðŸ’¡ ë‹¤ìŒ ë‹¨ê³„: V6_GPU_í•™ìŠµ_ìµœì¢…ë³¸.py ì‹¤í–‰")
    print("="*60)

# ============================================
# ì‹¤í–‰
# ============================================
if __name__ == '__main__':
    main()