import pandas as pd
import numpy as np
import os
from datetime import datetime
import glob
from tqdm import tqdm
import warnings
warnings.filterwarnings('ignore')

def process_semiconductor_data():
    """OUTPUT_BY_DATE í´ë”ì˜ CSV íŒŒì¼ë“¤ì„ í†µí•©í•˜ê³  ì „ì²˜ë¦¬"""
    
    print("ğŸš€ ë°˜ë„ì²´ ë¬¼ë¥˜ ë°ì´í„° ì „ì²˜ë¦¬ ì‹œì‘")
    print("=" * 60)
    
    # í•„ìš”í•œ ì»¬ëŸ¼ë“¤
    required_columns = [
        "CURRTIME", "TOTALCNT", "M14AM10A", "M10AM14A", "M14AM10ASUM",
        "M14AM14B", "M14BM14A", "M14AM14BSUM", "M14AM16", "M16M14A", 
        "M14AM16SUM", "TIME"
    ]
    
    # OUTPUT_BY_DATE í´ë”ì—ì„œ ëª¨ë“  CSV íŒŒì¼ ì°¾ê¸°
    folder_path = "OUTPUT_BY_DATE"
    csv_files = glob.glob(os.path.join(folder_path, "*.csv"))
    csv_files.sort()  # ë‚ ì§œìˆœ ì •ë ¬
    
    print(f"ğŸ“‚ {len(csv_files)}ê°œì˜ CSV íŒŒì¼ ë°œê²¬")
    
    # ëª¨ë“  ë°ì´í„°ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    all_data = []
    processed_files = 0
    
    # ê° íŒŒì¼ ì²˜ë¦¬
    for file_path in tqdm(csv_files, desc="íŒŒì¼ ì½ê¸°"):
        try:
            # CSV íŒŒì¼ ì½ê¸°
            df = pd.read_csv(file_path, encoding='utf-8-sig')
            
            # í•„ìš”í•œ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if all(col in df.columns for col in required_columns):
                # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
                df = df[required_columns]
                
                # íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ì˜ˆ: 20240101.csv â†’ 20240101)
                file_date = os.path.basename(file_path).replace('.csv', '').replace('.CSV', '')
                df['FILE_DATE'] = file_date
                
                all_data.append(df)
                processed_files += 1
            else:
                missing = [col for col in required_columns if col not in df.columns]
                print(f"\nâš ï¸ {os.path.basename(file_path)}: ëˆ„ë½ëœ ì»¬ëŸ¼ {missing}")
                
        except Exception as e:
            print(f"\nâŒ {os.path.basename(file_path)} ì½ê¸° ì˜¤ë¥˜: {e}")
            continue
    
    print(f"\nâœ… {processed_files}ê°œ íŒŒì¼ ì„±ê³µì ìœ¼ë¡œ ì½ìŒ")
    
    if not all_data:
        print("âŒ ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return
    
    # ëª¨ë“  ë°ì´í„° í†µí•©
    print("\nğŸ“Š ë°ì´í„° í†µí•© ì¤‘...")
    combined_df = pd.concat(all_data, ignore_index=True)
    print(f"âœ… ì´ {len(combined_df):,}ê°œ í–‰ í†µí•© ì™„ë£Œ")
    
    # ì¤‘ë³µ ì œê±° (ìœ ì‚¬ íŒ¨í„´ ê·¸ë£¹í™”)
    print("\nğŸ” ì¤‘ë³µ íŒ¨í„´ ì œê±° ì¤‘...")
    original_size = len(combined_df)
    
    # íŒ¨í„´ ì •ì˜ë¥¼ ìœ„í•œ ë°˜ì˜¬ë¦¼
    combined_df['PATTERN_TOTALCNT'] = (combined_df['TOTALCNT'] // 50) * 50
    combined_df['PATTERN_M14AM14B'] = (combined_df['M14AM14B'] // 20) * 20
    combined_df['PATTERN_M14AM10A'] = (combined_df['M14AM10A'] // 10) * 10
    combined_df['PATTERN_M14AM16'] = (combined_df['M14AM16'] // 20) * 20
    combined_df['PATTERN_M14AM14BSUM'] = (combined_df['M14AM14BSUM'] // 50) * 50
    
    # íŒ¨í„´ ê¸°ë°˜ ì¤‘ë³µ ì œê±°
    pattern_cols = ['PATTERN_TOTALCNT', 'PATTERN_M14AM14B', 'PATTERN_M14AM10A', 
                   'PATTERN_M14AM16', 'PATTERN_M14AM14BSUM']
    
    # ê° íŒ¨í„´ ê·¸ë£¹ì—ì„œ ì²« ë²ˆì§¸ í–‰ë§Œ ìœ ì§€
    combined_df = combined_df.drop_duplicates(subset=pattern_cols, keep='first')
    
    # íŒ¨í„´ ì»¬ëŸ¼ ì œê±°
    combined_df = combined_df.drop(columns=pattern_cols)
    
    removed_count = original_size - len(combined_df)
    print(f"âœ… {removed_count:,}ê°œ ì¤‘ë³µ ì œê±° ({removed_count/original_size*100:.1f}%)")
    
    # ë°ì´í„° ì •ì œ
    print("\nğŸ§¹ ë°ì´í„° ì •ì œ ì¤‘...")
    
    # 1. ê²°ì¸¡ê°’ ì œê±°
    before_na = len(combined_df)
    combined_df = combined_df.dropna()
    after_na = len(combined_df)
    if before_na > after_na:
        print(f"   - ê²°ì¸¡ê°’ {before_na - after_na:,}ê°œ í–‰ ì œê±°")
    
    # 2. ìŒìˆ˜ê°’ ì œê±° (ì„¼ì„œ ë°ì´í„°ëŠ” ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìŒ)
    numeric_cols = ["TOTALCNT", "M14AM10A", "M14AM14B", "M14AM16", 
                   "M14AM14BSUM", "M14AM10ASUM", "M14AM16SUM"]
    
    for col in numeric_cols:
        if col in combined_df.columns:
            before = len(combined_df)
            combined_df = combined_df[combined_df[col] >= 0]
            after = len(combined_df)
            if before > after:
                print(f"   - {col} ìŒìˆ˜ê°’ {before - after:,}ê°œ í–‰ ì œê±°")
    
    # 3. ê·¹ë‹¨ì  ì´ìƒê°’ ì œê±° (ê° ì»¬ëŸ¼ì˜ ìƒìœ„ 0.1%)
    for col in ['TOTALCNT', 'M14AM14B', 'M14AM14BSUM']:
        if col in combined_df.columns:
            q999 = combined_df[col].quantile(0.999)
            before = len(combined_df)
            combined_df = combined_df[combined_df[col] <= q999]
            after = len(combined_df)
            if before > after:
                print(f"   - {col} ì´ìƒê°’(>{q999:.0f}) {before - after:,}ê°œ í–‰ ì œê±°")
    
    # FILE_DATE ì»¬ëŸ¼ ì œê±° (ìµœì¢… íŒŒì¼ì—ëŠ” ë¶ˆí•„ìš”)
    if 'FILE_DATE' in combined_df.columns:
        combined_df = combined_df.drop('FILE_DATE', axis=1)
    
    # ì¸ë±ìŠ¤ ì¬ì„¤ì •
    combined_df = combined_df.reset_index(drop=True)
    
    # ìµœì¢… ë°ì´í„° ì €ì¥
    output_path = "semiconductor_consolidated_data.csv"
    print(f"\nğŸ’¾ ë°ì´í„° ì €ì¥ ì¤‘: {output_path}")
    combined_df.to_csv(output_path, index=False, encoding='utf-8-sig')
    
    # ê²°ê³¼ ìš”ì•½
    print("\n" + "=" * 60)
    print("ğŸ“Š ë°ì´í„° ì „ì²˜ë¦¬ ì™„ë£Œ!")
    print(f"ğŸ“ ì¶œë ¥ íŒŒì¼: {output_path}")
    print(f"ğŸ“ ìµœì¢… ë°ì´í„°: {len(combined_df):,}ê°œ í–‰")
    print(f"ğŸ“ ì»¬ëŸ¼ ìˆ˜: {len(combined_df.columns)}ê°œ")
    print(f"ğŸ’¾ íŒŒì¼ í¬ê¸°: {os.path.getsize(output_path) / 1024 / 1024:.1f} MB")
    
    # ì£¼ìš” í†µê³„
    print("\nğŸ“ˆ ì£¼ìš” í†µê³„:")
    print(f"- TOTALCNT í‰ê· : {combined_df['TOTALCNT'].mean():.0f}")
    print(f"- TOTALCNT ë²”ìœ„: {combined_df['TOTALCNT'].min():.0f} ~ {combined_df['TOTALCNT'].max():.0f}")
    print(f"- M14AM14B í‰ê· : {combined_df['M14AM14B'].mean():.0f}")
    print(f"- M14AM14B ìµœëŒ€: {combined_df['M14AM14B'].max():.0f}")
    
    # í™©ê¸ˆ íŒ¨í„´ ë¹„ìœ¨
    golden_pattern = (combined_df['M14AM14B'] > 300) & (combined_df['M14AM10A'] < 80)
    golden_ratio = golden_pattern.sum() / len(combined_df) * 100
    print(f"- í™©ê¸ˆ íŒ¨í„´(M14AM14B>300 & M14AM10A<80) ë¹„ìœ¨: {golden_ratio:.2f}%")
    
    return combined_df

if __name__ == "__main__":
    # ì‹¤í–‰
    process_semiconductor_data()