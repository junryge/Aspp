"""
ğŸ” EXTREME_NET í•™ìŠµ ì „ ìµœì¢… ê²€ì¦
=====================================
í•™ìŠµ ì‹œì‘ ì „ ë°ì´í„°ì™€ í™˜ê²½ ì²´í¬
"""

import pandas as pd
import numpy as np
import tensorflow as tf
import os
import psutil
import gc

print("="*80)
print("ğŸ” í•™ìŠµ ì „ ìµœì¢… ê²€ì¦ ì‹œì‘")
print("="*80)

# 1. TensorFlow ë²„ì „ í™•ì¸
print("\nâœ… 1. TensorFlow í™˜ê²½")
print(f"  TensorFlow ë²„ì „: {tf.__version__}")
if tf.__version__.startswith('2.16'):
    print("  âœ“ TensorFlow 2.16.x í™•ì¸")
else:
    print(f"  âš ï¸ ì£¼ì˜: TensorFlow 2.16.1 ê¶Œì¥ (í˜„ì¬: {tf.__version__})")

# 2. GPU í™•ì¸
gpus = tf.config.experimental.list_physical_devices('GPU')
if gpus:
    print(f"\nâœ… 2. GPU í™˜ê²½")
    print(f"  GPU ê°œìˆ˜: {len(gpus)}")
    for i, gpu in enumerate(gpus):
        print(f"  GPU {i}: {gpu}")
else:
    print("\nâš ï¸ 2. CPU ëª¨ë“œë¡œ ì‹¤í–‰ (í•™ìŠµ ì†ë„ ëŠë¦¼)")

# 3. ë©”ëª¨ë¦¬ í™•ì¸
print(f"\nâœ… 3. ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬")
memory = psutil.virtual_memory()
print(f"  ì „ì²´ ë©”ëª¨ë¦¬: {memory.total / (1024**3):.1f} GB")
print(f"  ì‚¬ìš© ê°€ëŠ¥: {memory.available / (1024**3):.1f} GB")
print(f"  ì‚¬ìš©ë¥ : {memory.percent:.1f}%")

if memory.available / (1024**3) < 4:
    print("  âš ï¸ ë©”ëª¨ë¦¬ ë¶€ì¡± ê°€ëŠ¥ì„± (ìµœì†Œ 4GB ê¶Œì¥)")
else:
    print("  âœ“ ì¶©ë¶„í•œ ë©”ëª¨ë¦¬")

# 4. ë°ì´í„° íŒŒì¼ í™•ì¸
print(f"\nâœ… 4. ë°ì´í„° íŒŒì¼ í™•ì¸")
data_paths = [
    '/mnt/user-data/uploads/gs.CSV',
    'uu.csv',
    'uu2.csv',
    'data.csv'
]

found_files = []
for path in data_paths:
    if os.path.exists(path):
        size = os.path.getsize(path) / (1024**2)  # MB
        print(f"  âœ“ {path} ({size:.1f} MB)")
        found_files.append(path)
    else:
        print(f"  âœ— {path} (ì—†ìŒ)")

if not found_files:
    print("\nâŒ ë°ì´í„° íŒŒì¼ ì—†ìŒ! í•™ìŠµ ë¶ˆê°€")
    exit(1)

# 5. ë°ì´í„° ê²€ì¦
print(f"\nâœ… 5. ë°ì´í„° ê²€ì¦")
data_file = found_files[0]
print(f"  ì„ íƒëœ íŒŒì¼: {data_file}")

try:
    df = pd.read_csv(data_file)
    print(f"  ë°ì´í„° í¬ê¸°: {len(df):,} í–‰ Ã— {len(df.columns)} ì—´")
    
    # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
    required_cols = ['TOTALCNT', 'M14AM14B', 'M14AM10A']
    missing_cols = []
    
    print("\n  í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸:")
    for col in required_cols:
        if col in df.columns:
            print(f"    âœ“ {col}")
        else:
            print(f"    âœ— {col} (ëˆ„ë½)")
            missing_cols.append(col)
    
    if missing_cols:
        print(f"\nâŒ í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: {missing_cols}")
        print("   ë‹¤ìŒ ì»¬ëŸ¼ì´ ìˆìŠµë‹ˆë‹¤:", list(df.columns[:10]))
        exit(1)
    
    # ë°ì´í„° í†µê³„
    print("\n  TOTALCNT í†µê³„:")
    print(f"    ìµœì†Œ: {df['TOTALCNT'].min():.0f}")
    print(f"    ìµœëŒ€: {df['TOTALCNT'].max():.0f}")
    print(f"    í‰ê· : {df['TOTALCNT'].mean():.0f}")
    print(f"    í‘œì¤€í¸ì°¨: {df['TOTALCNT'].std():.0f}")
    
    # 0ê°’ ì²´í¬
    zero_count = (df['TOTALCNT'] == 0).sum()
    if zero_count > 0:
        print(f"    âš ï¸ 0ê°’ {zero_count}ê°œ (ì œê±°ë¨)")
    
    # NaN ì²´í¬
    nan_count = df['TOTALCNT'].isna().sum()
    if nan_count > 0:
        print(f"    âš ï¸ NaNê°’ {nan_count}ê°œ")
    
    # ì‹œí€€ìŠ¤ ìƒì„± ê°€ëŠ¥ ì—¬ë¶€
    min_required = 100 + 10  # seq_len + pred_len
    if len(df) < min_required:
        print(f"\nâŒ ë°ì´í„° ë¶€ì¡±: ìµœì†Œ {min_required}ê°œ í•„ìš” (í˜„ì¬: {len(df)})")
        exit(1)
    
    # ì˜ˆìƒ ì‹œí€€ìŠ¤ ìˆ˜
    expected_sequences = len(df) - min_required + 1
    print(f"\n  ì˜ˆìƒ ì‹œí€€ìŠ¤ ìˆ˜: {expected_sequences:,}")
    print(f"    Train: ~{int(expected_sequences * 0.7):,}")
    print(f"    Val: ~{int(expected_sequences * 0.15):,}")
    print(f"    Test: ~{int(expected_sequences * 0.15):,}")
    
    # UU1/UU2 íŒ¨í„´ ì²´í¬
    print("\n  íŒ¨í„´ ë¶„ì„:")
    m14b_mean = df['M14AM14B'].mean()
    high_count = (df['TOTALCNT'] > 1682).sum()
    m14b_350_ratio = (df['M14AM14B'] > 350).mean()
    
    if high_count > 5 or m14b_mean > 380 or m14b_350_ratio > 0.3:
        print(f"    íŒ¨í„´: UU2 (ê³ ê°’ ìœ ì§€)")
    else:
        print(f"    íŒ¨í„´: UU1 (ê¸‰ì¦ ê°€ëŠ¥)")
    
    print(f"    M14B í‰ê· : {m14b_mean:.0f}")
    print(f"    1682+ ì¼€ì´ìŠ¤: {high_count}ê°œ")
    print(f"    M14B>350 ë¹„ìœ¨: {m14b_350_ratio:.1%}")
    
except Exception as e:
    print(f"\nâŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
    exit(1)

# 6. ì˜ˆìƒ í•™ìŠµ ì‹œê°„
print(f"\nâœ… 6. ì˜ˆìƒ í•™ìŠµ ì‹œê°„")
if gpus:
    est_time = expected_sequences / 10000 * 5  # GPU ê¸°ì¤€
    print(f"  GPU ëª¨ë“œ: ì•½ {est_time:.0f}~{est_time*2:.0f}ë¶„")
else:
    est_time = expected_sequences / 10000 * 30  # CPU ê¸°ì¤€
    print(f"  CPU ëª¨ë“œ: ì•½ {est_time:.0f}~{est_time*2:.0f}ë¶„")

# 7. ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸
print(f"\nâœ… 7. ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸")
checklist = {
    "TensorFlow ì„¤ì¹˜": tf.__version__ is not None,
    "ë°ì´í„° íŒŒì¼": len(found_files) > 0,
    "í•„ìˆ˜ ì»¬ëŸ¼": len(missing_cols) == 0 if 'missing_cols' in locals() else False,
    "ì¶©ë¶„í•œ ë°ì´í„°": expected_sequences > 1000 if 'expected_sequences' in locals() else False,
    "ë©”ëª¨ë¦¬": memory.available / (1024**3) > 4
}

all_ready = True
for item, status in checklist.items():
    status_text = "âœ“" if status else "âœ—"
    print(f"  {status_text} {item}")
    if not status:
        all_ready = False

# 8. ê²°ê³¼
print("\n" + "="*80)
if all_ready:
    print("âœ… ëª¨ë“  ì¤€ë¹„ ì™„ë£Œ! í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    print("\nì‹¤í–‰ ëª…ë ¹:")
    print("  python extreme_net_complete_fixed.py")
    print("\nì˜ˆìƒ ì†Œìš” ì‹œê°„: ", end="")
    if gpus:
        print(f"{est_time:.0f}~{est_time*2:.0f}ë¶„ (GPU)")
    else:
        print(f"{est_time:.0f}~{est_time*2:.0f}ë¶„ (CPU)")
else:
    print("âŒ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

print("="*80)

# ë©”ëª¨ë¦¬ ì •ë¦¬
gc.collect()
if gpus:
    tf.keras.backend.clear_session()