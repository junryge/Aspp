#!/usr/bin/env python3
"""
HID Zoneë³„ IN/OUT Lane ê°œìˆ˜ ì¶”ì¶œ ìŠ¤í¬ë¦½íŠ¸ (v2 - ì¤‘ë³µì œê±°)
"""

import re
import csv

def extract_hid_zones(config_file):
    """mcp75.cfgì—ì„œ HID Zone ì •ë³´ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)"""

    with open(config_file, 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read()

    zones = {}  # ë”•ì…”ë„ˆë¦¬ë¡œ ì¤‘ë³µ ë°©ì§€

    # <ZONE>:ìˆ«ì:ìˆ«ì íŒ¨í„´ìœ¼ë¡œ Zone ì‹œì‘ì  ì°¾ê¸°
    zone_starts = list(re.finditer(r'<ZONE>:(\d+):(\d+);', content))

    for i, match in enumerate(zone_starts):
        zone_id = int(match.group(1))
        territory = int(match.group(2))

        # ê³ ìœ  í‚¤
        key = (zone_id, territory)
        if key in zones:
            continue  # ì¤‘ë³µ ê±´ë„ˆë›°ê¸°

        # ë¸”ë¡ ì¶”ì¶œ
        start_pos = match.end()
        if i + 1 < len(zone_starts):
            end_pos = zone_starts[i + 1].start()
        else:
            next_section = re.search(r'\n<[A-Z_]+>', content[start_pos:])
            if next_section:
                end_pos = start_pos + next_section.start()
            else:
                end_pos = len(content)

        block = content[start_pos:end_pos]

        # TYPE í™•ì¸
        type_match = re.search(r'TYPE\s*=\s*"(\w+)"', block)
        zone_type = type_match.group(1) if type_match else "UNKNOWN"

        # HID Zoneë§Œ ì²˜ë¦¬
        if zone_type != "HID":
            continue

        # LOOP_ENTRY (IN) ê°œìˆ˜
        in_entries = re.findall(r'LOOP_ENTRY\s*=\s*(\d+)\s*,\s*(\d+)', block)
        in_count = len(in_entries)

        # EXIT (OUT) ê°œìˆ˜
        out_exits = re.findall(r'EXIT\s*=\s*(\d+)\s*,\s*(\d+)', block)
        out_count = len(out_exits)

        # VEHICLE_MAX
        vhl_max_match = re.search(r'VEHICLE_MAX\s*=\s*(\d+)', block)
        vhl_max = int(vhl_max_match.group(1)) if vhl_max_match else 0

        # VEHICLE_PRECAUTION
        vhl_precaution_match = re.search(r'VEHICLE_PRECAUTION\s*=\s*(\d+)', block)
        vhl_precaution = int(vhl_precaution_match.group(1)) if vhl_precaution_match else 0

        # IN/OUT Lane ìƒì„¸
        in_lanes = [f"{e[0]}â†’{e[1]}" for e in in_entries]
        out_lanes = [f"{e[0]}â†’{e[1]}" for e in out_exits]

        zones[key] = {
            'zone_id': zone_id,
            'territory': territory,
            'type': zone_type,
            'in_count': in_count,
            'out_count': out_count,
            'in_lanes': '; '.join(in_lanes),
            'out_lanes': '; '.join(out_lanes),
            'vehicle_max': vhl_max,
            'vehicle_precaution': vhl_precaution
        }

    return list(zones.values())


def save_to_csv(zones, output_file):
    """CSV íŒŒì¼ë¡œ ì €ì¥"""

    with open(output_file, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)

        # í—¤ë”
        writer.writerow([
            'Zone_ID',
            'Territory',
            'Type',
            'IN_Count',
            'OUT_Count',
            'IN_Lanes',
            'OUT_Lanes',
            'Vehicle_Max',
            'Vehicle_Precaution'
        ])

        # ë°ì´í„° (Zone ID ìˆœì„œë¡œ ì •ë ¬)
        for zone in sorted(zones, key=lambda x: (x['zone_id'], x['territory'])):
            writer.writerow([
                zone['zone_id'],
                zone['territory'],
                zone['type'],
                zone['in_count'],
                zone['out_count'],
                zone['in_lanes'],
                zone['out_lanes'],
                zone['vehicle_max'],
                zone['vehicle_precaution']
            ])

    print(f"âœ… CSV íŒŒì¼ ì €ì¥ ì™„ë£Œ: {output_file}")


def print_summary(zones):
    """ìš”ì•½ ì¶œë ¥"""

    print("\n" + "="*70)
    print("ğŸ“Š HID Zone IN/OUT ë¶„ì„ ê²°ê³¼")
    print("="*70)
    print(f"ì´ HID Zone ê°œìˆ˜: {len(zones)}ê°œ\n")

    print(f"{'Zone ID':<10} {'Territory':<10} {'INê°œìˆ˜':<10} {'OUTê°œìˆ˜':<10} {'ìµœëŒ€OHT':<10}")
    print("-"*50)

    total_in = 0
    total_out = 0

    for zone in sorted(zones, key=lambda x: (x['zone_id'], x['territory'])):
        print(f"{zone['zone_id']:<10} {zone['territory']:<10} {zone['in_count']:<10} {zone['out_count']:<10} {zone['vehicle_max']:<10}")
        total_in += zone['in_count']
        total_out += zone['out_count']

    print("-"*50)
    print(f"{'í•©ê³„':<20} {total_in:<10} {total_out:<10}")
    print("="*70)


if __name__ == "__main__":
    config_file = "/home/user/ASAS/OHT2/mcp75.cfg"
    output_csv = "/home/user/ASAS/OHT2/HID_Zone_IN_OUT.csv"

    print("ğŸ” HID Zone ë°ì´í„° ì¶”ì¶œ ì‹œì‘...")

    zones = extract_hid_zones(config_file)

    if zones:
        save_to_csv(zones, output_csv)
        print_summary(zones)
    else:
        print("âŒ HID Zoneì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")