# OHT 데이터 분석 상세 지침서

## 문서 개요
- **작성일**: 2025.01
- **대상 시스템**: Smart ATLAS (OHT 속도 분석 시스템)
- **목적**: OHT 데이터 수집, 처리, 저장 프로세스에 대한 상세 기술 지침

---

## 목차
1. [시스템 전체 구조](#1-시스템-전체-구조)
2. [OHT Connect Listener 초기화](#2-oht-connect-listener-초기화)
3. [메시지 Worker 구조](#3-메시지-worker-구조)
4. [processOhtReport() 상세 분석](#4-processohtreport-상세-분석)
5. [클래스 참조 관계](#5-클래스-참조-관계)
6. [Logpresso 데이터 적재](#6-logpresso-데이터-적재)
7. [VhlUdpState 필드 정의](#7-vhludpstate-필드-정의)
8. [데이터 테이블 구조](#8-데이터-테이블-구조)
9. [속도 계산 로직](#9-속도-계산-로직)
10. [트러블슈팅 가이드](#10-트러블슈팅-가이드)

---

## 1. 시스템 전체 구조

### 1.1 데이터 흐름 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           OHT 데이터 처리 전체 흐름                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  MCP (Material Control Point)                                               │
│       │                                                                     │
│       ▼                                                                     │
│  UDP Message                                                                │
│       │                                                                     │
│       ▼                                                                     │
│  OhtUdpListener.java ──────────────────────────────────────────────────┐   │
│       │                                                                │   │
│       ▼                                                                │   │
│  OhtMsgWorkerRunnable.java (Queue 적재)                                │   │
│       │                                                                │   │
│       ▼                                                                │   │
│  DataSet.java (속도 계산)                                               │   │
│       │                                                                │   │
│       ▼                                                                │   │
│  RailEdgeMap → RailEdge.java (속도 저장)                                │   │
│       │                                                                │   │
│       ▼                                                                │   │
│  Batch 클래스들 (주기별 동작)                                            │   │
│       │                                                                │   │
│       ▼                                                                │   │
│  Logpresso API ──────────────────────────────────────────────────────►│   │
│       │                                                                    │
│       ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │  ATLAS_RAW_DATA    │  ATLAS_DATA        │  ATLAS_AREA_TRAFFIC   │      │
│  │  ATLAS_ROUTE       │  ATLAS_VEHICLE     │  ATLAS_BRANCH_TRAFFIC │      │
│  │  ATLAS_VHL_COUNT   │  ATLAS_RAIL_TRAFFIC│                       │      │
│  └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 주요 Java 클래스 역할 정의

| 클래스명 | 역할 | 상세 설명 |
|---------|------|----------|
| `OhtUdpListener.java` | MCP로부터 UDP 메시지 수신 | DatagramSocket을 통해 UDP 패킷 수신 |
| `OhtMsgWorkerRunnable.java` | 수신한 UDP 메시지를 Queue에 적재 | Thread & Loop 방식으로 메시지 처리 |
| `DataSet.java` | Queue 데이터를 사용해 속도(velocity) 값 계산 | 지수평활법 적용 |
| `RailEdge.java` | RailEdge 객체 단위로 속도 값 저장 | 개별 레일 구간 정보 관리 |
| `RailEdgeMap` | RailEdge 객체들의 맵 구조 | 전체 레일 구간 맵핑 |
| `DataService.java` | DataSet의 인스턴스 관리 | 싱글톤 패턴으로 데이터 접근 제공 |
| `LauncherListener.java` | 시스템 시작 리스너 | onStarted() 이벤트 처리 |
| `BranchTrafficBatch.java` | areaTraffic/branchTraffic 데이터 구성 및 전송 | 4/10초 주기 |
| `TrafficBatch.java` | railTraffic 데이터 구성 및 전송 | 3/10초 주기 |
| `AreaVhlCountBatch.java` | areaVhlCountBatch 데이터 구성 및 전송 | 6/10초 주기 |
| `DijkstraVhlRouteFind.class` | 시작점~목적지 경로 탐색 | 다익스트라 알고리즘 |
| `DfkRoutePlanUpdate.java` | Rail 방향 및 노드 목록 업데이트 | defaultDir, railNodeList 관리 |

---

## 2. OHT Connect Listener 초기화

### 2.1 초기화 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OHT Connect Listener 초기화 과정                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐                                                   │
│  │  DataService.java   │                                                   │
│  └──────────┬──────────┘                                                   │
│             │                                                               │
│             │ .getFabPropertiseMap()                                        │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────┐                               │
│  │  fab properties mapper 데이터 호출 (→ fp) │                               │
│  └──────────┬──────────────────────────────┘                               │
│             │                                                               │
│             │ .onStarted()                                                  │
│             ▼                                                               │
│  ┌─────────────────────────────────────────┐                               │
│  │     LauncherListener.java               │                               │
│  └──────────┬──────────────────────────────┘                               │
│             │                                                               │
│             │ fp.getMcpPropertiesMap()의 키 값을 통해 MCP 정보 취득           │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────┐                               │
│  │       MCP의 Port 갯수 확인               │                               │
│  └──────────┬──────────────────────────────┘                               │
│             │                                                               │
│      ┌──────┴──────┐                                                       │
│      │             │                                                       │
│   0개 이하      1개 이상                                                     │
│      │             │                                                       │
│      ▼             ▼                                                       │
│  ┌────────┐   ┌────────────┐                                               │
│  │TIB/RV  │   │    UDP     │                                               │
│  │ 방식   │   │    방식    │                                               │
│  └───┬────┘   └─────┬──────┘                                               │
│      │              │                                                       │
│      ▼              ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. OhtTibrvListener    │  1. OhtUdpListener 인스턴스 생성과 함께 초기화 │   │
│  │    인스턴스 생성과 함께 │  2. fabOhtUdpListener에 map 데이터 저장 후     │   │
│  │    초기화              │     worker(runnable)가 위치한 thread가         │   │
│  │ 2. fabOhtListenerMap에 │     동작하기 전 UDP를 연결(start)한다.         │   │
│  │    map 데이터 저장 후  │                                              │   │
│  │    worker(runnable)가  │                                              │   │
│  │    위치한 thread가     │                                              │   │
│  │    동작하기 전         │                                              │   │
│  │    Tib/rv를 초기화     │                                              │   │
│  │    (init) 한 후        │                                              │   │
│  │    연결(start)한다.    │                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 OhtUdpListener.java 상세 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OhtUdpListener.java 동작 흐름                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  launcherListener.onStarted()                                               │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────┐                                   │
│  │  ','로 구분되는 IP가 존재            │                                   │
│  │        AND                          │                                   │
│  │  PORT 번호가 존재                    │                                   │
│  └──────────────┬──────────────────────┘                                   │
│                 │                                                           │
│            Yes  │                                                           │
│                 ▼                                                           │
│  ┌─────────────────────────────────────┐                                   │
│  │     new OhtUdpListener()            │                                   │
│  └──────────────┬──────────────────────┘                                   │
│                 │                                                           │
│                 │ 값 적재(put)                                              │
│                 ▼                                                           │
│  ┌─────────────────────────────────────┐                                   │
│  │     fabOhtUdpListenerMap            │                                   │
│  └──────────────┬──────────────────────┘                                   │
│                 │                                                           │
│                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────┐                   │
│  │  fabOhtListenerMap에서 fabId:mcpName 형태의 키 값이 존재?│                   │
│  └──────────────┬─────────────────────┬────────────────┘                   │
│            Yes  │                     │  No                                 │
│                 │                     │                                     │
│                 ▼                     ▼                                     │
│  ┌──────────────────┐   ┌─────────────────────────────────────────┐        │
│  │   TIB/RV logic   │   │  fabOhtUdpListenerMap에서               │        │
│  └──────────────────┘   │  fabId:mcpName 형태의 키 값이 존재?      │        │
│                         └──────────────┬──────────────────────────┘        │
│                                   Yes  │                                   │
│                                        ▼                                   │
│                              ┌─────────────────────┐                       │
│                              │ OhtUdpListener.java │                       │
│                              └──────────┬──────────┘                       │
│                                         │                                   │
│                    ┌────────────────────┼────────────────────┐             │
│                    │                    │                    │             │
│                    ▼                    ▼                    ▼             │
│         ┌──────────────────┐  ┌─────────────┐  ┌─────────────────────┐     │
│         │.addListenerMapIp()│  │  .start()   │  │   .sendMessage()    │     │
│         └────────┬─────────┘  └──────┬──────┘  └──────────┬──────────┘     │
│                  │                   │                    │                │
│                  ▼                   ▼                    ▼                │
│         Map<String,           DatagramSocket      tib/rv의 subject,        │
│         OhtTiprvReplicatro>                       message 정보를 수정한 후,  │
│         fabMcpNameOtrMap                          transport.send()         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 통신 방식 비교

| 구분 | TIB/RV 방식 | UDP 방식 |
|------|-------------|----------|
| **조건** | MCP Port 개수 0개 이하 | MCP Port 개수 1개 이상 |
| **리스너** | OhtTibrvListener | OhtUdpListener |
| **저장 Map** | fabOhtListenerMap | fabOhtUdpListenerMap |
| **초기화** | Tib/rv init → start | UDP 연결(start) |
| **통신 객체** | transport.send() | DatagramSocket |

---

## 3. 메시지 Worker 구조

### 3.1 Worker 전체 구조도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           메시지 Worker 처리 구조                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  LauncherListener.onStarted()                                               │
│             │                                                               │
│             │ queue                                                         │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    queue 값에따라 동작(switch)                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             │                                                               │
│  ┌──────────┼──────────┬──────────┬──────────┬──────────┐                  │
│  │          │          │          │          │          │                  │
│  ▼          ▼          ▼          ▼          ▼          │                  │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐│                  │
│  │OhtMsgWorker    │ │EiMsgWorker     │ │TsMsgWorker     ││                  │
│  │Runnable.java   │ │Runnable.java   │ │Runnable.java   ││                  │
│  └───────┬────────┘ └────────────────┘ └────────────────┘│                  │
│          │                                               │                  │
│  ┌───────┼───────────────────────────────────────────────┤                  │
│  │       │                                               │                  │
│  ▼       ▼                                               ▼                  │
│  ┌────────────────┐                              ┌────────────────┐         │
│  │UiMsgWorker     │                              │CnvMsgWorker    │         │
│  │Runnable.java   │                              │Runnable.java   │         │
│  └────────────────┘                              └────────────────┘         │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                           Thread & Loop                                     │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Worker별 역할 및 호출 메서드

| Worker | 역할 | 주요 호출 메서드 | DataService 접근 |
|--------|------|-----------------|------------------|
| **OhtMsgWorkerRunnable** | OHT 메시지 처리, Vehicle 상태 추적 | `processOhtReport(token)` | `.getVhlMap()`, `.getRailEdgeMap()` |
| **EiMsgWorkerRunnable** | Command 생성/완료 처리 | - | `.getVhlMap()` |
| **TsMsgWorkerRunnable** | Job 생성/완료 처리 | - | - |
| **UiMsgWorkerRunnable** | 포트/장비 상태 Update | - | - |
| **CnvMsgWorkerRunnable** | Conveyor 상태 Update | - | - |

### 3.3 OhtMsgWorkerRunnable 상세 처리 함수

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OhtMsgWorkerRunnable.run() 처리 흐름                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         DataService.java                                    │
│                              │                                              │
│      ┌───────────────────────┼───────────────────────┐                     │
│      │                       │                       │                     │
│      │ .getFapPropertiesMap()│ .getVhlMap()          │ .getNodeMap()       │
│      │                       │                       │                     │
│      ▼                       ▼                       ▼                     │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                                                                      │  │
│  │  ┌─────────────────────────┐  ┌─────────────────────────┐           │  │
│  │  │processMcpOnlineReport   │  │processVhlRouteReport    │           │  │
│  │  │       (token)           │  │       (token)           │           │  │
│  │  └───────────┬─────────────┘  └───────────┬─────────────┘           │  │
│  │              │                            │                          │  │
│  │              │ allEqpNameMap              │ vhlMap                   │  │
│  │              │ 참조 및 수정                │ 참조 및 수정              │  │
│  │              ▼                            ▼                          │  │
│  │                                                                      │  │
│  │  ┌─────────────────────────┐  ┌─────────────────────────┐           │  │
│  │  │processStationReport     │  │processOhtReport         │           │  │
│  │  │       (token)           │  │       (token)           │◄──────────┤  │
│  │  └───────────┬─────────────┘  └───────────┬─────────────┘    핵심   │  │
│  │              │                            │                   처리   │  │
│  │              │ stationPortMap             │                          │  │
│  │              │ 참조 및 수정                ▼                          │  │
│  │              ▼                 ┌─────────────────────────────┐       │  │
│  │                               │ 1. vehicle, station, edge 등, │       │  │
│  │                               │    dataService 데이터를       │       │  │
│  │                               │    참조 및 수정               │       │  │
│  │                               │ 2. Logpresso의 INSERT 로직    │       │  │
│  │                               │ 3. vehicle 속도, 상태에 따른  │       │  │
│  │                               │    분류, edge 길이, 도달까지  │       │  │
│  │                               │    최소시간 등 계산           │       │  │
│  │                               └─────────────────────────────┘       │  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                              │                             │
│                                              │ .getStationPortMap()        │
│                                              ▼                             │
│                                   ┌──────────────────────┐                 │
│                                   │DfkRoutePlanUpdate.java│                 │
│                                   └──────────────────────┘                 │
│                                              │                             │
│                                              │ RAIL의 기본 방향(defaultDir)과│
│                                              │ 노드 목록(railNodeList) 업데이트│
│                                              ▼                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. processOhtReport() 상세 분석

### 4.1 전체 처리 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              ohtMsgWorkerRunnable.processOhtReport() 전체 흐름                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  processOhtReport(token)                                                    │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────┐         ┌─────────────────────────────┐   │
│  │         Vhl v               │◄────────│      DataService.java       │   │
│  │   (vehicle 객체 참조)        │         │       .getVhlMap()          │   │
│  └──────────────┬──────────────┘         └─────────────────────────────┘   │
│                 │                                     │                     │
│                 │                                     │ vhlMap 참조 및 수정   │
│                 ▼                                     ▼                     │
│  ┌──────────────────────────────────┐                                      │
│  │  v(vehicle)의 VHL_STATE가 REMOVING? │                                      │
│  └──────────────┬───────────────────┘                                      │
│                 │                                                           │
│       ┌─────────┴─────────┐                                                │
│       │                   │                                                │
│      Yes                  No                                               │
│       │                   │                                                │
│       ▼                   ▼                                                │
│  ┌────────────────┐  ┌────────────────────────────────────────────────┐   │
│  │ REMOVING 처리  │  │              일반 처리 로직                      │   │
│  ├────────────────┤  ├────────────────────────────────────────────────┤   │
│  │ 1. vehicle의   │  │ 1. vehicle의 udpState 값을 업데이트 – 토큰 값 사용│   │
│  │    udpState    │  │ 2. vehicle의 rail 정보 업데이트 – ID 값 취득     │   │
│  │    값을 업데이트│  │ 3. vehicle의 교차점 정보 업데이트 – ID 값 취득   │   │
│  │ 2. rail 정보   │  └────────────────────────────────────────────────┘   │
│  │    업데이트    │                     │                                  │
│  │    → rail에    │                     ▼                                  │
│  │    적재된      │  ┌────────────────────────────────────────────────┐   │
│  │    vehicle     │  │ 조건에따라 rail 정보 업데이트                    │   │
│  │    정보 삭제,  │  │ – 마지막 rail에 대한 정보를 단위별(edge)로       │   │
│  │    이력 추가   │  │   dataService에서 가져와 정보를 업데이트하거나   │   │
│  │ 3. command     │  │   rail의 분산 ~ 병합되는 구간                    │   │
│  │    삭제        │  │   (branch join edge)을 검색                     │   │
│  └───────┬────────┘  └────────────────────────────────────────────────┘   │
│          │                              │                                  │
│          ▼                              ▼                                  │
│  ┌────────────┐         ┌────────────────────────────────────────────┐    │
│  │   return   │         │ vehicle의 마지막 udpState 정보와 현재       │    │
│  └────────────┘         │ vehicle의 교차점의 ID 값이 서로 다르다?     │    │
│                         └───────────────────┬────────────────────────┘    │
│                                             │                              │
│                               ┌─────────────┴─────────────┐               │
│                               │                           │               │
│                              Yes                          No              │
│                               │                           │               │
│                               ▼                           ▼               │
│                    ┌─────────────────────┐     (다음 로직으로 진행)        │
│                    │ OhtRegData oldOrd   │                                │
│                    │ Logpresso INSERT    │                                │
│                    └─────────────────────┘                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Vehicle 상태별 처리 상세

#### 4.2.1 REMOVING 상태 처리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        REMOVING 상태 처리 흐름                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  VHL_STATE == REMOVING                                                      │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. vehicle의 udpState 정보를 수정                                    │   │
│  │    - 대부분의 필드를 초기값/빈값으로 설정                             │   │
│  │    - state = VHL_STATE.REMOVING                                      │   │
│  │    - runCycle = RUN_CYCLE.NONE                                       │   │
│  │    - vhlCycle = VHL_CYCLE.NONE                                       │   │
│  │    - detailState = VHL_DET_STATE.NONE                                │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. rail 단위 정보 중 마지막 rail(lastRe)의 vehicle id 삭제           │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. command 삭제 (이전값이 command 정보를 호출 가능한 경우)            │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│         [return]                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 일반 상태 처리 (REMOVING 이외)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        일반 상태 처리 흐름 (6단계)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [1단계] UDP 통신에 따른 vehicle 정보 업데이트                         │   │
│  │                                                                      │   │
│  │ - vehicl의 udpState 정보를 토큰 값 등을 이용해 수정                   │   │
│  │ - rail 정보를 다시 수정                                              │   │
│  │ - 이후부터는 서로 다른 로직으로 분기                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [2단계] Rail Edge 정보 업데이트                                       │   │
│  │                                                                      │   │
│  │ - rail edge의 vehicle id를 키 값으로 등록                            │   │
│  │ - last rail edge, branch join edge 등의 rail 정보를 업데이트         │   │
│  │ - long rail edge를 기준으로 rail edge 정보를 취득                    │   │
│  │ - 실행 주기(RUN_CYCLE)을 조건으로 vehicle 상태를 집계                 │   │
│  │ - station 정보를 통해 station의 수와 목적지 수를 집계                 │   │
│  │ - 각 rail edge를 통해 long rail edge의 전체 길이와                   │   │
│  │   도달까지의 최소 시간을 계산                                        │   │
│  │ - branch rail edge와 junction rail edge의 수도 계산                  │   │
│  │                                                                      │   │
│  │ ※ 이후 다른 로직에서는 branch join edge를 기준으로 삼고 있음          │   │
│  │                                                                      │   │
│  │ 저장 구조:                                                           │   │
│  │   - long rail edge → OhtRegData                                      │   │
│  │   - branch join edge → OhtRegBjData                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [3단계] 교차점 ID 비교 및 Logpresso 저장                              │   │
│  │                                                                      │   │
│  │ - vehicle의 교차점 id를 branch join edge 혹은 (vehicle) 이전 값과 비교│   │
│  │ - 다를 경우에는 logpresso를 통해 추가 및 저장                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [4단계] Command 및 Job 정보 처리                                      │   │
│  │                                                                      │   │
│  │ - vehicle 정보를 통해 command 정보를 취득하거나 삭제                  │   │
│  │   (이전값이 command 정보를 호출 가능한 경우)                         │   │
│  │ - 해당 command를 통해 job 정보를 확인                                │   │
│  │ - 만약 job 정보를 얻지 못한다면 vehicle을 통해 얻은 carrier를 통해서  │   │
│  │   job 정보를 취득                                                    │   │
│  │ - 불러온 job은 노드 정보(toNodeId → getNodeMap())를 가져온다         │   │
│  │ - 노드 정보가 없다면 job이 가진 임시 노드(tempToNodeId)를 통해       │   │
│  │   다시 한 번 노드 정보를 호출                                        │   │
│  │ - 노드 정보를 호출하게 된다면 RoutePredictor.UpdateNewRoutePrediction()│   │
│  │   을 통해 노드 정보를 업데이트                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [5단계] Route 정보 처리 및 상태 기록                                   │   │
│  │                                                                      │   │
│  │ - vehicle의 route를 정리                                             │   │
│  │ - vehicle의 상태(JAM, ABNORMAL)에 따라 시간과 함께 job에 기록 및 저장 │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ [6단계] 최종 계산 및 저장                                              │   │
│  │                                                                      │   │
│  │ - route 정보를 통해 각 구간 간의 vehicle이 도달하는 데 걸리는        │   │
│  │   시간, 거리 등을 산출                                               │   │
│  │ - 이를 통해 command 정보를 입력하고(addRouteId())                    │   │
│  │ - dataService에 저장하거나 logpresso를 이용해 값을 저장              │   │
│  │                                                                      │   │
│  │ ※ 위(2단계)에서는 rail edge를 통해 rail 및 경로에 대한 정보를 산출    │   │
│  │ ※ 이번(6단계)에는 route 정보를 통해 계산                              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 클래스 참조 관계

### 5.1 processOhtReport() 클래스 참조 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              ohtMsgWorkerRunnable.processOhtReport() 참조 관계               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                      processOhtReport(token)                                │
│                              │                                              │
│              ┌───────────────┼───────────────┐                             │
│              │               │               │                             │
│              ▼               ▼               ▼                             │
│       ┌─────────────┐ ┌─────────────┐ ┌──────────────────┐                │
│       │RailEdge.java│ │  Vhl.java   │ │VhlUdpState.class │                │
│       └──────┬──────┘ └──────┬──────┘ └──────────────────┘                │
│              │               │                                             │
│              │               └─────────┐                                   │
│              │                         │                                   │
│              │ .getRailEdgeMap()       │ .getVhlMap()                      │
│              │ .getEdgeMap()           │                                   │
│              │                         │                                   │
│              └────────────┬────────────┘                                   │
│                           │                                                │
│                           ▼                                                │
│                  ┌─────────────────┐                                       │
│                  │ DataService.java │                                       │
│                  └─────────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 주요 클래스 관계 설명

| 클래스 | 역할 | 접근 방법 |
|--------|------|----------|
| **DataService.java** | 중앙 데이터 저장소, 싱글톤 | 직접 호출 |
| **Vhl.java** | Vehicle 객체 정의 | DataService.getVhlMap() |
| **VhlUdpState.class** | Vehicle의 UDP 상태 정보 | Vhl.java 내부 속성 |
| **RailEdge.java** | Rail Edge 정보 | DataService.getRailEdgeMap() |
| **Command cmd** | 명령 정보 | Vehicle을 통해 취득 |

### 5.3 DataService 제공 메서드

| 메서드 | 반환 타입 | 용도 |
|--------|----------|------|
| `.getVhlMap()` | Map<String, Vhl> | Vehicle 정보 조회/수정 |
| `.getRailEdgeMap()` | Map<String, RailEdge> | Rail Edge 정보 조회 |
| `.getEdgeMap()` | Map<String, Edge> | Edge 정보 조회 |
| `.getNodeMap()` | Map<String, Node> | Node 정보 조회 |
| `.getFapPropertiesMap()` | Map<String, FabProperties> | FAB 속성 정보 조회 |
| `.getStationPortMap()` | Map<String, StationPort> | Station Port 정보 조회 |

---

## 6. Logpresso 데이터 적재

### 6.1 Logpresso 접근 과정

```
┌─────────────────────────────────────────────────────────────────────────────┐
│           ohtMsgWorkerRunnable.processOhtReport() – 로그프레소 접근 과정       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────┐                                           │
│  │processMcpOnlineReport(token)│───► X (Logpresso 미사용)                   │
│  └─────────────────────────────┘                                           │
│                                                                             │
│  ┌─────────────────────────────┐                                           │
│  │processVhlRouteReport(token) │───► X (Logpresso 미사용)                   │
│  └─────────────────────────────┘                                           │
│                                                                             │
│  ┌─────────────────────────────┐                                           │
│  │processStationReport(token)  │───► X (Logpresso 미사용)                   │
│  └─────────────────────────────┘                                           │
│                                                                             │
│  ┌─────────────────────────────┐                                           │
│  │processOhtReport(token)      │───► ✓ (Logpresso 사용)                    │
│  └──────────────┬──────────────┘                                           │
│                 │                                                           │
│      ┌──────────┼──────────┬──────────────────────┐                        │
│      │          │          │                      │                        │
│      ▼          ▼          ▼                      │                        │
│  ┌────────┐ ┌────────┐ ┌─────────────────────┐   │                        │
│  │ 메서드1 │ │ 메서드2 │ │      메서드3        │   │                        │
│  └────┬───┘ └────┬───┘ └──────────┬──────────┘   │                        │
│       │          │                │              │                        │
│       ▼          ▼                ▼              │                        │
│                                                  │                        │
│  ═══════════════════════════════════════════════════════════════════════  │
│                                                                            │
│  [메서드1] JsonUtil.insertJsonArrayDataToLogpresso()                       │
│  ──────────────────────────────────────────────────                       │
│  - 정의 위치: JsonUtil.java                                                │
│  - 용도: OhtRegBjData, OhtRegData의 과거 데이터(old)를 각각 logpresso에 전달 │
│  - 테이블명: 입력한 데이터의 'tblNm' 값이 테이블 명이 됨                     │
│                                                                            │
│  [메서드2] _.sendToLogpresso()                                             │
│  ──────────────────────────────────────────────────                       │
│  - 정의 위치: RouteItem.java                                               │
│  - 용도: ri, lastRi(last route item), pri, lastPRI 등                     │
│          router item과 관련된 로직 처리                                    │
│  - 컬럼(키 값): 고정된 값 사용                                             │
│  - 테이블명: 'ATLAS_ROUTE'                                                 │
│                                                                            │
│  [메서드3] _.saveVehicleToLogpresso()                                      │
│  ──────────────────────────────────────────────────                       │
│  - 정의 위치: OhtMsgWorkerRunnable.java                                    │
│  - 용도: processOhtReport()의 모든 과정을 마무리하면서                      │
│          업데이트된 vehicle 정보를 logpresso에 전달                        │
│  - 컬럼(키 값): Vhl.java의 변수 값을 사용                                  │
│  - 테이블명: 'ATLAS_VEHICLE'                                               │
│                                                                            │
│  ═══════════════════════════════════════════════════════════════════════  │
│       │          │                │                                        │
│       │          │                │                                        │
│       ▼          ▼                ▼                                        │
│  ┌────────┐ ┌────────┐ ┌────────┐                                         │
│  │ INSERT │ │ INSERT │ │ INSERT │                                         │
│  └────┬───┘ └────┬───┘ └────┬───┘                                         │
│       │          │          │                                              │
│       └──────────┼──────────┘                                              │
│                  │                                                         │
│                  ▼                                                         │
│         ┌──────────────────┐                                               │
│         │    Logpresso     │                                               │
│         └──────────────────┘                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Logpresso INSERT 메서드 비교

| 메서드 | 정의 위치 | 테이블 | 컬럼 정의 방식 | 데이터 내용 |
|--------|----------|--------|---------------|-------------|
| `JsonUtil.insertJsonArrayDataToLogpresso()` | JsonUtil.java | 'tblNm' 값 | 동적 | OhtRegBjData, OhtRegData |
| `_.sendToLogpresso()` | RouteItem.java | ATLAS_ROUTE | 고정 | Route Item 정보 |
| `_.saveVehicleToLogpresso()` | OhtMsgWorkerRunnable.java | ATLAS_VEHICLE | Vhl.java 변수 | Vehicle 정보 |

### 6.3 저장 데이터 타입별 매핑

| 데이터 타입 | Edge 종류 | 저장 클래스 |
|------------|----------|-------------|
| Long Rail Edge | 긴 레일 구간 | OhtRegData |
| Branch Join Edge | 분기/병합 구간 | OhtRegBjData |

---

## 7. VhlUdpState 필드 정의

### 7.1 VhlUdpState 클래스 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           VhlUdpState.class 필드 정의                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  processOhtReport(token)                                                    │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                           │
│  │   Vhl.java  │                                                           │
│  └──────┬──────┘                                                           │
│         │                                                                   │
│         │ vehicle 상태에 따른                                               │
│         │ 분기에 대한 각각의 setter 값                                       │
│         ▼                                                                   │
│  ┌──────────────────┐                                                      │
│  │VhlUdpState.class │                                                      │
│  └──────────────────┘                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 상태별 필드값 비교표

| 필드명 | REMOVING 상태 값 | 일반 상태 값 | 설명 |
|--------|-----------------|-------------|------|
| `railNodeId` | "" (빈값) | token | 현재 Rail Node ID |
| `udpCarrierId` | "" | token | UDP Carrier ID |
| `destStationId` | "" | token | 목적지 Station ID |
| `destPortId` | "" | token | 목적지 Port ID |
| `distance` | 0 | token | 이동 거리 |
| `isFull` | False | token | 적재 상태 |
| `isOnline` | False | token | 온라인 상태 |
| `nextRailNodeId` | "" | token | 다음 Rail Node ID |
| `runCycle` | RUN_CYCLE.NONE | token | 실행 주기 |
| `vhlCycle` | VHL_CYCLE.NONE | token | Vehicle 주기 |
| `state` | VHL_STATE.REMOVING | token | Vehicle 상태 |
| `receivedTime` | receivedMilli | receivedMilli | 수신 시간 |
| `emStatus` | Util.binaryStringToByte(t) | token | E/M 상태 |
| `sourcePortId` | "" | token | 출발지 Port ID |
| `priority` | 0 | token | 우선순위 |
| `detailState` | VHL_DET_STATE.NONE | token | 상세 상태 |
| `runDistance` | 0 | token | 실행 거리 |
| `railEdgeId` | "" | token | Rail Edge ID |
| `lastUdpState` | railNodeId | token | 마지막 UDP 상태 |
| `errorCode` | - | token | 에러 코드 |
| `groupId` | - | token | 그룹 ID |
| `crossPointId` | - | (long edge) | 교차점 ID |

### 7.3 상태 Enum 정의

#### VHL_STATE (Vehicle 상태)
| 상태 | 설명 |
|------|------|
| REMOVING | 제거 중 |
| RUN | 운전 중 |
| OBS_STOP | 장애물 정지 |
| JAM | 정체 |
| E84_TIMEOUT | E84 타임아웃 |
| ABNORMAL | 이상 상태 |

#### RUN_CYCLE (실행 주기)
| 상태 | 설명 |
|------|------|
| NONE | 없음 |
| ACQUIRE | 구원 주기 |
| DEPOSIT | 도매 사이클 |

#### VHL_CYCLE (Vehicle 주기)
| 상태 | 설명 |
|------|------|
| NONE | 없음 |
| ACQUIRE_MOVING | 구원 이송 중 |
| DEPOSIT_MOVING | 도매 이동 |

#### VHL_DET_STATE (상세 상태)
| 상태 | 설명 |
|------|------|
| NONE | 없음 |

---

## 8. 데이터 테이블 구조

### 8.1 Logpresso 테이블 목록

| 테이블명 | 용도 | 적재 주체 |
|---------|------|----------|
| ATLAS_RAW_DATA | 원시 데이터 | - |
| ATLAS_DATA | 가공된 기본 데이터 | - |
| ATLAS_ROUTE | 경로 정보 | RouteItem.sendToLogpresso() |
| ATLAS_VEHICLE | Vehicle 정보 | saveVehicleToLogpresso() |
| ATLAS_AREA_TRAFFIC | Area 단위 트래픽 정보 | BranchTrafficBatch |
| ATLAS_BRANCH_TRAFFIC | Branch 단위 트래픽 정보 | BranchTrafficBatch |
| ATLAS_VHL_COUNT | Vehicle 수량 집계 | AreaVhlCountBatch |
| ATLAS_RAIL_TRAFFIC | Rail 단위 트래픽 정보 | TrafficBatch |

### 8.2 ATLAS_AREA_TRAFFIC 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| createTime | Long | 데이터 작성 시간 (BranchTrafficBatch 동작 시간) | 1723082384000 |
| density | Double | Area 상 RailEdge의 vehicle 밀도 | 0 |
| fabId | String | Factory ID | M11A |
| id | String | Area ID | M11A:AR:B32-2 |
| passJobCnts | String | 최근 1~5분 이내 통과 Job 수 | 0,0,0,0,0 |
| pathPredictQCnts | String | 향후 1~5분 이내 예상 Job 수 | 0,0,1,0,0 |
| railTrafficInputCnt | Integer | DEPOSIT/assign command 수 | 2 |
| railTrafficOutputCnt | Integer | ACQUIRE/assign command 수 | 2 |
| **speed** | **Double** | **현재 속도 (m/min, 지수평활법)** | **117.71171** |
| vhlCnt | Integer | 현재 vehicle 수량 | 0 |

**density 계산식:**
```
density = (vehicle 길이) × (현재 vehicle 수량) / {(RailEdge 길이) - (RailEdge 길이) % (vehicle 길이)}
```

### 8.3 ATLAS_BRANCH_TRAFFIC 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| createTime | Long | 데이터 작성 시간 | 1723082384000 |
| density | Double | RailEdge의 vehicle 밀도 | 0 |
| edgeIds | Array | BranchJoinEdge의 RailEdge ID 목록 | ["M11A:RE:A:..."] |
| elapsedTime | Long | 통과 소요 시간 | 4026 |
| fabId | String | Factory ID | M11A |
| id | String | BranchJoinEdge ID | M11A:BJE:... |
| isAvailable | Boolean | 사용 가능 여부 | true |
| jobCost | Double | 통과 및 소요 시간 | 637.44 |
| length | Integer | 길이 (mm) | 3020 |
| mcpName | String | MCP 명칭 | A |
| passCnt | Integer | 최근 10초간 통과 수량 | 0 |
| passJobCnts | String | 최근 1~5분 통과 Job 수 | 0,0,0,0,0 |
| pathPredictQCnts | String | 향후 1~5분 예상 Job 수 | 0,0,0,0,0 |
| pathPredictQueueSizeAvg | Double | 예상 수량 평균 | 0 |
| railTrafficInOutCnt | Integer | Input + Output 합계 | 1 |

### 8.4 ATLAS_RAIL_TRAFFIC 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| absoluteVelocity | Double | 속도 / 최대속도 | 1 |
| createTime | Long | 데이터 작성 시간 | 1723082383001 |
| fabId | String | Factory ID | M11A |
| intOutCnt | Integer | Input + Output 합계 | 0 |
| inputCnt | Integer | DEPOSIT command 수 | 0 |
| isAvailable | Boolean | 사용 가능 여부 | true |
| jobCost | Double | 통과 소요 시간 | 637.44 |
| jobPassCnt | Integer | 통과 수량 | 2 |
| **maxVelocity** | **Integer** | **RailEdge 최대 속도** | **200** |
| outputCnt | Integer | ACQUIRE command 수 | 0 |
| passCnt | Integer | 통과 vehicle 수량 | 1 |
| predict1_2minCnt | Integer | 1~2분 내 도착 예상 수량 | 1 |
| predict2_3minCnt | Integer | 2~3분 내 도착 예상 수량 | 0 |
| predict3_4minCnt | Integer | 3~4분 내 도착 예상 수량 | 0 |
| predict4_5minCnt | Integer | 4~5분 내 도착 예상 수량 | 0 |
| predictOver5minCnt | Integer | 5분 이상 도착 예상 수량 | 0 |
| predictQueueAllCnt | Integer | 전체 도착 예상 수량 | 5 |
| predictUnder1minCnt | Integer | 1분 미만 도착 예상 수량 | 3 |
| railEdgeId | String | RailEdge ID | M11B:RE:B:... |
| vhlAbnormalCnt | Integer | ABNORMAL 상태 vehicle 수 | 0 |
| vhlAcquireMovingCnt | Integer | ACQUIRE 상태 vehicle 수 | 0 |

### 8.5 ATLAS_VHL_COUNT 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| {fabId}:AR:{area명칭} | Integer | 각 area별 vehicle 수량 | 5 |
| createTime | Long | 데이터 작성 시간 | 1723082386001 |

---

## 9. 속도 계산 로직

### 9.1 기본 계산 공식

```
속도(ν) = 거리(Δx) / 시간(Δt) × 60.0
```

| 변수 | 설명 | 단위 |
|------|------|------|
| ν | 속도 | m/min |
| Δx | 거리 | mm |
| Δt | 시간 (두 메시지의 수신 시간 차이) | 초 |

### 9.2 거리 계산 케이스

#### Case 1: α의 시작점과 β의 도착지점이 동일한 경우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Case 1 거리 계산                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  β (이전 위치)                    α (현재 위치)                      │    │
│  │  ┌─────────────────────────┐     ┌─────────────────────────┐       │    │
│  │  │      RailEdge           │────▶│      RailEdge           │       │    │
│  │  │  [β의 현재 번지 거리]    │     │  [α의 현재 번지 거리]    │       │    │
│  │  └─────────────────────────┘     └─────────────────────────┘       │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  거리(Δx) = (β에 위치한 RailEdge의 길이)                                    │
│           - (β의 현재 번지에서의 거리)                                      │
│           + (α의 현재 번지에서의 거리)                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Case 2: α, β가 서로 다른 RailEdge에 위치한 경우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Case 2 거리 계산                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  β (이전 위치)        중간 RailEdge들         α (현재 위치)          │    │
│  │  ┌──────────┐     ┌──────────┬──────────┐     ┌──────────┐         │    │
│  │  │RailEdge 1│────▶│RailEdge 2│RailEdge 3│────▶│RailEdge 4│         │    │
│  │  └──────────┘     └──────────┴──────────┘     └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  거리(Δx) = (β의 시작점부터 α의 시작점까지의 거리 및 RailEdge 길이의 합)     │
│           - (β의 현재 번지에서의 거리)                                      │
│           + (α의 현재 번지에서의 거리)                                      │
│                                                                             │
│  ※ DijkstraVhlRouteFind 알고리즘으로 경로 유추                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

※ α: 최근 수신 메시지 정보 / β: 이전(마지막) 수신 메시지 정보

### 9.3 계산 예시

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              속도 계산 예시                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  조건: Vehicle이 서로 다른 RailEdge에 위치 (Case 2 적용)                     │
│                                                                             │
│  - RailEdge 길이: 100, 200 (가정)                                           │
│  - β의 현재 번지 거리: 20                                                   │
│  - α의 현재 번지 거리: 0                                                    │
│  - 시간(Δt): 1초                                                            │
│                                                                             │
│  계산:                                                                      │
│  ───────                                                                    │
│  거리(Δx) = (100 + 200) - 20 + 0 = 280 mm                                  │
│  시간(Δt) = 1초                                                             │
│  속도(ν) = 280 / 1 × 60.0 = 16,800 mm/min = 16.8 m/min                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.4 속도 계산 필수 조건 (5가지)

속도 계산이 수행되기 위해서는 아래 **모든 조건**을 충족해야 합니다:

| 번호 | 조건 | 상세 | 체크 포인트 |
|-----|------|------|------------|
| 1 | 메시지 수신 시간 차이 | 현재 vehicle과 최근 정보 비교 시 **1분 미만** | receivedTime 비교 |
| 2 | Vehicle 상태 | `RUN`, `OBS_STOP`, `JAM`, `E84_TIMEOUT` 중 하나 | state 필드 |
| 3 | Cycle 일치 | 현재 vehicle이 최근 정보와 실행 cycle, vehicle 실행 cycle 주기가 동일 | runCycle, vhlCycle |
| 4 | 실행 Cycle 값 | `ACQUIRE`, `DEPOSIT` 중 하나 | runCycle 필드 |
| 5 | Vehicle 실행 Cycle 주기 | `ACQUIRE_MOVING`, `DEPOSIT_MOVING` 중 하나 | vhlCycle 필드 |

### 9.5 속도 계산 플로우차트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           속도 계산 플로우차트                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [UDP Message 수신]                                                         │
│         │                                                                   │
│         ▼                                                                   │
│  [Message를 통해 vehicle, railEdge 정보 취득]                               │
│         │                                                                   │
│         ▼                                                                   │
│  [이전(최근) vehicle 정보 조회] ← lastUdpState                              │
│         │                                                                   │
│         ▼                                                                   │
│  [이전(최근) vehicle의 railEdge 정보 호출] ← lastRailEdge                   │
│         │                                                                   │
│         ▼                                                                   │
│  [현재 railEdge와 이전 railEdge 정보 비교]                                  │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────┐                   │
│  │  railEdge의 종점과 lastRailEdge의 시작점이 동일한가? │                   │
│  └─────────────────────────┬───────────────────────────┘                   │
│                   ┌────────┴────────┐                                      │
│                  Yes                No                                      │
│                   │                  │                                      │
│                   ▼                  ▼                                      │
│           [Case 1 계산]    [DijkstraVhlRouteFind로                          │
│                             경로 유추 후 Case 2 계산]                       │
│                   │                  │                                      │
│                   └────────┬─────────┘                                      │
│                            │                                                │
│                            ▼                                                │
│           [각 구간(railEdge)별로 속도 값 저장]                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.6 Factory별 Vehicle 길이

| Factory | Vehicle 본체 (mm) | 추가 길이 (mm) | 총 길이 (mm) |
|---------|------------------|----------------|--------------|
| M14* | 784 | 300 | **1084** |
| M16* | 943 | 300 | **1243** |
| 기타 (ETC) | 784 | 300 | **1084** |

```java
// Vehicle 길이 결정 로직
if(area.getFabId().startsWith("M14")) {
    vhlLength = 784 + 300;
}
else if(area.getFabId().startsWith("M16")) {
    vhlLength = 943 + 300;
}
else {
    vhlLength = 784 + 300;
}
```

---

## 10. 트러블슈팅 가이드

### 10.1 속도 값이 초기값으로 유지되는 경우

| 원인 | 확인 방법 | 해결 방안 |
|------|----------|----------|
| 해당 레일에 대한 UDP 메시지 미수신 | OhtUdpListener 로그 확인 | MCP 통신 상태 점검 |
| 5가지 필수 조건 미충족 | Vehicle 상태 및 Cycle 값 확인 | 조건별 체크 |
| 메시지 수신 시간 간격 초과 (1분 이상) | receivedTime 비교 | 메시지 수신 주기 점검 |

### 10.2 속도 계산 관련 주요 체크포인트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          속도 계산 체크리스트                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  □ 1. Vehicle 상태 코드가 유효한지 확인                                     │
│       - RUN, OBS_STOP, JAM, E84_TIMEOUT 중 하나인가?                       │
│                                                                             │
│  □ 2. 메시지 수신 시간 간격이 1분 이내인지 확인                             │
│       - 현재 receivedTime - 이전 receivedTime < 60초                       │
│                                                                             │
│  □ 3. 실행 cycle 값이 ACQUIRE 또는 DEPOSIT인지 확인                         │
│       - runCycle 필드 값 점검                                              │
│                                                                             │
│  □ 4. Vehicle 실행 cycle 주기가 MOVING 상태인지 확인                        │
│       - vhlCycle이 ACQUIRE_MOVING 또는 DEPOSIT_MOVING                      │
│                                                                             │
│  □ 5. RailEdge 경로가 올바르게 연결되어 있는지 확인                         │
│       - lastRailEdge → 현재 RailEdge 연결성 점검                           │
│                                                                             │
│  □ 6. Cycle 일치 여부 확인                                                  │
│       - 이전 정보와 현재 정보의 runCycle, vhlCycle 동일 여부                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 데이터 갱신 주기

| Batch 클래스 | 주기 | 적재 테이블 |
|-------------|------|------------|
| TrafficBatch | 3/10초 | ATLAS_RAIL_TRAFFIC |
| BranchTrafficBatch | 4/10초 | ATLAS_BRANCH_TRAFFIC, ATLAS_AREA_TRAFFIC |
| AreaVhlCountBatch | 6/10초 | ATLAS_VHL_COUNT |
| VhlBatch | 1분 | Logpresso (Vehicle 상태) |
| DataSetRefreshBatch | 매일 10시 | 맵 데이터 및 초기 속도값 |

### 10.4 일반적인 문제 해결 순서

```
1. UDP 메시지 수신 확인
   └─ OhtUdpListener 로그 확인
   └─ MCP 통신 상태 점검
   
2. Vehicle 상태 확인
   └─ VHL_STATE가 유효한 상태인지 확인
   └─ REMOVING 상태가 아닌지 확인
   
3. Cycle 상태 확인
   └─ runCycle이 ACQUIRE/DEPOSIT인지 확인
   └─ vhlCycle이 MOVING 상태인지 확인
   
4. 시간 조건 확인
   └─ 메시지 수신 간격이 1분 미만인지 확인
   
5. RailEdge 연결 확인
   └─ 경로가 올바르게 설정되어 있는지 확인
   └─ Dijkstra 알고리즘 동작 확인
   
6. Logpresso 저장 확인
   └─ INSERT 로그 확인
   └─ 테이블 데이터 조회
```

---

## 부록 A: UDP 메시지 구조

### A.1 메시지 형식

```
2,OHT,V00399,1,1,0000,1,4176,20,4177,4,4,4PDMG440,4011,00000000,0000,4ANZ16-404,4CSC1602_2,90,0,0,N4PDMG4402025020601541,B16,
```

### A.2 토큰별 필드 설명

| 순서 | 필드명 | 설명 | 예시값 |
|-----|--------|------|--------|
| 1 | message id | 메시지 식별자 | 2 |
| 2 | mcp 명칭 | MCP 이름 | OHT |
| 3 | vehicle 명칭 | Vehicle ID | V00399 |
| 4 | 상태 | Vehicle 상태 코드 | 1 |
| 5 | 재하 정보 | 적재 상태 | 1 |
| 6 | error code | 에러 코드 | 0000 |
| 7 | 통신 상태 | 통신 상태 코드 | 1 |
| 8 | 현재 번지 | 현재 위치 주소 | 4176 |
| 9 | 현재 번지에서의 거리 | 현재 번지 내 이동 거리 | 20 |
| 10 | 차 번지 | 다음 위치 주소 | 4177 |
| 11 | 실행 cycle | 실행 사이클 코드 | 4 |
| 12 | vehicle 실행 cycle 주기 | 사이클 주기 코드 | 4 |
| 13 | carrier id | Carrier 식별자 | 4PDMG440 |
| 14 | 목적지 | 목적지 주소 | 4011 |
| 15 | E/M 상태 | E/M 상태 코드 | 00000000 |
| 16 | group id | 그룹 식별자 | 0000 |

---

## 부록 B: 속도 초기값 설정

### B.1 초기값 형성 시점

- 서버 최초 구동 시
- `dataSetRefresh`를 통한 맵 데이터 업데이트 시

### B.2 설정 파일 구조 (*.mcp75.cfg)

```
[MCP75_LAYOUT@SCH.1]
POINT = 1945, 0, 1946, 2017, 64, 0, 0, 0, 0, 0
```

| POINT 값 | railEdge 속성 | 설명 |
|----------|--------------|------|
| 1945 | address | 레일의 시작점 |
| 0 | stNo | station 번호 |
| 1946 | leftAddress | 레일의 좌측 끝점 |
| 2017 | leftDistance | 레일의 좌측 길이 |
| 64 | leftSpeed | 레일의 좌측 속도 (level 키값) |
| 0 | rightAddress | 레일의 우측 끝점 |
| 0 | rightDistance | 레일의 우측 길이 |
| 0 | rightSpeed | 레일의 우측 속도 |

### B.3 속도 초기값 결정 과정

```
1. [MCP75_VEHICLE]의 VHL_SPEED_TYPE 값 확인 (예: "CLW07-2")
         │
         ▼
2. [MCP75_VEHICLE_SPEED]의 해당 하위 항목(<CLW07-2>)과 매칭
         │
         ▼
3. POINT의 leftSpeed(또는 rightSpeed) 값을 level 키로 사용
         │
         ▼
4. 해당 level에 매칭되는 SPEED 값 취득
```

### B.4 속도 설정 예시

```
[MCP75_VEHICLE]
VHL_SPEED_TYPE = "CLW07-2";

[MCP75_VEHICLE_SPEED]
<CLW07-2>
SPEED = 1, 1.5;      // level=1, 속도=1.5
SPEED = 60, 320;     // level=60, 속도=320
SPEED = 61, 320;
SPEED = 62, 320;
SPEED = 63, 320;
SPEED = 64, 320;     // level=64, 속도=320
```

---

## 부록 C: RailEdge ID 명명 규칙

```
M16A:RE:BR:M16A:RN:BR:01945-M16A:RN:BR:01946
 │    │  │   │    │   │      │
 │    │  │   │    │   │      └─ 끝점(to) 주소
 │    │  │   │    │   └─ 구분자
 │    │  │   │    └─ RN (Rail Node)
 │    │  │   └─ Factory ID
 │    │  └─ 층 정보 (BR=Bridge/3층/Hubroom, RN=일반)
 │    └─ RE (Rail Edge)
 └─ Factory ID (M16A, M14A, M11A 등)
```

| 구성요소 | 설명 | 예시 |
|---------|------|------|
| Factory ID | FAB 식별자 | M16A, M14A, M11A |
| RE | Rail Edge 표시 | RE |
| 층 정보 | BR=Bridge/3층/Hubroom, RN=일반 | BR, RN |
| RN | Rail Node 표시 | RN |
| 시작점 주소 | 5자리 숫자 | 01945 |
| 끝점 주소 | 5자리 숫자 | 01946 |

---

## 부록 D: 용어 정리

| 용어 | 설명 |
|------|------|
| OHT | Overhead Hoist Transport - 반도체 FAB 천장 이송 시스템 |
| MCP | Material Control Point - 자재 제어 포인트 |
| MCS | Material Control System - 자재 제어 시스템 |
| RailEdge | 레일의 한 구간 (시작점 → 끝점) |
| BranchJoinEdge | 여러 RailEdge를 묶은 분기 구간 |
| LongEdge | Branch~Junction 사이 RailEdge 집합 |
| Vehicle (VHL) | OHT 운반체 (V00001, V00399 등) |
| Carrier | Vehicle이 운반하는 FOUP 등의 용기 |
| ACQUIRE | 물품을 집어 올리는 동작/사이클 |
| DEPOSIT | 물품을 내려놓는 동작/사이클 |
| FAB | Fabrication facility - 반도체 생산 시설 |
| Logpresso | 로그 수집 및 분석 플랫폼 |
| FOUP | Front Opening Unified Pod - 웨이퍼 운반 용기 |
| TIB/rv | TIBCO Rendezvous - 메시지 통신 프로토콜 |
| UDP | User Datagram Protocol - 비연결형 통신 프로토콜 |
| STK | Stocker - 저장 장비 |
| Junction | 합류점 |
| Branch | 분기점 |

---

*문서 버전: 2025.01*
*작성 기준: OHT 데이터 분석 자료 종합*