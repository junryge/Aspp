<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK Hynix M14 OHT ì†ë„ ë¶„ì„ ì‹œë®¬ë ˆì´í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            overflow: hidden;
        }

        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #16213e 0%, #0f3460 100%);
            padding: 12px 24px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #header h1 {
            font-size: 20px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0,212,255,0.5);
        }

        #header .stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        #header .stat {
            background: rgba(0,212,255,0.1);
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid rgba(0,212,255,0.3);
        }

        #header .stat span {
            color: #00d4ff;
            font-weight: bold;
        }

        #controls {
            position: fixed;
            top: 60px;
            left: 10px;
            background: rgba(22,33,62,0.98);
            padding: 18px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 13px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            max-width: 320px;
            border: 1px solid rgba(0,212,255,0.2);
        }

        #controls h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,212,255,0.3);
            padding-bottom: 6px;
        }

        #controls label {
            display: block;
            margin: 8px 0;
            color: #a0d2eb;
            font-size: 12px;
        }

        #controls input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        #controls input[type="checkbox"] {
            margin-right: 6px;
        }

        #controls button {
            margin: 6px 4px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,119,182,0.3);
        }

        #controls button:hover {
            background: linear-gradient(135deg, #0096c7 0%, #00d4ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,119,182,0.5);
        }

        #controls input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            margin: 6px 4px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #6a4c93 0%, #8b5cf6 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(106,76,147,0.3);
        }

        .file-label:hover {
            background: linear-gradient(135deg, #7c5295 0%, #a78bfa 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106,76,147,0.5);
        }

        #info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(22,33,62,0.98);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 12px;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(0,212,255,0.2);
        }

        #info b {
            color: #00d4ff;
            font-size: 13px;
        }

        #info .info-row {
            margin: 6px 0;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #info .info-row:last-child {
            border-bottom: none;
        }

        #dataManager {
            position: fixed;
            top: 60px;
            right: 10px;
            background: rgba(22,33,62,0.98);
            padding: 18px;
            border-radius: 10px;
            z-index: 999;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(0,212,255,0.2);
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        #dataManager.active {
            display: block;
        }

        #dataManager h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,212,255,0.3);
            padding-bottom: 6px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: rgba(0,119,182,0.3);
            border: 1px solid rgba(0,212,255,0.3);
            color: #00d4ff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            color: #a0d2eb;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 6px 10px;
            background: rgba(26,26,46,0.8);
            border: 1px solid rgba(0,212,255,0.3);
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-primary {
            flex: 1;
            padding: 8px 14px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            flex: 1;
            padding: 8px 14px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            margin-top: 15px;
            font-size: 10px;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(0,119,182,0.3);
            color: #00d4ff;
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid rgba(0,212,255,0.3);
        }

        .data-table td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #eee;
        }

        .data-table tr:hover {
            background: rgba(0,212,255,0.1);
        }

        .btn-edit,
        .btn-delete {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-right: 4px;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .toggle-panel-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(139,92,246,0.4);
            transition: all 0.3s;
        }

        .toggle-panel-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            transform: translateY(-2px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ğŸš€ SK Hynix M14 OHT ì†ë„ ë¶„ì„ ì‹œë®¬ë ˆì´í„°</h1>
        <div class="stats">
            <div class="stat">Vehicles: <span id="vhlCount">0</span></div>
            <div class="stat">RailEdges: <span id="edgeCount">0</span></div>
            <div class="stat">Avg Speed: <span id="avgSpeed">0</span> m/min</div>
            <div class="stat">Running: <span id="runningCount">0</span></div>
        </div>
    </div>

    <div id="controls">
        <h3>ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì œì–´</h3>
        
        <div id="simulationControls">
            <label>
                <input type="checkbox" id="autoPlay" checked> ìë™ ì¬ìƒ
            </label>
            <label>
                ì¬ìƒ ì†ë„: <span id="speedValue">1.0x</span>
                <input type="range" id="playSpeed" min="0.1" max="5" step="0.1" value="1.0">
            </label>
            <div>
                <button onclick="toggleSimulation()">â¯ï¸ ì‹œì‘/ì •ì§€</button>
                <button onclick="stepForward()">â­ï¸ í•œ ìŠ¤í…</button>
                <button onclick="resetSimulation()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <h3 style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,212,255,0.3);">ğŸ—ºï¸ ë·° ì œì–´</h3>
        <label>
            ì¤Œ: <span id="zoomValue">100%</span>
            <input type="range" id="zoom" min="10" max="500" value="100">
        </label>
        <div style="margin: 10px 0;">
            <label><input type="checkbox" id="showRails" checked> RailEdge í‘œì‹œ</label>
            <label><input type="checkbox" id="showVehicles" checked> Vehicle í‘œì‹œ</label>
            <label><input type="checkbox" id="showLabels" checked> ë¼ë²¨ í‘œì‹œ</label>
            <label><input type="checkbox" id="showSpeed"> ì†ë„ í‘œì‹œ</label>
        </div>
        <div>
            <button onclick="fitView()">ğŸ“ í™”ë©´ ë§ì¶¤</button>
            <button onclick="resetView()">ğŸ¯ ë·° ì´ˆê¸°í™”</button>
        </div>

        <h3 style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,212,255,0.3);">ğŸ“ ë°ì´í„° ë¡œë“œ</h3>
        <input type="file" id="vehicleFileInput" accept=".csv">
        <label for="vehicleFileInput" class="file-label">ğŸš— Vehicle CSV</label>
        
        <input type="file" id="railedgeFileInput" accept=".csv">
        <label for="railedgeFileInput" class="file-label">ğŸ›¤ï¸ RailEdge CSV</label>
        
        <div style="margin-top: 10px;">
            <button onclick="reloadData()">ğŸ”ƒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <h3 style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,212,255,0.3);">ğŸ¨ ì†ë„ ë²”ë¡€</h3>
        <div style="font-size: 10px; line-height: 1.6;">
            <div style="margin: 4px 0;">ğŸŸ¢ 250+ m/min (ê³ ì†)</div>
            <div style="margin: 4px 0;">ğŸŸ¡ 150-250 (ì¤‘ì†)</div>
            <div style="margin: 4px 0;">ğŸŸ  50-150 (ì €ì†)</div>
            <div style="margin: 4px 0;">ğŸ”´ 0-50 (ë§¤ìš° ëŠë¦¼)</div>
            <div style="margin: 4px 0;">âš« 0 (ì •ì§€)</div>
        </div>
    </div>

    <div id="info">
        <b>ğŸ“ ì •ë³´ íŒ¨ë„</b>
        <div id="infoContent">
            <div class="info-row">ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™, ìŠ¤í¬ë¡¤ë¡œ í™•ëŒ€/ì¶•ì†Œ</div>
            <div class="info-row">Vehicle ë˜ëŠ” RailEdge í´ë¦­ìœ¼ë¡œ ìƒì„¸ ì •ë³´ í™•ì¸</div>
        </div>
    </div>

    <button class="toggle-panel-btn" onclick="toggleDataManager()">ğŸ“ ë°ì´í„° ê´€ë¦¬</button>

    <div id="dataManager">
        <h3>ğŸ“ ë°ì´í„° ê´€ë¦¬</h3>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('vehicle')">ğŸš— Vehicle</button>
            <button class="tab-btn" onclick="switchTab('railedge')">ğŸ›¤ï¸ RailEdge</button>
        </div>

        <!-- Vehicle íƒ­ -->
        <div id="vehicleTab" class="tab-content active">
            <h4 style="color: #00d4ff; font-size: 12px; margin-bottom: 10px;">Vehicle ë°ì´í„° ì¶”ê°€</h4>
            
            <div class="form-group">
                <label>Vehicle ID *</label>
                <input type="text" id="vhl_id" placeholder="V00001" maxlength="6">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>MCP Name</label>
                    <input type="text" id="vhl_mcp" value="OHT">
                </div>
                <div class="form-group">
                    <label>í˜„ì¬ ì£¼ì†Œ *</label>
                    <input type="number" id="vhl_currentAddr" placeholder="4176">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>í˜„ì¬ ê±°ë¦¬</label>
                    <input type="number" id="vhl_currentDist" placeholder="20" step="0.1">
                </div>
                <div class="form-group">
                    <label>ë‹¤ìŒ ì£¼ì†Œ</label>
                    <input type="number" id="vhl_nextAddr" placeholder="4177">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ìƒíƒœ *</label>
                    <select id="vhl_status">
                        <option value="1">1-RUN</option>
                        <option value="2">2-OBS_STOP</option>
                        <option value="3">3-JAM</option>
                        <option value="4">4-E84_TIMEOUT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì†ë„ (m/min) *</label>
                    <input type="number" id="vhl_velocity" placeholder="280.5" step="0.1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Cycle</label>
                    <select id="vhl_cycle">
                        <option value="3">3-ACQUIRE</option>
                        <option value="4" selected>4-DEPOSIT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cycle Period</label>
                    <select id="vhl_cyclePeriod">
                        <option value="3">3-ACQUIRE_MOVING</option>
                        <option value="4" selected>4-DEPOSIT_MOVING</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Carrier ID</label>
                    <input type="text" id="vhl_carrier" placeholder="4PDMG440">
                </div>
                <div class="form-group">
                    <label>ëª©ì ì§€</label>
                    <input type="number" id="vhl_destination" placeholder="4011">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-primary" onclick="addVehicle()">â• ì¶”ê°€</button>
                <button class="btn-secondary" onclick="clearVehicleForm()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,212,255,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #00d4ff; font-size: 12px; margin: 0;">Vehicle ëª©ë¡ (<span id="vhlListCount">0</span>)</h4>
                    <button class="btn-secondary" style="padding: 4px 10px; font-size: 10px;" onclick="downloadVehicleCSV()">ğŸ’¾ CSV ì €ì¥</button>
                </div>
                <div id="vehicleList" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- RailEdge íƒ­ -->
        <div id="railedgeTab" class="tab-content">
            <h4 style="color: #00d4ff; font-size: 12px; margin-bottom: 10px;">RailEdge ë°ì´í„° ì¶”ê°€</h4>
            
            <div class="form-group">
                <label>RailEdge ID *</label>
                <input type="text" id="edge_id" placeholder="M14A:RE:BR:M14A:RN:BR:04176-M14A:RN:BR:04177">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Factory ID</label>
                    <input type="text" id="edge_fabId" value="M14A">
                </div>
                <div class="form-group">
                    <label>MCP Name</label>
                    <input type="text" id="edge_mcp" value="OHT">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ê¸¸ì´ (mm) *</label>
                    <input type="number" id="edge_length" placeholder="3500">
                </div>
                <div class="form-group">
                    <label>ì†ë„ (m/min) *</label>
                    <input type="number" id="edge_velocity" placeholder="280.5" step="0.1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ìµœëŒ€ ì†ë„ *</label>
                    <input type="number" id="edge_maxVelocity" placeholder="320">
                </div>
                <div class="form-group">
                    <label>ë°€ë„ (0~1)</label>
                    <input type="number" id="edge_density" placeholder="0.15" step="0.01" min="0" max="1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Vehicle ìˆ˜</label>
                    <input type="number" id="edge_vhlCnt" placeholder="2" min="0">
                </div>
                <div class="form-group">
                    <label>í†µê³¼ ìˆ˜</label>
                    <input type="number" id="edge_passCnt" placeholder="5" min="0">
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="edge_isAvailable" checked> ì‚¬ìš© ê°€ëŠ¥
                </label>
            </div>

            <div class="btn-group">
                <button class="btn-primary" onclick="addRailEdge()">â• ì¶”ê°€</button>
                <button class="btn-secondary" onclick="clearRailEdgeForm()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,212,255,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #00d4ff; font-size: 12px; margin: 0;">RailEdge ëª©ë¡ (<span id="edgeListCount">0</span>)</h4>
                    <button class="btn-secondary" style="padding: 4px 10px; font-size: 10px;" onclick="downloadRailEdgeCSV()">ğŸ’¾ CSV ì €ì¥</button>
                </div>
                <div id="railedgeList" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // ========== ì „ì—­ ë³€ìˆ˜ ==========
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let vehicles = [];
        let railEdges = [];
        let simulation = {
            running: true,
            time: 0,
            speed: 1.0
        };
        
        let view = {
            scale: 0.5,
            offsetX: 0,
            offsetY: 0,
            dragging: false,
            lastX: 0,
            lastY: 0
        };
        
        let bounds = {
            minX: 0, maxX: 11389,
            minY: 0, maxY: 4769
        };

        // ========== CSV íŒŒì‹± í•¨ìˆ˜ ==========
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                data.push(obj);
            }
            
            return data;
        }

        // ========== ë°ì´í„° ë¡œë“œ ==========
        async function loadDefaultData() {
            try {
                // Vehicle ë°ì´í„° ë¡œë“œ
                const vhlResponse = await fetch('vehicle_data.csv');
                if (vhlResponse.ok) {
                    const vhlText = await vhlResponse.text();
                    const vhlData = parseCSV(vhlText);
                    processVehicleData(vhlData);
                }
                
                // RailEdge ë°ì´í„° ë¡œë“œ
                const edgeResponse = await fetch('railedge_data.csv');
                if (edgeResponse.ok) {
                    const edgeText = await edgeResponse.text();
                    const edgeData = parseCSV(edgeText);
                    processRailEdgeData(edgeData);
                }
                
                updateStats();
                render();
            } catch (error) {
                console.error('ê¸°ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ========== Vehicle ë°ì´í„° ì²˜ë¦¬ ==========
        function processVehicleData(data) {
            vehicles = data.map(v => ({
                id: v.vehicleId,
                mcp: v.mcpName,
                currentAddr: parseInt(v.currentAddr),
                currentDist: parseFloat(v.currentDist),
                nextAddr: parseInt(v.nextAddr),
                status: parseInt(v.status),
                cycle: parseInt(v.cycle),
                cyclePeriod: parseInt(v.cyclePeriod),
                carrierId: v.carrierId,
                destination: parseInt(v.destination),
                velocity: parseFloat(v.velocity),
                timestamp: v.timestamp,
                // ì‹œë®¬ë ˆì´ì…˜ìš© ìœ„ì¹˜ (í˜„ì¬ëŠ” ëœë¤, ì‹¤ì œë¡œëŠ” ë ˆì´ì•„ì›ƒ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°)
                x: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                y: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                angle: Math.random() * Math.PI * 2
            }));
        }

        // ========== RailEdge ë°ì´í„° ì²˜ë¦¬ ==========
        function processRailEdgeData(data) {
            railEdges = data.map(e => {
                const velocity = parseFloat(e.velocity);
                const maxVelocity = parseFloat(e.maxVelocity);
                
                return {
                    id: e.railEdgeId,
                    fabId: e.fabId,
                    mcp: e.mcpName,
                    length: parseFloat(e.length),
                    velocity: velocity,
                    maxVelocity: maxVelocity,
                    density: parseFloat(e.density),
                    vhlCnt: parseInt(e.vhlCnt),
                    passCnt: parseInt(e.passCnt),
                    isAvailable: e.isAvailable === 'true',
                    // ì‹œë®¬ë ˆì´ì…˜ìš© ìœ„ì¹˜
                    x1: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                    y1: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                    x2: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                    y2: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                    color: getSpeedColor(velocity, maxVelocity)
                };
            });
        }

        // ========== ì†ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ==========
        function getSpeedColor(velocity, maxVelocity) {
            if (velocity === 0) return '#64748b'; // ì •ì§€
            
            const ratio = maxVelocity > 0 ? velocity / maxVelocity : 0;
            
            if (ratio >= 0.8) return '#22c55e'; // ê³ ì†
            if (ratio >= 0.5) return '#eab308'; // ì¤‘ì†
            if (ratio >= 0.25) return '#f97316'; // ì €ì†
            return '#ef4444'; // ë§¤ìš° ëŠë¦¼
        }

        // ========== ì¢Œí‘œ ë³€í™˜ ==========
        function worldToScreen(wx, wy) {
            return {
                x: (wx - bounds.minX) * view.scale + view.offsetX,
                y: canvas.height - ((wy - bounds.minY) * view.scale + view.offsetY)
            };
        }

        function screenToWorld(sx, sy) {
            return {
                x: (sx - view.offsetX) / view.scale + bounds.minX,
                y: (canvas.height - sy - view.offsetY) / view.scale + bounds.minY
            };
        }

        // ========== ë Œë”ë§ ==========
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°°ê²½ ê·¸ë¦¬ë“œ
            drawGrid();
            
            // RailEdge ê·¸ë¦¬ê¸°
            if (document.getElementById('showRails').checked) {
                drawRailEdges();
            }
            
            // Vehicle ê·¸ë¦¬ê¸°
            if (document.getElementById('showVehicles').checked) {
                drawVehicles();
            }
        }

        function drawGrid() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            const gridSize = 1000; // 1000mm ê°„ê²©
            
            for (let x = bounds.minX; x <= bounds.maxX; x += gridSize) {
                const screenPos = worldToScreen(x, bounds.minY);
                ctx.beginPath();
                ctx.moveTo(screenPos.x, 0);
                ctx.lineTo(screenPos.x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = bounds.minY; y <= bounds.maxY; y += gridSize) {
                const screenPos = worldToScreen(bounds.minX, y);
                ctx.beginPath();
                ctx.moveTo(0, screenPos.y);
                ctx.lineTo(canvas.width, screenPos.y);
                ctx.stroke();
            }
        }

        function drawRailEdges() {
            railEdges.forEach(edge => {
                const p1 = worldToScreen(edge.x1, edge.y1);
                const p2 = worldToScreen(edge.x2, edge.y2);
                
                // RailEdge ì„ 
                ctx.strokeStyle = edge.color;
                ctx.lineWidth = Math.max(2, view.scale * 0.5);
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
                
                // ì†ë„ ë¼ë²¨
                if (document.getElementById('showSpeed').checked && view.scale > 0.3) {
                    const midX = (p1.x + p2.x) / 2;
                    const midY = (p1.y + p2.y) / 2;
                    
                    ctx.fillStyle = edge.color;
                    ctx.font = '10px sans-serif';
                    ctx.fillText(`${edge.velocity.toFixed(1)}`, midX, midY - 5);
                }
            });
        }

        function drawVehicles() {
            vehicles.forEach(vhl => {
                const pos = worldToScreen(vhl.x, vhl.y);
                const size = Math.max(4, view.scale * 2);
                
                // Vehicle ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ
                let color = '#00d4ff';
                if (vhl.status === 2) color = '#ef4444'; // ì •ì§€
                else if (vhl.status === 3) color = '#facc15'; // ì •ì²´
                else if (vhl.velocity > 250) color = '#22c55e'; // ê³ ì†
                
                // Vehicle ê·¸ë¦¬ê¸°
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                // ì™¸ê³½ì„ 
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // ë¼ë²¨
                if (document.getElementById('showLabels').checked && view.scale > 0.5) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '9px sans-serif';
                    ctx.fillText(vhl.id, pos.x + size + 3, pos.y + 3);
                }
            });
        }

        // ========== í†µê³„ ì—…ë°ì´íŠ¸ ==========
        function updateStats() {
            document.getElementById('vhlCount').textContent = vehicles.length;
            document.getElementById('edgeCount').textContent = railEdges.length;
            
            const runningVehicles = vehicles.filter(v => v.status === 1);
            document.getElementById('runningCount').textContent = runningVehicles.length;
            
            const avgSpeed = runningVehicles.length > 0
                ? runningVehicles.reduce((sum, v) => sum + v.velocity, 0) / runningVehicles.length
                : 0;
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
        }

        // ========== ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸ ==========
        function updateSimulation() {
            if (!simulation.running) return;
            
            const deltaTime = 0.016 * simulation.speed; // ~60fps
            
            vehicles.forEach(vhl => {
                if (vhl.status === 1 && vhl.velocity > 0) {
                    // ê°„ë‹¨í•œ ì´ë™ ì‹œë®¬ë ˆì´ì…˜
                    const distance = vhl.velocity * deltaTime / 60; // m/min -> m/frame
                    vhl.x += Math.cos(vhl.angle) * distance;
                    vhl.y += Math.sin(vhl.angle) * distance;
                    
                    // ê²½ê³„ ì²´í¬
                    if (vhl.x < bounds.minX || vhl.x > bounds.maxX) vhl.angle = Math.PI - vhl.angle;
                    if (vhl.y < bounds.minY || vhl.y > bounds.maxY) vhl.angle = -vhl.angle;
                }
            });
            
            simulation.time += deltaTime;
        }

        // ========== ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ ==========
        function animate() {
            if (document.getElementById('autoPlay').checked) {
                updateSimulation();
            }
            render();
            updateStats();
            requestAnimationFrame(animate);
        }

        // ========== ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤ ==========
        function toggleSimulation() {
            simulation.running = !simulation.running;
        }

        function stepForward() {
            simulation.running = false;
            updateSimulation();
            render();
        }

        function resetSimulation() {
            simulation.time = 0;
            loadDefaultData();
        }

        function fitView() {
            const w = canvas.width;
            const h = canvas.height - 60;
            const layoutW = bounds.maxX - bounds.minX;
            const layoutH = bounds.maxY - bounds.minY;
            
            view.scale = Math.min((w - 100) / layoutW, (h - 100) / layoutH);
            view.offsetX = (w - layoutW * view.scale) / 2;
            view.offsetY = (h - layoutH * view.scale) / 2;
            
            document.getElementById('zoom').value = view.scale * 100;
            document.getElementById('zoomValue').textContent = Math.round(view.scale * 100) + '%';
            render();
        }

        function resetView() {
            view.scale = 0.5;
            view.offsetX = 0;
            view.offsetY = 0;
            document.getElementById('zoom').value = 50;
            document.getElementById('zoomValue').textContent = '50%';
            render();
        }

        function reloadData() {
            loadDefaultData();
        }

        // ========== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==========
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            render();
        });

        // ì¤Œ ì»¨íŠ¸ë¡¤
        document.getElementById('zoom').addEventListener('input', (e) => {
            view.scale = e.target.value / 100;
            document.getElementById('zoomValue').textContent = Math.round(view.scale * 100) + '%';
            render();
        });

        // ì¬ìƒ ì†ë„
        document.getElementById('playSpeed').addEventListener('input', (e) => {
            simulation.speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = simulation.speed.toFixed(1) + 'x';
        });

        // ì²´í¬ë°•ìŠ¤
        ['showRails', 'showVehicles', 'showLabels', 'showSpeed'].forEach(id => {
            document.getElementById(id).addEventListener('change', render);
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('vehicleFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = parseCSV(event.target.result);
                    processVehicleData(data);
                    updateStats();
                    render();
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('railedgeFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = parseCSV(event.target.result);
                    processRailEdgeData(data);
                    updateStats();
                    render();
                };
                reader.readAsText(file);
            }
        });

        // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸
        canvas.addEventListener('mousedown', (e) => {
            view.dragging = true;
            view.lastX = e.clientX;
            view.lastY = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (view.dragging) {
                view.offsetX += e.clientX - view.lastX;
                view.offsetY -= e.clientY - view.lastY;
                view.lastX = e.clientX;
                view.lastY = e.clientY;
                render();
            }
        });

        canvas.addEventListener('mouseup', () => {
            view.dragging = false;
        });

        // ë§ˆìš°ìŠ¤ íœ  ì¤Œ
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoom = e.deltaY > 0 ? 0.9 : 1.1;
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            const worldBefore = screenToWorld(mouseX, mouseY);
            view.scale *= zoom;
            view.scale = Math.max(0.05, Math.min(10, view.scale));
            const screenAfter = worldToScreen(worldBefore.x, worldBefore.y);
            
            view.offsetX += mouseX - screenAfter.x;
            view.offsetY -= mouseY - (canvas.height - screenAfter.y);
            
            document.getElementById('zoom').value = view.scale * 100;
            document.getElementById('zoomValue').textContent = Math.round(view.scale * 100) + '%';
            render();
        });

        // í´ë¦­ ì •ë³´ í‘œì‹œ
        canvas.addEventListener('click', (e) => {
            const worldPos = screenToWorld(e.clientX, e.clientY);
            
            // Vehicle í´ë¦­ ì²´í¬
            for (const vhl of vehicles) {
                const dx = worldPos.x - vhl.x;
                const dy = worldPos.y - vhl.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 50) {
                    showVehicleInfo(vhl);
                    return;
                }
            }
            
            // RailEdge í´ë¦­ ì²´í¬
            for (const edge of railEdges) {
                if (pointToLineDistance(worldPos, edge) < 100) {
                    showRailEdgeInfo(edge);
                    return;
                }
            }
        });

        function pointToLineDistance(point, edge) {
            const dx = edge.x2 - edge.x1;
            const dy = edge.y2 - edge.y1;
            const lenSq = dx * dx + dy * dy;
            
            if (lenSq === 0) {
                const px = point.x - edge.x1;
                const py = point.y - edge.y1;
                return Math.sqrt(px * px + py * py);
            }
            
            let t = ((point.x - edge.x1) * dx + (point.y - edge.y1) * dy) / lenSq;
            t = Math.max(0, Math.min(1, t));
            
            const projX = edge.x1 + t * dx;
            const projY = edge.y1 + t * dy;
            const distX = point.x - projX;
            const distY = point.y - projY;
            
            return Math.sqrt(distX * distX + distY * distY);
        }

        function showVehicleInfo(vhl) {
            const statusText = ['', 'RUN', 'OBS_STOP', 'JAM', 'E84_TIMEOUT'][vhl.status] || 'UNKNOWN';
            const speedClass = vhl.velocity > 250 ? 'speed-high' : 
                              vhl.velocity > 150 ? 'speed-medium' :
                              vhl.velocity > 0 ? 'speed-low' : 'speed-stopped';
            
            document.getElementById('infoContent').innerHTML = `
                <div class="info-row"><b>ğŸš— Vehicle: ${vhl.id}</b></div>
                <div class="info-row">í˜„ì¬ ì£¼ì†Œ: ${vhl.currentAddr}</div>
                <div class="info-row">ë‹¤ìŒ ì£¼ì†Œ: ${vhl.nextAddr}</div>
                <div class="info-row">ìƒíƒœ: ${statusText}</div>
                <div class="info-row">
                    ì†ë„: <span class="speed-indicator ${speedClass}">${vhl.velocity.toFixed(1)} m/min</span>
                </div>
                <div class="info-row">Carrier: ${vhl.carrierId}</div>
                <div class="info-row">ëª©ì ì§€: ${vhl.destination}</div>
                <div class="info-row">Cycle: ${vhl.cycle} / Period: ${vhl.cyclePeriod}</div>
            `;
        }

        function showRailEdgeInfo(edge) {
            const utilization = ((edge.velocity / edge.maxVelocity) * 100).toFixed(1);
            const speedClass = edge.velocity > 250 ? 'speed-high' : 
                              edge.velocity > 150 ? 'speed-medium' :
                              edge.velocity > 0 ? 'speed-low' : 'speed-stopped';
            
            document.getElementById('infoContent').innerHTML = `
                <div class="info-row"><b>ğŸ›¤ï¸ RailEdge</b></div>
                <div class="info-row" style="font-size: 10px;">${edge.id}</div>
                <div class="info-row">Factory: ${edge.fabId}</div>
                <div class="info-row">ê¸¸ì´: ${edge.length.toFixed(0)} mm</div>
                <div class="info-row">
                    ì†ë„: <span class="speed-indicator ${speedClass}">${edge.velocity.toFixed(1)} m/min</span>
                </div>
                <div class="info-row">ìµœëŒ€ ì†ë„: ${edge.maxVelocity} m/min</div>
                <div class="info-row">í™œìš©ë¥ : ${utilization}%</div>
                <div class="info-row">ë°€ë„: ${(edge.density * 100).toFixed(1)}%</div>
                <div class="info-row">Vehicle ìˆ˜: ${edge.vhlCnt}ëŒ€</div>
                <div class="info-row">í†µê³¼ ìˆ˜: ${edge.passCnt}íšŒ</div>
                <div class="info-row">ì‚¬ìš© ê°€ëŠ¥: ${edge.isAvailable ? 'âœ… Yes' : 'âŒ No'}</div>
            `;
        }

        // ========== ì´ˆê¸°í™” ==========
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        loadDefaultData();
        animate();

        // ========== ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
        
        // íŒ¨ë„ í† ê¸€
        function toggleDataManager() {
            const panel = document.getElementById('dataManager');
            panel.classList.toggle('active');
            updateVehicleList();
            updateRailEdgeList();
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // íƒ­ ì»¨í…ì¸  í‘œì‹œ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'vehicle') {
                document.getElementById('vehicleTab').classList.add('active');
                updateVehicleList();
            } else {
                document.getElementById('railedgeTab').classList.add('active');
                updateRailEdgeList();
            }
        }

        // ========== Vehicle ê´€ë¦¬ ==========
        
        let editingVehicleId = null;

        function addVehicle() {
            const id = document.getElementById('vhl_id').value.trim();
            const mcp = document.getElementById('vhl_mcp').value.trim();
            const currentAddr = parseInt(document.getElementById('vhl_currentAddr').value);
            const currentDist = parseFloat(document.getElementById('vhl_currentDist').value) || 0;
            const nextAddr = parseInt(document.getElementById('vhl_nextAddr').value) || currentAddr;
            const status = parseInt(document.getElementById('vhl_status').value);
            const velocity = parseFloat(document.getElementById('vhl_velocity').value);
            const cycle = parseInt(document.getElementById('vhl_cycle').value);
            const cyclePeriod = parseInt(document.getElementById('vhl_cyclePeriod').value);
            const carrier = document.getElementById('vhl_carrier').value.trim() || 'EMPTY';
            const destination = parseInt(document.getElementById('vhl_destination').value) || 0;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!id || !currentAddr || velocity === undefined || isNaN(velocity)) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš” (Vehicle ID, í˜„ì¬ ì£¼ì†Œ, ì†ë„)');
                return;
            }

            // ID ì¤‘ë³µ ê²€ì‚¬ (í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
            if (!editingVehicleId && vehicles.find(v => v.id === id)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Vehicle IDì…ë‹ˆë‹¤.');
                return;
            }

            const timestamp = new Date().toISOString();

            const newVehicle = {
                id: id,
                mcp: mcp,
                currentAddr: currentAddr,
                currentDist: currentDist,
                nextAddr: nextAddr,
                status: status,
                cycle: cycle,
                cyclePeriod: cyclePeriod,
                carrierId: carrier,
                destination: destination,
                velocity: velocity,
                timestamp: timestamp,
                x: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                y: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                angle: Math.random() * Math.PI * 2
            };

            if (editingVehicleId) {
                // ìˆ˜ì • ëª¨ë“œ
                const index = vehicles.findIndex(v => v.id === editingVehicleId);
                if (index !== -1) {
                    vehicles[index] = newVehicle;
                }
                editingVehicleId = null;
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                vehicles.push(newVehicle);
            }

            clearVehicleForm();
            updateVehicleList();
            updateStats();
            render();
            
            alert(editingVehicleId ? 'Vehicleì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'Vehicleì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function editVehicle(id) {
            const vhl = vehicles.find(v => v.id === id);
            if (!vhl) return;

            editingVehicleId = id;

            document.getElementById('vhl_id').value = vhl.id;
            document.getElementById('vhl_mcp').value = vhl.mcp;
            document.getElementById('vhl_currentAddr').value = vhl.currentAddr;
            document.getElementById('vhl_currentDist').value = vhl.currentDist;
            document.getElementById('vhl_nextAddr').value = vhl.nextAddr;
            document.getElementById('vhl_status').value = vhl.status;
            document.getElementById('vhl_velocity').value = vhl.velocity;
            document.getElementById('vhl_cycle').value = vhl.cycle;
            document.getElementById('vhl_cyclePeriod').value = vhl.cyclePeriod;
            document.getElementById('vhl_carrier').value = vhl.carrierId;
            document.getElementById('vhl_destination').value = vhl.destination;

            document.querySelector('#vehicleTab .btn-primary').textContent = 'âœï¸ ìˆ˜ì •';
            document.getElementById('vhl_id').readOnly = true;
        }

        function deleteVehicle(id) {
            if (!confirm(`Vehicle ${id}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const index = vehicles.findIndex(v => v.id === id);
            if (index !== -1) {
                vehicles.splice(index, 1);
                updateVehicleList();
                updateStats();
                render();
                alert('Vehicleì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function clearVehicleForm() {
            editingVehicleId = null;
            document.getElementById('vhl_id').value = '';
            document.getElementById('vhl_mcp').value = 'OHT';
            document.getElementById('vhl_currentAddr').value = '';
            document.getElementById('vhl_currentDist').value = '';
            document.getElementById('vhl_nextAddr').value = '';
            document.getElementById('vhl_status').value = '1';
            document.getElementById('vhl_velocity').value = '';
            document.getElementById('vhl_cycle').value = '4';
            document.getElementById('vhl_cyclePeriod').value = '4';
            document.getElementById('vhl_carrier').value = '';
            document.getElementById('vhl_destination').value = '';
            
            document.querySelector('#vehicleTab .btn-primary').textContent = 'â• ì¶”ê°€';
            document.getElementById('vhl_id').readOnly = false;
        }

        function updateVehicleList() {
            const listDiv = document.getElementById('vehicleList');
            document.getElementById('vhlListCount').textContent = vehicles.length;

            if (vehicles.length === 0) {
                listDiv.innerHTML = '<div style="color: #94a3b8; padding: 10px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>ID</th><th>ì£¼ì†Œ</th><th>ì†ë„</th><th>ìƒíƒœ</th><th>ì‘ì—…</th>';
            html += '</tr></thead><tbody>';

            vehicles.forEach(vhl => {
                const statusText = ['', 'RUN', 'STOP', 'JAM', 'TIMEOUT'][vhl.status] || '-';
                html += `<tr>
                    <td>${vhl.id}</td>
                    <td>${vhl.currentAddr}</td>
                    <td>${vhl.velocity.toFixed(1)}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="btn-edit" onclick="editVehicle('${vhl.id}')">âœï¸</button>
                        <button class="btn-delete" onclick="deleteVehicle('${vhl.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function downloadVehicleCSV() {
            if (vehicles.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['vehicleId', 'mcpName', 'currentAddr', 'currentDist', 'nextAddr', 
                            'status', 'cycle', 'cyclePeriod', 'carrierId', 'destination', 
                            'velocity', 'timestamp'];
            
            let csv = headers.join(',') + '\n';
            
            vehicles.forEach(vhl => {
                const row = [
                    vhl.id, vhl.mcp, vhl.currentAddr, vhl.currentDist, vhl.nextAddr,
                    vhl.status, vhl.cycle, vhl.cyclePeriod, vhl.carrierId, vhl.destination,
                    vhl.velocity, vhl.timestamp
                ];
                csv += row.join(',') + '\n';
            });

            downloadCSVFile(csv, 'vehicle_data.csv');
        }

        // ========== RailEdge ê´€ë¦¬ ==========
        
        let editingRailEdgeId = null;

        function addRailEdge() {
            const id = document.getElementById('edge_id').value.trim();
            const fabId = document.getElementById('edge_fabId').value.trim();
            const mcp = document.getElementById('edge_mcp').value.trim();
            const length = parseFloat(document.getElementById('edge_length').value);
            const velocity = parseFloat(document.getElementById('edge_velocity').value);
            const maxVelocity = parseFloat(document.getElementById('edge_maxVelocity').value);
            const density = parseFloat(document.getElementById('edge_density').value) || 0;
            const vhlCnt = parseInt(document.getElementById('edge_vhlCnt').value) || 0;
            const passCnt = parseInt(document.getElementById('edge_passCnt').value) || 0;
            const isAvailable = document.getElementById('edge_isAvailable').checked;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!id || !length || velocity === undefined || !maxVelocity) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš” (RailEdge ID, ê¸¸ì´, ì†ë„, ìµœëŒ€ ì†ë„)');
                return;
            }

            // ID ì¤‘ë³µ ê²€ì‚¬
            if (!editingRailEdgeId && railEdges.find(e => e.id === id)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” RailEdge IDì…ë‹ˆë‹¤.');
                return;
            }

            const newEdge = {
                id: id,
                fabId: fabId,
                mcp: mcp,
                length: length,
                velocity: velocity,
                maxVelocity: maxVelocity,
                density: density,
                vhlCnt: vhlCnt,
                passCnt: passCnt,
                isAvailable: isAvailable,
                x1: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                y1: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                x2: Math.random() * (bounds.maxX - bounds.minX) + bounds.minX,
                y2: Math.random() * (bounds.maxY - bounds.minY) + bounds.minY,
                color: getSpeedColor(velocity, maxVelocity)
            };

            if (editingRailEdgeId) {
                // ìˆ˜ì • ëª¨ë“œ
                const index = railEdges.findIndex(e => e.id === editingRailEdgeId);
                if (index !== -1) {
                    railEdges[index] = newEdge;
                }
                editingRailEdgeId = null;
            } else {
                // ì¶”ê°€ ëª¨ë“œ
                railEdges.push(newEdge);
            }

            clearRailEdgeForm();
            updateRailEdgeList();
            updateStats();
            render();
            
            alert(editingRailEdgeId ? 'RailEdgeê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'RailEdgeê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function editRailEdge(id) {
            const edge = railEdges.find(e => e.id === id);
            if (!edge) return;

            editingRailEdgeId = id;

            document.getElementById('edge_id').value = edge.id;
            document.getElementById('edge_fabId').value = edge.fabId;
            document.getElementById('edge_mcp').value = edge.mcp;
            document.getElementById('edge_length').value = edge.length;
            document.getElementById('edge_velocity').value = edge.velocity;
            document.getElementById('edge_maxVelocity').value = edge.maxVelocity;
            document.getElementById('edge_density').value = edge.density;
            document.getElementById('edge_vhlCnt').value = edge.vhlCnt;
            document.getElementById('edge_passCnt').value = edge.passCnt;
            document.getElementById('edge_isAvailable').checked = edge.isAvailable;

            document.querySelector('#railedgeTab .btn-primary').textContent = 'âœï¸ ìˆ˜ì •';
            document.getElementById('edge_id').readOnly = true;
        }

        function deleteRailEdge(id) {
            if (!confirm(`RailEdge ${id}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const index = railEdges.findIndex(e => e.id === id);
            if (index !== -1) {
                railEdges.splice(index, 1);
                updateRailEdgeList();
                updateStats();
                render();
                alert('RailEdgeê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function clearRailEdgeForm() {
            editingRailEdgeId = null;
            document.getElementById('edge_id').value = '';
            document.getElementById('edge_fabId').value = 'M14A';
            document.getElementById('edge_mcp').value = 'OHT';
            document.getElementById('edge_length').value = '';
            document.getElementById('edge_velocity').value = '';
            document.getElementById('edge_maxVelocity').value = '';
            document.getElementById('edge_density').value = '';
            document.getElementById('edge_vhlCnt').value = '';
            document.getElementById('edge_passCnt').value = '';
            document.getElementById('edge_isAvailable').checked = true;
            
            document.querySelector('#railedgeTab .btn-primary').textContent = 'â• ì¶”ê°€';
            document.getElementById('edge_id').readOnly = false;
        }

        function updateRailEdgeList() {
            const listDiv = document.getElementById('railedgeList');
            document.getElementById('edgeListCount').textContent = railEdges.length;

            if (railEdges.length === 0) {
                listDiv.innerHTML = '<div style="color: #94a3b8; padding: 10px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>ID (ì¶•ì•½)</th><th>ì†ë„</th><th>ìµœëŒ€</th><th>ì‘ì—…</th>';
            html += '</tr></thead><tbody>';

            railEdges.forEach(edge => {
                // IDë¥¼ ì¶•ì•½í•´ì„œ í‘œì‹œ
                const shortId = edge.id.length > 20 ? edge.id.substring(0, 17) + '...' : edge.id;
                html += `<tr>
                    <td title="${edge.id}">${shortId}</td>
                    <td>${edge.velocity.toFixed(1)}</td>
                    <td>${edge.maxVelocity}</td>
                    <td>
                        <button class="btn-edit" onclick="editRailEdge('${edge.id}')">âœï¸</button>
                        <button class="btn-delete" onclick="deleteRailEdge('${edge.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function downloadRailEdgeCSV() {
            if (railEdges.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['railEdgeId', 'fabId', 'mcpName', 'length', 'velocity', 
                            'maxVelocity', 'density', 'vhlCnt', 'passCnt', 'isAvailable', 'createTime'];
            
            let csv = headers.join(',') + '\n';
            
            railEdges.forEach(edge => {
                const row = [
                    edge.id, edge.fabId, edge.mcp, edge.length, edge.velocity,
                    edge.maxVelocity, edge.density, edge.vhlCnt, edge.passCnt,
                    edge.isAvailable, new Date().toISOString()
                ];
                csv += row.join(',') + '\n';
            });

            downloadCSVFile(csv, 'railedge_data.csv');
        }

        // CSV ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜
        function downloadCSVFile(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) {
                // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>