"""
================================================================================
AMHS ì˜ˆì¸¡ ëª¨ë¸ íŒ¨ì¹˜ë…¸íŠ¸ ê´€ë¦¬ í”„ë¡œê·¸ë¨
================================================================================
ê¸°ëŠ¥:
  - íŒ¨ì¹˜ë…¸íŠ¸ ì‘ì„±
  - JSON íŒŒì¼ë¡œ ì €ì¥/ë¡œë“œ
  - íƒ­ìœ¼ë¡œ ë²„ì „ë³„ ë¶„ë¦¬
  - ì½˜ì†”/íŒŒì¼ ì¶œë ¥
================================================================================
"""

import json
import os
from datetime import datetime
from typing import List, Dict, Optional


class PatchNote:
    """íŒ¨ì¹˜ë…¸íŠ¸ ë°ì´í„° í´ë˜ìŠ¤"""
    
    def __init__(self, version: str, date: str = None, note_type: str = "Major"):
        self.version = version
        self.date = date or datetime.now().strftime("%Y-%m-%d")
        self.type = note_type
        self.new: List[str] = []
        self.improved: List[str] = []
        self.fixed: List[str] = []
        self.breaking: List[str] = []
        self.metrics: Dict[str, Dict] = {}
        self.files: List[str] = []
        self.next: List[str] = []
        self.notes: List[str] = []
    
    def to_dict(self) -> dict:
        """ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜"""
        return {
            "version": self.version,
            "date": self.date,
            "type": self.type,
            "new": self.new,
            "improved": self.improved,
            "fixed": self.fixed,
            "breaking": self.breaking,
            "metrics": self.metrics,
            "files": self.files,
            "next": self.next,
            "notes": self.notes,
        }
    
    @classmethod
    def from_dict(cls, data: dict) -> 'PatchNote':
        """ë”•ì…”ë„ˆë¦¬ì—ì„œ ìƒì„±"""
        note = cls(data["version"], data["date"], data.get("type", "Major"))
        note.new = data.get("new", [])
        note.improved = data.get("improved", [])
        note.fixed = data.get("fixed", [])
        note.breaking = data.get("breaking", [])
        note.metrics = data.get("metrics", {})
        note.files = data.get("files", [])
        note.next = data.get("next", [])
        note.notes = data.get("notes", [])
        return note


class PatchNoteManager:
    """íŒ¨ì¹˜ë…¸íŠ¸ ê´€ë¦¬ì"""
    
    def __init__(self, project_name: str = "AMHS ì˜ˆì¸¡ ëª¨ë¸"):
        self.project_name = project_name
        self.notes: Dict[str, PatchNote] = {}  # version -> PatchNote
        self.save_file = "patch_notes.json"
    
    # ========== ì¶”ê°€/ì‚­ì œ ==========
    
    def add(self, note: PatchNote):
        """íŒ¨ì¹˜ë…¸íŠ¸ ì¶”ê°€"""
        self.notes[note.version] = note
        print(f"âœ… {note.version} ì¶”ê°€ë¨")
        return self
    
    def remove(self, version: str):
        """íŒ¨ì¹˜ë…¸íŠ¸ ì‚­ì œ"""
        if version in self.notes:
            del self.notes[version]
            print(f"ğŸ—‘ï¸ {version} ì‚­ì œë¨")
        else:
            print(f"âŒ {version} ì—†ìŒ")
        return self
    
    def get(self, version: str) -> Optional[PatchNote]:
        """ë²„ì „ìœ¼ë¡œ ì¡°íšŒ"""
        return self.notes.get(version)
    
    def list_versions(self) -> List[str]:
        """ëª¨ë“  ë²„ì „ ëª©ë¡"""
        return sorted(self.notes.keys(), reverse=True)
    
    # ========== ì €ì¥/ë¡œë“œ ==========
    
    def save(self, filename: str = None):
        """JSON íŒŒì¼ë¡œ ì €ì¥"""
        filename = filename or self.save_file
        data = {
            "project": self.project_name,
            "updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "notes": {v: n.to_dict() for v, n in self.notes.items()}
        }
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"ğŸ’¾ ì €ì¥ë¨: {filename}")
        return self
    
    def load(self, filename: str = None):
        """JSON íŒŒì¼ì—ì„œ ë¡œë“œ"""
        filename = filename or self.save_file
        if not os.path.exists(filename):
            print(f"âŒ íŒŒì¼ ì—†ìŒ: {filename}")
            return self
        
        with open(filename, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        self.project_name = data.get("project", self.project_name)
        self.notes = {}
        for version, note_data in data.get("notes", {}).items():
            self.notes[version] = PatchNote.from_dict(note_data)
        
        print(f"ğŸ“‚ ë¡œë“œë¨: {filename} ({len(self.notes)}ê°œ ë²„ì „)")
        return self
    
    # ========== ì¶œë ¥ ==========
    
    def print_one(self, version: str):
        """ë‹¨ì¼ ë²„ì „ ì¶œë ¥"""
        note = self.get(version)
        if not note:
            print(f"âŒ {version} ì—†ìŒ")
            return
        
        self._print_note(note)
    
    def print_all(self):
        """ì „ì²´ ë²„ì „ ì¶œë ¥"""
        for version in self.list_versions():
            self._print_note(self.notes[version])
            print()
    
    def print_tabs(self):
        """íƒ­ í˜•ì‹ìœ¼ë¡œ ë²„ì „ ëª©ë¡ ì¶œë ¥"""
        versions = self.list_versions()
        if not versions:
            print("íŒ¨ì¹˜ë…¸íŠ¸ ì—†ìŒ")
            return
        
        print("\n" + "=" * 60)
        print(f"  {self.project_name} íŒ¨ì¹˜ë…¸íŠ¸")
        print("=" * 60)
        
        # íƒ­ í—¤ë”
        print("\nâ”Œ" + "â”€" * 58 + "â”")
        tab_line = "â”‚ "
        for i, v in enumerate(versions):
            tab_line += f"[{i+1}] {v}  "
        print(tab_line.ljust(59) + "â”‚")
        print("â””" + "â”€" * 58 + "â”˜")
        
        # ë²„ì „ ì„ íƒ
        while True:
            try:
                choice = input("\në²„ì „ ë²ˆí˜¸ ì„ íƒ (0=ì¢…ë£Œ): ").strip()
                if choice == "0" or choice == "":
                    break
                idx = int(choice) - 1
                if 0 <= idx < len(versions):
                    self._print_note(self.notes[versions[idx]])
                else:
                    print("ì˜ëª»ëœ ë²ˆí˜¸")
            except ValueError:
                print("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”")
            except KeyboardInterrupt:
                break
    
    def _print_note(self, note: PatchNote):
        """íŒ¨ì¹˜ë…¸íŠ¸ í¬ë§· ì¶œë ¥"""
        w = 58  # ë„ˆë¹„
        
        print()
        print("â”Œ" + "â”€" * w + "â”")
        print(f"â”‚  {self.project_name} {note.version}".ljust(w) + " â”‚")
        print(f"â”‚  {note.date} | {note.type} Update".ljust(w) + " â”‚")
        print("â”œ" + "â”€" * w + "â”¤")
        
        # NEW
        if note.new:
            print(f"â”‚  [NEW] ì‹ ê·œ ê¸°ëŠ¥".ljust(w) + " â”‚")
            for item in note.new:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        # IMPROVED
        if note.improved:
            print(f"â”‚  [IMPROVED] ê°œì„ ì‚¬í•­".ljust(w) + " â”‚")
            for item in note.improved:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        # METRICS
        if note.metrics:
            print(f"â”‚  [METRICS] ì„±ëŠ¥ ë³€í™”".ljust(w) + " â”‚")
            for name, data in note.metrics.items():
                before = data.get('before', '-')
                after = data.get('after', '-')
                change = data.get('change', '')
                line = f"â”‚    â€¢ {name}: {before} â†’ {after} ({change})"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        # FIXED
        print(f"â”‚  [FIXED] ë²„ê·¸ ìˆ˜ì •".ljust(w) + " â”‚")
        if note.fixed:
            for item in note.fixed:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        else:
            print(f"â”‚    â€¢ ì—†ìŒ".ljust(w) + " â”‚")
        
        # BREAKING
        if note.breaking:
            print(f"â”‚  [BREAKING] í˜¸í™˜ì„±".ljust(w) + " â”‚")
            for item in note.breaking:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        # FILES
        if note.files:
            print(f"â”‚  [FILES] ë³€ê²½ íŒŒì¼".ljust(w) + " â”‚")
            for item in note.files:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        # NEXT
        if note.next:
            print(f"â”‚  [NEXT] ë‹¤ìŒ ë²„ì „ ì˜ˆê³ ".ljust(w) + " â”‚")
            for item in note.next:
                line = f"â”‚    â€¢ {item}"
                if len(line) > w:
                    line = line[:w-3] + "..."
                print(line.ljust(w) + " â”‚")
        
        print("â””" + "â”€" * w + "â”˜")
    
    # ========== ë‚´ë³´ë‚´ê¸° ==========
    
    def export_md(self, filename: str = "PATCH_NOTES.md"):
        """ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°"""
        lines = []
        lines.append(f"# {self.project_name} íŒ¨ì¹˜ë…¸íŠ¸\n")
        lines.append(f"*ìµœì¢… ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d')}*\n")
        
        for version in self.list_versions():
            note = self.notes[version]
            lines.append(f"\n---\n")
            lines.append(f"## {note.version} ({note.date})\n")
            lines.append(f"**{note.type} Update**\n")
            
            if note.new:
                lines.append("\n### âœ¨ ì‹ ê·œ ê¸°ëŠ¥\n")
                for item in note.new:
                    lines.append(f"- {item}\n")
            
            if note.improved:
                lines.append("\n### â¬†ï¸ ê°œì„ ì‚¬í•­\n")
                for item in note.improved:
                    lines.append(f"- {item}\n")
            
            if note.metrics:
                lines.append("\n### ğŸ“Š ì„±ëŠ¥ ë³€í™”\n")
                lines.append("| ì§€í‘œ | Before | After | ë³€í™” |\n")
                lines.append("|------|--------|-------|------|\n")
                for name, data in note.metrics.items():
                    before = data.get('before', '-')
                    after = data.get('after', '-')
                    change = data.get('change', '')
                    lines.append(f"| {name} | {before} | {after} | {change} |\n")
            
            if note.fixed:
                lines.append("\n### ğŸ”§ ë²„ê·¸ ìˆ˜ì •\n")
                for item in note.fixed:
                    lines.append(f"- {item}\n")
            
            if note.breaking:
                lines.append("\n### âš ï¸ Breaking Changes\n")
                for item in note.breaking:
                    lines.append(f"- {item}\n")
            
            if note.files:
                lines.append("\n### ğŸ“ ë³€ê²½ íŒŒì¼\n")
                for item in note.files:
                    lines.append(f"- `{item}`\n")
            
            if note.next:
                lines.append("\n### ğŸ”® ë‹¤ìŒ ë²„ì „ ì˜ˆê³ \n")
                for item in note.next:
                    lines.append(f"- {item}\n")
        
        with open(filename, 'w', encoding='utf-8') as f:
            f.writelines(lines)
        
        print(f"ğŸ“„ MD ì €ì¥ë¨: {filename}")
        return self


# ========== ìƒ˜í”Œ ë°ì´í„° ==========

def create_sample_data() -> PatchNoteManager:
    """V6~V8 ìƒ˜í”Œ íŒ¨ì¹˜ë…¸íŠ¸ ìƒì„±"""
    
    manager = PatchNoteManager("AMHS ì˜ˆì¸¡ ëª¨ë¸")
    
    # V8.0.0
    v8 = PatchNote("V8.0.0", "2025-12-01", "Major")
    v8.new = [
        "ë²”ì£¼í˜• 3-Class ë¶„ë¥˜ ëª¨ë¸ ì¶”ê°€ (í•˜ë½/ì†Œí­/ê¸‰ì¦)",
        "M16HUB QUE ì»¬ëŸ¼ 5ê°œ ì¶”ê°€",
        "M16A QUE ì»¬ëŸ¼ 7ê°œ ì¶”ê°€",
        "CURRENT_M16A_3F_JOB ëŒ€ì²´ íƒ€ê²Ÿ ì»¬ëŸ¼ ì¶”ê°€",
    ]
    v8.improved = [
        "ì…ë ¥ ì»¬ëŸ¼: 19ê°œ â†’ 32ê°œ",
        "Feature ìˆ˜: 180ê°œ â†’ 222ê°œ",
        "ìˆ˜ì¹˜í˜• ëª¨ë¸: 50+ ë³€í™” ìƒ˜í”Œ 3ë°° ê°€ì¤‘ì¹˜ ì ìš©",
        "ë²”ì£¼í˜• ëª¨ë¸: Class2(ê¸‰ì¦) 5ë°° ê°€ì¤‘ì¹˜ ì ìš©",
    ]
    v8.metrics = {
        "MAE": {"before": 12.5, "after": 9.8, "change": "â†“21%"},
        "RÂ²": {"before": 0.62, "after": 0.68, "change": "â†‘9.7%"},
        "ë²”ì£¼í˜•ì •í™•ë„": {"before": "-", "after": "72%", "change": "ì‹ ê·œ"},
    }
    v8.fixed = []
    v8.breaking = [
        "V7 ëª¨ë¸ íŒŒì¼(.pkl)ê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŒ",
        "V8 ì „ìš© í‰ê°€ ì½”ë“œ ì‚¬ìš© í•„ìš”",
    ]
    v8.files = [
        "V8_ìˆ˜ì¹˜í˜•_í•™ìŠµì½”ë“œ.py",
        "V8_ìˆ˜ì¹˜í˜•_í‰ê°€ì½”ë“œ.py",
        "V8_ë²”ì£¼í˜•_í•™ìŠµì½”ë“œ.py",
        "V8_ë²”ì£¼í˜•_í‰ê°€ì½”ë“œ.py",
        "xgboost_ìˆ˜ì¹˜í˜•_V8.pkl",
        "xgboost_ë²”ì£¼í˜•_V8.pkl",
    ]
    v8.next = [
        "MLflow Tracking ì—°ë™",
        "í•˜ì´í¼íŒŒë¼ë¯¸í„° ìë™ íƒìƒ‰ (Optuna)",
    ]
    manager.add(v8)
    
    # V7.0.0
    v7 = PatchNote("V7.0.0", "2025-11-15", "Major")
    v7.new = [
        "M16HUB.QUE.ALL.CURRENTQCNT ì»¬ëŸ¼ ì¶”ê°€",
        "M16HUB.QUE.TIME.AVGTOTALTIME1MIN ì»¬ëŸ¼ ì¶”ê°€",
        "QUE ê¸°ë°˜ ë³‘ëª© ê°ì§€ Feature ì¶”ê°€",
    ]
    v7.improved = [
        "ì…ë ¥ ì»¬ëŸ¼: 17ê°œ â†’ 19ê°œ",
        "Feature ìˆ˜: 165ê°œ â†’ 180ê°œ",
        "ë³‘ëª© ê°ì§€ ë¡œì§ ê°•í™”",
    ]
    v7.metrics = {
        "MAE": {"before": 14.2, "after": 12.5, "change": "â†“12%"},
        "RÂ²": {"before": 0.58, "after": 0.62, "change": "â†‘6.9%"},
    }
    v7.fixed = [
        "HUBROOMTOTAL ê²°ì¸¡ì¹˜ ì²˜ë¦¬ ì˜¤ë¥˜ ìˆ˜ì •",
    ]
    v7.breaking = [
        "V6 ëª¨ë¸ íŒŒì¼ê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŒ",
    ]
    v7.files = [
        "V7_ìˆ˜ì¹˜í˜•_í•™ìŠµì½”ë“œ.py",
        "V7_ìˆ˜ì¹˜í˜•_í‰ê°€ì½”ë“œ.py",
    ]
    v7.next = [
        "ë²”ì£¼í˜• ë¶„ë¥˜ ëª¨ë¸ ì¶”ê°€",
        "QUE ì»¬ëŸ¼ í™•ì¥",
    ]
    manager.add(v7)
    
    # V6.0.0
    v6 = PatchNote("V6.0.0", "2025-10-20", "Major")
    v6.new = [
        "ë©€í‹°ì•„ì›ƒí’‹ êµ¬ì¡° ë„ì… (MIN/MAX/AVG)",
        "10ë¶„ êµ¬ê°„ í†µê³„ ì˜ˆì¸¡",
        "ë°©í–¥ ì •í™•ë„ ì§€í‘œ ì¶”ê°€",
    ]
    v6.improved = [
        "Feature ìˆ˜: 120ê°œ â†’ 165ê°œ",
        "ì‹œí€€ìŠ¤ ê¸¸ì´: 20ë¶„ â†’ 30ë¶„",
        "ì˜ˆì¸¡ ì•ˆì •ì„± í–¥ìƒ",
    ]
    v6.metrics = {
        "MAE": {"before": 18.5, "after": 14.2, "change": "â†“23%"},
        "RÂ²": {"before": 0.45, "after": 0.58, "change": "â†‘29%"},
    }
    v6.fixed = [
        "í° ë³€í™” ì˜ˆì¸¡ ëˆ„ë½ ë¬¸ì œ í•´ê²°",
    ]
    v6.breaking = [
        "ë‹¨ì¼ ì¶œë ¥ â†’ ë©€í‹° ì¶œë ¥ êµ¬ì¡° ë³€ê²½",
    ]
    v6.files = [
        "V6_í•™ìŠµì½”ë“œ.py",
        "V6_í‰ê°€ì½”ë“œ.py",
    ]
    v6.next = [
        "QUE ì»¬ëŸ¼ ì¶”ê°€",
        "ì‹¤ì‹œê°„ ì˜ˆì¸¡ ëª¨ë“ˆ",
    ]
    manager.add(v6)
    
    return manager


# ========== ë©”ì¸ ==========

def main():
    """ë©”ì¸ ë©”ë‰´"""
    
    manager = PatchNoteManager("AMHS ì˜ˆì¸¡ ëª¨ë¸")
    
    # ê¸°ì¡´ íŒŒì¼ ìˆìœ¼ë©´ ë¡œë“œ
    if os.path.exists("patch_notes.json"):
        manager.load()
    else:
        # ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        manager = create_sample_data()
        manager.save()
    
    while True:
        print("\n" + "=" * 40)
        print("  íŒ¨ì¹˜ë…¸íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ")
        print("=" * 40)
        print("  [1] ë²„ì „ë³„ íƒ­ ë³´ê¸°")
        print("  [2] ì „ì²´ ì¶œë ¥")
        print("  [3] íŠ¹ì • ë²„ì „ ë³´ê¸°")
        print("  [4] ìƒˆ íŒ¨ì¹˜ë…¸íŠ¸ ì¶”ê°€")
        print("  [5] íŒ¨ì¹˜ë…¸íŠ¸ ì‚­ì œ")
        print("  [6] ì €ì¥")
        print("  [7] ë¡œë“œ")
        print("  [8] MD ë‚´ë³´ë‚´ê¸°")
        print("  [0] ì¢…ë£Œ")
        print("=" * 40)
        
        choice = input("ì„ íƒ: ").strip()
        
        if choice == "1":
            manager.print_tabs()
        
        elif choice == "2":
            manager.print_all()
        
        elif choice == "3":
            version = input("ë²„ì „ ì…ë ¥ (ì˜ˆ: V8.0.0): ").strip()
            manager.print_one(version)
        
        elif choice == "4":
            print("\n[ìƒˆ íŒ¨ì¹˜ë…¸íŠ¸ ì¶”ê°€]")
            version = input("ë²„ì „ (ì˜ˆ: V9.0.0): ").strip()
            date = input("ë‚ ì§œ (YYYY-MM-DD, ì—”í„°=ì˜¤ëŠ˜): ").strip()
            note_type = input("ìœ í˜• (Major/Minor/Patch): ").strip() or "Major"
            
            note = PatchNote(version, date if date else None, note_type)
            
            print("\nì‹ ê·œ ê¸°ëŠ¥ (ë¹ˆ ì¤„ë¡œ ì¢…ë£Œ):")
            while True:
                item = input("  â€¢ ").strip()
                if not item:
                    break
                note.new.append(item)
            
            print("\nê°œì„ ì‚¬í•­ (ë¹ˆ ì¤„ë¡œ ì¢…ë£Œ):")
            while True:
                item = input("  â€¢ ").strip()
                if not item:
                    break
                note.improved.append(item)
            
            print("\në²„ê·¸ ìˆ˜ì • (ë¹ˆ ì¤„ë¡œ ì¢…ë£Œ):")
            while True:
                item = input("  â€¢ ").strip()
                if not item:
                    break
                note.fixed.append(item)
            
            print("\nBreaking Changes (ë¹ˆ ì¤„ë¡œ ì¢…ë£Œ):")
            while True:
                item = input("  â€¢ ").strip()
                if not item:
                    break
                note.breaking.append(item)
            
            manager.add(note)
            manager.save()
        
        elif choice == "5":
            version = input("ì‚­ì œí•  ë²„ì „: ").strip()
            confirm = input(f"{version} ì‚­ì œ? (y/n): ").strip().lower()
            if confirm == 'y':
                manager.remove(version)
                manager.save()
        
        elif choice == "6":
            manager.save()
        
        elif choice == "7":
            filename = input("íŒŒì¼ëª… (ì—”í„°=patch_notes.json): ").strip()
            manager.load(filename if filename else None)
        
        elif choice == "8":
            filename = input("íŒŒì¼ëª… (ì—”í„°=PATCH_NOTES.md): ").strip()
            manager.export_md(filename if filename else "PATCH_NOTES.md")
        
        elif choice == "0":
            print("ì¢…ë£Œ")
            break
        
        else:
            print("ì˜ëª»ëœ ì„ íƒ")


if __name__ == "__main__":
    main()