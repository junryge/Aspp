"""
Box Position Anomaly Detection - Web Version
Flask ê¸°ë°˜ ì›¹ ì„œë¹„ìŠ¤ + LLM ë¶„ì„

ì‹¤í–‰: python box_anomaly_web.py
ì ‘ì†: http://localhost:10005
"""

import os
import cv2
import numpy as np
import requests
import re
from flask import Flask, render_template_string, request, jsonify, send_from_directory
from werkzeug.utils import secure_filename
import base64
from PIL import Image, ImageDraw, ImageFont
import io

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = './uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB

# ì—…ë¡œë“œ í´ë” ìƒì„±
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

# ì „ì—­ ë³€ìˆ˜: ê¸°ì¤€ ì´ë¯¸ì§€
reference_data = {
    'center': None,
    'angle': None,
    'image': None
}

# ========================================
# LLM API ì„¤ì •
# ========================================
LLM_CONFIG = {
    "url": "http://common.llm.skhynix.com/v1/chat/completions",
    "model": "gpt-oss-20b",
    "name": "COMMON(20B)"
}

API_TOKEN = None

def load_api_token():
    """API í† í° ë¡œë“œ"""
    global API_TOKEN
    
    token_paths = [
        "token.txt",
        "../token.txt",
        os.path.expanduser("~/token.txt")
    ]
    
    for token_path in token_paths:
        if os.path.exists(token_path):
            try:
                with open(token_path, "r", encoding='utf-8') as f:
                    API_TOKEN = f.read().strip()
                if API_TOKEN and "REPLACE" not in API_TOKEN:
                    print(f"âœ… API í† í° ë¡œë“œ ì™„ë£Œ: {token_path}")
                    return True
            except Exception as e:
                print(f"âŒ í† í° ë¡œë“œ ì‹¤íŒ¨: {e}")
    
    print("âš ï¸ í† í° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    return False


def call_llm_api(prompt: str, system_prompt: str = "") -> dict:
    """LLM API í˜¸ì¶œ"""
    global API_TOKEN
    
    if not API_TOKEN:
        return {"success": False, "error": "API í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}
    
    headers = {
        "Authorization": f"Bearer {API_TOKEN}",
        "Content-Type": "application/json"
    }
    
    messages = []
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    messages.append({"role": "user", "content": prompt})
    
    data = {
        "model": LLM_CONFIG["model"],
        "messages": messages,
        "max_tokens": 2000,
        "temperature": 0.3
    }
    
    try:
        print("ğŸš€ LLM API í˜¸ì¶œ ì¤‘...")
        response = requests.post(LLM_CONFIG["url"], headers=headers, json=data, timeout=120)
        
        if response.status_code == 200:
            result = response.json()
            content = result["choices"][0]["message"]["content"]
            
            # <think> íƒœê·¸ ì œê±°
            content = re.sub(r'<think>.*?</think>', '', content, flags=re.DOTALL)
            content = content.strip()
            
            return {"success": True, "content": content}
        else:
            return {"success": False, "error": f"API ì˜¤ë¥˜: {response.status_code}"}
            
    except requests.exceptions.Timeout:
        return {"success": False, "error": "API ìš”ì²­ ì‹œê°„ ì´ˆê³¼"}
    except Exception as e:
        return {"success": False, "error": f"API í˜¸ì¶œ ì‹¤íŒ¨: {str(e)}"}


# í† í° ë¡œë“œ
load_api_token()


def find_box_center(gray_img):
    """ë°•ìŠ¤ ì¤‘ì‹¬ì  ì°¾ê¸°"""
    _, thresh = cv2.threshold(gray_img, 80, 255, cv2.THRESH_BINARY)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    
    if not contours:
        return None
    
    largest = max(contours, key=cv2.contourArea)
    M = cv2.moments(largest)
    if M["m00"] == 0:
        return None
    
    cx = int(M["m10"] / M["m00"])
    cy = int(M["m01"] / M["m00"])
    return (cx, cy)


def find_box_angle(gray_img):
    """ë°•ìŠ¤ íšŒì „ ê°ë„ ì°¾ê¸°"""
    _, thresh = cv2.threshold(gray_img, 80, 255, cv2.THRESH_BINARY)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    
    if not contours:
        return 0
    
    largest = max(contours, key=cv2.contourArea)
    rect = cv2.minAreaRect(largest)
    angle = rect[2]
    
    if angle < -45:
        angle += 90
    
    return angle


def detect_anomaly(test_img, position_threshold=30, angle_threshold=10):
    """ì´ìƒ íƒì§€"""
    if reference_data['center'] is None:
        return {'error': 'ê¸°ì¤€ ì´ë¯¸ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'}
    
    gray = cv2.cvtColor(test_img, cv2.COLOR_BGR2GRAY)
    test_center = find_box_center(gray)
    test_angle = find_box_angle(gray)
    
    if test_center is None:
        return {
            'is_anomaly': True,
            'anomaly_type': 'ë°•ìŠ¤ ì—†ìŒ',
            'position_shift': -1,
            'angle_shift': -1
        }
    
    # ê±°ë¦¬ ê³„ì‚°
    position_shift = np.sqrt(
        (test_center[0] - reference_data['center'][0])**2 + 
        (test_center[1] - reference_data['center'][1])**2
    )
    angle_shift = abs(test_angle - reference_data['angle'])
    
    # íŒì •
    is_position_anomaly = position_shift > position_threshold
    is_angle_anomaly = angle_shift > angle_threshold
    is_anomaly = is_position_anomaly or is_angle_anomaly
    
    if is_position_anomaly and is_angle_anomaly:
        anomaly_type = 'ìœ„ì¹˜+íšŒì „'
    elif is_position_anomaly:
        anomaly_type = 'ìœ„ì¹˜ ì´íƒˆ'
    elif is_angle_anomaly:
        anomaly_type = 'íšŒì „ë¨'
    else:
        anomaly_type = 'ì •ìƒ'
    
    return {
        'is_anomaly': bool(is_anomaly),
        'anomaly_type': anomaly_type,
        'position_shift': float(round(position_shift, 1)),
        'angle_shift': float(round(angle_shift, 1)),
        'test_center': test_center,
        'ref_center': reference_data['center']
    }


def draw_result(img, result):
    """ê²°ê³¼ ì´ë¯¸ì§€ì— í‘œì‹œ"""
    img = img.copy()
    
    if result.get('is_anomaly'):
        color = (0, 0, 255)  # ë¹¨ê°•
    else:
        color = (0, 255, 0)  # ì´ˆë¡
    
    # í…Œë‘ë¦¬
    cv2.rectangle(img, (5, 5), (img.shape[1]-5, img.shape[0]-5), color, 4)
    
    # ì¤‘ì‹¬ì  í‘œì‹œ
    if result.get('test_center'):
        cv2.circle(img, result['test_center'], 10, color, -1)
    if result.get('ref_center'):
        cv2.circle(img, result['ref_center'], 8, (255, 0, 0), 2)
    
    return img


def img_to_base64(img):
    """ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜"""
    _, buffer = cv2.imencode('.png', img)
    return base64.b64encode(buffer).decode('utf-8')


# HTML í…œí”Œë¦¿
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #00d4ff;
        }
        .header h1 {
            font-size: 28px;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        .header p { color: #888; font-size: 14px; }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card h2::before {
            content: 'â–¶';
            font-size: 12px;
        }
        
        .upload-area {
            border: 2px dashed #444;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .upload-area:hover {
            border-color: #00d4ff;
            background: rgba(0,212,255,0.05);
        }
        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        .upload-area input { display: none; }
        .upload-area p { color: #888; margin-top: 10px; }
        
        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            display: none;
            margin-top: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,212,255,0.4);
        }
        .btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-success { background: linear-gradient(135deg, #00ff88, #00cc6a); }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .result-box.normal {
            background: rgba(0,255,136,0.1);
            border: 2px solid #00ff88;
        }
        .result-box.anomaly {
            background: rgba(255,68,68,0.1);
            border: 2px solid #ff4444;
        }
        .result-box h3 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        .result-box.normal h3 { color: #00ff88; }
        .result-box.anomaly h3 { color: #ff4444; }
        
        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .detail-item {
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }
        .detail-item label {
            color: #888;
            font-size: 12px;
            display: block;
        }
        .detail-item span {
            font-size: 18px;
            font-weight: bold;
        }
        
        .result-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-badge.set { background: #00ff88; color: #000; }
        .status-badge.unset { background: #ff4444; color: #fff; }
        
        .settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .setting-item label {
            display: block;
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .setting-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
        }
        
        .history {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .history-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        .history-item.normal { border-left: 3px solid #00ff88; }
        .history-item.anomaly { border-left: 3px solid #ff4444; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        .stat-item .number {
            font-size: 32px;
            font-weight: bold;
        }
        .stat-item .label { color: #888; font-size: 12px; }
        .stat-item.total .number { color: #00d4ff; }
        .stat-item.normal .number { color: #00ff88; }
        .stat-item.anomaly .number { color: #ff4444; }
        
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ì‹œìŠ¤í…œ</h1>
        <p>Box Position Anomaly Detection System - BATA_VER_V0.1</p>
    </div>
    
    <div class="container">
        <!-- ì™¼ìª½: ê¸°ì¤€ ì´ë¯¸ì§€ ì„¤ì • -->
        <div class="card">
            <h2>ê¸°ì¤€ ì´ë¯¸ì§€ ì„¤ì •
                <span class="status-badge unset" id="refStatus">ë¯¸ì„¤ì •</span>
            </h2>
            
            <div class="upload-area" id="refUpload" onclick="document.getElementById('refInput').click()">
                <input type="file" id="refInput" accept="image/*">
                <div style="font-size: 48px;">ğŸ“·</div>
                <p>í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                <p style="font-size: 12px; color: #666;">ì •ìƒ ìƒíƒœì˜ ë°•ìŠ¤ ì´ë¯¸ì§€</p>
            </div>
            <img id="refPreview" class="preview-img">
            <button class="btn btn-success" id="setRefBtn" disabled onclick="setReference()">
                ê¸°ì¤€ ì´ë¯¸ì§€ë¡œ ì„¤ì •
            </button>
            
            <div class="settings">
                <div class="setting-item">
                    <label>ìœ„ì¹˜ í—ˆìš© ì˜¤ì°¨ (px)</label>
                    <input type="number" id="posThreshold" value="30" min="1" max="200">
                </div>
                <div class="setting-item">
                    <label>ê°ë„ í—ˆìš© ì˜¤ì°¨ (Â°)</label>
                    <input type="number" id="angleThreshold" value="10" min="1" max="45">
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ë¥¸ìª½: í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ -->
        <div class="card">
            <h2>í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ë¶„ì„</h2>
            
            <div class="upload-area" id="testUpload" onclick="document.getElementById('testInput').click()">
                <input type="file" id="testInput" accept="image/*">
                <div style="font-size: 48px;">ğŸ”</div>
                <p>ë¶„ì„í•  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
            <img id="testPreview" class="preview-img">
            <button class="btn" id="analyzeBtn" disabled onclick="analyzeImage()">
                ì´ìƒ íƒì§€ ë¶„ì„
            </button>
            
            <div class="result-box" id="resultBox">
                <h3 id="resultTitle"></h3>
                <div class="result-details">
                    <div class="detail-item">
                        <label>ìœ í˜•</label>
                        <span id="resultType">-</span>
                    </div>
                    <div class="detail-item">
                        <label>ì´íƒˆ ê±°ë¦¬</label>
                        <span id="resultShift">-</span>
                    </div>
                    <div class="detail-item">
                        <label>íšŒì „ ê°ë„</label>
                        <span id="resultAngle">-</span>
                    </div>
                    <div class="detail-item">
                        <label>íŒì •</label>
                        <span id="resultJudge">-</span>
                    </div>
                </div>
                <img id="resultImage" class="result-image">
                
                <!-- LLM ë¶„ì„ ë²„íŠ¼ -->
                <button class="btn" id="llmBtn" onclick="llmAnalyze()" style="margin-top: 15px; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    ğŸ¤– AI ì›ì¸ ë¶„ì„ (LLM)
                </button>
                <div id="llmResult" style="display: none; margin-top: 15px; padding: 15px; background: rgba(155,89,182,0.1); border: 1px solid #9b59b6; border-radius: 10px;">
                    <h4 style="color: #9b59b6; margin-bottom: 10px;">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h4>
                    <div id="llmContent" style="white-space: pre-wrap; line-height: 1.6; font-size: 14px;"></div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨: í†µê³„ ë° íˆìŠ¤í† ë¦¬ -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ë¶„ì„ í†µê³„</h2>
            <div class="stats">
                <div class="stat-item total">
                    <div class="number" id="statTotal">0</div>
                    <div class="label">ì´ ê²€ì‚¬</div>
                </div>
                <div class="stat-item normal">
                    <div class="number" id="statNormal">0</div>
                    <div class="label">ì •ìƒ</div>
                </div>
                <div class="stat-item anomaly">
                    <div class="number" id="statAnomaly">0</div>
                    <div class="label">ì´ìƒ</div>
                </div>
            </div>
            
            <h2>ê²€ì‚¬ íˆìŠ¤í† ë¦¬</h2>
            <div class="history" id="history">
                <p style="color: #666; text-align: center; padding: 20px;">
                    ì•„ì§ ê²€ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                </p>
            </div>
        </div>
    </div>
    
    <script>
        let refImageData = null;
        let testImageData = null;
        let stats = { total: 0, normal: 0, anomaly: 0 };
        
        // ë“œë˜ê·¸ì•¤ë“œë¡­ ì„¤ì •
        ['refUpload', 'testUpload'].forEach(id => {
            const area = document.getElementById(id);
            area.addEventListener('dragover', e => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            area.addEventListener('drop', e => {
                e.preventDefault();
                area.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    if (id === 'refUpload') handleRefImage(file);
                    else handleTestImage(file);
                }
            });
        });
        
        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('refInput').addEventListener('change', e => {
            if (e.target.files[0]) handleRefImage(e.target.files[0]);
        });
        document.getElementById('testInput').addEventListener('change', e => {
            if (e.target.files[0]) handleTestImage(e.target.files[0]);
        });
        
        function handleRefImage(file) {
            const reader = new FileReader();
            reader.onload = e => {
                refImageData = e.target.result;
                document.getElementById('refPreview').src = refImageData;
                document.getElementById('refPreview').style.display = 'block';
                document.getElementById('setRefBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        function handleTestImage(file) {
            const reader = new FileReader();
            reader.onload = e => {
                testImageData = e.target.result;
                document.getElementById('testPreview').src = testImageData;
                document.getElementById('testPreview').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        async function setReference() {
            const response = await fetch('/set_reference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: refImageData })
            });
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('refStatus').textContent = 'ì„¤ì •ë¨';
                document.getElementById('refStatus').className = 'status-badge set';
                alert('ê¸°ì¤€ ì´ë¯¸ì§€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                alert('ì˜¤ë¥˜: ' + result.error);
            }
        }
        
        async function analyzeImage() {
            const posThreshold = document.getElementById('posThreshold').value;
            const angleThreshold = document.getElementById('angleThreshold').value;
            
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image: testImageData,
                    position_threshold: parseFloat(posThreshold),
                    angle_threshold: parseFloat(angleThreshold)
                })
            });
            const result = await response.json();
            
            if (result.error) {
                alert('ì˜¤ë¥˜: ' + result.error);
                return;
            }
            
            // ê²°ê³¼ í‘œì‹œ
            const resultBox = document.getElementById('resultBox');
            resultBox.style.display = 'block';
            
            if (result.is_anomaly) {
                resultBox.className = 'result-box anomaly';
                document.getElementById('resultTitle').textContent = 'âš ï¸ ì´ìƒ ê°ì§€!';
                document.getElementById('resultJudge').textContent = 'FAIL';
                document.getElementById('resultJudge').style.color = '#ff4444';
                stats.anomaly++;
            } else {
                resultBox.className = 'result-box normal';
                document.getElementById('resultTitle').textContent = 'âœ… ì •ìƒ';
                document.getElementById('resultJudge').textContent = 'PASS';
                document.getElementById('resultJudge').style.color = '#00ff88';
                stats.normal++;
            }
            stats.total++;
            
            document.getElementById('resultType').textContent = result.anomaly_type;
            document.getElementById('resultShift').textContent = result.position_shift + ' px';
            document.getElementById('resultAngle').textContent = result.angle_shift + 'Â°';
            document.getElementById('resultImage').src = 'data:image/png;base64,' + result.result_image;
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statNormal').textContent = stats.normal;
            document.getElementById('statAnomaly').textContent = stats.anomaly;
            
            // íˆìŠ¤í† ë¦¬ ì¶”ê°€
            addHistory(result);
        }
        
        let lastResult = null;  // ë§ˆì§€ë§‰ ë¶„ì„ ê²°ê³¼ ì €ì¥
        
        // analyzeImage í•¨ìˆ˜ ìˆ˜ì • - ê²°ê³¼ ì €ì¥
        const originalAnalyze = analyzeImage;
        analyzeImage = async function() {
            const posThreshold = document.getElementById('posThreshold').value;
            const angleThreshold = document.getElementById('angleThreshold').value;
            
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image: testImageData,
                    position_threshold: parseFloat(posThreshold),
                    angle_threshold: parseFloat(angleThreshold)
                })
            });
            const result = await response.json();
            
            if (result.error) {
                alert('ì˜¤ë¥˜: ' + result.error);
                return;
            }
            
            lastResult = result;  // ê²°ê³¼ ì €ì¥
            
            // ê²°ê³¼ í‘œì‹œ
            const resultBox = document.getElementById('resultBox');
            resultBox.style.display = 'block';
            
            if (result.is_anomaly) {
                resultBox.className = 'result-box anomaly';
                document.getElementById('resultTitle').textContent = 'âš ï¸ ì´ìƒ ê°ì§€!';
                document.getElementById('resultJudge').textContent = 'FAIL';
                document.getElementById('resultJudge').style.color = '#ff4444';
                stats.anomaly++;
            } else {
                resultBox.className = 'result-box normal';
                document.getElementById('resultTitle').textContent = 'âœ… ì •ìƒ';
                document.getElementById('resultJudge').textContent = 'PASS';
                document.getElementById('resultJudge').style.color = '#00ff88';
                stats.normal++;
            }
            stats.total++;
            
            document.getElementById('resultType').textContent = result.anomaly_type;
            document.getElementById('resultShift').textContent = result.position_shift + ' px';
            document.getElementById('resultAngle').textContent = result.angle_shift + 'Â°';
            document.getElementById('resultImage').src = 'data:image/png;base64,' + result.result_image;
            
            // LLM ê²°ê³¼ ì´ˆê¸°í™”
            document.getElementById('llmResult').style.display = 'none';
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statNormal').textContent = stats.normal;
            document.getElementById('statAnomaly').textContent = stats.anomaly;
            
            // íˆìŠ¤í† ë¦¬ ì¶”ê°€
            addHistory(result);
        }
        
        async function llmAnalyze() {
            if (!lastResult) {
                alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const btn = document.getElementById('llmBtn');
            const resultDiv = document.getElementById('llmResult');
            const contentDiv = document.getElementById('llmContent');
            
            btn.disabled = true;
            btn.textContent = 'ğŸ¤– AI ë¶„ì„ ì¤‘...';
            contentDiv.textContent = 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch('/llm_analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result: lastResult })
                });
                const data = await response.json();
                
                if (data.success) {
                    contentDiv.textContent = data.analysis;
                } else {
                    contentDiv.textContent = 'âŒ ë¶„ì„ ì‹¤íŒ¨: ' + data.error;
                }
            } catch (e) {
                contentDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + e.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ¤– AI ì›ì¸ ë¶„ì„ (LLM)';
        }
        
        function addHistory(result) {
            const history = document.getElementById('history');
            if (stats.total === 1) history.innerHTML = '';
            
            const item = document.createElement('div');
            item.className = 'history-item ' + (result.is_anomaly ? 'anomaly' : 'normal');
            item.innerHTML = `
                <img src="data:image/png;base64,${result.result_image}">
                <div>
                    <strong>${result.is_anomaly ? 'âš ï¸ ì´ìƒ' : 'âœ… ì •ìƒ'}</strong>
                    <span style="color: #888; font-size: 12px; margin-left: 10px;">
                        ${result.anomaly_type} | ${result.position_shift}px | ${result.angle_shift}Â°
                    </span>
                </div>
            `;
            history.insertBefore(item, history.firstChild);
        }
    </script>
</body>
</html>
'''


@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)


@app.route('/set_reference', methods=['POST'])
def set_reference():
    try:
        data = request.json
        image_data = data['image'].split(',')[1]
        image_bytes = base64.b64decode(image_data)
        
        # numpy ë°°ì—´ë¡œ ë³€í™˜
        nparr = np.frombuffer(image_bytes, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        
        if img is None:
            return jsonify({'success': False, 'error': 'ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'})
        
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        
        reference_data['center'] = find_box_center(gray)
        reference_data['angle'] = find_box_angle(gray)
        reference_data['image'] = img
        
        if reference_data['center'] is None:
            return jsonify({'success': False, 'error': 'ë°•ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'})
        
        return jsonify({
            'success': True,
            'center': reference_data['center'],
            'angle': round(reference_data['angle'], 2)
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/analyze', methods=['POST'])
def analyze():
    try:
        data = request.json
        image_data = data['image'].split(',')[1]
        image_bytes = base64.b64decode(image_data)
        
        position_threshold = data.get('position_threshold', 30)
        angle_threshold = data.get('angle_threshold', 10)
        
        # numpy ë°°ì—´ë¡œ ë³€í™˜
        nparr = np.frombuffer(image_bytes, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        
        if img is None:
            return jsonify({'error': 'ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'})
        
        # ë¶„ì„
        result = detect_anomaly(img, position_threshold, angle_threshold)
        
        if 'error' in result:
            return jsonify(result)
        
        # ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„±
        result_img = draw_result(img, result)
        result_b64 = img_to_base64(result_img)
        
        result['result_image'] = result_b64
        
        return jsonify(result)
    except Exception as e:
        return jsonify({'error': str(e)})


@app.route('/llm_analyze', methods=['POST'])
def llm_analyze():
    """LLMìœ¼ë¡œ ì´ìƒ íƒì§€ ê²°ê³¼ ë¶„ì„"""
    try:
        data = request.json
        result = data.get('result', {})
        
        system_prompt = """ë‹¹ì‹ ì€ ë°˜ë„ì²´ FAB ê³µì •ì˜ í’ˆì§ˆ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³ , ì›ì¸ê³¼ ì¡°ì¹˜ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.
í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”."""
        
        prompt = f"""ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:

- íŒì •: {'ì´ìƒ' if result.get('is_anomaly') else 'ì •ìƒ'}
- ìœ í˜•: {result.get('anomaly_type', 'ì•Œ ìˆ˜ ì—†ìŒ')}
- ìœ„ì¹˜ ì´íƒˆ: {result.get('position_shift', 0)}px
- íšŒì „ ê°ë„: {result.get('angle_shift', 0)}Â°

ë‹¤ìŒ í•­ëª©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì´ìƒ ì›ì¸ ì¶”ì •
2. ê³µì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
3. ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­
4. ì˜ˆë°© ëŒ€ì±…"""
        
        llm_result = call_llm_api(prompt, system_prompt)
        
        if llm_result["success"]:
            return jsonify({"success": True, "analysis": llm_result["content"]})
        else:
            return jsonify({"success": False, "error": llm_result["error"]})
            
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})


@app.route('/api/llm_status')
def llm_status():
    """LLM ìƒíƒœ í™•ì¸"""
    return jsonify({
        "available": API_TOKEN is not None,
        "model": LLM_CONFIG["name"]
    })


if __name__ == '__main__':
    print("="*50)
    print("ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ì‹œìŠ¤í…œ - ì›¹ ë²„ì „")
    print("="*50)
    print()
    print("ğŸŒ ì ‘ì† ì£¼ì†Œ:")
    print("   ë¡œì»¬: http://localhost:10005")
    print("   ë„¤íŠ¸ì›Œí¬: http://<IPì£¼ì†Œ>:10005")
    print()
    print("ğŸ“Œ ì‚¬ìš©ë²•:")
    print("   1. ê¸°ì¤€ ì´ë¯¸ì§€(ì •ìƒ ë°•ìŠ¤) ì—…ë¡œë“œ â†’ 'ê¸°ì¤€ ì´ë¯¸ì§€ë¡œ ì„¤ì •' í´ë¦­")
    print("   2. í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ â†’ 'ì´ìƒ íƒì§€ ë¶„ì„' í´ë¦­")
    print()
    print("ì¢…ë£Œ: Ctrl+C")
    print("="*50)
    
    app.run(host='0.0.0.0', port=10005, debug=True)