"""
Box Position Anomaly Detection - Web Version V3
í™”ë©´ ê½‰ ì°¸ + ìŠ¤í¬ë¡¤ ìˆ¨ê¹€ + íˆìŠ¤í† ë¦¬ í•˜ë‹¨
"""

import os
import cv2
import numpy as np
import requests
import re
from flask import Flask, render_template_string, request, jsonify
import base64

app = Flask(__name__)

reference_data = {'center': None, 'angle': None, 'image': None}

LLM_CONFIG = {
    "url": "http://common.llm.skhynix.com/v1/chat/completions",
    "model": "gpt-oss-20b"
}
API_TOKEN = None

def load_api_token():
    global API_TOKEN
    for path in ["token.txt", "../token.txt", os.path.expanduser("~/token.txt")]:
        if os.path.exists(path):
            with open(path, "r", encoding='utf-8') as f:
                API_TOKEN = f.read().strip()
                if API_TOKEN and "REPLACE" not in API_TOKEN:
                    print(f"âœ… í† í° ë¡œë“œ: {path}")
                    return True
    print("âš ï¸ í† í° ì—†ìŒ")
    return False

def call_llm_api(prompt, system_prompt=""):
    if not API_TOKEN:
        return {"success": False, "error": "í† í° ì—†ìŒ"}
    try:
        response = requests.post(
            LLM_CONFIG["url"],
            headers={"Authorization": f"Bearer {API_TOKEN}", "Content-Type": "application/json"},
            json={
                "model": LLM_CONFIG["model"],
                "messages": [{"role": "system", "content": system_prompt}, {"role": "user", "content": prompt}] if system_prompt else [{"role": "user", "content": prompt}],
                "max_tokens": 2000,
                "temperature": 0.3
            },
            timeout=120
        )
        if response.status_code == 200:
            content = response.json()["choices"][0]["message"]["content"]
            content = re.sub(r'<think>.*?</think>', '', content, flags=re.DOTALL).strip()
            return {"success": True, "content": content}
        return {"success": False, "error": f"API ì˜¤ë¥˜: {response.status_code}"}
    except Exception as e:
        return {"success": False, "error": str(e)}

load_api_token()

def find_box_center(gray):
    _, thresh = cv2.threshold(gray, 80, 255, cv2.THRESH_BINARY)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    if not contours: return None
    largest = max(contours, key=cv2.contourArea)
    M = cv2.moments(largest)
    if M["m00"] == 0: return None
    return (int(M["m10"]/M["m00"]), int(M["m01"]/M["m00"]))

def find_box_angle(gray):
    _, thresh = cv2.threshold(gray, 80, 255, cv2.THRESH_BINARY)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    if not contours: return 0
    rect = cv2.minAreaRect(max(contours, key=cv2.contourArea))
    angle = rect[2]
    return angle + 90 if angle < -45 else angle

def detect_anomaly(img, pos_th=30, ang_th=10):
    if reference_data['center'] is None:
        return {'error': 'ê¸°ì¤€ ë¯¸ì„¤ì •'}
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    center = find_box_center(gray)
    angle = find_box_angle(gray)
    if center is None:
        return {'is_anomaly': True, 'anomaly_type': 'ë°•ìŠ¤ ì—†ìŒ', 'position_shift': -1, 'angle_shift': -1}
    pos_shift = np.sqrt((center[0]-reference_data['center'][0])**2 + (center[1]-reference_data['center'][1])**2)
    ang_shift = abs(angle - reference_data['angle'])
    is_pos = pos_shift > pos_th
    is_ang = ang_shift > ang_th
    if is_pos and is_ang: atype = 'ìœ„ì¹˜+íšŒì „'
    elif is_pos: atype = 'ìœ„ì¹˜ ì´íƒˆ'
    elif is_ang: atype = 'íšŒì „ë¨'
    else: atype = 'ì •ìƒ'
    return {
        'is_anomaly': bool(is_pos or is_ang),
        'anomaly_type': atype,
        'position_shift': float(round(pos_shift, 1)),
        'angle_shift': float(round(ang_shift, 1)),
        'test_center': center,
        'ref_center': reference_data['center']
    }

def draw_result(img, result):
    img = img.copy()
    color = (0,0,255) if result.get('is_anomaly') else (0,255,0)
    cv2.rectangle(img, (5,5), (img.shape[1]-5, img.shape[0]-5), color, 4)
    if result.get('test_center'): cv2.circle(img, result['test_center'], 10, color, -1)
    if result.get('ref_center'): cv2.circle(img, result['ref_center'], 8, (255,0,0), 2)
    return img

def img_to_base64(img):
    _, buf = cv2.imencode('.png', img)
    return base64.b64encode(buf).decode('utf-8')

HTML = '''
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Malgun Gothic',sans-serif;background:#1a1a2e;color:#fff}
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        ::-webkit-scrollbar{display:none}
        *{-ms-overflow-style:none;scrollbar-width:none}
        
        /* í—¤ë” */
        .header{background:rgba(0,0,0,.5);padding:10px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #00d4ff}
        .header h1{font-size:20px;color:#00d4ff}
        .header span{color:#666;font-size:11px;margin-left:10px}
        .stats{display:flex;gap:25px}
        .stat{text-align:center}
        .stat .n{font-size:28px;font-weight:bold}
        .stat.t .n{color:#00d4ff}
        .stat.g .n{color:#0f8}
        .stat.r .n{color:#f44}
        .stat .l{font-size:10px;color:#888}
        
        /* ë©”ì¸ - ìƒë‹¨ 2ì—´ + í•˜ë‹¨ íˆìŠ¤í† ë¦¬ */
        .wrapper{height:calc(100vh - 60px);display:flex;flex-direction:column;padding:8px;gap:8px}
        .top{display:grid;grid-template-columns:240px 1fr;gap:8px;flex:1;min-height:0}
        .bottom{height:100px;flex-shrink:0}
        
        /* ì¹´ë“œ */
        .card{background:rgba(255,255,255,.03);border-radius:10px;padding:15px;border:1px solid rgba(255,255,255,.1);overflow:hidden}
        .card h3{color:#00d4ff;font-size:13px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .card h3 .badge{font-size:9px;padding:2px 6px;border-radius:8px;background:#f44;color:#fff}
        .card h3 .badge.ok{background:#0f8}
        
        /* ì™¼ìª½ - ì„¤ì • */
        .left{display:flex;flex-direction:column;gap:10px;overflow-y:auto}
        .left::-webkit-scrollbar{width:4px}
        .left::-webkit-scrollbar-thumb{background:#444;border-radius:2px}
        .upload{border:2px dashed #444;border-radius:8px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}
        .upload:hover{border-color:#00d4ff;background:rgba(0,212,255,.05)}
        .upload .ico{font-size:24px}
        .upload p{font-size:10px;color:#666;margin-top:3px}
        .upload input{display:none}
        .preview{width:100%;max-height:60px;object-fit:contain;border-radius:5px;margin-top:5px;display:none}
        .btn{width:100%;padding:8px;border:none;border-radius:15px;cursor:pointer;font-size:12px;font-weight:bold;color:#fff;transition:all .2s}
        .btn:hover{transform:translateY(-2px);filter:brightness(1.1)}
        .btn:disabled{background:#333!important;cursor:not-allowed;transform:none;filter:none}
        .btn-p{background:linear-gradient(135deg,#00d4ff,#0099cc)}
        .btn-g{background:linear-gradient(135deg,#0f8,#0c6)}
        .btn-v{background:linear-gradient(135deg,#9b59b6,#8e44ad)}
        .sets{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:5px}
        .sets label{font-size:9px;color:#888}
        .sets input{width:100%;padding:6px;border:1px solid #444;border-radius:4px;background:rgba(0,0,0,.3);color:#fff;font-size:11px;margin-top:2px}
        
        /* ì˜¤ë¥¸ìª½ - ê²°ê³¼ (2ì—´) */
        .right{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        .result-section,.llm-section{display:flex;flex-direction:column}
        
        /* ê²°ê³¼ ë°•ìŠ¤ */
        .rbox{flex:1;padding:15px;border-radius:10px;display:flex;flex-direction:column}
        .rbox.g{background:rgba(0,255,136,.08);border:2px solid #0f8}
        .rbox.r{background:rgba(255,68,68,.08);border:2px solid #f44}
        .rbox.empty{background:rgba(255,255,255,.02);border:2px dashed #333;justify-content:center;align-items:center}
        .rbox.empty p{color:#555;font-size:13px}
        .rtitle{font-size:22px;font-weight:bold;margin-bottom:15px}
        .rbox.g .rtitle{color:#0f8}
        .rbox.r .rtitle{color:#f44}
        .rgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
        .ritem{background:rgba(0,0,0,.2);padding:12px;border-radius:8px;text-align:center}
        .ritem .lb{font-size:11px;color:#888;margin-bottom:5px}
        .ritem .vl{font-size:18px;font-weight:bold}
        .rimg{max-height:200px;object-fit:contain;border-radius:8px;margin-top:auto}
        
        /* LLM ê²°ê³¼ */
        .llm-box{flex:1;padding:15px;border-radius:10px;background:rgba(155,89,182,.08);border:1px solid #9b59b6;display:flex;flex-direction:column}
        .llm-box.empty{background:rgba(255,255,255,.02);border:2px dashed #333;justify-content:center;align-items:center}
        .llm-box h4{color:#9b59b6;font-size:14px;margin-bottom:10px}
        .llm-content{flex:1;overflow-y:auto;font-size:12px;line-height:1.6}
        .llm-btns{display:flex;gap:8px;margin-top:10px}
        .llm-btns .btn{flex:1}
        
        /* ë§ˆí¬ë‹¤ìš´ */
        .md h1,.md h2,.md h3,.md h4{color:#00d4ff;margin:15px 0 8px;font-size:14px;border-bottom:1px solid #333;padding-bottom:5px}
        .md h3{color:#9b59b6;border:none}
        .md table{width:100%;border-collapse:collapse;margin:10px 0;font-size:11px}
        .md th,.md td{border:1px solid #444;padding:8px}
        .md th{background:rgba(0,212,255,.1);color:#00d4ff}
        .md ul,.md ol{padding-left:20px;margin:8px 0}
        .md li{margin:4px 0}
        .md strong{color:#0f8}
        .md hr{border:none;border-top:1px solid #444;margin:15px 0}
        
        /* í•˜ë‹¨ íˆìŠ¤í† ë¦¬ */
        .bottom .card{height:100%;display:flex;flex-direction:column}
        .bottom h3{margin-bottom:8px;flex-shrink:0}
        .hist{display:flex;gap:10px;overflow-x:auto;flex:1;align-items:center;padding:5px 0}
        .hitem{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,0,0,.2);border-radius:8px;font-size:11px}
        .hitem.g{border-left:3px solid #0f8}
        .hitem.r{border-left:3px solid #f44}
        .hitem img{width:50px;height:50px;object-fit:cover;border-radius:5px}
        .hempty{color:#555;width:100%;text-align:center;font-size:12px}
        
        /* ëª¨ë‹¬ */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;justify-content:center;align-items:center}
        .mcontent{background:#1a1a2e;border-radius:12px;padding:25px;width:90%;max-width:600px;border:2px solid #9b59b6}
        .mcontent h2{color:#9b59b6;font-size:18px;margin-bottom:20px}
        .mcontent label{font-size:12px;color:#888;display:block;margin:15px 0 5px}
        .mcontent textarea{width:100%;background:rgba(0,0,0,.3);border:1px solid #444;border-radius:8px;color:#fff;padding:12px;font-size:12px;resize:none}
        .mbtns{display:flex;gap:10px;margin-top:20px}
        .mbtns .btn{flex:1}
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ì‹œìŠ¤í…œ <span>BATA_VER_V0.1</span></h1>
        </div>
        <div class="stats">
            <div class="stat t"><div class="n" id="sT">0</div><div class="l">ì´ ê²€ì‚¬</div></div>
            <div class="stat g"><div class="n" id="sN">0</div><div class="l">ì •ìƒ</div></div>
            <div class="stat r"><div class="n" id="sA">0</div><div class="l">ì´ìƒ</div></div>
        </div>
    </div>
    
    <div class="wrapper">
        <div class="top">
            <!-- ì™¼ìª½: ì„¤ì • -->
            <div class="card left">
                <div>
                    <h3>ğŸ“· ê¸°ì¤€ ì´ë¯¸ì§€ <span class="badge" id="refBadge">ë¯¸ì„¤ì •</span></h3>
                    <div class="upload" onclick="document.getElementById('refIn').click()">
                        <input type="file" id="refIn" accept="image/*">
                        <div class="ico">ğŸ“·</div>
                        <p>ì •ìƒ ë°•ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
                    </div>
                    <img id="refPv" class="preview">
                    <button class="btn btn-g" id="refBtn" disabled onclick="setRef()">âœ“ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •</button>
                </div>
                
                <div class="sets">
                    <div>
                        <label>ìœ„ì¹˜ ì˜¤ì°¨ (px)</label>
                        <input type="number" id="posT" value="30">
                    </div>
                    <div>
                        <label>ê°ë„ ì˜¤ì°¨ (Â°)</label>
                        <input type="number" id="angT" value="10">
                    </div>
                </div>
                
                <div style="margin-top:15px">
                    <h3>ğŸ” í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€</h3>
                    <div class="upload" onclick="document.getElementById('testIn').click()">
                        <input type="file" id="testIn" accept="image/*">
                        <div class="ico">ğŸ”</div>
                        <p>ë¶„ì„í•  ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
                    </div>
                    <img id="testPv" class="preview">
                    <button class="btn btn-p" id="anaBtn" disabled onclick="analyze()">ğŸ” ì´ìƒ íƒì§€ ë¶„ì„</button>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ê²°ê³¼ -->
            <div class="right">
                <!-- ë¶„ì„ ê²°ê³¼ -->
                <div class="result-section">
                    <h3 style="color:#00d4ff;font-size:14px;margin-bottom:10px">ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
                    <div class="rbox empty" id="rBox">
                        <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ <br>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>
                
                <!-- AI ë¶„ì„ -->
                <div class="llm-section">
                    <h3 style="color:#9b59b6;font-size:14px;margin-bottom:10px">ğŸ¤– AI ì›ì¸ ë¶„ì„</h3>
                    <div class="llm-box empty" id="llmBox">
                        <p>ë¶„ì„ ê²°ê³¼ í™•ì¸ í›„<br>AI ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨: íˆìŠ¤í† ë¦¬ -->
        <div class="bottom">
            <div class="card">
                <h3>ğŸ“œ ê²€ì‚¬ íˆìŠ¤í† ë¦¬</h3>
                <div class="hist" id="hist">
                    <div class="hempty">ì•„ì§ ê²€ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ -->
    <div class="modal" id="modal">
        <div class="mcontent">
            <h2>âš™ï¸ LLM í”„ë¡¬í”„íŠ¸ ì„¤ì •</h2>
            <label>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
            <textarea id="sysP" rows="3">ë‹¹ì‹ ì€ ë°˜ë„ì²´ FAB ê³µì •ì˜ í’ˆì§ˆ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³ , ì›ì¸ê³¼ ì¡°ì¹˜ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.</textarea>
            <label>ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ (ë³€ìˆ˜: {is_anomaly}, {anomaly_type}, {position_shift}, {angle_shift})</label>
            <textarea id="usrP" rows="6">ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼:
- íŒì •: {is_anomaly}
- ìœ í˜•: {anomaly_type}
- ìœ„ì¹˜ ì´íƒˆ: {position_shift}px
- íšŒì „ ê°ë„: {angle_shift}Â°

ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì´ìƒ ì›ì¸ ì¶”ì •
2. ê³µì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
3. ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­
4. ì˜ˆë°© ëŒ€ì±…</textarea>
            <div class="mbtns">
                <button class="btn btn-g" onclick="saveP()">ğŸ’¾ ì €ì¥</button>
                <button class="btn" style="background:#555" onclick="resetP()">ğŸ”„ ì´ˆê¸°í™”</button>
                <button class="btn" style="background:#333" onclick="closeModal()">âœ• ë‹«ê¸°</button>
            </div>
        </div>
    </div>

<script>
let refD=null,testD=null,lastR=null,st={t:0,n:0,a:0};

document.getElementById('refIn').onchange=e=>{if(e.target.files[0])loadImg(e.target.files[0],'ref')};
document.getElementById('testIn').onchange=e=>{if(e.target.files[0])loadImg(e.target.files[0],'test')};

function loadImg(f,t){
    const r=new FileReader();
    r.onload=e=>{
        if(t==='ref'){
            refD=e.target.result;
            document.getElementById('refPv').src=refD;
            document.getElementById('refPv').style.display='block';
            document.getElementById('refBtn').disabled=false;
        }else{
            testD=e.target.result;
            document.getElementById('testPv').src=testD;
            document.getElementById('testPv').style.display='block';
            document.getElementById('anaBtn').disabled=false;
        }
    };
    r.readAsDataURL(f);
}

async function setRef(){
    const r=await fetch('/set_reference',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:refD})});
    const d=await r.json();
    if(d.success){
        document.getElementById('refBadge').textContent='ì„¤ì •ì™„ë£Œ';
        document.getElementById('refBadge').className='badge ok';
    }else{
        alert('ì˜¤ë¥˜: '+d.error);
    }
}

async function analyze(){
    const r=await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        image:testD,
        position_threshold:+document.getElementById('posT').value,
        angle_threshold:+document.getElementById('angT').value
    })});
    const d=await r.json();
    if(d.error){alert('ì˜¤ë¥˜: '+d.error);return}
    
    lastR=d;
    
    // ê²°ê³¼ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    const box=document.getElementById('rBox');
    box.className='rbox '+(d.is_anomaly?'r':'g');
    box.innerHTML=`
        <div class="rtitle">${d.is_anomaly?'âš ï¸ ì´ìƒ ê°ì§€!':'âœ… ì •ìƒ'}</div>
        <div class="rgrid">
            <div class="ritem"><div class="lb">ìœ í˜•</div><div class="vl">${d.anomaly_type}</div></div>
            <div class="ritem"><div class="lb">ì´íƒˆê±°ë¦¬</div><div class="vl">${d.position_shift}px</div></div>
            <div class="ritem"><div class="lb">íšŒì „ê°ë„</div><div class="vl">${d.angle_shift}Â°</div></div>
            <div class="ritem"><div class="lb">íŒì •</div><div class="vl" style="color:${d.is_anomaly?'#f44':'#0f8'}">${d.is_anomaly?'FAIL':'PASS'}</div></div>
        </div>
        <img class="rimg" src="data:image/png;base64,${d.result_image}">
    `;
    
    // LLM ë°•ìŠ¤ ì´ˆê¸°í™” + ë²„íŠ¼ ì¶”ê°€
    const llmBox=document.getElementById('llmBox');
    llmBox.className='llm-box';
    llmBox.innerHTML=`
        <h4>ğŸ¤– AI ì›ì¸ ë¶„ì„</h4>
        <div class="llm-content md" id="llmC">ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
        <div class="llm-btns">
            <button class="btn btn-v" id="llmBtn" onclick="llmAna()">ğŸ¤– AI ë¶„ì„ ì‹œì‘</button>
            <button class="btn" style="background:#555" onclick="openModal()">âš™ï¸ ì„¤ì •</button>
        </div>
    `;
    
    // í†µê³„
    if(d.is_anomaly)st.a++;else st.n++;
    st.t++;
    document.getElementById('sT').textContent=st.t;
    document.getElementById('sN').textContent=st.n;
    document.getElementById('sA').textContent=st.a;
    
    addHist(d);
}

async function llmAna(){
    if(!lastR){alert('ë¨¼ì € ë¶„ì„í•˜ì„¸ìš”');return}
    
    const btn=document.getElementById('llmBtn');
    const c=document.getElementById('llmC');
    
    btn.disabled=true;
    btn.textContent='ğŸ”„ ë¶„ì„ ì¤‘...';
    c.innerHTML='<p style="color:#888">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
    
    let sP=localStorage.getItem('sysP')||document.getElementById('sysP').value;
    let uP=(localStorage.getItem('usrP')||document.getElementById('usrP').value)
        .replace('{is_anomaly}',lastR.is_anomaly?'ì´ìƒ':'ì •ìƒ')
        .replace('{anomaly_type}',lastR.anomaly_type)
        .replace('{position_shift}',lastR.position_shift)
        .replace('{angle_shift}',lastR.angle_shift);
    
    try{
        const r=await fetch('/llm_analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({result:lastR,system_prompt:sP,user_prompt:uP})});
        const d=await r.json();
        c.innerHTML=d.success?marked.parse(d.analysis):'<p style="color:#f44">âŒ '+d.error+'</p>';
    }catch(e){
        c.innerHTML='<p style="color:#f44">âŒ '+e.message+'</p>';
    }
    
    btn.disabled=false;
    btn.textContent='ğŸ¤– ë‹¤ì‹œ ë¶„ì„';
}

function addHist(d){
    const h=document.getElementById('hist');
    if(st.t===1)h.innerHTML='';
    
    const item=document.createElement('div');
    item.className='hitem '+(d.is_anomaly?'r':'g');
    item.innerHTML=`
        <img src="data:image/png;base64,${d.result_image}">
        <div>
            <strong>${d.is_anomaly?'âš ï¸ ì´ìƒ':'âœ… ì •ìƒ'}</strong><br>
            <span style="color:#888">${d.anomaly_type} | ${d.position_shift}px | ${d.angle_shift}Â°</span>
        </div>
    `;
    h.insertBefore(item,h.firstChild);
}

function openModal(){document.getElementById('modal').style.display='flex'}
function closeModal(){document.getElementById('modal').style.display='none'}
function saveP(){
    localStorage.setItem('sysP',document.getElementById('sysP').value);
    localStorage.setItem('usrP',document.getElementById('usrP').value);
    alert('ì €ì¥ë¨!');
    closeModal();
}
function resetP(){
    document.getElementById('sysP').value='ë‹¹ì‹ ì€ ë°˜ë„ì²´ FAB ê³µì •ì˜ í’ˆì§ˆ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³ , ì›ì¸ê³¼ ì¡°ì¹˜ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.';
    document.getElementById('usrP').value=`ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼:
- íŒì •: {is_anomaly}
- ìœ í˜•: {anomaly_type}
- ìœ„ì¹˜ ì´íƒˆ: {position_shift}px
- íšŒì „ ê°ë„: {angle_shift}Â°

ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì´ìƒ ì›ì¸ ì¶”ì •
2. ê³µì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
3. ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­
4. ì˜ˆë°© ëŒ€ì±…`;
    localStorage.removeItem('sysP');
    localStorage.removeItem('usrP');
    alert('ì´ˆê¸°í™”ë¨!');
}
</script>
</body>
</html>
'''

@app.route('/')
def index():
    return render_template_string(HTML)

@app.route('/set_reference', methods=['POST'])
def set_reference():
    try:
        data = request.json
        img_data = data['image'].split(',')[1]
        nparr = np.frombuffer(base64.b64decode(img_data), np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        if img is None: return jsonify({'success': False, 'error': 'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'})
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        reference_data['center'] = find_box_center(gray)
        reference_data['angle'] = find_box_angle(gray)
        reference_data['image'] = img
        if reference_data['center'] is None: return jsonify({'success': False, 'error': 'ë°•ìŠ¤ ì—†ìŒ'})
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/analyze', methods=['POST'])
def analyze():
    try:
        data = request.json
        img_data = data['image'].split(',')[1]
        nparr = np.frombuffer(base64.b64decode(img_data), np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        if img is None: return jsonify({'error': 'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'})
        result = detect_anomaly(img, data.get('position_threshold', 30), data.get('angle_threshold', 10))
        if 'error' in result: return jsonify(result)
        result['result_image'] = img_to_base64(draw_result(img, result))
        return jsonify(result)
    except Exception as e:
        return jsonify({'error': str(e)})

@app.route('/llm_analyze', methods=['POST'])
def llm_analyze():
    try:
        data = request.json
        result = call_llm_api(data.get('user_prompt', ''), data.get('system_prompt', ''))
        return jsonify({"success": result["success"], "analysis": result.get("content", ""), "error": result.get("error", "")})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

if __name__ == '__main__':
    print("="*50)
    print("ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ì‹œìŠ¤í…œ V3")
    print("="*50)
    print("ğŸŒ http://localhost:10005")
    print("="*50)
    app.run(host='0.0.0.0', port=10005, debug=True)