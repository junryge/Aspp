"""
Box Position Anomaly Detection - Web Version
ê¹”ë”í•œ ë””ìì¸
"""

import os, cv2, numpy as np, requests, re, base64
from flask import Flask, render_template_string, request, jsonify

app = Flask(__name__)
reference_data = {'center': None, 'angle': None}

# LLM ì„¤ì •
LLM_URL = "http://common.llm.skhynix.com/v1/chat/completions"
LLM_MODEL = "gpt-oss-20b"
API_TOKEN = None

for p in ["token.txt", "../token.txt"]:
    if os.path.exists(p):
        API_TOKEN = open(p).read().strip()
        if API_TOKEN: print(f"âœ… í† í° ë¡œë“œ: {p}"); break

def call_llm(prompt, sys=""):
    if not API_TOKEN: return {"success": False, "error": "í† í°ì—†ìŒ"}
    try:
        r = requests.post(LLM_URL, headers={"Authorization": f"Bearer {API_TOKEN}", "Content-Type": "application/json"},
            json={"model": LLM_MODEL, "messages": [{"role":"system","content":sys},{"role":"user","content":prompt}], "max_tokens": 2000}, timeout=120)
        if r.status_code == 200:
            c = r.json()["choices"][0]["message"]["content"]
            return {"success": True, "content": re.sub(r'<think>.*?</think>', '', c, flags=re.DOTALL).strip()}
        return {"success": False, "error": f"APIì˜¤ë¥˜:{r.status_code}"}
    except Exception as e: return {"success": False, "error": str(e)}

def find_center(g):
    _, t = cv2.threshold(g, 80, 255, cv2.THRESH_BINARY)
    c, _ = cv2.findContours(t, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    if not c: return None
    M = cv2.moments(max(c, key=cv2.contourArea))
    return (int(M["m10"]/M["m00"]), int(M["m01"]/M["m00"])) if M["m00"] else None

def find_angle(g):
    _, t = cv2.threshold(g, 80, 255, cv2.THRESH_BINARY)
    c, _ = cv2.findContours(t, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    if not c: return 0
    a = cv2.minAreaRect(max(c, key=cv2.contourArea))[2]
    return a + 90 if a < -45 else a

def detect(img, pt=30, at=10):
    if not reference_data['center']: return {'error': 'ê¸°ì¤€ ë¯¸ì„¤ì •'}
    g = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    c, a = find_center(g), find_angle(g)
    if not c: return {'is_anomaly': True, 'type': 'ë°•ìŠ¤ì—†ìŒ', 'shift': -1, 'angle': -1}
    ps = np.sqrt((c[0]-reference_data['center'][0])**2 + (c[1]-reference_data['center'][1])**2)
    aa = abs(a - reference_data['angle'])
    ip, ia = ps > pt, aa > at
    return {'is_anomaly': bool(ip or ia), 'type': 'ìœ„ì¹˜+íšŒì „' if ip and ia else 'ìœ„ì¹˜ì´íƒˆ' if ip else 'íšŒì „' if ia else 'ì •ìƒ',
            'shift': round(ps,1), 'angle': round(aa,1), 'center': c, 'ref': reference_data['center']}

def draw(img, r):
    img = img.copy()
    col = (0,0,255) if r.get('is_anomaly') else (0,255,0)
    cv2.rectangle(img, (3,3), (img.shape[1]-3, img.shape[0]-3), col, 3)
    if r.get('center'): cv2.circle(img, r['center'], 8, col, -1)
    if r.get('ref'): cv2.circle(img, r['ref'], 6, (255,0,0), 2)
    return img

def to_b64(img):
    _, b = cv2.imencode('.png', img)
    return base64.b64encode(b).decode()

HTML = '''
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body { font-family:'Malgun Gothic',sans-serif; background:#111827; color:#fff; }

/* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
::-webkit-scrollbar { display:none; }
* { -ms-overflow-style:none; scrollbar-width:none; }

/* í—¤ë” */
header { background:#1f2937; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; }
header h1 { font-size:18px; color:#60a5fa; }
header h1 span { color:#6b7280; font-size:12px; margin-left:8px; }
.stats { display:flex; gap:24px; }
.stats > div { text-align:center; }
.stats .num { font-size:24px; font-weight:bold; }
.stats .num.blue { color:#60a5fa; }
.stats .num.green { color:#34d399; }
.stats .num.red { color:#f87171; }
.stats .label { font-size:10px; color:#9ca3af; }

/* ë©”ì¸ */
main { display:flex; height:calc(100vh - 56px); }

/* ì‚¬ì´ë“œë°” */
.sidebar { width:240px; background:#1f2937; padding:12px; border-right:1px solid #374151; overflow-y:auto; }
.sidebar h2 { font-size:12px; color:#9ca3af; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.sidebar h2 .dot { width:8px; height:8px; border-radius:50%; }
.sidebar h2 .dot.red { background:#f87171; }
.sidebar h2 .dot.green { background:#34d399; }

.upload-box { border:2px dashed #374151; border-radius:8px; padding:12px; text-align:center; cursor:pointer; margin-bottom:8px; transition:0.2s; }
.upload-box:hover { border-color:#60a5fa; background:rgba(96,165,250,0.1); }
.upload-box .icon { font-size:24px; }
.upload-box p { font-size:10px; color:#6b7280; }
.upload-box input { display:none; }

.preview { width:100%; max-height:60px; object-fit:contain; border-radius:6px; margin-bottom:6px; display:none; }

.btn { width:100%; padding:8px; border:none; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; margin-bottom:6px; transition:0.2s; }
.btn:disabled { opacity:0.4; cursor:not-allowed; }
.btn-blue { background:#3b82f6; color:#fff; }
.btn-green { background:#10b981; color:#fff; }
.btn-purple { background:#8b5cf6; color:#fff; }

.input-row { display:flex; gap:6px; margin-bottom:10px; }
.input-row > div { flex:1; }
.input-row label { display:block; font-size:9px; color:#6b7280; margin-bottom:2px; }
.input-row input { width:100%; padding:6px; background:#374151; border:1px solid #4b5563; border-radius:4px; color:#fff; font-size:11px; }

/* ì»¨í…ì¸  */
.content { flex:1; display:flex; flex-direction:column; }

/* ê²°ê³¼ ì˜ì—­ */
.result-area { flex:1; display:flex; gap:12px; padding:12px; overflow:hidden; }

.result-card { flex:1; background:#1f2937; border-radius:10px; padding:12px; display:flex; flex-direction:column; }
.result-card h3 { font-size:13px; color:#9ca3af; margin-bottom:10px; }
.result-card.success { border:2px solid #34d399; }
.result-card.fail { border:2px solid #f87171; }

.result-status { font-size:20px; font-weight:bold; margin-bottom:12px; }
.result-status.green { color:#34d399; }
.result-status.red { color:#f87171; }

.result-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px; }
.result-item { background:#374151; padding:8px; border-radius:6px; text-align:center; }
.result-item .label { font-size:9px; color:#6b7280; }
.result-item .value { font-size:14px; font-weight:bold; }

.result-img { flex:1; min-height:0; display:flex; align-items:center; justify-content:center; }
.result-img img { max-width:100%; max-height:150px; object-fit:contain; border-radius:6px; }

.empty-state { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#4b5563; }
.empty-state .icon { font-size:36px; margin-bottom:8px; }
.empty-state p { font-size:12px; }

/* AI ë¶„ì„ */
.ai-card { flex:1; background:#1f2937; border-radius:10px; padding:12px; display:flex; flex-direction:column; border:1px solid #4b5563; }
.ai-card h3 { font-size:13px; color:#a78bfa; margin-bottom:10px; }
.ai-content { flex:1; overflow-y:auto; font-size:11px; line-height:1.5; }
.ai-btns { display:flex; gap:6px; margin-top:10px; }
.ai-btns .btn { flex:1; padding:6px; font-size:10px; }

/* ë§ˆí¬ë‹¤ìš´ */
.md h1,.md h2,.md h3,.md h4 { color:#60a5fa; font-size:12px; margin:10px 0 5px; }
.md h3 { color:#a78bfa; }
.md table { width:100%; border-collapse:collapse; margin:6px 0; font-size:10px; }
.md th,.md td { border:1px solid #4b5563; padding:4px 6px; text-align:left; }
.md th { background:#374151; color:#60a5fa; }
.md ul,.md ol { padding-left:16px; margin:4px 0; }
.md strong { color:#34d399; }
.md hr { border:none; border-top:1px solid #4b5563; margin:8px 0; }

/* íˆìŠ¤í† ë¦¬ */
.history { height:80px; background:#1f2937; border-top:1px solid #374151; padding:8px 12px; }
.history h3 { font-size:11px; color:#9ca3af; margin-bottom:6px; }
.history-list { display:flex; gap:8px; overflow-x:auto; }
.history-item { flex-shrink:0; display:flex; align-items:center; gap:6px; background:#374151; padding:6px 10px; border-radius:6px; }
.history-item.green { border-left:3px solid #34d399; }
.history-item.red { border-left:3px solid #f87171; }
.history-item img { width:35px; height:35px; object-fit:cover; border-radius:4px; }
.history-item .info { font-size:10px; }
.history-item .info strong { display:block; }
.history-item .info span { color:#6b7280; }
.history-empty { color:#4b5563; font-size:11px; padding:10px; }

/* ëª¨ë‹¬ */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; align-items:center; justify-content:center; }
.modal-box { background:#1f2937; border-radius:10px; padding:20px; width:90%; max-width:450px; }
.modal-box h2 { color:#a78bfa; font-size:14px; margin-bottom:12px; }
.modal-box label { display:block; font-size:10px; color:#6b7280; margin-bottom:4px; }
.modal-box textarea { width:100%; background:#374151; border:1px solid #4b5563; border-radius:6px; color:#fff; padding:8px; font-size:10px; resize:none; margin-bottom:10px; }
.modal-btns { display:flex; gap:8px; }
.modal-btns .btn { flex:1; }
</style>
</head>
<body>

<header>
    <h1>ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ <span>BATA_VER_V0.1</span></h1>
    <div class="stats">
        <div><div class="num blue" id="sT">0</div><div class="label">ì´ ê²€ì‚¬</div></div>
        <div><div class="num green" id="sN">0</div><div class="label">ì •ìƒ</div></div>
        <div><div class="num red" id="sA">0</div><div class="label">ì´ìƒ</div></div>
    </div>
</header>

<main>
    <div class="sidebar">
        <h2><span class="dot" id="refDot"></span> ê¸°ì¤€ ì´ë¯¸ì§€</h2>
        <div class="upload-box" onclick="$('#refIn').click()">
            <input type="file" id="refIn" accept="image/*">
            <div class="icon">ğŸ“·</div>
            <p>ì •ìƒ ë°•ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
        </div>
        <img id="refPv" class="preview">
        <button class="btn btn-green" id="refBtn" disabled onclick="setRef()">ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •</button>
        
        <div class="input-row">
            <div><label>ìœ„ì¹˜ ì˜¤ì°¨ (px)</label><input type="number" id="posT" value="30"></div>
            <div><label>ê°ë„ ì˜¤ì°¨ (Â°)</label><input type="number" id="angT" value="10"></div>
        </div>
        
        <h2 style="margin-top:16px"><span class="dot red" id="testDot"></span> í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€</h2>
        <div class="upload-box" onclick="$('#testIn').click()">
            <input type="file" id="testIn" accept="image/*">
            <div class="icon">ğŸ”</div>
            <p>ë¶„ì„í•  ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
        </div>
        <img id="testPv" class="preview">
        <button class="btn btn-blue" id="anaBtn" disabled onclick="analyze()">ì´ìƒ íƒì§€ ë¶„ì„</button>
    </div>
    
    <div class="content">
        <div class="result-area">
            <div class="result-card" id="resultCard">
                <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
                <div class="empty-state" id="emptyResult">
                    <div class="icon">ğŸ“‹</div>
                    <p>ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
                <div id="resultContent" style="display:none;flex:1;display:none;flex-direction:column;">
                    <div class="result-status" id="resultStatus"></div>
                    <div class="result-grid">
                        <div class="result-item"><div class="label">ìœ í˜•</div><div class="value" id="rType">-</div></div>
                        <div class="result-item"><div class="label">ì´íƒˆê±°ë¦¬</div><div class="value" id="rShift">-</div></div>
                        <div class="result-item"><div class="label">íšŒì „ê°ë„</div><div class="value" id="rAngle">-</div></div>
                        <div class="result-item"><div class="label">íŒì •</div><div class="value" id="rJudge">-</div></div>
                    </div>
                    <div class="result-img"><img id="rImg"></div>
                </div>
            </div>
            
            <div class="ai-card" id="aiCard">
                <h3>ğŸ¤– AI ì›ì¸ ë¶„ì„</h3>
                <div class="empty-state" id="emptyAI">
                    <div class="icon">ğŸ¤–</div>
                    <p>ë¶„ì„ ì™„ë£Œ í›„ AI ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
                </div>
                <div class="ai-content md" id="aiContent" style="display:none;"></div>
                <div class="ai-btns" id="aiBtns" style="display:none;">
                    <button class="btn btn-purple" id="aiBtn" onclick="aiAnalyze()">ğŸ¤– AI ë¶„ì„</button>
                    <button class="btn" style="background:#4b5563" onclick="openModal()">âš™ï¸</button>
                </div>
            </div>
        </div>
        
        <div class="history">
            <h3>ğŸ“œ ê²€ì‚¬ íˆìŠ¤í† ë¦¬</h3>
            <div class="history-list" id="hist">
                <div class="history-empty">ì•„ì§ ê²€ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>
    </div>
</main>

<div class="modal" id="modal">
    <div class="modal-box">
        <h2>âš™ï¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h2>
        <label>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
        <textarea id="sysP" rows="3">ë‹¹ì‹ ì€ FAB ê³µì • í’ˆì§ˆê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì„¸ìš”.</textarea>
        <label>ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸</label>
        <textarea id="usrP" rows="4">ê²°ê³¼: {is_anomaly}, {type}, ì´íƒˆ:{shift}px, íšŒì „:{angle}Â°
ë¶„ì„: ì›ì¸, ì˜í–¥, ì¡°ì¹˜, ì˜ˆë°©</textarea>
        <div class="modal-btns">
            <button class="btn btn-green" onclick="saveP()">ì €ì¥</button>
            <button class="btn" style="background:#4b5563" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
let refD,testD,lastR,st={t:0,n:0,a:0};

$('#refIn').onchange=e=>{if(e.target.files[0])loadImg(e.target.files[0],'ref')};
$('#testIn').onchange=e=>{if(e.target.files[0])loadImg(e.target.files[0],'test')};

function loadImg(f,t){
    const r=new FileReader();
    r.onload=e=>{
        if(t==='ref'){
            refD=e.target.result;
            $('#refPv').src=refD;
            $('#refPv').style.display='block';
            $('#refBtn').disabled=false;
        }else{
            testD=e.target.result;
            $('#testPv').src=testD;
            $('#testPv').style.display='block';
            $('#anaBtn').disabled=false;
        }
    };
    r.readAsDataURL(f);
}

async function setRef(){
    const r=await fetch('/set_ref',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({img:refD})});
    const d=await r.json();
    if(d.ok){
        $('#refDot').className='dot green';
        $('#refBtn').textContent='âœ“ ì„¤ì •ì™„ë£Œ';
        $('#refBtn').disabled=true;
    }else alert('ì˜¤ë¥˜: '+d.error);
}

async function analyze(){
    const r=await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        img:testD, pt:+$('#posT').value, at:+$('#angT').value
    })});
    const d=await r.json();
    if(d.error){alert('ì˜¤ë¥˜: '+d.error);return;}
    
    lastR=d;
    
    // ê²°ê³¼ í‘œì‹œ
    $('#emptyResult').style.display='none';
    $('#resultContent').style.display='flex';
    $('#resultCard').className='result-card '+(d.is_anomaly?'fail':'success');
    $('#resultStatus').textContent=d.is_anomaly?'âš ï¸ ì´ìƒ ê°ì§€':'âœ… ì •ìƒ';
    $('#resultStatus').className='result-status '+(d.is_anomaly?'red':'green');
    $('#rType').textContent=d.type;
    $('#rShift').textContent=d.shift+'px';
    $('#rAngle').textContent=d.angle+'Â°';
    $('#rJudge').textContent=d.is_anomaly?'FAIL':'PASS';
    $('#rJudge').style.color=d.is_anomaly?'#f87171':'#34d399';
    $('#rImg').src='data:image/png;base64,'+d.img;
    
    // AI ë²„íŠ¼ í‘œì‹œ
    $('#emptyAI').style.display='none';
    $('#aiContent').style.display='block';
    $('#aiContent').innerHTML='<p style="color:#6b7280">AI ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';
    $('#aiBtns').style.display='flex';
    
    // í†µê³„
    d.is_anomaly?st.a++:st.n++;
    st.t++;
    $('#sT').textContent=st.t;
    $('#sN').textContent=st.n;
    $('#sA').textContent=st.a;
    
    addHist(d);
}

async function aiAnalyze(){
    if(!lastR)return;
    $('#aiBtn').disabled=true;
    $('#aiBtn').textContent='ë¶„ì„ì¤‘...';
    $('#aiContent').innerHTML='<p style="color:#6b7280">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
    
    let sys=localStorage.getItem('sysP')||$('#sysP').value;
    let usr=(localStorage.getItem('usrP')||$('#usrP').value)
        .replace('{is_anomaly}',lastR.is_anomaly?'ì´ìƒ':'ì •ìƒ')
        .replace('{type}',lastR.type)
        .replace('{shift}',lastR.shift)
        .replace('{angle}',lastR.angle);
    
    try{
        const r=await fetch('/llm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sys,usr})});
        const d=await r.json();
        $('#aiContent').innerHTML=d.ok?marked.parse(d.content):'<p style="color:#f87171">ì˜¤ë¥˜: '+d.error+'</p>';
    }catch(e){
        $('#aiContent').innerHTML='<p style="color:#f87171">ì˜¤ë¥˜: '+e.message+'</p>';
    }
    $('#aiBtn').disabled=false;
    $('#aiBtn').textContent='ğŸ¤– AI ë¶„ì„';
}

function addHist(d){
    const h=$('#hist');
    if(st.t===1)h.innerHTML='';
    const item=document.createElement('div');
    item.className='history-item '+(d.is_anomaly?'red':'green');
    item.innerHTML=`<img src="data:image/png;base64,${d.img}"><div class="info"><strong>${d.is_anomaly?'âš ï¸ ì´ìƒ':'âœ… ì •ìƒ'}</strong><span>${d.type} | ${d.shift}px</span></div>`;
    h.insertBefore(item,h.firstChild);
}

function openModal(){$('#modal').style.display='flex'}
function closeModal(){$('#modal').style.display='none'}
function saveP(){
    localStorage.setItem('sysP',$('#sysP').value);
    localStorage.setItem('usrP',$('#usrP').value);
    alert('ì €ì¥!');
    closeModal();
}
</script>
</body>
</html>
'''

@app.route('/')
def index(): return render_template_string(HTML)

@app.route('/set_ref', methods=['POST'])
def set_ref():
    try:
        d = request.json['img'].split(',')[1]
        img = cv2.imdecode(np.frombuffer(base64.b64decode(d), np.uint8), cv2.IMREAD_COLOR)
        g = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        reference_data['center'] = find_center(g)
        reference_data['angle'] = find_angle(g)
        return jsonify({'ok': reference_data['center'] is not None, 'error': 'ë°•ìŠ¤ì—†ìŒ' if not reference_data['center'] else ''})
    except Exception as e: return jsonify({'ok': False, 'error': str(e)})

@app.route('/analyze', methods=['POST'])
def analyze():
    try:
        d = request.json
        img = cv2.imdecode(np.frombuffer(base64.b64decode(d['img'].split(',')[1]), np.uint8), cv2.IMREAD_COLOR)
        r = detect(img, d.get('pt',30), d.get('at',10))
        if 'error' in r: return jsonify(r)
        r['img'] = to_b64(draw(img, r))
        return jsonify(r)
    except Exception as e: return jsonify({'error': str(e)})

@app.route('/llm', methods=['POST'])
def llm():
    d = request.json
    r = call_llm(d['usr'], d['sys'])
    return jsonify({'ok': r['success'], 'content': r.get('content',''), 'error': r.get('error','')})

if __name__ == '__main__':
    print("="*40)
    print("ğŸ“¦ ë°•ìŠ¤ ìœ„ì¹˜ ì´ìƒ íƒì§€")
    print("ğŸŒ http://localhost:10005")
    print("="*40)
    app.run(host='0.0.0.0', port=10005, debug=True)